diff -- git a/evcxr_jupyter/README.md b/evcxr_jupyter/README.md index 0a5cfce..bde7156 100644 -- - a/evcxr_jupyter/README.md +++ b/evcxr_jupyter/README.md @ @ -4,12 +4,24 @ @ A [ Jupyter ] ( https : //jupyter.org/ ) Kernel for the Rust programming language . # # Installation + # # # Linux ( Debian/Ubuntu ) + `` ` sh sudo apt install libzmq3-dev jupyter-notebook cargo install evcxr_jupyter evcxr_jupyter -- install `` ` + # # # Mac OS X + +install jupyter or jupyterlab ( eg . via anaconda ) + + `` ` sh +brew install zeromq pkg-config +cargo install evcxr_jupyter +evcxr_jupyter -- install + `` ` + # # Usage notes * Functions , structs etc need to all be declared pub , otherwise they ca n't be diff -- git a/evcxr_jupyter/src/install.rs b/evcxr_jupyter/src/install.rs index d60869a..5c89ea1 100644 -- - a/evcxr_jupyter/src/install.rs +++ b/evcxr_jupyter/src/install.rs @ @ -12,8 +12,8 @ @ // See the License for the specific language governing permissions and // limitations under the License . -use failure : :Error ; use dirs ; +use failure : :Error ; use std : :path : :PathBuf ; use std : : { env , fs } ; @ @ -45,13 +45,24 @ @ pub ( crate ) fn uninstall (
diff -- git a/address-sanitizer/tools/kasan_symbolize.py b/address-sanitizer/tools/kasan_symbolize.py index d2c210d..b928b49 100755 -- - a/address-sanitizer/tools/kasan_symbolize.py +++ b/address-sanitizer/tools/kasan_symbolize.py @ @ -75,10 +75,14 @ @ class SymbolOffsetLoader : for line in output.split ( '\n ' ) : match = nm_re.match ( line ) if match ! = None : - self.offsets [ match.group ( 'symbol ' ) ] = int ( match.group ( 'offset ' ) , 16 ) + symbol = match.group ( 'symbol ' ) + offset = int ( match.group ( 'offset ' ) , 16 ) + if not self.offsets.has_key ( symbol ) : + self.offsets [ symbol ] = [ ] + self.offsets [ symbol ] .append ( offset ) - def LookupOffset ( self , symbol ) : - return self.offsets.get ( symbol ) + def LookupOffsets ( self , symbol ) : + return self.offsets.get ( symbol , [ ] ) class ReportProcesser : def __init__ ( self , linux_path , strip_path ) : @ @ -137,13 +141,28 @ @ class ReportProcesser : symbolizer = self.module_symbolizers [ module ] loader = self.module_offset_loaders [ module ] - symbol_offset = loader.LookupOffset ( function ) - if not symbol_offset : + symbol_offsets = loader.LookupOffsets ( function ) + if len ( symbol_offsets
diff -- git a/doc/JAVA-HOWTO.md b/doc/JAVA-HOWTO.md index 3847f71..2ee2f36 100644 -- - a/doc/JAVA-HOWTO.md +++ b/doc/JAVA-HOWTO.md @ @ -364,7 +364,7 @ @ to encrypt or decrypt data streams : # # # Message Authentication Code The following snippets shows how to compute or verify a [ MAC ( Message Authentication -Code ) ] ( RIMITIVES.md # message-authentication-code ) : +Code ) ] ( PRIMITIVES.md # message-authentication-code ) : `` ` java import com.google.crypto.tink.KeysetHandle ;
diff -- git a/ChangeLog b/ChangeLog index 7eb248d..66bae1a 100644 -- - a/ChangeLog +++ b/ChangeLog @ @ -1,4 +1,10 @ @ -- -- -- -- -- -- -- -- - +2018-05-21 3.5.1 + -- -- -- -- -- -- -- -- - +* Fix AttributeError : 'module ' object has no attribute 'Signals ' when + constructing a CalledProcessError exception . [ # 49 ] + + -- -- -- -- -- -- -- -- - 2018-05-13 3.5.0 ( 3.5.0rc3 ) -- -- -- -- -- -- -- -- - diff -- git a/setup.py b/setup.py index 762f17b..345d00c 100755 -- - a/setup.py +++ b/setup.py @ @ -66,7 +66,7 @ @ def main ( ) : setup ( name='subprocess32 ' , - version='3.5.0 ' , + version='3.5.1 ' , description='A backport of the subprocess module from Python 3 for use on 2.x . ' , long_description= '' '' '' \ This is a backport of the subprocess standard library module from diff -- git a/subprocess32.py b/subprocess32.py index ff4976d..b5c6a55 100644 -- - a/subprocess32.py +++ b/subprocess32.py @ @ -67,12 +67,8 @ @ class CalledProcessError ( SubprocessError ) : def __str__ ( self ) : if self.returncode and self.returncode < 0 : - try : - return
diff -- git a/import-mailbox-to-gmail.py b/import-mailbox-to-gmail.py index 6ad3559..2cdc50e 100644 -- - a/import-mailbox-to-gmail.py +++ b/import-mailbox-to-gmail.py @ @ -105,6 +105,11 @ @ parser.add_argument ( default=0 , type=int , help='Debug level of the HTTP library : 0=None ( default ) , 4=Maximum . ' ) +parser.add_argument ( + ' -- from_message ' , + default=0 , + type=int , + help='Message number to resume from ( default : 0 ) ' ) parser.set_defaults ( fix_msgid=True , replace_quoted_printable=True , logging_level='INFO ' ) args = parser.parse_args ( ) @ @ -195,7 +200,7 @ @ def process_mbox_files ( username , service , labels ) : logging.error ( `` Skipping label ' % s ' because it ca n't be created '' ) continue logging.info ( `` Using label name ' % s ' , ID ' % s ' '' , labelname , label_id ) - for index , message in enumerate ( mbox ) : + for index , message in enumerate ( mbox , start=args.from_message ) : logging.info ( `` Processing message % d in label ' % s ' '' , index , labelname ) try : if ( args.replace_quoted_printable and
diff -- git a/index.js b/index.js index acc10f3..ea4c7b8 100644 -- - a/index.js +++ b/index.js @ @ -318,7 +318,7 @ @ module.exports = { 'no-var ' : 2 , // 'object-shorthand ' : 0 , // 'prefer-arrow-callback ' : 0 , - // 'prefer-const ' : 0 , + 'prefer-const ' : [ `` error '' , { `` destructuring '' : `` all '' } ] , // 'prefer-destructuring ' : 0 , // 'prefer-numeric-literals ' : 0 , 'prefer-rest-params ' : 2 ,
diff -- git a/.gitignore b/.gitignore index adfcbc7..904eefe 100644 -- - a/.gitignore +++ b/.gitignore @ @ -1,4 +1,4 @ @ -build/ +build/* build-*/ # Vim swap diff -- git a/CMakeLists.txt b/CMakeLists.txt index d071f53..882c614 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -20,7 +20,13 @ @ cmake_minimum_required ( VERSION 3.1 ) set ( mathfu_build_benchmarks OFF CACHE BOOL `` '' ) set ( mathfu_build_tests OFF CACHE BOOL `` '' ) add_subdirectory ( third_party/mathfu ) -set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -fno-rtti -fno-exceptions '' ) +if ( NOT MSVC ) + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -fno-rtti -fno-exceptions '' ) +else ( ) + add_definitions ( -DNOMINMAX -D_SCL_SECURE_NO_WARNINGS -D_CRT_SECURE_NO_WARNINGS ) + # TODO ( awoloszyn ) : Figure out why std : :vector is throwing up with .back ( ) + add_definitions ( /wd4146 ) +endif ( ) include ( cmake/setup.cmake ) diff -- git a/application_sandbox/async_compute/main.cpp b/application_sandbox/async_compute/main.cpp index 85813b4..b88838a 100644 -- - a/application_sandbox/async_compute/main.cpp +++ b/application_sandbox/async_compute/main.cpp @ @ -102,8 +102,6 @ @ class ASyncThreadRunner { if ( ! app_- > async_compute_queue ( ) ) { return ; } - // Poor man 's semaphore - first_data_mutex_.lock ( ) ; update_time_data_ = containers : :make_unique < vulkan : :BufferFrameData < Mat44
diff -- git a/.gitignore b/.gitignore index adfcbc7..904eefe 100644 -- - a/.gitignore +++ b/.gitignore @ @ -1,4 +1,4 @ @ -build/ +build/* build-*/ # Vim swap diff -- git a/CMakeLists.txt b/CMakeLists.txt index d071f53..882c614 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -20,7 +20,13 @ @ cmake_minimum_required ( VERSION 3.1 ) set ( mathfu_build_benchmarks OFF CACHE BOOL `` '' ) set ( mathfu_build_tests OFF CACHE BOOL `` '' ) add_subdirectory ( third_party/mathfu ) -set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -fno-rtti -fno-exceptions '' ) +if ( NOT MSVC ) + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -fno-rtti -fno-exceptions '' ) +else ( ) + add_definitions ( -DNOMINMAX -D_SCL_SECURE_NO_WARNINGS -D_CRT_SECURE_NO_WARNINGS ) + # TODO ( awoloszyn ) : Figure out why std : :vector is throwing up with .back ( ) + add_definitions ( /wd4146 ) +endif ( ) include ( cmake/setup.cmake ) diff -- git a/application_sandbox/async_compute/main.cpp b/application_sandbox/async_compute/main.cpp index 85813b4..b88838a 100644 -- - a/application_sandbox/async_compute/main.cpp +++ b/application_sandbox/async_compute/main.cpp @ @ -102,8 +102,6 @ @ class ASyncThreadRunner { if ( ! app_- > async_compute_queue ( ) ) { return ; } - // Poor man 's semaphore - first_data_mutex_.lock ( ) ; update_time_data_ = containers : :make_unique < vulkan : :BufferFrameData < Mat44
diff -- git a/tool/travis.sh b/tool/travis.sh index cdbf4f7..c5843c1 100755 -- - a/tool/travis.sh +++ b/tool/travis.sh @ @ -11,7 +11,8 @ @ set -e set -x # Get the Dart SDK . -DART_DIST=dartsdk-linux-x64-release.zip + # DART_DIST=dartsdk-linux-x64-release.zip +DART_DIST=dartsdk-macos-ia32-release.zip curl https : //storage.googleapis.com/dart-archive/channels/ $ DART_CHANNEL/release/latest/sdk/ $ DART_DIST -o $ DART_DIST unzip $ DART_DIST > /dev/null rm $ DART_DIST @ @ -37,4 +38,16 @ @ dart test/serialization_test.dart & & \ dart test/no_library_test.dart & & \ dart test/serialization_mirrors_test.dart & & \ pub run test/transformer/transformer_test & & \ -pub run test/transformer/transformer_maps_test +pub run test/transformer/transformer_maps_test & & \ +dart2js test/serialization_test.dart & & \ +cat $ DART_SDK/lib/_internal/compiler/js_lib/preambles/d8.js out.js > foo.js & & \ +node foo.js & & \ +dart2js test/no_library_test.dart & & \ +d8 $ DART_SDK/lib/_internal/compiler/js_lib/preambles/d8.js out.js & & \ +dart2js test/serialization_mirrors_test.dart & & \ +d8 $ DART_SDK/lib/_internal/compiler/js_lib/preambles/d8.js out.js & & \ + ( cd test/transformer & & dart generate_standalone.dart ) & & \ +dart2js test/transformer/transformer_test.dart & & \ +d8 $ DART_SDK/lib/_internal/compiler/js_lib/preambles/d8.js out.js & & \ +dart2js test/transformer/transformer_maps_test.dart & & \ +d8 $ DART_SDK/lib/_internal/compiler/js_lib/preambles/d8.js out.js
diff -- git a/src/lexer.js b/src/lexer.js index de8835d..2a522d1 100644 -- - a/src/lexer.js +++ b/src/lexer.js @ @ -81,8 +81,8 @ @ wgxpath.Lexer.tokenize = function ( source ) { * @ private */ wgxpath.Lexer.TOKEN_ = new RegExp ( - '\\ $ ? ( ? : ( ? ! [ 0-9- ] ) [ \\w- ] + : ) ? ( ? ! [ 0-9- ] ) [ \\w- ] + ' + - // Nodename ( possibly with namespace ) or variable . + '\\ $ ? ( ? : ( ? ! [ 0-9- ] ) [ \\w-\\* ] + : ) ? ( ? ! [ 0-9- ] ) [ \\w-\\* ] + ' + + // Nodename or wildcard [ * ] ( possibly with namespace or wildcard [ * ] ) or variable . '|\\/\\/ ' + // Double slash . '|\\.\\ . ' + // Double dot . '| : : ' + // Double colon . diff -- git a/src/nameTest.js b/src/nameTest.js index 35edf54..13455c8 100644 -- - a/src/nameTest.js +++ b/src/nameTest.js @ @ -54,12 +54,20 @ @ wgxpath.NameTest = function ( name , opt_namespaceUri ) { */ this.name_ = name.toLowerCase ( ) ; + var defaultNamespace ; + if
diff -- git a/src/lexer.js b/src/lexer.js index de8835d..2a522d1 100644 -- - a/src/lexer.js +++ b/src/lexer.js @ @ -81,8 +81,8 @ @ wgxpath.Lexer.tokenize = function ( source ) { * @ private */ wgxpath.Lexer.TOKEN_ = new RegExp ( - '\\ $ ? ( ? : ( ? ! [ 0-9- ] ) [ \\w- ] + : ) ? ( ? ! [ 0-9- ] ) [ \\w- ] + ' + - // Nodename ( possibly with namespace ) or variable . + '\\ $ ? ( ? : ( ? ! [ 0-9- ] ) [ \\w-\\* ] + : ) ? ( ? ! [ 0-9- ] ) [ \\w-\\* ] + ' + + // Nodename or wildcard [ * ] ( possibly with namespace or wildcard [ * ] ) or variable . '|\\/\\/ ' + // Double slash . '|\\.\\ . ' + // Double dot . '| : : ' + // Double colon . diff -- git a/src/nameTest.js b/src/nameTest.js index 35edf54..cfed20b 100644 -- - a/src/nameTest.js +++ b/src/nameTest.js @ @ -54,12 +54,20 @ @ wgxpath.NameTest = function ( name , opt_namespaceUri ) { */ this.name_ = name.toLowerCase ( ) ; + var defaultNamespace ; + if
diff -- git a/lib/exception.js b/lib/exception.js index d00154d..3027fcb 100644 -- - a/lib/exception.js +++ b/lib/exception.js @ @ -44,7 +44,7 @ @ lf.Exception = function ( code , var_args ) { // Allow at most 4 parameters , each parameter at most 64 chars . for ( var i = 1 ; i < = Math.min ( 4 , arguments.length - 1 ) ; ++i ) { this.message += ' & p ' + ( i - 1 ) + '= ' + - encodeURIComponent ( arguments [ i ] .toString ( ) .slice ( 0 , 64 ) ) ; + encodeURIComponent ( ( arguments [ i ] || `` ) .toString ( ) .slice ( 0 , 64 ) ) ; } } } ; diff -- git a/tests/base/exception_test.js b/tests/base/exception_test.js index 7d98602..ea6d5e2 100644 -- - a/tests/base/exception_test.js +++ b/tests/base/exception_test.js @ @ -47,4 +47,7 @ @ function testException ( ) { var e4 = new lf.Exception ( 999 , longString ) ; assertEquals ( BASE_URL + '999 & p0= ' + expected , e4.message ) ; + + var e5 = new lf.Exception ( 999 , 3 , undefined ) ; + assertEquals ( BASE_URL + '999 & p0=3 & p1= ' ,
diff -- git a/setup.py b/setup.py index 2a0ba59..0572dff 100644 -- - a/setup.py +++ b/setup.py @ @ -40,4 +40,17 @ @ setup ( name='python-gflags ' , url='https : //github.com/google/python-gflags ' , packages= [ 'gflags ' , 'gflags.third_party ' , 'gflags.third_party.pep257 ' ] , data_files= [ ( 'bin ' , [ 'gflags2man.py ' ] ) ] , + classifiers= ( + 'Development Status : : 5 - Production/Stable ' , + 'Intended Audience : : Developers ' , + 'Natural Language : : English ' , + 'License : : OSI Approved : : BSD ' , + 'Programming Language : : Python ' , + 'Programming Language : : Python : : 2.7 ' , + 'Programming Language : : Python : : 3 ' , + 'Programming Language : : Python : : 3.3 ' , + 'Programming Language : : Python : : 3.4 ' , + 'Programming Language : : Python : : 3.5 ' , + 'Programming Language : : Python : : Implementation : : CPython ' , + 'Programming Language : : Python : : Implementation : : PyPy ' ) , )
diff -- git a/.analysis_options b/.analysis_options new file mode 100644 index 0000000..fe004ab -- - /dev/null +++ b/.analysis_options @ @ -0,0 +1,3 @ @ +analyzer : + strong-mode : true + diff -- git a/.gitignore b/.gitignore index 4232a2f..451de11 100644 -- - a/.gitignore +++ b/.gitignore @ @ -2,3 +2,4 @ @ .pub/ packages pubspec.lock +.idea diff -- git a/.idea/chartjs.dart.iml b/.idea/chartjs.dart.iml new file mode 100644 index 0000000..97b1bfd -- - /dev/null +++ b/.idea/chartjs.dart.iml @ @ -0,0 +1,16 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < module type= '' WEB_MODULE '' version= '' 4 '' > + < component name= '' NewModuleRootManager '' > + < content url= '' file : // $ MODULE_DIR $ '' > + < excludeFolder url= '' file : // $ MODULE_DIR $ /.tmp '' / > + < excludeFolder url= '' file : // $ MODULE_DIR $ /example/packages '' / > + < excludeFolder url= '' file : // $ MODULE_DIR $ /packages '' / > + < excludeFolder url= '' file : // $ MODULE_DIR $ /temp '' / > + < excludeFolder url= '' file : // $ MODULE_DIR $ /tmp '' / > + < /content >
diff -- git a/.analysis_options b/.analysis_options new file mode 100644 index 0000000..fe004ab -- - /dev/null +++ b/.analysis_options @ @ -0,0 +1,3 @ @ +analyzer : + strong-mode : true + diff -- git a/.gitignore b/.gitignore index 4232a2f..451de11 100644 -- - a/.gitignore +++ b/.gitignore @ @ -2,3 +2,4 @ @ .pub/ packages pubspec.lock +.idea diff -- git a/example/example.dart b/example/example.dart index 8caf7ec..9ae50d4 100644 -- - a/example/example.dart +++ b/example/example.dart @ @ -1,4 +1,5 @ @ // Copyright ( c ) 2015 , Google Inc . Please see the AUTHORS file for details . + // All rights reserved . Use of this source code is governed by a BSD-style // license that can be found in the LICENSE file . @ @ -9,37 +10,192 @ @ library chartjs.example ; // On 2015-10-15 import 'dart : html ' ; -import 'dart : math ' as math ; +import 'dart : async ' ; import 'package : chartjs/chartjs.dart ' ; +CanvasRenderingContext2D ctx ; +Chart chart ; + void main ( ) { Chart.defaults.global.responsive = true ; + ctx = ( querySelector ( ' # canvas ' ) as CanvasElement ) .context2D ; + + List < Function > examples = [ + createChart , + mixedChartType
diff -- git a/client/client.go b/client/client.go index dcded21..12e66d0 100644 -- - a/client/client.go +++ b/client/client.go @ @ -17,6 +17,7 @ @ package client import ( '' compress/gzip '' '' context '' + '' crypto/sha256 '' '' encoding/json '' '' fmt '' '' io '' @ @ -25,6 +26,7 @ @ import ( '' net/url '' '' os '' '' path/filepath '' + '' strings '' '' time '' '' cloud.google.com/go/storage '' @ @ -105,7 +107,7 @ @ func AvailableVersions ( ctx context.Context , srcs [ ] string , cacheDir string , cach return rm } -func decode ( index io.ReadCloser , ct , cf string ) ( [ ] goolib.RepoSpec , error ) { +func decode ( index io.ReadCloser , ct , url , cf string ) ( [ ] goolib.RepoSpec , error ) { defer index.Close ( ) var dec *json.Decoder @ @ -141,6 +143,13 @ @ func decode ( index io.ReadCloser , ct , cf string ) ( [ ] goolib.RepoSpec , error ) { return nil , err } + // The .url files are n't used by googet but help developers and the + // curious figure out which file belongs to which repo/URL . + mf :
diff -- git a/docker_explorer/de.py b/docker_explorer/de.py index 705287a..4817867 100644 -- - a/docker_explorer/de.py +++ b/docker_explorer/de.py @ @ -52,11 +52,8 @ @ class DockerExplorer ( object ) : `` '' '' self.docker_directory = docker_path if not os.path.isdir ( self.docker_directory ) : - err_message = ( - ' { 0 : s } is not a Docker directory\n' - 'Please specify the Docker\ 's directory path.\n' - 'hint : de.py -r /var/lib/docker ' ) .format ( self.docker_directory ) - raise errors.BadStorageException ( err_message ) + msg = ' { 0 : s } is not a Docker directory'.format ( self.docker_directory ) + raise errors.BadStorageException ( msg ) self.containers_directory = os.path.join ( self.docker_directory , 'containers ' ) @ @ -156,14 +153,23 @ @ class DockerExplorer ( object ) : Returns : list ( Container ) : the list of Container objects . + + Raises : + errors.BadStorageException : If required files or directories are not found + in the provided Docker directory. `` '' '' + if not os.path.isdir ( self.containers_directory ) : + raise errors.BadStorageException ( + 'Containers directory { 0 } does not exist'.format ( + self.containers_directory ) ) container_ids_list = os.listdir ( self.containers_directory ) if not container_ids_list : - print (
diff -- git a/docker_explorer/de.py b/docker_explorer/de.py index 3149c12..de79ca7 100644 -- - a/docker_explorer/de.py +++ b/docker_explorer/de.py @ @ -52,11 +52,8 @ @ class DockerExplorer ( object ) : `` '' '' self.docker_directory = docker_path if not os.path.isdir ( self.docker_directory ) : - err_message = ( - ' { 0 : s } is not a Docker directory\n' - 'Please specify the Docker\ 's directory path.\n' - 'hint : de.py -r /var/lib/docker ' ) .format ( self.docker_directory ) - raise errors.BadStorageException ( err_message ) + msg = ' { 0 : s } is not a Docker directory\n'.format ( self.docker_directory ) + raise errors.BadStorageException ( msg ) self.containers_directory = os.path.join ( self.docker_directory , 'containers ' ) @ @ -156,14 +153,23 @ @ class DockerExplorer ( object ) : Returns : list ( Container ) : the list of Container objects . + + Raises : + errors.BadStorageException : If required files or directories are not found + in the provided Docker directory. `` '' '' + if not os.path.isdir ( self.containers_directory ) : + raise errors.BadStorageException ( + 'Containers directory { 0 } does not exist'.format ( + self.containers_directory ) ) container_ids_list = os.listdir ( self.containers_directory ) if not container_ids_list : - print (
diff -- git a/docker_explorer/de.py b/docker_explorer/de.py index 705287a..4817867 100644 -- - a/docker_explorer/de.py +++ b/docker_explorer/de.py @ @ -52,11 +52,8 @ @ class DockerExplorer ( object ) : `` '' '' self.docker_directory = docker_path if not os.path.isdir ( self.docker_directory ) : - err_message = ( - ' { 0 : s } is not a Docker directory\n' - 'Please specify the Docker\ 's directory path.\n' - 'hint : de.py -r /var/lib/docker ' ) .format ( self.docker_directory ) - raise errors.BadStorageException ( err_message ) + msg = ' { 0 : s } is not a Docker directory'.format ( self.docker_directory ) + raise errors.BadStorageException ( msg ) self.containers_directory = os.path.join ( self.docker_directory , 'containers ' ) @ @ -156,14 +153,23 @ @ class DockerExplorer ( object ) : Returns : list ( Container ) : the list of Container objects . + + Raises : + errors.BadStorageException : If required files or directories are not found + in the provided Docker directory. `` '' '' + if not os.path.isdir ( self.containers_directory ) : + raise errors.BadStorageException ( + 'Containers directory { 0 } does not exist'.format ( + self.containers_directory ) ) container_ids_list = os.listdir ( self.containers_directory ) if not container_ids_list : - print (
diff -- git a/cmd/nel-collector/main.go b/cmd/nel-collector/main.go index 4a3eb92..d39119c 100644 -- - a/cmd/nel-collector/main.go +++ b/cmd/nel-collector/main.go @ @ -17,16 +17,21 @ @ package main import ( - '' flag '' '' log '' '' net/http '' - '' os '' '' github.com/google/nel-collector/pkg/collector '' - '' github.com/google/nel-collector/pkg/core '' + _ `` github.com/google/nel-collector/pkg/core '' ) -var keepNonNelReports = flag.Bool ( `` keep-non-nel-reports '' , false , `` keep non-NEL reports '' ) +var defaultConfig = [ ] byte ( ` + [ [ processor ] ] +type = `` KeepNelReports '' + + [ [ processor ] ] +type = `` DumpReportsAsCLF '' +dest = `` stdout '' + ` ) var rootBody = [ ] byte ( ` < html > @ @ -50,10 +55,10 @ @ func handleRoot ( w http.ResponseWriter , r *http.Request ) { func main ( ) { pipeline : = & collector.Pipeline { } - if ! *keepNonNelReports { - pipeline.AddProcessor ( core.KeepNelReports { } ) + err : = pipeline.LoadFromConfig ( defaultConfig ) + if err ! = nil { + log.Fatal ( err ) } - pipeline.AddProcessor ( core.DumpReportsAsCLF { os.Stdout } ) http.HandleFunc ( `` / '' , handleRoot ) http.Handle ( `` /upload/ '' ,
diff -- git a/extensions/database/src/main/java/com/google/android/agera/database/SqlDatabaseFunctions.java b/extensions/database/src/main/java/com/google/android/agera/database/SqlDatabaseFunctions.java index 9019458..3b00296 100644 -- - a/extensions/database/src/main/java/com/google/android/agera/database/SqlDatabaseFunctions.java +++ b/extensions/database/src/main/java/com/google/android/agera/database/SqlDatabaseFunctions.java @ @ -83,7 +83,8 @ @ public final class SqlDatabaseFunctions { public Result < Long > merge ( @ NonNull final SQLiteDatabase database , @ NonNull final SqlInsertRequest input ) { try { - return success ( database.insertOrThrow ( input.table , null , input.contentValues ) ) ; + return success ( database.insertWithOnConflict ( input.table , null , input.contentValues , + input.conflictAlgorithm ) ) ; } catch ( final SQLException e ) { return failure ( e ) ; } @ @ -98,8 +99,8 @ @ public final class SqlDatabaseFunctions { public Result < Integer > merge ( @ NonNull final SQLiteDatabase database , @ NonNull final SqlUpdateRequest input ) { try { - return success ( database.update ( input.table , input.contentValues , input.where , - input.arguments ) ) ; + return success ( database.updateWithOnConflict ( input.table , input.contentValues , + input.where , input.arguments , input.conflictAlgorithm ) ) ; } catch ( final SQLException e ) { return failure ( e ) ; } diff -- git a/extensions/database/src/main/java/com/google/android/agera/database/SqlInsertRequest.java b/extensions/database/src/main/java/com/google/android/agera/database/SqlInsertRequest.java index e66edcc..f4a27eb 100644 -- - a/extensions/database/src/main/java/com/google/android/agera/database/SqlInsertRequest.java +++ b/extensions/database/src/main/java/com/google/android/agera/database/SqlInsertRequest.java @ @ -28,8 +28,11 @ @ public final class SqlInsertRequest {
diff -- git a/gerrit/README.md b/gerrit/README.md index f4fd376..a7517bf 100644 -- - a/gerrit/README.md +++ b/gerrit/README.md @ @ -70,11 +70,17 @ @ The given revision is updated with the given message and/or label ( s ) . just the resource name . * ` message ` : A message to be posted as a comment on the given revision . + The message can contain build metadata variables . ( e.g . : $ BUILD_ID ) + See the [ Concourse.CI Metadata Documentation ] ( https : //concourse.ci/implementing-resources.html # section_resource-metadata + for a complete list of variables . * ` message_file ` : Path to a file containing a message to be posted as a comment on the given revision . This overrides ` message ` *unless* reading ` message_file ` fails , in which case ` message ` is used instead . If reading ` message_file ` fails and ` message ` is not specified then the ` put ` will fail . + The message can contain build metadata variables . ( e.g . : $ BUILD_ID ) + See the [ Concourse.CI Metadata Documentation ] ( https : //concourse.ci/implementing-resources.html # section_resource-metadata + for a complete list of variables . *
diff -- git a/gerrit/README.md b/gerrit/README.md index f4fd376..e72a0ae 100644 -- - a/gerrit/README.md +++ b/gerrit/README.md @ @ -70,11 +70,17 @ @ The given revision is updated with the given message and/or label ( s ) . just the resource name . * ` message ` : A message to be posted as a comment on the given revision . + The message can contain build metadata variables . ( e.g . : $ { BUILD_ID } ) + See the [ Concourse.CI Metadata Documentation ] ( https : //concourse.ci/implementing-resources.html # section_resource-metadata + for a complete list of variables . * ` message_file ` : Path to a file containing a message to be posted as a comment on the given revision . This overrides ` message ` *unless* reading ` message_file ` fails , in which case ` message ` is used instead . If reading ` message_file ` fails and ` message ` is not specified then the ` put ` will fail . + The message can contain build metadata variables . ( e.g . : $ { BUILD_ID } ) + See the [ Concourse.CI Metadata Documentation ] ( https : //concourse.ci/implementing-resources.html # section_resource-metadata + for a complete list
diff -- git a/src/com/google/caja/lang/css/css3-whitelist.json b/src/com/google/caja/lang/css/css3-whitelist.json index d288246..73dbf93 100644 -- - a/src/com/google/caja/lang/css/css3-whitelist.json +++ b/src/com/google/caja/lang/css/css3-whitelist.json @ @ -162,7 +162,7 @ @ `` word-break '' , `` word-spacing '' , `` word-wrap '' , - `` z-index '' + `` z-index '' , `` zoom '' ] ,
diff -- git a/resources/META-INF/plugin.xml b/resources/META-INF/plugin.xml index b02e7ca..cc8ced1 100644 -- - a/resources/META-INF/plugin.xml +++ b/resources/META-INF/plugin.xml @ @ -122,6 +122,7 @ @ < fileIndentOptionsProvider implementation= '' com.google.bamboo.soy.format.SoyFileIndentOptionsProvider '' / > + < stubIndex implementation= '' com.google.bamboo.soy.stubs.index.NamespaceDeclarationIndex '' / > < stubIndex implementation= '' com.google.bamboo.soy.stubs.index.TemplateDefinitionIndex '' / > < ! -- Annotators -- > diff -- git a/src/com/google/bamboo/soy/TemplateNameUtils.java b/src/com/google/bamboo/soy/TemplateNameUtils.java index fba7e89..c3645c0 100644 -- - a/src/com/google/bamboo/soy/TemplateNameUtils.java +++ b/src/com/google/bamboo/soy/TemplateNameUtils.java @ @ -15,7 +15,10 @ @ package com.google.bamboo.soy ; import com.google.bamboo.soy.elements.TemplateDefinitionElement ; +import com.google.bamboo.soy.file.SoyFile ; import com.google.bamboo.soy.parser.SoyAliasBlock ; +import com.google.bamboo.soy.parser.SoyTemplateDefinitionIdentifier ; +import com.google.bamboo.soy.stubs.index.NamespaceDeclarationIndex ; import com.google.bamboo.soy.stubs.index.TemplateDefinitionIndex ; import com.google.common.collect.ImmutableList ; import com.intellij.openapi.project.Project ; @ @ -23,14 +26,15 @ @ import com.intellij.psi.PsiElement ; import com.intellij.psi.PsiFile ; import com.intellij.psi.search.GlobalSearchScope ; import com.intellij.psi.util.PsiTreeUtil ; -import java.util.ArrayList ; import java.util.Collection ; import java.util.HashMap ; import java.util.List ; import java.util.Map ; import java.util.stream.Collectors ; +import java.util.stream.Stream ; public class TemplateNameUtils { + /* Finds the only TemplateDefinition by its exact name . */ public static TemplateDefinitionElement findTemplateDefinition ( PsiElement element , String templateIdentifier ) { List < TemplateDefinitionElement > definitions = @ @ -38,29 +42,23 @ @ public class TemplateNameUtils { return definitions.size ( ) > = 1 ? definitions.get ( 0 ) : null ; } + /* Finds the matching
diff -- git a/auto_forensicate/auto_acquire.py b/auto_forensicate/auto_acquire.py index a7b0176..2de3807 100644 -- - a/auto_forensicate/auto_acquire.py +++ b/auto_forensicate/auto_acquire.py @ @ -14,6 +14,7 @ @ # limitations under the License . `` `` '' Automated forensics acquisition script . '' '' '' +from __future__ import print_function from __future__ import unicode_literals import argparse @ @ -346,11 +347,11 @ @ class AutoForensicate ( object ) : green_color_code = 2 if not self._errors : - print self._Colorize ( + print ( self._Colorize ( green_color_code , ( 'Everything has completed successfully , feel free to shut the system' ' down . ' ) - ) + ) ) return should_retry = False @ @ -360,16 +361,16 @ @ class AutoForensicate ( object ) : should_retry = True if should_retry : - print self._Colorize ( + print ( self._Colorize ( red_color_code , - 'There was a problem with the upload , please re-run the script . ' ) + 'There was a problem with the upload , please re-run the script . ' ) ) else : - print self._Colorize ( + print ( self._Colorize ( red_color_code , ( 'There was a problem with the upload , please keep the system ' 'running and contact the security person who told you
diff -- git a/AddressBook/GTMABAddressBook.m b/AddressBook/GTMABAddressBook.m index d92cb08..4a7d733 100644 -- - a/AddressBook/GTMABAddressBook.m +++ b/AddressBook/GTMABAddressBook.m @ @ -100,7 +100,9 @ @ typedef struct { if ( ! wasGood ) { _GTMDevLog ( @ '' Error in [ % @ % @ ] : % @ '' , [ self class ] , NSStringFromSelector ( _cmd ) , cfError ) ; - CFRelease ( cfError ) ; + if ( cfError ) { + CFRelease ( cfError ) ; + } } # else // GTM_IPHONE_SDK bool wasGood = ABSave ( addressBook_ ) ; diff -- git a/Foundation/GTMNSFileManager+Carbon.m b/Foundation/GTMNSFileManager+Carbon.m index 8bd5f69..fc990ae 100644 -- - a/Foundation/GTMNSFileManager+Carbon.m +++ b/Foundation/GTMNSFileManager+Carbon.m @ @ -91,7 +91,7 @ @ CantUseParams : fsRef = ( FSRef* ) [ fsRefData mutableBytes ] ; Boolean isDir = FALSE ; const UInt8 *filePath = ( const UInt8 * ) [ path fileSystemRepresentation ] ; - __Require_noErr_action ( FSPathMakeRef ( filePath , fsRef , & isDir ) , + __Require_noErr_Action ( FSPathMakeRef ( filePath , fsRef , & isDir ) , CantMakeRef , fsRef = NULL ) ; CantMakeRef : CantAllocateFSRef : diff -- git a/Foundation/GTMScriptRunnerTest.m b/Foundation/GTMScriptRunnerTest.m index c8050f5..5f52e61 100644 -- - a/Foundation/GTMScriptRunnerTest.m +++ b/Foundation/GTMScriptRunnerTest.m @ @ -218,6 +218,11 @ @ // Account for
diff -- git a/AddressBook/GTMABAddressBook.m b/AddressBook/GTMABAddressBook.m index d92cb08..4a7d733 100644 -- - a/AddressBook/GTMABAddressBook.m +++ b/AddressBook/GTMABAddressBook.m @ @ -100,7 +100,9 @ @ typedef struct { if ( ! wasGood ) { _GTMDevLog ( @ '' Error in [ % @ % @ ] : % @ '' , [ self class ] , NSStringFromSelector ( _cmd ) , cfError ) ; - CFRelease ( cfError ) ; + if ( cfError ) { + CFRelease ( cfError ) ; + } } # else // GTM_IPHONE_SDK bool wasGood = ABSave ( addressBook_ ) ; diff -- git a/Foundation/GTMNSFileManager+Carbon.m b/Foundation/GTMNSFileManager+Carbon.m index 8bd5f69..fc990ae 100644 -- - a/Foundation/GTMNSFileManager+Carbon.m +++ b/Foundation/GTMNSFileManager+Carbon.m @ @ -91,7 +91,7 @ @ CantUseParams : fsRef = ( FSRef* ) [ fsRefData mutableBytes ] ; Boolean isDir = FALSE ; const UInt8 *filePath = ( const UInt8 * ) [ path fileSystemRepresentation ] ; - __Require_noErr_action ( FSPathMakeRef ( filePath , fsRef , & isDir ) , + __Require_noErr_Action ( FSPathMakeRef ( filePath , fsRef , & isDir ) , CantMakeRef , fsRef = NULL ) ; CantMakeRef : CantAllocateFSRef : diff -- git a/Foundation/GTMNSThread+Blocks.h b/Foundation/GTMNSThread+Blocks.h index e3700bb..17bfbc7 100644 -- - a/Foundation/GTMNSThread+Blocks.h +++ b/Foundation/GTMNSThread+Blocks.h @ @ -30,10 +30,10 @ @ // and this
diff -- git a/rekall-core/rekall/plugins/overlays/basic.py b/rekall-core/rekall/plugins/overlays/basic.py index 6736410..98f50ea 100644 -- - a/rekall-core/rekall/plugins/overlays/basic.py +++ b/rekall-core/rekall/plugins/overlays/basic.py @ @ -670,7 +670,7 @ @ class UnixTimeStamp ( obj.NativeType ) : try : # Return a data time object in UTC . return arrow.Arrow.utcfromtimestamp ( self.v ( ) ) - except ( ValueError , TypeError ) as e : + except ( ValueError , TypeError , OSError ) as e : return obj.NoneObject ( `` Datetime conversion failure : `` + str ( e ) ) def as_datetime ( self ) :
diff -- git a/.gitignore b/.gitignore index 41779de..684d232 100644 -- - a/.gitignore +++ b/.gitignore @ @ -9,3 +9,10 @ @ xcuserdata dart/tests/Speedtest.dart.js.deps dart/tests/Speedtest.dart.js.map + + # Java Related +.settings/ +.classpath +.project +.metadata +target/ diff -- git a/java/pom.xml b/java/pom.xml new file mode 100644 index 0000000..ee28223 -- - /dev/null +++ b/java/pom.xml @ @ -0,0 +1,132 @ @ + < project xmlns= '' https : //maven.apache.org/POM/4.0.0 '' xmlns : xsi= '' https : //www.w3.org/2001/XMLSchema-instance '' + xsi : schemaLocation= '' https : //maven.apache.org/POM/4.0.0 https : //maven.apache.org/xsd/maven-4.0.0.xsd '' > + < modelVersion > 4.0.0 < /modelVersion > + < groupId > com.google < /groupId > + < artifactId > diff-match-patch < /artifactId > + < version > 1.0.0 < /version > + < packaging > jar < /packaging > + + < properties > + < java-version > 1.6 < /java-version > + < project.build.sourceEncoding > UTF-8 < /project.build.sourceEncoding > + < junit.version > 4.11 < /junit.version > + < /properties > + + < dependencies > + < dependency > + < groupId > junit < /groupId > + < artifactId > junit < /artifactId > + < version > $ { junit.version } < /version > + < scope > test < /scope
diff -- git a/csharp/.gitignore b/csharp/.gitignore new file mode 100644 index 0000000..bd6764d -- - /dev/null +++ b/csharp/.gitignore @ @ -0,0 +1,340 @ @ + + # Created by https : //www.gitignore.io/api/visualstudio + + # # # VisualStudio # # # + # # Ignore Visual Studio temporary files , build results , and + # # files generated by popular Visual Studio add-ons . + # # + # # Get latest from https : //github.com/github/gitignore/blob/master/VisualStudio.gitignore + + # User-specific files +*.suo +*.user +*.userosscache +*.sln.docstates + + # User-specific files ( MonoDevelop/Xamarin Studio ) +*.userprefs + + # Build results + [ Dd ] ebug/ + [ Dd ] ebugPublic/ + [ Rr ] elease/ + [ Rr ] eleases/ +x64/ +x86/ +bld/ + [ Bb ] in/ + [ Oo ] bj/ + [ Ll ] og/ + + # Visual Studio 2015/2017 cache/options directory +.vs/ + # Uncomment if you have tasks that create the project 's static files in wwwroot + # wwwroot/ + + # Visual Studio 2017 auto generated files +Generated\ Files/ + + # MSTest test Results + [ Tt ] est [ Rr ] esult*/ + [ Bb ] uild [ Ll ] og
diff -- git a/textfsm.py b/textfsm.py index 3b1d75c..a663f4c 100755 -- - a/textfsm.py +++ b/textfsm.py @ @ -905,7 +905,7 @ @ class TextFSM ( object ) : for value in matched.groupdict ( ) : self._AssignVar ( matched , value ) - if self._Operations ( rule ) : + if self._Operations ( rule , line ) : # Not a Continue so check for state transition . if rule.new_state : if rule.new_state not in ( 'End ' , 'EOF ' ) : @ @ -941,7 +941,7 @ @ class TextFSM ( object ) : if _value is not None : _value.AssignVar ( matched.group ( value ) ) - def _Operations ( self , rule ) : + def _Operations ( self , rule , line ) : `` '' '' Operators on the data record . Operators come in two parts and are a ' . ' separated pair : @ @ -959,6 +959,7 @ @ class TextFSM ( object ) : Args : rule : FSMRule object . + line : A string , the current input line . Returns : True if state machine should restart state with new line . @ @ -981,11 +982,11 @ @ class TextFSM ( object
diff -- git a/README.md b/README.md index 2b5b8ce..f303858 100644 -- - a/README.md +++ b/README.md @ @ -1,6 +1,6 @ @ # percy-node -This is a wrapper of [ percy-js ] ( https : //github.com/percy/percy-js ) that simplifies the API so it can be used for node based test workflows such as testing an express app , an Angular app , or AngularJS app . +This is a wrapper of [ percy-js ] ( https : //github.com/percy/percy-js ) that simplifies the API so it can be used for automated visual regression testing in node environments such as testing an express app , an Angular app , or AngularJS app . For more general information about Percy , visit [ Percy 's homepage ] ( https : //percy.io/ ) @ @ -8,11 +8,11 @ @ This is not an official Google product . # # How to use -npm install - git+https : //webmaster.googlesource.com/percy-node - -- save +Percy-node is an installable [ npm package ] ( https : //www.npmjs.com/package/percy-node ) . -TODO ( bogusred ) + `` ` +npm install percy-node -- save-dev + `` ` # # Motivation This package was originally created specifically to allow testing of Express AngularJS apps tested
diff -- git a/CONTRIBUTING.md b/CONTRIBUTING.md index a854130..68445fc 100644 -- - a/CONTRIBUTING.md +++ b/CONTRIBUTING.md @ @ -1,70 +1,152 @ @ # How to Contribute -We would love to accept your patches and contributions to this project . Here is how you can help . +We would love to accept your patches and contributions to this project . Here is +how you can help . # # Filing issues -Filing issues is an important way you can contribute to the Wire Project . We want your feedback on things like bugs , desired API changes , or just anything that is n't working for you . + +Filing issues is an important way you can contribute to the Wire Project . We +want your feedback on things like bugs , desired API changes , or just anything +that is n't working for you . # # # Bugs -If your issue is a bug , open one [ here ] ( https : //github.com/google/wire/issues/new ) . The easiest way to file an issue with all the right information is to run ` go bug ` . ` go bug ` will print out a handy template of questions and system information that
diff -- git a/CONTRIBUTING.md b/CONTRIBUTING.md index a854130..68445fc 100644 -- - a/CONTRIBUTING.md +++ b/CONTRIBUTING.md @ @ -1,70 +1,152 @ @ # How to Contribute -We would love to accept your patches and contributions to this project . Here is how you can help . +We would love to accept your patches and contributions to this project . Here is +how you can help . # # Filing issues -Filing issues is an important way you can contribute to the Wire Project . We want your feedback on things like bugs , desired API changes , or just anything that is n't working for you . + +Filing issues is an important way you can contribute to the Wire Project . We +want your feedback on things like bugs , desired API changes , or just anything +that is n't working for you . # # # Bugs -If your issue is a bug , open one [ here ] ( https : //github.com/google/wire/issues/new ) . The easiest way to file an issue with all the right information is to run ` go bug ` . ` go bug ` will print out a handy template of questions and system information that
diff -- git a/guetzli.make b/guetzli.make index cffae1b..1a8febc 100644 -- - a/guetzli.make +++ b/guetzli.make @ @ -15,7 +15,7 @ @ ifeq ( $ ( config ) , release ) TARGETDIR = bin/Release TARGET = $ ( TARGETDIR ) /guetzli OBJDIR = obj/Release - DEFINES += -DGFLAGS_NAMESPACE=google + DEFINES += INCLUDES += -I . -Ithird_party/butteraugli FORCE_INCLUDE += ALL_CPPFLAGS += $ ( CPPFLAGS ) -MMD -MP $ ( DEFINES ) $ ( INCLUDES ) @ @ -42,7 +42,7 @ @ ifeq ( $ ( config ) , debug ) TARGETDIR = bin/Debug TARGET = $ ( TARGETDIR ) /guetzli OBJDIR = obj/Debug - DEFINES += -DGFLAGS_NAMESPACE=google + DEFINES += INCLUDES += -I . -Ithird_party/butteraugli FORCE_INCLUDE += ALL_CPPFLAGS += $ ( CPPFLAGS ) -MMD -MP $ ( DEFINES ) $ ( INCLUDES ) diff -- git a/guetzli.vcxproj b/guetzli.vcxproj index 015d5ed..d14db62 100644 -- - a/guetzli.vcxproj +++ b/guetzli.vcxproj @ @ -97,7 +97,6 @ @ < ClCompile > < PrecompiledHeader > NotUsing < /PrecompiledHeader > < WarningLevel > Level3 < /WarningLevel > - < PreprocessorDefinitions > GFLAGS_NAMESPACE=google ; % ( PreprocessorDefinitions ) < /PreprocessorDefinitions > < AdditionalIncludeDirectories > . ; third_party\butteraugli ; % ( AdditionalIncludeDirectories ) < /AdditionalIncludeDirectories > < Optimization > Full < /Optimization > <
diff -- git a/guetzli/output_image.cc b/guetzli/output_image.cc index cd2a371..fc2546b 100644 -- - a/guetzli/output_image.cc +++ b/guetzli/output_image.cc @ @ -21,6 +21,7 @ @ # include < stdio.h > # include < string.h > # include < cmath > + # include < cstdlib > # include `` guetzli/idct.h '' # include `` guetzli/color_transform.h ''
diff -- git a/client/v2_2/docker_image_.py b/client/v2_2/docker_image_.py index e0ee577..314d746 100755 -- - a/client/v2_2/docker_image_.py +++ b/client/v2_2/docker_image_.py @ @ -453,6 +453,12 @ @ class FromTarball ( DockerImage ) : return self._content ( self._blob_names [ digest ] , # pytype : disable=none-attr memoize=False ) + def layer_blob ( self , index ) : + `` '' '' Returns the uncompressed blob for the layer at the given index . '' '' '' + if index < len ( self._layers ) : + return self._content ( self._layers [ index ] , memoize=False ) + return None + # Could be large , do not memoize def blob ( self , digest ) : `` '' '' Override . '' '' '' diff -- git a/client/v2_2/save_.py b/client/v2_2/save_.py index 29d60e7..cda477c 100755 -- - a/client/v2_2/save_.py +++ b/client/v2_2/save_.py @ @ -185,3 +185,30 @ @ def fast ( future.result ( ) return ( config_file , layers ) + +def fast_minimal ( + image , + directory , + ) : + `` '' '' Similar to fast but produces a reduced image layout . + + This layout contains only the uncompressed_layers and the config json , + and is suitable for consumption by bazel 's container_import . + `` ''
diff -- git a/transform/v2_2/metadata_.py b/transform/v2_2/metadata_.py index f63c0ce..74bdc2e 100755 -- - a/transform/v2_2/metadata_.py +++ b/transform/v2_2/metadata_.py @ @ -29,7 +29,7 @ @ _OverridesT = namedtuple ( 'OverridesT ' , [ # Unix epoch 0 , representable in 32 bits . _DEFAULT_TIMESTAMP = '1970-01-01T00:00:00Z' -_EMPTY_LAYER = hashlib.sha256 ( `` ) .hexdigest ( ) +_EMPTY_LAYER = hashlib.sha256 ( `` .encode ( 'utf-8 ' ) ) .hexdigest ( ) class Overrides ( _OverridesT ) :
diff -- git a/compiler/python_archive.py b/compiler/python_archive.py index 3dfdba0..822c9de 100755 -- - a/compiler/python_archive.py +++ b/compiler/python_archive.py @ @ -50,6 +50,27 @ @ del _ # End boilerplate `` '' '' + # Boilerplate must be after the last __future__ import . See + # https : //docs.python.org/2/reference/simple_stmts.html # future +_boilerplate_insertion_regex = re.compile ( `` ' ( ? sx ) + ( ? P < before > + ( + ( + ( [ # ] [ ^\\r\\n ] * ) | # comment + ( \\s* ) | # whitespace + ( from\\s+__future__\\s+import\\s+ [ ^\\r\\n ] + ) | # future import + ( ' [ ^ ' ] .* ? ' ) | # module doc comment form 1 + ( `` [ ^ '' ] .* ? '' ) | # module doc comment form 2 + ( \'\'\'.* ? ( \'\'\ ' ) ) | # module doc comment form 3 + ( `` '' '' .* ? '' '' '' ) # module doc comment form 4 + ) + [ \\r\\n ] + # end of line ( s ) for Mac , Unix and/or Windows + ) * + ) + # Boilerplate is inserted here +
diff -- git a/build.gradle b/build.gradle index 5283f0e..8ffc382 100644 -- - a/build.gradle +++ b/build.gradle @ @ -4,7 +4,7 @ @ buildscript { } dependencies { classpath 'com.android.tools.build : gradle:2.3.3' - classpath 'me.tatarka : gradle-retrolambda:3.5.0' + classpath 'me.tatarka : gradle-retrolambda:3.7.0' // NOTE : Do not place your application dependencies here. } @ @ -31,7 +31,7 @ @ allprojects { android { compileSdkVersion 24 - buildToolsVersion '25.0.0' + buildToolsVersion '25.0.3' defaultConfig { applicationId `` com.google.android.mobly.snippet.bundled '' @ @ -50,6 +50,7 @ @ android { abortOnError true checkAllWarnings true warningsAsErrors true + disable 'HardwareIds ' , 'MissingApplicationIcon ' , 'GoogleAppIndexingWarning ' , 'InvalidPackage ' , 'OldTargetApi' } } @ @ -72,10 +73,10 @ @ artifacts { dependencies { compile 'com.android.support.test : runner:0.5' compile 'com.google.android.mobly : mobly-snippet-lib:1.2.0' - compile 'com.google.code.gson : gson:2.6.2' + compile 'com.google.code.gson : gson:2.8.2' compile 'com.google.guava : guava:20.0' - testCompile 'com.google.truth : truth:0.32' + testCompile 'com.google.truth : truth:0.36' testCompile 'junit : junit:4.12' } diff -- git a/src/main/AndroidManifest.xml b/src/main/AndroidManifest.xml index dc5d0af..0a0dad3 100644 -- - a/src/main/AndroidManifest.xml +++ b/src/main/AndroidManifest.xml @ @ -3,6 +3,8 @ @ xmlns : android= '' http : //schemas.android.com/apk/res/android '' package= '' com.google.android.mobly.snippet.bundled '' > + < uses-feature android : name= '' android.hardware.telephony '' android : required= '' false '' / >
diff -- git a/README.md b/README.md index 0dfcfbb..4dd4fd3 100644 -- - a/README.md +++ b/README.md @ @ -38,6 +38,22 @ @ Note : this is not an official Google product . self.ad.api.wifiEnable ( ) `` ` + # # Develop + +If you want to contribute , use the usual github method of forking and sending +a pull request . + +Before sending a pull request , run the ` presubmit ` target to format and run +lint over the code . Fix any issues it indicates . When complete , ask for the +pull request . + + `` ` shell +./gradlew presubmit + `` ` + +This target will reformat the code with + [ googleJavaFormat ] ( https : //github.com/sherter/google-java-format-gradle-plugin ) +and run lint . The lint report should open in your default browser . # # Other resources diff -- git a/build.gradle b/build.gradle index 5283f0e..114e5ba 100644 -- - a/build.gradle +++ b/build.gradle @ @ -4,7 +4,7 @ @ buildscript { } dependencies { classpath 'com.android.tools.build : gradle:2.3.3' - classpath 'me.tatarka : gradle-retrolambda:3.5.0' + classpath 'me.tatarka : gradle-retrolambda:3.7.0' // NOTE : Do not place your application dependencies here. } @ @ -31,7 +31,7 @ @ allprojects { android { compileSdkVersion
diff -- git a/safebrowser.go b/safebrowser.go index d6fbef7..2363ac1 100644 -- - a/safebrowser.go +++ b/safebrowser.go @ @ -370,9 +370,20 @ @ func ( sb *SafeBrowser ) LookupURLs ( urls [ ] string ) ( threats [ ] [ ] URLThreat , err err // TODO : There are some optimizations to be made here : // 1 . ) We could force a database update if it is in error . // However , we must ensure that we perform some form of rate-limiting . - // 2 . ) We should batch all of the partial hashes together such that we - // call api.HashLookup only once . - + // Construct the follow-up request being made to the server . + // In the request , we only ask for partial hashes for privacy reasons . + req : = & pb.FindFullHashesRequest { + Client : & pb.ClientInfo { + ClientId : sb.config.ID , + ClientVersion : sb.config.Version , + } , + ThreatInfo : & pb.ThreatInfo { } , + } + unsureFullHashes : = make ( map [ hashPrefix ] struct { + pattern string + reqIndex int + } ) + var urlCount int64 for i ,
diff -- git a/man/google-authenticator.1 b/man/google-authenticator.1 new file mode 100644 index 0000000..eb31a7b -- - /dev/null +++ b/man/google-authenticator.1 @ @ -0,0 +1,191 @ @ +.\ '' Automatically generated by Pandoc 1.16.0.2 +.\ '' +.TH `` GOOGLE\-AUTHENTICATOR '' `` 1 '' `` '' `` Google two\-factor authentication user manual '' `` '' +.hy +.SH NAME +.PP +google\-authenticator \- initialize one\-time passcodes for the current +user +.SH SYNOPSIS +.PP +google\-authenticator [ \f [ I ] options\f [ ] ] +.PP +If no option is provided on the command line , google\-authenticator ( 1 ) +will ask interactively the user for the more important options . +.SH DESCRIPTION +.PP +The google\-authenticator ( 1 ) command creates a new secret key in the +current user\ [ aq ] s home directory . +By default , this secret key and all settings will be stored in +\f [ C ] ~/.google_authenticator\f [ ] . +.PP +If the system supports the \f [ C ] libqrencode\f [ ] library , a QRCode will +be shown , that can be scanned using the Android Google Authenticator +application . +If the system does not have this library , google\-authenticator ( 1 ) +outputs an URL that can be followed using
diff -- git a/BUILD b/BUILD index a87a02f..7509fa4 100644 -- - a/BUILD +++ b/BUILD @ @ -15,6 +15,21 @ @ common_deps = [ test_srcs = glob ( [ `` java/com/google/security/wycheproof/testcases/*.java '' ] ) + [ `` java/com/google/security/wycheproof/WycheproofRunner.java '' ] + # We can not supply $ ( BOUNCYCASTLE_JAR ) directly to the 'jars' + # attribute of java_import , but we can generate a symlink . + # TODO ( wycheproof-team ) : is there an easier way to supply + # deps from the command line ? +java_import ( + name = `` bouncycastle_jar '' , + jars = [ `` bouncycastle.jar '' ] , + ) + +genrule ( + name = `` bouncycastle_symlink '' , + outs = [ `` bouncycastle.jar '' ] , + cmd = `` ln -sf $ ( BOUNCYCASTLE_JAR ) $ @ '' , + ) + # These targets run all tests . load ( `` : build_defs.bzl '' , `` bouncycastle_all_tests '' , `` spongycastle_all_tests '' ) @ @ -29,7 +44,11 @ @ load ( `` : build_defs.bzl '' , `` bouncycastle_all_tests '' , `` spongycastle_all_tests '' ) # $ bazel test BouncyCastleAllTests_1_52 # # To test all known versions ( warning
diff -- git a/java/com/google/security/wycheproof/testcases/AesEaxTest.java b/java/com/google/security/wycheproof/testcases/AesEaxTest.java index 3237afa..3976c84 100644 -- - a/java/com/google/security/wycheproof/testcases/AesEaxTest.java +++ b/java/com/google/security/wycheproof/testcases/AesEaxTest.java @ @ -22,13 +22,15 @ @ package com.google.security.wycheproof ; +import static org.junit.Assert . * ; + import javax.crypto.Cipher ; import javax.crypto.spec.GCMParameterSpec ; import javax.crypto.spec.SecretKeySpec ; -import junit.framework.TestCase ; +import org.junit.Test ; /** AES-EAX tests */ -public class AesEaxTest extends TestCase { +public class AesEaxTest { /** Test vectors */ public static class EaxTestVector { @ @ -264,6 +266,7 @ @ public class AesEaxTest extends TestCase { } } + @ Test public void testLateUpdateAAD ( ) throws Exception { for ( EaxTestVector test : EAX_TEST_VECTOR ) { Cipher cipher = Cipher.getInstance ( `` AES/EAX/NoPadding '' ) ; diff -- git a/java/com/google/security/wycheproof/testcases/AesGcmTest.java b/java/com/google/security/wycheproof/testcases/AesGcmTest.java index c69e5b1..27873d4 100644 -- - a/java/com/google/security/wycheproof/testcases/AesGcmTest.java +++ b/java/com/google/security/wycheproof/testcases/AesGcmTest.java @ @ -16,7 +16,7 @ @ package com.google.security.wycheproof ; -import static org.junit.Assert.assertArrayEquals ; +import static org.junit.Assert . * ; import com.google.security.wycheproof.WycheproofRunner.ExcludedTest ; import com.google.security.wycheproof.WycheproofRunner.ProviderType ; @ @ -35,7 +35,7 @ @ import javax.crypto.ShortBufferException ; import javax.crypto.spec.GCMParameterSpec ; import javax.crypto.spec.IvParameterSpec ; import javax.crypto.spec.SecretKeySpec ; -import junit.framework.TestCase ; +import org.junit.Test ; // TODO ( bleichen ) : // - For EAX I was able to derive some special cases by inverting OMAC . @ @ -45,7 +45,7 @ @
diff -- git a/doc/index.md b/doc/index.md index c664ba1..0d570e6 100644 -- - a/doc/index.md +++ b/doc/index.md @ @ -1,7 +1,7 @ @ # Project Wycheproof This page describes the goals and strategies of project Wycheproof . See - [ README ] ( ../README.md ) for introduction to the project . + [ README ] ( ../README.md ) for an introduction to the project . # # Defense in depth @ @ -33,7 +33,7 @ @ rather than exploitability . Examples : One of the goals of Wycheproof is to test for compatibility issues . Switching JCE providers should not introduce vulnerabilities simply because -the solution was developed with another provider . +the solution was developed by another provider . An example for this was the following observation : When using AES-GCM then javax.crypto.CipherInputStream worked sort of with JCE and @ @ -49,10 +49,10 @ @ cryptographic libraries based on the bugs found would be biased : * Libraries used internally in Google get more attention . Serious vulnerabilities in these libraries should be fixed at the time the tests are added to Wycheproof . On the other hand it is also likely that - tests find a larger number of bugs in thsese
diff -- git a/README.md b/README.md index d9fee13..f5cf957 100644 -- - a/README.md +++ b/README.md @ @ -84,7 +84,7 @ @ providers in [ OpenJDK ] ( http : //openjdk.java.net/ ) . - Install [ Java Cryptography Extension ( JCE ) Unlimited Strength Jurisdiction Policy Files ] ( http : //stackoverflow.com/questions/6481627/java-security-illegal-key-size-or-default-parameters ) : this enables tests with large key -sizes . Otherwise you 'll see a lot of `` iilegal key size '' exceptions . +sizes . Otherwise you 'll see a lot of `` illegal key size '' exceptions . - Check out the tests @ @ -155,8 +155,8 @ @ BouncyCastleTest , SpongyCastleTest or OpenJDKTest -- these targets exclude all slow tests ( which are annotated with @ SlowTest ) . Most test targets are failing , and each failure might be a security issue . To -learn more about what a failed test means , you might want to check out our -documentation ( doc/bugs.md ) or the comments on top of the corresponding test +learn more about what a failed test means , you might want to check out [ our +documentation ] ( doc/bugs.md ) or the comments on top of the corresponding test function and test
diff -- git a/library/build.gradle b/library/build.gradle index 30b53bd..fa88c3d 100644 -- - a/library/build.gradle +++ b/library/build.gradle @ @ -14,13 +14,21 @ @ apply plugin : 'com.android.library' + +def final toolsVersion = '25.0.1' +def final compileSdk = 25 +def final minSdk = 9 +def final targetSdk = 25 +def final supportLibrary = '25.0.1' + + android { - compileSdkVersion rootProject.ext.compileSdkVersion - buildToolsVersion rootProject.ext.buildToolsVersion + compileSdkVersion compileSdk + buildToolsVersion toolsVersion defaultConfig { - minSdkVersion rootProject.ext.minSdkVersion - targetSdkVersion rootProject.ext.targetSdkVersion + minSdkVersion minSdk + targetSdkVersion targetSdk testInstrumentationRunner 'android.support.test.runner.AndroidJUnitRunner' } buildTypes { @ @ -39,8 +47,8 @ @ android { } dependencies { - compile `` com.android.support : support-annotations : $ supportLibraryVersion '' - compile `` com.android.support : support-v4 : $ supportLibraryVersion '' + compile `` com.android.support : support-annotations : $ supportLibrary '' + compile `` com.android.support : support-v4 : $ supportLibrary '' // Tests testCompile 'junit : junit:4.12' @ @ -50,4 +58,6 @ @ dependencies { androidTestCompile ( 'com.android.support.test.espresso : espresso-core:2.2.2 ' ) { exclude module : 'support-annotations' } + + compile 'com.google.android.gms : play-services-vision:10.0.1' } diff -- git a/library/src/main/AndroidManifest.xml b/library/src/main/AndroidManifest.xml index 2c634fb..feedf8b 100644 -- - a/library/src/main/AndroidManifest.xml +++ b/library/src/main/AndroidManifest.xml @ @ -15,11 +15,8 @ @ xmlns : android= '' http : //schemas.android.com/apk/res/android '' > < uses-permission android
diff -- git a/cmp/compare.go b/cmp/compare.go index ae5ad96..694a933 100644 -- - a/cmp/compare.go +++ b/cmp/compare.go @ @ -69,12 +69,13 @ @ import ( // Structs are equal if all of their fields are equal . If a struct contains // unexported fields , Equal panics unless the AllowUnexported option is used or // an Ignore option ( e.g. , cmpopts.IgnoreUnexported ) ignores that field . -// Slices and arrays are equal if they have the same length and the elements -// at each index are equal . -// Maps are equal if their keys are exactly equal ( according to the == operator ) -// and the corresponding elements for each key are equal . To specify a custom -// comparison for map keys , use a Transformer to convert the map to a -// corresponding slice type . +// +// Arrays , slices , and maps are equal if they are both nil or both non-nil +// with the same length and the elements at each index or key are equal . +// Note that a non-nil empty slice and a nil slice are not equal . +// To equate empty slices and maps , consider using cmpopts.EquateEmpty . +// Map
diff -- git a/cmp/compare.go b/cmp/compare.go index 1260603..b56d634 100644 -- - a/cmp/compare.go +++ b/cmp/compare.go @ @ -29,6 +29,7 @ @ package cmp import ( '' fmt '' '' reflect '' + '' strings '' '' github.com/google/go-cmp/cmp/internal/diff '' '' github.com/google/go-cmp/cmp/internal/function '' @ @ -112,6 +113,10 @ @ type state struct { curPath Path // The current path in the value tree reporter reporter // Optional reporter used for difference formatting + // recChecker checks for infinite cycles applying the same set of + // transformers upon the output of itself . + recChecker recChecker + // dynChecker triggers pseudo-random checks for option correctness . // It is safe for statelessCompare to mutate this value . dynChecker dynChecker @ @ -181,6 +186,7 @ @ func ( s *state ) statelessCompare ( vx , vy reflect.Value ) diff.Result { func ( s *state ) compareAny ( vx , vy reflect.Value ) { // TODO : Support cyclic data structures . + s.recChecker.Check ( s.curPath ) // Rule 0 : Differing types are never equal . if ! vx.IsValid ( ) || ! vy.IsValid ( ) { @ @ -518,6 +524,45 @ @ func ( s *state ) report ( eq bool , vx ,
diff -- git a/tangent/anf.py b/tangent/anf.py index cb71946..eee1780 100644 -- - a/tangent/anf.py +++ b/tangent/anf.py @ @ -150,12 +150,19 @ @ class ANF ( transformers.TreeTransformer ) : return node def visit_AugAssign ( self , node ) : + self.src = quoting.unquote ( node ) self.trivializing = True - left = self.trivialize ( node.target ) + self.namer.target = node.target right = self.trivialize ( node.value ) + target = self.trivialize ( node.target ) + left = gast.Name ( id=target.id , ctx=gast.Load ( ) , annotation=None ) + node = gast.Assign ( targets= [ target ] , + value=gast.BinOp ( + left=left , op=node.op , right=right ) ) + self.mark ( node ) + node = self.generic_visit ( node ) + self.namer.target = None self.trivializing = False - node = gast.Assign ( targets= [ node.target ] , - value=gast.BinOp ( left=left , op=node.op , right=right ) ) return node def visit_Assign ( self , node ) : @ @ -182,7 +189,7 @ @ class ANF ( transformers.TreeTransformer ) : self.append ( stmt ) node.targets [ 0 ] = target elif not isinstance ( node.targets [ 0 ] , gast.Name ) : - raise ValueError + raise ValueError ( ' Can not Assign to % s
diff -- git a/environment.yml b/environment.yml index f294673..e7b949b 100644 -- - a/environment.yml +++ b/environment.yml @ @ -9,6 +9,6 @ @ dependencies : - six - pip : - autograd - - astor > =0.6 + - astor==0.6 - gast - - tf-nightly > =1.5.0.dev20171026 \ No newline at end of file + - tf-nightly > =1.5.0.dev20171026 diff -- git a/requirements.txt b/requirements.txt index 26b548b..d64b1b4 100644 -- - a/requirements.txt +++ b/requirements.txt @ @ -1,5 +1,5 @ @ autograd > =1.2 -astor > =0.6 +astor==0.6 enum34 future gast diff -- git a/setup.py b/setup.py index d040c89..f74c0a4 100644 -- - a/setup.py +++ b/setup.py @ @ -24,7 +24,7 @ @ setup ( 'deep-learning' ] , install_requires= [ - 'astor > =0.6 ' , + 'astor==0.6 ' , 'autograd > =1.2 ' , 'enum34 ' , 'future ' ,
diff -- git a/CONTRIBUTING.md b/CONTRIBUTING.md index 8425db9..dd9c41b 100644 -- - a/CONTRIBUTING.md +++ b/CONTRIBUTING.md @ @ -17,22 +17,4 @ @ Follow either of the two links above to access the appropriate CLA and instructi # # # Contributing code - # # # # Adding new derivatives - -We still have a lot of derivatives we need to write ! To add a new derivative for a primitive operation , - -- [ Read the docs on how to write derivatives in Tangent , and look at some examples ] ( https : //github.com/google/tangent/blob/7bf4eaffd646a5906aa15a852f117833d37fb09a/tangent/grads.py # L14-L33 ) ! -- Add your primitive op 's reverse-mode derivative to grads.py ( example reverse-mode derivative [ for np.sin ] ( https : //github.com/google/tangent/blob/7bf4eaffd646a5906aa15a852f117833d37fb09a/tangent/grads.py # L230-L232 ) , and for [ tf.sin ] ( https : //github.com/google/tangent/blob/7bf4eaffd646a5906aa15a852f117833d37fb09a/tangent/tf_extensions.py # L183-L185 ) ) . -- Add its forward-mode derivative to tangents.py ( example forward-mode derivative for [ np.sin ] ( https : //github.com/google/tangent/blob/7bf4eaffd646a5906aa15a852f117833d37fb09a/tangent/tangents.py # L144-L146 ) , and for [ tf.sin ] ( https : //github.com/google/tangent/blob/7bf4eaffd646a5906aa15a852f117833d37fb09a/tangent/tf_extensions.py # L344-L346 ) ) -- Add a function using the primitive operation in functions.py . Our tests will pick up on it automatically ( [ example test function ] ( https
diff -- git a/setup.py b/setup.py index cd62b1a..372be55 100644 -- - a/setup.py +++ b/setup.py @ @ -1,10 +1,10 @ @ from setuptools import find_packages from setuptools import setup -with open ( 'README.md ' ) as f : +with open ( 'README.md ' , encoding='utf-8 ' ) as f : readme = f.read ( ) -with open ( 'LICENSE ' ) as f : +with open ( 'LICENSE ' , encoding='utf-8 ' ) as f : lic = f.read ( ) setup (
diff -- git a/adb/adb_protocol.py b/adb/adb_protocol.py index daaac1b..fa11d21 100644 -- - a/adb/adb_protocol.py +++ b/adb/adb_protocol.py @ @ -226,7 +226,11 @ @ class AdbMessage ( object ) : cmd , ( timeout_ms , total_timeout_ms ) ) if data_length > 0 : - data = usb.BulkRead ( data_length , timeout_ms ) + data = `` + while data_length > 0 : + temp = usb.BulkRead ( data_length , timeout_ms ) + data = data + temp + data_length = data_length - len ( temp ) actual_checksum = cls.CalculateChecksum ( data ) if actual_checksum ! = data_checksum : raise InvalidChecksumError (
diff -- git a/adb/adb_commands.py b/adb/adb_commands.py index 667b713..e88aa88 100644 -- - a/adb/adb_commands.py +++ b/adb/adb_commands.py @ @ -127,7 +127,7 @ @ class AdbCommands ( object ) : # If there isnt a handle override ( used by tests ) , build one here if 'handle ' in kwargs : self._handle = kwargs.pop ( 'handle ' ) - elif serial and b ' : ' in serial : + elif serial and ' : ' in serial : self._handle = common.TcpHandle ( serial , timeout_ms=default_timeout_ms ) else : self._handle = common.UsbHandle.FindAndOpen ( diff -- git a/adb/adb_protocol.py b/adb/adb_protocol.py index 9654e51..4ff28c7 100644 -- - a/adb/adb_protocol.py +++ b/adb/adb_protocol.py @ @ -302,6 +302,11 @ @ class AdbMessage ( object ) : InvalidResponseError : When the device does authentication in an unexpected way. `` '' '' + # In py3 , convert unicode to bytes . In py2 , convert str to bytes . + # It 's later joined into a byte string , so in py2 , this ends up kind of being a no-op . + if isinstance ( banner , str ) : + banner = bytearray ( banner , 'utf-8 ' ) + msg = cls ( command=b'CNXN ' , arg0=VERSION , arg1=MAX_ADB_DATA
diff -- git a/adb/adb_commands.py b/adb/adb_commands.py index 667b713..f3667c8 100644 -- - a/adb/adb_commands.py +++ b/adb/adb_commands.py @ @ -127,12 +127,17 @ @ class AdbCommands ( object ) : # If there isnt a handle override ( used by tests ) , build one here if 'handle ' in kwargs : self._handle = kwargs.pop ( 'handle ' ) - elif serial and b ' : ' in serial : - self._handle = common.TcpHandle ( serial , timeout_ms=default_timeout_ms ) else : - self._handle = common.UsbHandle.FindAndOpen ( - DeviceIsAvailable , port_path=port_path , serial=serial , - timeout_ms=default_timeout_ms ) + # if necessary , convert serial to a unicode string + if isinstance ( serial , ( bytes , bytearray ) ) : + serial = serial.decode ( 'utf-8 ' ) + + if serial and ' : ' in serial : + self._handle = common.TcpHandle ( serial , timeout_ms=default_timeout_ms ) + else : + self._handle = common.UsbHandle.FindAndOpen ( + DeviceIsAvailable , port_path=port_path , serial=serial , + timeout_ms=default_timeout_ms ) self._Connect ( **kwargs ) diff -- git a/adb/adb_protocol.py b/adb/adb_protocol.py index 9654e51..4ff28c7 100644 -- - a/adb/adb_protocol.py +++ b/adb/adb_protocol.py @ @ -302,6 +302,11 @ @ class AdbMessage ( object ) : InvalidResponseError : When the device does authentication in an unexpected
diff -- git a/DEPS b/DEPS index 1169781..e803f40 100644 -- - a/DEPS +++ b/DEPS @ @ -57,6 +57,9 @ @ deps = { `` src/packager/third_party/tcmalloc/chromium '' : Var ( `` chromium_git '' ) + `` /chromium/src/third_party/tcmalloc/chromium @ fa1492f75861094061043a17c0f779c3d35780bf '' , + `` src/packager/third_party/zlib '' : + Var ( `` chromium_git '' ) + `` /chromium/src/third_party/zlib @ bcf81d2e5f3a62b698d179c1fadba94604c5dad3 '' , + `` src/packager/tools/clang '' : Var ( `` chromium_git '' ) + `` /chromium/src/tools/clang @ 0de8f3bb6af64e13876273c601704795d5e00faf '' , @ @ -69,10 +72,6 @ @ deps = { deps_os = { `` unix '' : { # Linux , actually . - # Required by build/linux/system.gyp . - `` src/packager/third_party/zlib '' : - Var ( `` chromium_git '' ) + `` /chromium/src/third_party/zlib @ bcf81d2e5f3a62b698d179c1fadba94604c5dad3 '' , - # Linux gold build to build faster . `` src/packager/third_party/gold '' : Var ( `` chromium_git '' ) + `` /chromium/deps/gold @ 29ae7431b4688df544ea840b0b66784e5dd298fe '' , diff -- git a/packager/media/base/media_base.gyp b/packager/media/base/media_base.gyp index 20a58a6..0183d75 100644 -- - a/packager/media/base/media_base.gyp +++ b/packager/media/base/media_base.gyp @ @ -10,7 +10,7 @ @ ] , 'targets ' : [ { - 'target_name ' : 'base ' , + 'target_name ' : 'media_base ' , 'type ' : ' < ( component ) ' , 'sources
diff -- git a/DEPS b/DEPS index 1169781..e803f40 100644 -- - a/DEPS +++ b/DEPS @ @ -57,6 +57,9 @ @ deps = { `` src/packager/third_party/tcmalloc/chromium '' : Var ( `` chromium_git '' ) + `` /chromium/src/third_party/tcmalloc/chromium @ fa1492f75861094061043a17c0f779c3d35780bf '' , + `` src/packager/third_party/zlib '' : + Var ( `` chromium_git '' ) + `` /chromium/src/third_party/zlib @ bcf81d2e5f3a62b698d179c1fadba94604c5dad3 '' , + `` src/packager/tools/clang '' : Var ( `` chromium_git '' ) + `` /chromium/src/tools/clang @ 0de8f3bb6af64e13876273c601704795d5e00faf '' , @ @ -69,10 +72,6 @ @ deps = { deps_os = { `` unix '' : { # Linux , actually . - # Required by build/linux/system.gyp . - `` src/packager/third_party/zlib '' : - Var ( `` chromium_git '' ) + `` /chromium/src/third_party/zlib @ bcf81d2e5f3a62b698d179c1fadba94604c5dad3 '' , - # Linux gold build to build faster . `` src/packager/third_party/gold '' : Var ( `` chromium_git '' ) + `` /chromium/deps/gold @ 29ae7431b4688df544ea840b0b66784e5dd298fe '' , diff -- git a/packager/media/base/media_base.gyp b/packager/media/base/media_base.gyp index 20a58a6..0183d75 100644 -- - a/packager/media/base/media_base.gyp +++ b/packager/media/base/media_base.gyp @ @ -10,7 +10,7 @ @ ] , 'targets ' : [ { - 'target_name ' : 'base ' , + 'target_name ' : 'media_base ' , 'type ' : ' < ( component ) ' , 'sources
diff -- git a/AUTHORS b/AUTHORS index cc37e22..b8945ee 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -17,6 +17,7 @ @ Anders Hasselqvist < anders.hasselqvist @ gmail.com > Chun-da Chen < capitalm.c @ gmail.com > Google Inc. < * @ google.com > Leandro Moreira < leandro.ribeiro.moreira @ gmail.com > +More Screens Ltd. < * @ morescreens.net > Philo Inc. < * @ philo.com > Richard Eklycke < richard @ eklycke.se > Sergio Ammirata < sergio @ ammirata.net > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index aa494ee..71fadc8 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -25,6 +25,7 @ @ Anders Hasselqvist < anders.hasselqvist @ gmail.com > Bei Li < beil @ google.com > Chun-da Chen < capitalm.c @ gmail.com > +David Cavar < pal3thorn @ gmail.com > Gabe Kopley < gabe @ philo.com > Haoming Chen < hmchen @ google.com > Jacob Trimble < modmaker @ google.com > diff -- git a/packager/file/file.cc b/packager/file/file.cc index 35273a4..a0f5aa6 100644 -- - a/packager/file/file.cc +++ b/packager/file/file.cc @ @ -9,9 +9,10 @ @ # include < gflags/gflags.h > # include < algorithm > # include < memory > - # include `` packager/base/files/important_file_writer.h '' + # include `` packager/base/files/file_util.h '' # include `` packager/base/logging.h '' # include `` packager/base/strings/string_piece.h ''
diff -- git a/README.md b/README.md index a6e3855..54dc85d 100644 -- - a/README.md +++ b/README.md @ @ -93,6 +93,22 @ @ new Formatter ( ) .formatSource ( source , output ) ; Your starting point should be the instance methods of ` com.google.googlejavaformat.java.Formatter ` . + # # # # Gradle via Spotless + + [ Spotless ] ( https : //github.com/diffplug/spotless/tree/master/plugin-gradle # applying-to-java-source-google-java-format ) can apply ` google-java-format ` automatically to all java sources in a project , as well as apply other kinds of formatter to other kinds of files . + + `` ` gradle +plugins { + id 'com.diffplug.gradle.spotless ' version '3.1.0' + } + +spotless { + java { + googleJavaFormat ( ) + } + } + `` ` + # # Building from source mvn install
diff -- git a/core/src/main/java/com/google/googlejavaformat/java/CommandLineOptions.java b/core/src/main/java/com/google/googlejavaformat/java/CommandLineOptions.java index 47a6cfd..7d724ef 100644 -- - a/core/src/main/java/com/google/googlejavaformat/java/CommandLineOptions.java +++ b/core/src/main/java/com/google/googlejavaformat/java/CommandLineOptions.java @ @ -38,6 +38,7 @ @ final class CommandLineOptions { private final boolean removeJavadocOnlyImports ; private final boolean sortImports ; private final boolean removeUnusedImports ; + private final boolean skipJavaDocFormatting ; CommandLineOptions ( ImmutableList < String > files , @ @ -52,7 +53,8 @ @ final class CommandLineOptions { boolean fixImportsOnly , boolean removeJavadocOnlyImports , boolean sortImports , - boolean removeUnusedImports ) { + boolean removeUnusedImports , + boolean skipJavaDocFormatting ) { this.files = files ; this.inPlace = inPlace ; this.lines = lines ; @ @ -66,6 +68,7 @ @ final class CommandLineOptions { this.removeJavadocOnlyImports = removeJavadocOnlyImports ; this.sortImports = sortImports ; this.removeUnusedImports = removeUnusedImports ; + this.skipJavaDocFormatting = skipJavaDocFormatting ; } /** The files to format . */ @ @ -136,6 +139,10 @ @ final class CommandLineOptions { return removeUnusedImports ; } + boolean skipJavaDocFormatting ( ) { + return skipJavaDocFormatting ; + } + /** Returns true if partial formatting was selected . */ boolean isSelection ( ) { return ! lines ( ) .isEmpty ( ) || ! offsets ( ) .isEmpty ( ) || ! lengths ( ) .isEmpty ( ) ; @
diff -- git a/core/src/main/java/com/google/googlejavaformat/java/GoogleJavaFormatVersion.java b/core/src/main/java/com/google/googlejavaformat/java/GoogleJavaFormatVersion.java index e858d9e..f8b2226 100644 -- - a/core/src/main/java/com/google/googlejavaformat/java/GoogleJavaFormatVersion.java +++ b/core/src/main/java/com/google/googlejavaformat/java/GoogleJavaFormatVersion.java @ @ -15,5 +15,5 @ @ package com.google.googlejavaformat.java ; public class GoogleJavaFormatVersion { - public static final String VERSION = `` 1.0 '' ; + public static final String VERSION = `` 1.5-SNAPSHOT '' ; }
diff -- git a/lib/file.dart b/lib/file.dart index 04cb973..cdde9fe 100644 -- - a/lib/file.dart +++ b/lib/file.dart @ @ -4,4 +4,5 @ @ /// Core interfaces containing the abstract ` FileSystem ` interface definition /// and all associated types used by ` FileSystem ` . +export 'src/forwarding.dart ' ; export 'src/interface.dart ' ; diff -- git a/lib/src/forwarding.dart b/lib/src/forwarding.dart index fb349f8..a0f46d6 100644 -- - a/lib/src/forwarding.dart +++ b/lib/src/forwarding.dart @ @ -13,5 +13,6 @ @ import 'package : meta/meta.dart ' ; part 'forwarding/forwarding_directory.dart ' ; part 'forwarding/forwarding_file.dart ' ; +part 'forwarding/forwarding_file_system.dart ' ; part 'forwarding/forwarding_file_system_entity.dart ' ; part 'forwarding/forwarding_link.dart ' ; diff -- git a/lib/src/forwarding/forwarding_directory.dart b/lib/src/forwarding/forwarding_directory.dart index 40fa714..3c75a02 100644 -- - a/lib/src/forwarding/forwarding_directory.dart +++ b/lib/src/forwarding/forwarding_directory.dart @ @ -4,6 +4,7 @ @ part of file.src.forwarding ; +/// A directory that forwards all methods and properties to a delegate . abstract class ForwardingDirectory extends ForwardingFileSystemEntity < Directory , io.Directory > implements Directory { diff -- git a/lib/src/forwarding/forwarding_file.dart b/lib/src/forwarding/forwarding_file.dart index 9434283..500642d 100644 -- - a/lib/src/forwarding/forwarding_file.dart +++ b/lib/src/forwarding/forwarding_file.dart @ @ -4,6 +4,7 @ @ part of file.src.forwarding ; +/// A file that forwards all methods and properties to a delegate . abstract class ForwardingFile extends ForwardingFileSystemEntity < File , io.File > implements File { @ override diff -- git a/lib/src/forwarding/forwarding_file_system.dart b/lib/src/forwarding/forwarding_file_system.dart new
diff -- git a/.analysis_options b/.analysis_options index 7cbae87..b941521 100644 -- - a/.analysis_options +++ b/.analysis_options @ @ -1,30 +1,68 @ @ analyzer : strong-mode : true language : - enableSuperMixins : true + enableStrictCallChecks : true + enableSuperMixins : true + errors : + # Allow having TODOs in the code + todo : ignore + linter : rules : - # Errors + # these rules are documented on and in the same order as + # the Dart Lint rules page to make maintenance easier + # http : //dart-lang.github.io/linter/lints/ + + # === error rules === - avoid_empty_else + # TODO - comment_references + - cancel_subscriptions + # TODO - close_sinks - control_flow_in_finally - empty_statements + - hash_and_equals + - invariant_booleans + - iterable_contains_unrelated_type + - list_remove_unrelated_type + - literal_only_boolean_expressions - test_types_in_equals - throw_in_finally + - unrelated_type_equality_checks - valid_regexps - # Style - # TODO : - annotate_overrides + # === style rules === + - always_declare_return_types + # TODO - always_specify_types + # TODO - annotate_overrides + # TODO - avoid_as - avoid_init_to_null - avoid_return_types_on_setters - await_only_futures - - camel_case_types - # TODO : - comment_references + # TODO - camel_case_types + # TODO - constant_identifier_names + -
diff -- git a/.analysis_options b/.analysis_options index 7cbae87..b941521 100644 -- - a/.analysis_options +++ b/.analysis_options @ @ -1,30 +1,68 @ @ analyzer : strong-mode : true language : - enableSuperMixins : true + enableStrictCallChecks : true + enableSuperMixins : true + errors : + # Allow having TODOs in the code + todo : ignore + linter : rules : - # Errors + # these rules are documented on and in the same order as + # the Dart Lint rules page to make maintenance easier + # http : //dart-lang.github.io/linter/lints/ + + # === error rules === - avoid_empty_else + # TODO - comment_references + - cancel_subscriptions + # TODO - close_sinks - control_flow_in_finally - empty_statements + - hash_and_equals + - invariant_booleans + - iterable_contains_unrelated_type + - list_remove_unrelated_type + - literal_only_boolean_expressions - test_types_in_equals - throw_in_finally + - unrelated_type_equality_checks - valid_regexps - # Style - # TODO : - annotate_overrides + # === style rules === + - always_declare_return_types + # TODO - always_specify_types + # TODO - annotate_overrides + # TODO - avoid_as - avoid_init_to_null - avoid_return_types_on_setters - await_only_futures - - camel_case_types - # TODO : - comment_references + # TODO - camel_case_types + # TODO - constant_identifier_names + -
diff -- git a/lib/src/backends/record_replay/common.dart b/lib/src/backends/record_replay/common.dart index afd95e0..cade562 100644 -- - a/lib/src/backends/record_replay/common.dart +++ b/lib/src/backends/record_replay/common.dart @ @ -51,6 +51,10 @ @ const String kManifestPositionalArgumentsKey = 'positionalArguments ' ; /// named arguments that were passed to the method . const String kManifestNamedArgumentsKey = 'namedArguments ' ; +/// The key in a serialized [ InvocationEvent ] map that is used to store whether +/// the invocation has been replayed already . +const String kManifestReplayedKey = 'replayed ' ; + /// The serialized [ kManifestTypeKey ] for property retrievals . const String kGetType = 'get ' ; @ @ -83,3 +87,40 @ @ class TypeMatcher < T > { /// Returns ` true ` if the given object is of type ` T ` . bool matches ( dynamic object ) = > object is T ; } + +/// Tells whether two objects are equal using deep equality checking . +/// +/// Two lists are deeply equal if they have the same type , the same length , and +/// every element in list A is pairwise deeply equal with the corresponding +/// element in list B . +/// +/// Two maps are deeply equal if they have the same type , the same
diff -- git a/appveyor.yml b/appveyor.yml index 09a4a70..1e45697 100644 -- - a/appveyor.yml +++ b/appveyor.yml @ @ -10,5 +10,9 @ @ install : build : off test_script : - # TODO ( tvolkert ) : Broaden scope of tests + # TODO ( tvolkert ) : Enable testing of LocalFileSystem + - pub run test test\chroot_test.dart - pub run test test\memory_test.dart + - pub run test test\recording_test.dart + - pub run test test\replay_test.dart + - pub run test test\utils_test.dart diff -- git a/test/chroot_test.dart b/test/chroot_test.dart index b911e19..91d1d58 100644 -- - a/test/chroot_test.dart +++ b/test/chroot_test.dart @ @ -31,58 +31,61 @ @ void main ( ) { ) ; } ) ; - group ( 'localBacked ' , ( ) { - ChrootFileSystem fs ; - io.Directory tmp ; - - setUp ( ( ) { - tmp = io.Directory.systemTemp.createTempSync ( 'file_test_ ' ) ; - tmp = new io.Directory ( tmp.resolveSymbolicLinksSync ( ) ) ; - fs = new ChrootFileSystem ( new LocalFileSystem ( ) , tmp.path ) ; - } ) ; + // LocalFileSystem is broken on Windows + if ( ! io.Platform.isWindows ) { + group ( 'localBacked ' , ( ) { + ChrootFileSystem fs ; + io.Directory tmp ; +
diff -- git a/endpoint.go b/endpoint.go index f7e074f..5c7c6c6 100644 -- - a/endpoint.go +++ b/endpoint.go @ @ -89,17 +89,23 @ @ func ( e *endpoint ) transfer ( buf [ ] byte ) ( int , error ) { return 0 , nil } - t , err : = newUSBTransfer ( e.h , & e.Desc , buf , e.Timeout ) + t , err : = newUSBTransfer ( e.h , & e.Desc , len ( buf ) , e.Timeout ) if err ! = nil { return 0 , err } defer t.free ( ) + if e.Desc.Direction == EndpointDirectionOut { + copy ( t.data ( ) , buf ) + } if err : = t.submit ( ) ; err ! = nil { return 0 , err } n , err : = t.wait ( ) + if e.Desc.Direction == EndpointDirectionIn { + copy ( buf , t.data ( ) ) + } if err ! = nil { return n , err } diff -- git a/endpoint_stream.go b/endpoint_stream.go index 052107b..4f6949c 100644 -- - a/endpoint_stream.go +++ b/endpoint_stream.go @ @ -17,7 +17,7 @ @ package gousb func ( e *endpoint ) newStream ( size , count int , submit bool
diff -- git a/endpoint_stream.go b/endpoint_stream.go index b9a2717..a4d684d 100644 -- - a/endpoint_stream.go +++ b/endpoint_stream.go @ @ -40,5 +40,5 @ @ func ( e *InEndpoint ) NewStream ( size , count int ) ( *ReadStream , error ) { if err ! = nil { return nil , err } - return & ReadStream { s } , nil + return & ReadStream { s : s } , nil } diff -- git a/transfer_stream.go b/transfer_stream.go index 6e294fb..3b9f9a6 100644 -- - a/transfer_stream.go +++ b/transfer_stream.go @ @ -27,22 +27,46 @ @ type transferIntf interface { type stream struct { // a fifo of USB transfers . transfers chan transferIntf - // current holds the last transfer to return . - current transferIntf - // total/used are the number of all/used bytes in the current transfer . - total , used int - // delayedErr is the delayed error , returned to the user after all - // remaining data was read . - delayedErr error + // err is the first encountered error , returned to the user . + err error } -func ( s *stream ) setDelayedErr ( err error ) { - if s.delayedErr == nil { - s.delayedErr =
diff -- git a/endpoint.go b/endpoint.go index 07903ed..d105025 100644 -- - a/endpoint.go +++ b/endpoint.go @ @ -16,6 +16,7 @ @ package gousb import ( + '' context '' '' fmt '' '' strings '' '' time '' @ @ -76,8 +77,6 @ @ type endpoint struct { InterfaceSetting Desc EndpointDesc - Timeout time.Duration - ctx *Context } @ @ -86,12 +85,12 @ @ func ( e *endpoint ) String ( ) string { return e.Desc.String ( ) } -func ( e *endpoint ) transfer ( buf [ ] byte ) ( int , error ) { +func ( e *endpoint ) transfer ( ctx context.Context , buf [ ] byte ) ( int , error ) { if len ( buf ) == 0 { return 0 , nil } - t , err : = newUSBTransfer ( e.ctx , e.h , & e.Desc , len ( buf ) , e.Timeout ) + t , err : = newUSBTransfer ( e.ctx , e.h , & e.Desc , len ( buf ) ) if err ! = nil { return 0 , err } @ @ -104,7 +103,7 @ @ func ( e *endpoint ) transfer ( buf [ ] byte )
diff -- git a/eval.go b/eval.go index ef03553..3c87862 100644 -- - a/eval.go +++ b/eval.go @ @ -9,6 +9,7 @ @ import ( '' fmt '' '' log '' '' math '' + '' math/big '' '' sort '' '' strings '' '' unicode '' @ @ -723,7 +724,12 @ @ func eval ( fr *Frame , e syntax.Expr ) ( Value , error ) { case *syntax.Literal : switch e.Token { case syntax.INT : - return MakeInt64 ( e.Value . ( int64 ) ) , nil + switch e.Value . ( type ) { + case int64 : + return MakeInt64 ( e.Value . ( int64 ) ) , nil + case *big.Int : + return Int { e.Value . ( *big.Int ) } , nil + } case syntax.FLOAT : return Float ( e.Value . ( float64 ) ) , nil case syntax.STRING : diff -- git a/repl/repl.go b/repl/repl.go index 4334540..567773a 100644 -- - a/repl/repl.go +++ b/repl/repl.go @ @ -14,12 +14,6 @ @ package repl // TODO ( adonovan ) : // -// - Distinguish expressions from statements more precisely . -// Otherwise e.g . 1 is parsed as an expression but -// 1000000000000000000000000000 is parsed as a file -//
diff -- git a/doc/spec.md b/doc/spec.md index 8454baa..34c3232 100644 -- - a/doc/spec.md +++ b/doc/spec.md @ @ -1330,7 +1330,8 @ @ dynamic error . The hash of a value is an unspecified integer chosen so that two equal values have the same hash , in other words , ` x == y = > hash ( x ) == hash ( y ) ` . -A hashable value has the same hash throughout its lifetime . +A hashable value has the same hash throughout its lifetime , +though the hash may vary from one execution of a program to the next . Values of the types ` NoneType ` , ` bool ` , ` int ` , ` float ` , and ` string ` , which are all immutable , are hashable . @ @ -2886,6 +2887,8 @ @ getattr ( `` banana '' , `` split '' ) ( `` a '' ) # [ `` b '' , `` n '' , `` n '' , `` '' ] , equivalent to `` ban ` hash ` fails if x , or any value upon which its hash depends , is unhashable . +The hash function may vary
diff -- git a/eval_test.go b/eval_test.go index b7a8e6f..5605d07 100644 -- - a/eval_test.go +++ b/eval_test.go @ @ -470,3 +470,23 @ @ func TestRepeatedExec ( t *testing.T ) { thread.Pop ( ) } } + +// TestUnpackUserDefined tests that user-defined +// implementations of skylark.Value may be unpacked . +func TestUnpackUserDefined ( t *testing.T ) { + // success + want : = new ( hasfields ) + var x *hasfields + if err : = skylark.UnpackArgs ( `` unpack '' , skylark.Tuple { want } , nil , `` x '' , & x ) ; err ! = nil { + t.Errorf ( `` UnpackArgs failed : % v '' , err ) + } + if x ! = want { + t.Errorf ( `` for x , got % v , want % v '' , x , want ) + } + + // failure + err : = skylark.UnpackArgs ( `` unpack '' , skylark.Tuple { skylark.MakeInt ( 42 ) } , nil , `` x '' , & x ) + if want : = `` unpack : for parameter 1 : got int , want hasfields '' ; fmt.Sprint ( err ) ! = want {
diff -- git a/fire/core.py b/fire/core.py index 3a0712e..37af349 100644 -- - a/fire/core.py +++ b/fire/core.py @ @ -352,7 +352,7 @ @ def _Fire ( component , args , context , name=None ) : try : target = component.__name__ - filename , lineno = _GetFileAndLine ( component ) + filename , lineno = inspectutils.GetFileAndLine ( component ) component , consumed_args , remaining_args , capacity = _CallCallable ( component , remaining_args ) @ @ -428,7 +428,7 @ @ def _Fire ( component , args , context , name=None ) : component , consumed_args , remaining_args = _GetMember ( component , remaining_args ) - filename , lineno = _GetFileAndLine ( component ) + filename , lineno = inspectutils.GetFileAndLine ( component ) component_trace.AddAccessedProperty ( component , target , consumed_args , filename , lineno ) @ @ -486,33 +486,6 @ @ def _Fire ( component , args , context , name=None ) : return component_trace -def _GetFileAndLine ( component ) : - `` '' '' Returns the filename and line number of component . - - Args : - component : A component to find the source information for , usually a class - or routine . - Returns : - filename : The name of the
diff -- git a/doc/guide.md b/doc/guide.md index 84cf4ad..78c9634 100644 -- - a/doc/guide.md +++ b/doc/guide.md @ @ -699,12 +699,12 @ @ The complete set of flags available is shown below , in the reference section . | Using a CLI | Command | Notes | : -- -- -- -- -- -- - | : -- -- -- -- -- -- -- -- -- -- -- -- - | : -- -- -- -- - -| [ Help ] ( doc/using-cli.md # help-flag ) | ` command -- -- help ` |Show help and usage information for the command . -| [ REPL ] ( doc/using-cli.md # interactive-flag ) | ` command -- -- interactive ` | Enter interactive mode . -| [ Separator ] ( doc/using-cli.md # separator-flag ) | ` command -- -- separator=X ` | This sets the separator to ` X ` . The default separator is ` - ` . -| [ Completion ] ( doc/using-cli.md # completion-flag ) | ` command -- -- completion ` | Generate a completion script for the CLI . -| [ Trace ] ( doc/using-cli.md # trace-flag ) | ` command -- -- trace ` | Gets a Fire trace for
diff -- git a/src/backend/Framebuffer.cpp b/src/backend/Framebuffer.cpp index 5f9cff8..ba83290 100644 -- - a/src/backend/Framebuffer.cpp +++ b/src/backend/Framebuffer.cpp @ @ -103,19 +103,10 @ @ namespace backend { return nullptr ; } - // TODO ( kainino @ chromium.org ) : Remove this flag when the - // null=backbuffer hack is removed . Then , using null texture views can - // be completely disallowed . - bool usingBackbufferHack = false ; for ( auto & textureView : textureViews ) { if ( ! textureView ) { - if ( usingBackbufferHack ) { - // TODO ( kainino @ chromium.org ) update this too - HandleError ( `` Framebuffer has more than one null attachment '' ) ; - return nullptr ; - } - usingBackbufferHack = true ; - continue ; + HandleError ( `` Framebuffer attachment not set '' ) ; + return nullptr ; } // TODO ( cwallez @ chromium.org ) : Adjust for the mip-level once that is supported . diff -- git a/src/backend/RenderPass.cpp b/src/backend/RenderPass.cpp index b2e04a3..3746b25 100644 -- - a/src/backend/RenderPass.cpp +++ b/src/backend/RenderPass.cpp @ @ -94,6 +94,23 @ @ namespace backend { } } + for ( const auto & subpass : subpasses ) { + for ( unsigned int location
diff -- git a/src/backend/Framebuffer.cpp b/src/backend/Framebuffer.cpp index 5f9cff8..ba83290 100644 -- - a/src/backend/Framebuffer.cpp +++ b/src/backend/Framebuffer.cpp @ @ -103,19 +103,10 @ @ namespace backend { return nullptr ; } - // TODO ( kainino @ chromium.org ) : Remove this flag when the - // null=backbuffer hack is removed . Then , using null texture views can - // be completely disallowed . - bool usingBackbufferHack = false ; for ( auto & textureView : textureViews ) { if ( ! textureView ) { - if ( usingBackbufferHack ) { - // TODO ( kainino @ chromium.org ) update this too - HandleError ( `` Framebuffer has more than one null attachment '' ) ; - return nullptr ; - } - usingBackbufferHack = true ; - continue ; + HandleError ( `` Framebuffer attachment not set '' ) ; + return nullptr ; } // TODO ( cwallez @ chromium.org ) : Adjust for the mip-level once that is supported . diff -- git a/src/backend/RenderPass.cpp b/src/backend/RenderPass.cpp index b2e04a3..3746b25 100644 -- - a/src/backend/RenderPass.cpp +++ b/src/backend/RenderPass.cpp @ @ -94,6 +94,23 @ @ namespace backend { } } + for ( const auto & subpass : subpasses ) { + for ( unsigned int location
diff -- git a/examples/CMakeLists.txt b/examples/CMakeLists.txt index ccb8fa4..c5e8775 100644 -- - a/examples/CMakeLists.txt +++ b/examples/CMakeLists.txt @ @ -72,4 +72,8 @ @ add_executable ( SpirvTest SpirvTest.cpp ) target_link_libraries ( SpirvTest shaderc spirv-cross nxtcpp ) SetCXX14 ( SpirvTest ) +add_executable ( CppHelloDepthStencil HelloDepthStencil.cpp ) +target_link_libraries ( CppHelloDepthStencil utils ) +SetCXX14 ( CppHelloDepthStencil ) + add_subdirectory ( glTFViewer ) diff -- git a/examples/HelloDepthStencil.cpp b/examples/HelloDepthStencil.cpp new file mode 100644 index 0000000..49fdf62 -- - /dev/null +++ b/examples/HelloDepthStencil.cpp @ @ -0,0 +1,352 @ @ +// Copyright 2017 The NXT Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + + # include `` Utils.h '' + + # include <
diff -- git a/src/backend/DepthStencilState.cpp b/src/backend/DepthStencilState.cpp index 130d4eb..79b6fee 100644 -- - a/src/backend/DepthStencilState.cpp +++ b/src/backend/DepthStencilState.cpp @ @ -24,10 +24,6 @ @ namespace backend { : depthInfo ( builder- > depthInfo ) , stencilInfo ( builder- > stencilInfo ) { } - bool DepthStencilStateBase : :DepthTestEnabled ( ) const { - return depthInfo.compareFunction ! = nxt : :CompareFunction : :Always ; - } - bool DepthStencilStateBase : :StencilTestEnabled ( ) const { return stencilInfo.back.compareFunction ! = nxt : :CompareFunction : :Always || stencilInfo.back.stencilFail ! = nxt : :StencilOperation : :Keep || diff -- git a/src/backend/DepthStencilState.h b/src/backend/DepthStencilState.h index 9013472..96f988f 100644 -- - a/src/backend/DepthStencilState.h +++ b/src/backend/DepthStencilState.h @ @ -47,7 +47,6 @ @ namespace backend { uint32_t writeMask = 0xff ; } ; - bool DepthTestEnabled ( ) const ; bool StencilTestEnabled ( ) const ; const DepthInfo & GetDepth ( ) const ; const StencilInfo & GetStencil ( ) const ; diff -- git a/src/backend/metal/DepthStencilStateMTL.mm b/src/backend/metal/DepthStencilStateMTL.mm index b41bbe5..7f35bd7 100644 -- - a/src/backend/metal/DepthStencilStateMTL.mm +++ b/src/backend/metal/DepthStencilStateMTL.mm @ @ -67,14 +67,11 @ @ namespace metal { : DepthStencilStateBase ( builder ) { MTLDepthStencilDescriptor* mtlDepthStencilDescriptor = [ MTLDepthStencilDescriptor new ] ; - if ( DepthTestEnabled ( ) ) { - auto & depth = GetDepth ( ) ; -
diff -- git a/examples/HelloDepthStencil.cpp b/examples/HelloDepthStencil.cpp index 6fc0630..df8682b 100644 -- - a/examples/HelloDepthStencil.cpp +++ b/examples/HelloDepthStencil.cpp @ @ -283,6 +283,7 @ @ void frame ( ) { .SetStencilReference ( 0x1 ) .SetRenderPipeline ( planePipeline ) + .SetBindGroup ( 0 , bindGroup [ 0 ] ) .SetVertexBuffers ( 0 , 1 , & planeBuffer , vertexBufferOffsets ) .DrawElements ( 6 , 1 , 0 , 0 ) diff -- git a/src/backend/DepthStencilState.cpp b/src/backend/DepthStencilState.cpp index 130d4eb..79b6fee 100644 -- - a/src/backend/DepthStencilState.cpp +++ b/src/backend/DepthStencilState.cpp @ @ -24,10 +24,6 @ @ namespace backend { : depthInfo ( builder- > depthInfo ) , stencilInfo ( builder- > stencilInfo ) { } - bool DepthStencilStateBase : :DepthTestEnabled ( ) const { - return depthInfo.compareFunction ! = nxt : :CompareFunction : :Always ; - } - bool DepthStencilStateBase : :StencilTestEnabled ( ) const { return stencilInfo.back.compareFunction ! = nxt : :CompareFunction : :Always || stencilInfo.back.stencilFail ! = nxt : :StencilOperation : :Keep || diff -- git a/src/backend/DepthStencilState.h b/src/backend/DepthStencilState.h index 9013472..96f988f 100644 -- - a/src/backend/DepthStencilState.h +++ b/src/backend/DepthStencilState.h @ @ -47,7 +47,6 @ @ namespace backend { uint32_t writeMask = 0xff ; } ; - bool DepthTestEnabled ( ) const ; bool StencilTestEnabled ( ) const ; const DepthInfo & GetDepth ( ) const
diff -- git a/README.md b/README.md index 8561bf4..7efab89 100644 -- - a/README.md +++ b/README.md @ @ -222,7 +222,7 @ @ Writes a JSON API response , with related records sideloaded , into an only . If you want to serialize many records , see , [ MarshalManyPayload ] ( # marshalmanypayload ) . - # # # # Handler Example Code + # # # # # Handler Example Code `` ` go func CreateBlog ( w http.ResponseWriter , r *http.Request ) { @ @ -270,7 +270,6 @ @ blogInterface : = make ( [ ] interface { } , len ( blogs ) ) for i , blog : = range blogs { blogInterface [ i ] = blog } - `` ` Alternatively , you can insert your ` Blog ` s into a slice of ` interface { } ` @ @ -283,7 +282,7 @ @ this , func FetchBlogs ( ) ( [ ] interface { } , error ) `` ` - # # # # Handler Example Code + # # # # # Handler Example Code `` ` go func ListBlogs ( w http.ResponseWriter , r *http.Request ) { @ @ -300,6 +299,44 @
diff -- git a/autoload/maktaba/log.vim b/autoload/maktaba/log.vim index 3d4aae1..bab0c82 100644 -- - a/autoload/maktaba/log.vim +++ b/autoload/maktaba/log.vim @ @ -41,6 +41,19 @ @ endfunction `` '' + '' Call { Handler } with { logitem } , trying both 1-arg and legacy 4-arg + '' signatures . +function ! s : CallHandler ( Handler , logitem ) abort + try + call maktaba # function # Call ( a : Handler , [ a : logitem ] ) + catch /E119 : / + `` Not enough arguments . Fall back to legacy 4-arg handler signature . + call maktaba # function # Call ( a : Handler , a : logitem ) + endtry +endfunction + + + '' '' `` Append { logitem } to s : log_queue and pass to handlers . function ! s : SendToHandlers ( logitem ) abort let l : maktaba = maktaba # Maktaba ( ) @ @ -65,12 +78,29 @ @ function ! s : SendToHandlers ( logitem ) abort `` Send to handlers . for l : Handler in l : maktaba.globals.loghandlers.Items ( ) - call maktaba # function # Call ( l : Handler , a : logitem ) + call s :
diff -- git a/autoload/maktaba/log.vim b/autoload/maktaba/log.vim index 3d4aae1..bab0c82 100644 -- - a/autoload/maktaba/log.vim +++ b/autoload/maktaba/log.vim @ @ -41,6 +41,19 @ @ endfunction `` '' + '' Call { Handler } with { logitem } , trying both 1-arg and legacy 4-arg + '' signatures . +function ! s : CallHandler ( Handler , logitem ) abort + try + call maktaba # function # Call ( a : Handler , [ a : logitem ] ) + catch /E119 : / + `` Not enough arguments . Fall back to legacy 4-arg handler signature . + call maktaba # function # Call ( a : Handler , a : logitem ) + endtry +endfunction + + + '' '' `` Append { logitem } to s : log_queue and pass to handlers . function ! s : SendToHandlers ( logitem ) abort let l : maktaba = maktaba # Maktaba ( ) @ @ -65,12 +78,29 @ @ function ! s : SendToHandlers ( logitem ) abort `` Send to handlers . for l : Handler in l : maktaba.globals.loghandlers.Items ( ) - call maktaba # function # Call ( l : Handler , a : logitem ) + call s :
diff -- git a/autoload/maktaba/log.vim b/autoload/maktaba/log.vim index 3d4aae1..bab0c82 100644 -- - a/autoload/maktaba/log.vim +++ b/autoload/maktaba/log.vim @ @ -41,6 +41,19 @ @ endfunction `` '' + '' Call { Handler } with { logitem } , trying both 1-arg and legacy 4-arg + '' signatures . +function ! s : CallHandler ( Handler , logitem ) abort + try + call maktaba # function # Call ( a : Handler , [ a : logitem ] ) + catch /E119 : / + `` Not enough arguments . Fall back to legacy 4-arg handler signature . + call maktaba # function # Call ( a : Handler , a : logitem ) + endtry +endfunction + + + '' '' `` Append { logitem } to s : log_queue and pass to handlers . function ! s : SendToHandlers ( logitem ) abort let l : maktaba = maktaba # Maktaba ( ) @ @ -65,12 +78,29 @ @ function ! s : SendToHandlers ( logitem ) abort `` Send to handlers . for l : Handler in l : maktaba.globals.loghandlers.Items ( ) - call maktaba # function # Call ( l : Handler , a : logitem ) + call s :
diff -- git a/docs/openbsd/setup.md b/docs/openbsd/setup.md index 0885022..8abdbaa 100644 -- - a/docs/openbsd/setup.md +++ b/docs/openbsd/setup.md @ @ -22,6 +22,12 @ @ Variables used throughout the instructions : # pkg_add bash git gmake go `` ` + In order for reproducers to work , GCC from ports is also required : + + `` ` sh + # pkg_add gcc + `` ` + 2 . Clone repository : `` ` sh diff -- git a/pkg/csource/common.go b/pkg/csource/common.go index 80ce02e..9de3879 100644 -- - a/pkg/csource/common.go +++ b/pkg/csource/common.go @ @ -27,7 +27,8 @ @ const ( func createCommonHeader ( p , mmapProg *prog.Prog , replacements map [ string ] string , opts Options ) ( [ ] byte , error ) { defines : = defineList ( p , mmapProg , opts ) - cmd : = osutil.Command ( `` cpp '' , `` -nostdinc '' , `` -undef '' , `` -fdirectives-only '' , `` -dDI '' , `` -E '' , `` -P '' , `` - '' ) + sysTarget : = targets.Get ( p.Target.OS , p.Target.Arch ) + cmd : = osutil.Command ( sysTarget.CPP , `` -nostdinc '' , `` -undef '' , `` -fdirectives-only '' , `` -dDI '' , ``
diff -- git a/executor/common_bsd.h b/executor/common_bsd.h index 0d95dc4..9c61917 100644 -- - a/executor/common_bsd.h +++ b/executor/common_bsd.h @ @ -8,6 +8,7 @ @ # include < stdarg.h > # include < stdbool.h > # include < string.h > + # include < sys/syscall.h > # if GOOS_openbsd diff -- git a/pkg/csource/generated.go b/pkg/csource/generated.go index c3e57da..a7bfe74 100644 -- - a/pkg/csource/generated.go +++ b/pkg/csource/generated.go @ @ -405,6 +405,7 @ @ void child ( ) # include < stdarg.h > # include < stdbool.h > # include < string.h > + # include < sys/syscall.h > # if GOOS_openbsd diff -- git a/sys/targets/targets.go b/sys/targets/targets.go index 88d2c72..386e6bc 100644 -- - a/sys/targets/targets.go +++ b/sys/targets/targets.go @ @ -176,6 +176,9 @ @ var List = map [ string ] map [ string ] *Target { PageSize : 4 < < 10 , CFlags : [ ] string { `` -m64 '' } , CrossCFlags : [ ] string { `` -m64 '' , `` -static '' } , + NeedSyscallDefine : func ( uint64 ) bool { + return false + } , } , } , '' netbsd '' : { @ @ -193,6 +196,9 @ @ var List = map [ string ] map [ string ] *Target { CFlags :
diff -- git a/core/src/main/java/com/google/common/truth/Subject.java b/core/src/main/java/com/google/common/truth/Subject.java index 7c718e7..953b150 100644 -- - a/core/src/main/java/com/google/common/truth/Subject.java +++ b/core/src/main/java/com/google/common/truth/Subject.java @ @ -23,6 +23,7 @ @ import com.google.common.base.Objects ; import com.google.common.base.Predicates ; import com.google.common.collect.Iterables ; import com.google.errorprone.annotations.CanIgnoreReturnValue ; +import java.util.Arrays ; import java.util.List ; import javax.annotation.Nullable ; @ @ -130,7 +131,7 @ @ public class Subject < S extends Subject < S , T > , T > { subject = rawSubject ; other = rawOther ; } - if ( Objects.equal ( subject , other ) ! = expectEqual ) { + if ( doCheckEquals ( subject , other ) ! = expectEqual ) { failComparingToStrings ( expectEqual ? `` is equal to '' : `` is not equal to '' , subject , other , rawOther , expectEqual ) ; } @ @ -153,6 +154,64 @ @ public class Subject < S extends Subject < S , T > , T > { throw new AssertionError ( o + `` must be either a Character or a Number . `` ) ; } } + + private static boolean doCheckEquals ( Object subject , Object other ) { + if ( subject instanceof boolean [ ] ) { + if ( other instanceof boolean [
diff -- git a/core/src/main/java/org/truth0/subjects/IntegerSubject.java b/core/src/main/java/org/truth0/subjects/IntegerSubject.java index 5464baa..6000f6f 100644 -- - a/core/src/main/java/org/truth0/subjects/IntegerSubject.java +++ b/core/src/main/java/org/truth0/subjects/IntegerSubject.java @ @ -119,6 +119,29 @ @ public class IntegerSubject extends Subject < IntegerSubject , Long > { super.is ( ( long ) other ) ; } + public void isGreaterThan ( long other ) { + if ( ! ( getSubject ( ) > other ) ) { + fail ( `` is greater than '' , other ) ; + } + } + + public void isGreaterThanOrEqual ( long other ) { + if ( ! ( getSubject ( ) > = other ) ) { + fail ( `` is greater than or equal to '' , other ) ; + } + } + + public void isLessThan ( long other ) { + if ( ! ( getSubject ( ) < other ) ) { + fail ( `` is less than '' , other ) ; + } + } + + public void isLessThanOrEqual ( long other ) { + if ( ! ( getSubject ( ) < = other ) ) { + fail ( `` is less than or equal to '' , other ) ; + }
diff -- git a/core/src/main/java/org/truth0/subjects/CollectionSubject.java b/core/src/main/java/org/truth0/subjects/CollectionSubject.java index e4fda7d..a954848 100644 -- - a/core/src/main/java/org/truth0/subjects/CollectionSubject.java +++ b/core/src/main/java/org/truth0/subjects/CollectionSubject.java @ @ -55,6 +55,12 @ @ public class CollectionSubject < S extends CollectionSubject < S , T , C > , T , C extend @ CheckReturnValue public Has < T , C > has ( ) { return new Has < T , C > ( ) { + @ Override public void size ( int size ) { + if ( getSubject ( ) .size ( ) ! = size ) { + fail ( `` has size '' , size ) ; + } + } + @ Override public void item ( T item ) { if ( ! getSubject ( ) .contains ( item ) ) { fail ( `` has item '' , item ) ; @ @ -177,6 +183,11 @ @ public class CollectionSubject < S extends CollectionSubject < S , T , C > , T , C extend public interface Has < E , C extends Collection < E > > { /** + * Attests that a Collection has the provided size + */ + void size ( int size ) ; + + /** * Attests
diff -- git a/core/src/main/java/org/truth0/subjects/CollectionSubject.java b/core/src/main/java/org/truth0/subjects/CollectionSubject.java index e4fda7d..a954848 100644 -- - a/core/src/main/java/org/truth0/subjects/CollectionSubject.java +++ b/core/src/main/java/org/truth0/subjects/CollectionSubject.java @ @ -55,6 +55,12 @ @ public class CollectionSubject < S extends CollectionSubject < S , T , C > , T , C extend @ CheckReturnValue public Has < T , C > has ( ) { return new Has < T , C > ( ) { + @ Override public void size ( int size ) { + if ( getSubject ( ) .size ( ) ! = size ) { + fail ( `` has size '' , size ) ; + } + } + @ Override public void item ( T item ) { if ( ! getSubject ( ) .contains ( item ) ) { fail ( `` has item '' , item ) ; @ @ -177,6 +183,11 @ @ public class CollectionSubject < S extends CollectionSubject < S , T , C > , T , C extend public interface Has < E , C extends Collection < E > > { /** + * Attests that a Collection has the provided size + */ + void size ( int size ) ; + + /** * Attests
diff -- git a/client/ctclient/ctclient.go b/client/ctclient/ctclient.go index 70f46e6..47d7765 100644 -- - a/client/ctclient/ctclient.go +++ b/client/ctclient/ctclient.go @ @ -212,8 +212,8 @ @ func getInclusionProofForHash ( ctx context.Context , logClient client.CheckLogClie hash : = sha256.Sum256 ( data ) return hash [ : ] } ) - if err : = verifier.VerifyInclusionProofByHash ( rsp.LeafIndex , int64 ( sth.TreeSize ) , rsp.AuditPath , sth.SHA256RootHash [ : ] , hash ) ; err ! = nil { - log.Fatalf ( `` Failed to VerifyInclusionProofByHash ( % d , % d ) = % v '' , rsp.LeafIndex , sth.TreeSize , err ) + if err : = verifier.VerifyInclusionProof ( rsp.LeafIndex , int64 ( sth.TreeSize ) , rsp.AuditPath , sth.SHA256RootHash [ : ] , hash ) ; err ! = nil { + log.Fatalf ( `` Failed to VerifyInclusionProof ( % d , % d ) = % v '' , rsp.LeafIndex , sth.TreeSize , err ) } fmt.Printf ( `` Verified that hash % x + proof = root hash % x\n '' , hash , sth.SHA256RootHash ) } diff -- git a/ctutil/loginfo.go b/ctutil/loginfo.go index 3aa1f0c..5b9ffdb 100644 -- - a/ctutil/loginfo.go +++ b/ctutil/loginfo.go @ @ -23,7 +23,7 @ @ import ( '' sync '' '' time '' -
diff -- git a/serialization.go b/serialization.go index b700204..47af087 100644 -- - a/serialization.go +++ b/serialization.go @ @ -161,23 +161,22 @ @ func MerkleTreeLeafFromChain ( chain [ ] *x509.Certificate , etype LogEntryType , time issuer : = chain [ 1 ] cert : = chain [ 0 ] - var newIssuer *x509.Certificate + var preIssuer *x509.Certificate if IsPreIssuer ( issuer ) { + // Replace the cert 's issuance information with details from the pre-issuer . + preIssuer = issuer + // The issuer of the pre-cert is not going to be the issuer of the final - // cert . Change to use the final issuer . + // cert . Change to use the final issuer 's key hash . if len ( chain ) < 3 { return nil , fmt.Errorf ( `` no issuer cert available for pre-issuer '' ) } issuer = chain [ 2 ] - - // Replace the cert 's Issuer field with the intermediate that will sign - // the final cert ; this changes the issuer and authority key ID . - newIssuer = issuer } // Next , post-process the DER-encoded TBSCertificate , to remove the CT poison // extension and possibly
diff -- git a/client/logclient.go b/client/logclient.go index 1ce74db..1723178 100644 -- - a/client/logclient.go +++ b/client/logclient.go @ @ -27,7 +27,6 @ @ import ( ct `` github.com/google/certificate-transparency-go '' '' github.com/google/certificate-transparency-go/jsonclient '' '' github.com/google/certificate-transparency-go/tls '' - '' github.com/google/certificate-transparency-go/x509 '' '' golang.org/x/net/context '' ) @ @ -171,49 +170,11 @ @ func ( c *LogClient ) VerifySCTSignature ( sct ct.SignedCertificateTimestamp , ctype // Ca n't verify signatures without a verifier return nil } - - // Build enough of a Merkle tree leaf for the verifier to work on . - leaf : = ct.MerkleTreeLeaf { - Version : sct.SCTVersion , - LeafType : ct.TimestampedEntryLeafType , - TimestampedEntry : & ct.TimestampedEntry { - Timestamp : sct.Timestamp , - EntryType : ctype , - Extensions : sct.Extensions , - } , - } - if ctype == ct.X509LogEntryType { - leaf.TimestampedEntry.X509Entry = & certData [ 0 ] - } else { - // Pre-certs are more complicated ; we need the issuer key hash and the - // DER-encoded TBSCertificate . First , parse the issuer to get its - // public key hash . - if len ( certData ) < 2 { - return fmt.Errorf ( `` no issuer cert available for precert SCT validation
diff -- git a/trillian/ctfe/ct_server/main.go b/trillian/ctfe/ct_server/main.go index bdee488..f0b7866 100644 -- - a/trillian/ctfe/ct_server/main.go +++ b/trillian/ctfe/ct_server/main.go @ @ -40,13 +40,15 @ @ import ( // Global flags that affect all log instances . var ( - httpEndpoint = flag.String ( `` http_endpoint '' , `` localhost:6962 '' , `` Endpoint for HTTP ( host : port ) '' ) - rpcBackendFlag = flag.String ( `` log_rpc_server '' , `` localhost:8090 '' , `` Backend specification ; comma-separated list or etcd service name ( if -- etcd_servers specified ) '' ) - rpcDeadlineFlag = flag.Duration ( `` rpc_deadline '' , time.Second*10 , `` Deadline for backend RPC requests '' ) - logConfigFlag = flag.String ( `` log_config '' , `` '' , `` File holding log config in JSON '' ) - maxGetEntriesFlag = flag.Int64 ( `` maxGetEntriesAllowed '' , 0 , `` Max number of entries we allow in a get-entries request ( default 50 ) '' ) - etcdServers = flag.String ( `` etcd_servers '' , `` '' , `` A comma-separated list of etcd servers '' ) - etcdHTTPService = flag.String ( `` etcd_http_service '' , `` trillian-ctfe-http '' , `` Service name to announce our HTTP endpoint under '' )
diff -- git a/android/guava-tests/test/com/google/common/util/concurrent/AbstractFutureCancellationCauseTest.java b/android/guava-tests/test/com/google/common/util/concurrent/AbstractFutureCancellationCauseTest.java index 380f69f..6c921b5 100644 -- - a/android/guava-tests/test/com/google/common/util/concurrent/AbstractFutureCancellationCauseTest.java +++ b/android/guava-tests/test/com/google/common/util/concurrent/AbstractFutureCancellationCauseTest.java @ @ -18,6 +18,7 @ @ package com.google.common.util.concurrent ; import static com.google.common.truth.Truth.assertThat ; +import java.lang.reflect.Method ; import java.net.URLClassLoader ; import java.util.HashMap ; import java.util.Map ; @ @ -34,6 +35,8 @ @ public class AbstractFutureCancellationCauseTest extends TestCase { private ClassLoader oldClassLoader ; private URLClassLoader classReloader ; + private Class < ? > settableFutureClass ; + private Class < ? > abstractFutureClass ; @ Override protected void setUp ( ) throws Exception { @ @ -68,6 +71,8 @ @ public class AbstractFutureCancellationCauseTest extends TestCase { } ; oldClassLoader = Thread.currentThread ( ) .getContextClassLoader ( ) ; Thread.currentThread ( ) .setContextClassLoader ( classReloader ) ; + abstractFutureClass = classReloader.loadClass ( AbstractFuture.class.getName ( ) ) ; + settableFutureClass = classReloader.loadClass ( SettableFuture.class.getName ( ) ) ; } @ Override @ @ -82,6 +87,7 @ @ public class AbstractFutureCancellationCauseTest extends TestCase { assertTrue ( future.cancel ( false ) ) ; assertTrue ( future.isCancelled ( ) ) ; assertTrue ( future.isDone ( ) ) ; + assertNull ( tryInternalFastPathGetFailure ( future ) ) ; try { future.get ( ) ; fail ( `` Expected CancellationException '' ) ; @ @ -95,6 +101,7 @
diff -- git a/guava-tests/test/com/google/common/eventbus/AsyncEventBusTest.java b/guava-tests/test/com/google/common/eventbus/AsyncEventBusTest.java index 208667d..08edc0e 100644 -- - a/guava-tests/test/com/google/common/eventbus/AsyncEventBusTest.java +++ b/guava-tests/test/com/google/common/eventbus/AsyncEventBusTest.java @ @ -17,10 +17,19 @ @ package com.google.common.eventbus ; import com.google.common.collect.Lists ; + +import java.util.Iterator ; import java.util.List ; import java.util.concurrent.Executor ; + +import com.google.common.util.concurrent.MoreExecutors ; import junit.framework.TestCase ; +import static org.mockito.ArgumentMatchers.any ; +import static org.mockito.ArgumentMatchers.eq ; +import static org.mockito.Mockito.mock ; +import static org.mockito.Mockito.verify ; + /** * Test case for { @ link AsyncEventBus } . * @ @ -34,6 +43,53 @ @ public class AsyncEventBusTest extends TestCase { private AsyncEventBus bus ; + public static class CreationTests extends TestCase { + private static final String TEST_BUS_IDENTIFIER = `` test-bus '' ; + + private FakeExecutor executor ; + private AsyncEventBus.Builder builder ; + + @ Override + protected void setUp ( ) throws Exception { + super.setUp ( ) ; + executor = new FakeExecutor ( ) ; + builder = new AsyncEventBus.Builder ( executor ) ; + } + + public void testBuilderEmpty ( ) { + final AsyncEventBus bus = builder.build ( ) ; + assertEquals ( `` default '' , bus.identifier ( ) ) ; + assertEquals ( executor , bus.executor ( ) ) ; + } + + public void testBuilderIdentifier
diff -- git a/ci/continuous_integration/daemon/main.py b/ci/continuous_integration/daemon/main.py index 0b8bcc9..486e2d9 100644 -- - a/ci/continuous_integration/daemon/main.py +++ b/ci/continuous_integration/daemon/main.py @ @ -214,6 +214,10 @ @ def clean ( ) : process.call ( 'git add -- all ' , cwd=CHROMIUM_SRC ) process.call ( 'git reset -- hard ' , cwd=CHROMIUM_SRC ) + # This fixes the problem in : + # https : //github.com/google/clusterfuzz-tools/issues/426 + process.call ( 'git checkout origin/master -f ' , cwd=CHROMIUM_SRC ) + # -- reset resets all uncommitted changes in the sub repo . process.call ( 'gclient sync -- reset ' , diff -- git a/ci/continuous_integration/tests/daemon/main_test.py b/ci/continuous_integration/tests/daemon/main_test.py index 93dd3a9..abd9262 100644 -- - a/ci/continuous_integration/tests/daemon/main_test.py +++ b/ci/continuous_integration/tests/daemon/main_test.py @ @ -399,6 +399,7 @ @ class CleanTest ( helpers.ExtendedTestCase ) : mock.call ( 'git reset -- hard ' , cwd=main.CHROMIUM_SRC ) , mock.call ( 'git add -- all ' , cwd=main.CHROMIUM_SRC ) , mock.call ( 'git reset -- hard ' , cwd=main.CHROMIUM_SRC ) , + mock.call ( 'git checkout origin/master -f ' , cwd=main.CHROMIUM_SRC ) , mock.call ( 'gclient sync -- reset ' , cwd=main.CHROMIUM_SRC , env= { 'PATH ' : 'some_path : % s ' % main.DEPOT_TOOLS } ) ,
diff -- git a/clusterfuzz/binary_providers.py b/clusterfuzz/binary_providers.py index 199e09b..a6d55a0 100644 -- - a/clusterfuzz/binary_providers.py +++ b/clusterfuzz/binary_providers.py @ @ -177,6 +177,33 @ @ class GenericBuilder ( BinaryProvider ) : ( command , self.source_directory ) ) common.execute ( command , self.source_directory ) + def deserialize_gn_args ( self , args ) : + `` '' '' Convert gn args into a dict . '' '' '' + + args_hash = { } + for line in args : + key , val = line.split ( ' = ' ) + args_hash [ key ] = val + return args_hash + + def serialize_gn_args ( self , args_hash ) : + args = [ ] + for key , val in args_hash.iteritems ( ) : + args.append ( ' % s = % s ' % ( key , val ) ) + return args + + def setup_gn_goma_params ( self , gn_args ) : + `` '' '' Ensures that goma_dir and gn_goma are used correctly . '' '' '' + + if not self.goma_dir or ( + 'use_goma ' in gn_args and gn_args [ 'use_goma ' ] == 'false ' ) : + self.goma_dir = False + gn_args.pop ( 'goma_dir ' , None ) +
diff -- git a/conn/physic/example_test.go b/conn/physic/example_test.go index 0a05e42..6b8fbdb 100644 -- - a/conn/physic/example_test.go +++ b/conn/physic/example_test.go @ @ -474,7 +474,50 @ @ func ExampleTemperature ( ) { // Output : // -273.150C // 23.010C - // 26.666C + // 26.667C + } + +func ExampleTemperature_Set ( ) { + var t physic.Temperature + + if err : = t.Set ( `` 0C '' ) ; err ! = nil { + log.Fatal ( err ) + } + fmt.Println ( t ) + + if err : = t.Set ( `` 1C '' ) ; err ! = nil { + log.Fatal ( err ) + } + fmt.Println ( t ) + + if err : = t.Set ( `` 5MK '' ) ; err ! = nil { + log.Fatal ( err ) + } + fmt.Println ( t ) + + if err : = t.Set ( `` 0F '' ) ; err ! = nil { + log.Fatal ( err ) + } + fmt.Println ( t ) + + if err : = t.Set ( `` 32F '' ) ; err ! = nil { + log.Fatal ( err ) + } + fmt.Println ( t ) +
diff -- git a/experimental/cmd/ws2812b/host.go b/experimental/cmd/ws2812b/host.go new file mode 100644 index 0000000..af7d261 -- - /dev/null +++ b/experimental/cmd/ws2812b/host.go @ @ -0,0 +1,16 @ @ +// Copyright 2018 The Periph Authors . All rights reserved . +// Use of this source code is governed under the Apache License , Version 2.0 +// that can be found in the LICENSE file . + +// +build ! periphextra + +package main + +import ( + '' periph.io/x/periph '' + '' periph.io/x/periph/host '' + ) + +func hostInit ( ) ( *periph.State , error ) { + return host.Init ( ) + } diff -- git a/experimental/cmd/ws2812b/hostextra.go b/experimental/cmd/ws2812b/hostextra.go new file mode 100644 index 0000000..3acb076 -- - /dev/null +++ b/experimental/cmd/ws2812b/hostextra.go @ @ -0,0 +1,16 @ @ +// Copyright 2018 The Periph Authors . All rights reserved . +// Use of this source code is governed under the Apache License , Version 2.0 +// that can be found in the LICENSE file . + +// +build periphextra + +package main + +// import ( +// '' periph.io/x/extra/hostextra '' +// '' periph.io/x/periph '' +// ) + +// func hostInit ( ) ( *periph.State , error ) { +// return hostextra.Init ( ) +// } diff -- git a/experimental/cmd/ws2812b/main.go b/experimental/cmd/ws2812b/main.go
diff -- git a/experimental/devices/bitbang/spi.go b/experimental/devices/bitbang/spi.go index c651586..04d1278 100644 -- - a/experimental/devices/bitbang/spi.go +++ b/experimental/devices/bitbang/spi.go @ @ -30,23 +30,14 @ @ import ( // // cs can be nil . func NewSPI ( clk , mosi gpio.PinOut , miso gpio.PinIn , cs gpio.PinOut ) ( *SPI , error ) { - if cs ! = nil { - if err : = cs.Out ( gpio.High ) ; err ! = nil { - return nil , err - } - } - if err : = clk.Out ( gpio.High ) ; err ! = nil { - return nil , err - } - if err : = mosi.Out ( gpio.High ) ; err ! = nil { - return nil , err - } - if miso ! = nil { - if err : = miso.In ( gpio.PullUp , gpio.NoEdge ) ; err ! = nil { - return nil , err - } - } - return & SPI { spiConn : spiConn { sck : clk , sdi : miso , sdo : mosi , csn : cs } } , nil + return & SPI { + spiConn : spiConn { + sck : clk , +
diff -- git a/build-deploy-artifact.sh b/build-deploy-artifact.sh new file mode 100755 index 0000000..6e023ec -- - /dev/null +++ b/build-deploy-artifact.sh @ @ -0,0 +1,16 @ @ + # ! /bin/bash +bazel build -- javacopt `` -source 1.7 '' -- javacopt `` -target 1.7 '' //java/google/registry/env/production : production_ear +OK= $ ? +if [ $ OK -eq 0 ] +then + echo `` Extracting ear file '' +else + echo `` Build failed '' + exit 1 +fi + +rm -rf mercury-donuts +mkdir mercury-donuts +cd mercury-donuts +jar -xf ../bazel-genfiles/java/google/registry/env/production/production_ear.ear +cd ../ diff -- git a/closure/BUILD b/closure/BUILD new file mode 100644 index 0000000..5d137e3 -- - /dev/null +++ b/closure/BUILD @ @ -0,0 +1,15 @ @ + # Copyright 2016 The Closure Rules Authors . All rights reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS
diff -- git a/WORKSPACE b/WORKSPACE index 04daf34..cf7285f 100644 -- - a/WORKSPACE +++ b/WORKSPACE @ @ -6,8 +6,8 @ @ domain_registry_repositories ( ) git_repository ( name = `` io_bazel_rules_closure '' , - remote = `` https : //github.com/bazelbuild/rules_closure.git '' , - tag = `` 0.1.0 '' , + remote = `` https : //github.com/donutsinc/rules_closure.git '' , + commit = `` 271f7b7e340a5313c82b3ecbfd035834a1b46153 '' , ) load ( `` @ io_bazel_rules_closure//closure : defs.bzl '' , `` closure_repositories '' ) diff -- git a/build-deploy-artifact.sh b/build-deploy-artifact.sh new file mode 100755 index 0000000..a735552 -- - /dev/null +++ b/build-deploy-artifact.sh @ @ -0,0 +1,16 @ @ + # ! /bin/bash +bazel build -- javacopt `` -source 1.7 '' -- javacopt `` -target 1.7 '' //java/google/registry/env : production_ear +OK= $ ? +if [ $ OK -eq 0 ] +then + echo `` Extracting ear file '' +else + echo `` Build failed '' + exit 1 +fi + +rm -rf mercury-donuts +mkdir mercury-donuts +cd mercury-donuts +jar -xf ../bazel-genfiles/java/google/registry/env/production_ear.ear +cd ../ diff -- git a/closure/BUILD b/closure/BUILD new file mode 100644 index 0000000..5d137e3 -- - /dev/null +++ b/closure/BUILD @ @ -0,0 +1,15 @ @ + # Copyright 2016 The Closure Rules Authors . All rights reserved . + # + #
diff -- git a/WORKSPACE b/WORKSPACE index 04daf34..cf7285f 100644 -- - a/WORKSPACE +++ b/WORKSPACE @ @ -6,8 +6,8 @ @ domain_registry_repositories ( ) git_repository ( name = `` io_bazel_rules_closure '' , - remote = `` https : //github.com/bazelbuild/rules_closure.git '' , - tag = `` 0.1.0 '' , + remote = `` https : //github.com/donutsinc/rules_closure.git '' , + commit = `` 271f7b7e340a5313c82b3ecbfd035834a1b46153 '' , ) load ( `` @ io_bazel_rules_closure//closure : defs.bzl '' , `` closure_repositories '' ) diff -- git a/build-deploy-artifact.sh b/build-deploy-artifact.sh new file mode 100755 index 0000000..a735552 -- - /dev/null +++ b/build-deploy-artifact.sh @ @ -0,0 +1,16 @ @ + # ! /bin/bash +bazel build -- javacopt `` -source 1.7 '' -- javacopt `` -target 1.7 '' //java/google/registry/env : production_ear +OK= $ ? +if [ $ OK -eq 0 ] +then + echo `` Extracting ear file '' +else + echo `` Build failed '' + exit 1 +fi + +rm -rf mercury-donuts +mkdir mercury-donuts +cd mercury-donuts +jar -xf ../bazel-genfiles/java/google/registry/env/production_ear.ear +cd ../ diff -- git a/closure/BUILD b/closure/BUILD new file mode 100644 index 0000000..5d137e3 -- - /dev/null +++ b/closure/BUILD @ @ -0,0 +1,15 @ @ + # Copyright 2016 The Closure Rules Authors . All rights reserved . + # + #
diff -- git a/java/google/registry/config/ConfigModule.java b/java/google/registry/config/ConfigModule.java index 66adc7c..48cfaff 100644 -- - a/java/google/registry/config/ConfigModule.java +++ b/java/google/registry/config/ConfigModule.java @ @ -406,6 +406,18 @ @ public final class ConfigModule { } /** + * Returns the identity used for the SSH keys used in RDE SFTP uploads . + * + * @ see Keyring # getRdeSshClientPublicKey ( ) + * @ see Keyring # getRdeSshClientPrivateKey ( ) + */ + @ Provides + @ Config ( `` rdeSshIdentity '' ) + public static String provideSshIdentity ( ) { + return `` rde @ charlestonroadregistry.com '' ; + } + + /** * Returns SFTP URL containing a username , hostname , port ( optional ) , and directory ( optional ) to * which cloud storage files are uploaded . The password should not be included , as it 's better to * use public key authentication . diff -- git a/java/google/registry/rde/JSchModule.java b/java/google/registry/rde/JSchModule.java index b313792..e26a24a 100644 -- - a/java/google/registry/rde/JSchModule.java +++ b/java/google/registry/rde/JSchModule.java @ @ -21,6 +21,7 @ @ import com.jcraft.jsch.JSch ; import com.jcraft.jsch.JSchException ; import dagger.Module ; import dagger.Provides ; +import google.registry.config.ConfigModule.Config ; import google.registry.keyring.api.KeyModule.Key ; /** Dagger module for { @ link JSch } which provides SSH/SFTP connectivity . */ @ @ -29,13 +30,14 @
diff -- git a/Makefile b/Makefile index cb2ea76..15ab7ce 100644 -- - a/Makefile +++ b/Makefile @ @ -32,11 +32,17 @ @ ifeq ( $ ( PYTHON ) , ) endif PYTHON_BIN : = $ ( shell which $ ( PYTHON ) ) PYTHON_VER : = $ ( word 2 , $ ( shell $ ( PYTHON ) -V 2 > & 1 ) ) +GO_MIN_VER : = 1.5 +GO_VER : = $ ( subst go , , $ ( word 3 , $ ( shell go version 2 > & 1 ) ) ) ifeq ( $ ( filter 2.7. % , $ ( PYTHON_VER ) ) , ) $ ( error unsupported Python version $ ( PYTHON_VER ) , Grumpy only supports 2.7.x . To use a different python binary such as python2 , run : 'make PYTHON=python2 ... ' ) endif +ifneq `` $ ( GO_MIN_VER ) '' `` $ ( word 1 , $ ( sort $ ( GO_MIN_VER ) $ ( GO_VER ) ) ) '' + $ ( error unsupported Go version $ ( GO_VER ) , Grumpy requires at least $ ( GO_MIN_VER ) .x . Please update Go . ) +endif + PY_DIR : =
diff -- git a/runtime/file.go b/runtime/file.go index 9bdcae8..54d526e 100644 -- - a/runtime/file.go +++ b/runtime/file.go @ @ -127,6 +127,11 @ @ func fileInit ( f *Frame , o *Object , args Args , _ KWArgs ) ( *Object , *BaseException flag = os.O_RDONLY case `` r+ '' , `` r+b '' : flag = os.O_RDWR + // Difference between r+ and a+ is that a+ automatically creates file . + case `` a+ '' : + flag = os.O_RDWR | os.O_CREATE | os.O_APPEND + case `` w+ '' : + flag = os.O_RDWR | os.O_CREATE case `` w '' , `` wb '' : flag = os.O_WRONLY | os.O_CREATE | os.O_TRUNC default : diff -- git a/runtime/file_test.go b/runtime/file_test.go index 74227ac..c3ccf80 100644 -- - a/runtime/file_test.go +++ b/runtime/file_test.go @ @ -34,7 +34,6 @ @ func TestFileInit ( t *testing.T ) { { args : wrapArgs ( newObject ( FileType ) , f.path ) , want : None } , { args : wrapArgs ( newObject ( FileType ) ) , wantExc : mustCreateException ( TypeErrorType , `` '__init__ ' requires 2 arguments '' ) } , { args : wrapArgs ( newObject ( FileType ) , f.path , `` abc '' ) , wantExc
diff -- git a/runtime/native.go b/runtime/native.go index 0ee9746..a422ee8 100644 -- - a/runtime/native.go +++ b/runtime/native.go @ @ -328,6 +328,18 @ @ func getNativeType ( rtype reflect.Type ) *Type { base = StrType } d : = map [ string ] *Object { `` __module__ '' : builtinStr.ToObject ( ) } + + derefed : = rtype + for derefed.Kind ( ) == reflect.Ptr { + derefed = derefed.Elem ( ) + } + if derefed.Kind ( ) == reflect.Struct { + for i : = 0 ; i < derefed.NumField ( ) ; i++ { + name : = derefed.Field ( i ) .Name + d [ name ] = newNativeField ( name , i ) + } + } + numMethod : = rtype.NumMethod ( ) for i : = 0 ; i < numMethod ; i++ { meth : = rtype.Method ( i ) @ @ -348,6 +360,21 @ @ func getNativeType ( rtype reflect.Type ) *Type { return t } +func newNativeField ( name string , i int ) *Object { + nativeFieldGet : = func ( f *Frame , args Args , _ KWArgs ) ( *Object , *BaseException ) { + if raised : = checkFunctionArgs (
diff -- git a/Makefile b/Makefile index 8f81c71..61e1636 100644 -- - a/Makefile +++ b/Makefile @ @ -21,8 +21,15 @ @ GOOS ? = $ ( word 1 , $ ( GO_ENV ) ) GOARCH ? = $ ( word 2 , $ ( GO_ENV ) ) ROOT_DIR : = $ ( realpath . ) PKG_DIR : = build/pkg/ $ ( GOOS ) _ $ ( GOARCH ) +PYTHON ? = python +PYTHON_BIN : = $ ( shell which $ ( PYTHON ) ) +PYTHON_VER : = $ ( word 2 , $ ( shell $ ( PYTHON ) -V 2 > & 1 ) ) PY_DIR : = build/lib/python2.7/site-packages +ifeq ( $ ( filter 2.7. % , $ ( PYTHON_VER ) ) , ) + $ ( error unsupported Python version $ ( PYTHON_VER ) , Grumpy only supports 2.7.x . To use a different python binary such as python2 , run : 'make PYTHON=python2 ... ' ) +endif + export GOPATH : = $ ( ROOT_DIR ) /build export PYTHONPATH : = $ ( ROOT_DIR ) / $ ( PY_DIR ) export PATH : = $ ( ROOT_DIR ) /build/bin : $ ( PATH ) @ @ -90,30 +97,32 @
diff -- git a/README.md b/README.md index ff4cdaa..ba05c70 100644 -- - a/README.md +++ b/README.md @ @ -25,10 +25,10 @ @ The top few distinct models for each dataset are shown below . You can see all s All percentages above correspond to the model 's accuracy at 80 % coverage . # # # # Bird or Bicycle dataset -| Defense | Submitted by | Clean data | Spatial grid attack | SPSA attack | Boundary attack | Submission Date | +| Defense | Submitted by | Clean data | Common corruptions | Spatial grid attack | SPSA attack | Boundary attack | Submission Date | | -- -- -- -- -- -- -- -- -- -- - | -- -- -- -- -- -- - | -- -- -- -- -- -- | -- -- -- -- -- -- | -- -- -- -- -- -- -- - | -- -- -- -- -- -- -- - | -- -- -- -- -- -- -- - | -| [ Keras ResNet < br > ( trained on ImageNet ) ] ( examples/undefended_keras_resnet ) | Google Brain | 100.0 % | 96.5 % | 1.6 % | 4.0 % | Sept
diff -- git a/.travis.yml b/.travis.yml index 1e9f8ef..209f67f 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -5,15 +5,16 @ @ language : python python : - 2.7 - 3.5 + env : - - KERAS_BACKEND=tensorflow TENSORFLOW_V=1.8.0 PYTORCH=False - - KERAS_BACKEND=tensorflow TENSORFLOW_V=1.4.1 PYTORCH=True + - TENSORFLOW_V=1.8.0 install : # code below is taken from http : //conda.pydata.org/docs/travis.html # We do this conditionally because it saves us some downloading if the # version is the same . - - if [ [ `` $ TRAVIS_PYTHON_VERSION '' == `` 2.7 '' ] ] ; then + - > + if [ [ `` $ TRAVIS_PYTHON_VERSION '' == `` 2.7 '' ] ] ; then wget https : //repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh ; else wget https : //repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh ; @ @ -26,20 +27,20 @ @ install : # Useful for debugging any issues with conda - conda info -a - - conda create -q -n test-environment python= $ TRAVIS_PYTHON_VERSION numpy scipy pyqt=4.11 matplotlib pandas h5py six mkl-service + - conda create -q -n test-environment python= $ TRAVIS_PYTHON_VERSION numpy six - source activate test-environment # install TensorFlow + - > if [ [ `` $ TRAVIS_PYTHON_VERSION '' == `` 2.7 '' & & `` $
diff -- git a/bird-or-bicycle/bin/process_tasker_data.py b/bird-or-bicycle/bin/process_tasker_data.py index eb0c735..faf4d74 100644 -- - a/bird-or-bicycle/bin/process_tasker_data.py +++ b/bird-or-bicycle/bin/process_tasker_data.py @ @ -3,9 +3,9 @ @ import json import os.path from collections import defaultdict -MIN_BBOX_AREA = ( 0.5 * 299 ) ** 2 +MIN_BBOX_AREA = ( 0.4 * 299 ) ** 2 -ALLOW_TRUNCATED = True +ALLOW_TRUNCATED = False ALLOW_OCCLUDED = True @ @ -79,7 +79,12 @ @ if __name__ == '__main__ ' : unambiguous_bicycle_urls = [ ] rejection_reason_to_urls = defaultdict ( list ) - filename = '/Users/tomfeelslucky/Downloads/bird-or-bicycle-tasker-data - shuffled_urls_v0-0-1.csv' + + # Raw tasker labels can be fetched with the following command : + # + # wget -- no-check-certificate `` https : //drive.google.com/uc ? authuser=0 & id=1pfW-QEDKieQrEBioopGJxz-CJhrSiPJq & export=download '' -O /tmp/tasker_labels_0.0.4.csv + # + filename = '/tmp/tasker_labels_0.0.4.csv' with open ( filename , 'r ' ) as f : reader = csv.reader ( f ) _ = next ( reader ) @ @ -117,12 +122,12 @ @ if __name__ == '__main__ ' : if not ALLOW_OCCLUDED : if not all ( [ not resp.is_occluded for resp in responses ] ) : rejection_reason_to_urls [ 'is_occluded ' ] .append ( url ) - continue + continue if not ALLOW_TRUNCATED : if not all ( [ not resp.is_truncated for
diff -- git a/examples/undefended_keras_resnet/main.py b/examples/undefended_keras_resnet/main.py index c3bc723..209b10e 100644 -- - a/examples/undefended_keras_resnet/main.py +++ b/examples/undefended_keras_resnet/main.py @ @ -8,37 +8,39 @ @ from bird_or_bicycle import CLASS_NAME_TO_IMAGENET_CLASS from tensorflow.keras.applications.resnet50 import preprocess_input from unrestricted_advex import eval_kit -if __name__ == '__main__ ' : - tf.keras.backend.set_image_data_format ( 'channels_last ' ) + # Variable scoping lets us use our _graph in our model_fn +_graph = tf.Graph ( ) +with _graph.as_default ( ) : + k_model = tf.keras.applications.resnet50.ResNet50 ( + include_top=True , weights='imagenet ' , input_tensor=None , + input_shape=None , pooling=None , classes=1000 ) - # Variable scoping lets us use our _graph in our model_fn - _graph = tf.Graph ( ) - with _graph.as_default ( ) : - k_model = tf.keras.applications.resnet50.ResNet50 ( - include_top=True , weights='imagenet ' , input_tensor=None , - input_shape=None , pooling=None , classes=1000 ) +def undefended_keras_model_fn ( x_np ) : + `` '' '' A normal keras resnet that was pretrained on ImageNet '' '' '' + x_np = preprocess_input ( x_np * 255 ) - def model_fn ( x_np ) : - `` '' '' A normal keras resnet that was pretrained on ImageNet '' '' '' - x_np = preprocess_input ( x_np * 255 ) + with _graph.as_default ( ) : + prob1000
diff -- git a/src/cli.ts b/src/cli.ts index 9bffb17..dc06eea 100644 -- - a/src/cli.ts +++ b/src/cli.ts @ @ -14,6 +14,7 @ @ * See the License for the specific language governing permissions and * limitations under the License . */ +import * as path from 'path ' ; import * as meow from 'meow ' ; import * as updateNotifier from 'update-notifier ' ; import { init } from './init ' ; @ @ -71,7 +72,8 @ @ function usage ( msg ? : string ) : void { async function run ( verb : string , files : string [ ] ) : Promise < boolean > { const options : Options = { dryRun : cli.flags.dryRun || false , - gtsRootDir : ` $ { process.cwd ( ) } /node_modules/gts ` , + // Paths are relative to the transpiled output files . + gtsRootDir : path.resolve ( __dirname , '../.. ' ) , targetRootDir : process.cwd ( ) , yes : cli.flags.yes || cli.flags.y || false , logger diff -- git a/test/test-kitchen.ts b/test/test-kitchen.ts index bd1e309..1cee2a4 100644 -- - a/test/test-kitchen.ts +++ b/test/test-kitchen.ts @ @ -74,6 +74,20 @ @ test.before ( async ( ) = > { await simpleExecp ( 'npm install
diff -- git a/package.json b/package.json index f152f69..73b3262 100644 -- - a/package.json +++ b/package.json @ @ -21,7 +21,7 @ @ `` scripts '' : { `` build '' : `` npm run compile '' , `` clean '' : `` rm -rf ./build/ '' , - `` compile '' : `` tsc -p . -- rootDir . -- outDir build/ '' , + `` compile '' : `` tsc -p . `` , `` format-check '' : `` echo \ '' TODO\ '' '' , `` format '' : `` clang-format -i -style= ' { Language : JavaScript , BasedOnStyle : Google , ColumnLimit : 80 } ' src/*.ts '' , `` lint '' : `` tslint -c tslint.json -- project . -- type-check -t codeFrame '' , diff -- git a/src/init.ts b/src/init.ts index 5609641..4bc3f66 100644 -- - a/src/init.ts +++ b/src/init.ts @ @ -46,11 +46,10 @ @ async function query ( async function addScripts ( packageJson : any , options : Options ) : Promise < boolean > { let edits = false ; - const outDir = 'build/ ' ; const scripts : Bag < string > = { build : 'npm run compile ' , clean : 'rm -rf
diff -- git a/README.md b/README.md index c7ccfce..6533c11 100644 -- - a/README.md +++ b/README.md @ @ -1,5 +1,11 @ @ # google-ts-style + [ ! [ NPM Version ] [ npm-image ] ] [ npm-url ] + [ ! [ Build Status ] [ travis-image ] ] [ travis-url ] + [ ! [ Dependency Status ] [ david-image ] ] [ david-url ] + [ ! [ devDependency Status ] [ david-dev-image ] ] [ david-dev-url ] + [ ! [ Known Vulnerabilities ] [ snyk-image ] ] [ snyk-url ] + > ***NOTE : This repo is a work-in-progress and is not ready for general use just yet . This is not an official Google product . *** This repository is Google 's default TypeScript configuration . Made with  by the Google Node.js team . @ @ -25,3 +31,14 @ @ $ ( npm bin ) /gts -- init # License See [ LICENSE.md ] ( LICENSE.md ) + + [ npm-image ] : https : //img.shields.io/npm/v/google-ts-style.svg + [ npm-url ] : https : //npmjs.org/package/google-ts-style + [ travis-image ] : https : //travis-ci.org/google/ts-style.svg ? branch=master + [ travis-url ] : https : //travis-ci.org/google/ts-style + [ david-image ] :
diff -- git a/package.json b/package.json index 78d6515..6e29d09 100644 -- - a/package.json +++ b/package.json @ @ -67,5 +67,10 @ @ } , `` peerDependencies '' : { `` typescript '' : `` ^2.4.1 '' + } , + `` ava '' : { + `` require '' : [ + `` source-map-support '' + ] } } diff -- git a/src/clean.ts b/src/clean.ts index 18128a6..1e06f94 100644 -- - a/src/clean.ts +++ b/src/clean.ts @ @ -16,14 +16,14 @ @ import * as chalk from 'chalk ' ; import { Options } from './cli ' ; -import * as tscfg from './tscfg ' ; +import { TSConfig } from './tscfg ' ; import { rimrafp } from './util ' ; /** * Remove files generated by the build . */ export async function clean ( options : Options ) : Promise < void > { - const tsconfig = await tscfg.getTsConfig ( options.targetRootDir ) ; + const tsconfig = ( await TSConfig.get ( options.targetRootDir ) ) .contents ; if ( tsconfig.compilerOptions & & tsconfig.compilerOptions.outDir ) { const outDir = tsconfig.compilerOptions.outDir ; if ( outDir === ' . ' ) { diff -- git a/src/fix.ts b/src/fix.ts index 417b095..4412a32 100644 -- - a/src/fix.ts +++ b/src/fix.ts @ @
diff -- git a/src/format.ts b/src/format.ts index 796c244..309adbd 100644 -- - a/src/format.ts +++ b/src/format.ts @ @ -32,12 +32,10 @ @ export async function format ( const program = createProgram ( options ) ; const srcFiles = files.length > 0 ? files : - program.getSourceFiles ( ) - .map ( sourceFile = > sourceFile.fileName ) - .filter ( f = > ! f.endsWith ( '.d.ts ' ) ) ; + program.getRootFileNames ( ) .filter ( f = > ! f.endsWith ( '.d.ts ' ) ) ; if ( fix ) { - return fixFormat ( srcFiles ) ; + return await fixFormat ( srcFiles ) ; } else { const result = await checkFormat ( srcFiles ) ; if ( ! result ) { diff -- git a/test/test-format.ts b/test/test-format.ts new file mode 100644 index 0000000..1cbcbd7 -- - /dev/null +++ b/test/test-format.ts @ @ -0,0 +1,59 @ @ +/** + * Copyright 2017 Google Inc. All Rights Reserved . + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at
diff -- git a/docs/Filament.md.html b/docs/Filament.md.html index e4e5805..a8508e3 100644 -- - a/docs/Filament.md.html +++ b/docs/Filament.md.html @ @ -43,7 +43,7 @ @ Flexibility : A physically based approach must not preclude non-realistic rendering . User interfaces for instance will need unlit materials . Deployment size - : While not directly related to the content of this document , it bears emphasizing our desire to keep the rendering library as small as possible so any application can bundle it without increase the binary to undesirable sizes . + : While not directly related to the content of this document , it bears emphasizing our desire to keep the rendering library as small as possible so any application can bundle it without increasing the binary to undesirable sizes . # # Physically based rendering @ @ -136,7 +136,7 @ @ However , not all microfacets with a properly oriented normal will contribute ref ! [ Figure [ microfacetShadowing ] : Masking and shadowing of microfacets ] ( images/diagram_shadowing_masking.png ) -A microfacet BRDF is heavily influenced by a _roughness_ parameter which describes how smooth ( low roughness ) or how rough ( high roughness ) a surface is at a micro level . The smoother the
diff -- git a/docs/Filament.md.html b/docs/Filament.md.html index 6e616c2..e0adc4f 100644 -- - a/docs/Filament.md.html +++ b/docs/Filament.md.html @ @ -43,7 +43,7 @ @ Flexibility : A physically based approach must not preclude non-realistic rendering . User interfaces for instance will need unlit materials . Deployment size - : While not directly related to the content of this document , it bears emphasizing our desire to keep the rendering library as small as possible so any application can bundle it without increase the binary to undesirable sizes . + : While not directly related to the content of this document , it bears emphasizing our desire to keep the rendering library as small as possible so any application can bundle it without increasing the binary to undesirable sizes . # # Physically based rendering @ @ -136,7 +136,7 @ @ However , not all microfacets with a properly oriented normal will contribute ref ! [ Figure [ microfacetShadowing ] : Masking and shadowing of microfacets ] ( images/diagram_shadowing_masking.png ) -A microfacet BRDF is heavily influenced by a _roughness_ parameter which describes how smooth ( low roughness ) or how rough ( high roughness ) a surface is at a micro level . The smoother the
diff -- git a/web/samples/webpack/README.md b/web/samples/webpack/README.md new file mode 100644 index 0000000..6aad1d9 -- - /dev/null +++ b/web/samples/webpack/README.md @ @ -0,0 +1,11 @ @ +The folder contains a simple Filament demo that uses webpack , TypeScript , and ` import ` . + +webpack combines ` src/app.ts ` with ` node_modules/filament/filament.js ` and generates + ` public/main.js ` . It also copies ` filament.wasm ` and ` index.html ` . + +To build and run the sample , do : + + npm install + npm run build + cd public + npx http-server diff -- git a/web/samples/webpack/package.json b/web/samples/webpack/package.json new file mode 100644 index 0000000..f07352f -- - /dev/null +++ b/web/samples/webpack/package.json @ @ -0,0 +1,19 @ @ + { + `` name '' : `` filament_webpack_demo '' , + `` main '' : `` index.js '' , + `` version '' : `` 1.0.0 '' , + `` scripts '' : { + `` build '' : `` webpack -- mode production '' , + `` watch '' : `` webpack -- mode development -- watch '' + } , + `` devDependencies '' : { + `` ts-loader '' : `` ^5.0.0 '' , + `` typescript '' : `` ^3.0.0 ''
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 0049e04..b8780e0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -3,13 +3,6 @ @ # ================================================================================================== cmake_minimum_required ( VERSION 3.1 ) -if ( WIN32 ) - # On Windows we need to instruct cmake to generate the .def in order to get the .lib required - # when linking against dlls . CL.EXE will not generate .lib without .def file ( or without pragma - # __declspec ( dllexport ) in front of each functions ) . - set ( CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS ON ) -endif ( ) - # ================================================================================================== # Project declaration # ================================================================================================== @ @ -29,6 +22,11 @ @ if ( UNIX AND NOT APPLE AND NOT ANDROID ) endif ( ) if ( WIN32 ) + # On Windows we need to instruct cmake to generate the .def in order to get the .lib required + # when linking against dlls . CL.EXE will not generate .lib without .def file ( or without pragma + # __declspec ( dllexport ) in front of each functions ) . + set ( CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS ON ) + # TODO : Figure out why pdb generation messes with incremental compilaton . # IN RELEASE_WITH_DEBUG_INFO , generate debug
diff -- git a/filament/src/driver/vulkan/VulkanDriverImpl.cpp b/filament/src/driver/vulkan/VulkanDriverImpl.cpp index 411a5ad..c2f8a97 100644 -- - a/filament/src/driver/vulkan/VulkanDriverImpl.cpp +++ b/filament/src/driver/vulkan/VulkanDriverImpl.cpp @ @ -102,8 +102,34 @ @ void selectPhysicalDevice ( VulkanContext & context ) { context.physicalDevice = physicalDevice ; vkGetPhysicalDeviceFeatures ( physicalDevice , & context.physicalDeviceFeatures ) ; vkGetPhysicalDeviceMemoryProperties ( physicalDevice , & context.memoryProperties ) ; - utils : :slog.i < < `` Selected physical device : `` - < < context.physicalDeviceProperties.deviceName < < utils : :io : :endl ; + + // Print out some properties of the GPU for diagnostic purposes . + // + // Ideally , the vendors register their vendor ID 's with Khronos so that apps can make an + // id = > string mapping . However in practice this has n't happened . At the time of this + // writing the gpuinfo database has the following ID 's : + // + // 0x1002 - AMD + // 0x1010 - ImgTec + // 0x10DE - NVIDIA + // 0x13B5 - ARM + // 0x5143 - Qualcomm + // 0x8086 - INTEL + // + // Since we do n't have any vendor-specific workarounds yet , there 's no need to make this + // mapping in code . The ``
diff -- git a/filament/include/filament/driver/ExternalContext.h b/filament/include/filament/driver/ExternalContext.h index f0b8449..f3d7edf 100644 -- - a/filament/include/filament/driver/ExternalContext.h +++ b/filament/include/filament/driver/ExternalContext.h @ @ -45,7 +45,7 @ @ public : // Creates and and initializes the low-level API ( e.g . an OpenGL context or Vulkan instance ) , // then creates the concrete Driver . Returns null on failure . - virtual std : :unique_ptr < Driver > createDriver ( void* const sharedGLContext ) noexcept = 0 ; + virtual std : :unique_ptr < Driver > createDriver ( void* sharedGLContext ) noexcept = 0 ; virtual ~ExternalContext ( ) noexcept ; diff -- git a/filament/src/driver/opengl/ContextManagerCocoa.h b/filament/src/driver/opengl/ContextManagerCocoa.h index 3ad625c..a28bc17 100644 -- - a/filament/src/driver/opengl/ContextManagerCocoa.h +++ b/filament/src/driver/opengl/ContextManagerCocoa.h @ @ -29,34 +29,34 @ @ struct ContextManagerCocoaImpl ; class ContextManagerCocoa final : public driver : :ContextManagerGL { public : ContextManagerCocoa ( ) ; - ~ContextManagerCocoa ( ) noexcept final override ; + ~ContextManagerCocoa ( ) noexcept final ; - std : :unique_ptr < Driver > createDriver ( void* const sharedGLContext ) noexcept override ; - void terminate ( ) noexcept final override ; + std : :unique_ptr < Driver > createDriver ( void* sharedGLContext ) noexcept override ; + void terminate ( ) noexcept final ; - SwapChain* createSwapChain ( void* nativewindow ,
diff -- git a/filament/include/filament/driver/ExternalContext.h b/filament/include/filament/driver/ExternalContext.h index f3d7edf..8ffab64 100644 -- - a/filament/include/filament/driver/ExternalContext.h +++ b/filament/include/filament/driver/ExternalContext.h @ @ -70,6 +70,8 @ @ public : // swap draw buffers ( i.e . for double-buffered rendering ) . virtual void commit ( SwapChain* swapChain ) noexcept = 0 ; + virtual void setPresentationTime ( long time ) noexcept = 0 ; + virtual bool canCreateFence ( ) noexcept { return false ; } virtual Fence* createFence ( ) noexcept = 0 ; virtual void destroyFence ( Fence* fence ) noexcept = 0 ; diff -- git a/filament/src/driver/opengl/ContextManagerCocoa.h b/filament/src/driver/opengl/ContextManagerCocoa.h index a28bc17..5703de2 100644 -- - a/filament/src/driver/opengl/ContextManagerCocoa.h +++ b/filament/src/driver/opengl/ContextManagerCocoa.h @ @ -45,6 +45,8 @ @ public : return driver : :FenceStatus : :ERROR ; } + void setPresentationTime ( long time ) noexcept final override { } + Stream* createStream ( void* nativeStream ) noexcept final { return nullptr ; } void destroyStream ( Stream* stream ) noexcept final { } void attach ( Stream* stream , intptr_t tname ) noexcept final { } diff -- git a/filament/src/driver/opengl/ContextManagerEGL.cpp b/filament/src/driver/opengl/ContextManagerEGL.cpp index 400e0ad..c747e2f 100644 -- - a/filament/src/driver/opengl/ContextManagerEGL.cpp +++ b/filament/src/driver/opengl/ContextManagerEGL.cpp @ @ -63,6 +63,9 @ @ using namespace utils ; namespace filament { using namespace driver ; +using PFNEGLGETNATIVECLIENTBUFFERANDROIDPROC = +
diff -- git a/src/main/java/com/android/volley/Cache.java b/src/main/java/com/android/volley/Cache.java index 8482c22..bf17bed 100644 -- - a/src/main/java/com/android/volley/Cache.java +++ b/src/main/java/com/android/volley/Cache.java @ @ -17,6 +17,7 @ @ package com.android.volley ; import java.util.Collections ; +import java.util.List ; import java.util.Map ; /** @ @ -83,9 +84,18 @ @ public interface Cache { /** Soft TTL for this record . */ public long softTtl ; - /** Immutable response headers as received from server ; must be non-null . */ + /** + * Immutable response headers as received from server ; must be non-null . + * + * < p > Note that if the server returns two headers with the same ( case-insensitive ) name , + * this map will only contain the one of them . { @ link # allResponseHeaders } may contain all + * headers if the { @ link Cache } implementation supports it . + */ public Map < String , String > responseHeaders = Collections.emptyMap ( ) ; + /** All response headers . May be null depending on the { @ link Cache } implementation . */ + public List < Header > allResponseHeaders ; + /** True if the entry is expired . */ public boolean isExpired (
diff -- git a/Gruntfile.js b/Gruntfile.js new file mode 100644 index 0000000..6e12ebd -- - /dev/null +++ b/Gruntfile.js @ @ -0,0 +1,65 @ @ +/** + * google-code-prettify + * https : //github.com/google/code-prettify + * + * Copyright ( C ) 2017 Google Inc. + * Licensed under Apache 2.0 license . + */ + +module.exports = function ( grunt ) { + 'use strict ' ; + + // project configuration + grunt.initConfig ( { + // metadata + pkg : grunt.file.readJSON ( 'package.json ' ) , + + // grunt-preprocess + preprocess : { + // https : //github.com/jsoverson/preprocess # optionstype + options : { + // renders @ include directives ( similar to SSI server-side includes ) + // where JS files are resolved relative to this directory + srcDir : 'js-modules ' , + type : 'js' + } , + prettify : { + src : 'js-modules/prettify.js ' , + dest : 'src/prettify.js' + } , + runprettify : { + options : { + context : { + // to control where defs.js is included ( top level ) + RUN_PRETTIFY : true + } + } , + src : 'js-modules/run_prettify.js ' , + dest
diff -- git a/scoreboard/rest.py b/scoreboard/rest.py index 90cb3bf..00c7189 100644 -- - a/scoreboard/rest.py +++ b/scoreboard/rest.py @ @ -110,13 +110,13 @ @ class User ( flask_restful.Resource ) : @ flask_restful.marshal_with ( resource_fields ) def get ( self , user_id ) : - if not models.User.current ( ) .uid == user_id and not models.User.current ( ) .admin : + if not flask.g.uid == user_id and not flask.g.admin : raise errors.AccessDeniedError ( 'No access to that user . ' ) return models.User.query.get_or_404 ( user_id ) @ flask_restful.marshal_with ( resource_fields ) def put ( self , user_id ) : - if not models.User.current ( ) .uid == user_id and not models.User.current ( ) .admin : + if not flask.g.uid == user_id and not flask.g.admin : raise errors.AccessDeniedError ( 'No access to that user . ' ) user = models.User.query.get_or_404 ( user_id ) data = flask.request.get_json ( ) diff -- git a/scoreboard/tests/base.py b/scoreboard/tests/base.py index b4e441c..f10a627 100644 -- - a/scoreboard/tests/base.py +++ b/scoreboard/tests/base.py @ @ -58,27 +58,48 @ @ class BaseTestCase ( flask_testing.TestCase ) : models.db.drop_all ( ) super ( BaseTestCase , self ) .tearDown ( ) + def queryLimit ( self , limit=None ) : + return MaxQueryBlock ( limit ) + class RestTestCase ( BaseTestCase ) :
diff -- git a/scoreboard/rest.py b/scoreboard/rest.py index 90cb3bf..00c7189 100644 -- - a/scoreboard/rest.py +++ b/scoreboard/rest.py @ @ -110,13 +110,13 @ @ class User ( flask_restful.Resource ) : @ flask_restful.marshal_with ( resource_fields ) def get ( self , user_id ) : - if not models.User.current ( ) .uid == user_id and not models.User.current ( ) .admin : + if not flask.g.uid == user_id and not flask.g.admin : raise errors.AccessDeniedError ( 'No access to that user . ' ) return models.User.query.get_or_404 ( user_id ) @ flask_restful.marshal_with ( resource_fields ) def put ( self , user_id ) : - if not models.User.current ( ) .uid == user_id and not models.User.current ( ) .admin : + if not flask.g.uid == user_id and not flask.g.admin : raise errors.AccessDeniedError ( 'No access to that user . ' ) user = models.User.query.get_or_404 ( user_id ) data = flask.request.get_json ( ) diff -- git a/scoreboard/tests/base.py b/scoreboard/tests/base.py index b4e441c..c66b445 100644 -- - a/scoreboard/tests/base.py +++ b/scoreboard/tests/base.py @ @ -58,28 +58,21 @ @ class BaseTestCase ( flask_testing.TestCase ) : models.db.drop_all ( ) super ( BaseTestCase , self ) .tearDown ( ) + def queryLimit ( self , limit=None ) : + return MaxQueryBlock ( limit ) + class RestTestCase ( BaseTestCase ) :
diff -- git a/scoreboard/models.py b/scoreboard/models.py index 0171bc5..65bb433 100644 -- - a/scoreboard/models.py +++ b/scoreboard/models.py @ @ -101,6 +101,15 @ @ class Team ( db.Model ) : return enumerate ( sorting.all ( ) , 1 ) @ classmethod + def all ( cls , with_history=True ) : + if with_history : + base = cls.query.options ( orm.joinedload ( cls.score_history ) ) + else : + base = cls.query + base = base.options ( orm.joinedload ( cls.answers ) ) + return base.all ( ) + + @ classmethod def current ( cls ) : try : return flask.g.team @ @ -151,6 +160,9 @ @ class User ( db.Model ) : def promote ( self ) : `` '' '' Promote a user to admin . '' '' '' empty_team = self.team and set ( self.team.players.all ( ) ) == set ( [ self ] ) + if self.team and len ( self.team.answers ) : + raise AssertionError ( + ' Can not promote player whose team has solved answers ! ' ) self.admin = True team = self.team self.team = None @ @ -240,6 +252,7 @ @ tag_challenge_association = db.Table ( 'tag_chall_association ' , db.Model.metadata , db.Column ( 'challenge_cid ' , db.BigInteger ,
diff -- git a/scoreboard/tests/base.py b/scoreboard/tests/base.py index fe3e945..543c6f7 100644 -- - a/scoreboard/tests/base.py +++ b/scoreboard/tests/base.py @ @ -14,6 +14,8 @ @ `` '' '' Base test module , MUST be imported first . '' '' '' +import contextlib +import functools import json import logging import os.path @ @ -87,6 +89,26 @ @ class RestTestCase ( BaseTestCase ) : super ( RestTestCase , self ) .tearDown ( ) pbkdf2.crypt = self._orig_pbkdf2 + def postJSON ( self , path , data , client=None ) : + client = client or self.client + return client.post ( + path , data=json.dumps ( data ) , + content_type='application/json ' ) + + def putJSON ( self , path , data , client=None ) : + client = client or self.client + return client.put ( + path , data=json.dumps ( data ) , + content_type='application/json ' ) + + @ contextlib.contextmanager + def swapClient ( self , client ) : + old_client = self.client + self.client = client + yield + self.client = old_client + + @ staticmethod def _pbkdf2_dummy ( value , *unused_args ) : return value @ @ -169,6 +191,24 @ @ class MaxQueryBlock ( object ) : logging.debug ( 'SQLAlchemy : % s ' ,
diff -- git a/scoreboard/models.py b/scoreboard/models.py index 0171bc5..bc77a91 100644 -- - a/scoreboard/models.py +++ b/scoreboard/models.py @ @ -399,8 +399,8 @ @ class Challenge ( db.Model ) : cat_slug = db.Column ( db.String ( 100 ) , db.ForeignKey ( 'category.slug ' ) ) answers = db.relationship ( 'Answer ' , backref=db.backref ( 'challenge ' , lazy='joined ' ) , lazy='select ' ) - attachments = db.relationship ( 'Attachment ' , backref='challenge ' , - lazy='joined ' ) + # attachments = db.relationship ( 'Attachment ' , backref='challenge ' , + # lazy='joined ' ) def __repr__ ( self ) : return ' < Challenge : % d/ % s > ' % ( self.cid , self.name ) @ @ -507,11 +507,12 @ @ class Challenge ( db.Model ) : aid_set.add ( a [ 'aid ' ] ) attachment = Attachment.query.get ( a [ 'aid ' ] ) if not attachment : - Attachment.create ( a [ 'aid ' ] , a [ 'filename ' ] , a [ 'content_type ' ] , self ) + logging.warning ( 'Trying to add attachment that does not exist ' ) + self.attachments.append ( attachment ) for a in old_attachments : if a.aid not in aid_set :
diff -- git a/scoreboard/attachments/__init__.py b/scoreboard/attachments/__init__.py index 0b7f8c2..64680ae 100644 -- - a/scoreboard/attachments/__init__.py +++ b/scoreboard/attachments/__init__.py @ @ -29,6 +29,7 @ @ from scoreboard import main app = main.get_app ( ) +backend = None def get_backend_path ( ) : `` '' '' Get backend path for attachments . '' '' '' @ @ -40,11 +41,23 @ @ def get_backend_type ( ) : backend = get_backend_path ( ) return urlparse.urlparse ( backend ) .scheme +def patch ( _backend_type ) : + if _backend_type == `` file '' : + import file as backend + elif _backend_type == `` gcs '' : + import gcs as backend + elif _backend_type == `` test '' : + import testing as backend + else : + raise ImportError ( 'Unhandled attachment backend % s ' % _backend_type ) + globals ( ) [ 'backend ' ] = backend _backend_type = get_backend_type ( ) if _backend_type == `` file '' : - from scoreboard.attachments.file import * + import file as backend elif _backend_type == `` gcs '' : - from scoreboard.attachments.gcs import * + import gcs as backend +elif _backend_type == `` test '' : + import testing as backend else : raise ImportError ( 'Unhandled attachment backend
diff -- git a/scoreboard/attachments/__init__.py b/scoreboard/attachments/__init__.py index 0b7f8c2..345c6b6 100644 -- - a/scoreboard/attachments/__init__.py +++ b/scoreboard/attachments/__init__.py @ @ -29,6 +29,7 @ @ from scoreboard import main app = main.get_app ( ) +backend = None def get_backend_path ( ) : `` '' '' Get backend path for attachments . '' '' '' @ @ -40,11 +41,19 @ @ def get_backend_type ( ) : backend = get_backend_path ( ) return urlparse.urlparse ( backend ) .scheme - -_backend_type = get_backend_type ( ) -if _backend_type == `` file '' : - from scoreboard.attachments.file import * -elif _backend_type == `` gcs '' : - from scoreboard.attachments.gcs import * -else : - raise ImportError ( 'Unhandled attachment backend % s ' % _backend_type ) +def get_backend ( _backend_type ) : + backend = None + if _backend_type == `` file '' : + import file as backend + elif _backend_type == `` gcs '' : + import gcs as backend + elif _backend_type == `` test '' : + import testing as backend + else : + raise ImportError ( 'Unhandled attachment backend % s ' % _backend_type ) + return backend + +def patch ( _backend_type ) : + globals ( ) [ 'backend ' ] = get_backend
diff -- git a/scoreboard/attachments/__init__.py b/scoreboard/attachments/__init__.py index 0b7f8c2..345c6b6 100644 -- - a/scoreboard/attachments/__init__.py +++ b/scoreboard/attachments/__init__.py @ @ -29,6 +29,7 @ @ from scoreboard import main app = main.get_app ( ) +backend = None def get_backend_path ( ) : `` '' '' Get backend path for attachments . '' '' '' @ @ -40,11 +41,19 @ @ def get_backend_type ( ) : backend = get_backend_path ( ) return urlparse.urlparse ( backend ) .scheme - -_backend_type = get_backend_type ( ) -if _backend_type == `` file '' : - from scoreboard.attachments.file import * -elif _backend_type == `` gcs '' : - from scoreboard.attachments.gcs import * -else : - raise ImportError ( 'Unhandled attachment backend % s ' % _backend_type ) +def get_backend ( _backend_type ) : + backend = None + if _backend_type == `` file '' : + import file as backend + elif _backend_type == `` gcs '' : + import gcs as backend + elif _backend_type == `` test '' : + import testing as backend + else : + raise ImportError ( 'Unhandled attachment backend % s ' % _backend_type ) + return backend + +def patch ( _backend_type ) : + globals ( ) [ 'backend ' ] = get_backend
diff -- git a/docs/glsl-fuzz-walkthrough.md b/docs/glsl-fuzz-walkthrough.md index 72e6904..f18d8d6 100644 -- - a/docs/glsl-fuzz-walkthrough.md +++ b/docs/glsl-fuzz-walkthrough.md @ @ -499,19 +499,11 @ @ and click `` Reduce result '' to reveal the reduction panel : ! [ Single result page with crash ] ( images/screenshot-single-result-crash.png ) -In the `` Error Regex '' text box , enter -a substring from the `` Run log '' text box that -will confirm the issue . -For example , -in this case , -we could enter `` Fatal signal 11 '' . -Ideally , we should enter something even more specific , -such as a function name from a stack trace , -but this is only possible if a stack trace is shown -in the run log . - - > The `` Error Regex '' text will be prepended and appended with ` . * ` - > and matched as a regular expression against the run log . +In the `` Error string '' text box , enter a substring from the `` Run log '' text box +that will confirm the issue . For example , in this case , we could enter `` Fatal +signal 11 '' . Ideally , we should enter something
diff -- git a/server/src/main/java/com/graphicsfuzz/server/webui/ReductionFilesHelper.java b/server/src/main/java/com/graphicsfuzz/server/webui/ReductionFilesHelper.java index 1cef2a1..6359718 100755 -- - a/server/src/main/java/com/graphicsfuzz/server/webui/ReductionFilesHelper.java +++ b/server/src/main/java/com/graphicsfuzz/server/webui/ReductionFilesHelper.java @ @ -24,9 +24,9 @ @ import java.util.Optional ; public class ReductionFilesHelper { - static File getReductionDir ( String token , String shaderSet , String shader ) { - return new File ( WebUiConstants.WORKER_DIR + `` / '' + token + `` / '' - + shaderSet + `` _ '' + shader + `` _inv '' ) ; + static File getReductionDir ( String token , String shaderSet , String variant ) { + return new File ( WebUiConstants.WORKER_DIR + `` / '' + token + `` / '' + shaderSet + + `` /reductions/ '' + variant ) ; } static Optional < File > getLatestReductionImage ( diff -- git a/server/src/main/java/com/graphicsfuzz/server/webui/WebUi.java b/server/src/main/java/com/graphicsfuzz/server/webui/WebUi.java index d3fe086..1339965 100755 -- - a/server/src/main/java/com/graphicsfuzz/server/webui/WebUi.java +++ b/server/src/main/java/com/graphicsfuzz/server/webui/WebUi.java @ @ -36,9 +36,7 @ @ import java.io.InputStream ; import java.io.PrintWriter ; import java.nio.charset.Charset ; import java.nio.file.Files ; -import java.nio.file.Path ; import java.nio.file.Paths ; -import java.nio.file.StandardCopyOption ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Comparator ; @ @ -89,9 +87,6 @ @ public class WebUi extends HttpServlet { private final FilenameFilter variantFragFilter = ( dir , name ) - > name.startsWith ( `` variant_ ''
diff -- git a/README.md b/README.md index 233ed91..f71fcbf 100644 -- - a/README.md +++ b/README.md @ @ -5,87 +5,20 @ @ Warning : this repository is a work-in-progress . Things may break while we transi [ ! [ License ] ( https : //img.shields.io/badge/License-Apache % 202.0-blue.svg ) ] ( https : //opensource.org/licenses/Apache-2.0 ) +GraphicsFuzz is a testing framework for automatically finding and simplifying bugs in GLSL and SPIR-V shader compilers . - # # Introduction +**NB : the [ GLSL reducer ] ( docs/reduce.md ) is available as a stand-alone tool . ** -GraphicsFuzz is a testing framework for automatically finding and simplifying bugs in graphics shader compilers . Our tools currently manipulate GLSL shaders , but we can indirectly test other targets such as SPIR-V , HLSL and Metal . Our current priority is testing Vulkan drivers . +* [ Introduction : why and how to test shader compilers ] ( docs/introduction.md ) +* [ Getting started : the walkthrough ] ( docs/walkthrough.md ) +* User documentation : + * [ Generate tests ] ( docs/generate.md ) + * [ Run tests ] ( docs/run.md ) + * [ Explore test results ] ( docs/explore.md ) + * [ Reduce a
diff -- git a/README.md b/README.md index 233ed91..d066ae0 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,31 @ @ -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . +**Warning : ** this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . # GraphicsFuzz [ ! [ License ] ( https : //img.shields.io/badge/License-Apache % 202.0-blue.svg ) ] ( https : //opensource.org/licenses/Apache-2.0 ) + # # # GraphicsFuzz is a testing framework for graphics drivers . - # # Introduction +GraphicsFuzz can automatically find and simplify bugs in graphics shader compilers . It enables to generate , run and reduce test shaders . It currently operates on GLSL shaders , and uses glslangValidator and spirv-tools to target SPIR-V. -GraphicsFuzz is a testing framework for automatically finding and simplifying bugs in graphics shader compilers . Our tools currently manipulate GLSL shaders , but we can indirectly test other targets such as SPIR-V , HLSL and Metal . Our current priority is testing Vulkan drivers . +**NB
diff -- git a/README.md b/README.md index 233ed91..544717e 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,32 @ @ -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . +**Warning : ** this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . # GraphicsFuzz [ ! [ License ] ( https : //img.shields.io/badge/License-Apache % 202.0-blue.svg ) ] ( https : //opensource.org/licenses/Apache-2.0 ) + # # # GraphicsFuzz is a testing framework for graphics drivers . - # # Introduction +GraphicsFuzz can automatically find and simplify bugs in graphics shader compilers . It enables to generate , run and reduce test shaders . It currently operates on GLSL shaders , and uses glslangValidator and spirv-tools to target SPIR-V. -GraphicsFuzz is a testing framework for automatically finding and simplifying bugs in graphics shader compilers . Our tools currently manipulate GLSL shaders , but we can indirectly test other targets such as SPIR-V , HLSL and Metal . Our current priority is testing Vulkan drivers . +**NB
diff -- git a/README.md b/README.md index 233ed91..d4472dd 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,43 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . - # GraphicsFuzz [ ! [ License ] ( https : //img.shields.io/badge/License-Apache % 202.0-blue.svg ) ] ( https : //opensource.org/licenses/Apache-2.0 ) + # # GraphicsFuzz is a testing framework for shader compilers - # # Introduction - -GraphicsFuzz is a testing framework for automatically finding and simplifying bugs in graphics shader compilers . Our tools currently manipulate GLSL shaders , but we can indirectly test other targets such as SPIR-V , HLSL and Metal . Our current priority is testing Vulkan drivers . - -* [ Getting started ] ( docs/getting_started.md ) -* [ Developer getting started ] ( docs/development.md ) -* [ Contributing ( requires Google CLA ) ] ( CONTRIBUTING.md ) -* [ License ( Apache 2.0 ) ] ( LICENSE ) - - # # The problem - -A graphics driver takes a *shader program* as input and executes it on a GPU ( graphics processing unit )
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..f1003b0 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,59 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/README.md b/README.md index 233ed91..5eb6e24 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,26 @ @ -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . +**Warning : ** this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . # GraphicsFuzz [ ! [ License ] ( https : //img.shields.io/badge/License-Apache % 202.0-blue.svg ) ] ( https : //opensource.org/licenses/Apache-2.0 ) + # # # GraphicsFuzz is a testing framework for graphics drivers . - # # Introduction +GraphicsFuzz can automatically find and simplify bugs in graphics shader compilers . It enables to generate , run and reduce test shaders . It currently operates on GLSL shaders , and uses glslangValidator and spirv-tools to target SPIR-V. -GraphicsFuzz is a testing framework for automatically finding and simplifying bugs in graphics shader compilers . Our tools currently manipulate GLSL shaders , but we can indirectly test other targets such as SPIR-V , HLSL and Metal . Our current priority is testing Vulkan drivers . +**NB
diff -- git a/README.md b/README.md index 233ed91..d4472dd 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,43 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . - # GraphicsFuzz [ ! [ License ] ( https : //img.shields.io/badge/License-Apache % 202.0-blue.svg ) ] ( https : //opensource.org/licenses/Apache-2.0 ) + # # GraphicsFuzz is a testing framework for shader compilers - # # Introduction - -GraphicsFuzz is a testing framework for automatically finding and simplifying bugs in graphics shader compilers . Our tools currently manipulate GLSL shaders , but we can indirectly test other targets such as SPIR-V , HLSL and Metal . Our current priority is testing Vulkan drivers . - -* [ Getting started ] ( docs/getting_started.md ) -* [ Developer getting started ] ( docs/development.md ) -* [ Contributing ( requires Google CLA ) ] ( CONTRIBUTING.md ) -* [ License ( Apache 2.0 ) ] ( LICENSE ) - - # # The problem - -A graphics driver takes a *shader program* as input and executes it on a GPU ( graphics processing unit )
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..f1003b0 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,59 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/authn/BUILD.bazel b/authn/BUILD.bazel deleted file mode 100644 index a2271da..0000000 -- - a/authn/BUILD.bazel +++ /dev/null @ @ -1,31 +0,0 @ @ -load ( `` @ io_bazel_rules_go//go : def.bzl '' , `` go_library '' , `` go_test '' ) - -go_library ( - name = `` go_default_library '' , - srcs = [ - `` anon.go '' , - `` auth.go '' , - `` authn.go '' , - `` basic.go '' , - `` bearer.go '' , - `` doc.go '' , - `` helper.go '' , - `` keychain.go '' , - ] , - importpath = `` github.com/google/go-containerregistry/authn '' , - visibility = [ `` //visibility : public '' ] , - deps = [ `` //name : go_default_library '' ] , - ) - -go_test ( - name = `` go_default_test '' , - srcs = [ - `` anon_test.go '' , - `` basic_test.go '' , - `` bearer_test.go '' , - `` helper_test.go '' , - `` keychain_test.go '' , - ] , - embed = [ `` : go_default_library '' ] , - deps = [ `` //name : go_default_library '' ] , - ) diff -- git a/authn/anon.go b/authn/anon.go deleted file mode
diff -- git a/cmd/deleter/BUILD.bazel b/cmd/deleter/BUILD.bazel new file mode 100644 index 0000000..5bacf74 -- - /dev/null +++ b/cmd/deleter/BUILD.bazel @ @ -0,0 +1,19 @ @ +load ( `` @ io_bazel_rules_go//go : def.bzl '' , `` go_binary '' , `` go_library '' ) + +go_library ( + name = `` go_default_library '' , + srcs = [ `` main.go '' ] , + importpath = `` github.com/google/go-containerregistry/cmd/deleter '' , + visibility = [ `` //visibility : private '' ] , + deps = [ + `` //authn : go_default_library '' , + `` //name : go_default_library '' , + `` //v1/remote : go_default_library '' , + ] , + ) + +go_binary ( + name = `` deleter '' , + embed = [ `` : go_default_library '' ] , + visibility = [ `` //visibility : public '' ] , + ) diff -- git a/cmd/deleter/main.go b/cmd/deleter/main.go new file mode 100644 index 0000000..eedce41 -- - /dev/null +++ b/cmd/deleter/main.go @ @ -0,0 +1,58 @ @ +// Copyright 2018 Google LLC All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License
diff -- git a/ko/publish/daemon.go b/ko/publish/daemon.go index 98143d9..ee4121c 100644 -- - a/ko/publish/daemon.go +++ b/ko/publish/daemon.go @ @ -15,6 +15,7 @ @ package publish import ( + '' fmt '' '' log '' '' github.com/google/go-containerregistry/name '' @ @ -34,7 +35,11 @ @ func NewDaemon ( wo daemon.WriteOptions ) Interface { // Publish implements publish.Interface func ( d *demon ) Publish ( img v1.Image , s string ) ( name.Reference , error ) { - tag , err : = name.NewTag ( s , name.WeakValidation ) + h , err : = img.Digest ( ) + if err ! = nil { + return nil , err + } + tag , err : = name.NewTag ( fmt.Sprintf ( `` ko.local/ % s : % s '' , s , h.Hex ) , name.WeakValidation ) if err ! = nil { return nil , err } diff -- git a/ko/publish/daemon_test.go b/ko/publish/daemon_test.go index 164f694..ba7e2fc 100644 -- - a/ko/publish/daemon_test.go +++ b/ko/publish/daemon_test.go @ @ -50,7 +50,7 @ @ func TestDaemon ( t *testing.T ) { def : = NewDaemon ( daemon.WriteOptions { } ) if d , err : = def.Publish ( img , importpath ) ; err ! = nil { t.Errorf ( `` Publish (
diff -- git a/.bazelrc b/.bazelrc new file mode 100644 index 0000000..68e9acc -- - /dev/null +++ b/.bazelrc @ @ -0,0 +1,15 @ @ +build -- deleted_packages=\ +vendor/k8s.io/code-generator/cmd/deepcopy-gen , \ +vendor/k8s.io/code-generator/cmd/deepcopy-gen/args , \ +vendor/k8s.io/code-generator/pkg/util , \ +vendor/k8s.io/gengo/args , \ +vendor/k8s.io/gengo/examples/deepcopy-gen/generators , \ +vendor/k8s.io/gengo/examples/deepcopy-gen/generators/args + +test -- test_output=errors \ + -- deleted_packages=\ +vendor/k8s.io/code-generator/cmd/deepcopy-gen , \ +vendor/k8s.io/code-generator/cmd/deepcopy-gen/args , \ +vendor/k8s.io/code-generator/pkg/util , \ +vendor/k8s.io/gengo/args , \ +vendor/k8s.io/gengo/examples/deepcopy-gen/generators , \ diff -- git a/.gitattributes b/.gitattributes new file mode 100644 index 0000000..e303040 -- - /dev/null +++ b/.gitattributes @ @ -0,0 +1,5 @ @ + # This file is documented at https : //git-scm.com/docs/gitattributes . + # Linguist-specific attributes are documented at + # https : //github.com/github/linguist . + +**/zz_generated_*.go linguist-generated=true diff -- git a/.travis.yml b/.travis.yml index 762bf22..5d768ec 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -8,7 +8,7 @ @ language : before_install : # Bazel requires JDK8 - sudo apt-get install oracle-java8-installer - + install : - go get -u github.com/bazelbuild/buildifier/buildifier @ @ -24,9 +24,9 @ @ addons : - bazel script : - - bazel clean & & bazel build //v1/ ... //name/ ... //authn/ ... //cmd/ ... - - bazel clean & & bazel test -- test_output=errors //v1/ ... //name/ ... //authn/ ... //cmd/ ...
diff -- git a/ko/build/BUILD.bazel b/ko/build/BUILD.bazel new file mode 100644 index 0000000..8b5d807 -- - /dev/null +++ b/ko/build/BUILD.bazel @ @ -0,0 +1,32 @ @ +load ( `` @ io_bazel_rules_go//go : def.bzl '' , `` go_library '' , `` go_test '' ) + +go_library ( + name = `` go_default_library '' , + srcs = [ + `` build.go '' , + `` doc.go '' , + `` fixed.go '' , + `` gobuild.go '' , + ] , + importpath = `` github.com/google/go-containerregistry/ko/build '' , + visibility = [ `` //visibility : public '' ] , + deps = [ + `` //v1 : go_default_library '' , + `` //v1/mutate : go_default_library '' , + `` //v1/tarball : go_default_library '' , + `` //v1/v1util : go_default_library '' , + ] , + ) + +go_test ( + name = `` go_default_test '' , + srcs = [ + `` fixed_test.go '' , + `` gobuild_test.go '' , + ] , + embed = [ `` : go_default_library '' ] , + deps = [ + `` //v1 : go_default_library '' , + `` //v1/random : go_default_library '' , + ] , + ) diff -- git a/ko/build/build.go b/ko/build/build.go new file mode 100644
diff -- git a/third_party/dart_packages/crypto/CHANGELOG.md b/third_party/dart_packages/crypto/CHANGELOG.md index 9538d91..3e279ea 100644 -- - a/third_party/dart_packages/crypto/CHANGELOG.md +++ b/third_party/dart_packages/crypto/CHANGELOG.md @ @ -1,3 +1,17 @ @ + # # 2.0.5 + +* Changed the max message size instead to 0x3ffffffffffff , which is the largest + portable value for both JS and the Dart VM . + + # # 2.0.4 + +* Made max message size a BigNum instead of an int so that dart2js can compile + with crypto . + + # # 2.0.3 + +* Updated SDK version to 2.0.0-dev.17.0 + # # 2.0.2+1 * Fix SDK constraint . diff -- git a/third_party/dart_packages/crypto/README.md b/third_party/dart_packages/crypto/README.md index 5f8fad8..a5fe3c3 100644 -- - a/third_party/dart_packages/crypto/README.md +++ b/third_party/dart_packages/crypto/README.md @ @ -1,24 +1,96 @ @ - # Library of cryptographic functions for Dart + # Cryptographic hashing functions for Dart -A set of cryptographic functions implemented in pure Dart . +A set of cryptographic hashing functions implemented in pure Dart +The following hashing algorithms are supported : + +* SHA-1 +* SHA-256 * MD5 -* SHA1 -* SHA265 -* HMAC -* Converting a list of bytes into a hex string -* Converting a list of bytes into a base64-encoded string . -* Converting a Base 64 encoded String into list
diff -- git a/.clang-format b/.clang-format new file mode 100644 index 0000000..80002f6 -- - /dev/null +++ b/.clang-format @ @ -0,0 +1,5 @ @ +BasedOnStyle : Google + -- - +Language : Cpp +DerivePointerAlignment : false +PointerAlignment : Right diff -- git a/linux/library/include/flutter_desktop_embedding/channels.h b/linux/library/include/flutter_desktop_embedding/channels.h new file mode 100644 index 0000000..fdffee5 -- - /dev/null +++ b/linux/library/include/flutter_desktop_embedding/channels.h @ @ -0,0 +1,120 @ @ +// Copyright 2018 Google LLC +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + # ifndef LINUX_INCLUDE_FLUTTER_DESKTOP_EMBEDDING_CHANNELS_H_ + # define LINUX_INCLUDE_FLUTTER_DESKTOP_EMBEDDING_CHANNELS_H_ + + # include < json/json.h > + + # include < memory > + # include < string > + +
diff -- git a/linux/library/Makefile b/linux/library/Makefile index d696638..db05ebe 100644 -- - a/linux/library/Makefile +++ b/linux/library/Makefile @ @ -25,7 +25,7 @ @ LDFLAGS= -L $ ( CURDIR ) \ LIBRARIES=lib $ ( FLUTTER_ENGINE_LIB ) .so HEADERS= $ ( shell find include/ -type f -name '*.h ' ) -SOURCES= $ ( wildcard src/*.cc ) +SOURCES= $ ( shell find src/ -type f -name '*.cc ' ) .PHONY : all all : $ ( LIBRARY_OUT ) diff -- git a/linux/library/include/flutter_desktop_embedding/common/platform_protocol.h b/linux/library/include/flutter_desktop_embedding/common/platform_protocol.h new file mode 100644 index 0000000..0f1b88b -- - /dev/null +++ b/linux/library/include/flutter_desktop_embedding/common/platform_protocol.h @ @ -0,0 +1,26 @ @ +// Copyright 2018 Google LLC +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations
diff -- git a/linux/README.md b/linux/README.md index a70b711..ea28084 100644 -- - a/linux/README.md +++ b/linux/README.md @ @ -3,23 +3,33 @ @ This framework provides the basic functionality for embedding a Flutter app on the Linux desktop . This currently includes support for : -* Drawing a Flutter view . -* Mouse event handling . +* Drawing a Flutter view . +* Mouse event handling . # How to Use This Code Note that the example build here is ` host_debug_unopt ` ( you 'll find more info on -what that means in this section ) . This can be changed to whatever version of -the Flutter Engine you end up building . +what that means in this section ) . This can be changed to whatever version of the +Flutter Engine you end up building . First you will need to install the relevant dependencies . # # Dependencies -Requires GLFW3 on your system ( example for debian-based systems ) : +Requires : + +* GLFW3 +* GTK 3 +* jsoncpp +* epoxy +* X11 development libs +* pkg-config + +Installation example for debian-based systems : `` ` - $ sudo apt-get install libglfw3-dev + $ sudo apt-get install libglfw3-dev libepoxy-dev libjsoncpp-dev
diff -- git a/tools/flutter_location.bat b/tools/flutter_location.bat new file mode 100644 index 0000000..61b183d -- - /dev/null +++ b/tools/flutter_location.bat @ @ -0,0 +1,44 @ @ + : : Copyright 2018 Google LLC + : : + : : Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + : : you may not use this file except in compliance with the License . + : : You may obtain a copy of the License at + : : + : : http : //www.apache.org/licenses/LICENSE-2.0 + : : + : : Unless required by applicable law or agreed to in writing , software + : : distributed under the License is distributed on an `` AS IS '' BASIS , + : : WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + : : See the License for the specific language governing permissions and + : : limitations under the License . + @ echo off +SETLOCAL ENABLEDELAYEDEXPANSION + +set BASE_DIR= % ~dp0 +set CONFIG_FILE_DIR= % BASE_DIR % ..\..\ +set CONFIG_FILE= % CONFIG_FILE_DIR % .flutter_location_config + + : : Default to a sibling directory to this repository . +set FLUTTER_DIR= % BASE_DIR %
diff -- git a/linux/Makefile b/linux/Makefile new file mode 100644 index 0000000..05e086a -- - /dev/null +++ b/linux/Makefile @ @ -0,0 +1,30 @ @ + # Copyright 2018 Google LLC + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . +FLUTTER_ENGINE_LIB=flutter_engine +CXX=g++ -std=c++0x +CXXFLAGS= \ + -Wall -Werror \ + -I $ ( CURDIR ) \ + -L $ ( CURDIR ) \ + -lGL -lglfw -l $ ( FLUTTER_ENGINE_LIB ) \ + -Wl , -rpath= $ ( CURDIR ) \ + +all : flutter_embedder + +flutter_embedder : main.cc lib $ ( FLUTTER_ENGINE_LIB )
diff -- git a/.gitignore b/.gitignore new file mode 100644 index 0000000..e6737bf -- - /dev/null +++ b/.gitignore @ @ -0,0 +1 @ @ +.flutter_location_config \ No newline at end of file diff -- git a/tools/flutter_location.bat b/tools/flutter_location.bat new file mode 100644 index 0000000..3762a9c -- - /dev/null +++ b/tools/flutter_location.bat @ @ -0,0 +1,44 @ @ + : : Copyright 2018 Google LLC + : : + : : Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + : : you may not use this file except in compliance with the License . + : : You may obtain a copy of the License at + : : + : : http : //www.apache.org/licenses/LICENSE-2.0 + : : + : : Unless required by applicable law or agreed to in writing , software + : : distributed under the License is distributed on an `` AS IS '' BASIS , + : : WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + : : See the License for the specific language governing permissions and + : : limitations under the License . + @ echo off +SETLOCAL ENABLEDELAYEDEXPANSION + +set BASE_DIR= % ~dp0
diff -- git a/.gitignore b/.gitignore new file mode 100644 index 0000000..e6737bf -- - /dev/null +++ b/.gitignore @ @ -0,0 +1 @ @ +.flutter_location_config \ No newline at end of file diff -- git a/tools/flutter_location.bat b/tools/flutter_location.bat new file mode 100644 index 0000000..3762a9c -- - /dev/null +++ b/tools/flutter_location.bat @ @ -0,0 +1,44 @ @ + : : Copyright 2018 Google LLC + : : + : : Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + : : you may not use this file except in compliance with the License . + : : You may obtain a copy of the License at + : : + : : http : //www.apache.org/licenses/LICENSE-2.0 + : : + : : Unless required by applicable law or agreed to in writing , software + : : distributed under the License is distributed on an `` AS IS '' BASIS , + : : WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + : : See the License for the specific language governing permissions and + : : limitations under the License . + @ echo off +SETLOCAL ENABLEDELAYEDEXPANSION + +set BASE_DIR= % ~dp0
diff -- git a/.gitignore b/.gitignore new file mode 100644 index 0000000..e6737bf -- - /dev/null +++ b/.gitignore @ @ -0,0 +1 @ @ +.flutter_location_config \ No newline at end of file diff -- git a/tools/flutter_location.bat b/tools/flutter_location.bat new file mode 100644 index 0000000..3762a9c -- - /dev/null +++ b/tools/flutter_location.bat @ @ -0,0 +1,44 @ @ + : : Copyright 2018 Google LLC + : : + : : Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + : : you may not use this file except in compliance with the License . + : : You may obtain a copy of the License at + : : + : : http : //www.apache.org/licenses/LICENSE-2.0 + : : + : : Unless required by applicable law or agreed to in writing , software + : : distributed under the License is distributed on an `` AS IS '' BASIS , + : : WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + : : See the License for the specific language governing permissions and + : : limitations under the License . + @ echo off +SETLOCAL ENABLEDELAYEDEXPANSION + +set BASE_DIR= % ~dp0
diff -- git a/tools/flutter_location.bat b/tools/flutter_location.bat new file mode 100644 index 0000000..61b183d -- - /dev/null +++ b/tools/flutter_location.bat @ @ -0,0 +1,44 @ @ + : : Copyright 2018 Google LLC + : : + : : Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + : : you may not use this file except in compliance with the License . + : : You may obtain a copy of the License at + : : + : : http : //www.apache.org/licenses/LICENSE-2.0 + : : + : : Unless required by applicable law or agreed to in writing , software + : : distributed under the License is distributed on an `` AS IS '' BASIS , + : : WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + : : See the License for the specific language governing permissions and + : : limitations under the License . + @ echo off +SETLOCAL ENABLEDELAYEDEXPANSION + +set BASE_DIR= % ~dp0 +set CONFIG_FILE_DIR= % BASE_DIR % ..\..\ +set CONFIG_FILE= % CONFIG_FILE_DIR % .flutter_location_config + + : : Default to a sibling directory to this repository . +set FLUTTER_DIR= % BASE_DIR %
diff -- git a/ubuntu/Makefile b/ubuntu/Makefile new file mode 100644 index 0000000..6b43a88 -- - /dev/null +++ b/ubuntu/Makefile @ @ -0,0 +1,30 @ @ + # Copyright 2018 Google LLC + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . +FLUTTER_ENGINE_LIB=flutter_engine +CXX=g++ -std=c++0x +CXXFLAGS= \ + -Wall -Werror \ + -I $ ( CURDIR ) \ + -L $ ( CURDIR ) \ + -lGL -lglfw -l $ ( FLUTTER_ENGINE_LIB ) \ + -Wl , -rpath= $ ( CURDIR ) \ + +all : flutter_embedder + +flutter_embedder : main.cc lib $ ( FLUTTER_ENGINE_LIB )
diff -- git a/docs/amber_script.md b/docs/amber_script.md index 386bd38..0d57f62 100644 -- - a/docs/amber_script.md +++ b/docs/amber_script.md @ @ -53,6 +53,9 @ @ END # # # Buffers +An AmberScript buffer represents a set of contiguous bits . This can be used for +either image buffers or , what the target API would refer to as a buffer . + # # # # Data Types * int8 * int16 @ @ -71,27 +74,16 @ @ TODO ( dneto ) : Support half-precision floating point . Sized arrays and structures are not currently representable . - # # # # Buffer Types - * uniform - * storage - * vertex - * index - * sampled - * color - * depth - `` ` // Filling the buffer with a given set of data . The values must provide // < size_in_bytes > of < type > data . The data can be provided as the type or // as a hex value . -BUFFER < buffer_type > < name > DATA_TYPE < type > DATA +BUFFER < name > DATA_TYPE < type > DATA < value > + END -BUFFER < buffer_type > < name > DATA_TYPE < type > SIZE
diff -- git a/src/dawn/find_dawn.cmake b/src/dawn/find_dawn.cmake index 5222408..40d4158 100644 -- - a/src/dawn/find_dawn.cmake +++ b/src/dawn/find_dawn.cmake @ @ -39,7 +39,8 @ @ set ( Dawn_FOUND FALSE ) # # -DDawn_INCLUDE_DIR= < directory containing dawn/dawn_export.h > # -DDawn_GEN_INCLUDE_DIR= < directory containing dawn/dawn.h > - # -DDawn_LIBRARY_DIR= < directory containing dawn_native > + # -DDawn_LIBRARY_DIR= < directory containing dawn_native library + # e.g. , libdawn_native.a > find_path ( Dawn_INCLUDE_DIR diff -- git a/src/vulkan/buffer.cc b/src/vulkan/buffer.cc index d71d4bb..bb4ac0b 100644 -- - a/src/vulkan/buffer.cc +++ b/src/vulkan/buffer.cc @ @ -34,8 +34,10 @ @ Result Buffer : :Initialize ( const VkBufferUsageFlags usage ) { if ( ! allocate_result.r.IsSuccess ( ) ) return allocate_result.r ; - if ( CheckMemoryHostAccessible ( allocate_result.memory_type_index ) ) { + if ( IsMemoryHostAccessible ( allocate_result.memory_type_index ) ) { is_buffer_host_accessible_ = true ; + is_buffer_host_coherent_ = + IsMemoryHostCoherent ( allocate_result.memory_type_index ) ; return MapMemory ( memory_ ) ; } @ @ -58,17 +60,32 @ @ Result Buffer : :CreateVkBufferView ( VkFormat format ) { return { } ; } -void Buffer : :CopyToDevice ( VkCommandBuffer command ) { +Result Buffer : :CopyToDevice ( VkCommandBuffer command ) { if ( is_buffer_host_accessible_ ) - return ; + return FlushMemoryIfNeeded ( ) ; VkBufferCopy region = { } ; region.srcOffset =
diff -- git a/src/vulkan/device.cc b/src/vulkan/device.cc index 98a9c70..cd08d8a 100644 -- - a/src/vulkan/device.cc +++ b/src/vulkan/device.cc @ @ -15,6 +15,7 @ @ # include `` src/vulkan/device.h '' # include < memory > + # include < set > # include < vector > # include `` src/make_unique.h '' @ @ -204,8 +205,13 @ @ VkPhysicalDeviceFeatures RequestedFeatures ( } bool AreAllRequiredFeaturesSupported ( - const VkPhysicalDeviceFeatures & available_features , + const VkPhysicalDevice & physical_device , const std : :vector < Feature > & required_features ) { + if ( required_features.empty ( ) ) + return true ; + + VkPhysicalDeviceFeatures available_features = { } ; + vkGetPhysicalDeviceFeatures ( physical_device , & available_features ) ; for ( const auto & feature : required_features ) { switch ( feature ) { case Feature : :kRobustBufferAccess : @ @ -444,6 +450,40 @ @ bool AreAllRequiredFeaturesSupported ( return true ; } +bool AreAllExtensionsSupported ( + const VkPhysicalDevice & physical_device , + const std : :vector < std : :string > & required_extensions ) { + if ( required_extensions.empty ( ) ) + return true ; + + uint32_t available_extension_count = 0 ; + std : :vector < VkExtensionProperties > available_extension_properties ; + + if ( vkEnumerateDeviceExtensionProperties ( physical_device ,
diff -- git a/src/amberscript/parser.cc b/src/amberscript/parser.cc index c11d3fb..d45c52a 100644 -- - a/src/amberscript/parser.cc +++ b/src/amberscript/parser.cc @ @ -432,7 +432,7 @ @ Result Parser : :ParseBuffer ( ) { if ( ! r.IsSuccess ( ) ) return r ; - auto buffer = MakeUnique < Buffer > ( type ) ; + auto buffer = MakeUnique < DataBuffer > ( type ) ; token = tokenizer_- > NextToken ( ) ; if ( ! token- > IsString ( ) ) @ @ -474,7 +474,7 @ @ Result Parser : :ParseBuffer ( ) { return { } ; } -Result Parser : :ParseBufferFramebuffer ( Buffer* buffer ) { +Result Parser : :ParseBufferFramebuffer ( DataBuffer* buffer ) { auto token = tokenizer_- > NextToken ( ) ; if ( token- > IsEOL ( ) || token- > IsEOS ( ) ) return Result ( `` BUFFER framebuffer missing DIMS values '' ) ; @ @ -506,7 +506,7 @ @ Result Parser : :ParseBufferFramebuffer ( Buffer* buffer ) { return ValidateEndOfStatement ( `` BUFFER framebuffer command '' ) ; } -Result Parser : :ParseBufferInitializer ( Buffer* buffer ) { +Result Parser : :ParseBufferInitializer ( DataBuffer* buffer ) { auto token = tokenizer_- > NextToken ( )
diff -- git a/.travis.yml b/.travis.yml index da09272..f962711 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -7,8 +7,8 @ @ android : components : - platform-tools - tools - - build-tools-23.0.3 - - android-23 + - build-tools-26.0.0 + - android-26 - extra-android-support - extra-android-m2repository licenses : diff -- git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties index 919bdd7..c71f03e 100644 -- - a/gradle/wrapper/gradle-wrapper.properties +++ b/gradle/wrapper/gradle-wrapper.properties @ @ -3,4 +3,4 @ @ distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists zipStoreBase=GRADLE_USER_HOME zipStorePath=wrapper/dists -distributionUrl=https\ : //services.gradle.org/distributions/gradle-3.0-all.zip +distributionUrl=https\ : //services.gradle.org/distributions/gradle-4.0-all.zip diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy index 8af2a72..c9b4f40 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy @ @ -37,7 +37,10 @ @ import org.gradle.api.GradleException import org.gradle.api.Plugin import org.gradle.api.Project import org.gradle.api.Task +import org.gradle.api.artifacts.Configuration +import org.gradle.api.attributes.Attribute ; import org.gradle.api.file.ConfigurableFileTree +import org.gradle.api.file.FileCollection import org.gradle.api.internal.file.FileResolver import org.gradle.api.plugins.AppliedPlugin import org.gradle.api.tasks.SourceSet @ @ -241,9 +244,26 @ @ class ProtobufPlugin implements Plugin < Project > { sourceSetNames.each { sourceSetName - > def extractProtosTask = maybeAddExtractProtosTask ( sourceSetName ) generateProtoTask.dependsOn ( extractProtosTask ) + } - def extractIncludeProtosTask = maybeAddExtractIncludeProtosTask ( sourceSetName ) + if ( variant.hasProperty ( `` compileConfiguration '' ) ) { + // For Android Gradle plugin > = 2.5 + def artifactType = Attribute.of ( `` artifactType '' , String ) + def extractIncludeProtosTask = + maybeAddExtractIncludeProtosTask ( + variant.name , + variant.compileConfiguration.incoming.artifactView
diff -- git a/.travis.yml b/.travis.yml index 59a904c..6a410d2 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -7,8 +7,8 @ @ android : components : - platform-tools - tools - - build-tools-23.0.3 - - android-23 + - build-tools-26.0.0 + - android-26 - extra-android-support - extra-android-m2repository licenses : diff -- git a/build.gradle b/build.gradle index 2735df9..33cd1f1 100644 -- - a/build.gradle +++ b/build.gradle @ @ -167,7 +167,7 @ @ pluginBundle { // Releases must be built on Java 1.7 . Building on Java 1.8 will make the // plugin runnable only on Java 1.8 . // See https : //github.com/grpc/grpc-java/issues/805 -task checkJavaVersion < < { +tasks.create ( `` checkJavaVersion '' ) .doLast { JavaVersion javaVersion = JavaVersion.current ( ) if ( ! javaVersion.isJava7 ( ) ) { throw new GradleException ( @ @ -198,6 +198,10 @ @ if ( System.env.TRAVIS == 'true ' ) { test { testLogging { showStandardStreams = true + exceptionFormat = 'full' + showExceptions true + showCauses true + showStackTraces true } } } diff -- git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties index 919bdd7..c71f03e 100644 -- - a/gradle/wrapper/gradle-wrapper.properties +++ b/gradle/wrapper/gradle-wrapper.properties @ @ -3,4 +3,4 @ @ distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists zipStoreBase=GRADLE_USER_HOME zipStorePath=wrapper/dists -distributionUrl=https\ : //services.gradle.org/distributions/gradle-3.0-all.zip +distributionUrl=https\ : //services.gradle.org/distributions/gradle-4.0-all.zip diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy index 3c41ccb..f122796 100644
diff -- git a/.travis.yml b/.travis.yml index 59a904c..10988c0 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -7,8 +7,8 @ @ android : components : - platform-tools - tools - - build-tools-23.0.3 - - android-23 + - build-tools-26.0.1 + - android-26 - extra-android-support - extra-android-m2repository licenses : @ @ -27,7 +27,7 @ @ script : notifications : email : false -sudo : false +sudo : required before_cache : - rm -f $ HOME/.gradle/caches/modules-2/modules-2.lock diff -- git a/build.gradle b/build.gradle index 2735df9..33cd1f1 100644 -- - a/build.gradle +++ b/build.gradle @ @ -167,7 +167,7 @ @ pluginBundle { // Releases must be built on Java 1.7 . Building on Java 1.8 will make the // plugin runnable only on Java 1.8 . // See https : //github.com/grpc/grpc-java/issues/805 -task checkJavaVersion < < { +tasks.create ( `` checkJavaVersion '' ) .doLast { JavaVersion javaVersion = JavaVersion.current ( ) if ( ! javaVersion.isJava7 ( ) ) { throw new GradleException ( @ @ -198,6 +198,10 @ @ if ( System.env.TRAVIS == 'true ' ) { test { testLogging { showStandardStreams = true + exceptionFormat = 'full' + showExceptions true + showCauses true + showStackTraces true } } } diff -- git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties index 919bdd7..c71f03e 100644 -- - a/gradle/wrapper/gradle-wrapper.properties
diff -- git a/.gitignore b/.gitignore index 622b605..e45a5a3 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ protobuf-gradle-plugin.i* gradle.properties /.idea +out/ diff -- git a/.gitmodules b/.gitmodules new file mode 100644 index 0000000..faa18fb -- - /dev/null +++ b/.gitmodules @ @ -0,0 +1,3 @ @ + [ submodule `` vendor/protobuf '' ] + path = vendor/protobuf + url = https : //github.com/google/protobuf.git diff -- git a/build.gradle b/build.gradle index 4bbe909..2a6c263 100644 -- - a/build.gradle +++ b/build.gradle @ @ -1,4 +1,7 @ @ import org.gradle.api.artifacts.maven.MavenDeployment +import org.gradle.model.internal.core.ModelPath +import org.gradle.model.internal.type.ModelType +import org.gradle.platform.base.ComponentSpecContainer println `` '' '' \ Welcome to Gradle $ gradle.gradleVersion - http : //www.gradle.org @ @ -9,6 +12,11 @ @ Base directory : $ projectDir Running script $ { relativePath ( buildFile ) } `` '' '' +if ( file ( `` vendor/protobuf '' ) .list ( ) .length == 0 ) { + throw new GradleException ( + `` You forgot to sync the submodule for protobuf . Please execute \ '' git submodule init & & git submodule update\ '' . '' ) + } + apply plugin : 'idea' apply plugin : 'eclipse' apply plugin : 'groovy' @ @ -61,16 +69,46 @ @ repositories { mavenCentral ( )
diff -- git a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy index 327bba2..4eebb4d 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy @ @ -31,6 +31,7 @ @ package com.google.protobuf.gradle import com.google.common.base.Preconditions import com.google.common.collect.ImmutableList +import com.google.common.primitives.Ints import org.gradle.api.DefaultTask import org.gradle.api.GradleException @ @ -46,6 +47,8 @ @ import org.gradle.util.ConfigureUtil */ // TODO ( zhangkun83 ) : add per-plugin output dir reconfiguraiton . public class GenerateProtoTask extends DefaultTask { + private static final int VISTA_CMD_LENGTH_LIMIT = 8191 + private static final int XP_CMD_LENGTH_LIMIT = 2047 private final List includeDirs = [ ] private final NamedDomainObjectContainer < PluginOptions > builtins @ @ -372,13 +375,13 @ @ public class GenerateProtoTask extends DefaultTask { List < String > dirs = includeDirs*.path.collect { `` -I $ { it } '' } logger.debug `` ProtobufCompile using directories $ { dirs } '' logger.debug `` ProtobufCompile using files $ { protoFiles } '' - List < String > cmd = [ tools.protoc.path ] - cmd.addAll ( dirs ) + List < String > baseCmd = [ tools.protoc.path ] + baseCmd.addAll ( dirs ) // Handle code generation built-ins builtins.each { builtin - > String outPrefix = makeOptionsPrefix ( builtin.options ) - cmd += `` -- $ { builtin.name } _out= $ { outPrefix } $ { getOutputDir
diff -- git a/.travis.yml b/.travis.yml index da09272..f962711 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -7,8 +7,8 @ @ android : components : - platform-tools - tools - - build-tools-23.0.3 - - android-23 + - build-tools-26.0.0 + - android-26 - extra-android-support - extra-android-m2repository licenses : diff -- git a/build.gradle b/build.gradle index 6cddded..fc4eef3 100644 -- - a/build.gradle +++ b/build.gradle @ @ -193,6 +193,10 @ @ if ( System.env.TRAVIS == 'true ' ) { test { testLogging { showStandardStreams = true + exceptionFormat = 'full' + showExceptions true + showCauses true + showStackTraces true } } } diff -- git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties index 919bdd7..c71f03e 100644 -- - a/gradle/wrapper/gradle-wrapper.properties +++ b/gradle/wrapper/gradle-wrapper.properties @ @ -3,4 +3,4 @ @ distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists zipStoreBase=GRADLE_USER_HOME zipStorePath=wrapper/dists -distributionUrl=https\ : //services.gradle.org/distributions/gradle-3.0-all.zip +distributionUrl=https\ : //services.gradle.org/distributions/gradle-4.0-all.zip diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy index 8af2a72..c9b4f40 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy @ @ -37,7 +37,10 @ @ import org.gradle.api.GradleException import org.gradle.api.Plugin import org.gradle.api.Project import org.gradle.api.Task +import org.gradle.api.artifacts.Configuration +import org.gradle.api.attributes.Attribute ; import org.gradle.api.file.ConfigurableFileTree +import org.gradle.api.file.FileCollection import org.gradle.api.internal.file.FileResolver import org.gradle.api.plugins.AppliedPlugin import org.gradle.api.tasks.SourceSet @ @ -241,9 +244,26 @ @ class ProtobufPlugin implements Plugin < Project > { sourceSetNames.each { sourceSetName - > def extractProtosTask = maybeAddExtractProtosTask ( sourceSetName ) generateProtoTask.dependsOn ( extractProtosTask ) + } - def
diff -- git a/.travis.yml b/.travis.yml index 59a904c..6a410d2 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -7,8 +7,8 @ @ android : components : - platform-tools - tools - - build-tools-23.0.3 - - android-23 + - build-tools-26.0.0 + - android-26 - extra-android-support - extra-android-m2repository licenses : diff -- git a/build.gradle b/build.gradle index 2735df9..17b4d35 100644 -- - a/build.gradle +++ b/build.gradle @ @ -198,6 +198,10 @ @ if ( System.env.TRAVIS == 'true ' ) { test { testLogging { showStandardStreams = true + exceptionFormat = 'full' + showExceptions true + showCauses true + showStackTraces true } } } diff -- git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties index 919bdd7..c71f03e 100644 -- - a/gradle/wrapper/gradle-wrapper.properties +++ b/gradle/wrapper/gradle-wrapper.properties @ @ -3,4 +3,4 @ @ distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists zipStoreBase=GRADLE_USER_HOME zipStorePath=wrapper/dists -distributionUrl=https\ : //services.gradle.org/distributions/gradle-3.0-all.zip +distributionUrl=https\ : //services.gradle.org/distributions/gradle-4.0-all.zip diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy index 3c41ccb..f122796 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy @ @ -37,7 +37,10 @ @ import org.gradle.api.GradleException import org.gradle.api.Plugin import org.gradle.api.Project import org.gradle.api.Task +import org.gradle.api.artifacts.Configuration +import org.gradle.api.attributes.Attribute ; import org.gradle.api.file.ConfigurableFileTree +import org.gradle.api.file.FileCollection import org.gradle.api.internal.file.FileResolver import org.gradle.api.plugins.AppliedPlugin import org.gradle.api.tasks.SourceSet @ @ -242,9 +245,26 @ @ class ProtobufPlugin implements Plugin < Project > { sourceSetNames.each { sourceSetName - > Task extractProtosTask = maybeAddExtractProtosTask ( sourceSetName ) generateProtoTask.dependsOn ( extractProtosTask ) + } - Task
diff -- git a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy index 45951dd..56e03e5 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy @ @ -202,8 +202,7 @ @ public class GenerateProtoTask extends DefaultTask { throw new IllegalStateException ( `` requested descriptor path but descriptor generation is off '' ) } - return descriptorSetOptions.path ! = null - ? descriptorSetOptions.path : `` $ { outputBaseDir } /descriptor_set.desc '' + return descriptorSetOptions.path ! = null ? descriptorSetOptions.path : `` $ { outputBaseDir } /descriptor_set.desc '' } public GenerateProtoTask ( ) { diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy index bbc5049..0145bcb 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy @ @ -44,6 +44,8 @ @ public class ProtobufConfigurator { private final ToolsLocator tools private final ArrayList < Closure > taskConfigClosures + final FileResolver fileResolver + /** * The base directory of generated files . The default is * `` $ { project.buildDir } /generated/source/proto '' . @ @ -52,6 +54,7 @ @ public class ProtobufConfigurator { public ProtobufConfigurator ( Project project , FileResolver fileResolver ) { this.project = project + this.fileResolver = fileResolver if ( Utils.isAndroidProject ( project ) ) { tasks = new AndroidGenerateProtoTaskCollection ( ) } else { diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy deleted file mode 100644 index c6e02e3..0000000 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy +++ /dev/null
diff -- git a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy index 45951dd..56e03e5 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy @ @ -202,8 +202,7 @ @ public class GenerateProtoTask extends DefaultTask { throw new IllegalStateException ( `` requested descriptor path but descriptor generation is off '' ) } - return descriptorSetOptions.path ! = null - ? descriptorSetOptions.path : `` $ { outputBaseDir } /descriptor_set.desc '' + return descriptorSetOptions.path ! = null ? descriptorSetOptions.path : `` $ { outputBaseDir } /descriptor_set.desc '' } public GenerateProtoTask ( ) { diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy index bbc5049..0145bcb 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy @ @ -44,6 +44,8 @ @ public class ProtobufConfigurator { private final ToolsLocator tools private final ArrayList < Closure > taskConfigClosures + final FileResolver fileResolver + /** * The base directory of generated files . The default is * `` $ { project.buildDir } /generated/source/proto '' . @ @ -52,6 +54,7 @ @ public class ProtobufConfigurator { public ProtobufConfigurator ( Project project , FileResolver fileResolver ) { this.project = project + this.fileResolver = fileResolver if ( Utils.isAndroidProject ( project ) ) { tasks = new AndroidGenerateProtoTaskCollection ( ) } else { diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy deleted file mode 100644 index c6e02e3..0000000 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy +++ /dev/null
diff -- git a/build.gradle b/build.gradle index 2391847..42e6095 100644 -- - a/build.gradle +++ b/build.gradle @ @ -41,33 +41,35 @ @ buildscript { } } -subprojects { - buildscript { - repositories { - jcenter ( ) - mavenLocal ( ) - } - dependencies { - classpath `` com.google.protobuf : protobuf-gradle-plugin : $ { rootProject.version } '' - } - } - repositories { - mavenCentral ( ) - jcenter ( ) - } - } - repositories { mavenLocal ( ) mavenCentral ( ) } +// Write the plugin 's classpath to a file to share with the tests +task createClasspathManifest { + def outputDir = file ( `` $ buildDir/ $ name '' ) + + inputs.files sourceSets.main.runtimeClasspath + outputs.dir outputDir + + doLast { + outputDir.mkdirs ( ) + file ( `` $ outputDir/plugin-classpath.txt '' ) .text = sourceSets.main.runtimeClasspath.join ( `` \n '' ) + } + } + dependencies { compile gradleApi ( ) - testCompile group : 'junit ' , name : 'junit ' , version : '4.8.1' - compile localGroovy ( ) + compile 'org.codehaus.groovy : groovy-all:2.4.4' compile 'com.google.gradle : osdetector-gradle-plugin:1.2.1' compile 'commons-lang : commons-lang:2.6' + testCompile gradleTestKit ( ) + testCompile 'org.spockframework : spock-core:1.0-groovy-2.4'
diff -- git a/docs/conf.py b/docs/conf.py index d092091..2e12371 100644 -- - a/docs/conf.py +++ b/docs/conf.py @ @ -31,6 +31,7 @ @ # extensions coming with Sphinx ( named 'sphinx.ext . * ' ) or your custom # ones . extensions = [ 'sphinx.ext.autodoc ' , + 'sphinx.ext.napoleon ' , 'sphinx.ext.todo ' , 'sphinx.ext.viewcode ' ] @ @ -78,7 +79,7 @ @ language = 'en' # List of patterns , relative to source directory , that match files and # directories to ignore when looking for source files . # This patterns also effect to html_static_path and html_extra_path -exclude_patterns = [ '_build ' , 'Thumbs.db ' , '.DS_Store ' ] +exclude_patterns = [ '_build ' , 'Thumbs.db ' , '.DS_Store ' , 'tutorial.md ' ] # The name of the Pygments ( syntax highlighting ) style to use . pygments_style = 'sphinx' @ @ -103,7 +104,7 @ @ html_theme = 'alabaster' # Add any paths that contain custom static files ( such as style sheets ) here , # relative to this directory . They are copied after the builtin static files , # so a file named `` default.css '' will overwrite the builtin `` default.css '' . -html_static_path = [ '_static
diff -- git a/mobly/controllers/android_device_lib/snippet_client.py b/mobly/controllers/android_device_lib/snippet_client.py index 4eb15e8..64fc21e 100644 -- - a/mobly/controllers/android_device_lib/snippet_client.py +++ b/mobly/controllers/android_device_lib/snippet_client.py @ @ -1,11 +1,11 @ @ # Copyright 2016 Google Inc. - # + # # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; # you may not use this file except in compliance with the License . # You may obtain a copy of the License at - # + # # http : //www.apache.org/licenses/LICENSE-2.0 - # + # # Unless required by applicable law or agreed to in writing , software # distributed under the License is distributed on an `` AS IS '' BASIS , # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . @ @ -185,7 +185,8 @ @ class SnippetClient ( jsonrpc_client_base.JsonRpcClientBase ) : def _connect_to_v0 ( self ) : self.device_port = self.host_port self._adb.forward ( - [ 'tcp : % d ' % self.host_port , 'tcp : % d ' % self.device_port ] ) + [ 'tcp : % d ' % self.host_port , + 'tcp : % d ' % self.device_port ] ) start_time = time.time ( ) expiration_time = start_time + _APP_START_WAIT_TIME_V0 while time.time ( ) < expiration_time
diff -- git a/mobly/controllers/android_device_lib/snippet_client.py b/mobly/controllers/android_device_lib/snippet_client.py index 3d85e40..f11a5bd 100644 -- - a/mobly/controllers/android_device_lib/snippet_client.py +++ b/mobly/controllers/android_device_lib/snippet_client.py @ @ -24,15 +24,27 @ @ _INSTRUMENTATION_RUNNER_PACKAGE = ( 'com.google.android.mobly.snippet.SnippetRunner ' ) # TODO ( adorokhine ) : delete this in Mobly 1.6 when snippet v0 support is removed . -_LAUNCH_CMD_V0 = ( 'am instrument -w -e action start -e port % s % s/ ' + +_LAUNCH_CMD_V0 = ( ' % s am instrument -w -e action start -e port % s % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) _LAUNCH_CMD_V1 = ( - 'am instrument -w -e action start % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) + ' % s am instrument -w -e action start % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) _STOP_CMD = ( 'am instrument -w -e action stop % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) + # Test that uses UiAutomation requires the shell session to be maintained while + # test is in progress . However , this requirement does not hold for the test that + # deals with device USB disconnection ( Once device disconnects , the shell + # session that started the instrument ends , and UiAutomation fails with error : + # `` UiAutomation not connected '' ) . To
diff -- git a/mobly/controllers/android_device_lib/snippet_client.py b/mobly/controllers/android_device_lib/snippet_client.py index 3d85e40..f7f473b 100644 -- - a/mobly/controllers/android_device_lib/snippet_client.py +++ b/mobly/controllers/android_device_lib/snippet_client.py @ @ -24,15 +24,27 @ @ _INSTRUMENTATION_RUNNER_PACKAGE = ( 'com.google.android.mobly.snippet.SnippetRunner ' ) # TODO ( adorokhine ) : delete this in Mobly 1.6 when snippet v0 support is removed . -_LAUNCH_CMD_V0 = ( 'am instrument -w -e action start -e port % s % s/ ' + +_LAUNCH_CMD_V0 = ( ' % s am instrument -w -e action start -e port % s % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) _LAUNCH_CMD_V1 = ( - 'am instrument -w -e action start % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) + ' % s am instrument -w -e action start % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) _STOP_CMD = ( 'am instrument -w -e action stop % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) + # Test that uses UiAutomation requires the shell session to be maintained while + # test is in progress . However , this requirement does not hold for the test that + # deals with device USB disconnection ( Once device disconnects , the shell + # session that started the instrument ends , and UiAutomation fails with error : + # `` UiAutomation not connected '' ) . To
diff -- git a/mobly/base_test.py b/mobly/base_test.py index 7353afd..ece150a 100644 -- - a/mobly/base_test.py +++ b/mobly/base_test.py @ @ -87,6 +87,7 @ @ class BaseTestClass ( object ) : self.user_params = configs.user_params self.register_controller = configs.register_controller self.results = records.TestResult ( ) + self.summary_writer = configs.summary_writer self.current_test_name = None self._generated_test_table = collections.OrderedDict ( ) @ @ -383,6 +384,8 @ @ class BaseTestClass ( object ) : elif tr_record.result == records.TestResultEnums.TEST_RESULT_SKIP : self._exec_procedure_func ( self._on_skip , tr_record ) self.results.add_record ( tr_record ) + self.summary_writer.dump ( tr_record.to_dict ( ) , + records.TestSummaryEntryType.RECORD ) def _assert_function_name_in_stack ( self , expected_func_name ) : `` '' '' Asserts that the current stack contains the given function name . '' '' '' @ @ -504,6 +507,8 @ @ class BaseTestClass ( object ) : test_record = records.TestResultRecord ( test_name , self.TAG ) test_record.test_skip ( exception ) self.results.add_record ( test_record ) + self.summary_writer.dump ( test_record.to_dict ( ) , + records.TestSummaryEntryType.RECORD ) def run ( self , test_names=None ) : `` '' '' Runs tests within a test class . @ @ -534,6 +539,8 @ @ class BaseTestClass ( object ) : class_record.test_begin ( ) class_record.test_error ( e ) self.results.add_class_error ( class_record ) + self.summary_writer.dump ( class_record.to_dict ( ) , + records.TestSummaryEntryType.RECORD ) return
diff -- git a/mobly/base_test.py b/mobly/base_test.py index 7353afd..ece150a 100644 -- - a/mobly/base_test.py +++ b/mobly/base_test.py @ @ -87,6 +87,7 @ @ class BaseTestClass ( object ) : self.user_params = configs.user_params self.register_controller = configs.register_controller self.results = records.TestResult ( ) + self.summary_writer = configs.summary_writer self.current_test_name = None self._generated_test_table = collections.OrderedDict ( ) @ @ -383,6 +384,8 @ @ class BaseTestClass ( object ) : elif tr_record.result == records.TestResultEnums.TEST_RESULT_SKIP : self._exec_procedure_func ( self._on_skip , tr_record ) self.results.add_record ( tr_record ) + self.summary_writer.dump ( tr_record.to_dict ( ) , + records.TestSummaryEntryType.RECORD ) def _assert_function_name_in_stack ( self , expected_func_name ) : `` '' '' Asserts that the current stack contains the given function name . '' '' '' @ @ -504,6 +507,8 @ @ class BaseTestClass ( object ) : test_record = records.TestResultRecord ( test_name , self.TAG ) test_record.test_skip ( exception ) self.results.add_record ( test_record ) + self.summary_writer.dump ( test_record.to_dict ( ) , + records.TestSummaryEntryType.RECORD ) def run ( self , test_names=None ) : `` '' '' Runs tests within a test class . @ @ -534,6 +539,8 @ @ class BaseTestClass ( object ) : class_record.test_begin ( ) class_record.test_error ( e ) self.results.add_class_error ( class_record ) + self.summary_writer.dump ( class_record.to_dict ( ) , + records.TestSummaryEntryType.RECORD ) return
diff -- git a/README.md b/README.md index f606ce5..16bb283 100644 -- - a/README.md +++ b/README.md @ @ -103,6 +103,7 @ @ class HelloWorldTest ( base_test.BaseTestClass ) : # object is created from this . self.ads = self.register_controller ( android_device ) self.dut = self.ads [ 0 ] + self.dut.load_sl4a ( ) # starts sl4a . def test_hello ( self ) : self.dut.sl4a.makeToast ( 'Hello World ! ' ) @ @ -147,6 +148,7 @ @ class HelloWorldTest ( base_test.BaseTestClass ) : def setup_class ( self ) : self.ads = self.register_controller ( android_device ) self.dut = self.ads [ 0 ] + self.dut.load_sl4a ( ) def test_hello ( self ) : self.dut.sl4a.makeToast ( 'Hello World ! ' ) @ @ -282,7 +284,9 @ @ class HelloWorldTest ( base_test.BaseTestClass ) : # requires at least two Android devices . self.ads = self.register_controller ( android_device , min_number=2 ) self.dut = android_device.get_device ( self.ads , label= '' dut '' ) + self.dut.load_sl4a ( ) self.discoverer = android_device.get_device ( self.ads , label= '' discoverer '' ) + self.discoverer.load_sl4a ( ) self.dut.ed.clear_all_events ( ) self.discoverer.ed.clear_all_events ( ) diff -- git a/docs/tutorials/lesson1.md b/docs/tutorials/lesson1.md index 3c93107..490ce40 100644 -- - a/docs/tutorials/lesson1.md +++ b/docs/tutorials/lesson1.md @ @ -40,6 +40,7 @ @ class HelloWorldTest ( base_test.BaseTestClass )
diff -- git a/mobly/asserts.py b/mobly/asserts.py index 9d1a6f2..ae119e5 100644 -- - a/mobly/asserts.py +++ b/mobly/asserts.py @ @ -31,13 +31,14 @ @ _pyunit_proxy = _ProxyTest ( ) def assert_equal ( first , second , msg=None , extras=None ) : - `` '' '' Assert an expression evaluates to true , otherwise fail the test . + `` '' '' Assert the equality of objects , otherwise fail the test . Error message is `` first ! = second '' by default . Additional explanation can be supplied in the message . Args : - expr : The expression that is evaluated . + first : The first object to compare . + second : The second object to compare . msg : A string that adds additional info about the failure . extras : An optional field for extra information to be included in test result . @ @ -98,9 +99,8 @ @ def assert_raises_regex ( expected_exception , extras : An optional field for extra information to be included in test result. `` '' '' - context = _AssertRaisesContext ( expected_exception , - expected_regex , - extras=extras ) + context = _AssertRaisesContext ( + expected_exception , expected_regex , extras=extras ) return context @
diff -- git a/mobly/base_instrumentation_test.py b/mobly/base_instrumentation_test.py index bb72075..32258ca 100644 -- - a/mobly/base_instrumentation_test.py +++ b/mobly/base_instrumentation_test.py @ @ -19,6 +19,7 @ @ from enum import Enum from mobly import base_test from mobly import records from mobly import signals +from mobly import utils class _InstrumentationStructurePrefixes ( object ) : @ @ -280,6 +281,8 @ @ class _InstrumentationBlock ( object ) : needs to be done for those . Attributes : + begin_time : string , optional timestamp for when the test corresponding + to the instrumentation block began . current_key : string , the current key that is being parsed , default to _InstrumentationKnownStatusKeys.STREAM . error_message : string , an error message indicating that something @ @ -302,6 +305,10 @ @ class _InstrumentationBlock ( object ) : self.state = state self.prefix = prefix self.previous_instrumentation_block = previous_instrumentation_block + if previous_instrumentation_block : + # The parser never needs lookback for two previous blocks , + # so unset to allow previous blocks to get garbage collected . + previous_instrumentation_block.previous_instrumentation_block = None self._empty = True self.error_message = `` @ @ -319,6 +326,8 @ @ class _InstrumentationBlock ( object ) : } self.unknown_keys = defaultdict ( list ) + self.begin_time = None + @ property def is_empty (
diff -- git a/mobly/base_test.py b/mobly/base_test.py index ddd1e11..3128b77 100644 -- - a/mobly/base_test.py +++ b/mobly/base_test.py @ @ -217,10 +217,12 @ @ class BaseTestClass ( object ) : called . Args : - record : The records.TestResultRecord object for the failed test . + record : records.TestResultRecord , a copy of the test record for + this test , containing all information of the test execution + including exception objects. `` '' '' logging.info ( RESULT_LINE_TEMPLATE , record.test_name , record.result ) - self.on_fail ( copy.deepcopy ( record ) ) + self.on_fail ( record ) def on_fail ( self , record ) : `` '' '' A function that is executed upon a test failure . @ @ -228,9 +230,9 @ @ class BaseTestClass ( object ) : User implementation is optional . Args : - record : records.TestResultRecord , the test record for this test , - containing all information of the test execution including - exception objects . + record : records.TestResultRecord , a copy of the test record for + this test , containing all information of the test execution + including exception objects. `` '' '' def _on_pass ( self , record ) : @ @ -238,13 +240,15 @ @
diff -- git a/tests/mobly/controllers/monsoon_test.py b/tests/mobly/controllers/monsoon_test.py index a726049..c8b6eeb 100755 -- - a/tests/mobly/controllers/monsoon_test.py +++ b/tests/mobly/controllers/monsoon_test.py @ @ -12,12 +12,16 @ @ # See the License for the specific language governing permissions and # limitations under the License . +import platform + from future.tests.base import unittest class MonsoonTest ( unittest.TestCase ) : - + @ unittest.skipIf ( platform.system ( ) == 'Windows ' , + 'fcntl does not exist on Windows ' ) def test_monsoon_import ( self ) : + # TODO : Replace 'fnctl ' with a Windows equivalent when on Windows from mobly.controllers import monsoon diff -- git a/tests/mobly/output_test.py b/tests/mobly/output_test.py index 9655f4c..ff5cae8 100755 -- - a/tests/mobly/output_test.py +++ b/tests/mobly/output_test.py @ @ -15,6 +15,7 @ @ import logging import mock import os +import platform import shutil import tempfile import unittest @ @ -28,6 +29,10 @ @ from tests.lib import mock_controller from tests.lib import integration_test from tests.lib import teardown_class_failure_test +if platform.system ( ) == 'Windows ' : + import win32file + from win32com import client + class OutputTest ( unittest.TestCase ) : `` '' '' This test class has unit tests for the implementation of Mobly 's output @ @ -87,6 +92,39 @ @ class OutputTest ( unittest.TestCase ) : for item in blacklist
diff -- git a/docs/conf.py b/docs/conf.py index d092091..2e12371 100644 -- - a/docs/conf.py +++ b/docs/conf.py @ @ -31,6 +31,7 @ @ # extensions coming with Sphinx ( named 'sphinx.ext . * ' ) or your custom # ones . extensions = [ 'sphinx.ext.autodoc ' , + 'sphinx.ext.napoleon ' , 'sphinx.ext.todo ' , 'sphinx.ext.viewcode ' ] @ @ -78,7 +79,7 @ @ language = 'en' # List of patterns , relative to source directory , that match files and # directories to ignore when looking for source files . # This patterns also effect to html_static_path and html_extra_path -exclude_patterns = [ '_build ' , 'Thumbs.db ' , '.DS_Store ' ] +exclude_patterns = [ '_build ' , 'Thumbs.db ' , '.DS_Store ' , 'tutorial.md ' ] # The name of the Pygments ( syntax highlighting ) style to use . pygments_style = 'sphinx' @ @ -103,7 +104,7 @ @ html_theme = 'alabaster' # Add any paths that contain custom static files ( such as style sheets ) here , # relative to this directory . They are copied after the builtin static files , # so a file named `` default.css '' will overwrite the builtin `` default.css '' . -html_static_path = [ '_static
diff -- git a/mobly/utils.py b/mobly/utils.py index efe2c0f..ba47c60 100644 -- - a/mobly/utils.py +++ b/mobly/utils.py @ @ -21,6 +21,7 @ @ import functools import logging import os import platform +import psutil import random import signal import socket @ @ -340,9 +341,8 @ @ def start_standing_subprocess ( cmd , check_health_delay=0 ) : cmd , stdout=subprocess.PIPE , stderr=subprocess.PIPE , - shell=True , - preexec_fn=os.setpgrp ) - logging.debug ( `` Start standing subprocess with cmd : % s '' , cmd ) + shell=True ) + logging.debug ( 'Start standing subprocess with cmd : % s ' , cmd ) if check_health_delay > 0 : time.sleep ( check_health_delay ) _assert_subprocess_running ( proc ) @ @ -359,14 +359,28 @ @ def stop_standing_subprocess ( proc , kill_signal=signal.SIGTERM ) : Args : proc : Subprocess to terminate . + + Throws : + Error : if the subprocess could not be stopped. `` '' '' pid = proc.pid - logging.debug ( `` Stop standing subprocess % d '' , pid ) + logging.debug ( 'Stop standing subprocess % d ' , pid ) _assert_subprocess_running ( proc ) + process = psutil.Process ( pid ) + success = True + for child in process.children ( recursive=True ) : +
diff -- git a/mobly/controllers/android_device.py b/mobly/controllers/android_device.py index 3af1040..e2b4113 100644 -- - a/mobly/controllers/android_device.py +++ b/mobly/controllers/android_device.py @ @ -49,6 +49,8 @ @ KEY_DEVICE_REQUIRED = 'required' # Default Timeout to wait for USB ON DEFAULT_TIMEOUT_USB_ON = 5 * 60 +DEFAULT_TIMEOUT_BOOT_COMPLETION = 15 * 60 + class Error ( signals.ControllerError ) : pass @ @ -682,7 +684,7 @ @ class AndroidDevice ( object ) : mode per security restrictions. `` '' '' self.adb.root ( ) - self.adb.wait_for_device ( ) + self.adb.wait_for_device ( timeout=DEFAULT_TIMEOUT_BOOT_COMPLETION ) def load_snippet ( self , name , package ) : `` '' '' Starts the snippet apk with the given package name and connects . @ @ -943,7 +945,6 @ @ class AndroidDevice ( object ) : different a lot from case to case . User should have more knowledge of this value. `` '' '' - timeout_start = time.time ( ) self._wait_for_device ( self._is_adb_detectable , timeout ) def _is_boot_completed ( self ) : @ @ -974,6 +975,9 @ @ class AndroidDevice ( object ) : self._wait_for_device ( self._is_boot_completed , timeout ) To wait for USB reconnect : self._wait_for_device ( self._is_adb_detectable , timeout ) + To wait for USB disconnect : + self._wait_for_device ( lambda : self.adb._is_adb_detectable ( ) : False
diff -- git a/proto-lens-tests/proto-lens-tests.cabal b/proto-lens-tests/proto-lens-tests.cabal index 72f0808..92c38ea 100644 -- - a/proto-lens-tests/proto-lens-tests.cabal +++ b/proto-lens-tests/proto-lens-tests.cabal @ @ -127,6 +127,7 @ @ Test-Suite text_format_test hs-source-dirs : tests build-depends : HUnit , base + , bytestring , lens-family , pretty , proto-lens @ @ -134,6 +135,7 @ @ Test-Suite text_format_test , proto-lens-tests , test-framework , test-framework-hunit + , text Test-Suite enum_test default-language : Haskell2010 diff -- git a/proto-lens-tests/tests/canonical.proto b/proto-lens-tests/tests/canonical.proto index 5134ec9..b3c11b7 100644 -- - a/proto-lens-tests/tests/canonical.proto +++ b/proto-lens-tests/tests/canonical.proto @ @ -19,3 +19,8 @ @ message Test3 { message Test4 { repeated int32 d = 4 [ packed=true ] ; } + +message Test5 { + required bytes e = 1 ; + } + diff -- git a/proto-lens-tests/tests/proto3_test.hs b/proto-lens-tests/tests/proto3_test.hs index f8aa3a0..ef4b2bf 100644 -- - a/proto-lens-tests/tests/proto3_test.hs +++ b/proto-lens-tests/tests/proto3_test.hs @ @ -55,7 +55,7 @ @ main = testMain $ tagged 3 $ Fixed32 0x40d55555 , serializeTo `` bytes '' ( def & d .~ `` a\0b '' : : Foo ) - `` d : \ '' a\\NULb\ '' '' + `` d : \ '' a\\000b\ '' '' $ tagged 4 $ Lengthy `` a\0b '' -- Scalar `` oneof '' fields should have a `` maybe '' selector . , testCase `` maybe '' $
diff -- git a/proto-lens-descriptors/src/Proto/Google/Protobuf/Compiler/Plugin.hs b/proto-lens-descriptors/src/Proto/Google/Protobuf/Compiler/Plugin.hs index 898bf4a..8e5d3fc 100644 -- - a/proto-lens-descriptors/src/Proto/Google/Protobuf/Compiler/Plugin.hs +++ b/proto-lens-descriptors/src/Proto/Google/Protobuf/Compiler/Plugin.hs @ @ -25,22 +25,26 @ @ data CodeGeneratorRequest = CodeGeneratorRequest { _CodeGeneratorRequest'fileToGen ! ( Prelude.Maybe Data.Text.Text ) , _CodeGeneratorRequest'protoFile : : ! [ Proto.Google.Protobuf.Descriptor.FileDescriptorProto ] } - deriving ( Prelude.Show , Prelude.Eq ) + deriving ( Prelude.Show , Prelude.Eq , Prelude.Ord ) instance ( a ~ [ Data.Text.Text ] , b ~ [ Data.Text.Text ] , Prelude.Functor f ) = > Lens.Labels.HasLens `` fileToGenerate '' f CodeGeneratorRequest CodeGeneratorRequest a b where lensOf _ - = Lens.Family2.Unchecked.lens _CodeGeneratorRequest'fileToGenerate - ( \ x__ y__ - > x__ { _CodeGeneratorRequest'fileToGenerate = y__ } ) + = ( Prelude.. ) + ( Lens.Family2.Unchecked.lens _CodeGeneratorRequest'fileToGenerate + ( \ x__ y__ - > x__ { _CodeGeneratorRequest'fileToGenerate = y__ } ) ) + Prelude.id instance ( a ~ Data.Text.Text , b ~ Data.Text.Text , Prelude.Functor f ) = > Lens.Labels.HasLens `` parameter '' f CodeGeneratorRequest CodeGeneratorRequest a b where lensOf _ - = ( Prelude.. ) maybe'parameter + = ( Prelude.. ) + ( Lens.Family2.Unchecked.lens _CodeGeneratorRequest'parameter + ( \ x__ y__ - > x__ { _CodeGeneratorRequest'parameter = y__ } ) ) ( Data.ProtoLens.maybeLens Data.ProtoLens.fieldDefault ) instance ( a ~ Prelude.Maybe Data.Text.Text , @ @
diff -- git a/docs/tutorial.md b/docs/tutorial.md index 1e88a15..2f7d3b2 100644 -- - a/docs/tutorial.md +++ b/docs/tutorial.md @ @ -42,8 +42,9 @ @ Notice ` _Foo'_unknownFields : : ! Data.ProtoLens.FieldSet ` ; it stores fields that Instances generated are : * ` Lens.Labels.HasLens ` and ` Lens.Labels.HasLens ' ` are for overloading field names ( see [ Field Overloading ] ( # field-overloading ) . -* ` Data.Default.Class.Default ` for having [ default message values ] ( https : //developers.google.com/protocol-buffers/docs/proto3 # default ) . -* ` Data.ProtoLens.Message ` for enabling serialization by providing reflection of all of the fields that may be used by this type . +* ` Data.ProtoLens.Message ` for having [ default message values ] and enabling serialization by providing reflection of all of the fields that may be used by this type . + + [ default message values ] : https : //developers.google.com/protocol-buffers/docs/proto3 # default # # Oneof Generation @ @ -102,7 +103,7 @ @ accessBaz foo = foo -- | Creates a 'Foo ' with an incoming 'Int32' createFoo : : Int32 - > Foo -createFoo i = def & maybe'bar .~ ( _Just # _Foo'Baz # i ) +createFoo i = defMessage & maybe'bar .~ ( _Just
diff -- git a/README.md b/README.md index 22a5490..0a4c387 100644 -- - a/README.md +++ b/README.md @ @ -89,7 +89,6 @ @ will generate the haskell files ` Proto/Project/ { Foo , Bar } .hs ` . # Current differences from the standard - Services are not supported . -- ` oneof ` fields are treated the same as ` optional ` fields . - Extensions ( proto2-only ) are not supported . ` Any ` messages ( the proto3 equivalent ) can be used , but do n't have any custom API support like in the C++ libraries . diff -- git a/proto-lens-protoc/src/Data/ProtoLens/Compiler/Combinators.hs b/proto-lens-protoc/src/Data/ProtoLens/Compiler/Combinators.hs index 50c5b7f..459de55 100644 -- - a/proto-lens-protoc/src/Data/ProtoLens/Compiler/Combinators.hs +++ b/proto-lens-protoc/src/Data/ProtoLens/Compiler/Combinators.hs @ @ -54,7 +54,9 @ @ equalP = Syntax.EqualP ( ) type ConDecl = Syntax.ConDecl ( ) conDecl : : Name - > [ Type ] - > ConDecl -conDecl = Syntax.ConDecl ( ) +conDecl constructorName paramTypes + = Syntax.ConDecl ( ) constructorName $ + fmap tyBang paramTypes recDecl : : Name - > [ ( Name , Type ) ] - > ConDecl recDecl dataName fields @ @ -103,6 +105,14 @ @ type Exp = Syntax.Exp ( ) let ' : : [ Decl ] - > Exp -
diff -- git a/proto-lens-tests/proto-lens-tests.cabal b/proto-lens-tests/proto-lens-tests.cabal index 72f0808..92c38ea 100644 -- - a/proto-lens-tests/proto-lens-tests.cabal +++ b/proto-lens-tests/proto-lens-tests.cabal @ @ -127,6 +127,7 @ @ Test-Suite text_format_test hs-source-dirs : tests build-depends : HUnit , base + , bytestring , lens-family , pretty , proto-lens @ @ -134,6 +135,7 @ @ Test-Suite text_format_test , proto-lens-tests , test-framework , test-framework-hunit + , text Test-Suite enum_test default-language : Haskell2010 diff -- git a/proto-lens-tests/tests/canonical.proto b/proto-lens-tests/tests/canonical.proto index 5134ec9..b3c11b7 100644 -- - a/proto-lens-tests/tests/canonical.proto +++ b/proto-lens-tests/tests/canonical.proto @ @ -19,3 +19,8 @ @ message Test3 { message Test4 { repeated int32 d = 4 [ packed=true ] ; } + +message Test5 { + required bytes e = 1 ; + } + diff -- git a/proto-lens-tests/tests/text_format_test.hs b/proto-lens-tests/tests/text_format_test.hs index 2a0af78..4ff1175 100644 -- - a/proto-lens-tests/tests/text_format_test.hs +++ b/proto-lens-tests/tests/text_format_test.hs @ @ -7,6 +7,11 @ @ { - # LANGUAGE OverloadedStrings # - } module Main where +import qualified Data.ByteString +import Data.Char ( ord ) +import Data.Monoid ( ( < > ) ) +import qualified Data.Text.Lazy +import Data.Word ( Word8 ) import Data.ProtoLens ( def , Message , showMessage , showMessageShort , pprintMessage ) import Lens.Family2 ( ( & ) , ( .~ ) ) @ @ -29,6 +34,9 @ @ def3 = def def4 : : Test4
diff -- git a/index.js b/index.js index 57e25f8..1dca881 100755 -- - a/index.js +++ b/index.js @ @ -256,8 +256,8 @ @ function getAPICredentials ( cb ) { */ function getFileType ( type ) { return { - SERVER_JS : 'gs ' , - SHARED_JS : 'gs' + SERVER_JS : 'js ' , + SHARED_JS : 'js' } [ type ] || type.toLowerCase ( ) ; } @ @ -270,6 +270,7 @ @ function getAPIFileType ( path ) { let extension = path.substr ( path.lastIndexOf ( ' . ' ) + 1 ) .toUpperCase ( ) ; return { GS : 'SERVER_JS ' , + JS : 'SERVER_JS ' , HTML : 'HTML ' , JSON : 'JSON' } [ extension ] ;
diff -- git a/index.js b/index.js index d51703e..57e25f8 100755 -- - a/index.js +++ b/index.js @ @ -140,7 +140,7 @ @ const LOG = { UNTITLED_SCRIPT_TITLE : 'Untitled Script ' , VERSION_CREATE : 'Creating a new version ... ' , VERSION_CREATED : ( versionNumber ) = > ` Created version $ { versionNumber } . ` , - VERSION_DESCRIPTION : ( { versionNumber , description } ) = > ` $ { versionNumber } - $ { description || ' ( no description ) ' } ` , + VERSION_DESCRIPTION : ( { versionNumber , description } ) = > ` $ { versionNumber } - $ { description || ' ( no description ) ' } ` , VERSION_NUM : ( numVersions ) = > ` ~ $ { numVersions } $ { pluralize ( 'Version ' , numVersions ) } ~ ` , } ; @ @ -153,6 +153,7 @ @ Forgot $ { PROJECT_NAME } commands ? Get help : \n $ { PROJECT_NAME } -- help ` , DEPLOYMENT_COUNT : ` Unable to deploy ; Only one deployment can be created at a time ` , FOLDER_EXISTS : ` Project file ( $ { DOT.PROJECT.PATH } ) already
diff -- git a/tsconfig.json b/tsconfig.json index 626c240..af22ff8 100644 -- - a/tsconfig.json +++ b/tsconfig.json @ @ -7,7 +7,8 @ @ `` es5 '' , `` es6 '' , `` es2017 '' - ] + ] , + `` strict '' : true , } , `` moduleResolution '' : `` node '' , `` files '' : [
diff -- git a/.gitignore b/.gitignore deleted file mode 100644 index 1fb7c62..0000000 -- - a/.gitignore +++ /dev/null @ @ -1,11 +0,0 @ @ -*~ -*.sw [ o-p ] -.DS_Store -xcuserdata -*.gem -fishhook/ -OCHamcrest.framework -Tests/UnitTests/ocmock/ -Tests/UnitTests/UnitTests.xcodeproj/project.xcworkspace/ -Tests/FunctionalTests/FunctionalTests.xcodeproj/project.xcworkspace/ -gem/spec/fixtures/tmpdir/ diff -- git a/.gitmodules b/.gitmodules new file mode 100644 index 0000000..eeddad7 -- - /dev/null +++ b/.gitmodules @ @ -0,0 +1,6 @ @ + [ submodule `` eDistantObject '' ] + path = eDistantObject + url = https : //github.com/google/eDistantObject + [ submodule `` fishhook '' ] + path = fishhook + url = https : //github.com/facebook/fishhook diff -- git a/.jazzy.yaml b/.jazzy.yaml deleted file mode 100644 index e70e35f..0000000 -- - a/.jazzy.yaml +++ /dev/null @ @ -1,23 +0,0 @ @ - # Copyright 2016 Google Inc. - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - # you may not use this file except in compliance with the License . - # You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software - # distributed under the License is distributed on an `` AS
diff -- git a/EarlGrey/Common/GREYAppleInternals.h b/EarlGrey/Common/GREYAppleInternals.h index 13e8dfa..5a9c191 100644 -- - a/EarlGrey/Common/GREYAppleInternals.h +++ b/EarlGrey/Common/GREYAppleInternals.h @ @ -146,6 +146,17 @ @ IOHIDEventRef IOHIDEventCreateDigitizerFingerEvent ( CFAllocatorRef allocator , * UITouch objects , and the relevant touch interaction state . */ - ( UITouchesEvent * ) _touchesEvent ; + +/** + * Sends a motion began event for the specified subtype . + */ +- ( void ) _sendMotionBegan : ( UIEventSubtype ) subtype ; + +/** + * Sends a motion ended event for the specified subtype . + */ +- ( void ) _sendMotionEnded : ( UIEventSubtype ) subtype ; + @ end @ interface UIScrollView ( GREYExposed ) diff -- git a/EarlGrey/Core/EarlGreyImpl.h b/EarlGrey/Core/EarlGreyImpl.h index 031fc13..dbf8e99 100644 -- - a/EarlGrey/Core/EarlGreyImpl.h +++ b/EarlGrey/Core/EarlGreyImpl.h @ @ -134,8 +134,8 @ @ typedef NS_ENUM ( NSInteger , GREYKeyboardDismissalErrorCode ) { * will be registered . * * @ param deviceOrientation The desired orientation of the device . - * @ param [ out ] errorOrNil Error that will be populated on failure . If @ c nil , a test - * failure will be reported if the rotation attempt fails . + * @ param [ out ] errorOrNil Error that will be populated on
diff -- git a/EarlGrey/Common/GREYAppleInternals.h b/EarlGrey/Common/GREYAppleInternals.h index 13e8dfa..5a9c191 100644 -- - a/EarlGrey/Common/GREYAppleInternals.h +++ b/EarlGrey/Common/GREYAppleInternals.h @ @ -146,6 +146,17 @ @ IOHIDEventRef IOHIDEventCreateDigitizerFingerEvent ( CFAllocatorRef allocator , * UITouch objects , and the relevant touch interaction state . */ - ( UITouchesEvent * ) _touchesEvent ; + +/** + * Sends a motion began event for the specified subtype . + */ +- ( void ) _sendMotionBegan : ( UIEventSubtype ) subtype ; + +/** + * Sends a motion ended event for the specified subtype . + */ +- ( void ) _sendMotionEnded : ( UIEventSubtype ) subtype ; + @ end @ interface UIScrollView ( GREYExposed ) diff -- git a/EarlGrey/Core/EarlGreyImpl.h b/EarlGrey/Core/EarlGreyImpl.h index 031fc13..dbf8e99 100644 -- - a/EarlGrey/Core/EarlGreyImpl.h +++ b/EarlGrey/Core/EarlGreyImpl.h @ @ -134,8 +134,8 @ @ typedef NS_ENUM ( NSInteger , GREYKeyboardDismissalErrorCode ) { * will be registered . * * @ param deviceOrientation The desired orientation of the device . - * @ param [ out ] errorOrNil Error that will be populated on failure . If @ c nil , a test - * failure will be reported if the rotation attempt fails . + * @ param [ out ] errorOrNil Error that will be populated on
diff -- git a/gem/Gemfile b/gem/Gemfile index 3384fe1..5532e86 100644 -- - a/gem/Gemfile +++ b/gem/Gemfile @ @ -16,8 +16,3 @ @ source 'https : //rubygems.org' gemspec - -gem 'coveralls ' , require : false -gem 'rspec' -gem 'rubocop' -gem 'thor ' # enable : bundle exec thor spec diff -- git a/gem/Rakefile b/gem/Rakefile index 2003e7b..afee1db 100644 -- - a/gem/Rakefile +++ b/gem/Rakefile @ @ -24,6 +24,7 @ @ require_relative 'support/bump' # Skip tagging the repo on Gem releases because that'll # conflict with EarlGrey carthage tagged releases . raise `` Ca n't find tag_version to patch '' unless Bundler : :GemHelper.instance.method ( : tag_version ) + class Bundler : :GemHelper def tag_version nil diff -- git a/gem/bin/earlgrey b/gem/bin/earlgrey index 6d7b92c..68c1da1 100644 -- - a/gem/bin/earlgrey +++ b/gem/bin/earlgrey @ @ -15,6 +15,6 @ @ # See the License for the specific language governing permissions and # limitations under the License . -require_relative '../lib/earlgrey' +require 'earlgrey/cli' EarlGrey : :CLI.start diff -- git a/gem/earlgrey.gemspec b/gem/earlgrey.gemspec index 550271d..af011f1 100644 -- - a/gem/earlgrey.gemspec +++ b/gem/earlgrey.gemspec @ @ -23,7 +23,7 @ @ Gem : :Specification.new do |s| s.license = 'Apache-2.0' s.summary = 'EarlGrey installer gem' s.description = 'Command line tool for installing EarlGrey into an iOS Unit Testing target' -
diff -- git a/docs/examples.md b/docs/examples.md new file mode 100644 index 0000000..cd5aae3 -- - /dev/null +++ b/docs/examples.md @ @ -0,0 +1,39 @ @ +**Selecting the first match via a custom Swift matcher** + +When an application has exact duplicate elements ( every attribute is the same , +including their hierarchy ) , then the correct fix is to update the app to avoid +duplicating the UI . When that 's not possible , a workaround is to match on +the first element . + + `` ` swift +// Swift Custom Matcher +/* + * Example Usage : + * + * EarlGrey ( ) .selectElementWithMatcher ( grey_allOfMatchers ( + * grey_accessibilityID ( `` some_id '' ) , + * grey_interactable ( ) , + * grey_firstElement ( ) ) ) + * .assertWithMatcher ( grey_notNil ( ) ) + * + * Only intended to be used with selectElementWithMatcher . Don't + * use grey_firstElement in assertWithMatcher as it wo n't do anything . + */ +func grey_firstElement ( ) - > GREYMatcher { + var firstMatch = true + let matches : MatchesBlock = { ( element : AnyObject ! ) - > Bool in + if firstMatch {
diff -- git a/docs/faq.md b/docs/faq.md index 9c11b8c..a5d467b 100644 -- - a/docs/faq.md +++ b/docs/faq.md @ @ -427,3 +427,45 @ @ You need to change kGREYConfigKeyScreenshotDirLocation in GREYConfiguration to c [ [ GREYConfiguration sharedInstance ] setValue : @ '' screenshot_dir_path '' forConfigKey : kGREYConfigKeyScreenshotDirLocation ] ; `` ` + +**How do I run tests against a precompiled app ? ** + +Xcode 8 adds two new commands for building and running tests : + +- ` build-for-testing ` - Generates a xctestrun file for use with ` test-without-building ` . +- ` test-without-building ` - Runs the tests from xctestrun against a precompiled app . + +For more information see ` man xcodebuild.xctestrun ` . The following commands work on [ the EarlGreyExample project . ] ( ../Demo/EarlGreyExample ) + + `` ` bash + $ cd Demo/EarlGreyExample + $ pod install + `` ` + + `` ` bash +xcodebuild \ +-workspace EarlGreyExample.xcworkspace \ +-scheme EarlGreyExampleSwiftTests \ +-destination 'platform=iOS Simulator , name=iPhone 6 , OS=latest ' \ +-derivedDataPath 'xctestrun_dd ' \ +build-for-testing + `` ` + + `` ` bash +xcodebuild \ +-workspace EarlGreyExample.xcworkspace \ +-scheme EarlGreyExampleSwiftTests \ +-destination 'platform=iOS Simulator , name=iPhone 6 , OS=latest ' \ +-derivedDataPath 'xctestrun_dd '
diff -- git a/EarlGrey/Action/GREYActions.h b/EarlGrey/Action/GREYActions.h index 605cbf6..0b0ff75 100644 -- - a/EarlGrey/Action/GREYActions.h +++ b/EarlGrey/Action/GREYActions.h @ @ -31,6 +31,12 @ @ + ( id < GREYAction > ) actionForMultipleTapsWithCount : ( NSUInteger ) count ; /** + * @ return A GREYAction that performs multiple taps of a specified @ c count at a specified + * @ c point . + */ ++ ( id < GREYAction > ) actionForMultipleTapsWithCount : ( NSUInteger ) count atPoint : ( CGPoint ) point ; + +/** * Returns an action that holds down finger for 1.0 second ( @ c kGREYLongPressDefaultDuration ) to * simulate a long press . * @ @ -285,6 +291,12 @ @ /** Shorthand macro for GREYActions : :actionForMultipleTapsWithCount : with count @ c 2 . */ GREY_EXPORT id < GREYAction > grey_doubleTap ( void ) ; +/** + * Shorthand macro for + * GREYActions : :actionForMultipleTapsWithCount : with count @ c 2 and @ c point . + */ +GREY_EXPORT id < GREYAction > grey_doubleTapAtPoint ( CGPoint point ) ; + /** Shorthand macro for GREYActions : :actionForMultipleTapsWithCount : . */ GREY_EXPORT id < GREYAction > grey_multipleTapsWithCount ( NSUInteger count ) ; diff -- git a/EarlGrey/Action/GREYActions.m b/EarlGrey/Action/GREYActions.m
diff -- git a/layers/dhcpv4.go b/layers/dhcpv4.go index 761b201..8106411 100644 -- - a/layers/dhcpv4.go +++ b/layers/dhcpv4.go @ @ -125,6 +125,7 @ @ func ( d *DHCPv4 ) LayerType ( ) gopacket.LayerType { return LayerTypeDHCPv4 } // DecodeFromBytes decodes the given bytes into this layer . func ( d *DHCPv4 ) DecodeFromBytes ( data [ ] byte , df gopacket.DecodeFeedback ) error { + d.Options = d.Options [ :0 ] d.Operation = DHCPOp ( data [ 0 ] ) d.HardwareType = LinkType ( data [ 1 ] ) d.HardwareLen = data [ 2 ]
diff -- git a/afpacket/afpacket.go b/afpacket/afpacket.go index 3acf814..0055497 100644 -- - a/afpacket/afpacket.go +++ b/afpacket/afpacket.go @ @ -116,8 +116,6 @ @ type TPacket struct { offset int // current is the current header . current header - // pollset is used by TPacket for its poll ( ) call . - pollset unix.PollFd // shouldReleasePacket is set to true whenever we return packet data , to make sure we remember to release that data back to the kernel . shouldReleasePacket bool // headerNextNeeded is set to true when header need to move to the next packet . No need to move it case of poll error . @ @ -457,16 +455,19 @ @ func ( h *TPacket ) getTPacketHeader ( ) header { func ( h *TPacket ) pollForFirstPacket ( hdr header ) error { tm : = int ( h.opts.pollTimeout / time.Millisecond ) for hdr.getStatus ( ) & C.TP_STATUS_USER == 0 { - h.pollset.Fd = int32 ( h.fd ) - h.pollset.Events = unix.POLLIN - h.pollset.Revents = 0 - n , err : = unix.Poll ( [ ] unix.PollFd { h.pollset } , tm ) + pollset : = [ ] unix.PollFd { + unix.PollFd { + Fd : int32 ( h.fd
diff -- git a/dhcpv6.go b/dhcpv6.go new file mode 100644 index 0000000..e7d761d -- - /dev/null +++ b/dhcpv6.go @ @ -0,0 +1,572 @ @ +// Copyright 2018 Google , Inc. All rights reserved . +// +// Use of this source code is governed by a BSD-style license +// that can be found in the LICENSE file in the root of the source +// tree . + +package layers + +import ( + '' bytes '' + '' encoding/binary '' + '' errors '' + '' fmt '' + '' net '' + + '' github.com/google/gopacket '' + ) + +// DHCPOp rerprents a bootp operation +type DHCPOp byte + +// bootp operations +const ( + DHCPOpRequest DHCPOp = 1 + DHCPOpReply DHCPOp = 2 + ) + +// String returns a string version of a DHCPOp . +func ( o DHCPOp ) String ( ) string { + switch o { + case DHCPOpRequest : + return `` Request '' + case DHCPOpReply : + return `` Reply '' + default : + return `` Unknown '' + } + } + +// DHCPMsgType represents a DHCP operation +type DHCPMsgType byte + +// Constants that represent DHCP operations +const ( + DHCPMsgTypeUnspecified
diff -- git a/layers/dhcpv6.go b/layers/dhcpv6.go new file mode 100644 index 0000000..40d2d2c -- - /dev/null +++ b/layers/dhcpv6.go @ @ -0,0 +1,495 @ @ +// Copyright 2018 Google , Inc. All rights reserved . +// +// Use of this source code is governed by a BSD-style license +// that can be found in the LICENSE file in the root of the source +// tree . + +package layers + +import ( + '' bytes '' + '' encoding/binary '' + '' errors '' + '' fmt '' + '' net '' + + '' github.com/google/gopacket '' + ) + +// DHCPv6MsgType represents a DHCPv6 operation +type DHCPv6MsgType byte + +// Constants that represent DHCP operations +const ( + DHCPv6MsgTypeUnspecified DHCPv6MsgType = iota + DHCPv6MsgTypeSolicit + DHCPv6MsgTypeAdverstise + DHCPv6MsgTypeRequest + DHCPv6MsgTypeConfirm + DHCPv6MsgTypeRenew + DHCPv6MsgTypeRebind + DHCPv6MsgTypeReply + DHCPv6MsgTypeRelease + DHCPv6MsgTypeDecline + DHCPv6MsgTypeReconfigure + DHCPv6MsgTypeInformationRequest + DHCPv6MsgTypeRelayForward + DHCPv6MsgTypeRelayReply + ) + +// String returns a string version of a DHCPv6MsgType . +func ( o DHCPv6MsgType ) String ( ) string { + switch o { + case DHCPv6MsgTypeUnspecified : + return `` Unspecified '' + case DHCPv6MsgTypeSolicit : + return `` Solicit '' + case DHCPv6MsgTypeAdverstise : + return `` Adverstise ''
diff -- git a/AUTHORS b/AUTHORS index eba34f0..5d3ffa4 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -13,6 +13,7 @ @ Hiroaki Kawai < Hiroaki.Kawai @ gmail.com > Lukas Lueg < lukas.lueg @ gmail.com > Laurent Hausermann < laurent.hausermann @ gmail.com > Bill Green < bgreen @ newrelic.com > +Christian Mder < christian.maeder @ nine.ch > CONTRIBUTORS : Attila Olh < attila @ attilaolah.eu > diff -- git a/layers/base_test.go b/layers/base_test.go index a6a5ea9..bed5d4f 100644 -- - a/layers/base_test.go +++ b/layers/base_test.go @ @ -9,8 +9,9 @ @ package layers import ( - '' github.com/google/gopacket '' '' testing '' + + '' github.com/google/gopacket '' ) func min ( a , b int ) int { diff -- git a/layers/icmp6.go b/layers/icmp6.go index 5354a16..09afd11 100644 -- - a/layers/icmp6.go +++ b/layers/icmp6.go @ @ -24,12 +24,21 @ @ const ( ICMPv6TypeParameterProblem = 4 ICMPv6TypeEchoRequest = 128 ICMPv6TypeEchoReply = 129 + // The following are from RFC 4861 ICMPv6TypeRouterSolicitation = 133 ICMPv6TypeRouterAdvertisement = 134 ICMPv6TypeNeighborSolicitation = 135 ICMPv6TypeNeighborAdvertisement = 136 ICMPv6TypeRedirect = 137 + + // The following are from RFC 2710 + ICMPv6TypeMLDv1MulticastListenerQueryMessage = 130 + ICMPv6TypeMLDv1MulticastListenerReportMessage = 131 + ICMPv6TypeMLDv1MulticastListenerDoneMessage = 132 + + // The following are from RFC 3810 + ICMPv6TypeMLDv2MulticastListenerReportMessageV2 = 143 ) const ( @
diff -- git a/turbinia/workers/__init__.py b/turbinia/workers/__init__.py index be05e4e..de47d3e 100644 -- - a/turbinia/workers/__init__.py +++ b/turbinia/workers/__init__.py @ @ -157,12 +157,12 @ @ class TurbiniaTaskResult ( object ) : log.info ( log_msg ) self._log.append ( log_msg ) - def add_evidence ( self , evidence , config ) : + def add_evidence ( self , evidence , config_ ) : `` '' '' Populate the results list . Args : evidence : Evidence object - config ( dict ) : The evidence config we want to associate with this + config_ ( dict ) : The evidence config we want to associate with this object . This will be passed in with the original evidence that was supplied to the task , so likely the caller will always want to use evidence_.config for this parameter . @ @ -171,7 +171,7 @ @ class TurbiniaTaskResult ( object ) : # created also contain the config . We could create a closure to do this # automatically , but the real fix is to attach this to a separate object . # See https : //github.com/google/turbinia/issues/211 for more details . - evidence.config = config + evidence.config = config_ self.evidence.append ( evidence ) def set_error ( self ,
diff -- git a/turbinia/jobs/grep.py b/turbinia/jobs/grep.py index 0e9ff90..9fb2014 100644 -- - a/turbinia/jobs/grep.py +++ b/turbinia/jobs/grep.py @ @ -19,19 +19,19 @ @ from __future__ import unicode_literals from turbinia.evidence import TextFile from turbinia.evidence import FilteredTextFile from turbinia.evidence import PlasoCsvFile -from turbinia.jobs import TurbiniaJob +from turbinia.jobs import interface +from turbinia.jobs import manager from turbinia.workers.grep import GrepTask -class GrepJob ( TurbiniaJob ) : +class GrepJob ( interface.TurbiniaJob ) : `` '' '' Filter input based on regular expression patterns . '' '' '' # The types of evidence that this Job will process evidence_input = [ TextFile , PlasoCsvFile ] evidence_output = [ FilteredTextFile ] - def __init__ ( self ) : - super ( GrepJob , self ) .__init__ ( name='GrepJob ' ) + NAME = 'GrepJob' def create_tasks ( self , evidence ) : `` '' '' Create task . @ @ -44,3 +44,6 @ @ class GrepJob ( TurbiniaJob ) : `` '' '' tasks = [ GrepTask ( ) for _ in evidence ] return tasks + + +manager.JobsManager.RegisterJob ( GrepJob ) diff -- git a/turbinia/jobs/interface.py b/turbinia/jobs/interface.py new file mode 100644 index 0000000..e84b23c -- - /dev/null +++ b/turbinia/jobs/interface.py @ @ -0,0 +1,44 @ @ + # -*- coding : utf-8 -*- +
diff -- git a/.travis.yml b/.travis.yml new file mode 100644 index 0000000..ea24c75 -- - /dev/null +++ b/.travis.yml @ @ -0,0 +1,11 @ @ +language : python +python : '2.7' +cache : + - pip + +install : + - pip install mock nose coverage + - pip install . + +script : + - ./run_tests.py diff -- git a/run_tests.py b/run_tests.py old mode 100644 new mode 100755 index 7f38293..4f1e1be -- - a/run_tests.py +++ b/run_tests.py @ @ -14,17 +14,9 @ @ # limitations under the License . `` `` '' Script to run the tests . '' '' '' -import os -import sys -import unittest +import subprocess if __name__ == '__main__ ' : - base_dir = os.path.dirname ( os.path.abspath ( __file__ ) ) - # Change PYTHONPATH to include full path to turbinia . - sys.path.insert ( 0 , base_dir ) - - test_suite = unittest.TestLoader ( ) .discover ( - os.path.join ( base_dir , 'tests ' ) , pattern='*.py ' ) - test_results = unittest.TextTestRunner ( verbosity=2 ) .run ( test_suite ) - if not test_results.wasSuccessful ( ) : - sys.exit ( 1 ) + subprocess.check_call ( [ + 'nosetests ' , '-vv ' , ' -- with-coverage ' , ' --
diff -- git a/tests/client.py b/tests/client.py index d449d7f..560a3e5 100644 -- - a/tests/client.py +++ b/tests/client.py @ @ -33,7 +33,8 @ @ class TestTurbiniaClient ( unittest.TestCase ) : @ mock.patch ( 'turbinia.client.task_manager.PSQTaskManager.setup ' ) def testTurbiniaClientInit ( self , _ ) : `` '' '' Basic test for client . '' '' '' - config.LoadConfig ( ) client = TurbiniaClient ( ) + config.LoadConfig ( ) + client = TurbiniaClient ( ) self.assertTrue ( hasattr ( client , 'task_manager ' ) ) @ mock.patch ( 'turbinia.client.GoogleCloudFunction.ExecuteFunction ' ) diff -- git a/tests/pubsub.py b/tests/pubsub.py index 4c9ac87..4f05b8f 100644 -- - a/tests/pubsub.py +++ b/tests/pubsub.py @ @ -131,3 +131,35 @ @ class TestTurbiniaPubSub ( unittest.TestCase ) : self.pubsub.topic = mock.MagicMock ( ) self.pubsub.send_message ( 'test message text ' ) self.pubsub.topic.publish.assert_called_with ( 'test message text ' ) + + +class TestTurbiniaKombu ( unittest.TestCase ) : + `` '' '' Test turbinia.pubsub Kombu module . '' '' '' + + def setUp ( self ) : + request = getTurbiniaRequest ( ) + self.kombu = pubsub.TurbiniaKombu ( 'fake_topic ' ) + result = mock.MagicMock ( ) + result.body = request.to_json ( ) + self.kombu.queue = mock.MagicMock ( ) + self.kombu.queue.__len__.return_value = 1 + self.kombu.queue.get.return_value = result + + def
diff -- git a/turbinia/evidence.py b/turbinia/evidence.py index ee1b583..6a83f0d 100644 -- - a/turbinia/evidence.py +++ b/turbinia/evidence.py @ @ -17,6 +17,7 @ @ import json import sys from turbinia import TurbiniaException +from turbinia.processors import google_cloud def evidence_decode ( evidence_dict ) : @ @ -205,6 +206,12 @ @ class GoogleCloudDisk ( RawDisk ) : self.type = type_ super ( GoogleCloudDisk , self ) .__init__ ( *args , **kwargs ) + def preprocess ( self ) : + google_cloud.PreprocessAttachDisk ( self ) + + def postprocess ( self ) : + google_cloud.PostprocessDetachDisk ( self ) + class PlasoFile ( Evidence ) : `` '' '' Plaso output file evidence . diff -- git a/turbinia/processors/__init__.py b/turbinia/processors/__init__.py new file mode 100644 index 0000000..e69de29 diff -- git a/turbinia/processors/google_cloud.py b/turbinia/processors/google_cloud.py new file mode 100644 index 0000000..38db662 -- - /dev/null +++ b/turbinia/processors/google_cloud.py @ @ -0,0 +1,328 @ @ + # Copyright 2017 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless
diff -- git a/turbinia/evidence.py b/turbinia/evidence.py index ee1b583..6a83f0d 100644 -- - a/turbinia/evidence.py +++ b/turbinia/evidence.py @ @ -17,6 +17,7 @ @ import json import sys from turbinia import TurbiniaException +from turbinia.processors import google_cloud def evidence_decode ( evidence_dict ) : @ @ -205,6 +206,12 @ @ class GoogleCloudDisk ( RawDisk ) : self.type = type_ super ( GoogleCloudDisk , self ) .__init__ ( *args , **kwargs ) + def preprocess ( self ) : + google_cloud.PreprocessAttachDisk ( self ) + + def postprocess ( self ) : + google_cloud.PostprocessDetachDisk ( self ) + class PlasoFile ( Evidence ) : `` '' '' Plaso output file evidence . diff -- git a/turbinia/processors/__init__.py b/turbinia/processors/__init__.py new file mode 100644 index 0000000..e69de29 diff -- git a/turbinia/processors/google_cloud.py b/turbinia/processors/google_cloud.py new file mode 100644 index 0000000..16046ac -- - /dev/null +++ b/turbinia/processors/google_cloud.py @ @ -0,0 +1,412 @ @ + # Copyright 2017 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless
diff -- git a/run_tests.py b/run_tests.py old mode 100644 new mode 100755 diff -- git a/tests/client.py b/tests/client.py index d449d7f..c499efb 100644 -- - a/tests/client.py +++ b/tests/client.py @ @ -30,15 +30,18 @ @ from turbinia import TurbiniaException class TestTurbiniaClient ( unittest.TestCase ) : `` '' '' Test Turbinia client class . '' '' '' - @ mock.patch ( 'turbinia.client.task_manager.PSQTaskManager.setup ' ) - def testTurbiniaClientInit ( self , _ ) : + @ mock.patch ( 'turbinia.client.task_manager.PSQTaskManager._backend_setup ' ) + @ mock.patch ( 'turbinia.state_manager.get_state_manager ' ) + def testTurbiniaClientInit ( self , _ , __ ) : `` '' '' Basic test for client . '' '' '' - config.LoadConfig ( ) client = TurbiniaClient ( ) + config.LoadConfig ( ) + client = TurbiniaClient ( ) self.assertTrue ( hasattr ( client , 'task_manager ' ) ) @ mock.patch ( 'turbinia.client.GoogleCloudFunction.ExecuteFunction ' ) - @ mock.patch ( 'turbinia.client.task_manager.PSQTaskManager.setup ' ) - def testTurbiniaClientGetTaskData ( self , _ , mock_cloud_function ) : + @ mock.patch ( 'turbinia.client.task_manager.PSQTaskManager._backend_setup ' ) + @ mock.patch ( 'turbinia.state_manager.get_state_manager ' ) + def testTurbiniaClientGetTaskData ( self , _ , __ , mock_cloud_function ) : `` '' '' Basic test for client.get_task_data '' '' '' # ExecuteFunction returns a dict with a
diff -- git a/tools/gcf_init/deploy_gcf.py b/tools/gcf_init/deploy_gcf.py index 61b8b4e..43679c3 100755 -- - a/tools/gcf_init/deploy_gcf.py +++ b/tools/gcf_init/deploy_gcf.py @ @ -18,8 +18,8 @ @ config.LoadConfig ( ) for function in function_names : print 'Deploying function { 0 : s } '.format ( function ) cmd = ( 'gcloud -- project { 0 : s } beta functions deploy { 1 : s } -- stage-bucket ' - ' { 2 : s } -- trigger-http'.format ( config.PROJECT , function , - config.BUCKET_NAME ) ) + ' { 2 : s } -- region { 3 : s } -- trigger-http'.format ( config.PROJECT , function , + config.BUCKET_NAME , config.TURBINIA_REGION ) ) print subprocess.check_call ( cmd , shell=True ) print '/nCreating Datastore index from { 0 : s } '.format ( index_file ) diff -- git a/turbinia/config/__init__.py b/turbinia/config/__init__.py index 64b5cff..3194cd9 100644 -- - a/turbinia/config/__init__.py +++ b/turbinia/config/__init__.py @ @ -47,6 +47,7 @ @ CONFIGVARS = [ # GCE CONFIG 'PROJECT ' , 'ZONE ' , + 'TURBINIA_REGION ' , 'INSTANCE ' , 'DEVICE_NAME ' , 'SCRATCH_PATH ' , diff -- git a/turbinia/config/turbinia_config.py b/turbinia/config/turbinia_config.py index eb5c445..b86378b 100644 -- - a/turbinia/config/turbinia_config.py +++ b/turbinia/config/turbinia_config.py @ @ -59,6 +59,11 @ @ DEVICE_NAME = None SCRATCH_PATH = None BUCKET_NAME = None PSQ_TOPIC
diff -- git a/turbinia/config/__init__.py b/turbinia/config/__init__.py index f5cd54a..0fb00bf 100644 -- - a/turbinia/config/__init__.py +++ b/turbinia/config/__init__.py @ @ -85,12 +85,16 @ @ def LoadConfig ( ) : if CONFIG : return CONFIG + # If the environment variable is set , take precedence over the pre-defined + # CONFIGPATHs . + configpath = CONFIGPATH if ENVCONFIGVAR in os.environ : - CONFIGPATH.extend ( os.environ [ ENVCONFIGVAR ] .split ( ' : ' ) ) + configpath = os.environ [ ENVCONFIGVAR ] .split ( ' : ' ) + config_file = None # Load first file found - for _dir , _file in itertools.product ( CONFIGPATH , CONFIGFILES ) : + for _dir , _file in itertools.product ( configpath , CONFIGFILES ) : if os.path.exists ( os.path.join ( _dir , _file ) ) : config_file = os.path.join ( _dir , _file ) break
diff -- git a/turbinia/evidence.py b/turbinia/evidence.py index 09a8360..fc6db97 100644 -- - a/turbinia/evidence.py +++ b/turbinia/evidence.py @ @ -14,10 +14,45 @ @ `` '' '' Turbinia Evidence objects . '' '' '' import json +import sys from turbinia import TurbiniaException +def evidence_decode ( evidence_dict ) : + `` '' '' Decode JSON into appropriate Evidence object . + + Args : + evidence_str : Serialized evidence ( i.e . a __dict__ post JSON decoding ) . + + Returns : + An instantiated Evidence object ( or a sub-class of it ) . + + Raises : + TurbiniaException : If input is not a dict , does not have a type attribute , + or does not deserialize to an evidence object . + `` '' '' + if not isinstance ( evidence_dict , dict ) : + raise TurbiniaException ( + u'Evidence_dict is not a dictionary , type is { 0 : s } '.format ( + str ( type ( evidence_dict ) ) ) ) + + type_ = evidence_dict.get ( u'type ' , None ) + if not type_ : + raise TurbiniaException ( + u'No Type attribute for evidence object [ { 0 : s } ] '.format
diff -- git a/requirements.txt b/requirements.txt index 583d766..bd97356 100644 -- - a/requirements.txt +++ b/requirements.txt @ @ -5,3 +5,6 @ @ google-cloud-pubsub==0.26.0 google-cloud-storage==1.6.0 google-cloud-core==0.26.0 urllib3 [ secure ] +celery==4.1.0 +kombu==4.1.0 +redis==2.10.6 diff -- git a/setup.py b/setup.py index 5769431..403a4ab 100644 -- - a/setup.py +++ b/setup.py @ @ -23,8 +23,12 @ @ sudo python setup.py install from setuptools import find_packages from setuptools import setup -from pip.req import parse_requirements -from pip.download import PipSession +try : # for pip > = 10 + from pip._internal.req import parse_requirements + from pip._internal.download import PipSession +except ImportError : # for pip < = 9.0.3 + from pip.req import parse_requirements + from pip.download import PipSession setup ( name='Turbinia ' , diff -- git a/tests/client.py b/tests/client.py index d449d7f..560a3e5 100644 -- - a/tests/client.py +++ b/tests/client.py @ @ -33,7 +33,8 @ @ class TestTurbiniaClient ( unittest.TestCase ) : @ mock.patch ( 'turbinia.client.task_manager.PSQTaskManager.setup ' ) def testTurbiniaClientInit ( self , _ ) : `` '' '' Basic test for client . '' '' '' - config.LoadConfig ( ) client = TurbiniaClient ( ) + config.LoadConfig ( ) + client = TurbiniaClient ( ) self.assertTrue ( hasattr ( client , 'task_manager ' ) ) @ mock.patch ( 'turbinia.client.GoogleCloudFunction.ExecuteFunction ' ) diff -- git a/tests/pubsub.py b/tests/pubsub.py
diff -- git a/tools/gcf_init/deploy_gcf.py b/tools/gcf_init/deploy_gcf.py index 43679c3..f3b12f4 100755 -- - a/tools/gcf_init/deploy_gcf.py +++ b/tools/gcf_init/deploy_gcf.py @ @ -1,5 +1,5 @ @ - # -*- coding : utf-8 -*- # ! /usr/bin/env python + # -*- coding : utf-8 -*- import subprocess import sys @ @ -11,7 +11,7 @ @ index_file = './index.yaml' if len ( sys.argv ) > 1 : function_names = [ sys.argv [ 1 ] ] else : - function_names = [ 'gettasks ' , 'getrecenttasks ' ] + function_names = [ 'gettasks ' , 'getrecenttasks ' , 'closetask ' , 'closetasks ' ] config.LoadConfig ( ) @ @ -19,10 +19,12 @ @ for function in function_names : print 'Deploying function { 0 : s } '.format ( function ) cmd = ( 'gcloud -- project { 0 : s } beta functions deploy { 1 : s } -- stage-bucket ' ' { 2 : s } -- region { 3 : s } -- trigger-http'.format ( config.PROJECT , function , - config.BUCKET_NAME , config.TURBINIA_REGION ) ) + config.BUCKET_NAME , + config.TURBINIA_REGION ) ) print subprocess.check_call ( cmd , shell=True ) print '/nCreating Datastore index from { 0 : s } '.format ( index_file ) cmd = 'gcloud --
diff -- git a/turbinia/turbiniactl.py b/turbinia/turbiniactl.py old mode 100755 new mode 100644 index 84d3ca1..b832626 -- - a/turbinia/turbiniactl.py +++ b/turbinia/turbiniactl.py @ @ -223,6 +223,9 @ @ def main ( ) : # Server subparsers.add_parser ( 'server ' , help='Run Turbinia Server ' ) + # print version + log.info ( 'Turbinia version : { 0 : s } '.format ( __version__ ) ) + args = parser.parse_args ( ) if args.quiet : log.setLevel ( logging.ERROR )
diff -- git a/app/elements/io-schedule-subnav.html b/app/elements/io-schedule-subnav.html index 78307cd..1c78eba 100644 -- - a/app/elements/io-schedule-subnav.html +++ b/app/elements/io-schedule-subnav.html @ @ -163,7 +163,7 @ @ Fired when the clears filter `` x '' is clicked . on-tap= '' toggleFilters '' > < span hidden $ = '' [ [ app.isPhoneSize ] ] '' > Filter < /span > < ! -- paper-icon-buttons supports its own disabled property . yay ! -- > - < paper-icon-button icon= '' io : filter-list '' aria-label= '' Filter list '' + < paper-icon-button icon= '' [ [ _computeFilterIcon ( showFilters ) ] ] '' aria-label= '' Filter list '' disabled= '' [ [ _disableFilterBtn ] ] '' > < /paper-icon-button > < /div > @ @ -284,6 +284,10 @ @ Fired when the clears filter `` x '' is clicked . clearFilters : function ( ) { this.fire ( 'filters-clear ' ) ; + } , + + _computeFilterIcon : function ( filtering ) { + return filtering ? 'io : close ' : 'io : filter-list ' ; } } ) diff -- git a/app/elements/io-schedule.scss b/app/elements/io-schedule.scss index 337be1e..8e78b2d 100644 -- - a/app/elements/io-schedule.scss +++ b/app/elements/io-schedule.scss @ @ -188,7 +188,7 @ @ $ filterBannerHeight : 72px ; } .filters__panel { -
diff -- git a/app/elements/countdown-timer/countdown-timer.html b/app/elements/countdown-timer/countdown-timer.html index 8c3c408..8e85a90 100644 -- - a/app/elements/countdown-timer/countdown-timer.html +++ b/app/elements/countdown-timer/countdown-timer.html @ @ -71,11 +71,11 @ @ Fired when the intro sequence starts or finishes . properties : { /** * The target date for the countdown . Should be specified in ISO 8601 - * format , e.g . ` May 10 2016 09:00:00 GMT-0700 ( PDT ) ` . + * format , e.g . ` May 18 2016 10:00:00 GMT-0700 ( PDT ) ` . */ date : { type : String , - value : 'May 18 2016 09:30:00 GMT-0700 ( PDT ) ' + value : 'May 18 2016 10:00:00 GMT-0700 ( PDT ) ' } , /** diff -- git a/app/elements/io-home-page.html b/app/elements/io-home-page.html index 0b93893..4eb469d 100644 -- - a/app/elements/io-home-page.html +++ b/app/elements/io-home-page.html @ @ -248,11 +248,11 @ @ limitations under the License . properties : { /** * The target date for I/O to start . Should be specified in ISO 8601 - * format , e.g . ` May 18 2016 09:00:00 GMT-0700 ( PDT ) ` . + * format , e.g . ` May 18 2016 10:00:00 GMT-0700 ( PDT ) ` . */ date : { type : String ,
diff -- git a/app/elements/io-attend-page.html b/app/elements/io-attend-page.html index b53c3dd..fe91607 100644 -- - a/app/elements/io-attend-page.html +++ b/app/elements/io-attend-page.html @ @ -334,6 +334,8 @ @ limitations under the License . ( function ( ) { 'use strict ' ; + var SUBTAB_SELECTOR = ' # subpage-tabs a ' ; + Polymer ( { is : 'io-attend-page ' , @ @ -373,10 +375,16 @ @ limitations under the License . this._lowerScrollThreshold = IOWA.Elements.Footer.clientHeight + parseInt ( getComputedStyle ( IOWA.Elements.Footer ) .height ) + Polymer.dom ( this.root ) .querySelector ( '.io__hash ' ) .clientHeight ; + + // Wait till after subnav effects to look for focusable items + this.async ( function ( ) { + IOWA.A11y.addFocusStates ( SUBTAB_SELECTOR ) ; + } ) ; } , detached : function ( ) { this.unlisten ( IOWA.Elements.ScrollContainer , 'scroll ' , '_onPageScroll ' ) ; + IOWA.A11y.removeFocusStates ( SUBTAB_SELECTOR ) ; } , onSubpageTransitionDone : function ( ) { diff -- git a/app/elements/shared-app-styles.html b/app/elements/shared-app-styles.html index 57dfffd..78b4fc6 100644 -- - a/app/elements/shared-app-styles.html +++ b/app/elements/shared-app-styles.html @ @ -119,7 +119,7 @ @ limitations under the License . padding : 0 12px ; } - paper-tab [ link ] a : focus { + paper-tab [ link ] a.focused { background : rgba (
diff -- git a/app/elements/io-schedule.html b/app/elements/io-schedule.html index e039318..a4d701c 100644 -- - a/app/elements/io-schedule.html +++ b/app/elements/io-schedule.html @ @ -256,9 +256,9 @ @ Fired when the user toggles bookmarking/removing a session . < p class= '' note '' > Note : Notifications are activated per device . To receive notifications on multiple devices , sign in on each device , enable notifications , and make sure you 're online . All device notifications can be turned on/off at any time in the settings panel . < /p > - < span class= '' anchor-like '' role= '' link '' tabindex= '' 0 '' + < a href= '' # '' class= '' anchor-like '' role= '' link '' tabindex= '' 0 '' data-track-link= '' schedule-open-settings '' - on-click= '' openSettings '' > Settings < /span > + on-click= '' openSettings '' > Settings < /a > < /div > < /iron-pages > < /div > @ @ -631,6 +631,8 @ @ Fired when the user toggles bookmarking/removing a session . openSettings : function ( e ) { e.stopPropagation ( ) ; + e.preventDefault ( ) ; + // TODO : note global pollution . Consider firing bubbling event . IOWA.Elements.Template.openSettings ( e ) ;
diff -- git a/extensions/data-transfer/portability-data-transfer-microsoft/src/main/java/org/dataportabilityproject/transfer/microsoft/provider/MicrosoftTransferServiceProvider.java b/extensions/data-transfer/portability-data-transfer-microsoft/src/main/java/org/dataportabilityproject/transfer/microsoft/provider/MicrosoftTransferServiceProvider.java index 243284c..a2004c6 100644 -- - a/extensions/data-transfer/portability-data-transfer-microsoft/src/main/java/org/dataportabilityproject/transfer/microsoft/provider/MicrosoftTransferServiceProvider.java +++ b/extensions/data-transfer/portability-data-transfer-microsoft/src/main/java/org/dataportabilityproject/transfer/microsoft/provider/MicrosoftTransferServiceProvider.java @ @ -16,6 +16,8 @ @ package org.dataportabilityproject.transfer.microsoft.provider ; import com.fasterxml.jackson.databind.ObjectMapper ; +import com.google.common.collect.ImmutableList ; +import java.util.List ; import okhttp3.OkHttpClient ; import org.dataportabilityproject.spi.transfer.provider.Exporter ; import org.dataportabilityproject.spi.transfer.provider.Importer ; @ @ -59,4 +61,14 @ @ public class MicrosoftTransferServiceProvider implements TransferServiceProvider throw new IllegalArgumentException ( `` Unsupported import type : `` + transferDataType ) ; } ) ; } + + @ Override + public List < String > getImportTypes ( ) { + return ImmutableList.of ( CONTACTS ) ; + } + + @ Override + public List < String > getExportTypes ( ) { + return ImmutableList.of ( CONTACTS ) ; + } } diff -- git a/portability-gateway/build.gradle b/portability-gateway/build.gradle index 384cb81..6a3cae8 100644 -- - a/portability-gateway/build.gradle +++ b/portability-gateway/build.gradle @ @ -16,4 +16,5 @ @ dependencies { compile project ( ' : portability-spi-cloud ' ) + compile project ( ' : portability-spi-gateway ' ) } diff -- git a/portability-spi-gateway/src/main/java/org/dataportabilityproject/spi/gateway/auth/AuthServiceProviderRegistry.java b/portability-spi-gateway/src/main/java/org/dataportabilityproject/spi/gateway/auth/AuthServiceProviderRegistry.java index 21266fb..ad18761 100644 -- - a/portability-spi-gateway/src/main/java/org/dataportabilityproject/spi/gateway/auth/AuthServiceProviderRegistry.java +++ b/portability-spi-gateway/src/main/java/org/dataportabilityproject/spi/gateway/auth/AuthServiceProviderRegistry.java @ @ -11,5 +11,4 @ @ public interface AuthServiceProviderRegistry { * @ param serviceId the service id */ AuthServiceProvider getServiceProvider ( String serviceId ) ; - - } + } diff --
diff -- git a/distributions/demo-server/build.gradle b/distributions/demo-server/build.gradle index 18ee0a7..ceeb6d8 100644 -- - a/distributions/demo-server/build.gradle +++ b/distributions/demo-server/build.gradle @ @ -39,6 +39,8 @ @ repositories { def CLIENT_ID_PREFIX = 'data.portability.key . ' def CLIENT_SECRET_PREFIX = 'data.portability.secret . ' +def JWT_KEY = 'data.portability.jwt.key' +def JWT_SECRET = 'data.portability.jwt.secret' dependencies { compile project ( ' : portability-bootstrap-vm ' ) @ @ -68,6 +70,10 @ @ task createSecretsFile ( ) { } else if ( key.startsWith ( CLIENT_SECRET_PREFIX ) & & key.length ( ) > CLIENT_SECRET_PREFIX.length ( ) ) { def keyPrefix = key.substring ( CLIENT_SECRET_PREFIX.length ( ) ) .toUpperCase ( ) ; propFile.append ( `` $ { keyPrefix } _SECRET= $ { val } \n '' ) ; + } else if ( JWT_KEY.equals ( key ) ) { + propFile.append ( `` JWT_KEY= $ { val } \n '' ) ; + } else if ( JWT_SECRET.equals ( key ) ) { + propFile.append ( `` JWT_SECRET= $ { val } \n '' ) ; } } } diff -- git a/extensions/cloud/portability-cloud-local/src/main/java/org/dataportabilityproject/cloud/local/LocalJobStore.java b/extensions/cloud/portability-cloud-local/src/main/java/org/dataportabilityproject/cloud/local/LocalJobStore.java index ddcda18..762ccd7 100644 -- - a/extensions/cloud/portability-cloud-local/src/main/java/org/dataportabilityproject/cloud/local/LocalJobStore.java +++ b/extensions/cloud/portability-cloud-local/src/main/java/org/dataportabilityproject/cloud/local/LocalJobStore.java @ @ -19,13 +19,13 @ @ import com.google.common.base.Preconditions ; import org.dataportabilityproject.spi.cloud.storage.JobStore ; import org.dataportabilityproject.spi.cloud.types.JobAuthorization ; import org.dataportabilityproject.spi.cloud.types.PortabilityJob ; +import org.dataportabilityproject.types.transfer.models.DataModel ; import java.io.IOException ; import java.util.Map
diff -- git a/extensions/data-transfer/portability-data-transfer-instagram/build.gradle b/extensions/data-transfer/portability-data-transfer-instagram/build.gradle new file mode 100644 index 0000000..ea202c9 -- - /dev/null +++ b/extensions/data-transfer/portability-data-transfer-instagram/build.gradle @ @ -0,0 +1,26 @ @ +/* + * Copyright 2018 The Data Transfer Project Authors . + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * https : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ + +dependencies { + compile project ( ' : portability-spi-cloud ' ) + compile project ( ' : portability-spi-transfer ' ) + + // logging + compile ( `` org.slf4j : slf4j-api : $ { slf4jVersion } '' ) + compile ( `` org.slf4j : slf4j-log4j12 :
diff -- git a/.travis.yml b/.travis.yml index 9e4cf9a..b229412 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -18,6 +18,9 @ @ matrix : # language : java causes Travis to automatically run Gradle tests based on the # presence of the appropriate build files . - language : java # Gradle ( used automatically ) + script : + # Build the demo docker image to be pushed to docker hub + - gradlew -PcloudType=local : distributions : demo-server : dockerize # The angularjs flow below is more customized . There is some nodejs setup to do as well as # configuration to use the version of Chrome that is installed in Travis images . - language : node_js @ @ -48,3 +51,11 @ @ notifications : secure : U+Xfg5/isDKa6JWpy98kauwcirWDAGlmVYcqBRkNBztH6uKvpJQX94Ftj3ciRyWU4f2Dm+fmBRtMnCsRBOied7XK8r+J/MFL7E+jP3FHT/3v/sRROhS15nX3vPPJDVMpU5G3UDe2d1n8VE6RyK6a6bGvOaFFBnt9WLdyoKKmM2gmR6ie/iBIJlQdYy4nMuu8Q0ExDuEX6gWCAyCzl9iC3uUHHOPCCuQPiEDD9zN17UYI+kbcYNjIbVJItyjGG9W3oBcVZm7Rn8mpB+kaV33iioMqz6oUC5vzPjwDw0vVk9AivZH1GQDhDvuJMFvFgJ5w7lj+rV6J6c9RvpHpMTZGFy4Fx7HoaTukqO53g74Vz63c9ql/L+hRXbkO7pkfB4PQJSpdF0Dc7Zq8hRZMcoMo6YW0+zYH0PtSESMo4+FK8WtmBtRwKcWCAaPdsDsYtnhj3ezjLijEqeKuk98AaV11Dik+C6/xmhmmfWqe+JizmSnCrRQz4h7H/2vsX8KSDip8hftvimjRkx0nYLsEwEjy7k5QmFsJ8zK47XJPUxiEimW86xoOP9Jesvtx+Ns+vRNa6wqXok2WM5cwD2oYQ7xdopBh98rQdrQiKnwFU6NE8us1tyKNwnJ2xuNrXbt+7PcJodCXTIlOkQIIAGUQx2CAR4TLAk564e/hqD+GW9102zw= on_success : change # default : always on_failure : always # default : always + + # Deploy the demo docker image to Docker Hub +deploy : + provider : script + script : bash docker_push + skip_cleanup : true + on : + branch : master diff -- git a/docker_push.sh b/docker_push.sh new file mode 100644 index 0000000..2865054 -- - /dev/null +++ b/docker_push.sh @ @ -0,0 +1,6 @ @ + # !
diff -- git a/client/package-lock.json b/client/package-lock.json new file mode 100644 index 0000000..405ccf4 -- - /dev/null +++ b/client/package-lock.json @ @ -0,0 +1,11488 @ @ + { + `` name '' : `` portability-demo '' , + `` version '' : `` 0.0.0 '' , + `` lockfileVersion '' : 1 , + `` requires '' : true , + `` dependencies '' : { + `` @ angular-devkit/build-optimizer '' : { + `` version '' : `` 0.3.2 '' , + `` resolved '' : `` https : //registry.npmjs.org/ @ angular-devkit/build-optimizer/-/build-optimizer-0.3.2.tgz '' , + `` integrity '' : `` sha512-U0BCZtThq5rUfY08shHXpxe8ZhSsiYB/cJjUvAWRTs/ORrs8pbngS6xwseQws8d/vHoVrtqGD9GU9h8AmFRERQ== '' , + `` dev '' : true , + `` requires '' : { + `` loader-utils '' : `` 1.1.0 '' , + `` source-map '' : `` 0.5.7 '' , + `` typescript '' : `` 2.6.2 '' , + `` webpack-sources '' : `` 1.1.0 '' + } , + `` dependencies '' : { + `` typescript '' : { + `` version '' : `` 2.6.2 '' , + `` resolved '' : `` https : //registry.npmjs.org/typescript/-/typescript-2.6.2.tgz '' , + `` integrity '' : `` sha1-PFtv1/beCRQmkCfwPAlGdY92c6Q= '' , + `` dev '' : true + }
diff -- git a/client/package-lock.json b/client/package-lock.json new file mode 100644 index 0000000..405ccf4 -- - /dev/null +++ b/client/package-lock.json @ @ -0,0 +1,11488 @ @ + { + `` name '' : `` portability-demo '' , + `` version '' : `` 0.0.0 '' , + `` lockfileVersion '' : 1 , + `` requires '' : true , + `` dependencies '' : { + `` @ angular-devkit/build-optimizer '' : { + `` version '' : `` 0.3.2 '' , + `` resolved '' : `` https : //registry.npmjs.org/ @ angular-devkit/build-optimizer/-/build-optimizer-0.3.2.tgz '' , + `` integrity '' : `` sha512-U0BCZtThq5rUfY08shHXpxe8ZhSsiYB/cJjUvAWRTs/ORrs8pbngS6xwseQws8d/vHoVrtqGD9GU9h8AmFRERQ== '' , + `` dev '' : true , + `` requires '' : { + `` loader-utils '' : `` 1.1.0 '' , + `` source-map '' : `` 0.5.7 '' , + `` typescript '' : `` 2.6.2 '' , + `` webpack-sources '' : `` 1.1.0 '' + } , + `` dependencies '' : { + `` typescript '' : { + `` version '' : `` 2.6.2 '' , + `` resolved '' : `` https : //registry.npmjs.org/typescript/-/typescript-2.6.2.tgz '' , + `` integrity '' : `` sha1-PFtv1/beCRQmkCfwPAlGdY92c6Q= '' , + `` dev '' : true + }
diff -- git a/client/package-lock.json b/client/package-lock.json new file mode 100644 index 0000000..405ccf4 -- - /dev/null +++ b/client/package-lock.json @ @ -0,0 +1,11488 @ @ + { + `` name '' : `` portability-demo '' , + `` version '' : `` 0.0.0 '' , + `` lockfileVersion '' : 1 , + `` requires '' : true , + `` dependencies '' : { + `` @ angular-devkit/build-optimizer '' : { + `` version '' : `` 0.3.2 '' , + `` resolved '' : `` https : //registry.npmjs.org/ @ angular-devkit/build-optimizer/-/build-optimizer-0.3.2.tgz '' , + `` integrity '' : `` sha512-U0BCZtThq5rUfY08shHXpxe8ZhSsiYB/cJjUvAWRTs/ORrs8pbngS6xwseQws8d/vHoVrtqGD9GU9h8AmFRERQ== '' , + `` dev '' : true , + `` requires '' : { + `` loader-utils '' : `` 1.1.0 '' , + `` source-map '' : `` 0.5.7 '' , + `` typescript '' : `` 2.6.2 '' , + `` webpack-sources '' : `` 1.1.0 '' + } , + `` dependencies '' : { + `` typescript '' : { + `` version '' : `` 2.6.2 '' , + `` resolved '' : `` https : //registry.npmjs.org/typescript/-/typescript-2.6.2.tgz '' , + `` integrity '' : `` sha1-PFtv1/beCRQmkCfwPAlGdY92c6Q= '' , + `` dev '' : true + }
diff -- git a/extensions/data-transfer/portability-data-transfer-google/src/main/java/org/dataportabilityproject/datatransfer/google/GoogleTransferExtension.java b/extensions/data-transfer/portability-data-transfer-google/src/main/java/org/dataportabilityproject/datatransfer/google/GoogleTransferExtension.java new file mode 100644 index 0000000..187e4be -- - /dev/null +++ b/extensions/data-transfer/portability-data-transfer-google/src/main/java/org/dataportabilityproject/datatransfer/google/GoogleTransferExtension.java @ @ -0,0 +1,69 @ @ +package org.dataportabilityproject.datatransfer.google ; + +import com.google.common.base.Preconditions ; +import com.google.common.collect.ImmutableList ; +import com.google.common.collect.ImmutableMap ; +import org.dataportabilityproject.api.launcher.ExtensionContext ; +import org.dataportabilityproject.datatransfer.google.calendar.GoogleCalendarExporter ; +import org.dataportabilityproject.datatransfer.google.calendar.GoogleCalendarImporter ; +import org.dataportabilityproject.datatransfer.google.contacts.GoogleContactsExporter ; +import org.dataportabilityproject.datatransfer.google.contacts.GoogleContactsImporter ; +import org.dataportabilityproject.spi.cloud.storage.JobStore ; +import org.dataportabilityproject.spi.transfer.extension.TransferExtension ; +import org.dataportabilityproject.spi.transfer.provider.Exporter ; +import org.dataportabilityproject.spi.transfer.provider.Importer ; + +/* + * GoogleTransferExtension allows for importers and exporters of data types + * to be retrieved . + */ +public class GoogleTransferExtension implements TransferExtension { + public static final String SERVICE_ID = `` google '' ; + // TODO : centralized place , or enum type for these + private ImmutableList < String > supportedServices = ImmutableList.of ( `` calendar '' , `` contacts '' ) ; + private ImmutableMap < String , Importer > importerMap ; + private ImmutableMap < String , Exporter > exporterMap ; + private JobStore jobStore ; + private boolean initialized = false ; + + @ Override + public String getServiceId ( ) { + return SERVICE_ID ; + } + + @ Override + public Exporter < ? , ? > getExporter ( String transferDataType ) { + Preconditions.checkArgument
diff -- git a/distributions/demo-google-deployment/bin/setup_gke_environment.sh b/distributions/demo-google-deployment/bin/setup_gke_environment.sh index b57280d..073c44e 100755 -- - a/distributions/demo-google-deployment/bin/setup_gke_environment.sh +++ b/distributions/demo-google-deployment/bin/setup_gke_environment.sh @ @ -309,6 +309,13 @ @ echo `` Created GCS bucket $ GCS_BUCKET_NAME '' print_step `` Granting service account $ { SERVICE_ACCOUNT } viewer privileges to 'app-data ' bucket '' gsutil acl -p $ { PROJECT_ID } ch -u $ { SERVICE_ACCOUNT } : R $ { GCS_BUCKET_NAME } + # TODO : what if the bucket already exists ? +print_step `` Creating GCS 'user-data ' bucket for storing encrypted user data '' +BUCKET_NAME= '' user-data- $ PROJECT_ID '' +GCS_BUCKET_NAME= '' gs : // $ BUCKET_NAME/ '' +gsutil mb -p $ { PROJECT_ID } $ { GCS_BUCKET_NAME } +echo `` Created GCS bucket $ GCS_BUCKET_NAME '' + print_step `` Creating a key to encrypt app secrets '' gcloud kms keyrings create portability_secrets -- location global # Currently only one purposes is supported : `` encryption '' . Ca n't have separate encrypt/decrypt keys . diff -- git a/extensions/cloud/portability-cloud-google/src/main/java/org/datatransferproject/cloud/google/GoogleCloudExtensionModule.java b/extensions/cloud/portability-cloud-google/src/main/java/org/datatransferproject/cloud/google/GoogleCloudExtensionModule.java index ca9c2a7..a35ad67 100644 -- - a/extensions/cloud/portability-cloud-google/src/main/java/org/datatransferproject/cloud/google/GoogleCloudExtensionModule.java +++ b/extensions/cloud/portability-cloud-google/src/main/java/org/datatransferproject/cloud/google/GoogleCloudExtensionModule.java @ @ -27,6 +27,9 @ @ import com.google.api.client.json.JsonFactory ; import com.google.auth.oauth2.GoogleCredentials ; import com.google.cloud.datastore.Datastore ; import com.google.cloud.datastore.DatastoreOptions ; +import com.google.cloud.storage.Bucket ; +import com.google.cloud.storage.Storage ; +import com.google.cloud.storage.StorageOptions ; import com.google.common.annotations.VisibleForTesting ;
diff -- git a/Documentation/Keys.md b/Documentation/Keys.md index 19d1bf9..8ecfeca 100644 -- - a/Documentation/Keys.md +++ b/Documentation/Keys.md @ @ -62,6 +62,6 @ @ for a template . # # # Running on a cloud provider -When running on a cloud provider your cloud implementation wil override - [ AppCredentialStore ] ( ../portability-spi-cloud/src/main/java/org/dataportabilityproject/spi/cloud/storage/AppCredentialStore.java ) +When running on a cloud provider , your cloud implementation will override + [ AppCredentialStore ] ( ../portability-spi-cloud/src/main/java/org/datatransferproject/spi/cloud/storage/AppCredentialStore.java ) to read stored credentials from your cloud provider .
diff -- git a/.travis.yml b/.travis.yml index 7ff08f9..9e4cf9a 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -18,10 +18,6 @ @ matrix : # language : java causes Travis to automatically run Gradle tests based on the # presence of the appropriate build files . - language : java # Gradle ( used automatically ) - install : - # Copy the required secrets file - - mkdir .gradle - - cp distributions/common/dataportability.secrets.example.properties .gradle/dataportability.secrets.properties # The angularjs flow below is more customized . There is some nodejs setup to do as well as # configuration to use the version of Chrome that is installed in Travis images . - language : node_js diff -- git a/Documentation/Developer.md b/Documentation/Developer.md index ef0669f..0cecfa7 100644 -- - a/Documentation/Developer.md +++ b/Documentation/Developer.md @ @ -74,21 +74,20 @ @ You only need to do this once . The following builds and optionally runs the demo server ( including Worker , API and UI ) locally * NOTE : The first time you run you need to configure your credentials by copying - distributions/common/dataportability.secrets.example.properties to - .gradle/dataportability.secrets.properties and inserting the API keys and secrets for - the services you with to interact with . + distributions/demo-server/env.secrets.template to env.secrets and inserting the
diff -- git a/.travis.yml b/.travis.yml index 7ff08f9..9e4cf9a 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -18,10 +18,6 @ @ matrix : # language : java causes Travis to automatically run Gradle tests based on the # presence of the appropriate build files . - language : java # Gradle ( used automatically ) - install : - # Copy the required secrets file - - mkdir .gradle - - cp distributions/common/dataportability.secrets.example.properties .gradle/dataportability.secrets.properties # The angularjs flow below is more customized . There is some nodejs setup to do as well as # configuration to use the version of Chrome that is installed in Travis images . - language : node_js diff -- git a/Documentation/Developer.md b/Documentation/Developer.md index ef0669f..0cecfa7 100644 -- - a/Documentation/Developer.md +++ b/Documentation/Developer.md @ @ -74,21 +74,20 @ @ You only need to do this once . The following builds and optionally runs the demo server ( including Worker , API and UI ) locally * NOTE : The first time you run you need to configure your credentials by copying - distributions/common/dataportability.secrets.example.properties to - .gradle/dataportability.secrets.properties and inserting the API keys and secrets for - the services you with to interact with . + distributions/demo-server/env.secrets.template to env.secrets and inserting the
diff -- git a/Documentation/Integration.md b/Documentation/Integration.md index 7e0e85b..987127e 100644 -- - a/Documentation/Integration.md +++ b/Documentation/Integration.md @ @ -2,29 +2,111 @ @ This guide covers the following options for integrating your service , with the primary use case being the integration of a new transfer service . -* Integrate a new transfer service -* Integrate a new data type -* Integrate a new cloud provider +* [ Integrate a new transfer service ] ( # integrate-a-new-transfer-service ) +* [ Integrate a new data model ] ( # integrate-a-new-data-model ) +* [ Integrate a new cloud provider ] ( # integrate-a-new-cloud-provider ) # # Integrate a new transfer service -A new service can be integrated into the Data Transfer Project by creating a 1 ) Transfer Extension and 2 ) Auth Extension . - +A new service can be integrated into the Data Transfer Project by creating the following extensions : + +1 . Transfer Extension +1 . Auth Extension +1 . Optionally , a new Data Model may be required if your does not exist . Please see Integrate a new Data Model ( below ) for more information . + # # # Transfer Extension -* Transfer Extensions are located in the
diff -- git a/WORKSPACE b/WORKSPACE index 683f95a..a35d203 100644 -- - a/WORKSPACE +++ b/WORKSPACE @ @ -25,3 +25,8 @ @ maven_jar ( name = `` com_squareup_okio_okio_1_6_0 '' , artifact = `` com.squareup.okio : okio : jar:1.6.0 '' ) + +maven_jar ( + name = `` org_json_json_jar_20180130 '' , + artifact = `` org.json : json : jar:20180130 '' + ) diff -- git a/android/BUILD b/android/BUILD index b4a0ac3..37b29dc 100644 -- - a/android/BUILD +++ b/android/BUILD @ @ -1,16 +1,18 @ @ -py_binary ( - name = `` firestore_genrule_py_impl '' , - srcs = [ `` firestore_genrule_py_impl.py '' ] , +java_binary ( + name = `` firestore_genrule_java_impl '' , + srcs = [ `` FirestoreGenRuleImpl.java '' ] , data = [ `` google-services.json '' ] , + deps = [ `` @ org_json_json_jar_20180130//jar '' ] , + main_class = `` com.google.startupos.android.FirestoreGenRuleImpl '' ) genrule ( name = `` firestore-genrule '' , outs = [ `` FirestoreConfig.java '' ] , - cmd = `` python android/firestore_genrule_py_impl.py > $ ( @ ) '' , + cmd = `` java -jar ./bazel-out/host/bin/android/firestore_genrule_java_impl_deploy.jar > $ ( @ ) '' , tools = [ `` google-services.json '' , - `` : firestore_genrule_py_impl '' , + `` : firestore_genrule_java_impl_deploy.jar ''
diff -- git a/tools/reviewer/webapp/src/app/app-routing.module.ts b/tools/reviewer/webapp/src/app/app-routing.module.ts index 6518421..d5768cd 100644 -- - a/tools/reviewer/webapp/src/app/app-routing.module.ts +++ b/tools/reviewer/webapp/src/app/app-routing.module.ts @ @ -2,13 +2,10 @ @ import { NgModule } from ' @ angular/core ' ; import { PreloadAllModules , RouterModule , Routes } from ' @ angular/router ' ; import { AuthGuard } from ' @ /core ' ; +import { DiffModule , DiffsModule , FileChangesModule } from ' @ /dashboard ' ; import { LoginComponent } from './login ' ; import { PageNotFoundComponent } from './page-not-found ' ; -import { DiffModule } from './dashboard/diff/diff.module ' ; -import { DiffsModule } from './dashboard/diffs/diffs.module ' ; -import { FileChangesModule } from './dashboard/file-changes/file-changes.module ' ; - const routes : Routes = [ { path : `` , redirectTo : 'diffs ' , pathMatch : 'full ' } , { diff -- git a/tools/reviewer/webapp/src/app/core/services/index.ts b/tools/reviewer/webapp/src/app/core/services/index.ts index d0f8570..ffaed57 100644 -- - a/tools/reviewer/webapp/src/app/core/services/index.ts +++ b/tools/reviewer/webapp/src/app/core/services/index.ts @ @ -9,6 +9,7 @ @ export * from './localserver.service ' ; export * from './exception.service ' ; export * from './diff-update.service ' ; export * from './user.service ' ; +export * from './mouse.service ' ; export * from './select-dashboard.service ' ; // Services @ @ -21,6 +22,7 @ @ import { FirebaseStateService } from './firebase-state.service
diff -- git a/.circleci/config.yml b/.circleci/config.yml index ad6c24f..8004e3c 100644 -- - a/.circleci/config.yml +++ b/.circleci/config.yml @ @ -64,6 +64,8 @ @ jobs : key : `` android_sdk '' paths : - `` /home/circleci/android_sdk '' + + - save_cache : key : `` v3-bazel_cache '' paths : - `` /home/circleci/.cache/bazel/ ''
diff -- git a/tools/reviewer/local_server/service/code_review.proto b/tools/reviewer/local_server/service/code_review.proto index 1b6537a..337e2d1 100644 -- - a/tools/reviewer/local_server/service/code_review.proto +++ b/tools/reviewer/local_server/service/code_review.proto @ @ -81,7 +81,8 @ @ message Diff { string workspace = 8 ; int64 created_timestamp = 9 ; int64 modified_timestamp = 10 ; - repeated Thread thread = 13 ; + // Threads on a line . + repeated Thread code_thread = 13 ; repeated string cc = 14 ; // Threads on the whole diff , not on a particular file or line . repeated Thread diff_thread = 15 ; diff -- git a/tools/reviewer/webapp/README.md b/tools/reviewer/webapp/README.md index 9c987f0..dc3f36b 100644 -- - a/tools/reviewer/webapp/README.md +++ b/tools/reviewer/webapp/README.md @ @ -1,13 +1,23 @ @ + # # You need installed +Required to use Reviewer locally : + [ node ] ( https : //nodejs.org/ ) LTS + [ npm ] ( https : //www.npmjs.com/ ) + [ protoc ] ( https : //github.com/protocolbuffers/protobuf/releases ) +Optional : + [ firebase ] ( https : //firebase.google.com/docs/hosting/quickstart ) to be able to deploy . + [ angular ] ( https : //angular.io/ ) to use ` ng ` features . + # # For the first time -Run ` ng install ` for the first time . +Run ` npm install ` to
diff -- git a/tools/BUILD b/tools/BUILD index 32c2aff..546087b 100644 -- - a/tools/BUILD +++ b/tools/BUILD @ @ -2,7 +2,7 @ @ package ( default_visibility = [ `` //visibility : public '' ] ) sh_binary ( name = `` buildifier '' , - srcs = [ `` buildtools_wrappers/buildifier.sh '' ] , + srcs = [ `` bazel_tools/buildifier.sh '' ] , data = [ `` @ buildifier//file '' , `` @ buildifier_osx//file '' , @ @ -11,7 +11,7 @ @ sh_binary ( sh_binary ( name = `` buildozer '' , - srcs = [ `` buildtools_wrappers/buildozer.sh '' ] , + srcs = [ `` bazel_tools/buildozer.sh '' ] , data = [ `` @ buildozer//file '' , `` @ buildozer_osx//file '' , @ @ -20,7 +20,7 @ @ sh_binary ( sh_binary ( name = `` unused_deps '' , - srcs = [ `` buildtools_wrappers/unused_deps.sh '' ] , + srcs = [ `` bazel_tools/unused_deps.sh '' ] , data = [ `` @ unused_deps//file '' , `` @ unused_deps_osx//file '' , diff -- git a/tools/README.md b/tools/README.md index 744b90e..3041014 100644 -- - a/tools/README.md +++ b/tools/README.md @ @ -4,8 +4,8 @ @ We want to automate as much as possible . Here are some tools we use : *
diff -- git a/tools/reviewer/local_server/service/code_review.proto b/tools/reviewer/local_server/service/code_review.proto index 1b6537a..337e2d1 100644 -- - a/tools/reviewer/local_server/service/code_review.proto +++ b/tools/reviewer/local_server/service/code_review.proto @ @ -81,7 +81,8 @ @ message Diff { string workspace = 8 ; int64 created_timestamp = 9 ; int64 modified_timestamp = 10 ; - repeated Thread thread = 13 ; + // Threads on a line . + repeated Thread code_thread = 13 ; repeated string cc = 14 ; // Threads on the whole diff , not on a particular file or line . repeated Thread diff_thread = 15 ; diff -- git a/tools/reviewer/webapp/README.md b/tools/reviewer/webapp/README.md index 9c987f0..815eca9 100644 -- - a/tools/reviewer/webapp/README.md +++ b/tools/reviewer/webapp/README.md @ @ -1,13 +1,21 @ @ + # # You need installed + [ node ] ( https : //nodejs.org/ ) LTS + [ npm ] ( https : //www.npmjs.com/ ) + [ protoc ] ( https : //github.com/protocolbuffers/protobuf/releases ) +Optional : + [ firebase ] ( https : //firebase.google.com/docs/hosting/quickstart ) + [ angular ] ( https : //angular.io/ ) + # # For the first time -Run ` ng install ` for the first time . +Run ` npm install ` to install npm modules -Run ` npm run protoc ` to generate proto functions . -You need google-protobuf 3.5 or
diff -- git a/tools/completion.sh b/tools/completion.sh new file mode 100755 index 0000000..292dc34 -- - /dev/null +++ b/tools/completion.sh @ @ -0,0 +1,18 @ @ + # ! /bin/bash + +if [ [ `` $ ( basename -- `` $ 0 '' ) '' == `` completion.sh '' ] ] ; then + echo `` Do n't run $ 0 , source it '' > & 2 + exit 1 +fi + +platform= $ ( uname ) +if [ `` $ platform '' == `` Darwin '' ] ; then + echo `` Current OS is macOS , we assume you installed bazel via Homebrew '' + source $ ( brew -- prefix ) /etc/bash_completion.d/bazel-complete.bash +elif [ `` $ platform '' == `` Linux '' ] ; then + echo `` Current OS is Linux , we assume you installed bazel via APT '' + source /etc/bash_completion.d/bazel +else + echo `` Unknown platform '' + exit 1 +fi
diff -- git a/charts_flutter/docs/examples/a11ys/domain_a11y_explore_bar_chart.md b/charts_flutter/docs/examples/a11ys/domain_a11y_explore_bar_chart.md new file mode 100644 index 0000000..89e02ef -- - /dev/null +++ b/charts_flutter/docs/examples/a11ys/domain_a11y_explore_bar_chart.md @ @ -0,0 +1,157 @ @ + # Domain A11y Explore Bar Chart a11y Example + + ! [ ] ( domain_a11y_explore_bar_chart_full.png ) + +Example : + + `` ` +/// Example of a bar chart with domain selection A11y behavior . +/// +/// The OS screen reader ( TalkBack / VoiceOver ) setting must be turned on , or +/// the behavior does not do anything . +/// +/// Note that the screenshot does not show any visual differences but when the +/// OS screen reader is enabled , the node that is being read out loud will be +/// surrounded by a rectangle . +/// +/// When [ DomainA11yExploreBehavior ] is added to the chart , the chart will +/// listen for the gesture that triggers `` explore mode '' . +/// `` Explore mode '' creates semantic nodes for each domain value in the chart +/// with a description ( customizable , defaults to domain value ) and a bounding +/// box that surrounds the domain . +/// +/// These semantic node descriptions are read out loud by the OS screen
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index bd7c5bb..cccafb5 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -52,9 +52,10 @ @ export 'src/chart/common/chart_canvas.dart ' show ChartCanvas , FillPatternType ; export 'src/chart/common/chart_context.dart ' show ChartContext ; export 'src/chart/common/datum_details.dart' show DatumDetails , DomainFormatter , MeasureFormatter ; +export 'src/chart/common/processed_series.dart ' show ImmutableSeries ; export 'src/chart/common/selection_model/selection_model.dart' show SelectionModel , SelectionModelType , SelectionModelListener ; -export 'src/chart/common/series_renderer.dart ' show SeriesRenderer ; +export 'src/chart/common/series_renderer.dart ' show SeriesRenderer , rendererKey ; export 'src/chart/common/series_renderer_config.dart' show RendererAttributeKey , SeriesRendererConfig ; export 'src/chart/layout/layout_config.dart ' show LayoutConfig , MarginSpec ; @ @ -79,7 +80,11 @ @ export 'src/common/rtl_spec.dart ' show RTLSpec , AxisPosition ; export 'src/common/style/material_style.dart ' show MaterialStyle ; export 'src/common/style/style_factory.dart ' show StyleFactory ; export 'src/common/symbol_renderer.dart' - show SymbolRenderer , RoundedRectSymbolRenderer ; + show + SymbolRenderer , + RoundedRectSymbolRenderer , + LineSymbolRenderer , + PointSymbolRenderer ; export 'src/common/text_element.dart' show TextElement , TextDirection , MaxWidthStrategy ; export 'src/common/text_measurement.dart ' show TextMeasurement ; diff -- git a/charts_common/lib/src/chart/bar/base_bar_renderer.dart b/charts_common/lib/src/chart/bar/base_bar_renderer.dart index 83b65b8..9ebc045 100644 -- - a/charts_common/lib/src/chart/bar/base_bar_renderer.dart +++ b/charts_common/lib/src/chart/bar/base_bar_renderer.dart @ @ -27,7 +27,6 @ @ import '../common/chart_canvas.dart ' show ChartCanvas , FillPatternType ; import '../common/datum_details.dart ' show DatumDetails ; import '../common/processed_series.dart ' show ImmutableSeries , MutableSeries ; import '../../common/color.dart ' show Color ; -import '../../common/symbol_renderer.dart ' show
diff -- git a/charts_common/lib/src/chart/common/base_chart.dart b/charts_common/lib/src/chart/common/base_chart.dart index 78286dd..0e1a87e 100644 -- - a/charts_common/lib/src/chart/common/base_chart.dart +++ b/charts_common/lib/src/chart/common/base_chart.dart @ @ -34,6 +34,8 @ @ import '../../common/proxy_gesture_listener.dart ' show ProxyGestureListener ; import 'selection_model/selection_model.dart' show SelectionModel , SelectionModelType ; +typedef BehaviorCreator = ChartBehavior < T , D > Function < T , D > ( ) ; + abstract class BaseChart < T , D > { ChartContext context ; @ @ -192,6 +194,13 @ @ abstract class BaseChart < T , D > { // Behavior methods // + /// Helper method to create a behavior with congruent types . + /// + /// This invokes the provides helper with type parameters that match this + /// chart . + ChartBehavior < T , D > createBehavior ( BehaviorCreator creator ) = > + creator < T , D > ( ) ; + /// Attaches a behavior to the chart . /// /// Setting a new behavior with the same role as a behavior already attached diff -- git a/charts_common/lib/src/chart/pie/arc_renderer.dart b/charts_common/lib/src/chart/pie/arc_renderer.dart index f86dc89..83b6303 100644 -- - a/charts_common/lib/src/chart/pie/arc_renderer.dart +++ b/charts_common/lib/src/chart/pie/arc_renderer.dart @ @ -93,30 +93,49 @ @ class ArcRenderer < T , D > extends BaseSeriesRenderer < T , D > { var measures = [ ]
diff -- git a/.gitignore b/.gitignore index e2015c6..f4e5d61 100644 -- - a/.gitignore +++ b/.gitignore @ @ -1,3 +1,13 @ @ .bundle _site +.DS_Store +.dart_tool/ + +.packages +.pub/ + +build/ +**/ios/.generated/ +**/ios/Flutter/Generated.xcconfig +**/ios/Runner/GeneratedPluginRegistrant . *
diff -- git a/charts_common/lib/src/chart/cartesian/axis/simple_ordinal_scale.dart b/charts_common/lib/src/chart/cartesian/axis/simple_ordinal_scale.dart index 09be07d..7e67822 100644 -- - a/charts_common/lib/src/chart/cartesian/axis/simple_ordinal_scale.dart +++ b/charts_common/lib/src/chart/cartesian/axis/simple_ordinal_scale.dart @ @ -120,7 +120,7 @ @ class SimpleOrdinalScale implements OrdinalScale { ( _cachedStepSizePixels * i ) ; } // If it was n't found - return 0 ; + return 0.0 ; } @ override
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index faa8fa4..67d2e6d 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -40,8 +40,15 @ @ export 'src/chart/common/behavior/chart_behavior.dart' export 'src/chart/common/behavior/domain_highlighter.dart' show DomainHighlighter ; export 'src/chart/common/behavior/legend/legend.dart' - show LegendCellPadding , LegendState , SeriesLegend ; + show + Legend , + LegendCellPadding , + LegendState , + LegendTapHandling , + SeriesLegend ; export 'src/chart/common/behavior/legend/legend_entry.dart ' show LegendEntry ; +export 'src/chart/common/behavior/legend/legend_entry_generator.dart' + show LegendEntryGenerator ; export 'src/chart/common/behavior/line_point_highlighter.dart' show LinePointHighlighter ; export 'src/chart/common/behavior/range_annotation.dart' @ @ -72,6 +79,10 @ @ export 'src/chart/line/line_renderer_config.dart ' show LineRendererConfig ; export 'src/chart/pie/arc_renderer.dart ' show ArcRenderer ; export 'src/chart/pie/arc_renderer_config.dart ' show ArcRendererConfig ; export 'src/chart/pie/pie_chart.dart ' show PieChart ; +export 'src/chart/scatter_plot/point_renderer.dart ' show PointRenderer ; +export 'src/chart/scatter_plot/point_renderer_config.dart' + show PointRendererConfig ; +export 'src/chart/scatter_plot/scatter_plot_chart.dart ' show ScatterPlotChart ; export 'src/chart/time_series/time_series_chart.dart ' show TimeSeriesChart ; export 'src/common/color.dart ' show Color ; export 'src/common/date_time_factory.dart' diff -- git a/charts_common/lib/src/chart/bar/bar_renderer.dart b/charts_common/lib/src/chart/bar/bar_renderer.dart index 0fa8707..8521e00 100644 -- - a/charts_common/lib/src/chart/bar/bar_renderer.dart +++ b/charts_common/lib/src/chart/bar/bar_renderer.dart @ @ -57,11 +57,9 @ @ class BarRenderer < T , D > extends BaseBarRenderer < T , D , _BarRendererElement < T , D > , super ( config : config , rendererId : rendererId , layoutPositionOrder : 10 ) ; @ override - void preprocessSeries ( List < MutableSeries < T
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index faa8fa4..008273a 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -40,8 +40,15 @ @ export 'src/chart/common/behavior/chart_behavior.dart' export 'src/chart/common/behavior/domain_highlighter.dart' show DomainHighlighter ; export 'src/chart/common/behavior/legend/legend.dart' - show LegendCellPadding , LegendState , SeriesLegend ; + show + Legend , + LegendCellPadding , + LegendState , + LegendTapHandling , + SeriesLegend ; export 'src/chart/common/behavior/legend/legend_entry.dart ' show LegendEntry ; +export 'src/chart/common/behavior/legend/legend_entry_generator.dart' + show LegendEntryGenerator ; export 'src/chart/common/behavior/line_point_highlighter.dart' show LinePointHighlighter ; export 'src/chart/common/behavior/range_annotation.dart' @ @ -51,6 +58,8 @ @ export 'src/chart/common/behavior/select_nearest.dart' export 'src/chart/common/behavior/zoom/pan_and_zoom_behavior.dart' show PanAndZoomBehavior ; export 'src/chart/common/behavior/zoom/pan_behavior.dart ' show PanBehavior ; +export 'src/chart/common/behavior/zoom/panning_tick_provider.dart' + show PanningTickProviderMode ; export 'src/chart/common/canvas_shapes.dart' show CanvasBarStack , CanvasPie , CanvasPieSlice , CanvasRect ; export 'src/chart/common/chart_canvas.dart ' show ChartCanvas , FillPatternType ; @ @ -72,6 +81,10 @ @ export 'src/chart/line/line_renderer_config.dart ' show LineRendererConfig ; export 'src/chart/pie/arc_renderer.dart ' show ArcRenderer ; export 'src/chart/pie/arc_renderer_config.dart ' show ArcRendererConfig ; export 'src/chart/pie/pie_chart.dart ' show PieChart ; +export 'src/chart/scatter_plot/point_renderer.dart ' show PointRenderer ; +export 'src/chart/scatter_plot/point_renderer_config.dart' + show PointRendererConfig ; +export 'src/chart/scatter_plot/scatter_plot_chart.dart ' show ScatterPlotChart ; export 'src/chart/time_series/time_series_chart.dart ' show TimeSeriesChart ; export 'src/common/color.dart ' show Color ; export 'src/common/date_time_factory.dart' diff -- git a/charts_common/lib/src/chart/bar/bar_renderer.dart b/charts_common/lib/src/chart/bar/bar_renderer.dart index 0fa8707..cd03c77 100644 -- - a/charts_common/lib/src/chart/bar/bar_renderer.dart +++ b/charts_common/lib/src/chart/bar/bar_renderer.dart @ @ -57,11 +57,9 @ @ class BarRenderer <
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index faa8fa4..7e26415 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -39,9 +39,18 @ @ export 'src/chart/common/behavior/chart_behavior.dart' OutsideJustification ; export 'src/chart/common/behavior/domain_highlighter.dart' show DomainHighlighter ; +export 'src/chart/common/behavior/initial_selection.dart' + show InitialSelection , SeriesDatumConfig ; export 'src/chart/common/behavior/legend/legend.dart' - show LegendCellPadding , LegendState , SeriesLegend ; + show + Legend , + LegendCellPadding , + LegendState , + LegendTapHandling , + SeriesLegend ; export 'src/chart/common/behavior/legend/legend_entry.dart ' show LegendEntry ; +export 'src/chart/common/behavior/legend/legend_entry_generator.dart' + show LegendEntryGenerator ; export 'src/chart/common/behavior/line_point_highlighter.dart' show LinePointHighlighter ; export 'src/chart/common/behavior/range_annotation.dart' @ @ -51,6 +60,8 @ @ export 'src/chart/common/behavior/select_nearest.dart' export 'src/chart/common/behavior/zoom/pan_and_zoom_behavior.dart' show PanAndZoomBehavior ; export 'src/chart/common/behavior/zoom/pan_behavior.dart ' show PanBehavior ; +export 'src/chart/common/behavior/zoom/panning_tick_provider.dart' + show PanningTickProviderMode ; export 'src/chart/common/canvas_shapes.dart' show CanvasBarStack , CanvasPie , CanvasPieSlice , CanvasRect ; export 'src/chart/common/chart_canvas.dart ' show ChartCanvas , FillPatternType ; @ @ -72,6 +83,10 @ @ export 'src/chart/line/line_renderer_config.dart ' show LineRendererConfig ; export 'src/chart/pie/arc_renderer.dart ' show ArcRenderer ; export 'src/chart/pie/arc_renderer_config.dart ' show ArcRendererConfig ; export 'src/chart/pie/pie_chart.dart ' show PieChart ; +export 'src/chart/scatter_plot/point_renderer.dart ' show PointRenderer ; +export 'src/chart/scatter_plot/point_renderer_config.dart' + show PointRendererConfig ; +export 'src/chart/scatter_plot/scatter_plot_chart.dart ' show ScatterPlotChart ; export 'src/chart/time_series/time_series_chart.dart ' show TimeSeriesChart ; export 'src/common/color.dart ' show Color ; export 'src/common/date_time_factory.dart' @ @ -90,7 +105,7 @ @ export 'src/common/symbol_renderer.dart' SymbolRenderer , RoundedRectSymbolRenderer ,
diff -- git a/README.md b/README.md index a6159cd..9a41b4d 100644 -- - a/README.md +++ b/README.md @ @ -1,6 +1,9 @ @ Charts is a general charting library , currently enabled for the [ Flutter mobile UI framework ] ( https : //flutter.io ) . +See the [ online gallery ] ( https : //google.github.io/charts/flutter/gallery.html ) for supported chart +types and examples of how to custom components of the chart . + *Note* : This is not an official Google product . [ ! [ Travis CI Build Status ] ( https : //travis-ci.org/google/charts.svg ? branch=master ) ] ( https : //travis-ci.org/google/charts ) diff -- git a/charts_common/CHANGELOG.md b/charts_common/CHANGELOG.md index fffd38b..917b6c6 100644 -- - a/charts_common/CHANGELOG.md +++ b/charts_common/CHANGELOG.md @ @ -1,3 +1,13 @ @ + # 0.3.0-dev +* Simplified API by removing the requirement for specifying the datum type when creating a chart . +For example , previously to construct a bar chart the syntax was 'new BarChart < MyDatumType > ( ) ' . +The syntax is now cleaned up to be 'new BarChart ( ) ' . Please refer to the + [ online gallery ] ( https : //google.github.io/charts/flutter/gallery.html ) for the correct syntax . +* Added scatter plot charts +* Added
diff -- git a/charts_flutter/README.md b/charts_flutter/README.md index f2aaa79..f7700b7 100644 -- - a/charts_flutter/README.md +++ b/charts_flutter/README.md @ @ -1,3 +1,12 @ @ # Flutter Charting library Material Design data visualization library written natively in Dart . + + # # Supported charts + +See the [ online gallery ] ( https : //google.github.io/charts/flutter/gallery.html ) . + + # # Using the library + +The ` /example/ ` folder inside ` charts_flutter ` in the [ GitHub repo ] ( https : //github.com/google/charts ) +contains a full Flutter app with many demo examples . diff -- git a/charts_flutter/pubspec.yaml b/charts_flutter/pubspec.yaml index b77c4ba..c292505 100644 -- - a/charts_flutter/pubspec.yaml +++ b/charts_flutter/pubspec.yaml @ @ -1,5 +1,5 @ @ name : charts_flutter -version : 0.0.1 +version : 0.0.1+1 description : Material Design charting library for flutter . author : Charts Team < charts_flutter @ google.com > homepage : https : //github.com/google/charts
diff -- git a/charts_common/CHANGELOG.md b/charts_common/CHANGELOG.md new file mode 100644 index 0000000..f683734 -- - /dev/null +++ b/charts_common/CHANGELOG.md @ @ -0,0 +1,7 @ @ + # 0.2.0-dev + +* Update color palette . + + # 0.1.0 + +Initial release . diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index bd7c5bb..cccafb5 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -52,9 +52,10 @ @ export 'src/chart/common/chart_canvas.dart ' show ChartCanvas , FillPatternType ; export 'src/chart/common/chart_context.dart ' show ChartContext ; export 'src/chart/common/datum_details.dart' show DatumDetails , DomainFormatter , MeasureFormatter ; +export 'src/chart/common/processed_series.dart ' show ImmutableSeries ; export 'src/chart/common/selection_model/selection_model.dart' show SelectionModel , SelectionModelType , SelectionModelListener ; -export 'src/chart/common/series_renderer.dart ' show SeriesRenderer ; +export 'src/chart/common/series_renderer.dart ' show SeriesRenderer , rendererKey ; export 'src/chart/common/series_renderer_config.dart' show RendererAttributeKey , SeriesRendererConfig ; export 'src/chart/layout/layout_config.dart ' show LayoutConfig , MarginSpec ; @ @ -79,7 +80,11 @ @ export 'src/common/rtl_spec.dart ' show RTLSpec , AxisPosition ; export 'src/common/style/material_style.dart ' show MaterialStyle ; export 'src/common/style/style_factory.dart ' show StyleFactory ; export 'src/common/symbol_renderer.dart' - show SymbolRenderer , RoundedRectSymbolRenderer ; + show + SymbolRenderer , + RoundedRectSymbolRenderer , + LineSymbolRenderer , + PointSymbolRenderer ; export 'src/common/text_element.dart' show TextElement , TextDirection , MaxWidthStrategy ; export 'src/common/text_measurement.dart ' show TextMeasurement ; diff -- git a/charts_common/lib/src/chart/bar/bar_label_decorator.dart b/charts_common/lib/src/chart/bar/bar_label_decorator.dart index a545052..5e7db65 100644 -- - a/charts_common/lib/src/chart/bar/bar_label_decorator.dart +++
diff -- git a/charts_common/lib/src/chart/common/base_chart.dart b/charts_common/lib/src/chart/common/base_chart.dart index 78286dd..0e1a87e 100644 -- - a/charts_common/lib/src/chart/common/base_chart.dart +++ b/charts_common/lib/src/chart/common/base_chart.dart @ @ -34,6 +34,8 @ @ import '../../common/proxy_gesture_listener.dart ' show ProxyGestureListener ; import 'selection_model/selection_model.dart' show SelectionModel , SelectionModelType ; +typedef BehaviorCreator = ChartBehavior < T , D > Function < T , D > ( ) ; + abstract class BaseChart < T , D > { ChartContext context ; @ @ -192,6 +194,13 @ @ abstract class BaseChart < T , D > { // Behavior methods // + /// Helper method to create a behavior with congruent types . + /// + /// This invokes the provides helper with type parameters that match this + /// chart . + ChartBehavior < T , D > createBehavior ( BehaviorCreator creator ) = > + creator < T , D > ( ) ; + /// Attaches a behavior to the chart . /// /// Setting a new behavior with the same role as a behavior already attached diff -- git a/charts_common/lib/src/chart/pie/arc_renderer.dart b/charts_common/lib/src/chart/pie/arc_renderer.dart index f86dc89..83b6303 100644 -- - a/charts_common/lib/src/chart/pie/arc_renderer.dart +++ b/charts_common/lib/src/chart/pie/arc_renderer.dart @ @ -93,30 +93,49 @ @ class ArcRenderer < T , D > extends BaseSeriesRenderer < T , D > { var measures = [ ]
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index faa8fa4..684459b 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -40,8 +40,15 @ @ export 'src/chart/common/behavior/chart_behavior.dart' export 'src/chart/common/behavior/domain_highlighter.dart' show DomainHighlighter ; export 'src/chart/common/behavior/legend/legend.dart' - show LegendCellPadding , LegendState , SeriesLegend ; + show + Legend , + LegendCellPadding , + LegendState , + LegendTapHandling , + SeriesLegend ; export 'src/chart/common/behavior/legend/legend_entry.dart ' show LegendEntry ; +export 'src/chart/common/behavior/legend/legend_entry_generator.dart' + show LegendEntryGenerator ; export 'src/chart/common/behavior/line_point_highlighter.dart' show LinePointHighlighter ; export 'src/chart/common/behavior/range_annotation.dart' diff -- git a/charts_common/lib/src/chart/bar/bar_renderer.dart b/charts_common/lib/src/chart/bar/bar_renderer.dart index 0fa8707..8521e00 100644 -- - a/charts_common/lib/src/chart/bar/bar_renderer.dart +++ b/charts_common/lib/src/chart/bar/bar_renderer.dart @ @ -57,11 +57,9 @ @ class BarRenderer < T , D > extends BaseBarRenderer < T , D , _BarRendererElement < T , D > , super ( config : config , rendererId : rendererId , layoutPositionOrder : 10 ) ; @ override - void preprocessSeries ( List < MutableSeries < T , D > > seriesList ) { + void configureSeries ( List < MutableSeries < T , D > > seriesList ) { assignMissingColors ( getOrderedSeriesList ( seriesList ) , emptyCategoryUsesSinglePalette : true ) ; - - super.preprocessSeries ( seriesList ) ; } @ override diff -- git a/charts_common/lib/src/chart/bar/bar_target_line_renderer.dart b/charts_common/lib/src/chart/bar/bar_target_line_renderer.dart index b2ea1d7..97fbb5a 100644 -- - a/charts_common/lib/src/chart/bar/bar_target_line_renderer.dart +++ b/charts_common/lib/src/chart/bar/bar_target_line_renderer.dart @ @ -50,12 +50,11
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index faa8fa4..008273a 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -40,8 +40,15 @ @ export 'src/chart/common/behavior/chart_behavior.dart' export 'src/chart/common/behavior/domain_highlighter.dart' show DomainHighlighter ; export 'src/chart/common/behavior/legend/legend.dart' - show LegendCellPadding , LegendState , SeriesLegend ; + show + Legend , + LegendCellPadding , + LegendState , + LegendTapHandling , + SeriesLegend ; export 'src/chart/common/behavior/legend/legend_entry.dart ' show LegendEntry ; +export 'src/chart/common/behavior/legend/legend_entry_generator.dart' + show LegendEntryGenerator ; export 'src/chart/common/behavior/line_point_highlighter.dart' show LinePointHighlighter ; export 'src/chart/common/behavior/range_annotation.dart' @ @ -51,6 +58,8 @ @ export 'src/chart/common/behavior/select_nearest.dart' export 'src/chart/common/behavior/zoom/pan_and_zoom_behavior.dart' show PanAndZoomBehavior ; export 'src/chart/common/behavior/zoom/pan_behavior.dart ' show PanBehavior ; +export 'src/chart/common/behavior/zoom/panning_tick_provider.dart' + show PanningTickProviderMode ; export 'src/chart/common/canvas_shapes.dart' show CanvasBarStack , CanvasPie , CanvasPieSlice , CanvasRect ; export 'src/chart/common/chart_canvas.dart ' show ChartCanvas , FillPatternType ; @ @ -72,6 +81,10 @ @ export 'src/chart/line/line_renderer_config.dart ' show LineRendererConfig ; export 'src/chart/pie/arc_renderer.dart ' show ArcRenderer ; export 'src/chart/pie/arc_renderer_config.dart ' show ArcRendererConfig ; export 'src/chart/pie/pie_chart.dart ' show PieChart ; +export 'src/chart/scatter_plot/point_renderer.dart ' show PointRenderer ; +export 'src/chart/scatter_plot/point_renderer_config.dart' + show PointRendererConfig ; +export 'src/chart/scatter_plot/scatter_plot_chart.dart ' show ScatterPlotChart ; export 'src/chart/time_series/time_series_chart.dart ' show TimeSeriesChart ; export 'src/common/color.dart ' show Color ; export 'src/common/date_time_factory.dart' diff -- git a/charts_common/lib/src/chart/bar/bar_renderer.dart b/charts_common/lib/src/chart/bar/bar_renderer.dart index 0fa8707..cd03c77 100644 -- - a/charts_common/lib/src/chart/bar/bar_renderer.dart +++ b/charts_common/lib/src/chart/bar/bar_renderer.dart @ @ -57,11 +57,9 @ @ class BarRenderer <
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index faa8fa4..008273a 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -40,8 +40,15 @ @ export 'src/chart/common/behavior/chart_behavior.dart' export 'src/chart/common/behavior/domain_highlighter.dart' show DomainHighlighter ; export 'src/chart/common/behavior/legend/legend.dart' - show LegendCellPadding , LegendState , SeriesLegend ; + show + Legend , + LegendCellPadding , + LegendState , + LegendTapHandling , + SeriesLegend ; export 'src/chart/common/behavior/legend/legend_entry.dart ' show LegendEntry ; +export 'src/chart/common/behavior/legend/legend_entry_generator.dart' + show LegendEntryGenerator ; export 'src/chart/common/behavior/line_point_highlighter.dart' show LinePointHighlighter ; export 'src/chart/common/behavior/range_annotation.dart' @ @ -51,6 +58,8 @ @ export 'src/chart/common/behavior/select_nearest.dart' export 'src/chart/common/behavior/zoom/pan_and_zoom_behavior.dart' show PanAndZoomBehavior ; export 'src/chart/common/behavior/zoom/pan_behavior.dart ' show PanBehavior ; +export 'src/chart/common/behavior/zoom/panning_tick_provider.dart' + show PanningTickProviderMode ; export 'src/chart/common/canvas_shapes.dart' show CanvasBarStack , CanvasPie , CanvasPieSlice , CanvasRect ; export 'src/chart/common/chart_canvas.dart ' show ChartCanvas , FillPatternType ; @ @ -72,6 +81,10 @ @ export 'src/chart/line/line_renderer_config.dart ' show LineRendererConfig ; export 'src/chart/pie/arc_renderer.dart ' show ArcRenderer ; export 'src/chart/pie/arc_renderer_config.dart ' show ArcRendererConfig ; export 'src/chart/pie/pie_chart.dart ' show PieChart ; +export 'src/chart/scatter_plot/point_renderer.dart ' show PointRenderer ; +export 'src/chart/scatter_plot/point_renderer_config.dart' + show PointRendererConfig ; +export 'src/chart/scatter_plot/scatter_plot_chart.dart ' show ScatterPlotChart ; export 'src/chart/time_series/time_series_chart.dart ' show TimeSeriesChart ; export 'src/common/color.dart ' show Color ; export 'src/common/date_time_factory.dart' diff -- git a/charts_common/lib/src/chart/bar/bar_chart.dart b/charts_common/lib/src/chart/bar/bar_chart.dart index 6855ef5..854361c 100644 -- - a/charts_common/lib/src/chart/bar/bar_chart.dart +++ b/charts_common/lib/src/chart/bar/bar_chart.dart @ @ -18,13 +18,13 @ @ import '../cartesian/cartesian_chart.dart '
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index faa8fa4..7e26415 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -39,9 +39,18 @ @ export 'src/chart/common/behavior/chart_behavior.dart' OutsideJustification ; export 'src/chart/common/behavior/domain_highlighter.dart' show DomainHighlighter ; +export 'src/chart/common/behavior/initial_selection.dart' + show InitialSelection , SeriesDatumConfig ; export 'src/chart/common/behavior/legend/legend.dart' - show LegendCellPadding , LegendState , SeriesLegend ; + show + Legend , + LegendCellPadding , + LegendState , + LegendTapHandling , + SeriesLegend ; export 'src/chart/common/behavior/legend/legend_entry.dart ' show LegendEntry ; +export 'src/chart/common/behavior/legend/legend_entry_generator.dart' + show LegendEntryGenerator ; export 'src/chart/common/behavior/line_point_highlighter.dart' show LinePointHighlighter ; export 'src/chart/common/behavior/range_annotation.dart' @ @ -51,6 +60,8 @ @ export 'src/chart/common/behavior/select_nearest.dart' export 'src/chart/common/behavior/zoom/pan_and_zoom_behavior.dart' show PanAndZoomBehavior ; export 'src/chart/common/behavior/zoom/pan_behavior.dart ' show PanBehavior ; +export 'src/chart/common/behavior/zoom/panning_tick_provider.dart' + show PanningTickProviderMode ; export 'src/chart/common/canvas_shapes.dart' show CanvasBarStack , CanvasPie , CanvasPieSlice , CanvasRect ; export 'src/chart/common/chart_canvas.dart ' show ChartCanvas , FillPatternType ; @ @ -72,6 +83,10 @ @ export 'src/chart/line/line_renderer_config.dart ' show LineRendererConfig ; export 'src/chart/pie/arc_renderer.dart ' show ArcRenderer ; export 'src/chart/pie/arc_renderer_config.dart ' show ArcRendererConfig ; export 'src/chart/pie/pie_chart.dart ' show PieChart ; +export 'src/chart/scatter_plot/point_renderer.dart ' show PointRenderer ; +export 'src/chart/scatter_plot/point_renderer_config.dart' + show PointRendererConfig ; +export 'src/chart/scatter_plot/scatter_plot_chart.dart ' show ScatterPlotChart ; export 'src/chart/time_series/time_series_chart.dart ' show TimeSeriesChart ; export 'src/common/color.dart ' show Color ; export 'src/common/date_time_factory.dart' @ @ -90,7 +105,7 @ @ export 'src/common/symbol_renderer.dart' SymbolRenderer , RoundedRectSymbolRenderer ,
diff -- git a/charts_common/README.md b/charts_common/README.md index 607a5e8..f7e5eee 100644 -- - a/charts_common/README.md +++ b/charts_common/README.md @ @ -1,3 +1,5 @ @ # Common Charting library + [ ! [ pub package ] ( https : //img.shields.io/pub/v/charts_common.svg ) ] ( https : //pub.dartlang.org/packages/charts_common ) + Common componnets for charting libraries . diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index d9a01dd..bd7c5bb 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -13,25 +13,24 @ @ // See the License for the specific language governing permissions and // limitations under the License . -export 'src/chart/common/behavior/chart_behavior.dart ' show ChartBehavior ; +export 'src/chart/bar/bar_chart.dart ' show BarChart ; +export 'src/chart/bar/bar_label_decorator.dart ' show BarLabelDecorator ; +export 'src/chart/bar/bar_renderer.dart' + show BarRenderer , ImmutableBarRendererElement ; +export 'src/chart/bar/bar_renderer_config.dart ' show BarRendererConfig ; +export 'src/chart/bar/bar_renderer_decorator.dart ' show BarRendererDecorator ; +export 'src/chart/bar/base_bar_renderer_config.dart' + show BarGroupingType , BaseBarRendererConfig ; +export 'src/chart/cartesian/axis/axis.dart ' show domainAxisKey , measureAxisKey ; +export 'src/chart/cartesian/axis/spec/axis_spec.dart ' show AxisSpec ; +export 'src/chart/cartesian/cartesian_chart.dart ' show CartesianChart ; +export 'src/chart/cartesian/cartesian_renderer.dart ' show BaseCartesianRenderer ; +export 'src/chart/common/base_chart.dart ' show BaseChart , LifecycleListener ; export 'src/chart/common/behavior/a11y/a11y_explore_behavior.dart' show ExploreModeTrigger ; export 'src/chart/common/behavior/a11y/a11y_node.dart ' show A11yNode ; export 'src/chart/common/behavior/a11y/domain_a11y_explore_behavior.dart' show DomainA11yExploreBehavior , VocalizationCallback ; -export 'src/chart/common/behavior/zoom/pan_and_zoom_behavior.dart' - show PanAndZoomBehavior ; -export 'src/chart/common/behavior/zoom/pan_behavior.dart ' show PanBehavior ; -export 'src/chart/common/chart_canvas.dart ' show ChartCanvas ,
diff -- git a/charts_flutter/lib/src/canvas/circle_sector_painter.dart b/charts_flutter/lib/src/canvas/circle_sector_painter.dart index 010fbe7..13ac6c7 100644 -- - a/charts_flutter/lib/src/canvas/circle_sector_painter.dart +++ b/charts_flutter/lib/src/canvas/circle_sector_painter.dart @ @ -16,6 +16,7 @ @ import 'dart : math ' show cos , sin , Point ; import 'package : flutter/material.dart ' ; import 'package : charts_common/common.dart ' as common show Color ; +import 'dart : math ' show PI ; /// Draws a sector of a circle , with an optional hole in the center . class CircleSectorPainter { @ @ -46,13 +47,19 @ @ class CircleSectorPainter { paint.color = new Color.fromARGB ( fill.a , fill.r , fill.g , fill.b ) ; paint.style = PaintingStyle.fill ; + // Make sure that the complete circle range for one item is not more than + // or equals 2 times PI . Otherwise the circle is not drawn . + final fixedEndAngle = startAngle ! = null & & endAngle ! = null + & & endAngle - startAngle > = 2 * PI + ? ( 2 * PI - startAngle.abs ( ) - PI * 0.001 ) : endAngle ; + final innerRadiusStartPoint = new Point < double > ( innerRadius * cos ( startAngle ) + center.x , innerRadius * sin ( startAngle )
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index 7e26415..0a4796d 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -23,7 +23,8 @ @ export 'src/chart/bar/base_bar_renderer_config.dart' show BarGroupingType , BaseBarRendererConfig ; export 'src/chart/cartesian/axis/axis.dart ' show domainAxisKey , measureAxisKey ; export 'src/chart/cartesian/axis/spec/axis_spec.dart ' show AxisSpec ; -export 'src/chart/cartesian/cartesian_chart.dart ' show CartesianChart ; +export 'src/chart/cartesian/cartesian_chart.dart' + show CartesianChart , NumericCartesianChart , OrdinalCartesianChart ; export 'src/chart/cartesian/cartesian_renderer.dart ' show BaseCartesianRenderer ; export 'src/chart/common/base_chart.dart ' show BaseChart , LifecycleListener ; export 'src/chart/common/behavior/a11y/a11y_explore_behavior.dart' @ @ -37,6 +38,8 @ @ export 'src/chart/common/behavior/chart_behavior.dart' ChartBehavior , InsideJustification , OutsideJustification ; +export 'src/chart/common/behavior/calculation/percent_injector.dart' + show PercentInjector , PercentInjectorTotalType ; export 'src/chart/common/behavior/domain_highlighter.dart' show DomainHighlighter ; export 'src/chart/common/behavior/initial_selection.dart' @ @ -52,14 +55,24 @ @ export 'src/chart/common/behavior/legend/legend_entry.dart ' show LegendEntry ; export 'src/chart/common/behavior/legend/legend_entry_generator.dart' show LegendEntryGenerator ; export 'src/chart/common/behavior/line_point_highlighter.dart' - show LinePointHighlighter ; + show LinePointHighlighter , LinePointHighlighterFollowLineType ; export 'src/chart/common/behavior/range_annotation.dart' show RangeAnnotation , RangeAnnotationAxisType , RangeAnnotationSegment ; -export 'src/chart/common/behavior/select_nearest.dart' - show SelectNearest , SelectNearestTrigger ; +export 'src/chart/common/behavior/sliding_viewport.dart ' show SlidingViewport ; +export 'src/chart/common/behavior/selection/lock_selection.dart' + show LockSelection ; +export 'src/chart/common/behavior/selection/select_nearest.dart' + show SelectNearest ; +export 'src/chart/common/behavior/selection/selection_trigger.dart' + show SelectionTrigger ; +export 'src/chart/common/behavior/slider/slider.dart' + show Slider , SliderListenerCallback , SliderListenerDragState , SliderStyle ; +export 'src/chart/common/behavior/zoom/initial_hint_behavior.dart' + show InitialHintBehavior ; export 'src/chart/common/behavior/zoom/pan_and_zoom_behavior.dart' show PanAndZoomBehavior ; -export 'src/chart/common/behavior/zoom/pan_behavior.dart ' show PanBehavior ;
diff -- git a/.travis.yml b/.travis.yml new file mode 100644 index 0000000..3db8c87 -- - /dev/null +++ b/.travis.yml @ @ -0,0 +1,29 @ @ +matrix : + include : + # Job 1 ) Run tests + - os : linux + env : + - SHARD=Tests + sudo : false + addons : + apt : + # Flutter depends on /usr/lib/x86_64-linux-gnu/libstdc++.so.6 version GLIBCXX_3.4.18 + sources : + - ubuntu-toolchain-r-test # if we do n't specify this , the libstdc++6 we get is the wrong version + packages : + - libstdc++6 + - fonts-droid + before_script : + - git clone https : //github.com/flutter/flutter.git + - export PATH= ` pwd ` /flutter/bin : ` pwd ` /flutter/bin/cache/dart-sdk/bin : $ PATH + - flutter doctor + script : + - cd charts_common + - pub get + - pub run test + - cd ../charts_flutter + - flutter test + +cache : + directories : + - $ HOME/.pub-cache \ No newline at end of file
diff -- git a/charts_common/lib/src/chart/cartesian/axis/spec/date_time_axis_spec.dart b/charts_common/lib/src/chart/cartesian/axis/spec/date_time_axis_spec.dart index c719d64..39d6961 100644 -- - a/charts_common/lib/src/chart/cartesian/axis/spec/date_time_axis_spec.dart +++ b/charts_common/lib/src/chart/cartesian/axis/spec/date_time_axis_spec.dart @ @ -19,6 +19,9 @ @ import '../../../common/chart_context.dart ' show ChartContext ; import '../static_tick_provider.dart ' show StaticTickProvider ; import '../time/auto_adjusting_date_time_tick_provider.dart' show AutoAdjustingDateTimeTickProvider ; +import '../time/time_range_tick_provider_impl.dart' + show TimeRangeTickProviderImpl ; +import '../time/day_time_stepper.dart ' show DayTimeStepper ; import '../time/date_time_tick_formatter.dart ' show DateTimeTickFormatter ; import '../time/hour_tick_formatter.dart ' show HourTickFormatter ; import '../time/time_tick_formatter.dart ' show TimeTickFormatter ; @ @ -98,6 +101,26 @ @ class AutoDateTimeTickProviderSpec implements DateTimeTickProviderSpec { int get hashCode = > includeTime ? .hashCode ? ? 0 ; } +/// [ TickProviderSpec ] that sets up time ticks with days increments only . + @ immutable +class DayTickProviderSpec implements DateTimeTickProviderSpec { + final List < int > increments ; + DayTickProviderSpec ( { this.increments } ) ; + + /// Creates a [ TickProviderSpec ] that dynamically chooses ticks based on the + /// extents of the data , limited to day increments . + /// + /// [ increments ] specify the number of day increments that can be chosen from + /// when searching for the appropriate tick intervals . + @ override + AutoAdjustingDateTimeTickProvider createTickProvider ( ChartContext context ) { + return new AutoAdjustingDateTimeTickProvider.createWith ( [
diff -- git a/charts_common/lib/src/chart/bar/bar_renderer.dart b/charts_common/lib/src/chart/bar/bar_renderer.dart index c342b1a..29b3bcf 100644 -- - a/charts_common/lib/src/chart/bar/bar_renderer.dart +++ b/charts_common/lib/src/chart/bar/bar_renderer.dart @ @ -385,9 +385,11 @ @ class BarRenderer < D > var bounds ; if ( this.renderingVertically ) { + // Rectangle clamps to zero width/height bounds = new Rectangle < int > ( domainStart , measureEnd , domainEnd - domainStart , measureStart - measureEnd ) ; } else { + // Rectangle clamps to zero width/height bounds = new Rectangle < int > ( min ( measureStart , measureEnd ) , domainStart , ( measureEnd - measureStart ) .abs ( ) , domainEnd - domainStart ) ; } diff -- git a/charts_common/lib/src/chart/bar/bar_target_line_renderer.dart b/charts_common/lib/src/chart/bar/bar_target_line_renderer.dart index bdf088d..eb2fab7 100644 -- - a/charts_common/lib/src/chart/bar/bar_target_line_renderer.dart +++ b/charts_common/lib/src/chart/bar/bar_target_line_renderer.dart @ @ -47,15 +47,15 @ @ class BarTargetLineRenderer < D > extends BaseBarRenderer < D , final _color = new Color ( r : 0 , g : 0 , b : 0 , a : 153 ) ; factory BarTargetLineRenderer ( - { BarTargetLineRendererConfig config , + { BarTargetLineRendererConfig < D > config , String rendererId = 'barTargetLine ' } ) { - config ? ? = new BarTargetLineRendererConfig ( ) ; + config ? ? = new BarTargetLineRendererConfig < D > ( )
diff -- git a/appveyor.yml b/appveyor.yml new file mode 100644 index 0000000..fb66808 -- - /dev/null +++ b/appveyor.yml @ @ -0,0 +1,108 @ @ +environment : + ANDROID_HOME : `` C : \\android-sdk-windows '' + ANDROID_NDK_HOME : `` C : \\android-ndk-r11c '' + JAVA_HOME : `` C : \\Program Files\\Java\\jdk1.8.0 '' + BORINGSSL_HOME : `` C : \\boringssl '' + ANDROID_TOOLS_URL : `` https : //dl.google.com/android/repository/tools_r25.2.3-windows.zip '' + ANDROID_NDK_URL : `` https : //dl.google.com/android/repository/android-ndk-r11c-windows-x86_64.zip '' + NINJA_URL : `` https : //github.com/ninja-build/ninja/releases/download/v1.6.0/ninja-win.zip '' + CMAKE_URL : `` https : //cmake.org/files/v3.4/cmake-3.4.0-win32-x86.zip '' + MSVC : `` 14.0 '' + +clone_folder : `` C : \\projects\\conscrypt '' +shallow_clone : true + +os : Visual Studio 2015 + +platform : + - x86 + - x64 + +version : ' { branch } . { build } ' + +pull_requests : + do_not_increment_build_number : true + +build : + verbosity : minimal + +init : + # Download the Android SDK + - appveyor DownloadFile % ANDROID_TOOLS_URL % -FileName android-tools.zip + - 7z x android-tools.zip -o '' % ANDROID_HOME % '' > nul + + # Download the Android NDK + - appveyor DownloadFile % ANDROID_NDK_URL % -FileName android-ndk.zip + - 7z x android-ndk.zip >
diff -- git a/common/src/jni/main/cpp/org_conscrypt_NativeCrypto.cpp b/common/src/jni/main/cpp/org_conscrypt_NativeCrypto.cpp index 68195d3..753de51 100644 -- - a/common/src/jni/main/cpp/org_conscrypt_NativeCrypto.cpp +++ b/common/src/jni/main/cpp/org_conscrypt_NativeCrypto.cpp @ @ -31,6 +31,13 @ @ # include `` macros.h '' # ifdef _WIN32 +// Needed for inet_ntop + # define _WIN32_WINNT _WIN32_WINNT_WIN8 + # include < ws2ipdef.h > + # include < ws2tcpip.h > + # pragma comment ( lib , `` ws2_32.lib '' ) + + # include < io.h > # include < winsock2.h > # else # include < arpa/inet.h > @ @ -993,6 +1000,14 @ @ void init_engine_globals ( ) { * Copied from libnativehelper NetworkUtilites.cpp */ static bool setBlocking ( int fd , bool blocking ) { + # ifdef _WIN32 + unsigned long flag = blocking ? 0UL : 1UL ; + int res = ioctlsocket ( fd , FIONBIO , & flag ) ; + if ( res ! = NO_ERROR ) { + JNI_TRACE ( `` ioctlsocket % d failed with error : % d '' , fd , WSAGetLastError ( ) ) ; + } + return res == NO_ERROR ; + # else int flags = fcntl ( fd , F_GETFL ) ; if ( flags == -1 ) { return false ; @ @ -1004,8
diff -- git a/common/src/jni/main/cpp/conscrypt/native_crypto.cc b/common/src/jni/main/cpp/conscrypt/native_crypto.cc index cf56a74..a50b391 100644 -- - a/common/src/jni/main/cpp/conscrypt/native_crypto.cc +++ b/common/src/jni/main/cpp/conscrypt/native_crypto.cc @ @ -6386,7 +6386,7 @ @ static jlong NativeCrypto_SSL_new ( JNIEnv* env , jclass , jlong ssl_ctx_address ) { return ( jlong ) ssl.release ( ) ; } -static void NativeCrypto_SSL_enable_tls_channel_id ( JNIEnv* env , jclass , jlong ssl_address ) { +static void NativeCrypto_SSL_enable_tls_channel_id ( JNIEnv* env , jclass , jlong ssl_address , jobject ssl_holder ) { SSL* ssl = to_SSL ( env , ssl_address , true ) ; JNI_TRACE ( `` ssl= % p NativeCrypto_NativeCrypto_SSL_enable_tls_channel_id '' , ssl ) ; if ( ssl == nullptr ) { @ @ -6404,7 +6404,7 @ @ static void NativeCrypto_SSL_enable_tls_channel_id ( JNIEnv* env , jclass , jlong ss } } -static jbyteArray NativeCrypto_SSL_get_tls_channel_id ( JNIEnv* env , jclass , jlong ssl_address ) { +static jbyteArray NativeCrypto_SSL_get_tls_channel_id ( JNIEnv* env , jclass , jlong ssl_address , jobject ssl_holder ) { SSL* ssl = to_SSL ( env , ssl_address , true ) ; JNI_TRACE ( `` ssl= % p NativeCrypto_NativeCrypto_SSL_get_tls_channel_id '' , ssl ) ; if ( ssl == nullptr ) { @ @ -6441,7 +6441,7 @ @ static jbyteArray NativeCrypto_SSL_get_tls_channel_id ( JNIEnv* env , jclass , jlong return javaBytes ; }
diff -- git a/common/src/jni/main/cpp/NativeCrypto.cpp b/common/src/jni/main/cpp/NativeCrypto.cpp index 48df119..d6fa53f 100644 -- - a/common/src/jni/main/cpp/NativeCrypto.cpp +++ b/common/src/jni/main/cpp/NativeCrypto.cpp @ @ -44,6 +44,8 @ @ # include < openssl/x509v3.h > # include < openssl/aead.h > + # include < vector > + using namespace conscrypt ; /** @ @ -6393,106 +6395,64 @ @ static void NativeCrypto_SSL_set1_tls_channel_id ( JNIEnv* env , jclass , JNI_TRACE ( `` ssl= % p SSL_set1_tls_channel_id = > ok '' , ssl ) ; } -static void NativeCrypto_SSL_use_PrivateKey ( JNIEnv* env , jclass , jlong ssl_address , - jobject pkeyRef ) { +static void NativeCrypto_setLocalCertsAndPrivateKey ( JNIEnv* env , jclass , jlong ssl_address , + jobjectArray encodedCertificatesJava , + jobject pkeyRef ) { SSL* ssl = to_SSL ( env , ssl_address , true ) ; - JNI_TRACE ( `` ssl= % p SSL_use_PrivateKey privatekey= % p '' , ssl , pkeyRef ) ; + JNI_TRACE ( `` ssl= % p NativeCrypto_SSL_set_chain_and_key certificates= % p , privateKey= % p '' , ssl , + encodedCertificatesJava , pkeyRef ) ; if ( ssl == nullptr ) { return ; } - - EVP_PKEY* pkey = fromContextObject < EVP_PKEY > ( env , pkeyRef ) ; - if ( pkey == nullptr ) { - JNI_TRACE
diff -- git a/CAPABILITIES.md b/CAPABILITIES.md index afa0c51..fc93aaf 100644 -- - a/CAPABILITIES.md +++ b/CAPABILITIES.md @ @ -9,59 +9,78 @ @ and other identifiers that are supported by Conscrypt . # # # Protocol Versions -* SSLv3 ( ignored ) -* TLSv1 -* TLSv1.1 -* TLSv1.2 - -Conscrypt supports TLS v1.0-1.2 . For backwards compatibility it will accept `` SSLv3 '' -in calls to methods like - [ setEnabledProtocols ( ) ] ( https : //docs.oracle.com/javase/9/docs/api/javax/net/ssl/SSLSocket.html # setEnabledProtocols-java.lang.String : A- ) -but will ignore it . +* ` SSLv3 ` ( ignored ) +* ` TLSv1 ` +* ` TLSv1.1 ` +* ` TLSv1.2 ` +* ` TLSv1.3 ` + +Conscrypt supports TLS v1.0-1.3 . For backwards compatibility it will accept + ` SSLv3 ` in calls to methods like + [ ` setEnabledProtocols ( ) ` ] ( https : //docs.oracle.com/javase/9/docs/api/javax/net/ssl/SSLSocket.html # setEnabledProtocols-java.lang.String : A- ) +but will ignore it . TLS 1.3 is not enabled unless ` SSLContext.TLSv1.3 ` is +requested or it 's explicitly enabled by a call to + [ ` setEnabledProtocols ( ) ` ] ( https : //docs.oracle.com/javase/9/docs/api/javax/net/ssl/SSLSocket.html # setEnabledProtocols-java.lang.String : A- ) . # # # SSLContext -* Default -* SSL -* TLS -* TLSv1
diff -- git a/common/src/jni/main/cpp/conscrypt/jniload.cc b/common/src/jni/main/cpp/conscrypt/jniload.cc index b43066c..c06cac3 100644 -- - a/common/src/jni/main/cpp/conscrypt/jniload.cc +++ b/common/src/jni/main/cpp/conscrypt/jniload.cc @ @ -18,8 +18,8 @ @ # include < conscrypt/compatibility_close_monitor.h > # include < conscrypt/jniutil.h > + # include < conscrypt/logging.h > # include < conscrypt/native_crypto.h > - # include < conscrypt/macros.h > # ifndef CONSCRYPT_JNI_VERSION # define CONSCRYPT_JNI_VERSION JNI_VERSION_1_6 @ @ -32,7 +32,7 @ @ using conscrypt : :NativeCrypto ; jint libconscrypt_JNI_OnLoad ( JavaVM* vm , void* ) { JNIEnv* env ; if ( vm- > GetEnv ( reinterpret_cast < void** > ( & env ) , CONSCRYPT_JNI_VERSION ) ! = JNI_OK ) { - ALOGE ( `` Could not get JNIEnv '' ) ; + CONSCRYPT_LOG_ERROR ( `` Could not get JNIEnv '' ) ; return JNI_ERR ; } diff -- git a/common/src/jni/main/cpp/conscrypt/jniutil.cc b/common/src/jni/main/cpp/conscrypt/jniutil.cc index ab9d1f1..390d6b7 100644 -- - a/common/src/jni/main/cpp/conscrypt/jniutil.cc +++ b/common/src/jni/main/cpp/conscrypt/jniutil.cc @ @ -80,7 +80,7 @ @ void init ( JavaVM* vm , JNIEnv* env ) { void jniRegisterNativeMethods ( JNIEnv* env , const char* className , const JNINativeMethod* gMethods , int numMethods ) { - ALOGV ( `` Registering % s 's % d native methods ... '' , className , numMethods ) ; + CONSCRYPT_LOG_VERBOSE ( `` Registering % s 's %
diff -- git a/android/build.gradle b/android/build.gradle index b88aac1..2cf1461 100644 -- - a/android/build.gradle +++ b/android/build.gradle @ @ -81,6 +81,9 @ @ if ( androidSdkInstalled ) { // Requires evaluationDependsOn ( ' : conscrypt-constants ' ) above . srcDirs += project ( ' : conscrypt-constants ' ) .sourceSets.main.java.srcDirs } + resources { + srcDirs += `` build/generated/resources '' + } } externalNativeBuild { cmake { @ @ -96,6 +99,10 @ @ if ( androidSdkInstalled ) { publicApiDocs } + preBuild { + dependsOn generateProperties + } + dependencies { publicApiDocs project ( ' : conscrypt-api-doclet ' ) androidTestImplementation ( 'com.android.support.test.espresso : espresso-core:2.2.2 ' , { diff -- git a/build.gradle b/build.gradle index 480d6f3..5f6f515 100644 -- - a/build.gradle +++ b/build.gradle @ @ -154,6 +154,16 @ @ subprojects { } } + task generateProperties ( type : WriteProperties ) { + ext { + parsedVersion = VersionNumber.parse ( version ) + } + property ( `` version.major '' , parsedVersion.getMajor ( ) ) + property ( `` version.minor '' , parsedVersion.getMinor ( ) ) + property ( `` version.patch '' , parsedVersion.getMicro ( ) ) + outputFile `` build/generated/resources/org/conscrypt/conscrypt.properties '' + } + if ( ! androidProject ) { sourceCompatibility = JavaVersion.VERSION_1_6 targetCompatibility = JavaVersion.VERSION_1_6 diff
diff -- git a/common/src/main/java/org/conscrypt/Conscrypt.java b/common/src/main/java/org/conscrypt/Conscrypt.java index 5670ac4..e322361 100644 -- - a/common/src/main/java/org/conscrypt/Conscrypt.java +++ b/common/src/main/java/org/conscrypt/Conscrypt.java @ @ -469,6 +469,8 @ @ public final class Conscrypt { /** * Provides the given engine with the provided bufferAllocator . + * @ throws IllegalArgumentException if the provided engine is not a Conscrypt engine . + * @ throws IllegalStateException if the provided engine has already begun its handshake . */ @ ExperimentalApi public static void setBufferAllocator ( SSLEngine engine , BufferAllocator bufferAllocator ) { @ @ -476,6 +478,20 @ @ public final class Conscrypt { } /** + * Provides the given socket with the provided bufferAllocator . If the given socket is a + * Conscrypt socket but does not use buffer allocators , this method does nothing . + * @ throws IllegalArgumentException if the provided socket is not a Conscrypt socket . + * @ throws IllegalStateException if the provided socket has already begun its handshake . + */ + @ ExperimentalApi + public static void setBufferAllocator ( SSLSocket socket , BufferAllocator bufferAllocator ) { + AbstractConscryptSocket s = toConscrypt ( socket ) ; + if ( s instanceof ConscryptEngineSocket ) { + ( ( ConscryptEngineSocket ) s ) .setBufferAllocator (
diff -- git a/android/CMakeLists.txt b/android/CMakeLists.txt index 6b3e474..64adbc6 100644 -- - a/android/CMakeLists.txt +++ b/android/CMakeLists.txt @ @ -21,4 +21,8 @ @ add_definitions ( -DANDROID -D_XOPEN_SOURCE=700 -Wno-unused-parameter ) +if ( $ { CMAKE_SYSTEM_PROCESSOR } STREQUAL `` aarch64 '' ) + set ( CMAKE_ASM_FLAGS `` $ { CMAKE_ASM_FLAGS } -march=armv8-a+crypto '' ) +endif ( ) + add_subdirectory ( $ { BORINGSSL_HOME } $ { CMAKE_CURRENT_BINARY_DIR } /boringssl ) diff -- git a/android/build.gradle b/android/build.gradle index 5769c49..35ff4aa 100644 -- - a/android/build.gradle +++ b/android/build.gradle @ @ -57,7 +57,7 @ @ if ( androidSdkInstalled ) { } } ndk { - abiFilters 'x86 ' , 'x86_64 ' , 'armeabi-v7a' + abiFilters 'x86 ' , 'x86_64 ' , 'armeabi-v7a ' , 'arm64-v8a' } } buildTypes {
diff -- git a/android-stub/build.gradle b/android-stub/build.gradle index ac51059..d0af41a 100644 -- - a/android-stub/build.gradle +++ b/android-stub/build.gradle @ @ -4,3 +4,7 @ @ description = 'Conscrypt : Android-Stub' sourceCompatibility = androidMinJavaVersion targetCompatibility = androidMinJavaVersion +// Do n't include this artifact in the distribution . +tasks.install.enabled = false +tasks.uploadArchives.enabled = false ; +
diff -- git a/common/src/main/java/org/conscrypt/ConscryptFileDescriptorSocket.java b/common/src/main/java/org/conscrypt/ConscryptFileDescriptorSocket.java index 2f8eaaf..1c7ca9d 100644 -- - a/common/src/main/java/org/conscrypt/ConscryptFileDescriptorSocket.java +++ b/common/src/main/java/org/conscrypt/ConscryptFileDescriptorSocket.java @ @ -1065,7 +1065,7 @ @ final class ConscryptFileDescriptorSocket extends OpenSSLSocketImpl @ Override public String chooseClientAlias ( X509KeyManager keyManager , X500Principal [ ] issuers , String [ ] keyTypes ) { - return keyManager.chooseClientAlias ( keyTypes , null , this ) ; + return keyManager.chooseClientAlias ( keyTypes , issuers , this ) ; } @ Override
diff -- git a/common/src/main/java/org/conscrypt/ChainStrengthAnalyzer.java b/common/src/main/java/org/conscrypt/ChainStrengthAnalyzer.java index af2a3e2..6ba8b1c 100644 -- - a/common/src/main/java/org/conscrypt/ChainStrengthAnalyzer.java +++ b/common/src/main/java/org/conscrypt/ChainStrengthAnalyzer.java @ @ -22,6 +22,7 @ @ import java.security.interfaces.DSAPublicKey ; import java.security.interfaces.ECPublicKey ; import java.security.interfaces.RSAPublicKey ; import java.util.List ; +import java.util.logging.Logger ; /** * Analyzes the cryptographic strength of a chain of X.509 certificates . @ @ -31,6 +32,8 @ @ import java.util.List ; @ Internal public final class ChainStrengthAnalyzer { + private static final Logger logger = Logger.getLogger ( ChainStrengthAnalyzer.class.getName ( ) ) ; + private static final int MIN_RSA_MODULUS_LEN_BITS = 1024 ; private static final int MIN_EC_FIELD_SIZE_BITS = 160 ; @ @ -79,6 +82,8 @ @ public final class ChainStrengthAnalyzer { if ( pubkey instanceof RSAPublicKey ) { int modulusLength = ( ( RSAPublicKey ) pubkey ) .getModulus ( ) .bitLength ( ) ; if ( modulusLength < MIN_RSA_MODULUS_LEN_BITS ) { + logger.fine ( `` RSA modulus of `` + modulusLength + + `` is less than `` + MIN_RSA_MODULUS_LEN_BITS ) ; throw new CertificateException ( `` RSA modulus is < `` + MIN_RSA_MODULUS_LEN_BITS + `` bits '' ) ; } @ @ -86,6 +91,8 @ @ public final class ChainStrengthAnalyzer { int fieldSizeBits = ( ( ECPublicKey ) pubkey ) .getParams ( ) .getCurve (
diff -- git a/android/build.gradle b/android/build.gradle index 4e9c558..3493f49 100644 -- - a/android/build.gradle +++ b/android/build.gradle @ @ -98,6 +98,86 @ @ if ( androidSdkInstalled ) { } ) provided project ( ' : conscrypt-android-stub ' ) } + + task javadocs ( type : Javadoc ) { + source = android.sourceSets.main.java.srcDirs + classpath += project.files ( android.getBootClasspath ( ) .join ( File.pathSeparator ) ) + // TODO ( nmittler ) : Fix the javadoc errors . + failOnError false + options { + encoding = 'UTF-8' + links `` https : //docs.oracle.com/javase/7/docs/api/ '' + } + } + + task javadocsJar ( type : Jar , dependsOn : javadocs ) { + classifier = 'javadoc' + from javadocs.destinationDir + } + + task sourcesJar ( type : Jar ) { + classifier = 'sources' + from android.sourceSets.main.java.srcDirs + } + + artifacts { + archives sourcesJar + archives javadocsJar + } + + uploadArchives.repositories.mavenDeployer { + beforeDeployment { MavenDeployment deployment - > signing.signPom ( deployment ) } + String stagingUrl + if ( rootProject.hasProperty ( 'repositoryId ' ) ) { + stagingUrl = 'https : //oss.sonatype.org/service/local/staging/deployByRepositoryId/ ' + + rootProject.repositoryId + } else { + stagingUrl = 'https : //oss.sonatype.org/service/local/staging/deploy/maven2/' + }
diff -- git a/build.gradle b/build.gradle index 3a2b496..d6e84ab 100644 -- - a/build.gradle +++ b/build.gradle @ @ -34,6 +34,17 @ @ subprojects { version = `` 1.0.0-SNAPSHOT '' ext { + os = org.gradle.internal.os.OperatingSystem.current ( ) ; + if ( os.isLinux ( ) ) { + osName = `` linux '' + } else if ( os.isMacOsX ( ) ) { + osName = `` osx '' + } else if ( os.isWindows ( ) ) { + osName = `` windows '' + } else { + throw new GradleException ( `` Unsupported os : `` + os.name ) + } + boringsslHome = `` $ System.env.BORINGSSL_HOME '' boringsslIncludeDir = `` $ boringsslHome/include '' boringssl32BuildDir = `` $ boringsslHome/build32 '' @ @ -53,15 +64,22 @ @ subprojects { assert file ( `` $ jdkHome '' ) .exists ( ) assert file ( `` $ jdkIncludeDir '' ) .exists ( ) + jmhVersion = '1.17.4' libraries = [ roboelectric : 'org.robolectric : android-all:5.0.0_r2-robolectric-1 ' , // Test dependencies . + guava : 'com.google.guava : guava:19.0 ' , junit : 'junit : junit:4.11 ' , mockito : 'org.mockito : mockito-core:1.9.5 ' , truth : 'com.google.truth : truth:0.28 ' , bouncycastle_provider : 'org.bouncycastle :
diff -- git a/build.gradle b/build.gradle index 3a2b496..d6e84ab 100644 -- - a/build.gradle +++ b/build.gradle @ @ -34,6 +34,17 @ @ subprojects { version = `` 1.0.0-SNAPSHOT '' ext { + os = org.gradle.internal.os.OperatingSystem.current ( ) ; + if ( os.isLinux ( ) ) { + osName = `` linux '' + } else if ( os.isMacOsX ( ) ) { + osName = `` osx '' + } else if ( os.isWindows ( ) ) { + osName = `` windows '' + } else { + throw new GradleException ( `` Unsupported os : `` + os.name ) + } + boringsslHome = `` $ System.env.BORINGSSL_HOME '' boringsslIncludeDir = `` $ boringsslHome/include '' boringssl32BuildDir = `` $ boringsslHome/build32 '' @ @ -53,15 +64,22 @ @ subprojects { assert file ( `` $ jdkHome '' ) .exists ( ) assert file ( `` $ jdkIncludeDir '' ) .exists ( ) + jmhVersion = '1.17.4' libraries = [ roboelectric : 'org.robolectric : android-all:5.0.0_r2-robolectric-1 ' , // Test dependencies . + guava : 'com.google.guava : guava:19.0 ' , junit : 'junit : junit:4.11 ' , mockito : 'org.mockito : mockito-core:1.9.5 ' , truth : 'com.google.truth : truth:0.28 ' , bouncycastle_provider : 'org.bouncycastle :
diff -- git a/common/src/main/java/org/conscrypt/NativeCrypto.java b/common/src/main/java/org/conscrypt/NativeCrypto.java index 509b2ef..33e470a 100644 -- - a/common/src/main/java/org/conscrypt/NativeCrypto.java +++ b/common/src/main/java/org/conscrypt/NativeCrypto.java @ @ -724,7 +724,8 @ @ public final class NativeCrypto { // prevent apps from connecting to servers they were previously able to connect to . /** X.509 based cipher suites enabled by default ( if requested ) , in preference order . */ - static final String [ ] DEFAULT_X509_CIPHER_SUITES = EVP_has_aes_hardware ( ) == 1 ? + static final boolean HAS_AES_HARDWARE = EVP_has_aes_hardware ( ) == 1 ; + static final String [ ] DEFAULT_X509_CIPHER_SUITES = HAS_AES_HARDWARE ? new String [ ] { `` TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 '' , `` TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 '' , @ @ -760,8 +761,10 @ @ public final class NativeCrypto { /** TLS-PSK cipher suites enabled by default ( if requested ) , in preference order . */ static final String [ ] DEFAULT_PSK_CIPHER_SUITES = new String [ ] { - `` TLS_ECDHE_PSK_WITH_CHACHA20_POLY1305_SHA256 '' , `` TLS_ECDHE_PSK_WITH_AES_128_CBC_SHA '' , - `` TLS_ECDHE_PSK_WITH_AES_256_CBC_SHA '' , `` TLS_PSK_WITH_AES_128_CBC_SHA '' , + `` TLS_ECDHE_PSK_WITH_CHACHA20_POLY1305_SHA256 '' , + `` TLS_ECDHE_PSK_WITH_AES_128_CBC_SHA '' , + `` TLS_ECDHE_PSK_WITH_AES_256_CBC_SHA '' , + `` TLS_PSK_WITH_AES_128_CBC_SHA '' , `` TLS_PSK_WITH_AES_256_CBC_SHA '' , } ; diff -- git a/libcore-stub/src/main/java/libcore/java/security/CpuFeatures.java b/libcore-stub/src/main/java/libcore/java/security/CpuFeatures.java index 3b7ce36..b90468c 100644 -- -
diff -- git a/ofl/amaranth/FONTLOG.txt b/ofl/amaranth/FONTLOG.txt index 0b4d4dc..74c14c0 100644 -- - a/ofl/amaranth/FONTLOG.txt +++ b/ofl/amaranth/FONTLOG.txt @ @ -13,6 +13,9 @ @ support other scripts . ChangeLog +21 July 2017 ( Marc Foley ) +- Added ellipsis + 30 Apr 2011 ( Gesine Todt and Camille Boulouis ) Amaranth v2 - Added italic , bold and bold italic weights - Regular refined diff -- git a/ofl/amaranth/METADATA.pb b/ofl/amaranth/METADATA.pb index aeac48b..d9a33cf 100644 -- - a/ofl/amaranth/METADATA.pb +++ b/ofl/amaranth/METADATA.pb @ @ -10,7 +10,7 @ @ fonts { filename : `` Amaranth-Regular.ttf '' post_script_name : `` Amaranth-Regular '' full_name : `` Amaranth Regular '' - copyright : `` Copyright ( c ) 2011 by Gesine Todt . All rights reserved . '' + copyright : `` Copyright 2016 The Amaranth Project Authors ( https : //github.com/googlefonts/amaranth ) '' } fonts { name : `` Amaranth '' @ @ -19,7 +19,7 @ @ fonts { filename : `` Amaranth-Italic.ttf '' post_script_name : `` Amaranth-Italic '' full_name : `` Amaranth Italic '' - copyright : `` Copyright ( c ) 2011 by Gesine Todt . All rights reserved . '' + copyright : `` Copyright 2016 The Amaranth Project Authors ( https : //github.com/googlefonts/amaranth ) '' } fonts { name
diff -- git a/ofl/oswald/Oswald-Bold.ttf b/ofl/oswald/Oswald-Bold.ttf index acfd663..fd710b7 100644 Binary files a/ofl/oswald/Oswald-Bold.ttf and b/ofl/oswald/Oswald-Bold.ttf differ diff -- git a/ofl/oswald/Oswald-ExtraLight.ttf b/ofl/oswald/Oswald-ExtraLight.ttf index ff1a7e4..91930df 100644 Binary files a/ofl/oswald/Oswald-ExtraLight.ttf and b/ofl/oswald/Oswald-ExtraLight.ttf differ diff -- git a/ofl/oswald/Oswald-Light.ttf b/ofl/oswald/Oswald-Light.ttf index 528f462..72b29c5 100644 Binary files a/ofl/oswald/Oswald-Light.ttf and b/ofl/oswald/Oswald-Light.ttf differ diff -- git a/ofl/oswald/Oswald-Medium.ttf b/ofl/oswald/Oswald-Medium.ttf index eb4bffa..056efbd 100644 Binary files a/ofl/oswald/Oswald-Medium.ttf and b/ofl/oswald/Oswald-Medium.ttf differ diff -- git a/ofl/oswald/Oswald-Regular.ttf b/ofl/oswald/Oswald-Regular.ttf index c749cfa..b04438e 100644 Binary files a/ofl/oswald/Oswald-Regular.ttf and b/ofl/oswald/Oswald-Regular.ttf differ diff -- git a/ofl/oswald/Oswald-SemiBold.ttf b/ofl/oswald/Oswald-SemiBold.ttf index 80c4885..06eca4c 100644 Binary files a/ofl/oswald/Oswald-SemiBold.ttf and b/ofl/oswald/Oswald-SemiBold.ttf differ
diff -- git a/ofl/oswald/Oswald-Bold.ttf b/ofl/oswald/Oswald-Bold.ttf index acfd663..fd710b7 100644 Binary files a/ofl/oswald/Oswald-Bold.ttf and b/ofl/oswald/Oswald-Bold.ttf differ diff -- git a/ofl/oswald/Oswald-ExtraLight.ttf b/ofl/oswald/Oswald-ExtraLight.ttf index ff1a7e4..91930df 100644 Binary files a/ofl/oswald/Oswald-ExtraLight.ttf and b/ofl/oswald/Oswald-ExtraLight.ttf differ diff -- git a/ofl/oswald/Oswald-Light.ttf b/ofl/oswald/Oswald-Light.ttf index 528f462..72b29c5 100644 Binary files a/ofl/oswald/Oswald-Light.ttf and b/ofl/oswald/Oswald-Light.ttf differ diff -- git a/ofl/oswald/Oswald-Medium.ttf b/ofl/oswald/Oswald-Medium.ttf index eb4bffa..056efbd 100644 Binary files a/ofl/oswald/Oswald-Medium.ttf and b/ofl/oswald/Oswald-Medium.ttf differ diff -- git a/ofl/oswald/Oswald-Regular.ttf b/ofl/oswald/Oswald-Regular.ttf index c749cfa..b04438e 100644 Binary files a/ofl/oswald/Oswald-Regular.ttf and b/ofl/oswald/Oswald-Regular.ttf differ diff -- git a/ofl/oswald/Oswald-SemiBold.ttf b/ofl/oswald/Oswald-SemiBold.ttf index 80c4885..06eca4c 100644 Binary files a/ofl/oswald/Oswald-SemiBold.ttf and b/ofl/oswald/Oswald-SemiBold.ttf differ
diff -- git a/tools/encodings/GF 2016 Glyph Sets/README.md b/tools/encodings/GF 2016 Glyph Sets/README.md index 11cebe9..972ec04 100644 -- - a/tools/encodings/GF 2016 Glyph Sets/README.md +++ b/tools/encodings/GF 2016 Glyph Sets/README.md @ @ -136,11 +136,102 @ @ Structure and Hierarchy of Glyph Sets for Cyrillic : # # # GF Cyrillic Core -**Supports the following Cyrillic languages : ** Balkar , Belarusian ( Cyrillic ) , Bosnian ( Cyrillic ) , Bulgarian , Croatian ( Cyrillic ) , Erzya , Karachay , Kumyk , Macedonian , Moksha , Montenigrin , Nanai , Nogai , Russian , Rusyn , Serbian ( Cyrillic ) , Ukrainian . +**Supports the following Cyrillic languages : ** Balkar , Belarusian ( Cyrillic ) , Bosnian ( Cyrillic ) , Bulgarian , Croatian ( Cyrillic ) , Erzya , Karachay , Kumyk , Macedonian , Moksha , Montenigrin , Nanai , Nogai , Russian , Rusyn , Serbian ( Cyrillic ) , Ukrainian , West Polesian # # # GF Cyrillic Plus ( 184 + 40 localized variants for 228 total ) -**Supports the following 59 Cyrillic languages : ** Adyghe , Agul , Altay , Avar , Azerbaijani ( Cyrillic ) , Balkar , Bashkir , Belarusian ( Cyrillic ) ,
diff -- git a/tools/encodings/GF 2016 Glyph Sets/CustomFilter.plist b/tools/encodings/GF 2016 Glyph Sets/CustomFilter.plist new file mode 100644 index 0000000..663e8f0 -- - /dev/null +++ b/tools/encodings/GF 2016 Glyph Sets/CustomFilter.plist @ @ -0,0 +1,1820 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < ! DOCTYPE plist PUBLIC `` -//Apple//DTD PLIST 1.0//EN '' `` http : //www.apple.com/DTDs/PropertyList-1.0.dtd '' > + < plist version= '' 1.0 '' > + < array > + < dict > + < key > name < /key > + < string > Incompatible Master < /string > + < key > predicate < /key > + < string > mastersCompatible == 0 < /string > + < /dict > + < dict > + < key > list < /key > + < array > + < string > Iegrave-cy < /string > + < string > Io-cy < /string > + < string > Dje-cy < /string > + < string > Gje-cy < /string > + < string > E-cy < /string > + < string > Dze-cy < /string > + < string > I-cy < /string > + < string > Yi-cy < /string > + < string
diff -- git a/tools/encodings/GF 2016 Glyph Sets/Cyrillic/FilterLists/Google Cyrillic Expert Nice Names.txt b/tools/encodings/GF 2016 Glyph Sets/Cyrillic/FilterLists/Google Cyrillic Expert Nice Names.txt deleted file mode 100644 index bb807b2..0000000 -- - a/tools/encodings/GF 2016 Glyph Sets/Cyrillic/FilterLists/Google Cyrillic Expert Nice Names.txt +++ /dev/null @ @ -1,398 +0,0 @ @ -Iegrave-cy -Io-cy -Dje-cy -Gje-cy -E-cy -Dze-cy -I-cy -Yi-cy -Je-cy -Lje-cy -Nje-cy -Tshe-cy -Kje-cy -Iigrave-cy -Ushort-cy -Dzhe-cy -A-cy -Be-cy -Ve-cy -Ge-cy -De-cy -Ie-cy -Zhe-cy -Ze-cy -Ii-cy -Iishort-cy -Ka-cy -El-cy -Em-cy -En-cy -O-cy -Pe-cy -Er-cy -Es-cy -Te-cy -U-cy -Ef-cy -Ha-cy -Tse-cy -Che-cy -Sha-cy -Shcha-cy -Hardsign-cy -Yeru-cy -Softsign-cy -Ereversed-cy -Iu-cy -Ia-cy -a-cy -be-cy -ve-cy -ge-cy -de-cy -ie-cy -zhe-cy -ze-cy -ii-cy -iishort-cy -ka-cy -el-cy -em-cy -en-cy -o-cy -pe-cy -er-cy -es-cy -te-cy -u-cy -ef-cy -ha-cy -tse-cy -che-cy -sha-cy -shcha-cy -hardsign-cy -yeru-cy -softsign-cy -ereversed-cy -iu-cy -ia-cy -iegrave-cy -io-cy -dje-cy -gje-cy -e-cy -dze-cy -i-cy -yi-cy -je-cy -lje-cy -nje-cy -tshe-cy -kje-cy -iigrave-cy -ushort-cy -dzhe-cy -Yat-cy -yat-cy -Yusbig-cy -yusbig-cy -Fita-cy -fita-cy -Izhitsa-cy -izhitsa-cy -Gheupturn-cy -gheupturn-cy -Ghestroke-cy -ghestroke-cy -Ghemiddlehook-cy -ghemiddlehook-cy -Zhedescender-cy -zhedescender-cy -Zedescender-cy -zedescender-cy -Kadescender-cy -kadescender-cy -Kaverticalstroke-cy -kaverticalstroke-cy -Kastroke-cy -kastroke-cy -Kabashkir-cy -kabashkir-cy -Endescender-cy -endescender-cy -Enghe-cy -enghe-cy -Pemiddlehook-cy -pemiddlehook-cy -Haabkhasian-cy -haabkhasian-cy -Esdescender-cy -esdescender-cy -Tedescender-cy -tedescender-cy -Ustrait-cy -ustrait-cy -Ustraitstroke-cy -ustraitstroke-cy -Hadescender-cy -hadescender-cy -Tetse-cy -tetse-cy -Chedescender-cy -chedescender-cy -Cheverticalstroke-cy -cheverticalstroke-cy -Shha-cy -shha-cy -Cheabkhasian-cy -cheabkhasian-cy -Palochka-cy -Zhebreve-cy -zhebreve-cy -Chekhakassian-cy -chekhakassian-cy -palochka-cy -Abreve-cy
diff -- git a/tools/encodings/GF 2016 Glyph Sets/Cyrillic/FilterLists/Google Cyrillic Expert Nice Names.txt b/tools/encodings/GF 2016 Glyph Sets/Cyrillic/FilterLists/Google Cyrillic Expert Nice Names.txt deleted file mode 100644 index bb807b2..0000000 -- - a/tools/encodings/GF 2016 Glyph Sets/Cyrillic/FilterLists/Google Cyrillic Expert Nice Names.txt +++ /dev/null @ @ -1,398 +0,0 @ @ -Iegrave-cy -Io-cy -Dje-cy -Gje-cy -E-cy -Dze-cy -I-cy -Yi-cy -Je-cy -Lje-cy -Nje-cy -Tshe-cy -Kje-cy -Iigrave-cy -Ushort-cy -Dzhe-cy -A-cy -Be-cy -Ve-cy -Ge-cy -De-cy -Ie-cy -Zhe-cy -Ze-cy -Ii-cy -Iishort-cy -Ka-cy -El-cy -Em-cy -En-cy -O-cy -Pe-cy -Er-cy -Es-cy -Te-cy -U-cy -Ef-cy -Ha-cy -Tse-cy -Che-cy -Sha-cy -Shcha-cy -Hardsign-cy -Yeru-cy -Softsign-cy -Ereversed-cy -Iu-cy -Ia-cy -a-cy -be-cy -ve-cy -ge-cy -de-cy -ie-cy -zhe-cy -ze-cy -ii-cy -iishort-cy -ka-cy -el-cy -em-cy -en-cy -o-cy -pe-cy -er-cy -es-cy -te-cy -u-cy -ef-cy -ha-cy -tse-cy -che-cy -sha-cy -shcha-cy -hardsign-cy -yeru-cy -softsign-cy -ereversed-cy -iu-cy -ia-cy -iegrave-cy -io-cy -dje-cy -gje-cy -e-cy -dze-cy -i-cy -yi-cy -je-cy -lje-cy -nje-cy -tshe-cy -kje-cy -iigrave-cy -ushort-cy -dzhe-cy -Yat-cy -yat-cy -Yusbig-cy -yusbig-cy -Fita-cy -fita-cy -Izhitsa-cy -izhitsa-cy -Gheupturn-cy -gheupturn-cy -Ghestroke-cy -ghestroke-cy -Ghemiddlehook-cy -ghemiddlehook-cy -Zhedescender-cy -zhedescender-cy -Zedescender-cy -zedescender-cy -Kadescender-cy -kadescender-cy -Kaverticalstroke-cy -kaverticalstroke-cy -Kastroke-cy -kastroke-cy -Kabashkir-cy -kabashkir-cy -Endescender-cy -endescender-cy -Enghe-cy -enghe-cy -Pemiddlehook-cy -pemiddlehook-cy -Haabkhasian-cy -haabkhasian-cy -Esdescender-cy -esdescender-cy -Tedescender-cy -tedescender-cy -Ustrait-cy -ustrait-cy -Ustraitstroke-cy -ustraitstroke-cy -Hadescender-cy -hadescender-cy -Tetse-cy -tetse-cy -Chedescender-cy -chedescender-cy -Cheverticalstroke-cy -cheverticalstroke-cy -Shha-cy -shha-cy -Cheabkhasian-cy -cheabkhasian-cy -Palochka-cy -Zhebreve-cy -zhebreve-cy -Chekhakassian-cy -chekhakassian-cy -palochka-cy -Abreve-cy
diff -- git a/ofl/mavenpro/MavenPro-Black.ttf b/ofl/mavenpro/MavenPro-Black.ttf index 4cbe95b..ed25f68 100644 Binary files a/ofl/mavenpro/MavenPro-Black.ttf and b/ofl/mavenpro/MavenPro-Black.ttf differ diff -- git a/ofl/mavenpro/MavenPro-Bold.ttf b/ofl/mavenpro/MavenPro-Bold.ttf index 42e6650..c04e7c5 100644 Binary files a/ofl/mavenpro/MavenPro-Bold.ttf and b/ofl/mavenpro/MavenPro-Bold.ttf differ diff -- git a/ofl/mavenpro/MavenPro-Medium.ttf b/ofl/mavenpro/MavenPro-Medium.ttf index d40982a..c9032b5 100644 Binary files a/ofl/mavenpro/MavenPro-Medium.ttf and b/ofl/mavenpro/MavenPro-Medium.ttf differ diff -- git a/ofl/mavenpro/MavenPro-Regular.ttf b/ofl/mavenpro/MavenPro-Regular.ttf index 38f2738..faf57c2 100644 Binary files a/ofl/mavenpro/MavenPro-Regular.ttf and b/ofl/mavenpro/MavenPro-Regular.ttf differ
diff -- git a/ofl/muli/Muli-Black.ttf b/ofl/muli/Muli-Black.ttf index 76825b8..a95b709 100644 Binary files a/ofl/muli/Muli-Black.ttf and b/ofl/muli/Muli-Black.ttf differ diff -- git a/ofl/muli/Muli-BlackItalic.ttf b/ofl/muli/Muli-BlackItalic.ttf index 70762c0..eb2e747 100644 Binary files a/ofl/muli/Muli-BlackItalic.ttf and b/ofl/muli/Muli-BlackItalic.ttf differ diff -- git a/ofl/muli/Muli-Bold.ttf b/ofl/muli/Muli-Bold.ttf index 732c3ec..86153a7 100644 Binary files a/ofl/muli/Muli-Bold.ttf and b/ofl/muli/Muli-Bold.ttf differ diff -- git a/ofl/muli/Muli-BoldItalic.ttf b/ofl/muli/Muli-BoldItalic.ttf index 1dac1c9..3048250 100644 Binary files a/ofl/muli/Muli-BoldItalic.ttf and b/ofl/muli/Muli-BoldItalic.ttf differ diff -- git a/ofl/muli/Muli-ExtraBold.ttf b/ofl/muli/Muli-ExtraBold.ttf index a8ef44c..5794514 100644 Binary files a/ofl/muli/Muli-ExtraBold.ttf and b/ofl/muli/Muli-ExtraBold.ttf differ diff -- git a/ofl/muli/Muli-ExtraBoldItalic.ttf b/ofl/muli/Muli-ExtraBoldItalic.ttf index b99e68d..695286e 100644 Binary files a/ofl/muli/Muli-ExtraBoldItalic.ttf and b/ofl/muli/Muli-ExtraBoldItalic.ttf differ diff -- git a/ofl/muli/Muli-ExtraLight.ttf b/ofl/muli/Muli-ExtraLight.ttf index ffe7b29..44c085f 100644 Binary files a/ofl/muli/Muli-ExtraLight.ttf and b/ofl/muli/Muli-ExtraLight.ttf differ diff -- git a/ofl/muli/Muli-ExtraLightItalic.ttf b/ofl/muli/Muli-ExtraLightItalic.ttf index eb8b36a..35d54f5 100644 Binary files a/ofl/muli/Muli-ExtraLightItalic.ttf and b/ofl/muli/Muli-ExtraLightItalic.ttf differ diff -- git a/ofl/muli/Muli-Italic.ttf b/ofl/muli/Muli-Italic.ttf index e159929..b55a76b 100644 Binary files a/ofl/muli/Muli-Italic.ttf and b/ofl/muli/Muli-Italic.ttf differ diff -- git a/ofl/muli/Muli-Light.ttf b/ofl/muli/Muli-Light.ttf index 4e66b69..fc579bd 100644 Binary files a/ofl/muli/Muli-Light.ttf and b/ofl/muli/Muli-Light.ttf differ diff -- git a/ofl/muli/Muli-LightItalic.ttf b/ofl/muli/Muli-LightItalic.ttf index 85ac251..170f6e3 100644 Binary files a/ofl/muli/Muli-LightItalic.ttf and b/ofl/muli/Muli-LightItalic.ttf differ diff -- git a/ofl/muli/Muli-Regular.ttf b/ofl/muli/Muli-Regular.ttf index 1dfd643..4b44bef 100644 Binary files a/ofl/muli/Muli-Regular.ttf and b/ofl/muli/Muli-Regular.ttf differ diff -- git a/ofl/muli/Muli-SemiBold.ttf b/ofl/muli/Muli-SemiBold.ttf index 096a15e..8c4948a 100644 Binary files a/ofl/muli/Muli-SemiBold.ttf and b/ofl/muli/Muli-SemiBold.ttf differ diff -- git a/ofl/muli/Muli-SemiBoldItalic.ttf b/ofl/muli/Muli-SemiBoldItalic.ttf index 6d7bcc8..78ab9fd 100644 Binary files a/ofl/muli/Muli-SemiBoldItalic.ttf and b/ofl/muli/Muli-SemiBoldItalic.ttf differ
diff -- git a/tools/encodings/GF 2016 Glyph Sets/README.md b/tools/encodings/GF 2016 Glyph Sets/README.md index d10cd05..76e515c 100644 -- - a/tools/encodings/GF 2016 Glyph Sets/README.md +++ b/tools/encodings/GF 2016 Glyph Sets/README.md @ @ -29,7 +29,10 @ @ Structure and Hierarchy of Encodings for Latin : # # # Google Latin Plus ( 600 glyphs total ) -Vietnamese language support + - Western & Central European + - Vietnamese + - Currencies (                ) + - Alternate Numerals : Proportonal Lining Includes characters from the following unicode ranges : @ @ -38,24 +41,28 @ @ Includes characters from the following unicode ranges : - Latin Extended B - Latin Extended Additional - Latin-1 Supplement - - Currencies :                **Language support for the following Latin-based languages** : Abenaki , Afaan Oromo , Afar , Afrikaans , Albanian , Alsatian , Amis , Anuta , Aragonese , Aranese , Aromanian , Arrernte , Arvanitic ( Latin ) , Asturian , Atayal , Aymara , Azerbaijani , Bashkir ( Latin ) , Basque , Belarusian ( Latin ) , Bemba
diff -- git a/ofl/merriweather/DESCRIPTION.en_us.html b/ofl/merriweather/DESCRIPTION.en_us.html index c2227de..9ac02bc 100644 -- - a/ofl/merriweather/DESCRIPTION.en_us.html +++ b/ofl/merriweather/DESCRIPTION.en_us.html @ @ -5,7 +5,3 @ @ It features a very large x height , slightly condensed letterforms , a mild diagon < p > There is also < a href= '' https : //fonts.google.com/specimen/Merriweather+Sans '' > Merriweather Sans < /a > , a sans-serif version which closely harmonizes with the weights and styles of this serif family . < /p > - < p > - < b > Updated January 2017 : < /b > -Many more languages are now supported , with Vietnamese and extended Cyrillic glyphs added . - < /p > diff -- git a/ofl/merriweather/FONTLOG.txt b/ofl/merriweather/FONTLOG.txt index 2a82708..0dbbcf5 100644 -- - a/ofl/merriweather/FONTLOG.txt +++ b/ofl/merriweather/FONTLOG.txt @ @ -47,6 +47,9 @ @ To contribute to the project contact Eben Sorkin at sorkineben @ gmail.com ChangeLog +24 April 2017 ( Marc Foley ) Merriweather v1.585 +v2.001 had to be reverted back to v1.544 , due to regression issues . This hotfix fixes https : //github.com/google/fonts/issues/588 . + 2 Feb 2017 ( Marc Foley ) Merriweather v2.001 * Fixed interpolation issues in Italic diff -- git a/ofl/merriweather/METADATA.pb b/ofl/merriweather/METADATA.pb index 96ab52c..b5a5dc0 100644 -- - a/ofl/merriweather/METADATA.pb +++ b/ofl/merriweather/METADATA.pb @
diff -- git a/ofl/barlow/Barlow-Black.ttf b/ofl/barlow/Barlow-Black.ttf index 302b01e..2f201bc 100644 Binary files a/ofl/barlow/Barlow-Black.ttf and b/ofl/barlow/Barlow-Black.ttf differ diff -- git a/ofl/barlow/Barlow-BlackItalic.ttf b/ofl/barlow/Barlow-BlackItalic.ttf index 1739ace..cc3ddf2 100644 Binary files a/ofl/barlow/Barlow-BlackItalic.ttf and b/ofl/barlow/Barlow-BlackItalic.ttf differ diff -- git a/ofl/barlow/Barlow-Bold.ttf b/ofl/barlow/Barlow-Bold.ttf index 27116c1..a739d38 100644 Binary files a/ofl/barlow/Barlow-Bold.ttf and b/ofl/barlow/Barlow-Bold.ttf differ diff -- git a/ofl/barlow/Barlow-BoldItalic.ttf b/ofl/barlow/Barlow-BoldItalic.ttf index 317f835..1ae0bfc 100644 Binary files a/ofl/barlow/Barlow-BoldItalic.ttf and b/ofl/barlow/Barlow-BoldItalic.ttf differ diff -- git a/ofl/barlow/Barlow-ExtraBold.ttf b/ofl/barlow/Barlow-ExtraBold.ttf index b98bcb6..dc9bb29 100644 Binary files a/ofl/barlow/Barlow-ExtraBold.ttf and b/ofl/barlow/Barlow-ExtraBold.ttf differ diff -- git a/ofl/barlow/Barlow-ExtraBoldItalic.ttf b/ofl/barlow/Barlow-ExtraBoldItalic.ttf index ae99541..0692971 100644 Binary files a/ofl/barlow/Barlow-ExtraBoldItalic.ttf and b/ofl/barlow/Barlow-ExtraBoldItalic.ttf differ diff -- git a/ofl/barlow/Barlow-ExtraLight.ttf b/ofl/barlow/Barlow-ExtraLight.ttf index 1f858c0..59a7e1c 100644 Binary files a/ofl/barlow/Barlow-ExtraLight.ttf and b/ofl/barlow/Barlow-ExtraLight.ttf differ diff -- git a/ofl/barlow/Barlow-ExtraLightItalic.ttf b/ofl/barlow/Barlow-ExtraLightItalic.ttf index 38e417f..757e9ac 100644 Binary files a/ofl/barlow/Barlow-ExtraLightItalic.ttf and b/ofl/barlow/Barlow-ExtraLightItalic.ttf differ diff -- git a/ofl/barlow/Barlow-Italic.ttf b/ofl/barlow/Barlow-Italic.ttf index 4ac5394..787667d 100644 Binary files a/ofl/barlow/Barlow-Italic.ttf and b/ofl/barlow/Barlow-Italic.ttf differ diff -- git a/ofl/barlow/Barlow-Light.ttf b/ofl/barlow/Barlow-Light.ttf index 21cb3c7..5d89fcb 100644 Binary files a/ofl/barlow/Barlow-Light.ttf and b/ofl/barlow/Barlow-Light.ttf differ diff -- git a/ofl/barlow/Barlow-LightItalic.ttf b/ofl/barlow/Barlow-LightItalic.ttf index 502747e..34682f2 100644 Binary files a/ofl/barlow/Barlow-LightItalic.ttf and b/ofl/barlow/Barlow-LightItalic.ttf differ diff -- git a/ofl/barlow/Barlow-Medium.ttf b/ofl/barlow/Barlow-Medium.ttf index 03b3295..8e62602 100644 Binary files a/ofl/barlow/Barlow-Medium.ttf and b/ofl/barlow/Barlow-Medium.ttf differ diff -- git a/ofl/barlow/Barlow-MediumItalic.ttf b/ofl/barlow/Barlow-MediumItalic.ttf index c152ae0..2b979d7 100644 Binary files a/ofl/barlow/Barlow-MediumItalic.ttf and b/ofl/barlow/Barlow-MediumItalic.ttf differ diff -- git a/ofl/barlow/Barlow-Regular.ttf b/ofl/barlow/Barlow-Regular.ttf index 24e9df7..85c5eb9 100644 Binary files a/ofl/barlow/Barlow-Regular.ttf and b/ofl/barlow/Barlow-Regular.ttf differ diff -- git a/ofl/barlow/Barlow-SemiBold.ttf
diff -- git a/ofl/neuton/METADATA.pb b/ofl/neuton/METADATA.pb index e4e31ac..a4b9b75 100644 -- - a/ofl/neuton/METADATA.pb +++ b/ofl/neuton/METADATA.pb @ @ -6,11 +6,11 @ @ date_added : `` 2011-02-09 '' fonts { name : `` Neuton '' style : `` normal '' - weight : 200 + weight : 250 filename : `` Neuton-ExtraLight.ttf '' post_script_name : `` Neuton-ExtraLight '' - full_name : `` Neuton Extralight '' - copyright : `` Copyright ( c ) 2010 , 2011 Brian M Zick ( http : //21326.info/ artistenator @ gmail.com ) , with Reserved Font Name \ '' Neuton\ '' . This Font Software is licensed under the SIL Open Font License , Version 1.1 . This license is available with a FAQ at : http : //scripts.sil.org/OFL '' + full_name : `` Neuton ExtraLight '' + copyright : `` Copyright 2010 The Neuton Project Authors ( http : //21326.info/ ) '' } fonts { name : `` Neuton '' @ @ -19,7 +19,7 @ @ fonts { filename : `` Neuton-Light.ttf '' post_script_name : `` Neuton-Light '' full_name : `` Neuton Light '' - copyright : `` Copyright ( c ) 2010 , 2011 Brian M Zick ( http : //21326.info/ artistenator @ gmail.com ) , with
diff -- git a/internal/driver/fetch.go b/internal/driver/fetch.go index 22e26b6..7c36573 100644 -- - a/internal/driver/fetch.go +++ b/internal/driver/fetch.go @ @ -373,20 +373,20 @ @ mapping : } } } + if len ( p.Mapping ) == 0 { + // If there are no mappings , add a fake mapping to attempt symbolization . + // This is useful for some profiles generated by the golang runtime , which + // do not include any mappings . Symbolization with a fake mapping will only + // be successful against a non-PIE binary . + m : = & profile.Mapping { ID : 1 } + p.Mapping = [ ] *profile.Mapping { m } + for _ , l : = range p.Location { + l.Mapping = m + } + } // Replace executable filename/buildID with the overrides from source . // Assumes the executable is the first Mapping entry . if execName , buildID : = s.ExecName , s.BuildID ; execName ! = `` '' || buildID ! = `` '' { - if len ( p.Mapping ) == 0 { - // If there are no mappings , add a fake mapping to attempt symbolization . - // This is useful for some
diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..e404d8d -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,254 @ @ +// Copyright  2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' bytes '' + '' encoding/json '' + '' html/template '' + '' net/http '' + '' path/filepath '' + ) + +var flameGraphTemplate = template.Must ( template.New ( `` graph '' ) .Parse ( ` < ! DOCTYPE html > + < html lang= '' en '' > + < head > +
diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..f9180b0 -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,314 @ @ +// Copyright  2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' bytes '' + '' encoding/json '' + '' fmt '' + '' html/template '' + '' net/http '' + '' path/filepath '' + '' time '' + ) + +var flameGraphTemplate = template.Must ( template.New ( `` graph '' ) .Parse ( ` < ! DOCTYPE html > + < html lang= ''
diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..5f6de4e -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,327 @ @ +// Copyright  2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' bytes '' + '' encoding/json '' + '' fmt '' + '' html/template '' + '' net/http '' + '' path/filepath '' + '' time '' + ) + +var flameGraphTemplate = template.Must ( template.New ( `` graph '' ) .Parse ( ` < ! DOCTYPE html > + < html lang= ''
diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 2f73c29..0ff468c 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -11,4 +11,5 @ @ Raul Silvera < rsilvera @ google.com > Tipp Moseley < tipp @ google.com > Hyoun Kyu Cho < netforce @ google.com > +Martin Spier < spiermar @ gmail.com > diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..fa2eff4 -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,118 @ @ +// Copyright  2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' encoding/json '' + '' html/template
diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 2f73c29..0ff468c 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -11,4 +11,5 @ @ Raul Silvera < rsilvera @ google.com > Tipp Moseley < tipp @ google.com > Hyoun Kyu Cho < netforce @ google.com > +Martin Spier < spiermar @ gmail.com > diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..41ddfcb -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,105 @ @ +// Copyright 2017 Google Inc. All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' encoding/json '' + '' fmt '' +
diff -- git a/internal/driver/driver_focus.go b/internal/driver/driver_focus.go index e2591ff..c37bfdd 100644 -- - a/internal/driver/driver_focus.go +++ b/internal/driver/driver_focus.go @ @ -77,19 +77,44 @ @ func compileTagFilter ( name , value string , ui plugin.UI , err error ) ( func ( *profil if value == `` '' || err ! = nil { return nil , err } + + tagValuePair : = strings.SplitN ( value , `` = '' , 2 ) + var key string + if len ( tagValuePair ) == 2 { + key = tagValuePair [ 0 ] + value = tagValuePair [ 1 ] + } else { + key = `` '' + } + if numFilter : = parseTagFilterRange ( value ) ; numFilter ! = nil { ui.PrintErr ( name , `` : Interpreted ' '' , value , `` ' as range , not regexp '' ) - return func ( s *profile.Sample ) bool { - for key , vals : = range s.NumLabel { - for _ , val : = range vals { - if numFilter ( val , key ) { + labelFilter : = func ( vals [ ] int64 , key string ) bool { + for _ ,
diff -- git a/appveyor.yml b/appveyor.yml index c4abc9e..9da712c 100644 -- - a/appveyor.yml +++ b/appveyor.yml @ @ -2,7 +2,7 @ @ clone_folder : c : \go\src\github.com\google\pprof install : - cinst graphviz.portable - + before_build : - go get github.com/ianlancetaylor/demangle diff -- git a/internal/driver/commands.go b/internal/driver/commands.go index 4793fb8..cfdacda 100644 -- - a/internal/driver/commands.go +++ b/internal/driver/commands.go @ @ -196,10 +196,14 @ @ var pprofVariables = variables { '' Matching includes the function name , filename or object name . `` ) } , '' tagfocus '' : & variable { stringKind , `` '' , `` '' , helpText ( '' Restrict to samples with tags in range or matched by regexp '' , - '' Discard samples that do not include a node with a tag matching this regexp . `` ) } , + '' Discard samples that do not include a node with a tag matching this regexp . `` , + '' Can specify both the name and value of the tag which should be matched '' , + '' using notation like name=value '' ) } , '' tagignore '' : & variable { stringKind , `` '' , `` '' , helpText ( '' Discard samples with tags in range
diff -- git a/internal/binutils/binutils.go b/internal/binutils/binutils.go index 82d0579..390f952 100644 -- - a/internal/binutils/binutils.go +++ b/internal/binutils/binutils.go @ @ -175,20 +175,35 @ @ func ( bu *Binutils ) Open ( name string , start , limit , offset uint64 ) ( plugin.ObjFi func ( b *binrep ) openMachO ( name string , start , limit , offset uint64 ) ( plugin.ObjFile , error ) { of , err : = macho.Open ( name ) if err ! = nil { - return nil , fmt.Errorf ( `` Parsing % s : % v '' , name , err ) + return nil , fmt.Errorf ( `` error parsing % s : % v '' , name , err ) } defer of.Close ( ) + // Subtract the load address of the __TEXT section . Usually 0 for shared + // libraries or 0x100000000 for executables . You can check this value by + // running ` objdump -private-headers < file > ` . + + textSegment : = of.Segment ( `` __TEXT '' ) + if textSegment == nil { + return nil , fmt.Errorf ( `` could not identify base for % s : no __TEXT segment '' , name ) +
diff -- git a/profile/prune.go b/profile/prune.go index cf9cbb3..a2955bc 100644 -- - a/profile/prune.go +++ b/profile/prune.go @ @ -22,6 +22,37 @ @ import ( '' strings '' ) +var ( + reservedNames = [ ] string { `` ( anonymous namespace ) '' , `` operator ( ) '' } + bracketRx = regexp.MustCompile ( `` ( `` + strings.Replace ( strings.Replace ( + strings.Join ( append ( reservedNames , `` ( `` ) , `` | '' ) , + '' ( `` , `` \\ ( `` , -1 ) , `` ) '' , `` \\ ) '' , -1 ) + `` ) '' ) + ) + +// simplifyFunc does some primitive simplification of function names . +func simplifyFunc ( f string ) string { + // Account for leading ' . ' on the PPC ELF v1 ABI . + funcName : = strings.TrimPrefix ( f , `` . '' ) + // Account for unsimplified names -- try to remove the argument list by trimming + // starting from the first ' ( ' , but skipping reserved names that have ' ( ' . + if indeces : = bracketRx.FindAllStringSubmatchIndex ( funcName , -1 )
diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..5f6de4e -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,327 @ @ +// Copyright  2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' bytes '' + '' encoding/json '' + '' fmt '' + '' html/template '' + '' net/http '' + '' path/filepath '' + '' time '' + ) + +var flameGraphTemplate = template.Must ( template.New ( `` graph '' ) .Parse ( ` < ! DOCTYPE html > + < html lang= ''
diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..25c996d -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,352 @ @ +// Copyright  2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' bytes '' + '' encoding/json '' + '' fmt '' + '' html/template '' + '' net/http '' + '' path/filepath '' + '' time '' + + '' github.com/google/pprof/third_party/d3 '' + '' github.com/google/pprof/third_party/d3flamegraph '' + '' github.com/google/pprof/third_party/d3tip '' + ) + +var flameGraphTemplate = template.Must ( template.New ( `` graph '' )
diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..857dbf0 -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,363 @ @ +// Copyright  2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' bytes '' + '' encoding/json '' + '' fmt '' + '' html/template '' + '' net/http '' + '' path/filepath '' + '' time '' + + '' github.com/google/pprof/third_party/d3 '' + '' github.com/google/pprof/third_party/d3flamegraph '' + '' github.com/google/pprof/third_party/d3tip '' + ) + +var flameGraphTemplate = template.Must ( template.New ( `` graph '' )
diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 2f73c29..0ff468c 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -11,4 +11,5 @ @ Raul Silvera < rsilvera @ google.com > Tipp Moseley < tipp @ google.com > Hyoun Kyu Cho < netforce @ google.com > +Martin Spier < spiermar @ gmail.com > diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..fa2eff4 -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,118 @ @ +// Copyright  2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' encoding/json '' + '' html/template
diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 2f73c29..0ff468c 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -11,4 +11,5 @ @ Raul Silvera < rsilvera @ google.com > Tipp Moseley < tipp @ google.com > Hyoun Kyu Cho < netforce @ google.com > +Martin Spier < spiermar @ gmail.com > diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..fa2eff4 -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,118 @ @ +// Copyright  2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' encoding/json '' + '' html/template
diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 2f73c29..0ff468c 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -11,4 +11,5 @ @ Raul Silvera < rsilvera @ google.com > Tipp Moseley < tipp @ google.com > Hyoun Kyu Cho < netforce @ google.com > +Martin Spier < spiermar @ gmail.com > diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..93bbe9f -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,109 @ @ +// Copyright 2017 Google Inc. All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' encoding/json '' + '' fmt '' +
diff -- git a/internal/driver/commands.go b/internal/driver/commands.go index 91d32d1..30e1478 100644 -- - a/internal/driver/commands.go +++ b/internal/driver/commands.go @ @ -337,21 +337,23 @ @ func listHelp ( c string , redirect bool ) string { // browsers returns a list of commands to attempt for web visualization . func browsers ( ) [ ] string { - cmds : = [ ] string { `` chrome '' , `` google-chrome '' , `` firefox '' } + var cmds [ ] string + if userBrowser : = os.Getenv ( `` BROWSER '' ) ; userBrowser ! = `` '' { + cmds = append ( cmds , userBrowser ) + } switch runtime.GOOS { case `` darwin '' : - return append ( cmds , `` /usr/bin/open '' ) + cmds = append ( cmds , `` /usr/bin/open '' ) case `` windows '' : - return append ( cmds , `` cmd /c start '' ) + cmds = append ( cmds , `` cmd /c start '' ) default : - userBrowser : = os.Getenv ( `` BROWSER '' ) - if userBrowser ! = `` '' { - cmds = append ( [ ] string { userBrowser , `` sensible-browser '' }
diff -- git a/doc/developer/profile.proto.md b/doc/developer/profile.proto.md index 9932e7e..5f567d6 100644 -- - a/doc/developer/profile.proto.md +++ b/doc/developer/profile.proto.md @ @ -128,9 +128,11 @ @ size of 6MB . Labels can be string-based or numeric . They are represented by the Label message , with a key identifying the label and either a string or numeric -value . For numeric labels , by convention the key represents the measurement unit -of the numeric value . So for the previous example , the samples would have labels - {  bytes  , 2097152 } and {  bytes  , 4194304 } . +value . For numeric labels , the measurement unit can be specified in the profile +If no unit is specified , is specified and the key is `` request '' or `` alignment '' , +then the units are assumed to be `` bytes '' . Otherwise the key will be used as the +measurement unit of the numeric value . All tags with the same key should be +associated with the same unit . # # Keep and drop expressions diff -- git a/internal/driver/driver_focus.go b/internal/driver/driver_focus.go index d6f9875..8618a9c 100644 -- - a/internal/driver/driver_focus.go +++ b/internal/driver/driver_focus.go @ @ -87,9 +87,9 @ @ func compileTagFilter (
diff -- git a/internal/driver/webhtml.go b/internal/driver/webhtml.go index 48f0fa1..6dfb482 100644 -- - a/internal/driver/webhtml.go +++ b/internal/driver/webhtml.go @ @ -14,152 +14,187 @ @ package driver -import `` html/template '' +import ( + '' html/template '' + ) // addTemplates adds a set of template definitions to templates . func addTemplates ( templates *template.Template ) { template.Must ( templates.Parse ( ` { { define `` css '' } } < style type= '' text/css '' > -html { - height : 100 % ; - min-height : 100 % ; - margin : 0px ; +* { + margin : 0 ; + padding : 0 ; + box-sizing : border-box ; } -body { - margin : 0px ; - width : 100 % ; +html , body { height : 100 % ; - min-height : 100 % ; - overflow : hidden ; } - # graphcontainer { +body { + font-family : 'Roboto ' , -apple-system , BlinkMacSystemFont , 'Segoe UI ' , Helvetica , Arial , sans-serif , 'Apple Color Emoji ' , 'Segoe UI Emoji ' , 'Segoe UI Symbol ' ; + font-size : 13px ; + line-height : 1.4 ; display : flex ; flex-direction : column
diff -- git a/projects/wireshark/Dockerfile b/projects/wireshark/Dockerfile index 40f6a33..1ba0ef8 100644 -- - a/projects/wireshark/Dockerfile +++ b/projects/wireshark/Dockerfile @ @ -17,7 +17,7 @ @ FROM gcr.io/oss-fuzz-base/base-builder MAINTAINER Jakub Zawadzki < darkjames-ws @ darkjames.pl > -RUN apt-get update & & apt-get install -y make autoconf automake libtool libtool-bin \ +RUN apt-get update & & apt-get install -y make cmake \ flex bison \ libglib2.0-dev libgcrypt20-dev diff -- git a/projects/wireshark/build.sh b/projects/wireshark/build.sh index dc8407d..0a56a3a 100755 -- - a/projects/wireshark/build.sh +++ b/projects/wireshark/build.sh @ @ -15,6 +15,9 @ @ # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # +WIRESHARK_BUILD_PATH= '' $ WORK/build '' +mkdir -p `` $ WIRESHARK_BUILD_PATH '' + export WIRESHARK_INSTALL_PATH= '' $ WORK/install '' mkdir -p `` $ WIRESHARK_INSTALL_PATH '' @ @ -24,25 +27,38 @ @ mkdir -p `` $ SAMPLES_DIR '' cp -a $ SRC/wireshark-fuzzdb/samples/* ``
diff -- git a/boringssl/Jenkinsfile b/boringssl/Jenkinsfile index bb7325b..8701c04 100644 -- - a/boringssl/Jenkinsfile +++ b/boringssl/Jenkinsfile @ @ -20,7 +20,6 @ @ def libfuzzerPipeline = fileLoader.fromGit ( libfuzzerPipeline { git = `` https : //boringssl.googlesource.com/boringssl '' - dockerfile = `` oss-fuzz/boringssl/Dockerfile '' } diff -- git a/docs/new_library.md b/docs/new_library.md index fe81c79..f8cc75d 100644 -- - a/docs/new_library.md +++ b/docs/new_library.md @ @ -29,7 +29,6 @ @ def libfuzzerBuild = fileLoader.fromGit ( 'infra/libfuzzer-pipeline.groovy ' , libfuzzerBuild { git = `` git : //git.code.sf.net/p/expat/code_git '' - dockerfile = `` oss-fuzz/expat/Dockerfile '' } `` ` diff -- git a/expat/Jenkinsfile b/expat/Jenkinsfile index 8f2908a..32afa56 100644 -- - a/expat/Jenkinsfile +++ b/expat/Jenkinsfile @ @ -19,5 +19,4 @ @ def libfuzzerBuild = fileLoader.fromGit ( 'infra/libfuzzer-pipeline.groovy ' , libfuzzerBuild { git = `` git : //git.code.sf.net/p/expat/code_git '' - dockerfile = `` oss-fuzz/expat/Dockerfile '' } diff -- git a/freetype2/Jenkinsfile b/freetype2/Jenkinsfile index e26395c..9267970 100644 -- - a/freetype2/Jenkinsfile +++ b/freetype2/Jenkinsfile @ @ -20,6 +20,5 @ @ def libfuzzerBuild = fileLoader.fromGit ( libfuzzerBuild { git = `` git : //git.sv.nongnu.org/freetype/freetype2.git '' - dockerfile = `` oss-fuzz/freetype2/Dockerfile '' } diff -- git a/infra/libfuzzer-pipeline.groovy b/infra/libfuzzer-pipeline.groovy index 5faba5a..26e8580 100644 -- - a/infra/libfuzzer-pipeline.groovy +++ b/infra/libfuzzer-pipeline.groovy @ @ -22,8 +22,6 @ @ def call ( body ) { body ( ) // Mandatory configuration -
diff -- git a/projects/skia/Dockerfile b/projects/skia/Dockerfile index 71f1c89..99efc7a 100644 -- - a/projects/skia/Dockerfile +++ b/projects/skia/Dockerfile @ @ -25,6 +25,9 @ @ ENV PATH= '' $ { SRC } /depot_tools : $ { PATH } '' # checkout all sources needed to build your project RUN git clone https : //skia.googlesource.com/skia.git +RUN wget -O $ SRC/skia/image_filter_deserialize_seed_corpus.zip https : //storage.googleapis.com/skia-fuzzer/oss-fuzz/image_filter_deserialize_seed_corpus.zip +COPY image_filter_deserialize.cpp $ SRC/skia/fuzz/oss_fuzz/image_filter_deserialize.cpp + # current directory for build script WORKDIR skia @ @ -40,5 +43,3 @ @ COPY BUILD.gn.diff $ SRC/skia/BUILD.gn.diff RUN cat BUILD.gn.diff > > BUILD.gn COPY image_filter_deserialize.options $ SRC/skia/image_filter_deserialize.options -RUN wget -O $ SRC/skia/image_filter_deserialize_seed_corpus.zip https : //storage.googleapis.com/skia-fuzzer/oss-fuzz/image_filter_deserialize_seed_corpus.zip -COPY image_filter_deserialize.cpp $ SRC/skia/fuzz/oss_fuzz/image_filter_deserialize.cpp diff -- git a/projects/skia/image_filter_deserialize.options b/projects/skia/image_filter_deserialize.options index 05ba1b1..0bde038 100644 -- - a/projects/skia/image_filter_deserialize.options +++ b/projects/skia/image_filter_deserialize.options @ @ -1,3 +1,3 @ @ [ libfuzzer ] max_len = 10024 -timeout = 10 \ No newline at end of file +timeout = 10
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py deleted file mode 100755 index 7ebf4c0..0000000 -- - a/infra/gcb/build.py +++ /dev/null @ @ -1,350 +0,0 @ @ - # ! /usr/bin/python2 - '' '' '' Starts project build on Google Cloud Builder . - -Usage : build.py < project_dir > - '' '' '' - -import base64 -import collections -import datetime -import os -import re -import subprocess -import sys -import time -import urllib -import yaml - -from oauth2client.client import GoogleCredentials -from oauth2client.service_account import ServiceAccountCredentials -from googleapiclient.discovery import build - -BUILD_TIMEOUT = 10 * 60 * 60 - -CONFIGURATIONS = { - 'sanitizer-address ' : [ 'SANITIZER=address ' ] , - 'sanitizer-memory ' : [ 'SANITIZER=memory ' ] , - 'sanitizer-undefined ' : [ 'SANITIZER=undefined ' ] , - 'sanitizer-coverage ' : [ 'SANITIZER=coverage ' ] , - 'engine-libfuzzer ' : [ 'FUZZING_ENGINE=libfuzzer ' ] , - 'engine-afl ' : [ 'FUZZING_ENGINE=afl ' ] , - 'engine-honggfuzz ' : [ 'FUZZING_ENGINE=honggfuzz ' ] , - 'engine-none ' : [ 'FUZZING_ENGINE=none ' ] , - } - -EngineInfo = collections.namedtuple ( 'EngineInfo ' , - [ 'upload_bucket ' , 'supported_sanitizers ' ] ) - -ENGINE_INFO = { - 'libfuzzer ' : - EngineInfo ( - upload_bucket='clusterfuzz-builds '
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py deleted file mode 100755 index 7ebf4c0..0000000 -- - a/infra/gcb/build.py +++ /dev/null @ @ -1,350 +0,0 @ @ - # ! /usr/bin/python2 - '' '' '' Starts project build on Google Cloud Builder . - -Usage : build.py < project_dir > - '' '' '' - -import base64 -import collections -import datetime -import os -import re -import subprocess -import sys -import time -import urllib -import yaml - -from oauth2client.client import GoogleCredentials -from oauth2client.service_account import ServiceAccountCredentials -from googleapiclient.discovery import build - -BUILD_TIMEOUT = 10 * 60 * 60 - -CONFIGURATIONS = { - 'sanitizer-address ' : [ 'SANITIZER=address ' ] , - 'sanitizer-memory ' : [ 'SANITIZER=memory ' ] , - 'sanitizer-undefined ' : [ 'SANITIZER=undefined ' ] , - 'sanitizer-coverage ' : [ 'SANITIZER=coverage ' ] , - 'engine-libfuzzer ' : [ 'FUZZING_ENGINE=libfuzzer ' ] , - 'engine-afl ' : [ 'FUZZING_ENGINE=afl ' ] , - 'engine-honggfuzz ' : [ 'FUZZING_ENGINE=honggfuzz ' ] , - 'engine-none ' : [ 'FUZZING_ENGINE=none ' ] , - } - -EngineInfo = collections.namedtuple ( 'EngineInfo ' , - [ 'upload_bucket ' , 'supported_sanitizers ' ] ) - -ENGINE_INFO = { - 'libfuzzer ' : - EngineInfo ( - upload_bucket='clusterfuzz-builds '
diff -- git a/infra/base-images/base-runner/bad_build_check b/infra/base-images/base-runner/bad_build_check index e133ea9..d5ffa17 100755 -- - a/infra/base-images/base-runner/bad_build_check +++ b/infra/base-images/base-runner/bad_build_check @ @ -19,34 +19,29 @ @ function check_instrumentation { local FUZZER= $ 1 local CHECK_FAILED=0 + local FUZZER_OUTPUT= '' /tmp/ $ ( basename $ FUZZER ) .output '' if [ [ `` $ FUZZING_ENGINE '' = libfuzzer ] ] ; then - CHECK_FAILED= $ ( $ FUZZER -max_total_time=4 2 > & 1 | egrep `` ERROR : no interesting inputs were found . Is the code instrumented '' -c ) + $ FUZZER -runs=4 & > $ FUZZER_OUTPUT + CHECK_FAILED= $ ( cat $ FUZZER_OUTPUT | egrep `` ERROR : no interesting inputs were found . Is the code instrumented '' -c ) if ( ( $ CHECK_FAILED > 0 ) ) ; then - echo `` BAD BUILD : the code does not seem to have coverage instrumentation . '' + echo `` BAD BUILD : the target does not seem to have coverage instrumentation . '' + exit 1 fi - fi - # honggfuzz is not fully integrated , avoid performing the following check . - if [ [ `` $ FUZZING_ENGINE '' ! = honggfuzz ] ] ; then - if ( (
diff -- git a/infra/base-images/base-runner/bad_build_check b/infra/base-images/base-runner/bad_build_check index e133ea9..b2c2521 100755 -- - a/infra/base-images/base-runner/bad_build_check +++ b/infra/base-images/base-runner/bad_build_check @ @ -1,4 +1,4 @ @ - # ! /bin/bash -ux + # ! /bin/bash -u # Copyright 2017 Google Inc. # # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; @ @ -15,56 +15,65 @ @ # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # - # Verify that the given fuzzer has proper coverage instrumentation . + # A minimal number of runs to test fuzz target with a non-empty input . +MIN_NUMBER_OF_RUNS=4 + + # The `` example '' target has 73 with ASan , 65 with UBSan , and 6648 with MSan . + # Real world targets have greater values ( arduinojson :
diff -- git a/projects/cpython3/Dockerfile b/projects/cpython3/Dockerfile new file mode 100644 index 0000000..0fd719d -- - /dev/null +++ b/projects/cpython3/Dockerfile @ @ -0,0 +1,7 @ @ +FROM gcr.io/oss-fuzz-base/base-builder +MAINTAINER jeanpierreda @ google.com + # Just installing python3-dev for its dependencies . We 'll build our own copy . + # ( apt-get build-dep fails for whatever reason . ) +RUN apt-get update & & apt-get install -y libtool python3-dev zlib1g-dev build-essential +RUN git clone https : //github.com/python/cpython.git cpython +COPY build.sh gen_fuzz.py $ SRC/ diff -- git a/projects/cpython3/build.sh b/projects/cpython3/build.sh new file mode 100644 index 0000000..e8b332e -- - /dev/null +++ b/projects/cpython3/build.sh @ @ -0,0 +1,41 @ @ + # ! /bin/bash -eu + # Copyright 2017 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES
diff -- git a/infra/base-images/base-runner/bad_build_check b/infra/base-images/base-runner/bad_build_check index e133ea9..39a17f5 100755 -- - a/infra/base-images/base-runner/bad_build_check +++ b/infra/base-images/base-runner/bad_build_check @ @ -1,4 +1,4 @ @ - # ! /bin/bash -ux + # ! /bin/bash -u # Copyright 2017 Google Inc. # # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; @ @ -15,44 +15,47 @ @ # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # - # Verify that the given fuzzer has proper coverage instrumentation . + # Global variable that can be overwritten by any check . +BAD_BUILD_CHECK_FAILED=0 + + # Verify that the given fuzz target has proper coverage instrumentation . function check_instrumentation { local FUZZER= $ 1 + local LOG_PATH_FOR_BROKEN_TARGET= $ 2 local CHECK_FAILED=0 + local FUZZER_OUTPUT= '' /tmp/ $ ( basename $
diff -- git a/infra/base-images/base-builder/Dockerfile b/infra/base-images/base-builder/Dockerfile index 8ea3bd0..af329ff 100644 -- - a/infra/base-images/base-builder/Dockerfile +++ b/infra/base-images/base-builder/Dockerfile @ @ -53,7 +53,8 @ @ RUN mkdir honggfuzz & & \ tar -xzv -- strip-components=1 -f $ SRC/oss-fuzz.tar.gz & & \ rm -rf $ SRC/oss-fuzz.tar.gz -COPY compile compile_afl compile_libfuzzer compile_honggfuzz coverage_report srcmap /usr/local/bin/ +COPY compile compile_afl compile_libfuzzer compile_libfuzzer-standalone \ + compile_honggfuzz coverage_report srcmap /usr/local/bin/ CMD [ `` compile '' ] diff -- git a/infra/base-images/base-builder/compile_libfuzzer-standalone b/infra/base-images/base-builder/compile_libfuzzer-standalone new file mode 100644 index 0000000..77e0779 -- - /dev/null +++ b/infra/base-images/base-builder/compile_libfuzzer-standalone @ @ -0,0 +1,26 @ @ + # ! /bin/bash -eu + # Copyright 2017 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the
diff -- git a/infra/base-images/base-runner-debug/Dockerfile b/infra/base-images/base-runner-debug/Dockerfile index dd739c3..d71b1ea 100644 -- - a/infra/base-images/base-runner-debug/Dockerfile +++ b/infra/base-images/base-runner-debug/Dockerfile @ @ -16,5 +16,5 @ @ FROM gcr.io/oss-fuzz-base/base-runner MAINTAINER mike.aizatsky @ gmail.com -RUN apt-get install -y gdb zip +RUN apt-get install -y gdb valgrind zip diff -- git a/infra/base-images/base-runner/reproduce b/infra/base-images/base-runner/reproduce index 121ce14..944376f 100755 -- - a/infra/base-images/base-runner/reproduce +++ b/infra/base-images/base-runner/reproduce @ @ -15,6 +15,7 @ @ # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # +DEBUGGER= $ { DEBUGGER : - } FUZZER= $ 1 shift TESTCASE= '' /testcase '' @ @ -26,5 +27,5 @ @ fi export PATH= $ OUT : $ PATH cd $ OUT - $ OUT/ $ FUZZER $ FUZZER_ARGS $ @ $ TESTCASE + $ DEBUGGER $ OUT/ $ FUZZER $ FUZZER_ARGS $ @ $ TESTCASE diff -- git a/infra/helper.py b/infra/helper.py index
diff -- git a/projects/openssl/build.sh b/projects/openssl/build.sh index 37caccb..14768c9 100755 -- - a/projects/openssl/build.sh +++ b/projects/openssl/build.sh @ @ -25,7 +25,7 @ @ fi make -j $ ( nproc ) LDCMD= '' $ CXX $ CXXFLAGS '' -fuzzers= $ ( find fuzz -executable -type f ' ! ' -name \*.py ' ! ' -name \*-test ) +fuzzers= $ ( find fuzz -executable -type f ' ! ' -name \*.py ' ! ' -name \*-test ' ! ' -name \*.pl ) for f in $ fuzzers ; do fuzzer= $ ( basename $ f ) cp $ f $ OUT/
diff -- git a/infra/base-images/base-libfuzzer/README.md b/infra/base-images/base-libfuzzer/README.md index c190207..875f1e8 100644 -- - a/infra/base-images/base-libfuzzer/README.md +++ b/infra/base-images/base-libfuzzer/README.md @ @ -41,6 +41,7 @ @ Build configuration is performed through following environment variables : | ` $ SANITIZER ( `` address '' ) ` | Specifies sanitizer configuration to use . ` address ` or ` undefined ` . | ` $ SANITIZER_FLAGS ` | Specify compiler sanitizer flags directly . Overrides ` $ SANITIZER ` . | ` $ COVERAGE_FLAGS ` | Specify compiler flags to use for fuzzer feedback coverage . +| ` $ SWITCH_UID ` | User id to use while building fuzzers . # Examples diff -- git a/infra/base-images/base-libfuzzer/compile b/infra/base-images/base-libfuzzer/compile index a18920e..7b6e1d1 100755 -- - a/infra/base-images/base-libfuzzer/compile +++ b/infra/base-images/base-libfuzzer/compile @ @ -42,4 +42,12 @ @ echo `` CXXFLAGS= $ CXXFLAGS '' echo `` -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- - '' -bash -x $ SRC/build.sh +BUILD_CMD= '' bash -x $ SRC/build.sh '' +if [ -z `` $ { SWITCH_UID+ } '' ] ; then + adduser -u $ SWITCH_UID -- disabled-password -- no-create-home -- gecos `` ossfuzz +
diff -- git a/boringssl/Jenkinsfile b/boringssl/Jenkinsfile index bb7325b..8701c04 100644 -- - a/boringssl/Jenkinsfile +++ b/boringssl/Jenkinsfile @ @ -20,7 +20,6 @ @ def libfuzzerPipeline = fileLoader.fromGit ( libfuzzerPipeline { git = `` https : //boringssl.googlesource.com/boringssl '' - dockerfile = `` oss-fuzz/boringssl/Dockerfile '' } diff -- git a/docs/new_library.md b/docs/new_library.md index fe81c79..f8cc75d 100644 -- - a/docs/new_library.md +++ b/docs/new_library.md @ @ -29,7 +29,6 @ @ def libfuzzerBuild = fileLoader.fromGit ( 'infra/libfuzzer-pipeline.groovy ' , libfuzzerBuild { git = `` git : //git.code.sf.net/p/expat/code_git '' - dockerfile = `` oss-fuzz/expat/Dockerfile '' } `` ` diff -- git a/expat/Jenkinsfile b/expat/Jenkinsfile index 8f2908a..32afa56 100644 -- - a/expat/Jenkinsfile +++ b/expat/Jenkinsfile @ @ -19,5 +19,4 @ @ def libfuzzerBuild = fileLoader.fromGit ( 'infra/libfuzzer-pipeline.groovy ' , libfuzzerBuild { git = `` git : //git.code.sf.net/p/expat/code_git '' - dockerfile = `` oss-fuzz/expat/Dockerfile '' } diff -- git a/freetype2/Jenkinsfile b/freetype2/Jenkinsfile index e26395c..9267970 100644 -- - a/freetype2/Jenkinsfile +++ b/freetype2/Jenkinsfile @ @ -20,6 +20,5 @ @ def libfuzzerBuild = fileLoader.fromGit ( libfuzzerBuild { git = `` git : //git.sv.nongnu.org/freetype/freetype2.git '' - dockerfile = `` oss-fuzz/freetype2/Dockerfile '' } diff -- git a/infra/libfuzzer-pipeline.groovy b/infra/libfuzzer-pipeline.groovy index 5faba5a..26e8580 100644 -- - a/infra/libfuzzer-pipeline.groovy +++ b/infra/libfuzzer-pipeline.groovy @ @ -22,8 +22,6 @ @ def call ( body ) { body ( ) // Mandatory configuration -
diff -- git a/nss/Dockerfile b/nss/Dockerfile new file mode 100644 index 0000000..5cf55e0 -- - /dev/null +++ b/nss/Dockerfile @ @ -0,0 +1,23 @ @ + # Copyright 2016 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + # + # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py deleted file mode 100755 index 7ebf4c0..0000000 -- - a/infra/gcb/build.py +++ /dev/null @ @ -1,350 +0,0 @ @ - # ! /usr/bin/python2 - '' '' '' Starts project build on Google Cloud Builder . - -Usage : build.py < project_dir > - '' '' '' - -import base64 -import collections -import datetime -import os -import re -import subprocess -import sys -import time -import urllib -import yaml - -from oauth2client.client import GoogleCredentials -from oauth2client.service_account import ServiceAccountCredentials -from googleapiclient.discovery import build - -BUILD_TIMEOUT = 10 * 60 * 60 - -CONFIGURATIONS = { - 'sanitizer-address ' : [ 'SANITIZER=address ' ] , - 'sanitizer-memory ' : [ 'SANITIZER=memory ' ] , - 'sanitizer-undefined ' : [ 'SANITIZER=undefined ' ] , - 'sanitizer-coverage ' : [ 'SANITIZER=coverage ' ] , - 'engine-libfuzzer ' : [ 'FUZZING_ENGINE=libfuzzer ' ] , - 'engine-afl ' : [ 'FUZZING_ENGINE=afl ' ] , - 'engine-honggfuzz ' : [ 'FUZZING_ENGINE=honggfuzz ' ] , - 'engine-none ' : [ 'FUZZING_ENGINE=none ' ] , - } - -EngineInfo = collections.namedtuple ( 'EngineInfo ' , - [ 'upload_bucket ' , 'supported_sanitizers ' ] ) - -ENGINE_INFO = { - 'libfuzzer ' : - EngineInfo ( - upload_bucket='clusterfuzz-builds '
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py deleted file mode 100755 index 7ebf4c0..0000000 -- - a/infra/gcb/build.py +++ /dev/null @ @ -1,350 +0,0 @ @ - # ! /usr/bin/python2 - '' '' '' Starts project build on Google Cloud Builder . - -Usage : build.py < project_dir > - '' '' '' - -import base64 -import collections -import datetime -import os -import re -import subprocess -import sys -import time -import urllib -import yaml - -from oauth2client.client import GoogleCredentials -from oauth2client.service_account import ServiceAccountCredentials -from googleapiclient.discovery import build - -BUILD_TIMEOUT = 10 * 60 * 60 - -CONFIGURATIONS = { - 'sanitizer-address ' : [ 'SANITIZER=address ' ] , - 'sanitizer-memory ' : [ 'SANITIZER=memory ' ] , - 'sanitizer-undefined ' : [ 'SANITIZER=undefined ' ] , - 'sanitizer-coverage ' : [ 'SANITIZER=coverage ' ] , - 'engine-libfuzzer ' : [ 'FUZZING_ENGINE=libfuzzer ' ] , - 'engine-afl ' : [ 'FUZZING_ENGINE=afl ' ] , - 'engine-honggfuzz ' : [ 'FUZZING_ENGINE=honggfuzz ' ] , - 'engine-none ' : [ 'FUZZING_ENGINE=none ' ] , - } - -EngineInfo = collections.namedtuple ( 'EngineInfo ' , - [ 'upload_bucket ' , 'supported_sanitizers ' ] ) - -ENGINE_INFO = { - 'libfuzzer ' : - EngineInfo ( - upload_bucket='clusterfuzz-builds '
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py deleted file mode 100755 index 7ebf4c0..0000000 -- - a/infra/gcb/build.py +++ /dev/null @ @ -1,350 +0,0 @ @ - # ! /usr/bin/python2 - '' '' '' Starts project build on Google Cloud Builder . - -Usage : build.py < project_dir > - '' '' '' - -import base64 -import collections -import datetime -import os -import re -import subprocess -import sys -import time -import urllib -import yaml - -from oauth2client.client import GoogleCredentials -from oauth2client.service_account import ServiceAccountCredentials -from googleapiclient.discovery import build - -BUILD_TIMEOUT = 10 * 60 * 60 - -CONFIGURATIONS = { - 'sanitizer-address ' : [ 'SANITIZER=address ' ] , - 'sanitizer-memory ' : [ 'SANITIZER=memory ' ] , - 'sanitizer-undefined ' : [ 'SANITIZER=undefined ' ] , - 'sanitizer-coverage ' : [ 'SANITIZER=coverage ' ] , - 'engine-libfuzzer ' : [ 'FUZZING_ENGINE=libfuzzer ' ] , - 'engine-afl ' : [ 'FUZZING_ENGINE=afl ' ] , - 'engine-honggfuzz ' : [ 'FUZZING_ENGINE=honggfuzz ' ] , - 'engine-none ' : [ 'FUZZING_ENGINE=none ' ] , - } - -EngineInfo = collections.namedtuple ( 'EngineInfo ' , - [ 'upload_bucket ' , 'supported_sanitizers ' ] ) - -ENGINE_INFO = { - 'libfuzzer ' : - EngineInfo ( - upload_bucket='clusterfuzz-builds '
diff -- git a/infra/libfuzzer-pipeline.groovy b/infra/libfuzzer-pipeline.groovy index df3e3dd..3f64a6a 100644 -- - a/infra/libfuzzer-pipeline.groovy +++ b/infra/libfuzzer-pipeline.groovy @ @ -37,7 +37,7 @ @ def call ( body ) { // Flags configuration def sanitizerFlags = [ `` address '' : '' -fsanitize=address '' , - `` undefined '' : '' -fsanitize=bool , signed-integer-overflow , shift , vptr '' + `` undefined '' : '' -fsanitize=bool , signed-integer-overflow , shift , vptr -fno-sanitize-recover=undefined '' ] def date = java.time.format.DateTimeFormatter.ofPattern ( `` yyyyMMddHHmm '' )
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py deleted file mode 100755 index 7ebf4c0..0000000 -- - a/infra/gcb/build.py +++ /dev/null @ @ -1,350 +0,0 @ @ - # ! /usr/bin/python2 - '' '' '' Starts project build on Google Cloud Builder . - -Usage : build.py < project_dir > - '' '' '' - -import base64 -import collections -import datetime -import os -import re -import subprocess -import sys -import time -import urllib -import yaml - -from oauth2client.client import GoogleCredentials -from oauth2client.service_account import ServiceAccountCredentials -from googleapiclient.discovery import build - -BUILD_TIMEOUT = 10 * 60 * 60 - -CONFIGURATIONS = { - 'sanitizer-address ' : [ 'SANITIZER=address ' ] , - 'sanitizer-memory ' : [ 'SANITIZER=memory ' ] , - 'sanitizer-undefined ' : [ 'SANITIZER=undefined ' ] , - 'sanitizer-coverage ' : [ 'SANITIZER=coverage ' ] , - 'engine-libfuzzer ' : [ 'FUZZING_ENGINE=libfuzzer ' ] , - 'engine-afl ' : [ 'FUZZING_ENGINE=afl ' ] , - 'engine-honggfuzz ' : [ 'FUZZING_ENGINE=honggfuzz ' ] , - 'engine-none ' : [ 'FUZZING_ENGINE=none ' ] , - } - -EngineInfo = collections.namedtuple ( 'EngineInfo ' , - [ 'upload_bucket ' , 'supported_sanitizers ' ] ) - -ENGINE_INFO = { - 'libfuzzer ' : - EngineInfo ( - upload_bucket='clusterfuzz-builds '
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py deleted file mode 100755 index 7ebf4c0..0000000 -- - a/infra/gcb/build.py +++ /dev/null @ @ -1,350 +0,0 @ @ - # ! /usr/bin/python2 - '' '' '' Starts project build on Google Cloud Builder . - -Usage : build.py < project_dir > - '' '' '' - -import base64 -import collections -import datetime -import os -import re -import subprocess -import sys -import time -import urllib -import yaml - -from oauth2client.client import GoogleCredentials -from oauth2client.service_account import ServiceAccountCredentials -from googleapiclient.discovery import build - -BUILD_TIMEOUT = 10 * 60 * 60 - -CONFIGURATIONS = { - 'sanitizer-address ' : [ 'SANITIZER=address ' ] , - 'sanitizer-memory ' : [ 'SANITIZER=memory ' ] , - 'sanitizer-undefined ' : [ 'SANITIZER=undefined ' ] , - 'sanitizer-coverage ' : [ 'SANITIZER=coverage ' ] , - 'engine-libfuzzer ' : [ 'FUZZING_ENGINE=libfuzzer ' ] , - 'engine-afl ' : [ 'FUZZING_ENGINE=afl ' ] , - 'engine-honggfuzz ' : [ 'FUZZING_ENGINE=honggfuzz ' ] , - 'engine-none ' : [ 'FUZZING_ENGINE=none ' ] , - } - -EngineInfo = collections.namedtuple ( 'EngineInfo ' , - [ 'upload_bucket ' , 'supported_sanitizers ' ] ) - -ENGINE_INFO = { - 'libfuzzer ' : - EngineInfo ( - upload_bucket='clusterfuzz-builds '
diff -- git a/projects/openvswitch/Dockerfile b/projects/openvswitch/Dockerfile new file mode 100644 index 0000000..212befb -- - /dev/null +++ b/projects/openvswitch/Dockerfile @ @ -0,0 +1,25 @ @ + # Copyright 2018 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + # + # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
diff -- git a/infra/base-images/base-clang/checkout_build_install_llvm.sh b/infra/base-images/base-clang/checkout_build_install_llvm.sh index d4ab51c..dd9a6cc 100755 -- - a/infra/base-images/base-clang/checkout_build_install_llvm.sh +++ b/infra/base-images/base-clang/checkout_build_install_llvm.sh @ @ -26,10 +26,11 @ @ cd $ SRC/chromium_tools git clone https : //chromium.googlesource.com/chromium/src/tools/clang cd clang -OUR_LLVM_REVISION=333631 # For manual bumping . +OUR_LLVM_REVISION=335507 # For manual bumping . +FORCE_OUR_REVISION=0 # To allow for manual downgrades . LLVM_REVISION= $ ( grep -Po `` CLANG_REVISION = '\K\d+ ( ? = ' ) '' scripts/update.py ) -if [ $ OUR_LLVM_REVISION -gt $ LLVM_REVISION ] ; then +if [ $ OUR_LLVM_REVISION -gt $ LLVM_REVISION ] || [ $ FORCE_OUR_REVISION -ne 0 ] ; then LLVM_REVISION= $ OUR_LLVM_REVISION fi diff -- git a/infra/base-images/base-runner/coverage b/infra/base-images/base-runner/coverage index e70efee..a0f2f58 100755 -- - a/infra/base-images/base-runner/coverage +++ b/infra/base-images/base-runner/coverage @ @ -46,6 +46,10 @ @ function run_fuzz_target { # Run each fuzz target , generate raw coverage dumps . for fuzz_target in $ FUZZ_TARGETS ; do + if grep -va $ FUZZER_BINARY `` LLVMFuzzerTestOneInput '' > /dev/null 2 > & 1 ; then + continue + fi + echo `` Running $ fuzz_target '' run_fuzz_target $ fuzz_target & objects= '' $ objects -object= $ fuzz_target '' diff -- git a/infra/base-images/base-runner/test_all b/infra/base-images/base-runner/test_all index f018e09..6517002 100755 -- - a/infra/base-images/base-runner/test_all +++ b/infra/base-images/base-runner/test_all @ @ -38,6 +38,10 @ @ for FUZZER_BINARY in $
diff -- git a/projects/openssl/build.sh b/projects/openssl/build.sh index 24fb404..0627eb3 100755 -- - a/projects/openssl/build.sh +++ b/projects/openssl/build.sh @ @ -17,12 +17,7 @ @ ./config enable-fuzz-libfuzzer -DPEDANTIC -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION no-shared enable-tls1_3 enable-rc5 enable-md2 enable-ec_nistp_64_gcc_128 enable-ssl3 enable-ssl3-method enable-nextprotoneg enable-weak-ssl-ciphers -- with-fuzzer-lib=/usr/lib/libFuzzingEngine $ CFLAGS -fno-sanitize=alignment - # openssl uses clang , not clang++ for linking . Add c++ libraries . -EX_LIBS= '' -ldl /usr/local/lib/libc++.a '' -if [ [ $ SANITIZER = undefined ] ] ; then - EX_LIBS= '' $ EX_LIBS /usr/local/lib/clang/4.0.0/lib/linux/libclang_rt.ubsan_standalone_cxx-x86_64.a /usr/local/lib/clang/4.0.0/lib/linux/libclang_rt.ubsan_standalone-x86_64.a '' -fi -make -j $ ( nproc ) EX_LIBS= '' $ EX_LIBS '' +make -j $ ( nproc ) LDCMD= '' clang++ $ CXXFLAGS '' fuzzers= $ ( find fuzz -executable -type f ' ! ' -name \*.py ' ! ' -name \*-test ) for f in $ fuzzers ; do
diff -- git a/projects/arduinojson/project.yaml b/projects/arduinojson/project.yaml index 9e8e4af..71e8954 100644 -- - a/projects/arduinojson/project.yaml +++ b/projects/arduinojson/project.yaml @ @ -2,6 +2,5 @ @ homepage : `` https : //github.com/bblanchon/ArduinoJson '' primary_contact : `` benoit.blanchon @ gmail.com '' sanitizers : - address - - memory : - experimental : True + - memory - undefined diff -- git a/projects/botan/project.yaml b/projects/botan/project.yaml index 78b9909..7541722 100644 -- - a/projects/botan/project.yaml +++ b/projects/botan/project.yaml @ @ -5,6 +5,5 @ @ auto_ccs : - `` d.neus @ sirrix.com '' sanitizers : - address - - memory : - experimental : True + - memory - undefined diff -- git a/projects/brotli/project.yaml b/projects/brotli/project.yaml index a001008..5af4b56 100644 -- - a/projects/brotli/project.yaml +++ b/projects/brotli/project.yaml @ @ -2,6 +2,5 @ @ homepage : `` https : //github.com/google/brotli '' primary_contact : `` eustas @ chromium.org '' sanitizers : - address - - memory : - experimental : True + - memory - undefined diff -- git a/projects/c-ares/project.yaml b/projects/c-ares/project.yaml index 12917ec..45ebc2d 100644 -- - a/projects/c-ares/project.yaml +++ b/projects/c-ares/project.yaml @ @ -2,6 +2,5 @ @ homepage : `` https : //c-ares.haxx.se/ '' primary_contact : `` drysdale @ google.com '' sanitizers : - address - - memory : - experimental : True + - memory - undefined diff -- git a/projects/expat/project.yaml b/projects/expat/project.yaml index
diff -- git a/projects/firefox/Dockerfile b/projects/firefox/Dockerfile new file mode 100644 index 0000000..d6188a8 -- - /dev/null +++ b/projects/firefox/Dockerfile @ @ -0,0 +1,26 @ @ + # Copyright 2018 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + # + # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
diff -- git a/projects/spidermonkey/Dockerfile b/projects/spidermonkey/Dockerfile new file mode 100644 index 0000000..5300919 -- - /dev/null +++ b/projects/spidermonkey/Dockerfile @ @ -0,0 +1,25 @ @ + # Copyright 2017 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + # + # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
diff -- git a/docs/code_coverage.md b/docs/code_coverage.md index f196b39..e14f4b2 100644 -- - a/docs/code_coverage.md +++ b/docs/code_coverage.md @ @ -87,20 +87,27 @ @ python infra/helper.py profile -- fuzz-target= < fuzz_target_name > -- corpus-dir= < my # # # Additional arguments for ` llvm-cov ` You may want to use some of the options of [ llvm-cov tool ] , for example , - ` -ignore-filename-regex= ` or ` -tab-size= ` . You can pass those to the helper -script after ` -- ` : + ` -ignore-filename-regex= ` . You can pass those to the helper script after ` -- ` : `` ` bash -python infra/helper.py profile $ project_name -- -ignore-filename-regex='.*code/to/be/ignored/ . * ' -tab-size=2 +python infra/helper.py profile $ project_name -- -ignore-filename-regex=.*code/to/be/ignored/ . * < other_extra_args > `` ` -To specify particular source files to be shown in the report , list the filepaths -at the end of the extra arguments sequence , for example : +To specify particular source files or directories to show in the report , list +their paths at the end of the extra arguments sequence , for example : `` ` bash -python infra/helper.py profile zlib -- -tab-size=8 /src/zlib/inftrees.c /src/zlib_uncompress_fuzzer.cc /src/zlib/zutil.c +python infra/helper.py profile zlib -- < other_extra_args
diff -- git a/infra/base-images/base-runner/download_corpus b/infra/base-images/base-runner/download_corpus deleted file mode 100755 index 6d88245..0000000 -- - a/infra/base-images/base-runner/download_corpus +++ /dev/null @ @ -1,26 +0,0 @ @ - # ! /bin/bash -u - # Copyright 2018 Google Inc. - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - # you may not use this file except in compliance with the License . - # You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software - # distributed under the License is distributed on an `` AS IS '' BASIS , - # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . - # See the License for the specific language governing permissions and - # limitations under the License . - # - # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py deleted file mode 100755 index 7ebf4c0..0000000 -- - a/infra/gcb/build.py +++ /dev/null @ @ -1,350 +0,0 @ @ - # ! /usr/bin/python2 - '' '' '' Starts project build on Google Cloud Builder . - -Usage : build.py < project_dir > - '' '' '' - -import base64 -import collections -import datetime -import os -import re -import subprocess -import sys -import time -import urllib -import yaml - -from oauth2client.client import GoogleCredentials -from oauth2client.service_account import ServiceAccountCredentials -from googleapiclient.discovery import build - -BUILD_TIMEOUT = 10 * 60 * 60 - -CONFIGURATIONS = { - 'sanitizer-address ' : [ 'SANITIZER=address ' ] , - 'sanitizer-memory ' : [ 'SANITIZER=memory ' ] , - 'sanitizer-undefined ' : [ 'SANITIZER=undefined ' ] , - 'sanitizer-coverage ' : [ 'SANITIZER=coverage ' ] , - 'engine-libfuzzer ' : [ 'FUZZING_ENGINE=libfuzzer ' ] , - 'engine-afl ' : [ 'FUZZING_ENGINE=afl ' ] , - 'engine-honggfuzz ' : [ 'FUZZING_ENGINE=honggfuzz ' ] , - 'engine-none ' : [ 'FUZZING_ENGINE=none ' ] , - } - -EngineInfo = collections.namedtuple ( 'EngineInfo ' , - [ 'upload_bucket ' , 'supported_sanitizers ' ] ) - -ENGINE_INFO = { - 'libfuzzer ' : - EngineInfo ( - upload_bucket='clusterfuzz-builds '
diff -- git a/infra/helper.py b/infra/helper.py index c16991a..ae3ec58 100755 -- - a/infra/helper.py +++ b/infra/helper.py @ @ -129,6 +129,11 @ @ def main ( ) : coverage_parser.add_argument ( 'extra_args ' , help='additional arguments to ' 'pass to llvm-cov utility . ' , nargs='* ' ) + download_corpora_parser = subparsers.add_parser ( + 'download_corpora ' , help='Download all corpora for a project . ' ) + download_corpora_parser.add_argument ( ' -- fuzz-target ' , help='specify name of a fuzz target ' ) + download_corpora_parser.add_argument ( 'project_name ' , help='name of the project ' ) + reproduce_parser = subparsers.add_parser ( 'reproduce ' , help='Reproduce a crash . ' ) reproduce_parser.add_argument ( ' -- valgrind ' , action='store_true ' , @ @ -159,6 +164,8 @ @ def main ( ) : return build_fuzzers ( args ) elif args.command == 'check_build ' : return check_build ( args ) + elif args.command == 'download_corpora ' : + return download_corpora ( args ) elif args.command == 'run_fuzzer ' : return run_fuzzer ( args ) elif args.command == 'coverage ' : @ @ -575,8 +582,11 @ @ def _get_latest_corpus ( project_name , fuzz_target , base_corpus_dir ) : subprocess.check_call ( command ) -def download_corpus ( args ) : - `` '' ''
diff -- git a/expat/Dockerfile b/expat/Dockerfile index d57215f..d60d484 100644 -- - a/expat/Dockerfile +++ b/expat/Dockerfile @ @ -18,4 +18,7 @ @ FROM ossfuzz/base-libfuzzer MAINTAINER mike.aizatsky @ gmail.com RUN apt-get install -y make autoconf automake libtool docbook2x -CMD /src/oss-fuzz/expat/build.sh +ENV GIT_CHECKOUT_DIR= '' expat '' +ENV GIT_URL= '' git : //git.code.sf.net/p/expat/code_git '' + +COPY build.sh /src/ diff -- git a/infra/base-images/base-libfuzzer/Dockerfile b/infra/base-images/base-libfuzzer/Dockerfile index fb478da..69f82b2 100644 -- - a/infra/base-images/base-libfuzzer/Dockerfile +++ b/infra/base-images/base-libfuzzer/Dockerfile @ @ -16,7 +16,7 @ @ FROM ossfuzz/base-clang MAINTAINER mike.aizatsky @ gmail.com -RUN apt-get install -y git libc6-dev +RUN apt-get install -y git libc6-dev RUN cd /src & & git clone -- depth 1 https : //github.com/google/oss-fuzz.git VOLUME /src/oss-fuzz @ @ -33,5 +33,7 @ @ ENV LDFLAGS `` -Wl , -whole-archive /usr/local/lib/libc++.a /usr/local/lib/libc++abi RUN mkdir /out VOLUME /out -COPY run / -ENTRYPOINT [ `` /run '' ] +RUN mkdir /src/bin +COPY compile checkout /src/bin/ +ENV PATH=/src/bin : $ PATH +CMD [ `` compile '' ] diff -- git a/infra/base-images/base-libfuzzer/README.md b/infra/base-images/base-libfuzzer/README.md new file mode 100644 index 0000000..2505107 -- - /dev/null +++ b/infra/base-images/base-libfuzzer/README.md @ @ -0,0 +1,13 @ @ + # base-libfuzzer +================ + +*Abstract* base image for all libfuzzer builders . + +Supported commands : + +* ` docker run -ti < image_name > [ compile
diff -- git a/projects/libaom/Dockerfile b/projects/libaom/Dockerfile new file mode 100644 index 0000000..fa85cec -- - /dev/null +++ b/projects/libaom/Dockerfile @ @ -0,0 +1,23 @ @ + # Copyright 2018 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + # + # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
diff -- git a/projects/openssl/build.sh b/projects/openssl/build.sh index 1ab3d00..9c691c8 100755 -- - a/projects/openssl/build.sh +++ b/projects/openssl/build.sh @ @ -15,7 +15,7 @ @ # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # -./config enable-fuzz-libfuzzer -DPEDANTIC -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION no-shared -- with-fuzzer-lib=/usr/lib/libfuzzer $ CFLAGS +./config enable-fuzz-libfuzzer -DPEDANTIC -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION no-shared -- with-fuzzer-lib=/usr/lib/libFuzzingEngine $ CFLAGS make -j $ ( nproc ) EX_LIBS= '' -ldl /usr/local/lib/libc++.a '' fuzzers= $ ( find fuzz -executable -type f ' ! ' -name \*.py ' ! ' -name \*-test )
diff -- git a/nss/Dockerfile b/nss/Dockerfile new file mode 100644 index 0000000..5cf55e0 -- - /dev/null +++ b/nss/Dockerfile @ @ -0,0 +1,23 @ @ + # Copyright 2016 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + # + # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
diff -- git a/infra/base-images/base-runner/bad_build_check b/infra/base-images/base-runner/bad_build_check index e133ea9..1509a77 100755 -- - a/infra/base-images/base-runner/bad_build_check +++ b/infra/base-images/base-runner/bad_build_check @ @ -1,4 +1,4 @ @ - # ! /bin/bash -ux + # ! /bin/bash -u # Copyright 2017 Google Inc. # # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; @ @ -15,56 +15,63 @ @ # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # - # Verify that the given fuzzer has proper coverage instrumentation . + # A minimal number of runs to test fuzz target with a non-empty input . +MIN_NUMBER_OF_RUNS=4 + + # The `` example '' target has 73 with ASan , 65 with UBSan , and 6648 with MSan . + # Real world targets have greater values ( arduinojson :
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py index 7410c0f..6940bd4 100755 -- - a/infra/gcb/build.py +++ b/infra/gcb/build.py @ @ -185,9 +185,6 @ @ def get_build_steps ( project_yaml , dockerfile_path ) : env.append ( 'OUT= ' + out ) - # To disable running of all fuzz targets while doing |test_all| step . - env.append ( 'SKIP_TEST_TARGET_RUN=1 ' ) - workdir = workdir_from_dockerfile ( dockerfile_path ) if not workdir : workdir = '/src' @ @ -209,17 +206,6 @ @ def get_build_steps ( project_yaml , dockerfile_path ) : 'rm -r /out & & cd /src & & cd { 1 } & & mkdir -p { 0 } & & compile & & rm -rf /work & & rm -rf /src'.format ( out , workdir ) , ] , } , - # test binaries - { 'name ' : 'gcr.io/oss-fuzz-base/base-runner ' , - 'env ' : env , - 'args ' : [ - 'bash ' , - '-c ' , - # Verify that fuzzers have been built properly and are not broken . - # TODO ( mmoroz ) : raise a notification if not passing the tests . - 'test_all' - ] - } , # zip binaries { 'name ' :
diff -- git a/projects/coreutils/Dockerfile b/projects/coreutils/Dockerfile new file mode 100644 index 0000000..1e2b8cf -- - /dev/null +++ b/projects/coreutils/Dockerfile @ @ -0,0 +1,24 @ @ + # Copyright 2016 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + # + # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py index 48bb117..4197756 100755 -- - a/infra/gcb/build.py +++ b/infra/gcb/build.py @ @ -195,27 +195,42 @ @ def get_build_steps ( project_yaml , dockerfile_path ) : env.append ( 'OUT= ' + out ) env.append ( 'MSAN_LIBS_PATH=/workspace/msan ' ) + # To disable running of all fuzz targets while doing |test_all| step . + env.append ( 'SKIP_TEST_TARGET_RUN=1 ' ) + workdir = workdir_from_dockerfile ( dockerfile_path ) if not workdir : workdir = '/src' - build_steps.append ( { + build_steps.extend ( [ # compile - 'name ' : image , - 'env ' : env , - 'args ' : [ - 'bash ' , - '-c ' , - # Remove /out to break loudly when a build script incorrectly uses - # /out instead of $ OUT . - # ` cd /src & & cd { workdir } ` ( where { workdir } is parsed from the - # Dockerfile ) . Container Builder overrides our workdir so we need to add - # this step to set it back . - # We also remove /work and /src to save disk space after a step . - # Container Builder does n't pass -- rm to
diff -- git a/gapis/api/vulkan/state_rebuilder.go b/gapis/api/vulkan/state_rebuilder.go index 5bb3019..e37008e 100644 -- - a/gapis/api/vulkan/state_rebuilder.go +++ b/gapis/api/vulkan/state_rebuilder.go @ @ -1409,12 +1409,8 @ @ func ( sb *stateBuilder ) createImage ( img ImageObject , imgPrimer *imagePrimer ) { // layout . The unused byteSizeAndExtent is to meet the requirement of // walkImageSubresourceRange ( ) appendImageLevelToOpaqueRanges : = func ( aspect VkImageAspectFlagBits , layer , level uint32 , unused byteSizeAndExtent ) { - // No need to handle for undefined layout - if isUndef , _ : = subCheckImageLevelLayout ( sb.ctx , nil , api.CmdNoID , nil , - sb.oldState , nil , 0 , nil , img , aspect , layer , level , - VkImageLayout_VK_IMAGE_LAYOUT_UNDEFINED , false ) ; isUndef { - return - } + // TODO : Re-enable the code to prevent copying to an + // undefined layout . opaqueRanges = append ( opaqueRanges , NewVkImageSubresourceRange ( sb.ta , VkImageAspectFlags ( aspect ) , // aspectMask level , // baseMipLevel
diff -- git a/core/codegen/output.go b/core/codegen/output.go index 2833109..792ff9e 100644 -- - a/core/codegen/output.go +++ b/core/codegen/output.go @ @ -108,8 +108,9 @ @ func ( m *Module ) Optimize ( ) { defer pass.Dispose ( ) // pass.AddFunctionInliningPass ( ) // Way too slow with this pass - pass.AddConstantPropagationPass ( ) pass.AddInstructionCombiningPass ( ) + pass.AddReassociatePass ( ) + pass.AddConstantPropagationPass ( ) pass.AddPromoteMemoryToRegisterPass ( ) pass.AddGVNPass ( ) pass.AddCFGSimplificationPass ( ) diff -- git a/gapil/compiler/plugins/encoder/encoder.go b/gapil/compiler/plugins/encoder/encoder.go index 83ee3f7..768ad01 100644 -- - a/gapil/compiler/plugins/encoder/encoder.go +++ b/gapil/compiler/plugins/encoder/encoder.go @ @ -597,15 +597,15 @ @ func ( e *encoder ) encodeValue ( s *compiler.S , ptr , buf *codegen.Value , ty semanti return case *semantic.Slice : e.writeBlob ( s , buf , func ( buf *codegen.Value ) { - root : = s.LocalInit ( `` root '' , ptr.Index ( 0 , compiler.SliceRoot ) .Load ( ) .Cast ( e.T.Uint64 ) ) - base : = s.LocalInit ( `` base '' , ptr.Index ( 0 , compiler.SliceBase ) .Load ( ) .Cast ( e.T.Uint64 ) ) + root : = s.LocalInit ( `` root '' , ptr.Index ( 0 , compiler.SliceRoot ) .Load ( ) .Cast ( e.T.Size ) ) + base : = s.LocalInit ( `` base ''
diff -- git a/core/event/task/task.go b/core/event/task/task.go index 92016aa..b7d6aaf 100644 -- - a/core/event/task/task.go +++ b/core/event/task/task.go @ @ -35,17 +35,17 @ @ func Once ( task Task ) Task { } } -// Retry repeatedly calls task until task returns a nil error , the number -// attempts reaches maxAttempts or the context is cancelled . Retry will sleep -// for retryDelay between retry attempts . +// Retry repeatedly calls f until f returns a true , the number of attempts +// reaches maxAttempts or the context is cancelled . Retry will sleep for +// retryDelay between retry attempts . // if maxAttempts < = 0 , then there is no maximum limit to the number of times -// task will be called . -func Retry ( ctx context.Context , maxAttempts int , retryDelay time.Duration , task Task ) error { +// f will be called . +func Retry ( ctx context.Context , maxAttempts int , retryDelay time.Duration , f func ( context.Context ) ( retry bool , err error ) ) error { var count int for { - err : = task ( ctx ) - if err == nil { - return nil + done , err : = f
diff -- git a/gapis/api/api.go b/gapis/api/api.go index d2f5248..eaa6be5 100644 -- - a/gapis/api/api.go +++ b/gapis/api/api.go @ @ -46,7 +46,7 @ @ type API interface { after [ ] uint64 , state *GlobalState , thread uint64 , - attachment FramebufferAttachment ) ( width , height , index uint32 , format *image.Format , err error ) + attachment FramebufferAttachment ) ( info FramebufferAttachmentInfo , err error ) // Context returns the active context for the given state . Context ( state *GlobalState , thread uint64 ) Context @ @ -55,6 +55,20 @ @ type API interface { CreateCmd ( name string ) Cmd } +// FramebufferAttachmentInfo describes a framebuffer at a given point in the trace +type FramebufferAttachmentInfo struct { + // Width in texels of the framebuffer + Width uint32 + // Height in texels of the framebuffer + Height uint32 + // Framebuffer index + Index uint32 + // Format of the image + Format *image.Format + // CanResize is true if this can be efficiently resized during replay . + CanResize bool + } + // ID is an API identifier type ID id.ID diff -- git a/gapis/api/gles/gles.go b/gapis/api/gles/gles.go index d4730f2..04cca8a 100644 -- - a/gapis/api/gles/gles.go +++ b/gapis/api/gles/gles.go @ @ -19,7 +19,6
diff -- git a/cmd/do/env.go b/cmd/do/env.go index d726b74..99a6472 100644 -- - a/cmd/do/env.go +++ b/cmd/do/env.go @ @ -40,19 +40,11 @ @ func env ( cfg Config ) *shell.Env { system32 : = cmd.Parent ( ) windows : = system32.Parent ( ) path = append ( path , system32.System ( ) , windows.System ( ) ) + path = append ( path , exePaths ( `` node.exe '' , `` adb.exe '' ) ... ) } else { - added : = map [ file.Path ] bool { } - for _ , name : = range [ ] string { `` sh '' , `` uname '' , `` sed '' , `` clang '' , `` gcc '' , `` node '' , `` adb '' } { - exe , err : = file.FindExecutable ( name ) - if err ! = nil { - continue - } - dir : = exe.Parent ( ) - if ! added [ dir ] { - path = append ( path , dir.System ( ) ) - added [ dir ] = true - } - } + path = append ( path , exePaths ( + '' sh '' , ``
diff -- git a/core/assert/slice.go b/core/assert/slice.go index e24c6d4..98aa152 100644 -- - a/core/assert/slice.go +++ b/core/assert/slice.go @ @ -14,7 +14,11 @ @ package assert -import `` reflect '' +import ( + '' reflect '' + + '' github.com/google/gapid/core/data/compare '' + ) // OnSlice is the result of calling ThatSlice on an Assertion . // It provides assertion tests that are specific to slice types . @ @ -59,7 +63,7 @ @ func ( o OnSlice ) EqualsWithComparator ( expected interface { } , same func ( a , b inter // DeepEquals asserts the array or slice matches expected using a deep-equal comparison . func ( o OnSlice ) DeepEquals ( expected interface { } ) bool { - return o.slicesEqual ( expected , reflect.DeepEqual ) + return o.slicesEqual ( expected , compare.DeepEqual ) } func ( o OnSlice ) slicesEqual ( expected interface { } , same func ( a , b interface { } ) bool ) bool { diff -- git a/core/data/compare/BUILD.bazel b/core/data/compare/BUILD.bazel index 2a1e390..689eeb3 100644 -- - a/core/data/compare/BUILD.bazel +++ b/core/data/compare/BUILD.bazel @ @ -26,6 +26,9 @ @ go_library ( ] , importpath = `` github.com/google/gapid/core/data/compare '' , visibility = [ `` //visibility : public '' ] , + deps =
diff -- git a/gapis/api/cmd_id_group.go b/gapis/api/cmd_id_group.go index 783bf7c..f216928 100644 -- - a/gapis/api/cmd_id_group.go +++ b/gapis/api/cmd_id_group.go @ @ -37,6 +37,7 @ @ type CmdIDGroup struct { Range CmdIDRange // The range of commands this group ( and items ) represents . Spans Spans // All sub-groups and sub-ranges of this group . UserData interface { } + Parent SubCmdIdx // SubCmdIdx of the SubCmdRoot if this CmdIDGroup belongs to a SubCmdRoot , otherwise just an empty SubCmdIdx } // SubCmdRoot is a new namespace under which subcommands live . @ @ -221,6 +222,12 @ @ func ( g CmdIDGroup ) Index ( index uint64 ) SpanItem { for _ , s : = range g.Spans { c : = s.itemCount ( ) if index < c { + // If the CmdIDGroup is a subcommand group , need to combine the SubCmdIdx + // of the immediate parent SubCmdRoot of this CmdIDGroup with the index + // target . + if x , ok : = s.item ( index ) . ( SubCmdIdx ) ; ok { + return append ( g.Parent , x ... ) + } return s.item ( index ) } index -= c @ @ -307,24 +314,27 @ @
diff -- git a/gapis/api/cmd_id_group.go b/gapis/api/cmd_id_group.go index 783bf7c..f216928 100644 -- - a/gapis/api/cmd_id_group.go +++ b/gapis/api/cmd_id_group.go @ @ -37,6 +37,7 @ @ type CmdIDGroup struct { Range CmdIDRange // The range of commands this group ( and items ) represents . Spans Spans // All sub-groups and sub-ranges of this group . UserData interface { } + Parent SubCmdIdx // SubCmdIdx of the SubCmdRoot if this CmdIDGroup belongs to a SubCmdRoot , otherwise just an empty SubCmdIdx } // SubCmdRoot is a new namespace under which subcommands live . @ @ -221,6 +222,12 @ @ func ( g CmdIDGroup ) Index ( index uint64 ) SpanItem { for _ , s : = range g.Spans { c : = s.itemCount ( ) if index < c { + // If the CmdIDGroup is a subcommand group , need to combine the SubCmdIdx + // of the immediate parent SubCmdRoot of this CmdIDGroup with the index + // target . + if x , ok : = s.item ( index ) . ( SubCmdIdx ) ; ok { + return append ( g.Parent , x ... ) + } return s.item ( index ) } index -= c @ @ -307,24 +314,27 @ @
diff -- git a/gapis/api/vulkan/BUILD.bazel b/gapis/api/vulkan/BUILD.bazel index e3052b7..1498461 100644 -- - a/gapis/api/vulkan/BUILD.bazel +++ b/gapis/api/vulkan/BUILD.bazel @ @ -62,6 +62,8 @ @ go_library ( `` resources.go '' , `` state.go '' , `` state_rebuilder.go '' , + `` image_rebuild_helper.go '' , + `` image_rebuild_shaders.go '' , `` vulkan.go '' , `` vulkan_terminator.go '' , `` wireframe.go '' , @ @ -128,6 +130,7 @ @ go_test ( srcs = [ `` externs_test.go '' , `` footprint_builder_test.go '' , + `` image_rebuild_helper_test.go '' , ] , embed = [ `` : go_default_library '' ] , deps = [ diff -- git a/gapis/api/vulkan/footprint_builder.go b/gapis/api/vulkan/footprint_builder.go index c9a53fe..6717676 100644 -- - a/gapis/api/vulkan/footprint_builder.go +++ b/gapis/api/vulkan/footprint_builder.go @ @ -17,6 +17,7 @ @ package vulkan import ( '' context '' '' fmt '' + '' time '' '' github.com/google/gapid/core/log '' '' github.com/google/gapid/core/math/interval '' @ @ -1640,6 +1641,8 @ @ func ( vb *FootprintBuilder ) BuildFootprint ( ctx context.Context , // Records the current last draw framebuffer image data , so that later when // the user request a command , we can always guarantee that the last draw // framebuffer is alive . + log.W ( ctx , `` id : % v , cmd : % v '' , id
diff -- git a/gapis/api/vulkan/BUILD.bazel b/gapis/api/vulkan/BUILD.bazel index e3052b7..1498461 100644 -- - a/gapis/api/vulkan/BUILD.bazel +++ b/gapis/api/vulkan/BUILD.bazel @ @ -62,6 +62,8 @ @ go_library ( `` resources.go '' , `` state.go '' , `` state_rebuilder.go '' , + `` image_rebuild_helper.go '' , + `` image_rebuild_shaders.go '' , `` vulkan.go '' , `` vulkan_terminator.go '' , `` wireframe.go '' , @ @ -128,6 +130,7 @ @ go_test ( srcs = [ `` externs_test.go '' , `` footprint_builder_test.go '' , + `` image_rebuild_helper_test.go '' , ] , embed = [ `` : go_default_library '' ] , deps = [ diff -- git a/gapis/api/vulkan/image_rebuild_helper.go b/gapis/api/vulkan/image_rebuild_helper.go new file mode 100644 index 0000000..8227fb8 -- - /dev/null +++ b/gapis/api/vulkan/image_rebuild_helper.go @ @ -0,0 +1,1131 @ @ +// Copyright ( C ) 2017 Google Inc. +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT
diff -- git a/gapis/api/cmd_id_group.go b/gapis/api/cmd_id_group.go index 783bf7c..f216928 100644 -- - a/gapis/api/cmd_id_group.go +++ b/gapis/api/cmd_id_group.go @ @ -37,6 +37,7 @ @ type CmdIDGroup struct { Range CmdIDRange // The range of commands this group ( and items ) represents . Spans Spans // All sub-groups and sub-ranges of this group . UserData interface { } + Parent SubCmdIdx // SubCmdIdx of the SubCmdRoot if this CmdIDGroup belongs to a SubCmdRoot , otherwise just an empty SubCmdIdx } // SubCmdRoot is a new namespace under which subcommands live . @ @ -221,6 +222,12 @ @ func ( g CmdIDGroup ) Index ( index uint64 ) SpanItem { for _ , s : = range g.Spans { c : = s.itemCount ( ) if index < c { + // If the CmdIDGroup is a subcommand group , need to combine the SubCmdIdx + // of the immediate parent SubCmdRoot of this CmdIDGroup with the index + // target . + if x , ok : = s.item ( index ) . ( SubCmdIdx ) ; ok { + return append ( g.Parent , x ... ) + } return s.item ( index ) } index -= c @ @ -307,24 +314,27 @ @
diff -- git a/gapii/cc/gles_extras.cpp b/gapii/cc/gles_extras.cpp index 250f70a..4b50ba0 100644 -- - a/gapii/cc/gles_extras.cpp +++ b/gapii/cc/gles_extras.cpp @ @ -132,13 +132,13 @ @ bool GlesSpy : :getFramebufferAttachmentSize ( uint32_t* width , uint32_t* height ) { return false ; } - auto framebuffer = ctx- > mObjects.mFramebuffers.find ( ctx- > mBoundReadFramebuffer ) ; - if ( framebuffer == ctx- > mObjects.mFramebuffers.end ( ) ) { + auto framebuffer = ctx- > mBound.mReadFramebuffer ; + if ( framebuffer == nullptr ) { return false ; } - auto attachment = framebuffer- > second- > mColorAttachments.find ( 0 ) ; - if ( attachment == framebuffer- > second- > mColorAttachments.end ( ) ) { + auto attachment = framebuffer- > mColorAttachments.find ( 0 ) ; + if ( attachment == framebuffer- > mColorAttachments.end ( ) ) { return false ; } diff -- git a/gapis/gfxapi/gles/api/asynchronous_queries.api b/gapis/gfxapi/gles/api/asynchronous_queries.api index 758461f..26775fd 100644 -- - a/gapis/gfxapi/gles/api/asynchronous_queries.api +++ b/gapis/gfxapi/gles/api/asynchronous_queries.api @ @ -14,6 +14,8 @ @ @ internal class Query { + QueryId ID + // Table 21.31 : Query Object State // GLuint QueryResult = 0 // TODO : or GL_FALSE ? // GLboolean QueryResultAvailable = GL_FALSE @ @ -38,7 +40,16 @ @ cmd void glBeginQuery ( GLenum target , QueryId query
diff -- git a/gapis/api/gles/draw_call.go b/gapis/api/gles/draw_call.go index 140b8d5..9cedad9 100644 -- - a/gapis/api/gles/draw_call.go +++ b/gapis/api/gles/draw_call.go @ @ -22,52 +22,66 @ @ import ( '' github.com/google/gapid/gapis/api '' ) +type drawCallIndices struct { + indices [ ] uint32 + drawMode GLenum + indexed bool + } + // drawCall is the interface implemented by all GLES draw call atoms . type drawCall interface { api.Cmd - getIndices ( - ctx context.Context , - c *Context , - s *api.GlobalState ) ( [ ] uint32 , uint32 , GLenum , error ) + getIndices ( ctx context.Context , c *Context , s *api.GlobalState ) ( drawCallIndices , error ) } -func ( a *GlDrawArrays ) getIndices ( - ctx context.Context , - c *Context , - s *api.GlobalState ) ( [ ] uint32 , uint32 , GLenum , error ) { - +func ( a *GlDrawArrays ) getIndices ( ctx context.Context , c *Context , s *api.GlobalState ) ( drawCallIndices , error ) { indices : = make ( [ ] uint32 , a.IndicesCount ) for i : = range indices { indices [ i ] = uint32 ( a.FirstIndex ) + uint32 ( i ) } - return indices , 0 , a.DrawMode ,
diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index edf2a0c..b5bd7b7 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -25,14 +25,14 @ @ protoc_go ( `` github.com/google/gapid/core/image '' `` core/image '' `` image.proto '' ) protoc_java ( `` core/image '' `` image.proto '' `` com/google/gapid/proto/image/Image '' ) protoc_go ( `` github.com/google/gapid/core/os/android/apk '' `` core/os/android/apk '' `` apk.proto '' ) protoc_go ( `` github.com/google/gapid/core/os/android '' `` core/os/android '' `` keycodes.proto '' ) -protoc_go ( `` github.com/google/gapid/gapidapk/pkginfo '' `` gapidapk/pkginfo '' `` pkginfo.proto '' ) -protoc_java ( `` gapidapk/pkginfo '' `` pkginfo.proto '' `` com/google/gapid/proto/pkginfo/PkgInfo '' ) protoc_go ( `` github.com/google/gapid/core/os/device/bind '' `` core/os/device/bind '' `` bind.proto '' ) protoc_go ( `` github.com/google/gapid/core/os/device '' `` core/os/device '' `` device.proto '' ) protoc_java ( `` core/os/device '' `` device.proto '' `` com/google/gapid/proto/device/Device '' ) protoc_cc ( `` github.com/google/gapid/core/os/device '' `` core/os/device '' `` device.proto '' ) protoc_go ( `` github.com/google/gapid/core/stream '' `` core/stream '' `` stream.proto '' ) protoc_java ( `` core/stream '' `` stream.proto '' `` com/google/gapid/proto/stream/Stream '' ) +protoc_go ( `` github.com/google/gapid/gapidapk/pkginfo '' `` gapidapk/pkginfo '' `` pkginfo.proto '' ) +protoc_java ( `` gapidapk/pkginfo '' `` pkginfo.proto '' `` com/google/gapid/proto/pkginfo/PkgInfo '' ) protoc_go ( `` github.com/google/gapid/gapis/atom/atom_pb '' `` gapis/atom/atom_pb '' `` atom.proto '' ) protoc_cc
diff -- git a/core/event/task/task.go b/core/event/task/task.go index 92016aa..b7d6aaf 100644 -- - a/core/event/task/task.go +++ b/core/event/task/task.go @ @ -35,17 +35,17 @ @ func Once ( task Task ) Task { } } -// Retry repeatedly calls task until task returns a nil error , the number -// attempts reaches maxAttempts or the context is cancelled . Retry will sleep -// for retryDelay between retry attempts . +// Retry repeatedly calls f until f returns a true , the number of attempts +// reaches maxAttempts or the context is cancelled . Retry will sleep for +// retryDelay between retry attempts . // if maxAttempts < = 0 , then there is no maximum limit to the number of times -// task will be called . -func Retry ( ctx context.Context , maxAttempts int , retryDelay time.Duration , task Task ) error { +// f will be called . +func Retry ( ctx context.Context , maxAttempts int , retryDelay time.Duration , f func ( context.Context ) ( retry bool , err error ) ) error { var count int for { - err : = task ( ctx ) - if err == nil { - return nil + done , err : = f
diff -- git a/gapic/src/main/com/google/gapid/Main.java b/gapic/src/main/com/google/gapid/Main.java index 91033a4..4b35c65 100644 -- - a/gapic/src/main/com/google/gapid/Main.java +++ b/gapic/src/main/com/google/gapid/Main.java @ @ -20,6 +20,7 @ @ import static com.google.gapid.widgets.Widgets.scheduleIfNotDisposed ; import com.google.gapid.models.Follower ; import com.google.gapid.models.Models ; +import com.google.gapid.models.Settings ; import com.google.gapid.server.Client ; import com.google.gapid.server.GapiPaths ; import com.google.gapid.util.Flags ; @ @ -53,8 +54,9 @ @ public class Main { Display.setAppName ( Messages.WINDOW_TITLE ) ; Display.setAppVersion ( Version.GAPID_VERSION.toString ( ) ) ; + Settings settings = Settings.load ( ) ; - Server server = new Server ( ) ; + Server server = new Server ( settings ) ; AtomicReference < UI > uiRef = new AtomicReference < UI > ( null ) ; try { server.connect ( ( code , panic ) - > { @ @ -63,7 +65,7 @ @ public class Main { ui.showServerDiedMessage ( code , panic ) ; } } ) ; - uiRef.set ( new UI ( server.getClient ( ) , args ) ) ; + uiRef.set ( new UI ( settings , server.getClient ( ) , args ) ) ; uiRef.get ( ) .show ( ) ; } finally { uiRef.set ( null ) ; @ @ -90,13 +92,15 @ @ public class Main { } ) ; } + private final
diff -- git a/gapis/gfxapi/state.go b/gapis/gfxapi/state.go index 57163f7..7ecab57 100644 -- - a/gapis/gfxapi/state.go +++ b/gapis/gfxapi/state.go @ @ -88,27 +88,28 @ @ func NewStateWithAllocator ( allocator memory.Allocator , memoryLayout *device.Memo } } -func ( st State ) String ( ) string { - mem : = make ( [ ] string , 0 , len ( st.Memory ) ) - for i , p : = range st.Memory { +func ( s State ) String ( ) string { + mem : = make ( [ ] string , 0 , len ( s.Memory ) ) + for i , p : = range s.Memory { mem = append ( mem , fmt.Sprintf ( `` % d : % v '' , i , strings.Replace ( p.String ( ) , `` \n '' , `` \n `` , -1 ) ) ) } - apis : = make ( [ ] string , 0 , len ( st.APIs ) ) - for a , s : = range st.APIs { + apis : = make ( [ ] string , 0 , len ( s.APIs ) ) + for a , s : = range s.APIs { apis = append ( apis ,
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/gapii/cc/vulkan_mid_execution.cpp b/gapii/cc/vulkan_mid_execution.cpp index 9c10f05..8c3f682 100644 -- - a/gapii/cc/vulkan_mid_execution.cpp +++ b/gapii/cc/vulkan_mid_execution.cpp @ @ -469,7 +469,7 @ @ void VulkanSpy : :prepareGPUBuffers ( CallObserver *observer , PackEncoder *group , } ; auto block_pitch = [ this ] ( const VkExtent3D & extent , uint32_t format , - uint32_t mip_level ) - > pitch { + uint32_t mip_level , uint32_t aspect_bit , bool in_buffer ) - > pitch { auto elementAndTexelBlockSize = subGetElementAndTexelBlockSize ( nullptr , nullptr , format ) ; const uint32_t texel_width = @ @ -485,20 +485,31 @ @ void VulkanSpy : :prepareGPUBuffers ( CallObserver *observer , PackEncoder *group , subRoundUpTo ( nullptr , nullptr , width , texel_width ) ; const uint32_t height_in_blocks = subRoundUpTo ( nullptr , nullptr , height , texel_height ) ; - const size_t size = width_in_blocks * height_in_blocks * - elementAndTexelBlockSize.mElementSize ; + const uint32_t element_size = [ & ] ( ) - > uint32_t { + switch ( aspect_bit ) { + case VkImageAspectFlagBits : :VK_IMAGE_ASPECT_COLOR_BIT : + return elementAndTexelBlockSize.mElementSize ; + case VkImageAspectFlagBits : :VK_IMAGE_ASPECT_DEPTH_BIT : + return subGetDepthElementSize ( nullptr , nullptr , format , in_buffer ) ; + case VkImageAspectFlagBits : :VK_IMAGE_ASPECT_STENCIL_BIT : + return 1 ; +
diff -- git a/core/image/image.go b/core/image/image.go index eb89a4c..a219431 100644 -- - a/core/image/image.go +++ b/core/image/image.go @ @ -88,6 +88,22 @ @ func ( b *Data ) Convert ( to *Format ) ( *Data , error ) { return & Data { Bytes : bytes , Width : b.Width , Height : b.Height , Depth : b.Depth , Format : to } , nil } +// NewInfo stores the image.Data 's content to the database then uses the ID to +// create a new image.Info which describes this image.Data . +func ( b *Data ) NewInfo ( ctx context.Context ) ( *Info , error ) { + id , err : = database.Store ( ctx , b.Bytes ) + if err ! = nil { + return nil , fmt.Errorf ( `` Failed to create imageInfo from imageData % v : % v '' , b , err ) + } + return & Info { + Format : b.Format , + Width : b.Width , + Height : b.Height , + Depth : b.Depth , + Bytes : NewID ( id ) , + } , nil + } + // Difference returns the normalized square error between the two images .
diff -- git a/integration/maptest/map_test.go b/integration/maptest/map_test.go index 553c573..af8eddd 100644 -- - a/integration/maptest/map_test.go +++ b/integration/maptest/map_test.go @ @ -41,7 +41,7 @ @ func createBatchLeaves ( batch , n int ) [ ] *trillian.MapLeaf { leaves : = make ( [ ] *trillian.MapLeaf , 0 , n ) for i : = 0 ; i < n ; i++ { leaves = append ( leaves , & trillian.MapLeaf { - Index : testonly.HashKey ( fmt.Sprintf ( `` batch- % d-key- % d '' , batch , i ) ) , + Index : testonly.TransparentHash ( fmt.Sprintf ( `` batch- % d-key- % d '' , batch , i ) ) , LeafValue : [ ] byte ( fmt.Sprintf ( `` batch- % d-value- % d '' , batch , i ) ) , } ) } @ @ -126,16 +126,16 @ @ func TestInclusion ( t *testing.T ) { desc : `` maphasher single '' , HashStrategy : trillian.HashStrategy_TEST_MAP_HASHER , leaves : [ ] *trillian.MapLeaf { - { Index : testonly.TransparentHash ( `` A '' ) , LeafValue : [ ] byte ( `` A '' ) } , + { Index : h2b ( `` 0000000000000000000000000000000000000000000000000000000000000000 '' ) , LeafValue : [ ]
diff -- git a/integration/map.go b/integration/map.go index b06394c..9f83230 100644 -- - a/integration/map.go +++ b/integration/map.go @ @ -32,6 +32,8 @ @ import ( const treeID = int64 ( 0 ) +var hasher = maphasher.Default + // RunMapIntegration runs a map integration test using the given map ID and client . func RunMapIntegration ( ctx context.Context , mapID int64 , pubKey crypto.PublicKey , client trillian.TrillianMapClient ) error { { @ @ -90,7 +92,6 @ @ func RunMapIntegration ( ctx context.Context , mapID int64 , pubKey crypto.PublicKey // Check values // Mix up the ordering of requests - h : = maphasher.Default randIndexes : = make ( [ ] [ ] byte , len ( tests ) ) for i , r : = range rand.Perm ( len ( tests ) ) { randIndexes [ i ] = tests [ r ] .Index @ @ -129,8 +130,8 @ @ func RunMapIntegration ( ctx context.Context , mapID int64 , pubKey crypto.PublicKey if got , want : = leaf.LeafValue , ev.LeafValue ; ! bytes.Equal ( got , want ) { return fmt.Errorf ( `` got value % s , want % s '' , got , want ) } - leafHash : = h.HashLeaf ( treeID
diff -- git a/integration/map.go b/integration/map.go deleted file mode 100644 index 9f83230..0000000 -- - a/integration/map.go +++ /dev/null @ @ -1,168 +0,0 @ @ -// Copyright 2016 Google Inc. All Rights Reserved . -// -// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; -// you may not use this file except in compliance with the License . -// You may obtain a copy of the License at -// -// http : //www.apache.org/licenses/LICENSE-2.0 -// -// Unless required by applicable law or agreed to in writing , software -// distributed under the License is distributed on an `` AS IS '' BASIS , -// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . -// See the License for the specific language governing permissions and -// limitations under the License . - -package integration - -import ( - '' bytes '' - '' context '' - '' crypto '' - '' encoding/hex '' - '' fmt '' - '' math/rand '' - - '' github.com/golang/glog '' - '' github.com/google/trillian '' - tcrypto `` github.com/google/trillian/crypto '' - '' github.com/google/trillian/merkle '' - '' github.com/google/trillian/merkle/maphasher '' - '' github.com/google/trillian/testonly '' - ) - -const treeID = int64
diff -- git a/crypto/object.go b/crypto/object.go new file mode 100644 index 0000000..147d7b0 -- - /dev/null +++ b/crypto/object.go @ @ -0,0 +1,44 @ @ +// Copyright 2016 Google Inc. All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package crypto + +import ( + '' crypto '' + '' encoding/json '' + + '' github.com/benlaurie/objecthash/go/objecthash '' + '' github.com/google/trillian/crypto/sigpb '' + ) + +// SignObject signs the requested object using ObjectHash . +func ( s *Signer ) SignObject ( obj interface { } ) ( *sigpb.DigitallySigned , error ) { + j , err : = json.Marshal ( obj )
diff -- git a/crypto/verifier_test.go b/crypto/verifier_test.go index 11139d0..93c71ed 100644 -- - a/crypto/verifier_test.go +++ b/crypto/verifier_test.go @ @ -17,6 +17,7 @ @ package crypto import ( '' testing '' + '' github.com/google/trillian '' '' github.com/google/trillian/crypto/keys '' '' github.com/google/trillian/crypto/sigpb '' '' github.com/google/trillian/testonly '' @ @ -81,3 +82,59 @ @ func TestSignVerify ( t *testing.T ) { } } } + +func TestSignVerifyObject ( t *testing.T ) { + key , err : = keys.NewFromPrivatePEM ( testonly.DemoPrivateKey , testonly.DemoPrivateKeyPass ) + if err ! = nil { + t.Fatalf ( `` Failed to open test key , err= % v '' , err ) + } + signer : = NewSHA256Signer ( key ) + + type subfield struct { + c int + } + + for _ , tc : = range [ ] struct { + obj interface { } + } { + { & trillian.MapperMetadata { } } , + { & trillian.MapperMetadata { HighestFullyCompletedSeq : 0 } } , + { & trillian.MapperMetadata { HighestFullyCompletedSeq : 1 } } , + + { & trillian.SignedMapRoot { } } , + { & trillian.SignedMapRoot { + MapId : 0xcafe , + } } , + { & trillian.SignedMapRoot { +
diff -- git a/merkle/hstar2.go b/merkle/hstar2.go index 1cbfee3..a241ff0 100644 -- - a/merkle/hstar2.go +++ b/merkle/hstar2.go @ @ -17,6 +17,7 @ @ package merkle import ( '' errors '' '' fmt '' + '' log '' '' math/big '' '' sort '' @ @ -54,15 +55,11 @ @ func NewHStar2 ( treeID int64 , hasher hashers.MapHasher ) HStar2 { } } -// HStar2Root calculates the root of a sparse Merkle tree of depth n which contains -// the given set of non-null leaves . -func ( s *HStar2 ) HStar2Root ( n int , values [ ] HStar2LeafHash ) ( [ ] byte , error ) { +// HStar2Root calculates the root of a sparse Merkle tree of a given depth +// which contains the given set of non-null leaves . +func ( s *HStar2 ) HStar2Root ( depth int , values [ ] HStar2LeafHash ) ( [ ] byte , error ) { sort.Sort ( ByIndex { values } ) - return s.hStar2b ( n , values , smtZero , - func ( depth int , index *big.Int ) ( [ ] byte , error ) { - return s.hasher.HashEmpty ( s.treeID , PaddedBytes ( index , s.hasher.Size ( ) ) ,
diff -- git a/integration/maptest/map_test.go b/integration/maptest/map_test.go index 5eee5c2..41542c2 100644 -- - a/integration/maptest/map_test.go +++ b/integration/maptest/map_test.go @ @ -231,6 +231,22 @ @ func TestInclusion ( t *testing.T ) { { Index : h2b ( `` 0000000000000000000000000000000000000000000000000000000000000002 '' ) , LeafValue : [ ] byte ( `` C '' ) } , } , } , + { + desc : `` CONIKS across subtrees '' , + HashStrategy : trillian.HashStrategy_CONIKS_SHA512_256 , + leaves : [ ] *trillian.MapLeaf { + { Index : h2b ( `` 0000000000000180000000000000000000000000000000000000000000000000 '' ) , LeafValue : [ ] byte ( `` Z '' ) } , + } , + } , + { + desc : `` CONIKS multi '' , + HashStrategy : trillian.HashStrategy_CONIKS_SHA512_256 , + leaves : [ ] *trillian.MapLeaf { + { Index : h2b ( `` 0000000000000000000000000000000000000000000000000000000000000000 '' ) , LeafValue : [ ] byte ( `` A '' ) } , + { Index : h2b ( `` 0000000000000000000000000000000000000000000000000000000000000001 '' ) , LeafValue : [ ] byte ( `` B '' ) } , + { Index : h2b ( `` 0000000000000000000000000000000000000000000000000000000000000002 '' ) , LeafValue : [ ] byte ( `` C '' ) } , + } , + }
diff -- git a/storage/types_test.go b/storage/types_test.go index 7f6867e..9f9144f 100644 -- - a/storage/types_test.go +++ b/storage/types_test.go @ @ -16,202 +16,295 @ @ package storage import ( '' bytes '' + '' encoding/binary '' + '' encoding/hex '' '' fmt '' '' testing '' ) -func TestZerosNewNodeIDWithPrefix ( t *testing.T ) { - n : = NewNodeIDWithPrefix ( 0 , 0 , 0 , 64 ) - if got , want : = n.Path , [ ] byte { 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 } ; ! bytes.Equal ( got , want ) { - t.Fatalf ( `` Expected Path of % v , but got % v '' , want , got ) - } - } - func TestNewNodeIDWithPrefix ( t *testing.T ) { - n : = NewNodeIDWithPrefix ( 0x12345678 , 32 , 32 , 64 ) - if got , want : = n.Path , [ ] byte { 0x12 , 0x34 , 0x56 , 0x78 , 0x00 , 0x00 , 0x00 , 0x00 } ; ! bytes.Equal ( got , want ) { - t.Fatalf ( `` Expected Path of % v , but got % v '' ,
diff -- git a/storage/types.go b/storage/types.go index 68af0f0..5df4ef9 100644 -- - a/storage/types.go +++ b/storage/types.go @ @ -86,7 +86,13 @ @ func NewEmptyNodeID ( maxLenBits int ) NodeID { } // NewNodeIDWithPrefix creates a new NodeID of nodeIDLen bits with the prefixLen MSBs set to prefix . +// NewNodeIDWithPrefix places the lower prefixLenBits of prefix in the most significant bits of path . +// Path will have enough bytes to hold maxLenBits +// func NewNodeIDWithPrefix ( prefix uint64 , prefixLenBits , nodeIDLenBits , maxLenBits int ) NodeID { + if got , want : = nodeIDLenBits % 8 , 0 ; got ! = want { + panic ( fmt.Sprintf ( `` nodeIDLenBits mod 8 : % v , want % v '' , got , want ) ) + } maxLenBytes : = bytesForBits ( maxLenBits ) p : = NodeID { Path : make ( [ ] byte , maxLenBytes ) , @ @ -156,6 +162,9 @ @ func ( n *NodeID ) SetBit ( i int , b uint ) { // Bit returns 1 if the ith bit is true , and false otherwise . func ( n *NodeID ) Bit ( i int ) uint { +
diff -- git a/merkle/sparse_merkle_tree.go b/merkle/sparse_merkle_tree.go index 5127ace..f81f4c9 100644 -- - a/merkle/sparse_merkle_tree.go +++ b/merkle/sparse_merkle_tree.go @ @ -192,23 +192,6 @ @ func ( s *subtreeWriter ) RootHash ( ) ( [ ] byte , error ) { return r.hash , r.err } -func nodeIDFromAddress ( size int , prefix [ ] byte , index *big.Int , depth int ) storage.NodeID { - switch { - case depth < 0 : - panic ( fmt.Errorf ( `` logic error : can not have depth ( % d ) < 0 '' , depth ) ) - case depth == 0 : - return storage.NewEmptyNodeID ( size * 8 ) - } - ib : = index.Bytes ( ) - t : = make ( [ ] byte , size ) - - copy ( t , prefix ) - copy ( t [ size-len ( ib ) : ] , ib ) - n : = storage.NewNodeIDFromHash ( t ) - n.PrefixLenBits = len ( prefix ) *8 + depth - return n - } - // buildSubtree is the worker function which calculates the root hash . // The root chan will have had exactly one entry placed in it , and
diff -- git a/integration/maptest/map_test.go b/integration/maptest/map_test.go index d8bc8e1..5eee5c2 100644 -- - a/integration/maptest/map_test.go +++ b/integration/maptest/map_test.go @ @ -117,6 +117,97 @ @ func newTreeWithHasher ( ctx context.Context , env *integration.MapEnv , hashStrateg return tree , hasher , nil } +func TestLeafHistory ( t *testing.T ) { + ctx : = context.Background ( ) + for _ , tc : = range [ ] struct { + desc string + HashStrategy trillian.HashStrategy + batches [ ] [ ] *trillian.MapLeaf + get [ ] struct { + revision int64 + Index [ ] byte + LeafValue [ ] byte + } + } { + { + desc : `` single leaf update '' , + HashStrategy : trillian.HashStrategy_TEST_MAP_HASHER , + batches : [ ] [ ] *trillian.MapLeaf { + [ ] *trillian.MapLeaf { } , // Advance revision without changing anything . + [ ] *trillian.MapLeaf { + { Index : h2b ( `` 0000000000000000000000000000000000000000000000000000000000000000 '' ) , LeafValue : [ ] byte ( `` A '' ) } , + } , + [ ] *trillian.MapLeaf { } , // Advance revision without changing anything . + [ ] *trillian.MapLeaf { + { Index : h2b ( `` 0000000000000000000000000000000000000000000000000000000000000000 '' ) , LeafValue
diff -- git a/storage/tools/dump_tree/dumplib/dumplib.go b/storage/tools/dump_tree/dumplib/dumplib.go new file mode 100644 index 0000000..eeeda21 -- - /dev/null +++ b/storage/tools/dump_tree/dumplib/dumplib.go @ @ -0,0 +1,506 @ @ +// Copyright 2017 Google Inc. All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package dumplib + +import ( + '' bytes '' + '' context '' + '' crypto '' + '' crypto/sha256 '' + '' crypto/x509 '' + '' encoding/base64 '' + '' encoding/binary '' + '' encoding/hex '' + '' fmt '' + '' sort '' + '' strconv '' + '' strings '' + '' time '' + + '' github.com/gogo/protobuf/proto ''
diff -- git a/log/sequencer_test.go b/log/sequencer_test.go index 376a15b..674ede1 100644 -- - a/log/sequencer_test.go +++ b/log/sequencer_test.go @ @ -59,10 +59,10 @ @ var testRoot16 = trillian.SignedLogRoot { // These will be accepted in either order because of custom sorting in the mock var updatedNodes = [ ] storage.Node { - { NodeID : storage.NodeID { Path : [ ] uint8 { 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x10 } , PrefixLenBits : 64 , PathLenBits : 64 } , + { NodeID : storage.NodeID { Path : [ ] uint8 { 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x10 } , PrefixLenBits : 64 } , Hash : testonly.MustDecodeBase64 ( `` L5Iyd7aFOVewxiRm29xD+EU+jvEo4RfufBijKdflWMk= '' ) , NodeRevision : 6 } , { - NodeID : storage.NodeID { Path : [ ] uint8 { 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 } , PrefixLenBits : 59 , PathLenBits : 64 } , + NodeID : storage.NodeID { Path : [ ] uint8 { 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 } , PrefixLenBits :
diff -- git a/integration/maptest/map_test.go b/integration/maptest/map_test.go index 7927602..d8bc8e1 100644 -- - a/integration/maptest/map_test.go +++ b/integration/maptest/map_test.go @ @ -88,7 +88,7 @ @ func verifyGetMapLeavesResponse ( getResp *trillian.GetMapLeavesResponse , indexes leafHash : = incl.GetLeaf ( ) .GetLeafHash ( ) proof : = incl.GetInclusion ( ) - if got , want : = leafHash , hasher.HashLeaf ( treeID , index , hasher.BitLen ( ) , leaf ) ; ! bytes.Equal ( got , want ) { + if got , want : = leafHash , hasher.HashLeaf ( treeID , index , leaf ) ; ! bytes.Equal ( got , want ) { return fmt.Errorf ( `` HashLeaf ( % s ) : % x , want % x '' , leaf , got , want ) } if err : = merkle.VerifyMapInclusionProof ( treeID , index , @ @ -356,8 +356,7 @ @ func TestNonExistentLeaf ( t *testing.T ) { t.Errorf ( `` len ( leaf ) : % v , want , % v '' , got , want ) } - if got , want : = leafHash , - hasher.HashLeaf ( tree.TreeId , index , hasher.BitLen ( ) , leaf ) ; ! bytes.Equal ( got , want ) { + if
diff -- git a/server/trillian_log_server/main.go b/server/trillian_log_server/main.go index 34f324e..8a39103 100644 -- - a/server/trillian_log_server/main.go +++ b/server/trillian_log_server/main.go @ @ -51,7 +51,11 @ @ import ( ) var ( - mySQLURI = flag.String ( `` mysql_uri '' , `` test : zaphod @ tcp ( 127.0.0.1:3306 ) /test '' , `` Connection URI for MySQL database '' ) + mySQLURI = flag.String ( `` mysql_uri '' , `` test : zaphod @ tcp ( 127.0.0.1:3306 ) /test '' , `` Connection URI for MySQL database '' ) + // MySQL supports 151 connections by default ( https : //dev.mysql.com/doc/refman/5.7/en/server-system-variables.html # sysvar_max_connections ) . + // Default to a maximum of ~1/2 of this , because other Trillian binaries will also need to make connections . + mySQLMaxConns = flag.Int ( `` mysql_max_conns '' , 75 , `` Maximum number of connections that may be made to the MySQL database '' ) + rpcEndpoint = flag.String ( `` rpc_endpoint '' , `` localhost:8090 '' , `` Endpoint for RPC requests ( host : port ) '' ) httpEndpoint = flag.String ( `` http_endpoint '' , `` localhost:8091 '' , `` Endpoint for HTTP metrics and REST requests on ( host : port , empty means disabled
diff -- git a/log/sequencer.go b/log/sequencer.go index 3017037..8cd1768 100644 -- - a/log/sequencer.go +++ b/log/sequencer.go @ @ -284,13 +284,13 @ @ func ( s logSequencingTask ) update ( ctx context.Context , leaves [ ] *trillian.LogLea // IntegrateBatch wraps up all the operations needed to take a batch of queued // leaves and integrate them into the tree . -func ( s Sequencer ) IntegrateBatch ( ctx context.Context , logID int64 , limit int , guardWindow , maxRootDurationInterval time.Duration ) ( int , error ) { +func ( s Sequencer ) IntegrateBatch ( ctx context.Context , tree *trillian.Tree , limit int , guardWindow , maxRootDurationInterval time.Duration ) ( int , error ) { start : = s.timeSource.Now ( ) - label : = strconv.FormatInt ( logID , 10 ) + label : = strconv.FormatInt ( tree.TreeId , 10 ) numLeaves : = 0 var newLogRoot *trillian.SignedLogRoot - err : = s.logStorage.ReadWriteTransaction ( ctx , logID , func ( ctx context.Context , tx storage.LogTreeTX ) error { + err : = s.logStorage.ReadWriteTransaction ( ctx , tree , func ( ctx context.Context , tx storage.LogTreeTX ) error { stageStart : = s.timeSource.Now ( ) defer seqBatches.Inc ( label ) defer func ( ) { seqLatency.Observe
diff -- git a/log/sequencer.go b/log/sequencer.go index 3017037..8cd1768 100644 -- - a/log/sequencer.go +++ b/log/sequencer.go @ @ -284,13 +284,13 @ @ func ( s logSequencingTask ) update ( ctx context.Context , leaves [ ] *trillian.LogLea // IntegrateBatch wraps up all the operations needed to take a batch of queued // leaves and integrate them into the tree . -func ( s Sequencer ) IntegrateBatch ( ctx context.Context , logID int64 , limit int , guardWindow , maxRootDurationInterval time.Duration ) ( int , error ) { +func ( s Sequencer ) IntegrateBatch ( ctx context.Context , tree *trillian.Tree , limit int , guardWindow , maxRootDurationInterval time.Duration ) ( int , error ) { start : = s.timeSource.Now ( ) - label : = strconv.FormatInt ( logID , 10 ) + label : = strconv.FormatInt ( tree.TreeId , 10 ) numLeaves : = 0 var newLogRoot *trillian.SignedLogRoot - err : = s.logStorage.ReadWriteTransaction ( ctx , logID , func ( ctx context.Context , tx storage.LogTreeTX ) error { + err : = s.logStorage.ReadWriteTransaction ( ctx , tree , func ( ctx context.Context , tx storage.LogTreeTX ) error { stageStart : = s.timeSource.Now ( ) defer seqBatches.Inc ( label ) defer func ( ) { seqLatency.Observe
diff -- git a/crypto/keys/private.go b/crypto/keys/private.go index 502b2b3..3337139 100644 -- - a/crypto/keys/private.go +++ b/crypto/keys/private.go @ @ -15,6 +15,7 @ @ package keys import ( + '' context '' '' crypto '' '' crypto/ecdsa '' '' crypto/rsa '' @ @ -23,8 +24,16 @ @ import ( '' errors '' '' fmt '' '' io/ioutil '' + + '' github.com/google/trillian '' ) +// Provider handles acquisition of signers for trees . +type Provider interface { + // Signer returns a signer for the given tree . + Signer ( context.Context , *trillian.Tree ) ( crypto.Signer , error ) + } + // NewFromPrivatePEMFile reads a PEM-encoded private key from a file . // The key may be protected by a password . func NewFromPrivatePEMFile ( keyFile , keyPassword string ) ( crypto.Signer , error ) { diff -- git a/examples/ct/ctmapper/README.md b/examples/ct/ctmapper/README.md index ebcb805..7091b89 100644 -- - a/examples/ct/ctmapper/README.md +++ b/examples/ct/ctmapper/README.md @ @ -19,7 +19,7 @ @ go build ./examples/ct/ctmapper/mapper go build ./examples/ct/ctmapper/lookup # in one terminal : -./trillian_map_server -- logtostderr -- private_key_password=towel -- private_key_file=testdata/trillian-map-server-key.pem +./trillian_map_server -- logtostderr # in another ( leaving the trillian_map_server running ) : ./mapper -source http : //ct.googleapis.com/pilot -map_id=1 -map_server=localhost:8091 -- logtostderr diff -- git a/extension/builtin/default_registry.go b/extension/builtin/default_registry.go index cad0d6f..3775a32 100644
diff -- git a/merkle/merkle_path.go b/merkle/merkle_path.go index 7e59b6d..4874014 100644 -- - a/merkle/merkle_path.go +++ b/merkle/merkle_path.go @ @ -3,9 +3,13 @ @ package merkle import ( '' fmt '' + '' github.com/golang/glog '' '' github.com/google/trillian/storage '' ) +// Verbosity level for logging of debug related items +const vLevel = 2 + // CalcInclusionProofNodeAddresses returns the tree node IDs needed to // build an inclusion proof for a specified leaf and tree size . The maxBitLen parameter // is copied into all the returned nodeIDs . @ @ -37,10 +41,10 @ @ func CalcInclusionProofNodeAddresses ( treeSize , index int64 , maxBitLen int ) ( [ ] st proof = append ( proof , n ) } else if sibling == lastNodeAtLevel { // The tree may skip levels because it 's not completely filled in . These nodes - // do n't exist - drop : = depth - subtreeDepth ( treeSize , depth-1 ) - sibling = sibling < < uint ( drop ) - n , err : = storage.NewNodeIDForTreeCoords ( int64 ( depth-drop ) , sibling , maxBitLen ) + // do n't exist in storage , the value we want is a copy of a node further down + //
diff -- git a/examples/ct/handlers.go b/examples/ct/handlers.go index 3225e75..47fa608 100644 -- - a/examples/ct/handlers.go +++ b/examples/ct/handlers.go @ @ -285,14 +285,11 @ @ func addChainInternal ( ctx context.Context , c LogContext , w http.ResponseWriter , req : = trillian.QueueLeavesRequest { LogId : c.logID , Leaves : [ ] *trillian.LogLeaf { & leaf } } glog.V ( 2 ) .Infof ( `` % s : % s = > grpc.QueueLeaves '' , c.LogPrefix , method ) - rsp , err : = c.rpcClient.QueueLeaves ( ctx , & req ) - glog.V ( 2 ) .Infof ( `` % s : % s < = grpc.QueueLeaves status= % v '' , c.LogPrefix , method , rsp.GetStatus ( ) ) + _ , err = c.rpcClient.QueueLeaves ( ctx , & req ) + glog.V ( 2 ) .Infof ( `` % s : % s < = grpc.QueueLeaves err= % v '' , c.LogPrefix , method , err ) if err ! = nil { return http.StatusInternalServerError , fmt.Errorf ( `` backend QueueLeaves request failed : % v '' , err ) } - if ! rpcStatusOK ( rsp.GetStatus ( ) ) { - return http.StatusInternalServerError , fmt.Errorf ( `` backend QueueLeaves request failed , status= %
diff -- git a/.travis.yml b/.travis.yml index a25fe12..dbd9bb4 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -11,6 +11,14 @ @ env : - GOFLAGS= - GOFLAGS=-race +addons : + apt : + sources : + - ubuntu-toolchain-r-test + packages : + - gcc-4.8 + - g++-4.8 + install : - | if [ ! -d $ HOME/gopath/src/github.com/google ] ; then @ @ -21,6 +29,8 @ @ install : - if [ [ $ TRAVIS_OS_NAME == `` osx '' ] ] ; then brew update > /dev/null & & brew install mariadb & & mysql.server start ; fi script : + - export CXX= '' g++-4.8 '' + - export CC= '' gcc-4.8 '' - go install github.com/golang/mock/mockgen - go get -u github.com/golang/lint/golint - go get -u github.com/golang/protobuf/ ... @ @ -47,8 +57,5 @ @ script : services : mysql before_script : - - mysql -u root -e 'DROP DATABASE IF EXISTS test ; ' - - mysql -u root -e 'CREATE DATABASE test ; ' - - mysql -u root -e `` GRANT ALL ON test . * TO 'test ' @ 'localhost ' IDENTIFIED BY 'zaphod ' ; '' - - mysql -u root -D test < storage/mysql/storage.sql + -
diff -- git a/docs/storage/commit_log/commit_log_based_storage_design.md b/docs/storage/commit_log/commit_log_based_storage_design.md new file mode 100644 index 0000000..787a477 -- - /dev/null +++ b/docs/storage/commit_log/commit_log_based_storage_design.md @ @ -0,0 +1,357 @ @ + # # Commit-Log based Trillian storage + +*Status : Draft* + +*Authors : al @ google.com , drysdale @ google.com , filippo @ cloudflare.com* + +*Last Updated : 2017-05-12* + + # # Objective + +A design for an alternative Trillian storage layer which uses a distributed and +immutable *commit log* as the source of truth for a Trillian Log 's contents and +sequence information , and one or more independent * '' readonly '' * databases built +from the commit log to serve queries . + +This design allows for : + +* flexibility in scaling Trillian deployments , +* easier recovery from corrupt/failed database deployments since in many + cases operators can simply delete the failed DB instance and allow it to be + rebuilt from the commit log , while the remaining instances continue to + serve . + +Initially , this will be built using Apache Kafka for the commit log , with +datacentre-local Apache HBase instances for the serving databases , since this +is what Cloudflare has operational experience in running ,
diff -- git a/storage/log_storage.go b/storage/log_storage.go index 61e4e4a..27c0144 100644 -- - a/storage/log_storage.go +++ b/storage/log_storage.go @ @ -112,6 +112,12 @ @ type LogStorage interface { // the returned object , and values read through it should only be propagated // if Commit returns without error . BeginForTree ( ctx context.Context , treeID int64 ) ( LogTreeTX , error ) + + // ReadWriteTransaction starts a RW transaction on the underlying storage , and + // calls f with it . + // If f fails and returns an error , the storage implementation may optionally + // retry with a new transaction , and f MUST NOT keep state across calls . + ReadWriteTransaction ( ctx context.Context , treeID int64 , f func ( ctx context.Context , tx LogTreeTX ) error ) error } // CountByLogID is a map of total number of items keyed by log ID . diff -- git a/storage/map_storage.go b/storage/map_storage.go index a03da49..6cf90c4 100644 -- - a/storage/map_storage.go +++ b/storage/map_storage.go @ @ -92,4 +92,10 @ @ type MapStorage interface { // the returned object , and values read through it should only be propagated // if Commit returns without error . BeginForTree ( ctx context.Context , treeID int64 ) (
diff -- git a/integration/maptest/map.go b/integration/maptest/map.go index dc41339..ee4ded1 100644 -- - a/integration/maptest/map.go +++ b/integration/maptest/map.go @ @ -226,7 +226,6 @ @ func RunMapRevisionZero ( ctx context.Context , t *testing.T , tadmin trillian.Trill } // TODO ( phad ) : ideally we 'd inspect err 's type and check it contains a NOT_FOUND Code ( 5 ) , but I do n't want // a dependency on gRPC here . - } ) } } @ @ -544,7 +543,7 @ @ func runMapBatchTest ( ctx context.Context , t *testing.T , desc string , tmap trilli r , err : = tmap.GetSignedMapRoot ( ctx , & trillian.GetSignedMapRootRequest { MapId : tree.TreeId , } ) - if err ! = nil { + if err ! = nil || r.MapRoot == nil { t.Fatalf ( `` % s : failed to get map head : % v '' , desc , err ) } diff -- git a/integration/maptest/map_test.go b/integration/maptest/map_test.go index 4decb7b..dc86501 100644 -- - a/integration/maptest/map_test.go +++ b/integration/maptest/map_test.go @ @ -30,7 +30,6 @ @ import ( var server = flag.String ( `` map_rpc_server '' , `` '' , `` Server address : port '' ) func TestMapIntegration ( t *testing.T ) { - flag.Parse ( )
diff -- git a/integration/maptest/map.go b/integration/maptest/map.go index dc41339..ee4ded1 100644 -- - a/integration/maptest/map.go +++ b/integration/maptest/map.go @ @ -226,7 +226,6 @ @ func RunMapRevisionZero ( ctx context.Context , t *testing.T , tadmin trillian.Trill } // TODO ( phad ) : ideally we 'd inspect err 's type and check it contains a NOT_FOUND Code ( 5 ) , but I do n't want // a dependency on gRPC here . - } ) } } @ @ -544,7 +543,7 @ @ func runMapBatchTest ( ctx context.Context , t *testing.T , desc string , tmap trilli r , err : = tmap.GetSignedMapRoot ( ctx , & trillian.GetSignedMapRootRequest { MapId : tree.TreeId , } ) - if err ! = nil { + if err ! = nil || r.MapRoot == nil { t.Fatalf ( `` % s : failed to get map head : % v '' , desc , err ) } diff -- git a/integration/maptest/map_test.go b/integration/maptest/map_test.go index 4decb7b..dc86501 100644 -- - a/integration/maptest/map_test.go +++ b/integration/maptest/map_test.go @ @ -30,7 +30,6 @ @ import ( var server = flag.String ( `` map_rpc_server '' , `` '' , `` Server address : port '' ) func TestMapIntegration ( t *testing.T ) { - flag.Parse ( )
diff -- git a/.travis.yml b/.travis.yml index 952375a..392817d 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -17,14 +17,17 @ @ install : mkdir -p $ HOME/gopath/src/github.com/google ln -s $ TRAVIS_BUILD_DIR $ HOME/gopath/src/github.com/google/trillian fi - - mkdir protoc + - mkdir ../protoc - | ( - cd protoc + cd ../protoc wget https : //github.com/google/protobuf/releases/download/v3.2.0/protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip unzip protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip + git clone https : //github.com/googleapis/googleapis.git + cd include/google + ln -s ../../googleapis/google/rpc ) - - export PATH= $ ( pwd ) /protoc/bin : $ PATH + - export PATH= $ ( pwd ) /../protoc/bin : $ PATH - go get -d ./ ... - if [ [ $ TRAVIS_OS_NAME == `` osx '' ] ] ; then brew update > /dev/null & & brew install mariadb & & mysql.server start ; fi - go get -u github.com/client9/misspell/cmd/misspell diff -- git a/client/client_proxy.go b/client/client_proxy.go index 0a8f9fa..7a0218a 100644 -- - a/client/client_proxy.go +++ b/client/client_proxy.go @ @ -17,10 +17,8 @ @ package client import ( '' math/rand '' - context `` golang.org/x/net/context '' - - google_protobuf `` github.com/golang/protobuf/ptypes/empty '' '' github.com/google/trillian '' + '' golang.org/x/net/context '' '' google.golang.org/grpc '' ) @ @ -32,7 +30,7 @ @ type MockLogClient struct
diff -- git a/.travis.yml b/.travis.yml index 952375a..392817d 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -17,14 +17,17 @ @ install : mkdir -p $ HOME/gopath/src/github.com/google ln -s $ TRAVIS_BUILD_DIR $ HOME/gopath/src/github.com/google/trillian fi - - mkdir protoc + - mkdir ../protoc - | ( - cd protoc + cd ../protoc wget https : //github.com/google/protobuf/releases/download/v3.2.0/protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip unzip protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip + git clone https : //github.com/googleapis/googleapis.git + cd include/google + ln -s ../../googleapis/google/rpc ) - - export PATH= $ ( pwd ) /protoc/bin : $ PATH + - export PATH= $ ( pwd ) /../protoc/bin : $ PATH - go get -d ./ ... - if [ [ $ TRAVIS_OS_NAME == `` osx '' ] ] ; then brew update > /dev/null & & brew install mariadb & & mysql.server start ; fi - go get -u github.com/client9/misspell/cmd/misspell diff -- git a/client/client.go b/client/client.go index 45196ac..bd0742e 100644 -- - a/client/client.go +++ b/client/client.go @ @ -27,6 +27,7 @ @ import ( '' github.com/google/trillian/client/backoff '' '' github.com/google/trillian/crypto '' '' github.com/google/trillian/merkle '' + '' google.golang.org/genproto/googleapis/rpc/code '' '' google.golang.org/grpc '' '' google.golang.org/grpc/codes '' ) @ @ -206,6 +207,13 @ @ func ( c *LogClient ) queueLeaf ( ctx context.Context ,
diff -- git a/.travis.yml b/.travis.yml index 952375a..392817d 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -17,14 +17,17 @ @ install : mkdir -p $ HOME/gopath/src/github.com/google ln -s $ TRAVIS_BUILD_DIR $ HOME/gopath/src/github.com/google/trillian fi - - mkdir protoc + - mkdir ../protoc - | ( - cd protoc + cd ../protoc wget https : //github.com/google/protobuf/releases/download/v3.2.0/protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip unzip protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip + git clone https : //github.com/googleapis/googleapis.git + cd include/google + ln -s ../../googleapis/google/rpc ) - - export PATH= $ ( pwd ) /protoc/bin : $ PATH + - export PATH= $ ( pwd ) /../protoc/bin : $ PATH - go get -d ./ ... - if [ [ $ TRAVIS_OS_NAME == `` osx '' ] ] ; then brew update > /dev/null & & brew install mariadb & & mysql.server start ; fi - go get -u github.com/client9/misspell/cmd/misspell diff -- git a/client/client.go b/client/client.go index 45196ac..bd0742e 100644 -- - a/client/client.go +++ b/client/client.go @ @ -27,6 +27,7 @ @ import ( '' github.com/google/trillian/client/backoff '' '' github.com/google/trillian/crypto '' '' github.com/google/trillian/merkle '' + '' google.golang.org/genproto/googleapis/rpc/code '' '' google.golang.org/grpc '' '' google.golang.org/grpc/codes '' ) @ @ -206,6 +207,13 @ @ func ( c *LogClient ) queueLeaf ( ctx context.Context ,
diff -- git a/docs/source/Schemas.md b/docs/source/Schemas.md index daeb90a..70d3e22 100755 -- - a/docs/source/Schemas.md +++ b/docs/source/Schemas.md @ @ -278,6 +278,9 @ @ Current understood attributes : - ` key ` ( on a field ) : this field is meant to be used as a key when sorting a vector of the type of table it sits in . Can be used for in-place binary search . +- ` map_entry ` ( on a table ) : The table must have a string field annotated with + the key attribute.enable vectors of this table to be parsed as a JSON + object instead of an array of object . # # JSON Parsing diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index 46f6540..e5de62a 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -134,10 +134,17 @ @ struct Type { // Represents a parsed scalar value , it 's type , and field offset . struct Value { - Value ( ) : constant ( `` 0 '' ) , offset ( static_cast < voffset_t > ( - ~ ( static_cast < voffset_t > ( 0U ) ) ) ) { } + Value ( ) : string ( `` 0 '' ) , offset ( static_cast <
diff -- git a/docs/source/Schemas.md b/docs/source/Schemas.md index daeb90a..174168d 100755 -- - a/docs/source/Schemas.md +++ b/docs/source/Schemas.md @ @ -278,6 +278,9 @ @ Current understood attributes : - ` key ` ( on a field ) : this field is meant to be used as a key when sorting a vector of the type of table it sits in . Can be used for in-place binary search . +- ` map_entry ` ( on a table ) : The table must have two fields , one of which + having the ` key ` attribute . Enable vectors of this table to be parsed as a + JSON object instead of an array of object . # # JSON Parsing diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index f77b13e..d2f5d22 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -14,8 +14,8 @ @ * limitations under the License . */ - # ifndef FLATBUFFERS_H_ - # define FLATBUFFERS_H_ + # ifndef INCLUDE_FLATBUFFERS_FLATBUFFERS_H_ + # define INCLUDE_FLATBUFFERS_FLATBUFFERS_H_ # include < assert.h > @ @ -45,7 +45,7 @ @ # define FLATBUFFERS_LITTLEENDIAN 0 # else # define FLATBUFFERS_LITTLEENDIAN 1 - # endif // __BIG_ENDIAN__ + # endif // __BIG_ENDIAN__ # elif defined ( _MSC_VER ) # if defined ( _M_PPC
diff -- git a/CMakeLists.txt b/CMakeLists.txt index bc71610..b8ccc9d 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -145,7 +145,7 @ @ elseif ( $ { CMAKE_CXX_COMPILER_ID } MATCHES `` Clang '' ) elseif ( MSVC ) # warning C4512 : assignment operator could not be generated - set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } /wd4512 '' ) + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } /W4 /WX /wd4512 '' ) endif ( ) if ( FLATBUFFERS_CODE_COVERAGE ) diff -- git a/include/flatbuffers/flexbuffers.h b/include/flatbuffers/flexbuffers.h index a5d24fd..b29a163 100644 -- - a/include/flatbuffers/flexbuffers.h +++ b/include/flatbuffers/flexbuffers.h @ @ -105,7 +105,7 @ @ inline Type ToTypedVectorElementType ( Type t ) { inline Type ToFixedTypedVectorElementType ( Type t , uint8_t *len ) { assert ( IsFixedTypedVector ( t ) ) ; auto fixed_type = t - TYPE_VECTOR_INT2 ; - *len = fixed_type / 3 + 2 ; // 3 types each , starting from length 2 . + *len = static_cast < uint8_t > ( fixed_type / 3 + 2 ) ; // 3 types each , starting from length 2. return static_cast < Type > ( fixed_type % 3 + TYPE_INT ) ; } @ @ -602,7 +602,7 @ @ class Reference { template < typename T
diff -- git a/.gitignore b/.gitignore index cdb37b3..b351ea7 100755 -- - a/.gitignore +++ b/.gitignore @ @ -5,6 +5,7 @ @ *.o.d *.class *.a +*.pyc *~ *.vcxproj *.vcxproj.filters @ @ -38,3 +39,6 @ @ CMakeLists.txt.user CMakeScripts/** build/Xcode/FlatBuffers.xcodeproj/project.xcworkspace/** build/Xcode/FlatBuffers.xcodeproj/xcuserdata/** +python/*.egg +python/*.egg-info +.venv diff -- git a/CMakeLists.txt b/CMakeLists.txt index 811e6f2..67c55ca 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -15,6 +15,7 @ @ set ( FlatBuffers_Compiler_SRCS src/idl_gen_cpp.cpp src/idl_gen_general.cpp src/idl_gen_go.cpp + src/idl_gen_python.cpp src/idl_gen_text.cpp src/idl_gen_fbs.cpp src/flatc.cpp diff -- git a/CONTRIBUTING.md b/CONTRIBUTING.md new file mode 100644 index 0000000..aebd885 -- - /dev/null +++ b/CONTRIBUTING.md @ @ -0,0 +1,28 @ @ +Contributing { # contributing } +============ + +Want to contribute ? Great ! First , read this page ( including the small print at +the end ) . + + # Before you contribute +Before we can use your code , you must sign the + [ Google Individual Contributor License Agreement ] ( https : //developers.google.com/open-source/cla/individual ? csw=1 ) + ( CLA ) , which you can do online . The CLA is necessary mainly because you own the +copyright to your changes , even after your contribution becomes part of our +codebase , so we need your permission to use and distribute your code . We also
diff -- git a/CMakeLists.txt b/CMakeLists.txt index d313980..d74123a 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -226,7 +226,7 @ @ endif ( ) if ( FLATBUFFERS_BUILD_GRPCTEST ) if ( CMAKE_COMPILER_IS_GNUCXX ) - set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter '' ) + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter -Wno-shadow '' ) endif ( ) add_executable ( grpctest $ { FlatBuffers_GRPCTest_SRCS } ) target_link_libraries ( grpctest grpc++_unsecure pthread dl ) diff -- git a/grpc/tests/grpctest.cpp b/grpc/tests/grpctest.cpp index f0a1f57..2207fb5 100644 -- - a/grpc/tests/grpctest.cpp +++ b/grpc/tests/grpctest.cpp @ @ -27,24 +27,21 @ @ using namespace MyGame : :Example ; // code . It implements all rpcs specified in the FlatBuffers schema . class ServiceImpl final : public MyGame : :Example : :MonsterStorage : :Service { virtual : :grpc : :Status Store ( : :grpc : :ServerContext* context , - const flatbuffers : :BufferRef < Monster > *request , - flatbuffers : :BufferRef < Stat > *response ) + const flatbuffers : :grpc : :Message < Monster > *request , + flatbuffers : :grpc : :Message < Stat > *response ) override { // Create a response from the incoming request name . fbb_.Clear ( ) ; auto stat_offset = CreateStat (
diff -- git a/CMakeLists.txt b/CMakeLists.txt index d313980..d74123a 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -226,7 +226,7 @ @ endif ( ) if ( FLATBUFFERS_BUILD_GRPCTEST ) if ( CMAKE_COMPILER_IS_GNUCXX ) - set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter '' ) + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter -Wno-shadow '' ) endif ( ) add_executable ( grpctest $ { FlatBuffers_GRPCTest_SRCS } ) target_link_libraries ( grpctest grpc++_unsecure pthread dl ) diff -- git a/grpc/tests/grpctest.cpp b/grpc/tests/grpctest.cpp index f0a1f57..2207fb5 100644 -- - a/grpc/tests/grpctest.cpp +++ b/grpc/tests/grpctest.cpp @ @ -27,24 +27,21 @ @ using namespace MyGame : :Example ; // code . It implements all rpcs specified in the FlatBuffers schema . class ServiceImpl final : public MyGame : :Example : :MonsterStorage : :Service { virtual : :grpc : :Status Store ( : :grpc : :ServerContext* context , - const flatbuffers : :BufferRef < Monster > *request , - flatbuffers : :BufferRef < Stat > *response ) + const flatbuffers : :grpc : :Message < Monster > *request , + flatbuffers : :grpc : :Message < Stat > *response ) override { // Create a response from the incoming request name . fbb_.Clear ( ) ; auto stat_offset = CreateStat (
diff -- git a/CMakeLists.txt b/CMakeLists.txt index d313980..d74123a 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -226,7 +226,7 @ @ endif ( ) if ( FLATBUFFERS_BUILD_GRPCTEST ) if ( CMAKE_COMPILER_IS_GNUCXX ) - set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter '' ) + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter -Wno-shadow '' ) endif ( ) add_executable ( grpctest $ { FlatBuffers_GRPCTest_SRCS } ) target_link_libraries ( grpctest grpc++_unsecure pthread dl ) diff -- git a/examples/grpc/greeter/Makefile b/examples/grpc/greeter/Makefile new file mode 100644 index 0000000..3746705 -- - /dev/null +++ b/examples/grpc/greeter/Makefile @ @ -0,0 +1,14 @ @ +CXXFLAGS ? = -I../../../include +LDFLAGS ? = + +.PHONY : all +all : server client + +greeter_generated.h : greeter.fbs + flatc -- grpc -- cpp $ < + +server : server.cpp greeter.grpc.fb.cc greeter_generated.h greeter.grpc.fb.h + g++ -std=c++11 -O2 $ ( CXXFLAGS ) $ ( LDFLAGS ) -lgpr -lgrpc -lgrpc++ server.cpp greeter.grpc.fb.cc -o $ @ + +client : client.cpp greeter.grpc.fb.cc greeter_generated.h greeter.grpc.fb.h + g++ -std=c++11 -O2 $ ( CXXFLAGS ) $ ( LDFLAGS ) -lgpr -lgrpc -lgrpc++ client.cpp greeter.grpc.fb.cc -o $ @ diff -- git a/examples/grpc/greeter/client.cpp b/examples/grpc/greeter/client.cpp new file mode 100644 index 0000000..ab89003 -- - /dev/null +++ b/examples/grpc/greeter/client.cpp @ @ -0,0 +1,84 @ @ + #
diff -- git a/CMakeLists.txt b/CMakeLists.txt index d313980..d74123a 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -226,7 +226,7 @ @ endif ( ) if ( FLATBUFFERS_BUILD_GRPCTEST ) if ( CMAKE_COMPILER_IS_GNUCXX ) - set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter '' ) + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter -Wno-shadow '' ) endif ( ) add_executable ( grpctest $ { FlatBuffers_GRPCTest_SRCS } ) target_link_libraries ( grpctest grpc++_unsecure pthread dl ) diff -- git a/docs/source/doxyfile b/docs/source/doxyfile index 770da9f..64af671 100755 -- - a/docs/source/doxyfile +++ b/docs/source/doxyfile @ @ -765,6 +765,7 @ @ INPUT = `` FlatBuffers.md '' \ `` ../../CONTRIBUTING.md '' \ `` Tutorial.md '' \ `` GoApi.md '' \ + `` gRPC/CppUsage.md '' \ `` groups '' \ `` ../../java/com/google/flatbuffers '' \ `` ../../python/flatbuffers/builder.py '' \ @ @ -883,21 +884,21 @ @ EXCLUDE_SYMBOLS = # that contain example code fragments that are included ( see the \include # command ) . -EXAMPLE_PATH = `` GoApi_generated.txt '' +EXAMPLE_PATH = `` GoApi_generated.txt '' `` ../../grpc/samples '' # If the value of the EXAMPLE_PATH tag contains directories , you can use the # EXAMPLE_PATTERNS tag to specify one or more wildcard pattern ( like *.cpp and # *.h ) to filter out
diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index c166e4b..3f18a86 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -105,8 +105,10 @ @ # if ( ! defined ( _MSC_VER ) || _MSC_VER > 1600 ) & & \ ( ! defined ( __GNUC__ ) || ( __GNUC__ * 100 + __GNUC_MINOR__ > = 407 ) ) # define FLATBUFFERS_FINAL_CLASS final + # define FLATBUFFERS_OVERRIDE override # else # define FLATBUFFERS_FINAL_CLASS + # define FLATBUFFERS_OVERRIDE # endif # if ( ! defined ( _MSC_VER ) || _MSC_VER > = 1900 ) & & \ @ @ -123,6 +125,31 @ @ # define FLATBUFFERS_NOEXCEPT # endif +// NOTE : the FLATBUFFERS_DELETE_FUNC macro may change the access mode to +// private , so be sure to put it at the end or reset access mode explicitly . + # if ( ! defined ( _MSC_VER ) || _MSC_FULL_VER > = 180020827 ) & & \ + ( ! defined ( __GNUC__ ) || ( __GNUC__ * 100 + __GNUC_MINOR__ > = 404 ) ) + # define FLATBUFFERS_DELETE_FUNC ( func ) func = delete ; + # else + # define FLATBUFFERS_DELETE_FUNC ( func ) private : func ; + # endif + + # if
diff -- git a/java/com/google/flatbuffers/Table.java b/java/com/google/flatbuffers/Table.java index 8f83653..c426389 100644 -- - a/java/com/google/flatbuffers/Table.java +++ b/java/com/google/flatbuffers/Table.java @ @ -18,7 +18,6 @ @ package com.google.flatbuffers ; import static com.google.flatbuffers.Constants . * ; import java.nio.ByteBuffer ; -import java.nio.charset.Charset ; // All tables in the generated code derive from this class , and add their own accessors . public class Table { @ @ -45,7 +44,7 @ @ public class Table { protected String __string ( int offset ) { offset += bb.getInt ( offset ) ; if ( bb.hasArray ( ) ) { - return new String ( bb.array ( ) , offset + SIZEOF_INT , bb.getInt ( offset ) , Charset.forName ( `` UTF-8 '' ) ) ; + return new String ( bb.array ( ) , offset + SIZEOF_INT , bb.getInt ( offset ) , FlatBufferBuilder.utf8charset ) ; } else { // We ca n't access .array ( ) , since the ByteBuffer is read-only . // We 're forced to make an extra copy : @ @ -54,7 +53,7 @ @ public class Table { bb.position ( offset + SIZEOF_INT ) ; bb.get ( copy ) ; bb.position ( old_pos ) ; - return new String ( copy , 0 , copy.length
diff -- git a/python/flatbuffers/compat.py b/python/flatbuffers/compat.py index e031535..2fc9cca 100644 -- - a/python/flatbuffers/compat.py +++ b/python/flatbuffers/compat.py @ @ -12,9 +12,11 @ @ # See the License for the specific language governing permissions and # limitations under the License . - '' '' '' A tiny version of ` six ` to help with backwards compability. `` '' '' + '' '' '' A tiny version of ` six ` to help with backwards compability . Also includes + compatibility helpers for numpy. `` '' '' import sys +import imp PY2 = sys.version_info [ 0 ] == 2 PY26 = sys.version_info [ 0:2 ] == ( 2 , 6 ) @ @ -43,4 +45,37 @ @ else : memoryview_type = memoryview struct_bool_decl = `` ? '' + # Helper functions to facilitate making numpy optional instead of required + +def import_numpy ( ) : + `` '' '' + Returns the numpy module if it exists on the system , + otherwise returns None . + `` '' '' + try : + imp.find_module ( 'numpy ' ) + numpy_exists = True + except ImportError : + numpy_exists = False + + if numpy_exists : + # We do this outside of try/except block
diff -- git a/CMakeLists.txt b/CMakeLists.txt index d313980..d74123a 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -226,7 +226,7 @ @ endif ( ) if ( FLATBUFFERS_BUILD_GRPCTEST ) if ( CMAKE_COMPILER_IS_GNUCXX ) - set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter '' ) + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter -Wno-shadow '' ) endif ( ) add_executable ( grpctest $ { FlatBuffers_GRPCTest_SRCS } ) target_link_libraries ( grpctest grpc++_unsecure pthread dl ) diff -- git a/docs/source/doxyfile b/docs/source/doxyfile index 770da9f..5c38cb9 100755 -- - a/docs/source/doxyfile +++ b/docs/source/doxyfile @ @ -765,6 +765,7 @ @ INPUT = `` FlatBuffers.md '' \ `` ../../CONTRIBUTING.md '' \ `` Tutorial.md '' \ `` GoApi.md '' \ + `` gRPC/CppUsage.md '' \ `` groups '' \ `` ../../java/com/google/flatbuffers '' \ `` ../../python/flatbuffers/builder.py '' \ diff -- git a/docs/source/doxygen_layout.xml b/docs/source/doxygen_layout.xml index 77866df..504d15c 100644 -- - a/docs/source/doxygen_layout.xml +++ b/docs/source/doxygen_layout.xml @ @ -39,6 +39,10 @ @ title= '' Use in Python '' / > < tab type= '' user '' url= '' @ ref flexbuffers '' title= '' Schema-less version '' / > + < tab type= '' usergroup '' url= '' '' title= '' gRPC '' > + < tab type= '' user '' url= '' @ ref flatbuffers_grpc_guide_use_cpp
diff -- git a/CMakeLists.txt b/CMakeLists.txt index d3c6a7a..53d453b 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -50,6 +50,7 @ @ set ( FlatBuffers_Compiler_SRCS src/idl_gen_python.cpp src/idl_gen_fbs.cpp src/idl_gen_grpc.cpp + src/idl_gen_json_schema.cpp src/flatc.cpp src/flatc_main.cpp grpc/src/compiler/schema_interface.h diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index 68426c2..f7cccd2 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -380,6 +380,7 @ @ struct IDLOptions { kJson = 1 < < 7 , kBinary = 1 < < 8 , kTs = 1 < < 9 , + kJsonSchema = 1 < < 10 , kMAX } ; @ @ -713,6 +714,12 @ @ extern bool GeneratePython ( const Parser & parser , const std : :string & path , const std : :string & file_name ) ; +// Generate Json schema file +// See idl_gen_json_schema.cpp . +extern bool GenerateJsonSchema ( const Parser & parser , + const std : :string & path , + const std : :string & file_name ) ; + // Generate C # files from the definitions in the Parser object . // See idl_gen_csharp.cpp . extern bool GenerateCSharp ( const Parser & parser , diff -- git a/src/flatc_main.cpp b/src/flatc_main.cpp index cb8f217..02d01c0 100644 -- - a/src/flatc_main.cpp +++ b/src/flatc_main.cpp @ @ -96,7 +96,12 @ @ int main ( int argc
diff -- git a/reflection/generate_code.bat b/reflection/generate_code.bat index 8f58c0c..e299325 100644 -- - a/reflection/generate_code.bat +++ b/reflection/generate_code.bat @ @ -15,4 +15,4 @ @ set buildtype=Release if `` % 1 '' == '' -b '' set buildtype= % 2 -..\ % buildtype % \flatc.exe -- cpp -- no-prefix -o ../include/flatbuffers reflection.fbs +..\ % buildtype % \flatc.exe -- cpp -- no-prefix -o ../include/flatbuffers reflection.fbs || exit /b 1 diff -- git a/reflection/generate_code.sh b/reflection/generate_code.sh index da8a181..f186b73 100755 -- - a/reflection/generate_code.sh +++ b/reflection/generate_code.sh @ @ -13,5 +13,6 @ @ # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . # See the License for the specific language governing permissions and # limitations under the License . +set -e ../flatc -c -- no-prefix -o ../include/flatbuffers reflection.fbs diff -- git a/tests/generate_code.bat b/tests/generate_code.bat index 30d18ed..fedb08e 100644 -- - a/tests/generate_code.bat +++ b/tests/generate_code.bat @ @ -15,13 +15,20 @ @ set buildtype=Release if `` % 1 '' == '' -b '' set buildtype= % 2 -..\ % buildtype % \flatc.exe -- cpp -- java -- csharp -- go -- binary -- python -- lobster -- lua -- js -- rust -- ts -- php -- grpc -- gen-mutable -- reflect-names -- gen-object-api -- gen-compare -- no-includes -- cpp-ptr-type flatbuffers :
diff -- git a/.editorconfig b/.editorconfig index c5a1b6c..be31d8c 100644 -- - a/.editorconfig +++ b/.editorconfig @ @ -1,5 +1,5 @ @ root = true - [ * . { cpp , cc , h } ] + [ * . { cpp , cc , h , sh } ] end_of_line = LF indent_style = space indent_size = 2 diff -- git a/reflection/generate_code.bat b/reflection/generate_code.bat index 8f58c0c..e299325 100644 -- - a/reflection/generate_code.bat +++ b/reflection/generate_code.bat @ @ -15,4 +15,4 @ @ set buildtype=Release if `` % 1 '' == '' -b '' set buildtype= % 2 -..\ % buildtype % \flatc.exe -- cpp -- no-prefix -o ../include/flatbuffers reflection.fbs +..\ % buildtype % \flatc.exe -- cpp -- no-prefix -o ../include/flatbuffers reflection.fbs || exit /b 1 diff -- git a/reflection/generate_code.sh b/reflection/generate_code.sh index da8a181..f186b73 100755 -- - a/reflection/generate_code.sh +++ b/reflection/generate_code.sh @ @ -13,5 +13,6 @ @ # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . # See the License for the specific language governing permissions and # limitations under the License . +set -e ../flatc -c -- no-prefix -o ../include/flatbuffers reflection.fbs diff -- git a/tests/generate_code.bat b/tests/generate_code.bat index 30d18ed..fedb08e 100644 -- - a/tests/generate_code.bat +++ b/tests/generate_code.bat @ @ -15,13 +15,20 @ @ set buildtype=Release if
diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index c166e4b..75d5704 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -154,6 +154,10 @ @ typedef uintmax_t largest_scalar_t ; // We support aligning the contents of buffers up to this size . # define FLATBUFFERS_MAX_ALIGNMENT 16 +static constexpr size_t kFileIdentifierLength = 4 ; + +typedef std : :allocator < uint8_t > DefaultAllocator ; + # ifndef FLATBUFFERS_CPP98_STL // Pointer to relinquished memory . typedef std : :unique_ptr < uint8_t , std : :function < void ( uint8_t * /* unused */ ) > > @ @ -542,22 +546,28 @ @ struct String : public Vector < char > { } } ; -// Simple indirection for buffer allocation , to allow this to be overridden -// with custom allocation ( see the FlatBufferBuilder constructor ) . -class simple_allocator { - public : - virtual ~simple_allocator ( ) { } - virtual uint8_t *allocate ( size_t size ) const { return new uint8_t [ size ] ; } - virtual void deallocate ( uint8_t *p ) const { delete [ ] p ; } - } ; - // This is a minimal replication of std : :vector < uint8_t > functionality , // except growing from
diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index c166e4b..3451a43 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -105,8 +105,10 @ @ # if ( ! defined ( _MSC_VER ) || _MSC_VER > 1600 ) & & \ ( ! defined ( __GNUC__ ) || ( __GNUC__ * 100 + __GNUC_MINOR__ > = 407 ) ) # define FLATBUFFERS_FINAL_CLASS final + # define FLATBUFFERS_OVERRIDE override # else # define FLATBUFFERS_FINAL_CLASS + # define FLATBUFFERS_OVERRIDE # endif # if ( ! defined ( _MSC_VER ) || _MSC_VER > = 1900 ) & & \ @ @ -123,6 +125,31 @ @ # define FLATBUFFERS_NOEXCEPT # endif +// NOTE : the FLATBUFFERS_DELETE_FUNC macro may change the access mode to +// private , so be sure to put it at the end or reset access mode explicitly . + # if ( ! defined ( _MSC_VER ) || _MSC_FULL_VER > = 180020827 ) & & \ + ( ! defined ( __GNUC__ ) || ( __GNUC__ * 100 + __GNUC_MINOR__ > = 404 ) ) + # define FLATBUFFERS_DELETE_FUNC ( func ) func = delete ; + # else + # define FLATBUFFERS_DELETE_FUNC ( func ) private : func ; + # endif + + # if
diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index 41b3b26..617b188 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -87,10 +87,6 @ @ typedef uint16_t voffset_t ; typedef uintmax_t largest_scalar_t ; -// Pointer to relinquished memory . -typedef std : :unique_ptr < uint8_t , std : :function < void ( uint8_t * /* unused */ ) > > - unique_ptr_t ; - // Wrapper for uoffset_t to allow safe template specialization . template < typename T > struct Offset { uoffset_t o ; @ @ -391,44 +387,96 @ @ struct String : public Vector < char > { class simple_allocator { public : virtual ~simple_allocator ( ) { } - virtual uint8_t *allocate ( size_t size ) const { return new uint8_t [ size ] ; } - virtual void deallocate ( uint8_t *p ) const { delete [ ] p ; } + virtual uint8_t *allocate ( size_t size ) const = 0 ; + virtual void deallocate ( uint8_t *p ) const = 0 ; + } ; + +inline uint8_t* custom_allocate ( const simple_allocator* allocator , size_t amt ) { + if ( allocator ) { + return allocator- > allocate ( amt ) ; + } + else { +
diff -- git a/.travis.yml b/.travis.yml index be3e22d..6cc6b03 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -40,7 +40,7 @ @ matrix : env : matrix : - BUILD_TYPE=Debug BIICODE=false - - BUILD_TYPE=Release BIICODE=false + - BUILD_TYPE=Release BIICODE=false CONAN=true # biicode .deb files no longer available . # - BUILD_TYPE=Release BIICODE=true # - BUILD_TYPE=Debug BIICODE=true @ @ -56,6 +56,7 @ @ matrix : script : - if [ `` $ BIICODE '' == `` false '' ] ; then cmake -DCMAKE_BUILD_TYPE= $ BUILD_TYPE . & & make & & make test ; fi - if [ `` $ BIICODE '' == `` true '' ] & & [ `` $ TRAVIS_OS_NAME '' == `` linux '' ] ; then ./biicode/support/bii-travis.sh $ BUILD_TYPE ; fi + - if [ `` $ CONAN '' == `` true '' ] & & [ `` $ TRAVIS_OS_NAME '' == `` linux '' ] ; then sudo pip install conan & & conan create . flatbuffers/testing -s build_type= $ BUILD_TYPE ; fi - language : android sudo : true diff -- git a/conanfile.py b/conanfile.py new file mode 100644 index 0000000..aac7606 -- - /dev/null +++ b/conanfile.py @ @ -0,0 +1,53 @ @ + # ! /usr/bin/env python +
diff -- git a/.gitignore b/.gitignore index c1011c3..cd0182d 100644 -- - a/.gitignore +++ b/.gitignore @ @ -45,6 +45,7 @ @ grpctest grpctest.exe snapshot.sh tags +tests/dart_gen tests/go_gen tests/monsterdata_java_wire.mon tests/monsterdata_java_wire_sp.mon @ @ -93,3 +94,4 @ @ js/flatbuffers.mjs .ninja_log build.ninja rules.ninja +.vscode/ diff -- git a/BUILD b/BUILD index 4b10991..7610efc 100644 -- - a/BUILD +++ b/BUILD @ @ -86,6 +86,7 @ @ cc_binary ( `` grpc/src/compiler/schema_interface.h '' , `` src/flatc_main.cpp '' , `` src/idl_gen_cpp.cpp '' , + `` src/idl_gen_dart.cpp '' , `` src/idl_gen_general.cpp '' , `` src/idl_gen_go.cpp '' , `` src/idl_gen_grpc.cpp '' , diff -- git a/CMakeLists.txt b/CMakeLists.txt index a3388dd..90860c3 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -45,6 +45,7 @ @ set ( FlatBuffers_Library_SRCS set ( FlatBuffers_Compiler_SRCS $ { FlatBuffers_Library_SRCS } src/idl_gen_cpp.cpp + src/idl_gen_dart.cpp src/idl_gen_general.cpp src/idl_gen_go.cpp src/idl_gen_js.cpp diff -- git a/dart/.gitignore b/dart/.gitignore new file mode 100644 index 0000000..9d46fd7 -- - /dev/null +++ b/dart/.gitignore @ @ -0,0 +1,5 @ @ +.pub/ +.packages +.dart_tool/ +build/ +doc/api/ diff -- git a/dart/LICENSE b/dart/LICENSE new file mode 100644 index 0000000..81764fd -- - /dev/null +++ b/dart/LICENSE @ @ -0,0 +1,24 @ @ +Copyright 2012 , the Dart project authors . All rights reserved . +Redistribution and use in source and binary forms , with or without +modification , are permitted
diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index 6453c30..edaa4da 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -600,6 +600,21 @ @ class vector_downward { } // Relinquish the pointer to the caller . + uint8_t *release_raw ( size_t & size , size_t & offset ) { + uint8_t *buf = buf_ ; + size = reserved_ ; + offset = static_cast < size_t > ( cur_ - buf_ ) ; + + if ( own_allocator_ & & allocator_ ) { delete allocator_ ; } + + allocator_ = nullptr ; + own_allocator_ = false ; + buf_ = nullptr ; + clear ( ) ; + return buf ; + } + + // Relinquish the pointer to the caller . DetachedBuffer release ( ) { DetachedBuffer fb ( allocator_ , own_allocator_ , buf_ , reserved_ , cur_ , size ( ) ) ; @ @ -827,6 +842,19 @ @ class FlatBufferBuilder { return buf_.release ( ) ; } + /// @ brief Get the released pointer to the serialized buffer . + /// @ param The size of the memory block containing + /// the serialized ` FlatBuffer ` . + /// @ param The offset from the released pointer where
diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index 6453c30..0024a8e 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -573,15 +573,12 @ @ class vector_downward { scratch_ ( nullptr ) { } ~vector_downward ( ) { - if ( buf_ ) Deallocate ( allocator_ , buf_ , reserved_ ) ; - if ( own_allocator_ & & allocator_ ) { delete allocator_ ; } + clear_buffer ( ) ; + clear_allocator ( ) ; } void reset ( ) { - if ( buf_ ) { - Deallocate ( allocator_ , buf_ , reserved_ ) ; - buf_ = nullptr ; - } + clear_buffer ( ) ; clear ( ) ; } @ @ -599,6 +596,31 @ @ class vector_downward { scratch_ = buf_ ; } + void clear_allocator ( ) + { + if ( own_allocator_ & & allocator_ ) { delete allocator_ ; } + allocator_ = nullptr ; + own_allocator_ = false ; + } + + void clear_buffer ( ) + { + if ( buf_ ) Deallocate ( allocator_ , buf_ , reserved_ ) ; + buf_ = nullptr ; + } + + // Relinquish the pointer to the caller . + uint8_t *release_raw ( size_t & size
diff -- git a/.gitignore b/.gitignore index 9dfabef..135dc5c 100755 -- - a/.gitignore +++ b/.gitignore @ @ -66,3 +66,6 @ @ build/VS2010/FlatBuffers.opensdf build/VS2010/ipch/**/*.ipch *.so Testing/Temporary +.cproject +.settings/ +.project diff -- git a/include/flatbuffers/code_generators.h b/include/flatbuffers/code_generators.h index 16e368e..3e85df2 100644 -- - a/include/flatbuffers/code_generators.h +++ b/include/flatbuffers/code_generators.h @ @ -114,6 +114,8 @ @ class BaseGenerator { std : :string WrapInNameSpace ( const Definition & def ) const ; + std : :string GetNameSpace ( const Definition & def ) const ; + const Parser & parser_ ; const std : :string & path_ ; const std : :string & file_name_ ; diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index deb1edf..5d67f33 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -358,6 +358,7 @ @ struct IDLOptions { bool allow_non_utf8 ; std : :string include_prefix ; bool binary_schema_comments ; + bool skip_flatbuffers_import ; std : :string go_namespace ; // Possible options for the more general generator below . @ @ -371,6 +372,7 @ @ struct IDLOptions { kPhp = 1 < < 6 , kJson = 1 < < 7 , kBinary = 1 < < 8 , + kTs = 1 < < 9 , kMAX } ; @ @ -400,6 +402,7 @ @ struct IDLOptions { union_value_namespacing ( true ) ,
diff -- git a/.gitignore b/.gitignore index bf6d665..e3ed2b7 100755 -- - a/.gitignore +++ b/.gitignore @ @ -78,3 +78,5 @ @ android/build/ samples/android/.externalNativeBuild/ samples/android/.gradle/ samples/android/build/ +tests/union_vector/union_vector_generated.js +tests/union_vector/union_vector_generated.ts diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index 9c7459c..2b4335b 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -647,6 +647,8 @ @ private : const char *suffix , BaseType baseType ) ; + bool SupportsVectorOfUnions ( ) const ; + public : SymbolTable < Type > types_ ; SymbolTable < StructDef > structs_ ; diff -- git a/src/idl_gen_js.cpp b/src/idl_gen_js.cpp index 9fac550..a117234 100644 -- - a/src/idl_gen_js.cpp +++ b/src/idl_gen_js.cpp @ @ -754,17 +754,37 @ @ void GenStruct ( const Parser & parser , StructDef & struct_def , auto index = `` this.bb.__vector ( this.bb_pos + offset ) + index '' + MaybeScale ( inline_size ) ; std : :string args = `` @ param { number } index\n '' ; - if ( vectortype.base_type == BASE_TYPE_STRUCT ) { + std : :string ret_type ; + bool is_union = false ; + switch ( vectortype.base_type ) { + case BASE_TYPE_STRUCT : args += `` @ param { `` + vectortypename + `` = } obj\n '' ; - } else if ( vectortype.base_type == BASE_TYPE_STRING ) { + ret_type = vectortypename
diff -- git a/java/com/google/flatbuffers/FlatBufferBuilder.java b/java/com/google/flatbuffers/FlatBufferBuilder.java index 5b1425a..fc7cf6d 100644 -- - a/java/com/google/flatbuffers/FlatBufferBuilder.java +++ b/java/com/google/flatbuffers/FlatBufferBuilder.java @ @ -263,6 +263,21 @ @ public class FlatBufferBuilder { } /** + * Encode the string { @ code s } in the buffer using UTF-8 . + * + * @ param s An already encoded UTF-8 string + * @ return The offset in the buffer where the encoded string starts + */ + public int createString ( ByteBuffer s ) { + int length = s.remaining ( ) ; + addByte ( ( byte ) 0 ) ; + startVector ( 1 , length , 1 ) ; + bb.position ( space -= length ) ; + bb.put ( s ) ; + return endVector ( ) ; + } + + /** * Should not be creating any other object , string or vector * while an object is being constructed */
diff -- git a/src/idl_gen_general.cpp b/src/idl_gen_general.cpp index f9190a2..3d1ed91 100644 -- - a/src/idl_gen_general.cpp +++ b/src/idl_gen_general.cpp @ @ -79,6 +79,7 @ @ struct LanguageParameters { const char *bool_type ; const char *open_curly ; const char *const_decl ; + const char *unsubclassable_decl ; const char *inheritance_marker ; const char *namespace_ident ; const char *namespace_begin ; @ @ -97,6 +98,7 @ @ LanguageParameters language_parameters [ ] = { `` boolean `` , `` { \n '' , `` final `` , + `` final `` , `` extends `` , `` package `` , `` ; '' , @ @ -118,6 +120,7 @ @ LanguageParameters language_parameters [ ] = { `` bool `` , `` \n { \n '' , `` readonly `` , + `` sealed `` , `` : `` , `` namespace `` , `` \n { `` , @ @ -140,6 +143,7 @ @ LanguageParameters language_parameters [ ] = { `` bool `` , `` \n { \n '' , `` const `` , + `` `` , `` '' , `` package `` , `` '' , @ @ -265,7 +269,9 @ @ static void GenEnum ( const LanguageParameters & lang , EnumDef & enum_def , // to map directly
diff -- git a/src/idl_gen_rust.cpp b/src/idl_gen_rust.cpp index c3d733d..bfe5ea3 100644 -- - a/src/idl_gen_rust.cpp +++ b/src/idl_gen_rust.cpp @ @ -351,7 +351,6 @ @ class RustGenerator : public BaseGenerator { case ftInteger : case ftFloat : case ftBool : - case ftTable : case ftEnumKey : case ftUnionKey : case ftStruct : { return false ; } diff -- git a/tests/namespace_test/namespace_test2_generated.rs b/tests/namespace_test/namespace_test2_generated.rs index abcd5c6..e420b89 100644 -- - a/tests/namespace_test/namespace_test2_generated.rs +++ b/tests/namespace_test/namespace_test2_generated.rs @ @ -42,7 +42,7 @ @ impl < 'a > TableInFirstNS < 'a > { # [ allow ( unused_mut ) ] pub fn create < 'bldr : 'args , 'args : 'mut_bldr , 'mut_bldr > ( _fbb : & 'mut_bldr mut flatbuffers : :FlatBufferBuilder < 'bldr > , - args : & 'args TableInFirstNSArgs ) - > flatbuffers : :WIPOffset < TableInFirstNS < 'bldr > > { + args : & 'args TableInFirstNSArgs < 'args > ) - > flatbuffers : :WIPOffset < TableInFirstNS < 'bldr > > { let mut builder = TableInFirstNSBuilder : :new ( _fbb ) ; if let Some ( x ) = args.foo_struct { builder.add_foo_struct ( x ) ; } if let Some ( x ) = args.foo_table { builder.add_foo_table ( x ) ; } @ @ -68,12 +68,12
diff -- git a/docs/source/CppUsage.md b/docs/source/CppUsage.md index 87a11c8..8787823 100755 -- - a/docs/source/CppUsage.md +++ b/docs/source/CppUsage.md @ @ -99,11 +99,19 @ @ construction , access and mutation . To use : ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ { .cpp } - auto monsterobj = GetMonster ( buffer ) - > UnPack ( ) ; - cout < < monsterobj- > name ; // This is now a std : :string ! - monsterobj- > name = `` Bob '' ; // Change the name . + MonsterT monsterobj ( GetMonster ( buffer ) ) ; + cout < < monsterobj.name ; // This is now a std : :string ! + monsterobj.name = `` Bob '' ; // Change the name . FlatBufferBuilder fbb ; - CreateMonster ( fbb , monsterobj.get ( ) ) ; // Serialize into new buffer . + monsterobj.Pack ( fbb ) ; // Serialize into new buffer . + + // You can even copy one struct to another + MonsterT another ; // Create another monster + another = monsterobj ; // Copy the original monster + another.name = `` Good monster '' ; // Change only the name + FlatBufferBuilder fbb1 ; + another.Pack ( fbb1 ) ; // Serialize into
diff -- git a/samples/monster_generated.h b/samples/monster_generated.h index 5ac4be3..53368a4 100644 -- - a/samples/monster_generated.h +++ b/samples/monster_generated.h @ @ -55,6 +55,7 @ @ inline const char * const *EnumNamesColor ( ) { } inline const char *EnumNameColor ( Color e ) { + if ( e < Color_Red || e > Color_Blue ) return `` '' ; const size_t index = static_cast < int > ( e ) ; return EnumNamesColor ( ) [ index ] ; } @ @ -84,6 +85,7 @ @ inline const char * const *EnumNamesEquipment ( ) { } inline const char *EnumNameEquipment ( Equipment e ) { + if ( e < Equipment_NONE || e > Equipment_Weapon ) return `` '' ; const size_t index = static_cast < int > ( e ) ; return EnumNamesEquipment ( ) [ index ] ; } diff -- git a/src/idl_gen_cpp.cpp b/src/idl_gen_cpp.cpp index a0abfdd..b73980e 100644 -- - a/src/idl_gen_cpp.cpp +++ b/src/idl_gen_cpp.cpp @ @ -990,6 +990,10 @ @ class CppGenerator : public BaseGenerator { code_ += `` inline const char *EnumName { { ENUM_NAME } } ( { { ENUM_NAME } } e ) { `` ; + code_ += `` if ( e < `` + GetEnumValUse ( enum_def , *enum_def.vals.vec.front ( )
diff -- git a/java/com/google/flatbuffers/FlatBufferBuilder.java b/java/com/google/flatbuffers/FlatBufferBuilder.java old mode 100644 new mode 100755 index 695a29a..73e062e -- - a/java/com/google/flatbuffers/FlatBufferBuilder.java +++ b/java/com/google/flatbuffers/FlatBufferBuilder.java @ @ -22,9 +22,11 @ @ import java.nio.ByteBuffer ; import java.nio.ByteOrder ; import java.nio.charset.Charset ; -// Class that helps you build a FlatBuffer . -// See the section `` Use in Java '' in the main FlatBuffers documentation . - +/** + * Class that helps you build a FlatBuffer . See the section + * < a href= '' http : //google.github.io/flatbuffers/md__java_usage.html '' > '' Use in Java '' < /a > in the + * main FlatBuffers documentation . + */ public class FlatBufferBuilder { ByteBuffer bb ; // Where we construct the FlatBuffer . int space ; // Remaining space in the ByteBuffer . @ @ -36,14 +38,24 @ @ public class FlatBufferBuilder { int num_vtables = 0 ; // Number of entries in ` vtables ` in use . int vector_num_elems = 0 ; // For the current vector being built . - // Start with a buffer of size ` initial_size ` , then grow as required . + /** + * Start with a buffer of size { @ code initial_size } , then grow as
diff -- git a/java/com/google/flatbuffers/FlatBufferBuilder.java b/java/com/google/flatbuffers/FlatBufferBuilder.java index 695a29a..73e062e 100644 -- - a/java/com/google/flatbuffers/FlatBufferBuilder.java +++ b/java/com/google/flatbuffers/FlatBufferBuilder.java @ @ -22,9 +22,11 @ @ import java.nio.ByteBuffer ; import java.nio.ByteOrder ; import java.nio.charset.Charset ; -// Class that helps you build a FlatBuffer . -// See the section `` Use in Java '' in the main FlatBuffers documentation . - +/** + * Class that helps you build a FlatBuffer . See the section + * < a href= '' http : //google.github.io/flatbuffers/md__java_usage.html '' > '' Use in Java '' < /a > in the + * main FlatBuffers documentation . + */ public class FlatBufferBuilder { ByteBuffer bb ; // Where we construct the FlatBuffer . int space ; // Remaining space in the ByteBuffer . @ @ -36,14 +38,24 @ @ public class FlatBufferBuilder { int num_vtables = 0 ; // Number of entries in ` vtables ` in use . int vector_num_elems = 0 ; // For the current vector being built . - // Start with a buffer of size ` initial_size ` , then grow as required . + /** + * Start with a buffer of size { @ code initial_size } , then grow as required . + * +
diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index 2781852..03ddb52 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -559,6 +559,10 @ @ private : const StructDef *parent_struct_def ) ; FLATBUFFERS_CHECKED_ERROR ParseTable ( const StructDef & struct_def , std : :string *value , uoffset_t *ovalue ) ; + FLATBUFFERS_CHECKED_ERROR ProcessTableFields ( size_t fieldn , + const StructDef & struct_def , + std : :string *value , + uoffset_t *ovalue ) ; void SerializeStruct ( const StructDef & struct_def , const Value & val ) ; void AddVector ( bool sortbysize , int count ) ; FLATBUFFERS_CHECKED_ERROR ParseVector ( const Type & type , uoffset_t *ovalue ) ; diff -- git a/src/idl_parser.cpp b/src/idl_parser.cpp index f03ad9a..209074e 100644 -- - a/src/idl_parser.cpp +++ b/src/idl_parser.cpp @ @ -853,17 +853,35 @ @ void Parser : :SerializeStruct ( const StructDef & struct_def , const Value & val ) { CheckedError Parser : :ParseTable ( const StructDef & struct_def , std : :string *value , uoffset_t *ovalue ) { - EXPECT ( ' { ' ) ; + // We allow tables both as JSON object { .. } with field names + // or vector [ .. ] with all fields in order + const bool is_nested_list = Is ( '
diff -- git a/go/safe.go b/go/safe.go new file mode 100644 index 0000000..760acf7 -- - /dev/null +++ b/go/safe.go @ @ -0,0 +1,8 @ @ +// +build ! unsafe + +package flatbuffers + +// byteSliceToString converts a [ ] byte to string . +func byteSliceToString ( b [ ] byte ) string { + return string ( b ) + } diff -- git a/go/sizes.go b/go/sizes.go new file mode 100644 index 0000000..3183162 -- - /dev/null +++ b/go/sizes.go @ @ -0,0 +1,46 @ @ +package flatbuffers + +const ( + // See http : //golang.org/ref/spec # Numeric_types + + // SizeUint8 is the byte size of a uint8 . + SizeUint8 = 1 + // SizeUint16 is the byte size of a uint16 . + SizeUint16 = 2 + // SizeUint32 is the byte size of a uint32 . + SizeUint32 = 4 + // SizeUint64 is the byte size of a uint64 . + SizeUint64 = 8 + + // SizeInt8 is the byte size of a int8 . + SizeInt8 = 1 + // SizeInt16 is the byte size of a int16 . + SizeInt16 = 2 + // SizeInt32 is the byte size of a int32 . + SizeInt32 = 4
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 6dc73e7..8b58083 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -34,6 +34,7 @ @ set ( FlatBuffers_Compiler_SRCS src/idl_gen_general.cpp src/idl_gen_go.cpp src/idl_gen_js.cpp + src/idl_gen_kotlin.cpp src/idl_gen_php.cpp src/idl_gen_python.cpp src/idl_gen_fbs.cpp diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index 1ed360b..4f8589d 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -524,6 +524,12 @ @ extern bool GenerateJava ( const Parser & parser , const std : :string & path , const std : :string & file_name ) ; +// Generate Kotlin files from the definitions in the Parser object . +// See idl_gen_kotlin.cpp . +extern bool GenerateKotlin ( const Parser & parser , + const std : :string & path , + const std : :string & file_name ) ; + // Generate Php code from the definitions in the Parser object . // See idl_gen_php . extern bool GeneratePhp ( const Parser & parser , diff -- git a/kotlin/FlatBufferBuilder.kt b/kotlin/FlatBufferBuilder.kt new file mode 100644 index 0000000..9f1f299 -- - /dev/null +++ b/kotlin/FlatBufferBuilder.kt @ @ -0,0 +1,624 @ @ +/* + * Copyright 2014 Google Inc. All rights reserved . + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 6dc73e7..8b58083 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -34,6 +34,7 @ @ set ( FlatBuffers_Compiler_SRCS src/idl_gen_general.cpp src/idl_gen_go.cpp src/idl_gen_js.cpp + src/idl_gen_kotlin.cpp src/idl_gen_php.cpp src/idl_gen_python.cpp src/idl_gen_fbs.cpp diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index 1ed360b..4f8589d 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -524,6 +524,12 @ @ extern bool GenerateJava ( const Parser & parser , const std : :string & path , const std : :string & file_name ) ; +// Generate Kotlin files from the definitions in the Parser object . +// See idl_gen_kotlin.cpp . +extern bool GenerateKotlin ( const Parser & parser , + const std : :string & path , + const std : :string & file_name ) ; + // Generate Php code from the definitions in the Parser object . // See idl_gen_php . extern bool GeneratePhp ( const Parser & parser , diff -- git a/kotlin/FlatBufferBuilder.kt b/kotlin/FlatBufferBuilder.kt new file mode 100644 index 0000000..9f1f299 -- - /dev/null +++ b/kotlin/FlatBufferBuilder.kt @ @ -0,0 +1,624 @ @ +/* + * Copyright 2014 Google Inc. All rights reserved . + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this
diff -- git a/src/idl_parser.cpp b/src/idl_parser.cpp index 78072b9..edd279c 100644 -- - a/src/idl_parser.cpp +++ b/src/idl_parser.cpp @ @ -897,6 +897,27 @ @ CheckedError Parser : :ParseTable ( const StructDef & struct_def , std : :string *value , EXPECT ( ' , ' ) ; } + // Check if all required fields are parsed . + std : :vector < FieldDef* > requiredFields ; + auto rfIt = requiredFields.begin ( ) ; + for ( FieldDef* field : struct_def.fields.vec ) { + if ( field- > required ) { + rfIt = requiredFields.insert ( rfIt , field ) ; + } + } + for ( FieldDef* requiredField : requiredFields ) { + bool found = false ; + for ( std : :pair < Value , FieldDef * > parsedFields : field_stack_ ) { + if ( parsedFields.second- > name == requiredField- > name ) { + found = true ; + break ; + } + } + if ( ! found ) { + return Error ( `` required field is missing : `` + requiredField- > name ) ; + } + } + if ( struct_def.fixed & & fieldn ! = struct_def.fields.vec.size ( ) ) return Error (
diff -- git a/src/idl_parser.cpp b/src/idl_parser.cpp index f0908ff..0eec353 100644 -- - a/src/idl_parser.cpp +++ b/src/idl_parser.cpp @ @ -1594,7 +1594,8 @ @ CheckedError Parser : :ParseEnum ( bool is_union , EnumDef **dest ) { } // Specify the integer type underlying this enum . ECHECK ( ParseType ( enum_def- > underlying_type ) ) ; - if ( ! IsInteger ( enum_def- > underlying_type.base_type ) ) + if ( ! IsInteger ( enum_def- > underlying_type.base_type ) || + IsBool ( enum_def- > underlying_type.base_type ) ) return Error ( `` underlying enum type must be integral '' ) ; // Make this type refer back to the enum it was derived from . enum_def- > underlying_type.enum_def = enum_def ; @ @ -1620,10 +1621,8 @ @ CheckedError Parser : :ParseEnum ( bool is_union , EnumDef **dest ) { } } auto prevsize = enum_def- > vals.vec.size ( ) ; - auto value = ! enum_def- > vals.vec.empty ( ) - ? enum_def- > vals.vec.back ( ) - > value + 1 - : 0 ; - auto & ev = *new EnumVal ( value_name , value ) ; + auto prevvalue = prevsize > 0 ? enum_def- > vals.vec.back ( ) - > value : 0
diff -- git a/src/idl_gen_python.cpp b/src/idl_gen_python.cpp index 17db565..ba7dd56 100644 -- - a/src/idl_gen_python.cpp +++ b/src/idl_gen_python.cpp @ @ -141,9 +141,14 @ @ static void GetScalarFieldOfTable ( const StructDef & struct_def , code += MakeCamel ( field.name ) ; code += `` ( self ) : '' ; code += OffsetPrefix ( field ) ; - code += Indent + Indent + Indent + `` return `` + getter ; - code += `` o + self._tab.Pos ) \n '' ; - code += Indent + Indent + `` return `` + field.value.constant + `` \n\n '' ; + getter += `` o + self._tab.Pos ) '' ; + auto is_bool = field.value.type.base_type == BASE_TYPE_BOOL ; + if ( is_bool ) { + getter = `` bool ( `` + getter + `` ) '' ; + } + code += Indent + Indent + Indent + `` return `` + getter + `` \n '' ; + auto defaultValue = ( is_bool ? `` False '' : field.value.constant ) ; + code += Indent + Indent + `` return `` + defaultValue + `` \n\n '' ; } // Get a struct by initializing an existing struct . diff -- git a/tests/MyGame/Example/Monster.py b/tests/MyGame/Example/Monster.py
diff -- git a/.gitignore b/.gitignore index c1011c3..f5ff92c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -93,3 +93,4 @ @ js/flatbuffers.mjs .ninja_log build.ninja rules.ninja +.vscode diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index 4c4bcc3..ca24ef4 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -306,7 +306,7 @ @ inline size_t InlineAlignment ( const Type & type ) { struct EnumVal { EnumVal ( const std : :string & _name , int64_t _val ) : name ( _name ) , value ( _val ) { } - Offset < reflection : :EnumVal > Serialize ( FlatBufferBuilder *builder ) const ; + Offset < reflection : :EnumVal > Serialize ( FlatBufferBuilder *builder , const Parser & parser ) const ; std : :string name ; std : :vector < std : :string > doc_comment ; @ @ -326,8 +326,7 @ @ struct EnumDef : public Definition { return nullptr ; } - Offset < reflection : :Enum > Serialize ( FlatBufferBuilder *builder , - const Parser & parser ) const ; + Offset < reflection : :Enum > Serialize ( FlatBufferBuilder *builder , const Parser & parser ) const ; SymbolTable < EnumVal > vals ; bool is_union ; @ @ -342,14 +341,15 @ @ inline bool
diff -- git a/src/idl_gen_go.cpp b/src/idl_gen_go.cpp index 88ce1f2..4f1d1f1 100644 -- - a/src/idl_gen_go.cpp +++ b/src/idl_gen_go.cpp @ @ -42,7 +42,16 @ @ static void GenReceiver ( const StructDef & struct_def , std : :string *code_ptr ) ; static std : :string GenTypeBasic ( const Type & type ) ; static std : :string GenTypeGet ( const Type & type ) ; static std : :string TypeName ( const FieldDef & field ) ; +static bool IsEnum ( const FieldDef & field ) ; +static std : :string EnumName ( const FieldDef & field ) ; +static bool IsEnum ( const FieldDef & field ) { + return field.value.type.enum_def ; + } + +static std : :string EnumName ( const FieldDef & field ) { + return field.value.type.enum_def- > name ; + } // Most field accessors need to retrieve and test the field offset first , // this is the prefix code for that . @ @ -79,9 +88,10 @ @ static void BeginClass ( const StructDef & struct_def , std : :string *code_ptr ) { } // Begin enum code with a class declaration . -static void BeginEnum ( std : :string *code_ptr ) { +static void BeginEnum ( const EnumDef &
diff -- git a/src/cycleclock.h b/src/cycleclock.h index ca26cca..2372f95 100644 -- - a/src/cycleclock.h +++ b/src/cycleclock.h @ @ -45,6 +45,10 @ @ extern `` C '' uint64_t __rdtsc ( ) ; # include < sys/time.h > # endif + # if defined ( __pnacl__ ) + # include < time.h > + # endif + namespace benchmark { // NOTE : only i386 and x86_64 have been well tested . // PPC , sparc , alpha , and ia64 are based on @ @ -108,7 +112,9 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { asm volatile ( `` mrs % 0 , cntvct_el0 '' : `` =r '' ( virtual_timer_value ) ) ; return virtual_timer_value ; # elif defined ( __ARM_ARCH ) - # if ( __ARM_ARCH > = 6 ) // V6 is the earliest arch that has a standard cyclecount + // V6 is the earliest arch that has a standard cyclecount + // Native Client validator does n't allow MRC instructions . + # if ( __ARM_ARCH > = 6 ) & & ! defined ( BENCHMARK_OS_NACL ) uint32_t pmccntr ; uint32_t pmuseren ; uint32_t pmcntenset ; @ @ -132,6 +138,14 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( )
diff -- git a/src/cycleclock.h b/src/cycleclock.h index ca26cca..e0f9b01 100644 -- - a/src/cycleclock.h +++ b/src/cycleclock.h @ @ -43,6 +43,11 @ @ extern `` C '' uint64_t __rdtsc ( ) ; # ifndef BENCHMARK_OS_WINDOWS # include < sys/time.h > + # include < time.h > + # endif + + # ifdef BENCHMARK_OS_EMSCRIPTEN + # include < emscripten.h > # endif namespace benchmark { @ @ -65,6 +70,10 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { // counter pauses ; it does not continue counting , nor does it // reset to zero . return mach_absolute_time ( ) ; + # elif defined ( BENCHMARK_OS_EMSCRIPTEN ) + // this goes above x86-specific code because old versions of Emscripten + // define __x86_64__ , although they have nothing to do with it . + return static_cast < int64_t > ( emscripten_get_now ( ) * 1e+6 ) ; # elif defined ( __i386__ ) int64_t ret ; __asm__ volatile ( `` rdtsc '' : `` =A '' ( ret ) ) ; @ @ -99,6 +108,22 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { _asm rdtsc # elif defined ( COMPILER_MSVC ) return __rdtsc ( ) ; + # elif defined ( BENCHMARK_OS_NACL
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..98dca3d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..90fd5c4 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..90fd5c4 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 8c15b87..391434c 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -25,6 +25,7 @ @ Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > Lei Xu < eddyxu @ gmail.com > Matt Clarkson < mattyclarkson @ gmail.com > +Maxim Vafin < maxvafin @ gmail.com > Nick Hutchinson < nshutchinson @ gmail.com > Oleksandr Sochka < sasha.sochka @ gmail.com > Paul Redmond < paul.redmond @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 96cd15a..0f7f6ed 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -41,6 +41,7 @ @ Kaito Udagawa < umireon @ gmail.com > Kai Wolf < kai.wolf @ gmail.com > Lei Xu < eddyxu @ gmail.com > Matt Clarkson < mattyclarkson @ gmail.com > +Maxim Vafin < maxvafin @ gmail.com > Nick Hutchinson < nshutchinson @ gmail.com > Oleksandr Sochka < sasha.sochka @ gmail.com > Pascal Leroy < phl @ google.com > diff -- git a/src/sysinfo.cc b/src/sysinfo.cc index 34f9871..7feb79e 100644 -- - a/src/sysinfo.cc +++ b/src/sysinfo.cc @ @ -75,7 +75,9 @ @ bool ReadIntFromFile ( const char* file , long* value ) { char line [ 1024 ] ; char* err ; memset ( line , '\0 ' , sizeof ( line )
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..c4f0741 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,6 +23,18 @ @ matrix : - compiler : gcc addons : apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + addons : + apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc +
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 2ded481..5cc302f 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -223,6 +230,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..05ad376 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..98dca3d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/CMakeLists.txt b/CMakeLists.txt index f7f1566..4265a6c 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -135,24 +135,21 @ @ else ( ) endif ( ) # Coverage build type - set ( CMAKE_CXX_FLAGS_COVERAGE `` $ { CMAKE_CXX_FLAGS_DEBUG } '' CACHE STRING - `` Flags used by the C++ compiler during coverage builds . '' + set ( BENCHMARK_CXX_FLAGS_COVERAGE `` $ { CMAKE_CXX_FLAGS_DEBUG } '' + CACHE STRING `` Flags used by the C++ compiler during coverage builds . '' FORCE ) - set ( CMAKE_EXE_LINKER_FLAGS_COVERAGE - `` $ { CMAKE_EXE_LINKER_FLAGS_DEBUG } '' CACHE STRING - `` Flags used for linking binaries during coverage builds . '' + set ( BENCHMARK_EXE_LINKER_FLAGS_COVERAGE `` $ { CMAKE_EXE_LINKER_FLAGS_DEBUG } '' + CACHE STRING `` Flags used for linking binaries during coverage builds . '' FORCE ) - set ( CMAKE_SHARED_LINKER_FLAGS_COVERAGE - `` $ { CMAKE_SHARED_LINKER_FLAGS_DEBUG } '' CACHE STRING - `` Flags used by the shared libraries linker during coverage builds . '' + set ( BENCHMARK_SHARED_LINKER_FLAGS_COVERAGE `` $ { CMAKE_SHARED_LINKER_FLAGS_DEBUG } '' + CACHE STRING `` Flags used by the shared libraries linker during coverage builds . '' FORCE ) mark_as_advanced ( - CMAKE_CXX_FLAGS_COVERAGE - CMAKE_EXE_LINKER_FLAGS_COVERAGE - CMAKE_SHARED_LINKER_FLAGS_COVERAGE ) + BENCHMARK_CXX_FLAGS_COVERAGE + BENCHMARK_EXE_LINKER_FLAGS_COVERAGE
diff -- git a/src/cycleclock.h b/src/cycleclock.h index ca26cca..726311e 100644 -- - a/src/cycleclock.h +++ b/src/cycleclock.h @ @ -45,6 +45,14 @ @ extern `` C '' uint64_t __rdtsc ( ) ; # include < sys/time.h > # endif + # ifdef BENCHMARK_OS_EMSCRIPTEN + # include < emscripten.h > + # endif + + # if defined ( __pnacl__ ) + # include < time.h > + # endif + namespace benchmark { // NOTE : only i386 and x86_64 have been well tested . // PPC , sparc , alpha , and ia64 are based on @ @ -65,6 +73,10 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { // counter pauses ; it does not continue counting , nor does it // reset to zero . return mach_absolute_time ( ) ; + # elif defined ( BENCHMARK_OS_EMSCRIPTEN ) + // this goes above x86-specific code because old versions of Emscripten + // define __x86_64__ , although they have nothing to do with it . + return static_cast < int64_t > ( emscripten_get_now ( ) * 1e+6 ) ; # elif defined ( __i386__ ) int64_t ret ; __asm__ volatile ( `` rdtsc '' : `` =A '' ( ret ) ) ;
diff -- git a/src/sleep.cc b/src/sleep.cc index 1449339..54aa04a 100644 -- - a/src/sleep.cc +++ b/src/sleep.cc @ @ -41,7 +41,7 @ @ void SleepForMicroseconds ( int microseconds ) { } void SleepForMilliseconds ( int milliseconds ) { - SleepForMicroseconds ( static_cast < int > ( milliseconds ) * kNumMicrosPerMilli ) ; + SleepForMicroseconds ( milliseconds * kNumMicrosPerMilli ) ; } void SleepForSeconds ( double seconds ) { diff -- git a/src/sleep.h b/src/sleep.h index f1e515c..f98551a 100644 -- - a/src/sleep.h +++ b/src/sleep.h @ @ -1,14 +1,12 @ @ # ifndef BENCHMARK_SLEEP_H_ # define BENCHMARK_SLEEP_H_ - # include < cstdint > - namespace benchmark { -const int64_t kNumMillisPerSecond = 1000LL ; -const int64_t kNumMicrosPerMilli = 1000LL ; -const int64_t kNumMicrosPerSecond = kNumMillisPerSecond * 1000LL ; -const int64_t kNumNanosPerMicro = 1000LL ; -const int64_t kNumNanosPerSecond = kNumNanosPerMicro * kNumMicrosPerSecond ; +const int kNumMillisPerSecond = 1000 ; +const int kNumMicrosPerMilli = 1000 ; +const int kNumMicrosPerSecond = kNumMillisPerSecond * 1000 ; +const int kNumNanosPerMicro = 1000 ; +const int kNumNanosPerSecond = kNumNanosPerMicro * kNumMicrosPerSecond ; void SleepForMilliseconds ( int milliseconds ) ; void SleepForSeconds ( double seconds ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 8c15b87..391434c 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -25,6 +25,7 @ @ Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > Lei Xu < eddyxu @ gmail.com > Matt Clarkson < mattyclarkson @ gmail.com > +Maxim Vafin < maxvafin @ gmail.com > Nick Hutchinson < nshutchinson @ gmail.com > Oleksandr Sochka < sasha.sochka @ gmail.com > Paul Redmond < paul.redmond @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 96cd15a..0f7f6ed 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -41,6 +41,7 @ @ Kaito Udagawa < umireon @ gmail.com > Kai Wolf < kai.wolf @ gmail.com > Lei Xu < eddyxu @ gmail.com > Matt Clarkson < mattyclarkson @ gmail.com > +Maxim Vafin < maxvafin @ gmail.com > Nick Hutchinson < nshutchinson @ gmail.com > Oleksandr Sochka < sasha.sochka @ gmail.com > Pascal Leroy < phl @ google.com > diff -- git a/src/sysinfo.cc b/src/sysinfo.cc index 34f9871..7feb79e 100644 -- - a/src/sysinfo.cc +++ b/src/sysinfo.cc @ @ -75,7 +75,9 @ @ bool ReadIntFromFile ( const char* file , long* value ) { char line [ 1024 ] ; char* err ; memset ( line , '\0 ' , sizeof ( line )
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 1e853e2..9b123f1 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -231,7 +231,13 @ @ BENCHMARK_UNUSED static int stream_init_anchor = InitializeStreams ( ) ; # ifndef BENCHMARK_HAS_NO_INLINE_ASSEMBLY template < class Tp > inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { + // Clang does n't like the 'X ' constraint on ` value ` and certain GCC versions + // do n't like the 'g ' constraint . Attempt to placate them both . + # if defined ( __clang__ ) asm volatile ( `` '' : : `` g '' ( value ) : `` memory '' ) ; + # else + asm volatile ( `` '' : : `` X '' ( value ) : `` memory '' ) ; + # endif } // Force the compiler to flush pending writes to global memory . Acts as an // effective read/write barrier diff -- git a/test/CMakeLists.txt b/test/CMakeLists.txt index d89135a..93c0025 100644 -- - a/test/CMakeLists.txt +++ b/test/CMakeLists.txt @ @ -1,6 +1,7 @ @ # Enable the tests find_package ( Threads REQUIRED ) +include ( CheckCXXCompilerFlag ) # NOTE : Some tests use ` < cassert > ` to perform the test
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..5ab7ece 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -21,6 +21,10 @ @ matrix : - compiler : gcc env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc addons : apt : sources : @ @ -44,6 +48,17 @ @ matrix :
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..daeedc2 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,6 +23,18 @ @ matrix : - compiler : gcc addons : apt : + packages : + - gcc-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + addons : + apt : + packages : + - gcc-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc +
diff -- git a/src/complexity.cc b/src/complexity.cc index 02adbef..a4c57c4 100644 -- - a/src/complexity.cc +++ b/src/complexity.cc @ @ -35,9 +35,9 @ @ BigOFunc* FittingCurve ( BigO complexity ) { case oNCubed : return [ ] ( int n ) - > double { return std : :pow ( n , 3 ) ; } ; case oLogN : - return [ ] ( int n ) { return std : :log2 ( n ) ; } ; + return [ ] ( int n ) { return log2 ( n ) ; } ; case oNLogN : - return [ ] ( int n ) { return n * std : :log2 ( n ) ; } ; + return [ ] ( int n ) { return n * log2 ( n ) ; } ; case o1 : default : return [ ] ( int ) { return 1.0 ; } ; diff -- git a/test/complexity_test.cc b/test/complexity_test.cc index 14e03b0..62d1154 100644 -- - a/test/complexity_test.cc +++ b/test/complexity_test.cc @ @ -141,7 +141,7 @ @ BENCHMARK ( BM_Complexity_O_N_log_N ) BENCHMARK ( BM_Complexity_O_N_log_N ) - > RangeMultiplier ( 2 ) - > Range ( 1 < < 10 , 1 < < 16 ) - -
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..82bd94f 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..90fd5c4 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..915702e 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index c4b059d..49f500f 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -32,6 +32,7 @ @ Oleksandr Sochka < sasha.sochka @ gmail.com > Paul Redmond < paul.redmond @ gmail.com > Radoslav Yovchev < radoslav.tm @ gmail.com > Shuo Chen < chenshuo @ chenshuo.com > +Yixuan Qiu < yixuanq @ gmail.com > Yusuke Suzuki < utatane.tea @ gmail.com > Dirac Research Zbigniew Skowron < zbychs @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 8ca4565..c0c0292 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -50,6 +50,7 @ @ Pierre Phaneuf < pphaneuf @ google.com > Radoslav Yovchev < radoslav.tm @ gmail.com > Ray Glover < ray.glover @ uk.ibm.com > Shuo Chen < chenshuo @ chenshuo.com > +Yixuan Qiu < yixuanq @ gmail.com > Yusuke Suzuki < utatane.tea @ gmail.com > Tobias Ulvgrd < tobias.ulvgard @ dirac.se > Zbigniew Skowron < zbychs @ gmail.com > diff -- git a/src/complexity.cc b/src/complexity.cc index a4c57c4..24b3ed4 100644 -- - a/src/complexity.cc +++ b/src/complexity.cc @ @ -194,16 +194,16 @ @ std : :vector < BenchmarkReporter : :Run > ComputeStats ( CHECK_EQ ( run_iterations , run.iterations ) ; if ( run.error_occurred ) continue ; real_accumulated_time_stat += - Stat1_d ( run.real_accumulated_time / run.iterations , run.iterations ) ; +
diff -- git a/AUTHORS b/AUTHORS index c4b059d..49f500f 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -32,6 +32,7 @ @ Oleksandr Sochka < sasha.sochka @ gmail.com > Paul Redmond < paul.redmond @ gmail.com > Radoslav Yovchev < radoslav.tm @ gmail.com > Shuo Chen < chenshuo @ chenshuo.com > +Yixuan Qiu < yixuanq @ gmail.com > Yusuke Suzuki < utatane.tea @ gmail.com > Dirac Research Zbigniew Skowron < zbychs @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 8ca4565..c0c0292 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -50,6 +50,7 @ @ Pierre Phaneuf < pphaneuf @ google.com > Radoslav Yovchev < radoslav.tm @ gmail.com > Ray Glover < ray.glover @ uk.ibm.com > Shuo Chen < chenshuo @ chenshuo.com > +Yixuan Qiu < yixuanq @ gmail.com > Yusuke Suzuki < utatane.tea @ gmail.com > Tobias Ulvgrd < tobias.ulvgard @ dirac.se > Zbigniew Skowron < zbychs @ gmail.com > diff -- git a/src/complexity.cc b/src/complexity.cc index a4c57c4..24b3ed4 100644 -- - a/src/complexity.cc +++ b/src/complexity.cc @ @ -194,16 +194,16 @ @ std : :vector < BenchmarkReporter : :Run > ComputeStats ( CHECK_EQ ( run_iterations , run.iterations ) ; if ( run.error_occurred ) continue ; real_accumulated_time_stat += - Stat1_d ( run.real_accumulated_time / run.iterations , run.iterations ) ; +
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2526faf..4296b23 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -44,6 +44,10 @ @ add_cxx_compiler_flag ( -pedantic-errors ) add_cxx_compiler_flag ( -fno-strict-aliasing RELEASE ) add_cxx_compiler_flag ( -Wthread-safety ) +if ( HAVE_WTHREAD_SAFETY ) + add_definitions ( -DHAVE_WTHREAD_SAFETY ) + cxx_feature_check ( THREAD_SAFETY_ATTRIBUTES ) +endif ( ) # C++ feature checks cxx_feature_check ( STD_REGEX ) diff -- git a/cmake/thread_safety_attributes.cpp b/cmake/thread_safety_attributes.cpp new file mode 100644 index 0000000..46161ba -- - /dev/null +++ b/cmake/thread_safety_attributes.cpp @ @ -0,0 +1,4 @ @ + # define HAVE_THREAD_SAFETY_ATTRIBUTES + # include `` ../src/mutex.h '' + +int main ( ) { } diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 2532454..0597f20 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -135,7 +135,8 @ @ BENCHMARK ( BM_MultiThreaded ) - > Threads ( 4 ) ; # ifndef BENCHMARK_BENCHMARK_H_ # define BENCHMARK_BENCHMARK_H_ - # include < stdint.h > + # include < cassert > + # include < cstdint > # include < functional > # include < memory > @ @ -153,14 +154,18 @ @ void Initialize ( int* argc , const char** argv ) ; // Otherwise , run all benchmarks specified by the -- benchmark_filter flag , // and exit after running the benchmarks . -void RunSpecifiedBenchmarks
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2526faf..4296b23 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -44,6 +44,10 @ @ add_cxx_compiler_flag ( -pedantic-errors ) add_cxx_compiler_flag ( -fno-strict-aliasing RELEASE ) add_cxx_compiler_flag ( -Wthread-safety ) +if ( HAVE_WTHREAD_SAFETY ) + add_definitions ( -DHAVE_WTHREAD_SAFETY ) + cxx_feature_check ( THREAD_SAFETY_ATTRIBUTES ) +endif ( ) # C++ feature checks cxx_feature_check ( STD_REGEX ) diff -- git a/cmake/thread_safety_attributes.cpp b/cmake/thread_safety_attributes.cpp new file mode 100644 index 0000000..46161ba -- - /dev/null +++ b/cmake/thread_safety_attributes.cpp @ @ -0,0 +1,4 @ @ + # define HAVE_THREAD_SAFETY_ATTRIBUTES + # include `` ../src/mutex.h '' + +int main ( ) { } diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 2532454..f891943 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -135,7 +135,8 @ @ BENCHMARK ( BM_MultiThreaded ) - > Threads ( 4 ) ; # ifndef BENCHMARK_BENCHMARK_H_ # define BENCHMARK_BENCHMARK_H_ - # include < stdint.h > + # include < cassert > + # include < cstdint > # include < functional > # include < memory > @ @ -153,14 +154,18 @ @ void Initialize ( int* argc , const char** argv ) ; // Otherwise , run all benchmarks specified by the -- benchmark_filter flag , // and exit after running the benchmarks . -void RunSpecifiedBenchmarks
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2526faf..4296b23 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -44,6 +44,10 @ @ add_cxx_compiler_flag ( -pedantic-errors ) add_cxx_compiler_flag ( -fno-strict-aliasing RELEASE ) add_cxx_compiler_flag ( -Wthread-safety ) +if ( HAVE_WTHREAD_SAFETY ) + add_definitions ( -DHAVE_WTHREAD_SAFETY ) + cxx_feature_check ( THREAD_SAFETY_ATTRIBUTES ) +endif ( ) # C++ feature checks cxx_feature_check ( STD_REGEX ) diff -- git a/cmake/thread_safety_attributes.cpp b/cmake/thread_safety_attributes.cpp new file mode 100644 index 0000000..46161ba -- - /dev/null +++ b/cmake/thread_safety_attributes.cpp @ @ -0,0 +1,4 @ @ + # define HAVE_THREAD_SAFETY_ATTRIBUTES + # include `` ../src/mutex.h '' + +int main ( ) { } diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 2532454..292ffc2 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -1,386 +1,48 @ @ -// Support for registering benchmarks for functions . - -/* Example usage : -// Define a function that executes the code to be measured a -// specified number of times : -static void BM_StringCreation ( benchmark : :State & state ) { - while ( state.KeepRunning ( ) ) - std : :string empty_string ; - } +// Copyright 2015 Google Inc. All rights reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2526faf..4296b23 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -44,6 +44,10 @ @ add_cxx_compiler_flag ( -pedantic-errors ) add_cxx_compiler_flag ( -fno-strict-aliasing RELEASE ) add_cxx_compiler_flag ( -Wthread-safety ) +if ( HAVE_WTHREAD_SAFETY ) + add_definitions ( -DHAVE_WTHREAD_SAFETY ) + cxx_feature_check ( THREAD_SAFETY_ATTRIBUTES ) +endif ( ) # C++ feature checks cxx_feature_check ( STD_REGEX ) diff -- git a/cmake/thread_safety_attributes.cpp b/cmake/thread_safety_attributes.cpp new file mode 100644 index 0000000..46161ba -- - /dev/null +++ b/cmake/thread_safety_attributes.cpp @ @ -0,0 +1,4 @ @ + # define HAVE_THREAD_SAFETY_ATTRIBUTES + # include `` ../src/mutex.h '' + +int main ( ) { } diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 2532454..07a5df5 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -135,7 +135,8 @ @ BENCHMARK ( BM_MultiThreaded ) - > Threads ( 4 ) ; # ifndef BENCHMARK_BENCHMARK_H_ # define BENCHMARK_BENCHMARK_H_ - # include < stdint.h > + # include < cassert > + # include < cstdint > # include < functional > # include < memory > @ @ -153,14 +154,18 @ @ void Initialize ( int* argc , const char** argv ) ; // Otherwise , run all benchmarks specified by the -- benchmark_filter flag , // and exit after running the benchmarks . -void RunSpecifiedBenchmarks
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2526faf..4296b23 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -44,6 +44,10 @ @ add_cxx_compiler_flag ( -pedantic-errors ) add_cxx_compiler_flag ( -fno-strict-aliasing RELEASE ) add_cxx_compiler_flag ( -Wthread-safety ) +if ( HAVE_WTHREAD_SAFETY ) + add_definitions ( -DHAVE_WTHREAD_SAFETY ) + cxx_feature_check ( THREAD_SAFETY_ATTRIBUTES ) +endif ( ) # C++ feature checks cxx_feature_check ( STD_REGEX ) diff -- git a/cmake/thread_safety_attributes.cpp b/cmake/thread_safety_attributes.cpp new file mode 100644 index 0000000..46161ba -- - /dev/null +++ b/cmake/thread_safety_attributes.cpp @ @ -0,0 +1,4 @ @ + # define HAVE_THREAD_SAFETY_ATTRIBUTES + # include `` ../src/mutex.h '' + +int main ( ) { } diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 2532454..fbab4e0 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -135,7 +135,8 @ @ BENCHMARK ( BM_MultiThreaded ) - > Threads ( 4 ) ; # ifndef BENCHMARK_BENCHMARK_H_ # define BENCHMARK_BENCHMARK_H_ - # include < stdint.h > + # include < cassert > + # include < cstdint > # include < functional > # include < memory > @ @ -153,14 +154,7 @ @ void Initialize ( int* argc , const char** argv ) ; // Otherwise , run all benchmarks specified by the -- benchmark_filter flag , // and exit after running the benchmarks . -void RunSpecifiedBenchmarks
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2526faf..4296b23 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -44,6 +44,10 @ @ add_cxx_compiler_flag ( -pedantic-errors ) add_cxx_compiler_flag ( -fno-strict-aliasing RELEASE ) add_cxx_compiler_flag ( -Wthread-safety ) +if ( HAVE_WTHREAD_SAFETY ) + add_definitions ( -DHAVE_WTHREAD_SAFETY ) + cxx_feature_check ( THREAD_SAFETY_ATTRIBUTES ) +endif ( ) # C++ feature checks cxx_feature_check ( STD_REGEX ) diff -- git a/cmake/thread_safety_attributes.cpp b/cmake/thread_safety_attributes.cpp new file mode 100644 index 0000000..46161ba -- - /dev/null +++ b/cmake/thread_safety_attributes.cpp @ @ -0,0 +1,4 @ @ + # define HAVE_THREAD_SAFETY_ATTRIBUTES + # include `` ../src/mutex.h '' + +int main ( ) { } diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 2532454..c62fae7 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -135,7 +135,8 @ @ BENCHMARK ( BM_MultiThreaded ) - > Threads ( 4 ) ; # ifndef BENCHMARK_BENCHMARK_H_ # define BENCHMARK_BENCHMARK_H_ - # include < stdint.h > + # include < cassert > + # include < cstdint > # include < functional > # include < memory > @ @ -153,14 +154,18 @ @ void Initialize ( int* argc , const char** argv ) ; // Otherwise , run all benchmarks specified by the -- benchmark_filter flag , // and exit after running the benchmarks . -void RunSpecifiedBenchmarks
diff -- git a/README.md b/README.md index 2f2d78f..3820395 100644 -- - a/README.md +++ b/README.md @ @ -545,12 +545,20 @ @ The number of runs of each benchmark is specified globally by the ` Repetitions ` on the registered benchmark object . When a benchmark is run more than once the mean , median and standard deviation of the runs will be reported . -Additionally the ` -- benchmark_report_aggregates_only= { true|false } ` flag or - ` ReportAggregatesOnly ( bool ) ` function can be used to change how repeated tests -are reported . By default the result of each repeated run is reported . When this -option is ` true ` only the mean , median and standard deviation of the runs is reported . -Calling ` ReportAggregatesOnly ( bool ) ` on a registered benchmark object overrides -the value of the flag for that benchmark . +Additionally the ` -- benchmark_report_aggregates_only= { true|false } ` , + ` -- benchmark_display_aggregates_only= { true|false } ` flags or + ` ReportAggregatesOnly ( bool ) ` , ` DisplayAggregatesOnly ( bool ) ` functions can be +used to change how repeated tests are reported . By default the result of each +repeated run
diff -- git a/README.md b/README.md index 2f2d78f..3820395 100644 -- - a/README.md +++ b/README.md @ @ -545,12 +545,20 @ @ The number of runs of each benchmark is specified globally by the ` Repetitions ` on the registered benchmark object . When a benchmark is run more than once the mean , median and standard deviation of the runs will be reported . -Additionally the ` -- benchmark_report_aggregates_only= { true|false } ` flag or - ` ReportAggregatesOnly ( bool ) ` function can be used to change how repeated tests -are reported . By default the result of each repeated run is reported . When this -option is ` true ` only the mean , median and standard deviation of the runs is reported . -Calling ` ReportAggregatesOnly ( bool ) ` on a registered benchmark object overrides -the value of the flag for that benchmark . +Additionally the ` -- benchmark_report_aggregates_only= { true|false } ` , + ` -- benchmark_display_aggregates_only= { true|false } ` flags or + ` ReportAggregatesOnly ( bool ) ` , ` DisplayAggregatesOnly ( bool ) ` functions can be +used to change how repeated tests are reported . By default the result of each +repeated run
diff -- git a/src/cycleclock.h b/src/cycleclock.h index ca26cca..726311e 100644 -- - a/src/cycleclock.h +++ b/src/cycleclock.h @ @ -45,6 +45,14 @ @ extern `` C '' uint64_t __rdtsc ( ) ; # include < sys/time.h > # endif + # ifdef BENCHMARK_OS_EMSCRIPTEN + # include < emscripten.h > + # endif + + # if defined ( __pnacl__ ) + # include < time.h > + # endif + namespace benchmark { // NOTE : only i386 and x86_64 have been well tested . // PPC , sparc , alpha , and ia64 are based on @ @ -65,6 +73,10 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { // counter pauses ; it does not continue counting , nor does it // reset to zero . return mach_absolute_time ( ) ; + # elif defined ( BENCHMARK_OS_EMSCRIPTEN ) + // this goes above x86-specific code because old versions of Emscripten + // define __x86_64__ , although they have nothing to do with it . + return static_cast < int64_t > ( emscripten_get_now ( ) * 1e+6 ) ; # elif defined ( __i386__ ) int64_t ret ; __asm__ volatile ( `` rdtsc '' : `` =A '' ( ret ) ) ;
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 8cde61b..420d454 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -577,9 +577,13 @ @ class Benchmark { // Set the minimum amount of time to use when running this benchmark . This // option overrides the ` benchmark_min_time ` flag . - // REQUIRES : ` t > 0 ` + // REQUIRES : ` t > 0 ` and ` Iterations ` has not been called on this benchmark . Benchmark* MinTime ( double t ) ; + // Specify the amount of iterations that should be run by this benchmark . + // REQUIRES : 'n > 0 ' and ` MinTime ` has not been called on this benchmark . + Benchmark* Iterations ( size_t n ) ; + // Specify the amount of times to repeat this benchmark . This option overrides // the ` benchmark_repetitions ` flag . // REQUIRES : ` n > 0 ` @ @ -668,6 +672,7 @ @ class Benchmark { TimeUnit time_unit_ ; int range_multiplier_ ; double min_time_ ; + size_t iterations_ ; int repetitions_ ; bool use_real_time_ ; bool use_manual_time_ ; diff -- git a/src/benchmark.cc b/src/benchmark.cc index a93a83d..4adb97a 100644 -- - a/src/benchmark.cc +++ b/src/benchmark.cc
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 28baa58..754fb87 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -168,6 +168,9 @ @ class BenchmarkReporter ; void Initialize ( int* argc , char** argv ) ; +// Report to stdout all arguments in 'argv ' as unrecognized except the first . +void ReportUnrecognizedArguments ( int argc , char** argv ) ; + // Generate a list of benchmarks matching the specified -- benchmark_filter flag // and if -- benchmark_list_tests is specified return after printing the name // of each matching benchmark . Otherwise run each matching benchmark and @ @ -858,6 +861,10 @ @ class Fixture : public internal : :Benchmark { # define BENCHMARK_MAIN ( ) \ int main ( int argc , char** argv ) { \ : :benchmark : :Initialize ( & argc , argv ) ; \ + if ( argc > 1 ) { \ + : :benchmark : :ReportUnrecognizedArguments ( argc , argv ) ; \ + return 1 ; \ + } \ : :benchmark : :RunSpecifiedBenchmarks ( ) ; \ } diff -- git a/src/benchmark.cc b/src/benchmark.cc index 95f6a25..0374ec8 100644 -- - a/src/benchmark.cc +++ b/src/benchmark.cc @ @ -664,4 +664,10 @ @ void Initialize ( int* argc ,
diff -- git a/CMakeLists.txt b/CMakeLists.txt index e3abf0f..713d22b 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -92,8 +92,13 @ @ else ( ) add_cxx_compiler_flag ( -Wzero-as-null-pointer-constant ) endif ( ) if ( HAVE_CXX_FLAG_FSTRICT_ALIASING ) - add_cxx_compiler_flag ( -Wstrict-aliasing ) + if ( NOT CMAKE_CXX_COMPILER_ID STREQUAL `` Intel '' ) # ICC17u2 : Many false positives for Wstrict-aliasing + add_cxx_compiler_flag ( -Wstrict-aliasing ) + endif ( ) endif ( ) + # ICC17u2 : overloaded virtual function `` benchmark : :Fixture : :SetUp '' is only partially overridden + # ( because of deprecated overload ) + add_cxx_compiler_flag ( -wd654 ) add_cxx_compiler_flag ( -Wthread-safety ) if ( HAVE_CXX_FLAG_WTHREAD_SAFETY ) cxx_feature_check ( THREAD_SAFETY_ATTRIBUTES ) diff -- git a/README.md b/README.md index 4446637..f16a9d7 100644 -- - a/README.md +++ b/README.md @ @ -643,6 +643,7 @ @ The following minimum versions are strongly recommended build the library : * GCC 4.8 * Clang 3.4 * Visual Studio 2013 +* Intel 2015 Update 1 Anything older *may* work . diff -- git a/test/benchmark_test.cc b/test/benchmark_test.cc index dfcf092..5773133 100644 -- - a/test/benchmark_test.cc +++ b/test/benchmark_test.cc @ @ -150,7 +150,7 @ @ static void BM_LongTest ( benchmark : :State & state ) { BENCHMARK ( BM_LongTest ) - > Range ( 1
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..3401ed2 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..713823c 100644 -- - a/README.md +++ b/README.md @ @ -393,6 +393,78 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..98d2be2 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/.travis.yml b/.travis.yml index 6bbd13b..c10e3da 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -6,129 +6,138 @ @ env : global : - /usr/local/bin : $ PATH - # NOTE : The COMPILER variable is unused . It simply makes the display on - # travis-ci.org more readable . matrix : - include : - - compiler : gcc - addons : - apt : - packages : - - lcov - env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Coverage - - compiler : gcc - env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug - - compiler : gcc - env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release - - compiler : gcc - addons : - apt : - packages : - - g++-multilib - env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON - - compiler : gcc - addons : - apt : - packages : - - g++-multilib - env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON - - compiler : gcc - addons : - apt : - sources : - - ubuntu-toolchain-r-test - packages : - - g++-6 - env : - - COMPILER=g++-6 C_COMPILER=gcc-6 BUILD_TYPE=Debug - - EXTRA_FLAGS= '' -fno-omit-frame-pointer -g -O2 -fsanitize=undefined , address -fuse-ld=gold '' - - compiler : clang - env : COMPILER=clang++
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 28baa58..754fb87 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -168,6 +168,9 @ @ class BenchmarkReporter ; void Initialize ( int* argc , char** argv ) ; +// Report to stdout all arguments in 'argv ' as unrecognized except the first . +void ReportUnrecognizedArguments ( int argc , char** argv ) ; + // Generate a list of benchmarks matching the specified -- benchmark_filter flag // and if -- benchmark_list_tests is specified return after printing the name // of each matching benchmark . Otherwise run each matching benchmark and @ @ -858,6 +861,10 @ @ class Fixture : public internal : :Benchmark { # define BENCHMARK_MAIN ( ) \ int main ( int argc , char** argv ) { \ : :benchmark : :Initialize ( & argc , argv ) ; \ + if ( argc > 1 ) { \ + : :benchmark : :ReportUnrecognizedArguments ( argc , argv ) ; \ + return 1 ; \ + } \ : :benchmark : :RunSpecifiedBenchmarks ( ) ; \ } diff -- git a/src/benchmark.cc b/src/benchmark.cc index 95f6a25..e829176 100644 -- - a/src/benchmark.cc +++ b/src/benchmark.cc @ @ -664,4 +664,10 @ @ void Initialize ( int* argc ,
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index b3b0a8e..fc448e6 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -11,11 +11,1199 @ @ // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . // See the License for the specific language governing permissions and // limitations under the License . + +// Support for registering benchmarks for functions . + +/* Example usage : +// Define a function that executes the code to be measured a +// specified number of times : +static void BM_StringCreation ( benchmark : :State & state ) { + while ( state.KeepRunning ( ) ) + std : :string empty_string ; + } + +// Register the function as a benchmark +BENCHMARK ( BM_StringCreation ) ; + +// Define another benchmark +static void BM_StringCopy ( benchmark : :State & state ) { + std : :string x = `` hello '' ; + while ( state.KeepRunning ( ) ) + std : :string copy ( x ) ; + } +BENCHMARK ( BM_StringCopy ) ; + +// Augment the main ( ) program to invoke benchmarks if specified +// via the -- benchmarks command line flag . E.g. , +// my_unittest -- benchmark_filter=all +// my_unittest
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -228,6 +235,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..05ad376 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..35f594a 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index b3b0a8e..fc448e6 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -11,11 +11,1199 @ @ // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . // See the License for the specific language governing permissions and // limitations under the License . + +// Support for registering benchmarks for functions . + +/* Example usage : +// Define a function that executes the code to be measured a +// specified number of times : +static void BM_StringCreation ( benchmark : :State & state ) { + while ( state.KeepRunning ( ) ) + std : :string empty_string ; + } + +// Register the function as a benchmark +BENCHMARK ( BM_StringCreation ) ; + +// Define another benchmark +static void BM_StringCopy ( benchmark : :State & state ) { + std : :string x = `` hello '' ; + while ( state.KeepRunning ( ) ) + std : :string copy ( x ) ; + } +BENCHMARK ( BM_StringCopy ) ; + +// Augment the main ( ) program to invoke benchmarks if specified +// via the -- benchmarks command line flag . E.g. , +// my_unittest -- benchmark_filter=all +// my_unittest
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..35f594a 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..5ab7ece 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -21,6 +21,10 @ @ matrix : - compiler : gcc env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc addons : apt : sources : @ @ -44,6 +48,17 @ @ matrix :
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..a3f6a1b 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -21,6 +21,10 @ @ matrix : - compiler : gcc env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc addons : apt : sources : @ @ -44,6 +48,17 @ @ matrix :
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9109430..1b14138 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 8cde61b..1e853e2 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -577,9 +577,17 @ @ class Benchmark { // Set the minimum amount of time to use when running this benchmark . This // option overrides the ` benchmark_min_time ` flag . - // REQUIRES : ` t > 0 ` + // REQUIRES : ` t > 0 ` and ` Iterations ` has not been called on this benchmark . Benchmark* MinTime ( double t ) ; + // Specify the amount of iterations that should be run by this benchmark . + // REQUIRES : 'n > 0 ' and ` MinTime ` has not been called on this benchmark . + // + // NOTE : This function should only be used when *exact* iteration control is + // needed and never to control or limit how long a benchmark runs , where + // ` -- benchmark_min_time=N ` or ` MinTime ( ... ) ` should be used instead . + Benchmark* Iterations ( size_t n ) ; + // Specify the amount of times to repeat this benchmark . This option overrides // the ` benchmark_repetitions ` flag . //
diff -- git a/src/benchmark_register.cc b/src/benchmark_register.cc index cf78bbf..0753e5c 100644 -- - a/src/benchmark_register.cc +++ b/src/benchmark_register.cc @ @ -31,6 +31,7 @ @ # include < fstream > # include < iostream > # include < memory > + # include < sstream > # include < thread > # include `` check.h '' @ @ -162,8 +163,15 @ @ bool BenchmarkFamilies : :FindBenchmarks ( StringPrintF ( `` % s : '' , family- > arg_names_ [ arg_i ] .c_str ( ) ) ; } } - + + # if defined ( __ANDROID__ ) & & ( defined ( __GLIBCXX__ ) || defined ( __GLIBCPP__ ) ) + // workaround for Android , http : //stackoverflow.com/questions/22774009/android-ndk-stdto-string-support + std : :ostringstream ss ; + ss < < arg ; + instance.name += ss.str ( ) ; + # else instance.name += std : :to_string ( arg ) ; + # endif ++arg_i ; } diff -- git a/src/colorprint.cc b/src/colorprint.cc index 513376b..2dec4a8 100644 -- - a/src/colorprint.cc +++ b/src/colorprint.cc @ @ -89,7 +89,7 @ @ std : :string FormatString ( const char* msg , va_list args ) { std : :size_t size = 256 ; char local_buff [ 256 ] ; - auto ret = std
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 28baa58..ff3f3d4 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -858,6 +858,13 @ @ class Fixture : public internal : :Benchmark { # define BENCHMARK_MAIN ( ) \ int main ( int argc , char** argv ) { \ : :benchmark : :Initialize ( & argc , argv ) ; \ + for ( int i = 1 ; i < argc ; ++i ) { \ + fprintf ( stdout , `` % s : error : unrecognised command-line flag : % s\n '' , \ + argv [ 0 ] , argv [ i ] ) ; \ + } \ + if ( argc > 1 ) { \ + return 1 ; \ + } \ : :benchmark : :RunSpecifiedBenchmarks ( ) ; \ }
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 356994a..f7f1566 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -5,7 +5,6 @ @ project ( benchmark ) foreach ( p CMP0054 # CMake 3.1 CMP0056 # export EXE_LINKER_FLAGS to try_run - CMP0063 # CMake 3.3 - honour symbol visability for static libraries ) if ( POLICY $ { p } ) cmake_policy ( SET $ { p } NEW )
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..3401ed2 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..90fd5c4 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 8c15b87..391434c 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -25,6 +25,7 @ @ Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > Lei Xu < eddyxu @ gmail.com > Matt Clarkson < mattyclarkson @ gmail.com > +Maxim Vafin < maxvafin @ gmail.com > Nick Hutchinson < nshutchinson @ gmail.com > Oleksandr Sochka < sasha.sochka @ gmail.com > Paul Redmond < paul.redmond @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 96cd15a..0f7f6ed 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -41,6 +41,7 @ @ Kaito Udagawa < umireon @ gmail.com > Kai Wolf < kai.wolf @ gmail.com > Lei Xu < eddyxu @ gmail.com > Matt Clarkson < mattyclarkson @ gmail.com > +Maxim Vafin < maxvafin @ gmail.com > Nick Hutchinson < nshutchinson @ gmail.com > Oleksandr Sochka < sasha.sochka @ gmail.com > Pascal Leroy < phl @ google.com > diff -- git a/src/sysinfo.cc b/src/sysinfo.cc index 34f9871..7feb79e 100644 -- - a/src/sysinfo.cc +++ b/src/sysinfo.cc @ @ -75,7 +75,9 @ @ bool ReadIntFromFile ( const char* file , long* value ) { char line [ 1024 ] ; char* err ; memset ( line , '\0 ' , sizeof ( line )
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..5ab7ece 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -21,6 +21,10 @ @ matrix : - compiler : gcc env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc addons : apt : sources : @ @ -44,6 +48,17 @ @ matrix :
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..daeedc2 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,6 +23,18 @ @ matrix : - compiler : gcc addons : apt : + packages : + - gcc-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + addons : + apt : + packages : + - gcc-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index c4b059d..49f500f 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -32,6 +32,7 @ @ Oleksandr Sochka < sasha.sochka @ gmail.com > Paul Redmond < paul.redmond @ gmail.com > Radoslav Yovchev < radoslav.tm @ gmail.com > Shuo Chen < chenshuo @ chenshuo.com > +Yixuan Qiu < yixuanq @ gmail.com > Yusuke Suzuki < utatane.tea @ gmail.com > Dirac Research Zbigniew Skowron < zbychs @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 8ca4565..c0c0292 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -50,6 +50,7 @ @ Pierre Phaneuf < pphaneuf @ google.com > Radoslav Yovchev < radoslav.tm @ gmail.com > Ray Glover < ray.glover @ uk.ibm.com > Shuo Chen < chenshuo @ chenshuo.com > +Yixuan Qiu < yixuanq @ gmail.com > Yusuke Suzuki < utatane.tea @ gmail.com > Tobias Ulvgrd < tobias.ulvgard @ dirac.se > Zbigniew Skowron < zbychs @ gmail.com > diff -- git a/src/complexity.cc b/src/complexity.cc index a4c57c4..24b3ed4 100644 -- - a/src/complexity.cc +++ b/src/complexity.cc @ @ -194,16 +194,16 @ @ std : :vector < BenchmarkReporter : :Run > ComputeStats ( CHECK_EQ ( run_iterations , run.iterations ) ; if ( run.error_occurred ) continue ; real_accumulated_time_stat += - Stat1_d ( run.real_accumulated_time / run.iterations , run.iterations ) ; +
diff -- git a/.gitattributes b/.gitattributes new file mode 100644 index 0000000..da00b4e -- - /dev/null +++ b/.gitattributes @ @ -0,0 +1,5 @ @ + # Auto detect text files and perform LF normalization +* text=auto + + # Custom for Visual Studio +*.sln merge=union diff -- git a/.gitignore b/.gitignore index 9b51121..a398cdd 100644 -- - a/.gitignore +++ b/.gitignore @ @ -10,3 +10,10 @ @ cmake_install.cmake lib/ tags .ycm_extra_conf.pyc + + # Visual Studio files +/msvc/ [ Dd ] ebug*/ +/msvc/ [ Rr ] elease*/ +/msvc/*.opensdf +/msvc/*.sdf +/msvc/*.suo diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index c8c2115..3765544 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -135,16 +135,19 @ @ BENCHMARK ( BM_MultiThreaded ) - > Threads ( 4 ) ; # ifndef BENCHMARK_BENCHMARK_H_ # define BENCHMARK_BENCHMARK_H_ - # include < stdint.h > + # include `` port.h '' + # include < stdint.h > # include < functional > # include < memory > - # include < pthread.h > # include < string > # include < vector > # include `` macros.h '' +struct _pthread_v ; +typedef struct _pthread_v* pthread_t ; + namespace benchmark { class BenchmarkReporter ; diff -- git a/include/benchmark/macros.h b/include/benchmark/macros.h index da408d4..8330549 100644 -- - a/include/benchmark/macros.h +++ b/include/benchmark/macros.h @ @
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 8cde61b..420d454 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -577,9 +577,13 @ @ class Benchmark { // Set the minimum amount of time to use when running this benchmark . This // option overrides the ` benchmark_min_time ` flag . - // REQUIRES : ` t > 0 ` + // REQUIRES : ` t > 0 ` and ` Iterations ` has not been called on this benchmark . Benchmark* MinTime ( double t ) ; + // Specify the amount of iterations that should be run by this benchmark . + // REQUIRES : 'n > 0 ' and ` MinTime ` has not been called on this benchmark . + Benchmark* Iterations ( size_t n ) ; + // Specify the amount of times to repeat this benchmark . This option overrides // the ` benchmark_repetitions ` flag . // REQUIRES : ` n > 0 ` @ @ -668,6 +672,7 @ @ class Benchmark { TimeUnit time_unit_ ; int range_multiplier_ ; double min_time_ ; + size_t iterations_ ; int repetitions_ ; bool use_real_time_ ; bool use_manual_time_ ; diff -- git a/src/benchmark.cc b/src/benchmark.cc index a93a83d..4adb97a 100644 -- - a/src/benchmark.cc +++ b/src/benchmark.cc
diff -- git a/src/benchmark_register.cc b/src/benchmark_register.cc index cf78bbf..0753e5c 100644 -- - a/src/benchmark_register.cc +++ b/src/benchmark_register.cc @ @ -31,6 +31,7 @ @ # include < fstream > # include < iostream > # include < memory > + # include < sstream > # include < thread > # include `` check.h '' @ @ -162,8 +163,15 @ @ bool BenchmarkFamilies : :FindBenchmarks ( StringPrintF ( `` % s : '' , family- > arg_names_ [ arg_i ] .c_str ( ) ) ; } } - + + # if defined ( __ANDROID__ ) & & ( defined ( __GLIBCXX__ ) || defined ( __GLIBCPP__ ) ) + // workaround for Android , http : //stackoverflow.com/questions/22774009/android-ndk-stdto-string-support + std : :ostringstream ss ; + ss < < arg ; + instance.name += ss.str ( ) ; + # else instance.name += std : :to_string ( arg ) ; + # endif ++arg_i ; } diff -- git a/src/colorprint.cc b/src/colorprint.cc index 513376b..2dec4a8 100644 -- - a/src/colorprint.cc +++ b/src/colorprint.cc @ @ -89,7 +89,7 @ @ std : :string FormatString ( const char* msg , va_list args ) { std : :size_t size = 256 ; char local_buff [ 256 ] ; - auto ret = std
diff -- git a/CMakeLists.txt b/CMakeLists.txt index e3abf0f..713d22b 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -92,8 +92,13 @ @ else ( ) add_cxx_compiler_flag ( -Wzero-as-null-pointer-constant ) endif ( ) if ( HAVE_CXX_FLAG_FSTRICT_ALIASING ) - add_cxx_compiler_flag ( -Wstrict-aliasing ) + if ( NOT CMAKE_CXX_COMPILER_ID STREQUAL `` Intel '' ) # ICC17u2 : Many false positives for Wstrict-aliasing + add_cxx_compiler_flag ( -Wstrict-aliasing ) + endif ( ) endif ( ) + # ICC17u2 : overloaded virtual function `` benchmark : :Fixture : :SetUp '' is only partially overridden + # ( because of deprecated overload ) + add_cxx_compiler_flag ( -wd654 ) add_cxx_compiler_flag ( -Wthread-safety ) if ( HAVE_CXX_FLAG_WTHREAD_SAFETY ) cxx_feature_check ( THREAD_SAFETY_ATTRIBUTES ) diff -- git a/README.md b/README.md index 4446637..f16a9d7 100644 -- - a/README.md +++ b/README.md @ @ -643,6 +643,7 @ @ The following minimum versions are strongly recommended build the library : * GCC 4.8 * Clang 3.4 * Visual Studio 2013 +* Intel 2015 Update 1 Anything older *may* work . diff -- git a/test/benchmark_test.cc b/test/benchmark_test.cc index dfcf092..5773133 100644 -- - a/test/benchmark_test.cc +++ b/test/benchmark_test.cc @ @ -150,7 +150,7 @ @ static void BM_LongTest ( benchmark : :State & state ) { BENCHMARK ( BM_LongTest ) - > Range ( 1
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index b3b0a8e..fc448e6 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -11,11 +11,1199 @ @ // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . // See the License for the specific language governing permissions and // limitations under the License . + +// Support for registering benchmarks for functions . + +/* Example usage : +// Define a function that executes the code to be measured a +// specified number of times : +static void BM_StringCreation ( benchmark : :State & state ) { + while ( state.KeepRunning ( ) ) + std : :string empty_string ; + } + +// Register the function as a benchmark +BENCHMARK ( BM_StringCreation ) ; + +// Define another benchmark +static void BM_StringCopy ( benchmark : :State & state ) { + std : :string x = `` hello '' ; + while ( state.KeepRunning ( ) ) + std : :string copy ( x ) ; + } +BENCHMARK ( BM_StringCopy ) ; + +// Augment the main ( ) program to invoke benchmarks if specified +// via the -- benchmarks command line flag . E.g. , +// my_unittest -- benchmark_filter=all +// my_unittest
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 4755322..7f9a58f 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -707,6 +707,10 @ @ template < class Lambda > internal : :Benchmark* RegisterBenchmark ( const char* name , Lambda & & fn ) ; # endif +// Remove all registered benchmarks . All pointers to previously registered +// benchmarks are invalidated . +void ClearRegisteredBenchmarks ( ) ; + namespace internal { // The class used to hold all Benchmarks created from static function . // ( ie those created using the BENCHMARK ( ... ) macros . diff -- git a/src/benchmark_register.cc b/src/benchmark_register.cc index c95da98..ed70d82 100644 -- - a/src/benchmark_register.cc +++ b/src/benchmark_register.cc @ @ -70,6 +70,9 @ @ class BenchmarkFamilies { // Registers a benchmark family and returns the index assigned to it . size_t AddBenchmark ( std : :unique_ptr < Benchmark > family ) ; + // Clear all registered benchmark families . + void ClearBenchmarks ( ) ; + // Extract the list of benchmark instances that match the specified // regular expression . bool FindBenchmarks ( const std : :string & re , @ @ -95,6 +98,12 @ @ size_t BenchmarkFamilies : :AddBenchmark ( std : :unique_ptr < Benchmark > family ) { return
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..f681078 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..98dca3d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..9f9ca91 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..456b0a6 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,65 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..a591743 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,18 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF & & echo disabling 32 bit build +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLLVM_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..314ac64 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,6 +23,18 @ @ matrix : - compiler : gcc addons : apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + addons : + apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc +
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -228,6 +235,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -228,6 +235,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..82bd94f 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..9f9ca91 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..9f9ca91 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..35f594a 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..456b0a6 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,65 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index c4b059d..49f500f 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -32,6 +32,7 @ @ Oleksandr Sochka < sasha.sochka @ gmail.com > Paul Redmond < paul.redmond @ gmail.com > Radoslav Yovchev < radoslav.tm @ gmail.com > Shuo Chen < chenshuo @ chenshuo.com > +Yixuan Qiu < yixuanq @ gmail.com > Yusuke Suzuki < utatane.tea @ gmail.com > Dirac Research Zbigniew Skowron < zbychs @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 8ca4565..c0c0292 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -50,6 +50,7 @ @ Pierre Phaneuf < pphaneuf @ google.com > Radoslav Yovchev < radoslav.tm @ gmail.com > Ray Glover < ray.glover @ uk.ibm.com > Shuo Chen < chenshuo @ chenshuo.com > +Yixuan Qiu < yixuanq @ gmail.com > Yusuke Suzuki < utatane.tea @ gmail.com > Tobias Ulvgrd < tobias.ulvgard @ dirac.se > Zbigniew Skowron < zbychs @ gmail.com > diff -- git a/src/complexity.cc b/src/complexity.cc index a4c57c4..24b3ed4 100644 -- - a/src/complexity.cc +++ b/src/complexity.cc @ @ -194,16 +194,16 @ @ std : :vector < BenchmarkReporter : :Run > ComputeStats ( CHECK_EQ ( run_iterations , run.iterations ) ; if ( run.error_occurred ) continue ; real_accumulated_time_stat += - Stat1_d ( run.real_accumulated_time / run.iterations , run.iterations ) ; +
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index ea9743c..1521e7f 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -1303,7 +1303,7 @ @ class BenchmarkReporter { // Keep track of arguments to compute asymptotic complexity BigO complexity ; BigOFunc* complexity_lambda ; - int complexity_n ; + int64_t complexity_n ; // what statistics to compute from the measurements const std : :vector < Statistics > * statistics ; diff -- git a/src/complexity.cc b/src/complexity.cc index b1aad69..9305605 100644 -- - a/src/complexity.cc +++ b/src/complexity.cc @ @ -157,7 +157,7 @ @ std : :vector < BenchmarkReporter : :Run > ComputeBigO ( if ( reports.size ( ) < 2 ) return results ; // Accumulators . - std : :vector < int > n ; + std : :vector < int64_t > n ; std : :vector < double > real_time ; std : :vector < double > cpu_time ; diff -- git a/src/thread_manager.h b/src/thread_manager.h index f9ee267..61755a8 100644 -- - a/src/thread_manager.h +++ b/src/thread_manager.h @ @ -40,7 +40,7 @ @ class ThreadManager { double manual_time_used = 0 ; int64_t bytes_processed = 0 ; int64_t items_processed = 0 ; - int complexity_n = 0 ; + int64_t complexity_n = 0 ; std : :string report_label_ ; std : :string error_message_ ; bool
diff -- git a/.gitignore b/.gitignore index aca5f93..050e469 100644 -- - a/.gitignore +++ b/.gitignore @ @ -6,6 +6,7 @ @ *.dylib *.cmake ! /cmake/*.cmake + ! /test/AssemblyTests.cmake *~ *.pyc __pycache__ diff -- git a/.travis.yml b/.travis.yml index 137cc98..09c058c 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -34,6 +34,7 @ @ matrix : env : - INSTALL_GCC6_FROM_PPA=1 - COMPILER=g++-6 C_COMPILER=gcc-6 BUILD_TYPE=Debug + - ENABLE_SANITIZER=1 - EXTRA_FLAGS= '' -fno-omit-frame-pointer -g -O2 -fsanitize=undefined , address -fuse-ld=gold '' - compiler : clang env : COMPILER=clang++ C_COMPILER=clang BUILD_TYPE=Debug @ @ -91,6 +92,7 @ @ matrix : env : - COMPILER=clang++-3.8 C_COMPILER=clang-3.8 BUILD_TYPE=Debug - LIBCXX_BUILD=1 LIBCXX_SANITIZER= '' Undefined ; Address '' + - ENABLE_SANITIZER=1 - EXTRA_FLAGS= '' -stdlib=libc++ -g -O2 -fno-omit-frame-pointer -fsanitize=undefined , address -fno-sanitize-recover=all '' - UBSAN_OPTIONS=print_stacktrace=1 # Clang w/ libc++ and MSAN @ @ -102,6 +104,7 @ @ matrix : env : - COMPILER=clang++-3.8 C_COMPILER=clang-3.8 BUILD_TYPE=Debug - LIBCXX_BUILD=1 LIBCXX_SANITIZER=MemoryWithOrigins + - ENABLE_SANITIZER=1 - EXTRA_FLAGS= '' -stdlib=libc++ -g -O2 -fno-omit-frame-pointer -fsanitize=memory -fsanitize-memory-track-origins '' # Clang w/ libc++ and MSAN - compiler : clang @ @ -112,8 +115,8 @ @ matrix : env : - COMPILER=clang++-3.8 C_COMPILER=clang-3.8 BUILD_TYPE=RelWithDebInfo - LIBCXX_BUILD=1 LIBCXX_SANITIZER=Thread + - ENABLE_SANITIZER=1 - EXTRA_FLAGS= '' -stdlib=libc++ -g -O2 -fno-omit-frame-pointer -fsanitize=thread -fno-sanitize-recover=all '' - - os :
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 04fbbf4..cf37e41 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -562,16 +562,16 @ @ class State { // Range arguments for this run . CHECKs if the argument has been set . BENCHMARK_ALWAYS_INLINE - int range ( std : :size_t pos = 0 ) const { + int64_t range ( std : :size_t pos = 0 ) const { assert ( range_.size ( ) > pos ) ; return range_ [ pos ] ; } BENCHMARK_DEPRECATED_MSG ( `` use 'range ( 0 ) ' instead '' ) - int range_x ( ) const { return range ( 0 ) ; } + int64_t range_x ( ) const { return range ( 0 ) ; } BENCHMARK_DEPRECATED_MSG ( `` use 'range ( 1 ) ' instead '' ) - int range_y ( ) const { return range ( 1 ) ; } + int64_t range_y ( ) const { return range ( 1 ) ; } BENCHMARK_ALWAYS_INLINE size_t iterations ( ) const { @ @ -598,7 +598,7 @ @ private : bool error_occurred_ ; private : // items we do n't need on the first cache line - std : :vector < int > range_ ;
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 04fbbf4..20265a4 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -525,10 +525,10 @ @ class State { // and complexity_n will // represent the length of N. BENCHMARK_ALWAYS_INLINE - void SetComplexityN ( int complexity_n ) { complexity_n_ = complexity_n ; } + void SetComplexityN ( int64_t complexity_n ) { complexity_n_ = complexity_n ; } BENCHMARK_ALWAYS_INLINE - int complexity_length_n ( ) { return complexity_n_ ; } + int64_t complexity_length_n ( ) { return complexity_n_ ; } // If this routine is called with items > 0 , then an items/s // label is printed on the benchmark report line for the currently @ @ -562,16 +562,16 @ @ class State { // Range arguments for this run . CHECKs if the argument has been set . BENCHMARK_ALWAYS_INLINE - int range ( std : :size_t pos = 0 ) const { + int64_t range ( std : :size_t pos = 0 ) const { assert ( range_.size ( ) > pos ) ; return range_ [ pos ] ; } BENCHMARK_DEPRECATED_MSG ( `` use 'range ( 0 ) ' instead '' ) - int range_x ( ) const { return range ( 0 ) ; } +
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 04fbbf4..ea9743c 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -514,10 +514,10 @ @ class State { // // REQUIRES : a benchmark has exited its benchmarking loop . BENCHMARK_ALWAYS_INLINE - void SetBytesProcessed ( size_t bytes ) { bytes_processed_ = bytes ; } + void SetBytesProcessed ( int64_t bytes ) { bytes_processed_ = bytes ; } BENCHMARK_ALWAYS_INLINE - size_t bytes_processed ( ) const { return bytes_processed_ ; } + int64_t bytes_processed ( ) const { return bytes_processed_ ; } // If this routine is called with complexity_n > 0 and complexity report is // requested for the @ @ -525,10 +525,10 @ @ class State { // and complexity_n will // represent the length of N. BENCHMARK_ALWAYS_INLINE - void SetComplexityN ( int complexity_n ) { complexity_n_ = complexity_n ; } + void SetComplexityN ( int64_t complexity_n ) { complexity_n_ = complexity_n ; } BENCHMARK_ALWAYS_INLINE - int complexity_length_n ( ) { return complexity_n_ ; } + int64_t complexity_length_n ( ) { return complexity_n_ ; } // If this routine is called with items > 0 , then an items/s // label is printed on the benchmark report line for the currently @ @ -537,10 +537,10 @
diff -- git a/src/cycleclock.h b/src/cycleclock.h index ca26cca..726311e 100644 -- - a/src/cycleclock.h +++ b/src/cycleclock.h @ @ -45,6 +45,14 @ @ extern `` C '' uint64_t __rdtsc ( ) ; # include < sys/time.h > # endif + # ifdef BENCHMARK_OS_EMSCRIPTEN + # include < emscripten.h > + # endif + + # if defined ( __pnacl__ ) + # include < time.h > + # endif + namespace benchmark { // NOTE : only i386 and x86_64 have been well tested . // PPC , sparc , alpha , and ia64 are based on @ @ -65,6 +73,10 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { // counter pauses ; it does not continue counting , nor does it // reset to zero . return mach_absolute_time ( ) ; + # elif defined ( BENCHMARK_OS_EMSCRIPTEN ) + // this goes above x86-specific code because old versions of Emscripten + // define __x86_64__ , although they have nothing to do with it . + return static_cast < int64_t > ( emscripten_get_now ( ) * 1e+6 ) ; # elif defined ( __i386__ ) int64_t ret ; __asm__ volatile ( `` rdtsc '' : `` =A '' ( ret ) ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..40dfd50 100644 -- - a/README.md +++ b/README.md @ @ -393,6 +393,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 1e853e2..4755322 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -231,7 +231,13 @ @ BENCHMARK_UNUSED static int stream_init_anchor = InitializeStreams ( ) ; # ifndef BENCHMARK_HAS_NO_INLINE_ASSEMBLY template < class Tp > inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { + // Clang does n't like the 'X ' constraint on ` value ` and certain GCC versions + // do n't like the 'g ' constraint . Attempt to placate them both . + # if defined ( __clang__ ) asm volatile ( `` '' : : `` g '' ( value ) : `` memory '' ) ; + # else + asm volatile ( `` '' : : `` i , r , m '' ( value ) : `` memory '' ) ; + # endif } // Force the compiler to flush pending writes to global memory . Acts as an // effective read/write barrier diff -- git a/test/CMakeLists.txt b/test/CMakeLists.txt index d89135a..b55612b 100644 -- - a/test/CMakeLists.txt +++ b/test/CMakeLists.txt @ @ -1,6 +1,7 @ @ # Enable the tests find_package ( Threads REQUIRED ) +include ( CheckCXXCompilerFlag ) # NOTE : Some tests use ` < cassert > `
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..c4f0741 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,6 +23,18 @ @ matrix : - compiler : gcc addons : apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + addons : + apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc +
diff -- git a/README.md b/README.md index 456b0a6..4446637 100644 -- - a/README.md +++ b/README.md @ @ -365,7 +365,7 @ @ static void BM_vector_push_back ( benchmark : :State & state ) { } `` ` -Note that ` ClobberMemory ( ) ` is only available for GNU based compilers . +Note that ` ClobberMemory ( ) ` is only available for GNU or MSVC based compilers . # # # Set time unit manually If a benchmark runs a few milliseconds it may be hard to visually compare the diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f72a64a..8cde61b 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -165,6 +165,10 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include < utility > # endif + # if defined ( _MSC_VER ) + # include < intrin.h > // for _ReadWriteBarrier + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -215,11 +219,16 @ @ BENCHMARK_UNUSED static int stream_init_anchor = InitializeStreams ( ) ; } // end namespace internal + + # if ! defined ( __GNUC__ ) || defined ( __pnacl__ ) || defined ( EMSCRIPTN ) + # define BENCHMARK_HAS_NO_INLINE_ASSEMBLY + # endif + //
diff -- git a/src/complexity.cc b/src/complexity.cc index 02adbef..a4c57c4 100644 -- - a/src/complexity.cc +++ b/src/complexity.cc @ @ -35,9 +35,9 @ @ BigOFunc* FittingCurve ( BigO complexity ) { case oNCubed : return [ ] ( int n ) - > double { return std : :pow ( n , 3 ) ; } ; case oLogN : - return [ ] ( int n ) { return std : :log2 ( n ) ; } ; + return [ ] ( int n ) { return log2 ( n ) ; } ; case oNLogN : - return [ ] ( int n ) { return n * std : :log2 ( n ) ; } ; + return [ ] ( int n ) { return n * log2 ( n ) ; } ; case o1 : default : return [ ] ( int ) { return 1.0 ; } ; diff -- git a/test/complexity_test.cc b/test/complexity_test.cc index 14e03b0..62d1154 100644 -- - a/test/complexity_test.cc +++ b/test/complexity_test.cc @ @ -141,7 +141,7 @ @ BENCHMARK ( BM_Complexity_O_N_log_N ) BENCHMARK ( BM_Complexity_O_N_log_N ) - > RangeMultiplier ( 2 ) - > Range ( 1 < < 10 , 1 < < 16 ) - -
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..9f9ca91 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/src/sleep.cc b/src/sleep.cc index 918abc4..1449339 100644 -- - a/src/sleep.cc +++ b/src/sleep.cc @ @ -15,6 +15,7 @ @ # include `` sleep.h '' # include < cerrno > + # include < cstdlib > # include < ctime > # include `` internal_macros.h ''
diff -- git a/src/benchmark_register.cc b/src/benchmark_register.cc index cf78bbf..05dc704 100644 -- - a/src/benchmark_register.cc +++ b/src/benchmark_register.cc @ @ -31,6 +31,7 @ @ # include < fstream > # include < iostream > # include < memory > + # include < sstream > # include < thread > # include `` check.h '' @ @ -162,8 +163,15 @ @ bool BenchmarkFamilies : :FindBenchmarks ( StringPrintF ( `` % s : '' , family- > arg_names_ [ arg_i ] .c_str ( ) ) ; } } - + + # if defined ( __ANDROID__ ) & & defined ( __GLIBCXX__ ) + // workaround for Android , http : //stackoverflow.com/questions/22774009/android-ndk-stdto-string-support + std : :ostringstream ss ; + ss < < arg ; + instance.name += ss.str ( ) ; + # else instance.name += std : :to_string ( arg ) ; + # endif ++arg_i ; } diff -- git a/src/colorprint.cc b/src/colorprint.cc index 513376b..2dec4a8 100644 -- - a/src/colorprint.cc +++ b/src/colorprint.cc @ @ -89,7 +89,7 @ @ std : :string FormatString ( const char* msg , va_list args ) { std : :size_t size = 256 ; char local_buff [ 256 ] ; - auto ret = std : :vsnprintf ( local_buff , size ,
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..68c1ee2 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..9f9ca91 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..456b0a6 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,65 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..68c1ee2 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..40dfd50 100644 -- - a/README.md +++ b/README.md @ @ -393,6 +393,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..9f9ca91 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/tools/compare.py b/tools/compare.py new file mode 100644 index 0000000..e5bddd6 -- - /dev/null +++ b/tools/compare.py @ @ -0,0 +1,24 @ @ + # ! /usr/bin/env python + +import sys +import gbench.report as greport +import gbench.util as gutil + +def main ( ) : + # Parse the command line flags + def usage ( ) : + print ( 'compare_bench.py < test1 > < test2 > [ benchmark options ] ... ' ) + exit ( 1 ) + if ' -- help ' in sys.argv or len ( sys.argv ) < 3 : + usage ( ) + tests = sys.argv [ 1:3 ] + bench_opts = sys.argv [ 3 : ] + bench_opts = list ( bench_opts ) + # Run the benchmarks and report the results + json1 = gutil.run_or_load_benchmark ( tests [ 0 ] , bench_opts ) + json2 = gutil.run_or_load_benchmark ( tests [ 1 ] , bench_opts ) + greport.report_difference ( json1 , json2 ) + + +if __name__ == '__main__ ' : + main ( ) \ No newline at end of file diff -- git a/tools/gbench/__init__.py b/tools/gbench/__init__.py new file mode 100644 index 0000000..fce1a1a -- - /dev/null +++ b/tools/gbench/__init__.py @ @ -0,0 +1,8
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 0c5115d..d483139 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -59,9 +59,8 @ @ BENCHMARK ( BM_memcpy ) - > Range ( 8 , 8 < < 10 ) ; // measuring the speed of set insertion . static void BM_SetInsert ( benchmark : :State & state ) { while ( state.KeepRunning ( ) ) { - state.PauseTiming ( ) ; + // NOTE : Use a fixture to construct this before running the benchmark . set < int > data = ConstructRandomSet ( state.range_x ( ) ) ; - state.ResumeTiming ( ) ; for ( int j = 0 ; j < state.range_y ( ) ; ++j ) data.insert ( RandomNumber ( ) ) ; } @ @ -241,34 +240,6 @ @ public : return res ; } - // REQUIRES : timer is running - // Stop the benchmark timer . If not called , the timer will be - // automatically stopped after KeepRunning ( ) returns false for the first time . - // - // For threaded benchmarks the PauseTiming ( ) function acts - // like a barrier . I.e. , the ith call by a particular thread to
diff -- git a/AUTHORS b/AUTHORS index 5a4b355..cb36aee 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -28,3 +28,4 @ @ Yusuke Suzuki < utatane.tea @ gmail.com > Dirac Research Zbigniew Skowron < zbychs @ gmail.com > Dominik Czarnota < dominik.b.czarnota @ gmail.com > +Bjrn Gaier < bjoerngaier @ web.de > diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2c72252..16357a1 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -121,6 +121,20 @ @ find_package ( Threads REQUIRED ) # Set up directories include_directories ( $ { PROJECT_SOURCE_DIR } /include ) + # Set up pathes to javascript +set ( JQUERY_NAME `` jquery-2.2.1.min.js '' ) +set ( HIGHSTOCK_NAME `` highstock.js '' ) + +set ( JQUERY_PATH `` $ { PROJECT_SOURCE_DIR } /include/benchmark/ $ { JQUERY_NAME } '' ) +set ( HIGHSTOCK_PATH `` $ { PROJECT_SOURCE_DIR } /include/benchmark/ $ { HIGHSTOCK_NAME } '' ) + +configure_file ( $ { PROJECT_SOURCE_DIR } /include/benchmark/filePath.h.in $ { PROJECT_BINARY_DIR } /include/benchmark/filePath.h @ ONLY ) + +set ( JQUERY_PATH `` $ { CMAKE_INSTALL_PREFIX } /share/benchmark/ $ { JQUERY_NAME } '' ) +set ( HIGHSTOCK_PATH `` $ { CMAKE_INSTALL_PREFIX } /share/benchmark/ $ { HIGHSTOCK_NAME } '' ) + +configure_file ( $ { PROJECT_SOURCE_DIR } /include/benchmark/filePath.h.in $ { PROJECT_BINARY_DIR } /include/benchmark/filePath.h.install @ ONLY )
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 8cde61b..1e853e2 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -577,9 +577,17 @ @ class Benchmark { // Set the minimum amount of time to use when running this benchmark . This // option overrides the ` benchmark_min_time ` flag . - // REQUIRES : ` t > 0 ` + // REQUIRES : ` t > 0 ` and ` Iterations ` has not been called on this benchmark . Benchmark* MinTime ( double t ) ; + // Specify the amount of iterations that should be run by this benchmark . + // REQUIRES : 'n > 0 ' and ` MinTime ` has not been called on this benchmark . + // + // NOTE : This function should only be used when *exact* iteration control is + // needed and never to control or limit how long a benchmark runs , where + // ` -- benchmark_min_time=N ` or ` MinTime ( ... ) ` should be used instead . + Benchmark* Iterations ( size_t n ) ; + // Specify the amount of times to repeat this benchmark . This option overrides // the ` benchmark_repetitions ` flag . //
diff -- git a/src/benchmark_register.cc b/src/benchmark_register.cc index cf78bbf..7438a2b 100644 -- - a/src/benchmark_register.cc +++ b/src/benchmark_register.cc @ @ -31,6 +31,7 @ @ # include < fstream > # include < iostream > # include < memory > + # include < sstream > # include < thread > # include `` check.h '' @ @ -162,8 +163,8 @ @ bool BenchmarkFamilies : :FindBenchmarks ( StringPrintF ( `` % s : '' , family- > arg_names_ [ arg_i ] .c_str ( ) ) ; } } - - instance.name += std : :to_string ( arg ) ; + + instance.name += StringPrintF ( `` % d '' , arg ) ; ++arg_i ; } diff -- git a/src/colorprint.cc b/src/colorprint.cc index 513376b..2dec4a8 100644 -- - a/src/colorprint.cc +++ b/src/colorprint.cc @ @ -89,7 +89,7 @ @ std : :string FormatString ( const char* msg , va_list args ) { std : :size_t size = 256 ; char local_buff [ 256 ] ; - auto ret = std : :vsnprintf ( local_buff , size , msg , args_cp ) ; + auto ret = vsnprintf ( local_buff , size , msg , args_cp ) ; va_end ( args_cp ) ; @ @ -104,7 +104,7 @ @ std :
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 4755322..7f9a58f 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -707,6 +707,10 @ @ template < class Lambda > internal : :Benchmark* RegisterBenchmark ( const char* name , Lambda & & fn ) ; # endif +// Remove all registered benchmarks . All pointers to previously registered +// benchmarks are invalidated . +void ClearRegisteredBenchmarks ( ) ; + namespace internal { // The class used to hold all Benchmarks created from static function . // ( ie those created using the BENCHMARK ( ... ) macros . diff -- git a/src/benchmark_register.cc b/src/benchmark_register.cc index c95da98..ed70d82 100644 -- - a/src/benchmark_register.cc +++ b/src/benchmark_register.cc @ @ -70,6 +70,9 @ @ class BenchmarkFamilies { // Registers a benchmark family and returns the index assigned to it . size_t AddBenchmark ( std : :unique_ptr < Benchmark > family ) ; + // Clear all registered benchmark families . + void ClearBenchmarks ( ) ; + // Extract the list of benchmark instances that match the specified // regular expression . bool FindBenchmarks ( const std : :string & re , @ @ -95,6 +98,12 @ @ size_t BenchmarkFamilies : :AddBenchmark ( std : :unique_ptr < Benchmark > family ) { return
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..9f9ca91 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..9f9ca91 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..a3f6a1b 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -21,6 +21,10 @ @ matrix : - compiler : gcc env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc addons : apt : sources : @ @ -44,6 +48,17 @ @ matrix :
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..456b0a6 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,65 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..456b0a6 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,65 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/README.md b/README.md index 95326bd..9df94a3 100644 -- - a/README.md +++ b/README.md @ @ -206,6 +206,34 @ @ BENCHMARK_CAPTURE ( BM_takes_args , int_string_test , 42 , std : :string ( `` abc '' ) ) ; Note that elements of ` ... args ` may refer to global variables . Users should avoid modifying global state inside of a benchmark . + # # Using RegisterBenchmark ( name , fn , args ... ) + +The ` RegisterBenchmark ( name , func , args ... ) ` function provides an alternative +way to create and register benchmarks . + ` RegisterBenchmark ( name , func , args ... ) ` creates , registers , and returns a +pointer to a new benchmark with the specified ` name ` that invokes + ` func ( st , args ... ) ` where ` st ` is a ` benchmark : :State ` object . + +Unlike the ` BENCHMARK ` registration macros , which can only be used at the global +scope , the ` RegisterBenchmark ` can be called anywhere . This allows for +benchmark tests to be registered programmatically . + +Additionally ` RegisterBenchmark ` allows any callable
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 28baa58..754fb87 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -168,6 +168,9 @ @ class BenchmarkReporter ; void Initialize ( int* argc , char** argv ) ; +// Report to stdout all arguments in 'argv ' as unrecognized except the first . +void ReportUnrecognizedArguments ( int argc , char** argv ) ; + // Generate a list of benchmarks matching the specified -- benchmark_filter flag // and if -- benchmark_list_tests is specified return after printing the name // of each matching benchmark . Otherwise run each matching benchmark and @ @ -858,6 +861,10 @ @ class Fixture : public internal : :Benchmark { # define BENCHMARK_MAIN ( ) \ int main ( int argc , char** argv ) { \ : :benchmark : :Initialize ( & argc , argv ) ; \ + if ( argc > 1 ) { \ + : :benchmark : :ReportUnrecognizedArguments ( argc , argv ) ; \ + return 1 ; \ + } \ : :benchmark : :RunSpecifiedBenchmarks ( ) ; \ } diff -- git a/src/benchmark.cc b/src/benchmark.cc index 95f6a25..0374ec8 100644 -- - a/src/benchmark.cc +++ b/src/benchmark.cc @ @ -664,4 +664,10 @ @ void Initialize ( int* argc ,
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 4755322..7f9a58f 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -707,6 +707,10 @ @ template < class Lambda > internal : :Benchmark* RegisterBenchmark ( const char* name , Lambda & & fn ) ; # endif +// Remove all registered benchmarks . All pointers to previously registered +// benchmarks are invalidated . +void ClearRegisteredBenchmarks ( ) ; + namespace internal { // The class used to hold all Benchmarks created from static function . // ( ie those created using the BENCHMARK ( ... ) macros . diff -- git a/src/benchmark_register.cc b/src/benchmark_register.cc index c95da98..ed70d82 100644 -- - a/src/benchmark_register.cc +++ b/src/benchmark_register.cc @ @ -70,6 +70,9 @ @ class BenchmarkFamilies { // Registers a benchmark family and returns the index assigned to it . size_t AddBenchmark ( std : :unique_ptr < Benchmark > family ) ; + // Clear all registered benchmark families . + void ClearBenchmarks ( ) ; + // Extract the list of benchmark instances that match the specified // regular expression . bool FindBenchmarks ( const std : :string & re , @ @ -95,6 +98,12 @ @ size_t BenchmarkFamilies : :AddBenchmark ( std : :unique_ptr < Benchmark > family ) { return
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..35f594a 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..35f594a 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..a3f6a1b 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -21,6 +21,10 @ @ matrix : - compiler : gcc env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc addons : apt : sources : @ @ -44,6 +48,17 @ @ matrix :
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..a3f6a1b 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -21,6 +21,10 @ @ matrix : - compiler : gcc env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc addons : apt : sources : @ @ -44,6 +48,17 @ @ matrix :
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..35f594a 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index d529e4b..d8c1a71 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -642,10 +642,10 @ @ struct State : :StateIterator { State* const parent_ ; } ; -BENCHMARK_ALWAYS_INLINE inline State : :StateIterator State : :begin ( ) { +inline BENCHMARK_ALWAYS_INLINE State : :StateIterator State : :begin ( ) { return StateIterator ( this ) ; } -BENCHMARK_ALWAYS_INLINE inline State : :StateIterator State : :end ( ) { +inline BENCHMARK_ALWAYS_INLINE State : :StateIterator State : :end ( ) { StartKeepRunning ( ) ; return StateIterator ( ) ; }
diff -- git a/tests/gcp/app/cloudbuild.yaml b/tests/gcp/app/cloudbuild.yaml index 1e8f94f..f66db34 100644 -- - a/tests/gcp/app/cloudbuild.yaml +++ b/tests/gcp/app/cloudbuild.yaml @ @ -13,11 +13,13 @ @ # limitations under the License . steps : -- name : ' $ _VGO_IMAGE_NAME' - args : [ 'build ' ] +- name : 'golang:1.11' + args : [ 'go ' , 'build ' ] dir : 'tests/gcp/app' + - name : 'gcr.io/cloud-builders/docker' args : [ 'build ' , '-t ' , ' $ _IMAGE_NAME : $ BUILD_ID ' , ' . ' ] dir : 'tests/gcp/app' + images : - ' $ _IMAGE_NAME : $ BUILD_ID' diff -- git a/tests/gcp/test.sh b/tests/gcp/test.sh index 7238514..002a9c3 100755 -- - a/tests/gcp/test.sh +++ b/tests/gcp/test.sh @ @ -47,22 +47,14 @ @ cleanup2 ( ) { trap cleanup2 EXIT terraform apply -auto-approve -input=false -var project= '' $ project_id '' `` $ test_dir '' || exit 1 - # Add vgo container . -log `` Building application ... '' -vgo_image= '' gcr.io/ $ { project_id// : /\/ } /vgo '' -if ! GCLOUD container images describe -- format='value ( image_summary.digest ) ' `` $ vgo_image '' 1 > /dev/null 2 > /dev/null ; then - GCLOUD container builds submit \ - -t `` $ vgo_image '' \ -
diff -- git a/wire/cmd/wire/main.go b/wire/cmd/wire/main.go index e70a589..ab9a193 100644 -- - a/wire/cmd/wire/main.go +++ b/wire/cmd/wire/main.go @ @ -18,14 +18,12 @ @ package main import ( + '' context '' '' errors '' '' fmt '' - '' go/build '' '' go/token '' '' go/types '' - '' io/ioutil '' '' os '' - '' path/filepath '' '' reflect '' '' sort '' '' strconv '' @ @ -74,25 +72,17 @ @ func generate ( pkg string ) error { if err ! = nil { return err } - pkgInfo , err : = build.Default.Import ( pkg , wd , build.FindOnly ) - if err ! = nil { - return err - } - out , errs : = wire.Generate ( & build.Default , wd , pkg ) + out , errs : = wire.Generate ( context.Background ( ) , wd , os.Environ ( ) , pkg ) if len ( errs ) > 0 { logErrors ( errs ) return errors.New ( `` generate failed '' ) } - if len ( out ) == 0 { + if len ( out.Content ) == 0 { // No Wire directives , do n't write anything . fmt.Fprintln ( os.Stderr ,
diff -- git a/internal/pubsub/acks_test.go b/internal/pubsub/acks_test.go index 2d6d1d6..1333007 100644 -- - a/internal/pubsub/acks_test.go +++ b/internal/pubsub/acks_test.go @ @ -49,6 +49,8 @ @ func ( s *ackingDriverSub ) Close ( ) error { func ( s *ackingDriverSub ) IsRetryable ( error ) bool { return false } +func ( s *ackingDriverSub ) As ( i interface { } ) bool { return false } + func TestAckTriggersDriverSendAcksForOneMessage ( t *testing.T ) { ctx : = context.Background ( ) var mu sync.Mutex diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index a67dc09..726161f 100644 -- - a/internal/pubsub/driver/driver.go +++ b/internal/pubsub/driver/driver.go @ @ -77,6 +77,13 @ @ type Topic interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil error returned from SendBatch . IsRetryable ( err error ) bool + + // As allows providers to expose provider-specific types . + // + // See + // https : //github.com/google/go-cloud/blob/master/internal/docs/design.md # as + // for more background . + As ( i interface { } ) bool } // Subscription receives published messages . @ @ -116,4 +123,11 @ @ type Subscription interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil
diff -- git a/internal/pubsub/acks_test.go b/internal/pubsub/acks_test.go index 2d6d1d6..1333007 100644 -- - a/internal/pubsub/acks_test.go +++ b/internal/pubsub/acks_test.go @ @ -49,6 +49,8 @ @ func ( s *ackingDriverSub ) Close ( ) error { func ( s *ackingDriverSub ) IsRetryable ( error ) bool { return false } +func ( s *ackingDriverSub ) As ( i interface { } ) bool { return false } + func TestAckTriggersDriverSendAcksForOneMessage ( t *testing.T ) { ctx : = context.Background ( ) var mu sync.Mutex diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index a67dc09..726161f 100644 -- - a/internal/pubsub/driver/driver.go +++ b/internal/pubsub/driver/driver.go @ @ -77,6 +77,13 @ @ type Topic interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil error returned from SendBatch . IsRetryable ( err error ) bool + + // As allows providers to expose provider-specific types . + // + // See + // https : //github.com/google/go-cloud/blob/master/internal/docs/design.md # as + // for more background . + As ( i interface { } ) bool } // Subscription receives published messages . @ @ -116,4 +123,11 @ @ type Subscription interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil
diff -- git a/internal/pubsub/acks_test.go b/internal/pubsub/acks_test.go index 2d6d1d6..1333007 100644 -- - a/internal/pubsub/acks_test.go +++ b/internal/pubsub/acks_test.go @ @ -49,6 +49,8 @ @ func ( s *ackingDriverSub ) Close ( ) error { func ( s *ackingDriverSub ) IsRetryable ( error ) bool { return false } +func ( s *ackingDriverSub ) As ( i interface { } ) bool { return false } + func TestAckTriggersDriverSendAcksForOneMessage ( t *testing.T ) { ctx : = context.Background ( ) var mu sync.Mutex diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index a67dc09..726161f 100644 -- - a/internal/pubsub/driver/driver.go +++ b/internal/pubsub/driver/driver.go @ @ -77,6 +77,13 @ @ type Topic interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil error returned from SendBatch . IsRetryable ( err error ) bool + + // As allows providers to expose provider-specific types . + // + // See + // https : //github.com/google/go-cloud/blob/master/internal/docs/design.md # as + // for more background . + As ( i interface { } ) bool } // Subscription receives published messages . @ @ -116,4 +123,11 @ @ type Subscription interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil
diff -- git a/internal/pubsub/acks_test.go b/internal/pubsub/acks_test.go index 2d6d1d6..1333007 100644 -- - a/internal/pubsub/acks_test.go +++ b/internal/pubsub/acks_test.go @ @ -49,6 +49,8 @ @ func ( s *ackingDriverSub ) Close ( ) error { func ( s *ackingDriverSub ) IsRetryable ( error ) bool { return false } +func ( s *ackingDriverSub ) As ( i interface { } ) bool { return false } + func TestAckTriggersDriverSendAcksForOneMessage ( t *testing.T ) { ctx : = context.Background ( ) var mu sync.Mutex diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index a67dc09..726161f 100644 -- - a/internal/pubsub/driver/driver.go +++ b/internal/pubsub/driver/driver.go @ @ -77,6 +77,13 @ @ type Topic interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil error returned from SendBatch . IsRetryable ( err error ) bool + + // As allows providers to expose provider-specific types . + // + // See + // https : //github.com/google/go-cloud/blob/master/internal/docs/design.md # as + // for more background . + As ( i interface { } ) bool } // Subscription receives published messages . @ @ -116,4 +123,11 @ @ type Subscription interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil
diff -- git a/blob/driver/driver.go b/blob/driver/driver.go index b4a5e9f..d770385 100644 -- - a/blob/driver/driver.go +++ b/blob/driver/driver.go @ @ -165,6 +165,11 @ @ type ListObject struct { type ListPage struct { // Objects is the slice of objects found . If ListOptions.PageSize ! = 0 , // it should have at most ListOptions.PageSize entries . + // + // Objects should be returned in lexicographical order of UTF-8 encoded keys , + // including across pages . I.e. , all objects returned from a ListPage request + // made using a PageToken from a previous ListPage request 's NextPageToken + // should have Key > = the Key for all objects from the previous request . Objects [ ] *ListObject // NextPageToken should be left empty unless there are more objects // to return . The value may be returned as ListOptions.PageToken on a
diff -- git a/blob/drivertest/drivertest.go b/blob/drivertest/drivertest.go index 2ce076b..b469c05 100644 -- - a/blob/drivertest/drivertest.go +++ b/blob/drivertest/drivertest.go @ @ -156,6 +156,9 @ @ func RunConformanceTests ( t *testing.T , newHarness HarnessMaker , asTests [ ] AsTest t.Run ( `` TestDelete '' , func ( t *testing.T ) { testDelete ( t , newHarness ) } ) + t.Run ( `` TestKeys '' , func ( t *testing.T ) { + testKeys ( t , newHarness ) + } ) t.Run ( `` TestSignedURL '' , func ( t *testing.T ) { testSignedURL ( t , newHarness ) } ) @ @ -894,6 +897,85 @ @ func testDelete ( t *testing.T , newHarness HarnessMaker ) { } ) } +// testKeys tests a variety of weird keys . +func testKeys ( t *testing.T , newHarness HarnessMaker ) { + const keyPrefix = `` weird-keys '' + content : = [ ] byte ( `` hello '' ) + + tests : = [ ] struct { + description string + key string + } { + { + description : `` fwdslashes '' , + key : `` foo/bar/baz '' , + } , + { + description : `` backslashes '' , + key
diff -- git a/blob/blob.go b/blob/blob.go index 40a4305..2dd6145 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -172,11 +172,22 @ @ func ( w *Writer ) open ( p [ ] byte ) ( n int , err error ) { } // ListOptions sets options for listing objects . -// TODO ( Issue # 541 ) : Add Delimiter . type ListOptions struct { // Prefix indicates that only objects with a key starting with this prefix // should be returned . Prefix string + // Delimiter sets the delimiter used to define a hierarchical namespace , + // like a filesystem with `` directories '' . + // + // An empty delimiter means that the bucket is treated as a single flat + // namespace . + // + // A non-empty delimiter means that any result with the delimiter in its key + // after Prefix is stripped will be returned with ListObject.IsDir = true , + // ListObject.Key truncated after the delimiter , and zero values for fields + // other than Key . These results represent `` directories '' . Multiple results in + // a `` directory '' are returned as a single result .
diff -- git a/blob/blob.go b/blob/blob.go index cfb0cda..04c378d 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -172,11 +172,22 @ @ func ( w *Writer ) open ( p [ ] byte ) ( n int , err error ) { } // ListOptions sets options for listing objects . -// TODO ( Issue # 541 ) : Add Delimiter . type ListOptions struct { // Prefix indicates that only objects with a key starting with this prefix // should be returned . Prefix string + // Delimiter sets the delimiter used to define a hierarchical namespace , + // like a filesystem with `` directories '' . + // + // An empty delimiter means that the bucket is treated as a single flat + // namespace . + // + // A non-empty delimiter means that any result with the delimiter in its key + // after Prefix is stripped will be returned with ListObject.IsDir = true , + // ListObject.Key truncated after the delimiter , and zero values for fields + // other than Key . These results represent `` directories '' . Multiple results in + // a `` directory '' are returned as a single result .
diff -- git a/blob/blob_test.go b/blob/blob_test.go deleted file mode 100644 index 34201cf..0000000 -- - a/blob/blob_test.go +++ /dev/null @ @ -1,217 +0,0 @ @ -// Copyright 2018 The Go Cloud Authors -// -// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; -// you may not use this file except in compliance with the License . -// You may obtain a copy of the License at -// -// https : //www.apache.org/licenses/LICENSE-2.0 -// -// Unless required by applicable law or agreed to in writing , software -// distributed under the License is distributed on an `` AS IS '' BASIS , -// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . -// See the License for the specific language governing permissions and -// limitations under the License . - -package blob - -import ( - '' context '' - '' io/ioutil '' - '' path/filepath '' - '' testing '' - - '' github.com/google/go-cloud/blob/driver '' - ) - -func TestNewRangeReader ( t *testing.T ) { - t.Run ( `` EntireBlob '' , func ( t *testing.T ) { - const key = `` foo '' - spy : = new ( bucketSpy )
diff -- git a/blob/blob_test.go b/blob/blob_test.go deleted file mode 100644 index 34201cf..0000000 -- - a/blob/blob_test.go +++ /dev/null @ @ -1,217 +0,0 @ @ -// Copyright 2018 The Go Cloud Authors -// -// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; -// you may not use this file except in compliance with the License . -// You may obtain a copy of the License at -// -// https : //www.apache.org/licenses/LICENSE-2.0 -// -// Unless required by applicable law or agreed to in writing , software -// distributed under the License is distributed on an `` AS IS '' BASIS , -// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . -// See the License for the specific language governing permissions and -// limitations under the License . - -package blob - -import ( - '' context '' - '' io/ioutil '' - '' path/filepath '' - '' testing '' - - '' github.com/google/go-cloud/blob/driver '' - ) - -func TestNewRangeReader ( t *testing.T ) { - t.Run ( `` EntireBlob '' , func ( t *testing.T ) { - const key = `` foo '' - spy : = new ( bucketSpy )
diff -- git a/aws/aws.go b/aws/aws.go index 1854b59..379f031 100644 -- - a/aws/aws.go +++ b/aws/aws.go @ @ -20,7 +20,7 @ @ import ( '' github.com/aws/aws-sdk-go/aws/client '' '' github.com/aws/aws-sdk-go/aws/credentials '' '' github.com/aws/aws-sdk-go/aws/session '' - '' github.com/google/go-cloud/wire '' + '' github.com/google/wire '' ) // DefaultSession is a Wire provider set that provides a *session.Session using diff -- git a/aws/awscloud/awscloud.go b/aws/awscloud/awscloud.go index 023cd77..e4bdc6b 100644 -- - a/aws/awscloud/awscloud.go +++ b/aws/awscloud/awscloud.go @ @ -22,7 +22,7 @ @ import ( '' github.com/google/go-cloud/aws/rds '' '' github.com/google/go-cloud/runtimevar/paramstore '' '' github.com/google/go-cloud/server/xrayserver '' - '' github.com/google/go-cloud/wire '' + '' github.com/google/wire '' ) // AWS is a Wire provider set that includes all Amazon Web Services interface diff -- git a/aws/awscloud/example_test.go b/aws/awscloud/example_test.go index a4bbbf9..1c136fb 100644 -- - a/aws/awscloud/example_test.go +++ b/aws/awscloud/example_test.go @ @ -23,7 +23,7 @ @ import ( '' github.com/google/go-cloud/aws/awscloud '' '' github.com/google/go-cloud/health '' '' github.com/google/go-cloud/server '' - '' github.com/google/go-cloud/wire '' + '' github.com/google/wire '' '' go.opencensus.io/trace '' ) diff -- git a/aws/rds/rds.go b/aws/rds/rds.go index bd0f941..d8fb383 100644 -- - a/aws/rds/rds.go +++ b/aws/rds/rds.go @ @ -24,7 +24,7 @ @ import ( '' io/ioutil '' '' net/http '' - '' github.com/google/go-cloud/wire '' + '' github.com/google/wire '' '' golang.org/x/net/context/ctxhttp '' ) diff -- git a/gcp/cloudsql/cloudsql.go b/gcp/cloudsql/cloudsql.go index 42be5cd..06632ae 100644 -- - a/gcp/cloudsql/cloudsql.go +++ b/gcp/cloudsql/cloudsql.go @ @
diff -- git a/samples/guestbook/aws/provision-db.sh b/samples/guestbook/aws/provision-db.sh index e7a0036..8f1b2c9 100755 -- - a/samples/guestbook/aws/provision-db.sh +++ b/samples/guestbook/aws/provision-db.sh @ @ -39,8 +39,10 @ @ log ( ) { log `` Downloading Docker images ... '' docker pull `` $ mysql_image '' || exit 1 - # Create a temporary directory to hold the service account key . -tempdir= '' $ ( mktemp -d 2 > /dev/null || mktemp -d -t 'guestbook-service-acct ' ) '' || exit 1 + # Create a temporary directory to hold the certificates . + # We resolve all symlinks to avoid Docker on Mac issues , see + # https : //github.com/google/go-cloud/issues/110 . +tempdir= '' $ ( cd `` $ ( mktemp -d 2 > /dev/null || mktemp -d -t 'guestbook-ca ' ) '' & & pwd -P ) '' || exit 1 cleanup1 ( ) { rm -rf `` $ tempdir '' } diff -- git a/samples/guestbook/gcp/provision-db.sh b/samples/guestbook/gcp/provision-db.sh index 929800e..e5ddab9 100755 -- - a/samples/guestbook/gcp/provision-db.sh +++ b/samples/guestbook/gcp/provision-db.sh @ @ -47,7 +47,9 @ @ log `` Getting database metadata ... '' db_conn_str= '' $ ( GCLOUD sql instances describe -- format='value ( connectionName ) ' `` $ db_instance '' ) '' || exit 1 # Create a temporary directory to hold
diff -- git a/samples/guestbook/gcp/main.tf b/samples/guestbook/gcp/main.tf index d879460..75c1c11 100644 -- - a/samples/guestbook/gcp/main.tf +++ b/samples/guestbook/gcp/main.tf @ @ -21,7 +21,15 @ @ provider `` random '' { version = `` ~ > 1.3 '' } - # TODO ( light ) : Add cloudbuild.googleapis.com resource . +locals { + service_count = `` $ { var.project_services ? 1 : 0 } '' + } + +resource `` google_project_service '' `` cloudbuild '' { + count = `` $ { local.service_count } '' + service = `` cloudbuild.googleapis.com '' + disable_on_destroy = false + } # Service account for the running server @ @ -36,7 +44,11 @ @ resource `` google_service_account_key '' `` server '' { # Stackdriver Tracing - # TODO ( light ) : Add cloudtrace.googleapis.com resource . +resource `` google_project_service '' `` trace '' { + count = `` $ { local.service_count } '' + service = `` cloudtrace.googleapis.com '' + disable_on_destroy = false + } resource `` google_project_iam_member '' `` server_trace '' { role = `` roles/cloudtrace.agent '' @ @ -46,11 +58,16 @ @ resource `` google_project_iam_member '' `` server_trace '' { # Cloud SQL resource `` google_project_service '' `` sql '' { + count = `` $ { local.service_count }
diff -- git a/internal/contributebot/process.go b/internal/contributebot/process.go index 68348d5..5a59d95 100644 -- - a/internal/contributebot/process.go +++ b/internal/contributebot/process.go @ @ -32,7 +32,7 @ @ const ( ) var ( - issueTitleRegexp = regexp.MustCompile ( ` ^ [ a-z0-9./- ] + : . * $ ` ) + issueTitleRegexp = regexp.MustCompile ( ` ^ ( [ a-z0-9./- ] +| [ A-Z_ ] + ) : . * $ ` ) pullRequestTitleRegexp = issueTitleRegexp )
diff -- git a/internal/pubsub/gcppubsub/gcppubsub.go b/internal/pubsub/gcppubsub/gcppubsub.go new file mode 100644 index 0000000..b0ed963 -- - /dev/null +++ b/internal/pubsub/gcppubsub/gcppubsub.go @ @ -0,0 +1,122 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package gcppubsub provides an implementation of pubsub that uses GCP +// PubSub . +package gcppubsub + +import ( + '' context '' + '' fmt '' + + raw `` cloud.google.com/go/pubsub/apiv1 '' + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + pb `` google.golang.org/genproto/googleapis/pubsub/v1 '' + ) + +type topic struct { + path string + client *raw.PublisherClient + } + +// Close
diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index 5418eae..d2931b4 100644 -- - a/internal/pubsub/driver/driver.go +++ b/internal/pubsub/driver/driver.go @ @ -74,9 +74,15 @ @ type Topic interface { // Subscription receives published messages . type Subscription interface { // ReceiveBatch should return a batch of messages that have queued up - // for the subscription on the server . If no messages are available - // yet , it must block until there is at least one , or the context is - // done . + // for the subscription on the server . + // + // If there is a transient failure , this method should not retry but + // should return a nil slice and an error . The concrete API will take + // care of retry logic . + // + // If the service returns no messages for some other reason , this + // method should return the empty slice of messages and not attempt to + // retry . // // ReceiveBatch is only called sequentially for individual // Subscriptions . diff -- git a/internal/pubsub/gcppubsub/gcppubsub.go b/internal/pubsub/gcppubsub/gcppubsub.go new file mode 100644 index 0000000..8250ec1 -- - /dev/null +++ b/internal/pubsub/gcppubsub/gcppubsub.go @ @ -0,0 +1,132 @ @ +// Copyright
diff -- git a/internal/docs/pubsub/design.md b/internal/docs/pubsub/design.md index d55764e..50b80de 100644 -- - a/internal/docs/pubsub/design.md +++ b/internal/docs/pubsub/design.md @ @ -319,8 +319,19 @ @ type Topic interface { // Subscription receives published messages . type Subscription interface { - // ReceiveBatch returns a batch of messages that have queued up for the - // subscription on the server . + // ReceiveBatch should return a batch of messages that have queued up + // for the subscription on the server . + // + // If there is a transient failure , this method should not retry but + // should return a nil slice and an error . The concrete API will take + // care of retry logic . + // + // If the service returns no messages for some other reason , this + // method should return the empty slice of messages and not attempt to + // retry . + // + // ReceiveBatch is only called sequentially for individual + // Subscriptions . ReceiveBatch ( ctx context.Context ) ( [ ] *Message , error ) // SendAcks acknowledges the messages with the given ackIDs on the diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index 5418eae..d2931b4 100644 -- - a/internal/pubsub/driver/driver.go +++
diff -- git a/internal/docs/pubsub/design.md b/internal/docs/pubsub/design.md index 7c768e4..3fad6e9 100644 -- - a/internal/docs/pubsub/design.md +++ b/internal/docs/pubsub/design.md @ @ -319,8 +319,19 @ @ type Topic interface { // Subscription receives published messages . type Subscription interface { - // ReceiveBatch returns a batch of messages that have queued up for the - // subscription on the server . + // ReceiveBatch should return a batch of messages that have queued up + // for the subscription on the server . + // + // If there is a transient failure , this method should not retry but + // should return a nil slice and an error . The concrete API will take + // care of retry logic . + // + // If the service returns no messages for some other reason , this + // method should return the empty slice of messages and not attempt to + // retry . + // + // ReceiveBatch is only called sequentially for individual + // Subscriptions . ReceiveBatch ( ctx context.Context ) ( [ ] *Message , error ) // SendAcks acknowledges the messages with the given ackIDs on the diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index 5418eae..4ca255c 100644 -- - a/internal/pubsub/driver/driver.go +++
diff -- git a/internal/docs/pubsub/design.md b/internal/docs/pubsub/design.md index 7c768e4..3fad6e9 100644 -- - a/internal/docs/pubsub/design.md +++ b/internal/docs/pubsub/design.md @ @ -319,8 +319,19 @ @ type Topic interface { // Subscription receives published messages . type Subscription interface { - // ReceiveBatch returns a batch of messages that have queued up for the - // subscription on the server . + // ReceiveBatch should return a batch of messages that have queued up + // for the subscription on the server . + // + // If there is a transient failure , this method should not retry but + // should return a nil slice and an error . The concrete API will take + // care of retry logic . + // + // If the service returns no messages for some other reason , this + // method should return the empty slice of messages and not attempt to + // retry . + // + // ReceiveBatch is only called sequentially for individual + // Subscriptions . ReceiveBatch ( ctx context.Context ) ( [ ] *Message , error ) // SendAcks acknowledges the messages with the given ackIDs on the diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index 5418eae..4ca255c 100644 -- - a/internal/pubsub/driver/driver.go +++
diff -- git a/blob/blob.go b/blob/blob.go index fc4a7e3..3121589 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -154,6 +154,85 @ @ func ( w *Writer ) open ( p [ ] byte ) ( n int , err error ) { return w.w.Write ( p ) } +// MaxPageSize is the maximum number of results to retrieve at a time via ListPaged . +const MaxPageSize = 1000 + +// ListOptions sets options for listing objects . +// TODO ( Issue # 541 ) : Add Delimiter . +type ListOptions struct { + // Prefix indicates that only objects with a key starting with this prefix + // should be returned . + Prefix string + + // PageSize sets the maximum number of objects that will be returned in + // a single call to ListPaged . For List , it sets the internal buffer size . + // Must be > = 0 and < = MaxPageSize ; 0 defaults to MaxPageSize . + PageSize int + // PageToken should be filled in with the NextPageToken from a previous + // ListPaged call , to get the next page of results . + // Ignored when using List . + PageToken
diff -- git a/blob/blob.go b/blob/blob.go index 8000404..885943d 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -185,6 +185,12 @ @ type ListOptions struct { // at a time from the provider . // Must be > = 0 and < = MaxPageSize ; 0 defaults to MaxPageSize . PageSize int + + // BeforeList is a callback that will be called before each call to the + // the underlying provider 's list functionality . + // asFunc converts its argument to provider-specific types . + // See Bucket.As for more details . + BeforeList func ( asFunc func ( interface { } ) bool ) error } // ListIterator is used to iterate over List results . @ @ -208,6 +214,7 @ @ func ( i *ListIterator ) Next ( ctx context.Context ) ( *ListObject , error ) { Key : dobj.Key , ModTime : dobj.ModTime , Size : dobj.Size , + asFunc : dobj.AsFunc , } , nil } if len ( i.page.NextPageToken ) == 0 { @ @ -235,6 +242,17 @ @ type ListObject struct { ModTime time.Time // Size is the size of the object in bytes . Size int64 + + asFunc func ( interface {
diff -- git a/blob/gcsblob/gcsblob.go b/blob/gcsblob/gcsblob.go index 6204b28..ae71183 100644 -- - a/blob/gcsblob/gcsblob.go +++ b/blob/gcsblob/gcsblob.go @ @ -18,10 +18,7 @ @ package gcsblob import ( '' context '' - '' errors '' '' fmt '' - '' regexp '' - '' unicode/utf8 '' '' github.com/google/go-cloud/blob '' '' github.com/google/go-cloud/blob/driver '' @ @ -34,9 +31,6 @ @ import ( // OpenBucket returns a GCS Bucket that communicates using the given HTTP client . func OpenBucket ( ctx context.Context , bucketName string , client *gcp.HTTPClient ) ( *blob.Bucket , error ) { - if err : = validateBucketChar ( bucketName ) ; err ! = nil { - return nil , err - } if client == nil { return nil , fmt.Errorf ( `` NewBucket requires an HTTP client to communicate using '' ) } @ @ -89,9 +83,6 @ @ func ( b *bucket ) NewRangeReader ( ctx context.Context , key string , offset , length // // The caller must call Close on the returned Writer when done writing . func ( b *bucket ) NewTypedWriter ( ctx context.Context , key string , contentType string , opts *driver.WriterOptions ) ( driver.Writer , error ) { - if err : = validateObjectChar (
diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md index 0a46da3..af5017c 100644 -- - a/samples/guestbook/README.md +++ b/samples/guestbook/README.md @ @ -3,7 +3,8 @ @ Guestbook is a sample application that records visitors ' messages , displays a cloud banner , and an administrative message . The main business logic is written in a cloud-agnostic manner using MySQL , the generic blob API , and the -generic runtimevar API . All platform-specific code is set up by Wire . +generic runtimevar API . All platform-specific code is set up by + [ Wire ] ( https : //github.com/google/go-x-cloud/tree/master/wire ) . # # Prerequisites @ @ -12,7 +13,7 @ @ You will need to install the following software to run this sample : - [ Go ] ( https : //golang.org/doc/install ) and [ vgo ] ( https : //go.googlesource.com/vgo ) - [ Docker ] ( https : //docs.docker.com/install/ ) -- [ Terraform ] ( https : //www.terraform.io/intro/getting-started/install.html ) +- [ Terraform ] [ TF ] - [ jq ] ( https : //stedolan.github.io/jq/download/ ) - [ gcloud CLI ] ( https : //cloud.google.com/sdk/downloads ) , if you want to use GCP - [ aws CLI ] ( https : //docs.aws.amazon.com/cli/latest/userguide/installing.html ) , @ @ -60,7 +61,7
diff -- git a/go.mod b/go.mod index 93fdeb0..3cbcde8 100644 -- - a/go.mod +++ b/go.mod @ @ -38,7 +38,7 @ @ require ( github.com/google/btree v0.0.0-20180813153112-4030bb1f1f0c // indirect github.com/google/go-cmp v0.2.0 github.com/google/martian v2.1.0+incompatible // indirect - github.com/google/wire v0.1.0 + github.com/google/wire v0.2.0 github.com/googleapis/gax-go v2.0.0+incompatible github.com/gopherjs/gopherjs v0.0.0-20181017120253-0766667cb4d1 // indirect github.com/gorilla/context v1.1.1 // indirect diff -- git a/go.sum b/go.sum index c66507e..d5be0c3 100644 -- - a/go.sum +++ b/go.sum @ @ -59,6 +59,8 @ @ github.com/google/martian v2.1.0+incompatible h1 : /CP5g8u/VJHijgedC/Legn3BAbAaWPg github.com/google/martian v2.1.0+incompatible/go.mod h1:9I4somxYTbIHy5NJKHRl3wXiIaQGbYVAs8BPL6v8lEs= github.com/google/wire v0.1.0 h1 : PFFNZLhKJLKe9DHooJzYCxZogNJDIYuB8KfmJmsi/Mk= github.com/google/wire v0.1.0/go.mod h1 : ptBl5bWD3nzmJHVNwYHV3v4wdtKzBMlU2YbtKQCG9GI= +github.com/google/wire v0.2.0 h1 : l8O+yxT6Kx49nR2KzotgPOQpHFcIvpDY0rGzlCZ1wIE= +github.com/google/wire v0.2.0/go.mod h1 : ptBl5bWD3nzmJHVNwYHV3v4wdtKzBMlU2YbtKQCG9GI= github.com/googleapis/gax-go v2.0.0+incompatible h1 : j0GKcs05QVmm7yesiZq2+9cxHkNK9YM6zKx4D2qucQU= github.com/googleapis/gax-go v2.0.0+incompatible/go.mod h1 : SFVmujtThgffbyetf+mdk2eWhX2bMyUtNHzFKcPA9HY= github.com/gopherjs/gopherjs v0.0.0-20181017120253-0766667cb4d1 h1 : EGx4pi6eqNxGaHF6qqu48+N2wcFQ5qg5FXgOdqsJ5d8= diff -- git a/internal/contributebot/go.sum b/internal/contributebot/go.sum index 356bbdc..d5ff82b 100644 -- - a/internal/contributebot/go.sum +++ b/internal/contributebot/go.sum @ @ -43,6 +43,7 @ @ github.com/google/go-querystring v1.0.0/go.mod h1 : odCYkC5MyYFN7vkCjXpyrEuKhc/BUO github.com/google/martian v2.1.0+incompatible/go.mod h1:9I4somxYTbIHy5NJKHRl3wXiIaQGbYVAs8BPL6v8lEs= github.com/google/wire v0.1.0 h1 : PFFNZLhKJLKe9DHooJzYCxZogNJDIYuB8KfmJmsi/Mk= github.com/google/wire v0.1.0/go.mod h1 : ptBl5bWD3nzmJHVNwYHV3v4wdtKzBMlU2YbtKQCG9GI= +github.com/google/wire v0.2.0/go.mod h1 : ptBl5bWD3nzmJHVNwYHV3v4wdtKzBMlU2YbtKQCG9GI= github.com/googleapis/gax-go v2.0.0+incompatible h1 : j0GKcs05QVmm7yesiZq2+9cxHkNK9YM6zKx4D2qucQU= github.com/googleapis/gax-go v2.0.0+incompatible/go.mod h1 : SFVmujtThgffbyetf+mdk2eWhX2bMyUtNHzFKcPA9HY= github.com/gopherjs/gopherjs v0.0.0-20181017120253-0766667cb4d1/go.mod h1 : wJfORRmW1u3UXTncJ5qlYoELFm8eSnnEO6hX4iZ3EWY= diff -- git a/internal/testing/runchecks.sh b/internal/testing/runchecks.sh index 138060c..c645724 100755 -- - a/internal/testing/runchecks.sh +++ b/internal/testing/runchecks.sh @ @ -40,11 +40,12 @ @ if [ [ `` $ TRAVIS_OS_NAME '' == `` linux '' ] ] ; then
diff -- git a/samples/guestbook/gcp/main.tf b/samples/guestbook/gcp/main.tf index 75c1c11..b255f94 100644 -- - a/samples/guestbook/gcp/main.tf +++ b/samples/guestbook/gcp/main.tf @ @ -35,6 +35,7 @ @ resource `` google_project_service '' `` cloudbuild '' { resource `` google_service_account '' `` server '' { account_id = `` $ { var.server_service_account_name } '' + project = `` $ { var.project } '' display_name = `` Guestbook Server '' } @ @ -73,6 +74,7 @ @ resource `` google_sql_database_instance '' `` guestbook '' { name = `` $ { var.db_instance } '' database_version = `` MYSQL_5_6 '' region = `` $ { var.region } '' + project = `` $ { var.project } '' settings { tier = `` db-f1-micro '' @ @ -120,6 +122,7 @ @ resource `` google_sql_user '' `` guestbook '' { resource `` google_service_account '' `` db_access '' { account_id = `` $ { var.db_access_service_account_name } '' + project = `` $ { var.project } '' display_name = `` Guestbook Database Access '' } @ @ -142,15 +145,17 @ @ resource `` google_project_service '' `` runtimeconfig '' { } resource `` google_runtimeconfig_config '' `` guestbook '' { - name = `` guestbook '' + name = `` guestbook '' + project = `` $ { var.project }
diff -- git a/blob/gcsblob/testdata/TestConformance/TestAttributes/ReadLength=-1/ModTime.yaml b/blob/gcsblob/testdata/TestConformance/TestAttributes/ReadLength=-1/ModTime.yaml index d5dc895..4d7bcfc 100644 -- - a/blob/gcsblob/testdata/TestConformance/TestAttributes/ReadLength=-1/ModTime.yaml +++ b/blob/gcsblob/testdata/TestConformance/TestAttributes/ReadLength=-1/ModTime.yaml @ @ -238,255 +238,6 @ @ interactions : code : 200 duration : `` '' - request : - body : `` -- e26b80c8bc13287d493059fe1b021266920a5523aa34140213a80bcad1bd\r\nContent-Type : - application/json\r\n\r\n { \ '' bucket\ '' : \ '' pledged-solved-practically\ '' , \ '' contentType\ '' : \ '' text/plain ; - charset=utf-8\ '' , \ '' name\ '' : \ '' blob-for-attributes\ '' } \n\r\n -- e26b80c8bc13287d493059fe1b021266920a5523aa34140213a80bcad1bd\r\nContent-Type : - text/plain ; charset=utf-8\r\n\r\nHello World ! \r\n -- e26b80c8bc13287d493059fe1b021266920a5523aa34140213a80bcad1bd -- \r\n '' - form : { } - headers : - Content-Type : - - multipart/related ; boundary=e26b80c8bc13287d493059fe1b021266920a5523aa34140213a80bcad1bd - User-Agent : - - google-api-go-client/0.5 - X-Goog-Api-Client : - - gl-go/b8669ef1ce gccl/20180226 - url : https : //www.googleapis.com/upload/storage/v1/b/pledged-solved-practically/o ? alt=json & projection=full & uploadType=multipart - method : POST - response : - body : | - { - `` error '' : { - `` errors '' : [ - { - `` domain '' : `` usageLimits '' , - `` reason '' : `` rateLimitExceeded '' , - `` message '' : `` The total number of changes to the object pledged-solved-practically/blob-for-attributes exceeds the rate limit . Please reduce the rate
diff -- git a/internal/pubsub/acks_test.go b/internal/pubsub/acks_test.go index 2d6d1d6..93c7f46 100644 -- - a/internal/pubsub/acks_test.go +++ b/internal/pubsub/acks_test.go @ @ -18,6 +18,7 @ @ import ( '' math/rand '' '' sync '' '' testing '' + '' time '' '' github.com/google/go-cloud/internal/pubsub '' '' github.com/google/go-cloud/internal/pubsub/driver '' @ @ -43,10 +44,6 @ @ func ( s *ackingDriverSub ) SendAcks ( ctx context.Context , ackIDs [ ] driver.AckID ) e return s.sendAcks ( ctx , ackIDs ) } -func ( s *ackingDriverSub ) Close ( ) error { - return nil - } - func ( s *ackingDriverSub ) IsRetryable ( error ) bool { return false } func TestAckTriggersDriverSendAcksForOneMessage ( t *testing.T ) { @ @ -67,7 +64,7 @ @ func TestAckTriggersDriverSendAcksForOneMessage ( t *testing.T ) { } , } sub : = pubsub.NewSubscription ( ds ) - defer sub.Close ( ) + defer sub.Shutdown ( ctx ) m2 , err : = sub.Receive ( ctx ) if err ! = nil { t.Fatal ( err ) @ @ -101,7 +98,7 @ @ func TestMultipleAcksCanGoIntoASingleBatch ( t *testing.T ) { } , } sub : = pubsub.NewSubscription ( ds ) - defer sub.Close ( ) + defer sub.Shutdown ( ctx ) // Receive and ack the messages
diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md index 3c1d0b3..c023e41 100644 -- - a/samples/guestbook/README.md +++ b/samples/guestbook/README.md @ @ -79,7 +79,7 @ @ terraform init # and desired zone . terraform apply -./deploy.sh +go run ./deploy `` ` The deploy script will display the URL of your running service . diff -- git a/samples/guestbook/gcp/deploy.sh b/samples/guestbook/gcp/deploy.sh deleted file mode 100755 index e4ac35c..0000000 -- - a/samples/guestbook/gcp/deploy.sh +++ /dev/null @ @ -1,83 +0,0 @ @ - # ! /bin/bash - # Copyright 2018 Google LLC - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - # you may not use this file except in compliance with the License . - # You may obtain a copy of the License at - # - # https : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software - # distributed under the License is distributed on an `` AS IS '' BASIS , - # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . - # See the License for the specific language governing permissions and - # limitations under the License . - - # deploy.sh
diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md index 3c1d0b3..53dbbb4 100644 -- - a/samples/guestbook/README.md +++ b/samples/guestbook/README.md @ @ -79,7 +79,7 @ @ terraform init # and desired zone . terraform apply -./deploy.sh +go run ./deploy/main.go `` ` The deploy script will display the URL of your running service . diff -- git a/samples/guestbook/aws/main.tf b/samples/guestbook/aws/main.tf index 259b272..ff8d402 100644 -- - a/samples/guestbook/aws/main.tf +++ b/samples/guestbook/aws/main.tf @ @ -82,7 +82,7 @ @ resource `` aws_db_instance '' `` guestbook '' { provisioner `` local-exec '' { # TODO ( light ) : Reuse credentials from Terraform . - command = `` cat ' $ { path.module } '/../schema.sql ' $ { path.module } '/../roles.sql | AWS_DEFAULT_REGION= ' $ { var.region } ' ' $ { path.module } '/provision-db.sh ' $ { aws_db_instance.guestbook.address } ' ' $ { aws_security_group.guestbook.id } ' guestbook ' $ { random_string.db_password.result } ' '' + command = `` cat ' $ { path.module } '/../schema.sql ' $ { path.module } '/../roles.sql | AWS_DEFAULT_REGION= ' $ { var.region } ' 'go run $ { path.module } '/provision_db/main.go ' $ { aws_db_instance.guestbook.address } ' ' $ { aws_security_group.guestbook.id } ' guestbook ' $ { random_string.db_password.result } ' '' } } diff -- git a/samples/guestbook/aws/provision-db.sh b/samples/guestbook/aws/provision-db.sh deleted
diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md index 3c1d0b3..53dbbb4 100644 -- - a/samples/guestbook/README.md +++ b/samples/guestbook/README.md @ @ -79,7 +79,7 @ @ terraform init # and desired zone . terraform apply -./deploy.sh +go run ./deploy/main.go `` ` The deploy script will display the URL of your running service . diff -- git a/samples/guestbook/aws/main.tf b/samples/guestbook/aws/main.tf index 259b272..ff8d402 100644 -- - a/samples/guestbook/aws/main.tf +++ b/samples/guestbook/aws/main.tf @ @ -82,7 +82,7 @ @ resource `` aws_db_instance '' `` guestbook '' { provisioner `` local-exec '' { # TODO ( light ) : Reuse credentials from Terraform . - command = `` cat ' $ { path.module } '/../schema.sql ' $ { path.module } '/../roles.sql | AWS_DEFAULT_REGION= ' $ { var.region } ' ' $ { path.module } '/provision-db.sh ' $ { aws_db_instance.guestbook.address } ' ' $ { aws_security_group.guestbook.id } ' guestbook ' $ { random_string.db_password.result } ' '' + command = `` cat ' $ { path.module } '/../schema.sql ' $ { path.module } '/../roles.sql | AWS_DEFAULT_REGION= ' $ { var.region } ' 'go run $ { path.module } '/provision_db/main.go ' $ { aws_db_instance.guestbook.address } ' ' $ { aws_security_group.guestbook.id } ' guestbook ' $ { random_string.db_password.result } ' '' } } diff -- git a/samples/guestbook/aws/provision-db.sh b/samples/guestbook/aws/provision-db.sh deleted
diff -- git a/go.mod b/go.mod index e7805bf..496f2fa 100644 -- - a/go.mod +++ b/go.mod @ @ -14,7 +14,7 @ @ module github.com/google/go-cloud -replace cloud.google.com/go = > cloud.google.com/go v0.0.0-20180608230132-da2b80561ef3 +replace cloud.google.com/go v0.25.0 = > cloud.google.com/go v0.0.0-20180608230132-da2b80561ef3 require ( cloud.google.com/go v0.25.0 diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md index 3c1d0b3..53dbbb4 100644 -- - a/samples/guestbook/README.md +++ b/samples/guestbook/README.md @ @ -79,7 +79,7 @ @ terraform init # and desired zone . terraform apply -./deploy.sh +go run ./deploy/main.go `` ` The deploy script will display the URL of your running service . diff -- git a/samples/guestbook/aws/main.tf b/samples/guestbook/aws/main.tf index 259b272..ff8d402 100644 -- - a/samples/guestbook/aws/main.tf +++ b/samples/guestbook/aws/main.tf @ @ -82,7 +82,7 @ @ resource `` aws_db_instance '' `` guestbook '' { provisioner `` local-exec '' { # TODO ( light ) : Reuse credentials from Terraform . - command = `` cat ' $ { path.module } '/../schema.sql ' $ { path.module } '/../roles.sql | AWS_DEFAULT_REGION= ' $ { var.region } ' ' $ { path.module } '/provision-db.sh ' $ { aws_db_instance.guestbook.address } ' ' $ { aws_security_group.guestbook.id } ' guestbook ' $ { random_string.db_password.result } ' '' + command = `` cat ' $ { path.module } '/../schema.sql ' $ { path.module } '/../roles.sql | AWS_DEFAULT_REGION= ' $ {
diff -- git a/go.mod b/go.mod index 89daba2..7dc4b4f 100644 -- - a/go.mod +++ b/go.mod @ @ -14,7 +14,7 @ @ module github.com/google/go-cloud -replace cloud.google.com/go = > cloud.google.com/go v0.0.0-20180608230132-da2b80561ef3 +replace cloud.google.com/go v0.25.0 = > cloud.google.com/go v0.0.0-20180608230132-da2b80561ef3 require ( cloud.google.com/go v0.25.0 diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md index 3c1d0b3..53dbbb4 100644 -- - a/samples/guestbook/README.md +++ b/samples/guestbook/README.md @ @ -79,7 +79,7 @ @ terraform init # and desired zone . terraform apply -./deploy.sh +go run ./deploy/main.go `` ` The deploy script will display the URL of your running service . diff -- git a/samples/guestbook/aws/main.tf b/samples/guestbook/aws/main.tf index 5962cf0..f48ef7d 100644 -- - a/samples/guestbook/aws/main.tf +++ b/samples/guestbook/aws/main.tf @ @ -82,7 +82,7 @ @ resource `` aws_db_instance '' `` guestbook '' { provisioner `` local-exec '' { # TODO ( light ) : Reuse credentials from Terraform . - command = `` cat ' $ { path.module } '/../schema.sql ' $ { path.module } '/../roles.sql | AWS_DEFAULT_REGION= ' $ { var.region } ' ' $ { path.module } '/provision-db.sh ' $ { aws_db_instance.guestbook.address } ' ' $ { aws_security_group.guestbook.id } ' guestbook ' $ { random_string.db_password.result } ' '' + command = `` cat ' $ { path.module } '/../schema.sql ' $ { path.module } '/../roles.sql | AWS_DEFAULT_REGION= ' $ {
diff -- git a/go.mod b/go.mod index 89daba2..7dc4b4f 100644 -- - a/go.mod +++ b/go.mod @ @ -14,7 +14,7 @ @ module github.com/google/go-cloud -replace cloud.google.com/go = > cloud.google.com/go v0.0.0-20180608230132-da2b80561ef3 +replace cloud.google.com/go v0.25.0 = > cloud.google.com/go v0.0.0-20180608230132-da2b80561ef3 require ( cloud.google.com/go v0.25.0 diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md index 3c1d0b3..33325eb 100644 -- - a/samples/guestbook/README.md +++ b/samples/guestbook/README.md @ @ -30,11 +30,11 @ @ go generate & & go build # # Running Locally You will need to run a local MySQL database server , set up a directory that -simulates a bucket , and create a local message of the day . ` localdb.sh ` is a -script that runs a temporary database using Docker : +simulates a bucket , and create a local message of the day . ` localdb/main.go ` is a +program that runs a temporary database using Docker : `` ` shell -./localdb.sh +go run localdb/main.go `` ` In another terminal , you can run : @ @ -79,7 +79,7 @ @ terraform init # and desired zone . terraform apply -./deploy.sh +go run ./deploy/main.go `` ` The deploy script will display the URL of your running service . diff -- git a/samples/guestbook/aws/main.tf b/samples/guestbook/aws/main.tf index 5962cf0..f48ef7d 100644 -- - a/samples/guestbook/aws/main.tf +++ b/samples/guestbook/aws/main.tf
diff -- git a/README.md b/README.md index b4e9670..2177a3f 100644 -- - a/README.md +++ b/README.md @ @ -1,24 +1,41 @ @ - # Go X Cloud - [ ! [ Build Status ] ( https : //travis-ci.com/google/go-cloud.svg ? branch=master ) ] [ travis ] [ ! [ godoc ] ( https : //godoc.org/github.com/google/go-cloud ? status.svg ) ] [ godoc ] -This repository is a design experiment to make it possible to write Go programs -across multiple cloud platforms . + # The Go X Cloud Project +_Write once , run any cloud _ - `` ` - $ go get -u github.com/google/go-cloud +The Go X Cloud Project is an initiative that will allow application developers to seamlessly deploy cloud applications on any combination of cloud providers . It does this by providing stable , idiomatic interfaces for common uses like storage , PubSub and databases . Think ` database/sql ` for cloud . + +A key part of the project is to also provide a code generator called Wire . Wire is invoked using ` go generate ` and creates human-readable code that only imports the cloud SDKs for providers you use . This allows Go X Cloud to grow to support
diff -- git a/blob/s3blob/s3blob.go b/blob/s3blob/s3blob.go index ff50cdd..85be0ad 100644 -- - a/blob/s3blob/s3blob.go +++ b/blob/s3blob/s3blob.go @ @ -21,9 +21,7 @ @ import ( '' fmt '' '' io '' '' io/ioutil '' - '' regexp '' '' strings '' - '' unicode/utf8 '' '' github.com/google/go-cloud/blob '' '' github.com/google/go-cloud/blob/driver '' @ @ -38,9 +36,6 @ @ import ( // communicate to S3 . AWS config can be passed in through BucketOptions to // change the default configuration of the S3Bucket . func NewBucket ( ctx context.Context , sess client.ConfigProvider , bucketName string ) ( *blob.Bucket , error ) { - if err : = validateBucketChar ( bucketName ) ; err ! = nil { - return nil , err - } if sess == nil { return nil , errors.New ( `` sess must be provided to get bucket '' ) } @ @ -216,9 +211,6 @ @ func ( b *bucket ) newMetadataReader ( ctx context.Context , key string ) ( driver.Read // // The caller must call Close on the returned writer when done writing . func ( b *bucket ) NewWriter ( ctx context.Context , key string , opts *driver.WriterOptions ) ( driver.Writer , error ) { - if err
diff -- git a/blob/s3blob/s3blob.go b/blob/s3blob/s3blob.go index ff50cdd..85be0ad 100644 -- - a/blob/s3blob/s3blob.go +++ b/blob/s3blob/s3blob.go @ @ -21,9 +21,7 @ @ import ( '' fmt '' '' io '' '' io/ioutil '' - '' regexp '' '' strings '' - '' unicode/utf8 '' '' github.com/google/go-cloud/blob '' '' github.com/google/go-cloud/blob/driver '' @ @ -38,9 +36,6 @ @ import ( // communicate to S3 . AWS config can be passed in through BucketOptions to // change the default configuration of the S3Bucket . func NewBucket ( ctx context.Context , sess client.ConfigProvider , bucketName string ) ( *blob.Bucket , error ) { - if err : = validateBucketChar ( bucketName ) ; err ! = nil { - return nil , err - } if sess == nil { return nil , errors.New ( `` sess must be provided to get bucket '' ) } @ @ -216,9 +211,6 @ @ func ( b *bucket ) newMetadataReader ( ctx context.Context , key string ) ( driver.Read // // The caller must call Close on the returned writer when done writing . func ( b *bucket ) NewWriter ( ctx context.Context , key string , opts *driver.WriterOptions ) ( driver.Writer , error ) { - if err
diff -- git a/blob/blob.go b/blob/blob.go index fc4a7e3..a8670cd 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -302,6 +302,35 @ @ func ( b *Bucket ) Delete ( ctx context.Context , key string ) error { return b.b.Delete ( ctx , key ) } +// SignedURL returns a URL that can be used to GET the blob for a limited time . +// If IsNotImplemented returns true for the returned error , the provider does +// not support SignedURL . +func ( b *Bucket ) SignedURL ( ctx context.Context , key string , opts *SignedURLOptions ) ( string , error ) { + if opts == nil { + opts = & SignedURLOptions { } + } + if opts.Expiry < 0 { + return `` '' , errors.New ( `` SignedURLOptions.Expiry must be > = 0 '' ) + } + if opts.Expiry == 0 { + opts.Expiry = DefaultSignedURLExpiry + } + dopts : = driver.SignedURLOptions { + Expiry : opts.Expiry , + } + return b.b.SignedURL ( ctx , key , & dopts ) + } + +// DefaultSignedURLExpiry is the default duration for SignedURLOptions.Expiry . +const DefaultSignedURLExpiry = 1 * time.Hour + +// SignedURLOptions sets options for SignedURL
diff -- git a/internal/pubsub/gcppubsub/gcppubsub.go b/internal/pubsub/gcppubsub/gcppubsub.go new file mode 100644 index 0000000..342d562 -- - /dev/null +++ b/internal/pubsub/gcppubsub/gcppubsub.go @ @ -0,0 +1,125 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package gcppubsub provides an implementation of pubsub that uses GCP +// PubSub . +package gcppubsub + +import ( + '' context '' + '' fmt '' + + raw `` cloud.google.com/go/pubsub/apiv1 '' + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + pb `` google.golang.org/genproto/googleapis/pubsub/v1 '' + ) + +type topic struct { + path string + client *raw.PublisherClient + } + +// OpenTopic
diff -- git a/internal/docs/pubsub/design.md b/internal/docs/pubsub/design.md index d55764e..50b80de 100644 -- - a/internal/docs/pubsub/design.md +++ b/internal/docs/pubsub/design.md @ @ -319,8 +319,19 @ @ type Topic interface { // Subscription receives published messages . type Subscription interface { - // ReceiveBatch returns a batch of messages that have queued up for the - // subscription on the server . + // ReceiveBatch should return a batch of messages that have queued up + // for the subscription on the server . + // + // If there is a transient failure , this method should not retry but + // should return a nil slice and an error . The concrete API will take + // care of retry logic . + // + // If the service returns no messages for some other reason , this + // method should return the empty slice of messages and not attempt to + // retry . + // + // ReceiveBatch is only called sequentially for individual + // Subscriptions . ReceiveBatch ( ctx context.Context ) ( [ ] *Message , error ) // SendAcks acknowledges the messages with the given ackIDs on the diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index 5418eae..d2931b4 100644 -- - a/internal/pubsub/driver/driver.go +++
diff -- git a/blob/blob.go b/blob/blob.go index fc4a7e3..3bacf3a 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -61,6 +61,12 @ @ func ( r *Reader ) Size ( ) int64 { return r.r.Attributes ( ) .Size } +// As converts i to provider-specific types . +// See Bucket.As for more details . +func ( r *Reader ) As ( i interface { } ) bool { + return r.r.As ( i ) + } + // Attributes contains attributes about a blob . type Attributes struct { // ContentType is the MIME type of the blob object . It will not be empty . @ @ -76,6 +82,17 @ @ type Attributes struct { ModTime time.Time // Size is the size of the object in bytes . Size int64 + + asFunc func ( interface { } ) bool + } + +// As converts i to provider-specific types . +// See Bucket.As for more details . +func ( a *Attributes ) As ( i interface { } ) bool { + if a.asFunc == nil { + return false + } + return a.asFunc ( i ) } // Writer implements io.WriteCloser to write to blob . It must be closed
diff -- git a/internal/docs/design.md b/internal/docs/design.md index c8e42fc..7a0239f 100644 -- - a/internal/docs/design.md +++ b/internal/docs/design.md @ @ -19,20 +19,20 @ @ teams . In a larger organization , these may be different teams entirely , but working closely together . Regardless , these two personas have two very different ways of looking at a Go program : -- The developer persona wants to write business logic that is agnostic of - underlying cloud provider . Their focus is on making software correct for the - requirements at hand . -- The operator persona wants to incorporate the business logic into the - organization 's policies and provision resources for the logic to run . Their - focus is making software run predictably and reliably with the resources at - hand . +- The developer persona wants to write business logic that is agnostic of + underlying cloud provider . Their focus is on making software correct for the + requirements at hand . +- The operator persona wants to incorporate the business logic into the + organization 's policies and provision resources for the logic to run . Their + focus is making software run predictably and reliably with the resources at
diff -- git a/blob/gcsblob/testdata/test-naming.yaml b/blob/gcsblob/testdata/test-naming.yaml index 6176e81..555f5e3 100644 -- - a/blob/gcsblob/testdata/test-naming.yaml +++ b/blob/gcsblob/testdata/test-naming.yaml @ @ -2,45 +2,28 @ @ version : 1 interactions : - request : - body : | - { `` name '' : '' go-cloud-bucket-name '' } + body : `` '' form : { } headers : - Content-Type : - - application/json User-Agent : - google-api-go-client/0.5 X-Goog-Api-Client : - gl-go/1.10.3 gccl/20180226 - url : https : //www.googleapis.com/storage/v1/b ? alt=json - method : POST + url : https : //www.googleapis.com/storage/v1/b/go-cloud-8ucket_nam3 ? alt=json + method : DELETE response : - body : | - { - `` kind '' : `` storage # bucket '' , - `` id '' : `` go-cloud-bucket-name '' , - `` projectNumber '' : `` 640193379878 '' , - `` name '' : `` go-cloud-bucket-name '' , - `` timeCreated '' : `` 2018-07-17T22:41:21.898Z '' , - `` updated '' : `` 2018-07-17T22:41:21.898Z '' , - `` metageneration '' : `` 1 '' , - `` location '' : `` US '' , - `` storageClass '' : `` STANDARD '' , - `` etag '' : `` CAE= '' - } + body : `` '' headers : Alt-Svc
diff -- git a/docs/design.md b/docs/design.md index b63565b..210a6e9 100644 -- - a/docs/design.md +++ b/docs/design.md @ @ -3,6 +3,52 @ @ This document outlines important design decisions made for this repository and attempts to provide succinct rationales . + # # Drivers and User-Facing Types + +The generic APIs that Go X Cloud exports ( like [ ` blob.Bucket ` ] [ ] or + [ ` runtimevar.Variable ` ] [ ] are concrete types , not interfaces . To understand why , +imagine if we used a plain interface : + + ! [ Diagram showing user code depending on blob.Bucket , which is implemented by +awsblob.Bucket . ] ( img/user-facing-type-no-driver.png ) + +Consider the [ ` Bucket.NewWriter ` method ] [ ] , which infers the content type of the +blob based on the first bytes written to it . If ` blob.Bucket ` was an interface , +each implementation of ` blob.Bucket ` would have to replicate this behavior +precisely . This does not scale : conformance tests would be needed to ensure that +each interface method actually behaves in the way that the docs describe . This +makes the interfaces hard to implement , which runs counter to
diff -- git a/internal/pubsub/gcppubsub/gcppubsub.go b/internal/pubsub/gcppubsub/gcppubsub.go new file mode 100644 index 0000000..1c78054 -- - /dev/null +++ b/internal/pubsub/gcppubsub/gcppubsub.go @ @ -0,0 +1,111 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package gcppubsub provides an implementation of pubsub that uses GCP +// PubSub . +package gcppubsub + +import ( + '' context '' + '' fmt '' + + rawgcppubsub `` cloud.google.com/go/pubsub/apiv1 '' + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + pubsubpb `` google.golang.org/genproto/googleapis/pubsub/v1 '' + ) + +type topic struct { + path string + client *rawgcppubsub.PublisherClient + } + +func (
diff -- git a/internal/pubsub/pubsub.go b/internal/pubsub/pubsub.go index 44c8fae..d518ef8 100644 -- - a/internal/pubsub/pubsub.go +++ b/internal/pubsub/pubsub.go @ @ -30,22 +30,15 @ @ type Message struct { // Metadata has key/value metadata for the message . Metadata map [ string ] string - // AckID identifies the message on the server . - // It can be used to ack the message after it has been received . - ackID driver.AckID - - // sub is the Subscription this message was received from . - sub *Subscription + // ack is a closure that queues this message for acknowledgement . + ack func ( ) } // Ack acknowledges the message , telling the server that it does not need to be // sent again to the associated Subscription . It returns immediately , but the // actual ack is sent in the background , and is not guaranteed to succeed . func ( m *Message ) Ack ( ) { - // Send the message back to the subscription for ack batching . - // size is an estimate of the size of a single AckID in bytes . - const size = 8 - go m.sub.ackBatcher.Add ( m , size ) +
diff -- git a/internal/batcher/batcher.go b/internal/batcher/batcher.go new file mode 100644 index 0000000..885c4e1 -- - /dev/null +++ b/internal/batcher/batcher.go @ @ -0,0 +1,110 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package batcher supports batching of items . Create a Batcher with a handler and +// add items to it . Items are accumulated while handler calls are in progress ; when +// the handler returns , it will be called again with items accumulated since the last +// call . Multiple concurrent calls to the handler are supported . +package batcher + +import
diff -- git a/internal/batcher/batcher.go b/internal/batcher/batcher.go new file mode 100644 index 0000000..885c4e1 -- - /dev/null +++ b/internal/batcher/batcher.go @ @ -0,0 +1,110 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package batcher supports batching of items . Create a Batcher with a handler and +// add items to it . Items are accumulated while handler calls are in progress ; when +// the handler returns , it will be called again with items accumulated since the last +// call . Multiple concurrent calls to the handler are supported . +package batcher + +import
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 2019ddc..a20970c 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -17,10 +17,10 @ @ package drivertest import ( - '' bytes '' '' context '' '' fmt '' '' math/rand '' + '' sort '' '' testing '' '' github.com/google/go-cloud/internal/pubsub '' @ @ -53,12 +53,6 @ @ func RunConformanceTests ( t *testing.T , newHarness HarnessMaker ) { t.Run ( `` TestSendReceive '' , func ( t *testing.T ) { testSendReceive ( t , newHarness ) } ) - t.Run ( `` TestErrorOnSendToClosedTopic '' , func ( t *testing.T ) { - testErrorOnSendToClosedTopic ( t , newHarness ) - } ) - t.Run ( `` TestErrorOnReceiveFromClosedSubscription '' , func ( t *testing.T ) { - testErrorOnReceiveFromClosedSubscription ( t , newHarness ) - } ) t.Run ( `` TestCancelSendReceive '' , func ( t *testing.T ) { testCancelSendReceive ( t , newHarness ) } ) @ @ -80,6 +74,7 @ @ func testSendReceive ( t *testing.T , newHarness HarnessMaker ) { // Send to the topic . ms : = [ ] *pubsub.Message { } + ss : = [ ] string { } for i : = 0 ; i < 3 ; i++ { m
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 84cbee2..3726b6a 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -17,10 +17,10 @ @ package drivertest import ( - '' bytes '' '' context '' '' fmt '' '' math/rand '' + '' sort '' '' testing '' '' github.com/google/go-cloud/internal/pubsub '' @ @ -53,12 +53,6 @ @ func RunConformanceTests ( t *testing.T , newHarness HarnessMaker ) { t.Run ( `` TestSendReceive '' , func ( t *testing.T ) { testSendReceive ( t , newHarness ) } ) - t.Run ( `` TestErrorOnSendToClosedTopic '' , func ( t *testing.T ) { - testErrorOnSendToClosedTopic ( t , newHarness ) - } ) - t.Run ( `` TestErrorOnReceiveFromClosedSubscription '' , func ( t *testing.T ) { - testErrorOnReceiveFromClosedSubscription ( t , newHarness ) - } ) t.Run ( `` TestCancelSendReceive '' , func ( t *testing.T ) { testCancelSendReceive ( t , newHarness ) } ) @ @ -80,6 +74,7 @ @ func testSendReceive ( t *testing.T , newHarness HarnessMaker ) { // Send to the topic . ms : = [ ] *pubsub.Message { } + ss : = [ ] string { } for i : = 0 ; i < 3 ; i++ { m
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 84cbee2..270abc3 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -17,10 +17,10 @ @ package drivertest import ( - '' bytes '' '' context '' '' fmt '' '' math/rand '' + '' sort '' '' testing '' '' github.com/google/go-cloud/internal/pubsub '' @ @ -79,7 +79,8 @ @ func testSendReceive ( t *testing.T , newHarness HarnessMaker ) { defer cleanup ( ) // Send to the topic . - ms : = [ ] *pubsub.Message { } + var ms [ ] *pubsub.Message + var ss [ ] string for i : = 0 ; i < 3 ; i++ { m : = & pubsub.Message { Body : [ ] byte ( randStr ( ) ) , @ @ -89,22 +90,26 @ @ func testSendReceive ( t *testing.T , newHarness HarnessMaker ) { t.Fatal ( err ) } ms = append ( ms , m ) + ss = append ( ss , string ( m.Body ) ) } // Receive from the subscription . - ms2 : = [ ] *pubsub.Message { } + var ms2 [ ] *pubsub.Message + var ss2 [ ] string for i : = 0 ; i < len
diff -- git a/internal/pubsub/gcppubsub/gcppubsub.go b/internal/pubsub/gcppubsub/gcppubsub.go index f3d08a5..b4683b0 100644 -- - a/internal/pubsub/gcppubsub/gcppubsub.go +++ b/internal/pubsub/gcppubsub/gcppubsub.go @ @ -51,26 +51,29 @ @ func OpenTopic ( ctx context.Context , client *raw.PublisherClient , proj gcp.Projec // openTopic returns the driver for OpenTopic . This function exists so the test // harness can get the driver interface implementation if it needs to . func openTopic ( ctx context.Context , client *raw.PublisherClient , proj gcp.ProjectID , topicName string ) ( driver.Topic , error ) { + path : = fmt.Sprintf ( `` projects/ % s/topics/ % s '' , proj , topicName ) client , err : = raw.NewPublisherClient ( ctx ) if err ! = nil { return nil , fmt.Errorf ( `` gcppubsub : creating publisher client : % v '' , err ) } - ok , err : = topicExists ( ctx , client , topicName ) + ok , err : = topicExists ( ctx , client , path ) if err ! = nil { return nil , fmt.Errorf ( `` gcppubsub : checking existence of topic : % v '' , err ) } if ! ok { return nil , fmt.Errorf ( `` gcppubsub : topic named % q
diff -- git a/samples/guestbook/inject_aws.go b/samples/guestbook/inject_aws.go index 9fce61f..03fc8a2 100644 -- - a/samples/guestbook/inject_aws.go +++ b/samples/guestbook/inject_aws.go @ @ -38,14 +38,14 @ @ import ( func setupAWS ( ctx context.Context , flags *cliFlags ) ( *application , func ( ) , error ) { // This will be filled in by Wire with providers from the provider sets in // wire.Build . - - panic ( wire.Build ( + wire.Build ( awscloud.AWS , applicationSet , awsBucket , awsMOTDVar , awsSQLParams , - ) ) + ) + return nil , func ( ) { } , nil } // awsBucket is a Wire provider function that returns the S3 bucket based on the diff -- git a/samples/guestbook/inject_gcp.go b/samples/guestbook/inject_gcp.go index a7235dd..3948c28 100644 -- - a/samples/guestbook/inject_gcp.go +++ b/samples/guestbook/inject_gcp.go @ @ -38,14 +38,14 @ @ import ( func setupGCP ( ctx context.Context , flags *cliFlags ) ( *application , func ( ) , error ) { // This will be filled in by Wire with providers from the provider sets in // wire.Build . - - panic ( wire.Build ( + wire.Build ( gcpcloud.GCP , applicationSet , gcpBucket , gcpMOTDVar , gcpSQLParams , - ) ) + ) + return nil , func ( ) { }
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..e306c0c 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -31,8 +31,8 @ @ var GCP = wire.NewSet ( Services , gcp.DefaultIdentity ) // Google Cloud Platform services in this repository , but does not include // credentials . Individual services may require additional configuration . var Services = wire.NewSet ( - cloudmysql.CertSourceSet , cloudmysql.Open , + cloudmysql.CertSourceSet , gcp.DefaultTransport , gcp.NewHTTPClient , runtimeconfigurator.Set , diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..957a3b7 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -67,7 +69,6 @ @ func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sq } dialerName : = fmt.Sprintf ( `` github.com/google/go-cloud/mysql/gcpmysql/ % d '' , dialerNum ) mysql.RegisterDial ( dialerName , client.Dial ) - cfg : = & mysql.Config { AllowNativePasswords : true , Net : dialerName , @ @ -79,6 +80,31 @ @ func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sq return sql.OpenDB ( connector ( cfg.FormatDSN ( )
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..e306c0c 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -31,8 +31,8 @ @ var GCP = wire.NewSet ( Services , gcp.DefaultIdentity ) // Google Cloud Platform services in this repository , but does not include // credentials . Individual services may require additional configuration . var Services = wire.NewSet ( - cloudmysql.CertSourceSet , cloudmysql.Open , + cloudmysql.CertSourceSet , gcp.DefaultTransport , gcp.NewHTTPClient , runtimeconfigurator.Set , diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..8c825f7 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -53,6 +55,7 @ @ type Params struct { User string Password string // may be empty , see https : //cloud.google.com/sql/docs/sql-proxy # user Database string + TraceOpts ocsql.TraceOption } // Open opens a Cloud SQL database . @ @ -67,7 +70,6 @ @ func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sq } dialerName : = fmt.Sprintf ( `` github.com/google/go-cloud/mysql/gcpmysql/ % d '' , dialerNum ) mysql.RegisterDial ( dialerName , client.Dial ) - cfg : =
diff -- git a/blob/gcsblob/gcsblob.go b/blob/gcsblob/gcsblob.go index ae71183..62a4a04 100644 -- - a/blob/gcsblob/gcsblob.go +++ b/blob/gcsblob/gcsblob.go @ @ -105,8 +105,6 @ @ func ( b *bucket ) Delete ( ctx context.Context , key string ) error { return err } -const namingRuleURL = `` https : //cloud.google.com/storage/docs/naming '' - func bufferSize ( size int ) int { if size == 0 { return googleapi.DefaultUploadChunkSize diff -- git a/internal/testing/checkpr.sh b/internal/testing/checkpr.sh index 09ae3d1..2484031 100755 -- - a/internal/testing/checkpr.sh +++ b/internal/testing/checkpr.sh @ @ -65,5 +65,5 @ @ golangci-lint run \ -- disable=deadcode \ -- disable=typecheck \ -- disable=unused \ - -- disable=varcheck \ + -- build-tags=wireinject \ `` $ { lintdirs [ @ ] } '' || exit 1
diff -- git a/internal/docs/pubsub/design.md b/internal/docs/pubsub/design.md index b42123f..e8533e6 100644 -- - a/internal/docs/pubsub/design.md +++ b/internal/docs/pubsub/design.md @ @ -29,7 +29,7 @ @ There are several pubsub systems available that could be made to work with Go Cl # # Design overview # # # Developer  s perspective -Given a topic that has already been created on the pubsub server , messages can be sent to that topic by calling ` acmepubsub.OpenTopic ` and calling the ` Send ` method of the returned ` Topic ` , like this ( assuming a fictional pubsub provider called `` acme '' ) : +Given a topic that has already been created on the pubsub server , messages can be sent to that topic by calling ` acmepubsub.OpenTopic ` and calling the ` Send ` method of the returned ` Topic ` , like this ( assuming a fictional pubsub provider called `` acme '' ) : `` ` go package main @ @ -38,6 +38,7 @ @ import ( '' log '' '' net/http '' + rawacmepubsub `` github.com/acme/pubsub '' '' github.com/google/go-cloud/pubsub '' '' github.com/google/go-cloud/pubsub/acmepubsub '' ) @ @ -48,11 +49,11 @ @ func main ( ) { func serve ( ) error { ctx
diff -- git a/.gitignore b/.gitignore index 6dbf748..89a9b5e 100644 -- - a/.gitignore +++ b/.gitignore @ @ -18,3 +18,13 @ @ # Populated config files tests/gcp/app/gcp-test.yaml + + # Cryptographic keys +*.pem +*.json + + # Terraform Temporary Files +*.tfstate +*.tfstate.backup +.terraform/ +terraform.tfvars diff -- git a/go.mod b/go.mod index 90463d1..0fe3d6c 100644 -- - a/go.mod +++ b/go.mod @ @ -18,6 +18,8 @ @ require ( contrib.go.opencensus.io/exporter/stackdriver v0.0.0-20180421005815-665cf5131b71 github.com/GoogleCloudPlatform/cloudsql-proxy v0.0.0-20180321230639-1e456b1c68cb github.com/aws/aws-sdk-go v1.13.20 + github.com/aws/aws-sdk-go-v2 v0.0.0-20180526011417-ff1a530c3150 + github.com/aws/aws-xray-sdk-go v1.0.0-rc.5 github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b github.com/dnaeon/go-vcr v0.0.0-20180504081357-f8a7e8b9c630 github.com/fsnotify/fsnotify v1.4.7 diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md new file mode 100644 index 0000000..0454589 -- - /dev/null +++ b/samples/guestbook/README.md @ @ -0,0 +1,87 @ @ + # Guestbook Sample + + # # Prerequisites + +You will need to install the following software to run this sample : + +- [ Go ] ( https : //golang.org/doc/install ) and + [ vgo ] ( https : //go.googlesource.com/vgo ) +- [ Docker ] ( https : //docs.docker.com/install/ ) +- [ Terraform ] ( https : //www.terraform.io/intro/getting-started/install.html ) +- [ jq ] ( https : //stedolan.github.io/jq/download/ ) +- [ gcloud CLI ] ( https : //cloud.google.com/sdk/downloads ) , if you want to use GCP +- [ aws CLI ] ( https : //docs.aws.amazon.com/cli/latest/userguide/installing.html ) ,
diff -- git a/.gitignore b/.gitignore index 6dbf748..89a9b5e 100644 -- - a/.gitignore +++ b/.gitignore @ @ -18,3 +18,13 @ @ # Populated config files tests/gcp/app/gcp-test.yaml + + # Cryptographic keys +*.pem +*.json + + # Terraform Temporary Files +*.tfstate +*.tfstate.backup +.terraform/ +terraform.tfvars diff -- git a/go.mod b/go.mod index 90463d1..0fe3d6c 100644 -- - a/go.mod +++ b/go.mod @ @ -18,6 +18,8 @ @ require ( contrib.go.opencensus.io/exporter/stackdriver v0.0.0-20180421005815-665cf5131b71 github.com/GoogleCloudPlatform/cloudsql-proxy v0.0.0-20180321230639-1e456b1c68cb github.com/aws/aws-sdk-go v1.13.20 + github.com/aws/aws-sdk-go-v2 v0.0.0-20180526011417-ff1a530c3150 + github.com/aws/aws-xray-sdk-go v1.0.0-rc.5 github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b github.com/dnaeon/go-vcr v0.0.0-20180504081357-f8a7e8b9c630 github.com/fsnotify/fsnotify v1.4.7 diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md new file mode 100644 index 0000000..2c360c2 -- - /dev/null +++ b/samples/guestbook/README.md @ @ -0,0 +1,105 @ @ + # Guestbook Sample + +Guestbook is a sample application that records visitors ' messages , displays a +cloud banner , and an administrative message . The main business logic is +written in a cloud-agnostic manner using MySQL , the generic blob API , and the +generic runtimevar API . Each of the platform-specific code is set up by Wire . + + # # Prerequisites + +You will need to install the following software to run this sample : + +- [ Go ] ( https : //golang.org/doc/install ) and + [ vgo ] ( https :
diff -- git a/.gitignore b/.gitignore index 6dbf748..89a9b5e 100644 -- - a/.gitignore +++ b/.gitignore @ @ -18,3 +18,13 @ @ # Populated config files tests/gcp/app/gcp-test.yaml + + # Cryptographic keys +*.pem +*.json + + # Terraform Temporary Files +*.tfstate +*.tfstate.backup +.terraform/ +terraform.tfvars diff -- git a/go.mod b/go.mod index 90463d1..0fe3d6c 100644 -- - a/go.mod +++ b/go.mod @ @ -18,6 +18,8 @ @ require ( contrib.go.opencensus.io/exporter/stackdriver v0.0.0-20180421005815-665cf5131b71 github.com/GoogleCloudPlatform/cloudsql-proxy v0.0.0-20180321230639-1e456b1c68cb github.com/aws/aws-sdk-go v1.13.20 + github.com/aws/aws-sdk-go-v2 v0.0.0-20180526011417-ff1a530c3150 + github.com/aws/aws-xray-sdk-go v1.0.0-rc.5 github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b github.com/dnaeon/go-vcr v0.0.0-20180504081357-f8a7e8b9c630 github.com/fsnotify/fsnotify v1.4.7 diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md new file mode 100644 index 0000000..b44953e -- - /dev/null +++ b/samples/guestbook/README.md @ @ -0,0 +1,98 @ @ + # Guestbook Sample + +Guestbook is a sample application that records visitors ' messages , displays a +cloud banner , and an administrative message . The main business logic is +written in a cloud-agnostic manner using MySQL , the generic blob API , and the +generic runtimevar API . Each of the platform-specific code is set up by Wire . + + # # Prerequisites + +You will need to install the following software to run this sample : + +- [ Go ] ( https : //golang.org/doc/install ) and + [ vgo ] ( https :
diff -- git a/.gitignore b/.gitignore index 6dbf748..89a9b5e 100644 -- - a/.gitignore +++ b/.gitignore @ @ -18,3 +18,13 @ @ # Populated config files tests/gcp/app/gcp-test.yaml + + # Cryptographic keys +*.pem +*.json + + # Terraform Temporary Files +*.tfstate +*.tfstate.backup +.terraform/ +terraform.tfvars diff -- git a/go.mod b/go.mod index 51f8b6c..4fdc9d9 100644 -- - a/go.mod +++ b/go.mod @ @ -22,6 +22,8 @ @ require ( contrib.go.opencensus.io/exporter/stackdriver v0.0.0-20180421005815-665cf5131b71 github.com/GoogleCloudPlatform/cloudsql-proxy v0.0.0-20180321230639-1e456b1c68cb github.com/aws/aws-sdk-go v1.13.20 + github.com/aws/aws-sdk-go-v2 v0.0.0-20180526011417-ff1a530c3150 + github.com/aws/aws-xray-sdk-go v1.0.0-rc.5 github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b github.com/dnaeon/go-vcr v0.0.0-20180504081357-f8a7e8b9c630 github.com/fsnotify/fsnotify v1.4.7 diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md new file mode 100644 index 0000000..2f44772 -- - /dev/null +++ b/samples/guestbook/README.md @ @ -0,0 +1,120 @ @ + # Guestbook Sample + +Guestbook is a sample application that records visitors ' messages , displays a +cloud banner , and an administrative message . The main business logic is +written in a cloud-agnostic manner using MySQL , the generic blob API , and the +generic runtimevar API . All platform-specific code is set up by Wire . + + # # Prerequisites + +You will need to install the following software to run this sample : + +- [ Go ] ( https : //golang.org/doc/install ) and + [ vgo ] ( https : //go.googlesource.com/vgo )
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index bd0947d..f57977f 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -19,6 +19,7 @ @ import ( '' github.com/google/go-cloud/gcp '' '' github.com/google/go-cloud/goose '' '' github.com/google/go-cloud/mysql/cloudmysql '' + '' github.com/google/go-cloud/runtimevar/runtimeconfigurator '' '' github.com/google/go-cloud/server/sdserver '' ) @ @ -30,8 +31,9 @ @ var GCP = goose.NewSet ( Services , gcp.DefaultIdentity ) // Google Cloud Platform services in this repository , but does not include // credentials . Individual services may require additional configuration . var Services = goose.NewSet ( - gcp.DefaultTransport , - gcp.NewHTTPClient , cloudmysql.CertSourceSet , cloudmysql.Open , + gcp.DefaultTransport , + gcp.NewHTTPClient , + runtimeconfigurator.Set , sdserver.Set ) diff -- git a/runtimevar/paramstore/paramstore.go b/runtimevar/paramstore/paramstore.go index ab38e90..e3344cf 100644 -- - a/runtimevar/paramstore/paramstore.go +++ b/runtimevar/paramstore/paramstore.go @ @ -12,7 +12,7 @ @ // See the License for the specific language governing permissions and // limitations under the License . -// Package paramstore reads and writes parameters to the AWS Systems Manager Parameter Store . +// Package paramstore reads parameters to the AWS Systems Manager Parameter Store . package paramstore import ( diff -- git a/runtimevar/runtimeconfigurator/example_test.go b/runtimevar/runtimeconfigurator/example_test.go index 8e1f3fb..2e43207 100644 -- - a/runtimevar/runtimeconfigurator/example_test.go +++ b/runtimevar/runtimeconfigurator/example_test.go @ @ -18,10 +18,28 @ @ import ( '' context '' '' log '' + '' github.com/google/go-cloud/gcp
diff -- git a/.travis.yml b/.travis.yml index 1c1c0cf..c5a93e8 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -3,7 +3,7 @ @ os : - osx language : go -go_import_path : github.com/google/go-cloud +go_import_path : github.com/google/go-x-cloud go : `` 1.10.x '' before_install : diff -- git a/README.md b/README.md index b4e9670..42f999d 100644 -- - a/README.md +++ b/README.md @ @ -1,19 +1,19 @ @ # Go X Cloud - [ ! [ Build Status ] ( https : //travis-ci.com/google/go-cloud.svg ? branch=master ) ] [ travis ] - [ ! [ godoc ] ( https : //godoc.org/github.com/google/go-cloud ? status.svg ) ] [ godoc ] + [ ! [ Build Status ] ( https : //travis-ci.com/google/go-x-cloud.svg ? branch=master ) ] [ travis ] + [ ! [ godoc ] ( https : //godoc.org/github.com/google/go-x-cloud ? status.svg ) ] [ godoc ] This repository is a design experiment to make it possible to write Go programs across multiple cloud platforms . `` ` - $ go get -u github.com/google/go-cloud + $ go get -u github.com/google/go-x-cloud `` ` See the examples under ` aws/awscloud ` or ` gcp/gcpcloud ` for how to get started . - [ travis ] : https : //travis-ci.com/google/go-cloud - [ godoc ] : http : //godoc.org/github.com/google/go-cloud
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go new file mode 100644 index 0000000..dac6653 -- - /dev/null +++ b/internal/pubsub/drivertest/drivertest.go @ @ -0,0 +1,157 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package drivertest provides a conformance test for implementations of +// driver . +package drivertest + +import ( + '' context '' + '' fmt '' + '' math/rand '' + '' testing '' + '' time '' + + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + ) + +// Harness descibes the functionality test harnesses must provide to run +// conformance tests
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go new file mode 100644 index 0000000..0fa4568 -- - /dev/null +++ b/internal/pubsub/drivertest/drivertest.go @ @ -0,0 +1,165 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package drivertest provides a conformance test for implementations of +// driver . +package drivertest + +import ( + '' context '' + '' fmt '' + '' math/rand '' + '' testing '' + + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + ) + +// Harness descibes the functionality test harnesses must provide to run +// conformance tests . +type Harness interface
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go new file mode 100644 index 0000000..3ca5655 -- - /dev/null +++ b/internal/pubsub/drivertest/drivertest.go @ @ -0,0 +1,204 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package drivertest provides a conformance test for implementations of +// driver . +package drivertest + +import ( + '' context '' + '' fmt '' + '' math/rand '' + '' testing '' + + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + '' github.com/google/go-cmp/cmp '' + ) + +// Harness descibes the functionality test harnesses must provide to run +// conformance tests
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go new file mode 100644 index 0000000..dd14f64 -- - /dev/null +++ b/internal/pubsub/drivertest/drivertest.go @ @ -0,0 +1,246 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package drivertest provides a conformance test for implementations of +// driver . +package drivertest + +import ( + '' bytes '' + '' context '' + '' fmt '' + '' math/rand '' + '' testing '' + + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + '' github.com/google/go-cmp/cmp '' + '' github.com/google/go-cmp/cmp/cmpopts '' + ) + +// Harness descibes the functionality test
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go new file mode 100644 index 0000000..1f1ee86 -- - /dev/null +++ b/internal/pubsub/drivertest/drivertest.go @ @ -0,0 +1,251 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package drivertest provides a conformance test for implementations of +// driver . +package drivertest + +import ( + '' bytes '' + '' context '' + '' fmt '' + '' math/rand '' + '' testing '' + + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + '' github.com/google/go-cmp/cmp '' + '' github.com/google/go-cmp/cmp/cmpopts '' + ) + +// Harness descibes the functionality test
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go new file mode 100644 index 0000000..a4d9dbb -- - /dev/null +++ b/internal/pubsub/drivertest/drivertest.go @ @ -0,0 +1,184 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package drivertest provides a conformance test for implementations of +// driver . +package drivertest + +import ( + '' bytes '' + '' context '' + '' fmt '' + '' math/rand '' + '' testing '' + + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + '' github.com/google/go-cmp/cmp '' + '' github.com/google/go-cmp/cmp/cmpopts '' + ) + +// Harness descibes the functionality test
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..5592081 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -37,3 +37,17 @ @ var Services = wire.NewSet ( gcp.NewHTTPClient , runtimeconfigurator.Set , sdserver.Set ) + +// GAE is a Wire provider set , similar to the GCP Wire provider +// set except that GAEServices is used instead of Services . +var GAE = wire.NewSet ( GAEServices , gcp.DefaultIdentity ) + +// GAEServices is a Wire provider set , similar to Services +// except that cloudmysql.OpenGAE is used instead of cloudmysql.Open . +var GAEServices = wire.NewSet ( + cloudmysql.CertSourceSet , + cloudmysql.OpenGAE , + gcp.DefaultTransport , + gcp.NewHTTPClient , + runtimeconfigurator.Set , + sdserver.Set ) diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..3838044 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,10 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' + '' strings '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -79,6 +82,36 @ @ func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sq return sql.OpenDB ( connector ( cfg.FormatDSN ( ) ) ) , nil } +// OpenGAE opens a Cloud SQL
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..5592081 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -37,3 +37,17 @ @ var Services = wire.NewSet ( gcp.NewHTTPClient , runtimeconfigurator.Set , sdserver.Set ) + +// GAE is a Wire provider set , similar to the GCP Wire provider +// set except that GAEServices is used instead of Services . +var GAE = wire.NewSet ( GAEServices , gcp.DefaultIdentity ) + +// GAEServices is a Wire provider set , similar to Services +// except that cloudmysql.OpenGAE is used instead of cloudmysql.Open . +var GAEServices = wire.NewSet ( + cloudmysql.CertSourceSet , + cloudmysql.OpenGAE , + gcp.DefaultTransport , + gcp.NewHTTPClient , + runtimeconfigurator.Set , + sdserver.Set ) diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..b4e0dad 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -67,7 +69,6 @ @ func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sq } dialerName : = fmt.Sprintf ( `` github.com/google/go-cloud/mysql/gcpmysql/ % d '' , dialerNum ) mysql.RegisterDial ( dialerName , client.Dial ) - cfg :
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..e306c0c 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -31,8 +31,8 @ @ var GCP = wire.NewSet ( Services , gcp.DefaultIdentity ) // Google Cloud Platform services in this repository , but does not include // credentials . Individual services may require additional configuration . var Services = wire.NewSet ( - cloudmysql.CertSourceSet , cloudmysql.Open , + cloudmysql.CertSourceSet , gcp.DefaultTransport , gcp.NewHTTPClient , runtimeconfigurator.Set , diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..247a872 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -57,6 +59,13 @ @ type Params struct { // Open opens a Cloud SQL database . func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sql.DB , error ) { + if os.Getenv ( `` GAE_ENV '' ) == `` standard '' { + return openGAE ( ctx , params ) + } + return open ( ctx , certSource , params ) + } + +func open ( ctx context.Context , certSource proxy.CertSource , params *Params
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..e306c0c 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -31,8 +31,8 @ @ var GCP = wire.NewSet ( Services , gcp.DefaultIdentity ) // Google Cloud Platform services in this repository , but does not include // credentials . Individual services may require additional configuration . var Services = wire.NewSet ( - cloudmysql.CertSourceSet , cloudmysql.Open , + cloudmysql.CertSourceSet , gcp.DefaultTransport , gcp.NewHTTPClient , runtimeconfigurator.Set , diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..247a872 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -57,6 +59,13 @ @ type Params struct { // Open opens a Cloud SQL database . func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sql.DB , error ) { + if os.Getenv ( `` GAE_ENV '' ) == `` standard '' { + return openGAE ( ctx , params ) + } + return open ( ctx , certSource , params ) + } + +func open ( ctx context.Context , certSource proxy.CertSource , params *Params
diff -- git a/wire/cmd/wire/main.go b/wire/cmd/wire/main.go index 0c8f5d2..9011e98 100644 -- - a/wire/cmd/wire/main.go +++ b/wire/cmd/wire/main.go @ @ -35,9 +35,14 @ @ import ( '' golang.org/x/tools/go/types/typeutil '' ) +const usage = `` usage : wire [ gen ] [ PKG ] | wire show [ ... ] | wire check [ ... ] '' + func main ( ) { var err error switch { + case len ( os.Args ) == 2 & & ( os.Args [ 1 ] == `` help '' || os.Args [ 1 ] == `` -h '' || os.Args [ 1 ] == `` -help '' || os.Args [ 1 ] == `` -- help '' ) : + fmt.Fprintln ( os.Stderr , usage ) + os.Exit ( 0 ) case len ( os.Args ) == 1 || len ( os.Args ) == 2 & & os.Args [ 1 ] == `` gen '' : err = generate ( `` . '' ) case len ( os.Args ) == 2 & & os.Args [ 1 ] == `` show '' : @ @ -53,7 +58,7 @ @ func main ( ) { case len ( os.Args ) == 3 & & os.Args [ 1 ] == ``
diff -- git a/internal/secrets/localsecrets/example_test.go b/internal/secrets/localsecrets/example_test.go new file mode 100644 index 0000000..6985c3b -- - /dev/null +++ b/internal/secrets/localsecrets/example_test.go @ @ -0,0 +1,40 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package localsecrets_test + +import ( + '' context '' + '' fmt '' + '' github.com/google/go-cloud/internal/secrets/localsecrets '' + ) + +func ExampleEncrypterDecrypterEncrypt ( ) { + msg : = `` I 'm a message ! '' + e , _ : = localsecrets.NewCrypter ( ) + + encryptedMsg , err : = e.Encrypt ( context.Background ( ) , [ ] byte ( msg )
diff -- git a/internal/secrets/driver/driver.go b/internal/secrets/driver/driver.go index e7c83f8..71dd1d8 100644 -- - a/internal/secrets/driver/driver.go +++ b/internal/secrets/driver/driver.go @ @ -31,3 +31,13 @ @ type Encrypter interface { // Encrypt encrypts the plaintext and returns the cipher message . Encrypt ( ctx context.Context , plaintext [ ] byte ) ( [ ] byte , error ) } + +// Crypter defines an interface satisfied by implementing both +// Encrypterand Decrypter . This composed interface reflects the +// inherent tie between compatible pairs , ie to decrypt a message , +// Decrypter must be based on the same underlying credentials as +// the Encrypter which encrypted the message . +type Crypter interface { + Encrypter + Decrypter + } diff -- git a/internal/secrets/drivertest/drivertest.go b/internal/secrets/drivertest/drivertest.go new file mode 100644 index 0000000..e4296e3 -- - /dev/null +++ b/internal/secrets/drivertest/drivertest.go @ @ -0,0 +1,74 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing
diff -- git a/internal/secrets/driver/driver.go b/internal/secrets/driver/driver.go index e7c83f8..71dd1d8 100644 -- - a/internal/secrets/driver/driver.go +++ b/internal/secrets/driver/driver.go @ @ -31,3 +31,13 @ @ type Encrypter interface { // Encrypt encrypts the plaintext and returns the cipher message . Encrypt ( ctx context.Context , plaintext [ ] byte ) ( [ ] byte , error ) } + +// Crypter defines an interface satisfied by implementing both +// Encrypterand Decrypter . This composed interface reflects the +// inherent tie between compatible pairs , ie to decrypt a message , +// Decrypter must be based on the same underlying credentials as +// the Encrypter which encrypted the message . +type Crypter interface { + Encrypter + Decrypter + } diff -- git a/internal/secrets/drivertest/drivertest.go b/internal/secrets/drivertest/drivertest.go new file mode 100644 index 0000000..ba352de -- - /dev/null +++ b/internal/secrets/drivertest/drivertest.go @ @ -0,0 +1,74 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing
diff -- git a/blob/blob.go b/blob/blob.go index 84fe943..cfae5e3 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -37,17 +37,19 @ @ import ( // Reader implements io.ReadCloser to read a blob . It must be closed after // reads are finished . type Reader struct { + b driver.Bucket r driver.Reader } // Read implements io.ReadCloser to read from this reader . func ( r *Reader ) Read ( p [ ] byte ) ( int , error ) { - return r.r.Read ( p ) + n , err : = r.r.Read ( p ) + return n , wrapError ( r.b , err ) } // Close implements io.ReadCloser to close this reader . func ( r *Reader ) Close ( ) error { - return r.r.Close ( ) + return wrapError ( r.b , r.r.Close ( ) ) } // ContentType returns the MIME type of the blob object . @ @ -102,6 +104,7 @ @ func ( a *Attributes ) As ( i interface { } ) bool { // Writer implements io.WriteCloser to write to blob . It must be closed after // all writes are done . type Writer struct { + b driver.Bucket w driver.Writer
diff -- git a/runtimevar/runtimeconfigurator/runtimeconfigurator_test.go b/runtimevar/runtimeconfigurator/runtimeconfigurator_test.go index 2dbed6b..a0fdcaa 100644 -- - a/runtimevar/runtimeconfigurator/runtimeconfigurator_test.go +++ b/runtimevar/runtimeconfigurator/runtimeconfigurator_test.go @ @ -147,15 +147,11 @ @ func TestInitialStringWatch ( t *testing.T ) { } want : = `` facepalm :  '' - _ , err = createStringVariable ( ctx , client.client , rn , want ) + _ , done , err = createStringVariable ( ctx , client.client , rn , want ) if err ! = nil { t.Fatal ( err ) } - defer func ( ) { - if err : = deleteConfig ( ctx , client.client , rn ) ; err ! = nil { - t.Fatalf ( `` delete config failed , possible human cleanup required : % v '' , err ) - } - } ( ) + defer done ( ) variable , err : = client.NewVariable ( ctx , rn , runtimevar.StringDecoder , nil ) if err ! = nil { @ @ -193,15 +189,11 @ @ func TestInitialJSONWatch ( t *testing.T ) { } var jsonDataPtr *home want : = & home { `` Batman '' , `` Gotham '' } - _ , err = createByteVariable ( ctx , client.client , rn , [ ]
diff -- git a/.travis.yml b/.travis.yml index 09cb655..122371d 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,6 +23,7 @ @ install : - `` git config -- global core.autocrlf input '' - `` git checkout -- . '' - `` go install ./wire/cmd/wire '' + - `` go install github.com/mattn/goveralls '' script : - 'internal/testing/runchecks.sh' diff -- git a/go.mod b/go.mod index c8ae366..c0a4af1 100644 -- - a/go.mod +++ b/go.mod @ @ -50,6 +50,7 @ @ require ( github.com/jtolds/gls v4.2.1+incompatible // indirect github.com/konsorten/go-windows-terminal-sequences v1.0.1 // indirect github.com/kr/pretty v0.1.0 // indirect + github.com/mattn/goveralls v0.0.2 // indirect github.com/opencensus-integrations/ocsql v0.1.1 github.com/pkg/errors v0.8.0 // indirect github.com/prometheus/client_golang v0.9.0 // indirect diff -- git a/go.sum b/go.sum index 895d80d..597524d 100644 -- - a/go.sum +++ b/go.sum @ @ -87,6 +87,8 @ @ github.com/kr/pretty v0.1.0/go.mod h1 : dAy3ld7l9f0ibDNOQOHHMYYIIbhfbHSm3C4ZsoJORN github.com/kr/pty v1.1.1/go.mod h1 : pFQYn66WHrOpPYNljwOMqo10TkYh1fy3cYio2l3bCsQ= github.com/kr/text v0.1.0 h1:45sCR5RtlFHMR4UwH9sdQ5TC8v0qDQCHnXt+kaKSTVE= github.com/kr/text v0.1.0/go.mod h1:4Jbv+DJW3UT/LiOwJeYQe1efqtUx/iVham/4vfdArNI= +github.com/mattn/goveralls v0.0.2 h1:7eJB6EqsPhRVxvwEXGnqdO2sJI0PTsrWoTMXEk9/OQc= +github.com/mattn/goveralls v0.0.2/go.mod h1:8d1ZMHsd7fW6IRPKQh46F2WRpyib5/X4FOpevwGNQEw= github.com/matttproud/golang_protobuf_extensions v1.0.1 h1:4hp9jkHxhMHkqkrB3Ix0jegS5sx/RkqARlsWZ6pIwiU= github.com/matttproud/golang_protobuf_extensions v1.0.1/go.mod h1 : D8He9yQNgCq6Z5Ld7szi9bcBfOoFv/3dc6xSMkL2PC0= github.com/opencensus-integrations/ocsql v0.1.1 h1 : +J5BmLX1kNWCH9/5wJdleej2oRyJrhVEt+FAjq1VqaI= diff -- git a/internal/testing/runchecks.sh b/internal/testing/runchecks.sh index 4e72f6e..e36d0fa 100755 -- - a/internal/testing/runchecks.sh +++ b/internal/testing/runchecks.sh @ @ -29,7 +29,10 @ @ fi # Run Go tests for each module . result=0 for path in `` . '' `` ./internal/contributebot '' `` ./samples/appengine '' ; do -
diff -- git a/blob/blob_test.go b/blob/blob_test.go deleted file mode 100644 index 34201cf..0000000 -- - a/blob/blob_test.go +++ /dev/null @ @ -1,217 +0,0 @ @ -// Copyright 2018 The Go Cloud Authors -// -// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; -// you may not use this file except in compliance with the License . -// You may obtain a copy of the License at -// -// https : //www.apache.org/licenses/LICENSE-2.0 -// -// Unless required by applicable law or agreed to in writing , software -// distributed under the License is distributed on an `` AS IS '' BASIS , -// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . -// See the License for the specific language governing permissions and -// limitations under the License . - -package blob - -import ( - '' context '' - '' io/ioutil '' - '' path/filepath '' - '' testing '' - - '' github.com/google/go-cloud/blob/driver '' - ) - -func TestNewRangeReader ( t *testing.T ) { - t.Run ( `` EntireBlob '' , func ( t *testing.T ) { - const key = `` foo '' - spy : = new ( bucketSpy )
diff -- git a/internal/pubsub/pubsub.go b/internal/pubsub/pubsub.go index 44c8fae..668b809 100644 -- - a/internal/pubsub/pubsub.go +++ b/internal/pubsub/pubsub.go @ @ -30,22 +30,15 @ @ type Message struct { // Metadata has key/value metadata for the message . Metadata map [ string ] string - // AckID identifies the message on the server . - // It can be used to ack the message after it has been received . - ackID driver.AckID - - // sub is the Subscription this message was received from . - sub *Subscription + // ack is a closure that queues this message for acknowledgement . + ack func ( ) } // Ack acknowledges the message , telling the server that it does not need to be // sent again to the associated Subscription . It returns immediately , but the // actual ack is sent in the background , and is not guaranteed to succeed . func ( m *Message ) Ack ( ) { - // Send the message back to the subscription for ack batching . - // size is an estimate of the size of a single AckID in bytes . - const size = 8 - go m.sub.ackBatcher.Add ( m , size ) +
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 2019ddc..d41d9f3 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -53,12 +53,6 @ @ func RunConformanceTests ( t *testing.T , newHarness HarnessMaker ) { t.Run ( `` TestSendReceive '' , func ( t *testing.T ) { testSendReceive ( t , newHarness ) } ) - t.Run ( `` TestErrorOnSendToClosedTopic '' , func ( t *testing.T ) { - testErrorOnSendToClosedTopic ( t , newHarness ) - } ) - t.Run ( `` TestErrorOnReceiveFromClosedSubscription '' , func ( t *testing.T ) { - testErrorOnReceiveFromClosedSubscription ( t , newHarness ) - } ) t.Run ( `` TestCancelSendReceive '' , func ( t *testing.T ) { testCancelSendReceive ( t , newHarness ) } ) @ @ -108,47 +102,6 @ @ func testSendReceive ( t *testing.T , newHarness HarnessMaker ) { } } -func testErrorOnSendToClosedTopic ( t *testing.T , newHarness HarnessMaker ) { - // Set up . - ctx : = context.Background ( ) - h , err : = newHarness ( ctx , t ) - if err ! = nil { - t.Fatal ( err ) - } - defer h.Close ( ) - top , _ , cleanup , err : = makePair ( ctx ,
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 2019ddc..a20970c 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -17,10 +17,10 @ @ package drivertest import ( - '' bytes '' '' context '' '' fmt '' '' math/rand '' + '' sort '' '' testing '' '' github.com/google/go-cloud/internal/pubsub '' @ @ -53,12 +53,6 @ @ func RunConformanceTests ( t *testing.T , newHarness HarnessMaker ) { t.Run ( `` TestSendReceive '' , func ( t *testing.T ) { testSendReceive ( t , newHarness ) } ) - t.Run ( `` TestErrorOnSendToClosedTopic '' , func ( t *testing.T ) { - testErrorOnSendToClosedTopic ( t , newHarness ) - } ) - t.Run ( `` TestErrorOnReceiveFromClosedSubscription '' , func ( t *testing.T ) { - testErrorOnReceiveFromClosedSubscription ( t , newHarness ) - } ) t.Run ( `` TestCancelSendReceive '' , func ( t *testing.T ) { testCancelSendReceive ( t , newHarness ) } ) @ @ -80,6 +74,7 @ @ func testSendReceive ( t *testing.T , newHarness HarnessMaker ) { // Send to the topic . ms : = [ ] *pubsub.Message { } + ss : = [ ] string { } for i : = 0 ; i < 3 ; i++ { m
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 2019ddc..a20970c 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -17,10 +17,10 @ @ package drivertest import ( - '' bytes '' '' context '' '' fmt '' '' math/rand '' + '' sort '' '' testing '' '' github.com/google/go-cloud/internal/pubsub '' @ @ -53,12 +53,6 @ @ func RunConformanceTests ( t *testing.T , newHarness HarnessMaker ) { t.Run ( `` TestSendReceive '' , func ( t *testing.T ) { testSendReceive ( t , newHarness ) } ) - t.Run ( `` TestErrorOnSendToClosedTopic '' , func ( t *testing.T ) { - testErrorOnSendToClosedTopic ( t , newHarness ) - } ) - t.Run ( `` TestErrorOnReceiveFromClosedSubscription '' , func ( t *testing.T ) { - testErrorOnReceiveFromClosedSubscription ( t , newHarness ) - } ) t.Run ( `` TestCancelSendReceive '' , func ( t *testing.T ) { testCancelSendReceive ( t , newHarness ) } ) @ @ -80,6 +74,7 @ @ func testSendReceive ( t *testing.T , newHarness HarnessMaker ) { // Send to the topic . ms : = [ ] *pubsub.Message { } + ss : = [ ] string { } for i : = 0 ; i < 3 ; i++ { m
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 2019ddc..84cbee2 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -99,6 +99,7 @ @ func testSendReceive ( t *testing.T , newHarness HarnessMaker ) { t.Fatal ( err ) } ms2 = append ( ms2 , m2 ) + m2.Ack ( ) } // Check that the received messages match the sent ones .
diff -- git a/internal/pubsub/gcppubsub/gcppubsub.go b/internal/pubsub/gcppubsub/gcppubsub.go index f3d08a5..b4683b0 100644 -- - a/internal/pubsub/gcppubsub/gcppubsub.go +++ b/internal/pubsub/gcppubsub/gcppubsub.go @ @ -51,26 +51,29 @ @ func OpenTopic ( ctx context.Context , client *raw.PublisherClient , proj gcp.Projec // openTopic returns the driver for OpenTopic . This function exists so the test // harness can get the driver interface implementation if it needs to . func openTopic ( ctx context.Context , client *raw.PublisherClient , proj gcp.ProjectID , topicName string ) ( driver.Topic , error ) { + path : = fmt.Sprintf ( `` projects/ % s/topics/ % s '' , proj , topicName ) client , err : = raw.NewPublisherClient ( ctx ) if err ! = nil { return nil , fmt.Errorf ( `` gcppubsub : creating publisher client : % v '' , err ) } - ok , err : = topicExists ( ctx , client , topicName ) + ok , err : = topicExists ( ctx , client , path ) if err ! = nil { return nil , fmt.Errorf ( `` gcppubsub : checking existence of topic : % v '' , err ) } if ! ok { return nil , fmt.Errorf ( `` gcppubsub : topic named % q
diff -- git a/AUTHORS b/AUTHORS index f521b6d..b31fb2a 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -69,6 +69,7 @ @ i2bskn < i2bskn @ gmail.com > Isao Jonas < isao.jonas @ gmail.com > isqua < isqua @ isqua.ru > Jameel Haffejee < RC1140 @ republiccommandos.co.za > +Jeremy Morris < jeremylevanmorris @ gmail.com > Jihoon Chung < j.c @ navercorp.com > Joe Tsai < joetsai @ digital-static.net > John Engelman < john.r.engelman @ gmail.com > diff -- git a/github/apps.go b/github/apps.go index ff33893..4c3e7c6 100644 -- - a/github/apps.go +++ b/github/apps.go @ @ -37,4 +37,4 @ @ func ( s *AppsService ) ListInstallations ( ctx context.Context , opt *ListOptions ) ( } return i , resp , nil - } + } \ No newline at end of file diff -- git a/github/apps_installation.go b/github/apps_installation.go index 6a27799..15172c0 100644 -- - a/github/apps_installation.go +++ b/github/apps_installation.go @ @ -47,3 +47,40 @ @ func ( s *AppsService ) ListRepos ( ctx context.Context , opt *ListOptions ) ( [ ] *Repos return r.Repositories , resp , nil } + +// AddRepository adds a single repository to an installation . +// +// GitHub API docs : https : //developer.github.com/v3/apps/installations/ # add-repository-to-installation +func ( s *AppService ) AddRepository ( ctx context.Context , installationID
diff -- git a/github/repos_collaborators.go b/github/repos_collaborators.go index 68a9f46..5eb0ec5 100644 -- - a/github/repos_collaborators.go +++ b/github/repos_collaborators.go @ @ -49,6 +49,35 @ @ func ( s *RepositoriesService ) IsCollaborator ( owner , repo , user string ) ( bool , *R return isCollab , resp , err } +// RepositoryPermissionLevel represents the permission level an organization +// member has for a given repository . +type RepositoryPermissionLevel struct { + // Possible values : `` admin '' , `` write '' , `` read '' , `` none '' + Permission *string ` json : '' permission , omitempty '' ` + + User *User ` json : '' user , omitempty '' ` + } + +// GetPermissionLevel retrieves the specific permission level a collaborator has for a given repository . +// GitHub API docs : https : //developer.github.com/v3/repos/collaborators/ # review-a-users-permission-level +func ( s *RepositoriesService ) GetPermissionLevel ( owner , repo , user string ) ( *RepositoryPermissionLevel , *Response , error ) { + u : = fmt.Sprintf ( `` repos/ % v/ % v/collaborators/ % v/permission '' , owner , repo , user ) + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err
diff -- git a/github/github.go b/github/github.go index 46731a3..1a8f10c 100644 -- - a/github/github.go +++ b/github/github.go @ @ -51,9 +51,6 @ @ const ( // https : //developer.github.com/changes/2014-12-09-new-attributes-for-stars-api/ mediaTypeStarringPreview = `` application/vnd.github.v3.star+json '' - // https : //developer.github.com/changes/2015-11-11-protected-branches-api/ - mediaTypeProtectedBranchesPreview = `` application/vnd.github.loki-preview+json '' - // https : //help.github.com/enterprise/2.4/admin/guides/migrations/exporting-the-github-com-organization-s-repositories/ mediaTypeMigrationsPreview = `` application/vnd.github.wyandotte-preview+json '' @ @ -113,6 +110,9 @ @ const ( // https : //developer.github.com/changes/2018-01-25-organization-invitation-api-preview/ mediaTypeOrganizationInvitationPreview = `` application/vnd.github.dazzler-preview+json '' + + // https : //developer.github.com/changes/2018-03-16-protected-branches-required-approving-reviews/ + mediaTypeRequiredApprovingReviewsPreview = `` application/vnd.github.luke-cage-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/repos.go b/github/repos.go index aa9b6ac..191c60d 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -565,6 +565,9 @ @ type PullRequestReviewsEnforcement struct { DismissStaleReviews bool ` json : '' dismiss_stale_reviews '' ` // RequireCodeOwnerReviews specifies if an approved review is required in pull requests including files with a designated code owner . RequireCodeOwnerReviews bool ` json : '' require_code_owner_reviews '' ` + // RequiredApprovingReviewCount specifies the number of approvals required before the pull request can be merged . + // Valid values are 1-6 . + RequiredApprovingReviewCount int ` json : '' required_approving_review_count '' ` } // PullRequestReviewsEnforcementRequest represents request to set the pull request review @ @ -579,6
diff -- git a/github/github.go b/github/github.go index 6da27b1..f04a011 100644 -- - a/github/github.go +++ b/github/github.go @ @ -87,6 +87,9 @ @ const ( // https : //developer.github.com/v3/repos/traffic/ mediaTypeTrafficPreview = `` application/vnd.github.spiderman-preview+json '' + + // https : //developer.github.com/changes/2016-09-14-projects-api/ + mediaTypeProjectsPreview = `` application/vnd.github.inertia-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/repos_projects.go b/github/repos_projects.go new file mode 100644 index 0000000..d734c2d -- - /dev/null +++ b/github/repos_projects.go @ @ -0,0 +1,496 @ @ +// Copyright 2016 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import `` fmt '' + +// Projects represents a Project 's configuration of a GitHub Repository +type RepositoryProject struct { + ID *int ` json : '' id , omitempty '' ` + Name *string ` json : '' name , omitempty '' ` + Body *string ` json : '' body , omitempty '' ` + URL *string ` json : '' url , omitempty '' ` + OwnerURL *string ` json : '' url , omitempty '' ` + Number *int ` json : ''
diff -- git a/github/activity_events_test.go b/github/activity_events_test.go index dc92a98..0b01c4a 100644 -- - a/github/activity_events_test.go +++ b/github/activity_events_test.go @ @ -88,7 +88,7 @ @ func TestActivityService_ListIssueEventsForRepository ( t *testing.T ) { t.Errorf ( `` Activities.ListIssueEventsForRepository returned error : % v '' , err ) } - want : = [ ] *IssueEvent { { ID : Int ( 1 ) } , { ID : Int ( 2 ) } } + want : = [ ] *IssueEvent { { ID : Int64 ( 1 ) } , { ID : Int64 ( 2 ) } } if ! reflect.DeepEqual ( events , want ) { t.Errorf ( `` Activities.ListIssueEventsForRepository returned % +v , want % +v '' , events , want ) } @ @ -301,7 +301,7 @ @ func TestActivityService_EventParsePayload_typed ( t *testing.T ) { t.Fatalf ( `` Unmarshal Event returned error : % v '' , err ) } - want : = & PushEvent { PushID : Int ( 1 ) } + want : = & PushEvent { PushID : Int64 ( 1 ) } got , err : = event.ParsePayload ( ) if err ! = nil { t.Fatalf ( `` ParsePayload returned unexpected error : % v ''
diff -- git a/github/checks.go b/github/checks.go index 2a6ce41..14f5fbe 100644 -- - a/github/checks.go +++ b/github/checks.go @ @ -133,16 +133,24 @ @ func ( s *ChecksService ) GetCheckSuite ( ctx context.Context , owner , repo string , c // CreateCheckRunOptions sets up parameters needed to create a CheckRun . type CreateCheckRunOptions struct { - Name string ` json : '' name '' ` // The name of the check ( e.g. , `` code-coverage '' ) . ( Required . ) - HeadBranch string ` json : '' head_branch '' ` // The name of the branch to perform a check against . ( Required . ) - HeadSHA string ` json : '' head_sha '' ` // The SHA of the commit . ( Required . ) - DetailsURL *string ` json : '' details_url , omitempty '' ` // The URL of the integrator 's site that has the full details of the check . ( Optional . ) - ExternalID *string ` json : '' external_id , omitempty '' ` // A reference for the run on the integrator 's system . ( Optional . ) - Status *string ` json : '' status , omitempty '' ` // The
diff -- git a/github/github.go b/github/github.go index ba34310..8b2df80 100644 -- - a/github/github.go +++ b/github/github.go @ @ -97,6 +97,9 @ @ const ( // https : //developer.github.com/changes/2016-12-14-reviews-api/ mediaTypePullRequestReviewsPreview = `` application/vnd.github.black-cat-preview+json '' + + // https : //developer.github.com/changes/2017-02-28-user-blocking-apis-and-webhook/ + mediaTypeBlockUsersPreview = `` application/vnd.github.giant-sentry-fist-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/users_blocking.go b/github/users_blocking.go new file mode 100644 index 0000000..967ee5f -- - /dev/null +++ b/github/users_blocking.go @ @ -0,0 +1,91 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// ListBlockedUsers lists all the blocked users by the authenticated user . +// +// GitHub API docs : https : //developer.github.com/v3/users/blocking/ # list-blocked-users +func ( s *UsersService ) ListBlockedUsers ( ctx context.Context , opt *ListOptions ) ( [ ] *User , *Response , error ) { + u : = `` user/blocks '' + u , err : = addOptions ( u , opt ) + if err ! = nil { + return
diff -- git a/github/orgs_members.go b/github/orgs_members.go index 80454ad..957674c 100644 -- - a/github/orgs_members.go +++ b/github/orgs_members.go @ @ -270,3 +270,33 @ @ func ( s *OrganizationsService ) RemoveOrgMembership ( user , org string ) ( *Response , return s.client.Do ( req , nil ) } + +//ListPendingOrgInvitations returns a list of contains a role field which refers to the +//Organization Invitation role and will be one of the following values : +//direct_member , admin , billing_manager , hiring_manager , or reinstate . +//If the invitee is not a GitHub member , the login field in the return hash will be null . +// +// GitHub API docs : +// https : //developer.github.com/v3/orgs/members/ # list-pending-organization-invitations +func ( s *OrganizationsService ) ListPendingOrgInvitations ( org int , opt *ListOptions ) ( [ ] *Invitation , *Response , error ) { + u : = fmt.Sprintf ( `` orgs/ % v/invitations '' , org ) + u , err : = addOptions ( u , opt ) + if err ! = nil { + return nil , nil , err + } + + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil {
diff -- git a/github/orgs_members.go b/github/orgs_members.go index 80454ad..77f6912 100644 -- - a/github/orgs_members.go +++ b/github/orgs_members.go @ @ -270,3 +270,29 @ @ func ( s *OrganizationsService ) RemoveOrgMembership ( user , org string ) ( *Response , return s.client.Do ( req , nil ) } + +// ListPendingOrgInvitations returns a list of pending invitations . +// +// GitHub API docs : https : //developer.github.com/v3/orgs/members/ # list-pending-organization-invitations +func ( s *OrganizationsService ) ListPendingOrgInvitations ( org int , opt *ListOptions ) ( [ ] *Invitation , *Response , error ) { + u : = fmt.Sprintf ( `` orgs/ % v/invitations '' , org ) + u , err : = addOptions ( u , opt ) + if err ! = nil { + return nil , nil , err + } + + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil { + return nil , nil , err + } + + // TODO : remove custom Accept header when this API fully launches . + req.Header.Set ( `` Accept '' , mediaTypeOrgMembershipPreview ) + + pendingInvitations : = new ( [ ] *Invitation ) + resp , err
diff -- git a/github/github.go b/github/github.go index f3eadce..93df714 100644 -- - a/github/github.go +++ b/github/github.go @ @ -113,6 +113,9 @ @ const ( // https : //developer.github.com/changes/2017-12-19-graphql-node-id/ mediaTypeGraphQLNodeIDPreview = `` application/vnd.github.jean-grey-preview+json '' + + // https : //developer.github.com/changes/2018-01-25-organization-invitation-api-preview/ + mediaTypeOrganizationInvitationPreview = `` application/vnd.github.dazzler-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/orgs_members.go b/github/orgs_members.go index d0ea6a9..29deeb1 100644 -- - a/github/orgs_members.go +++ b/github/orgs_members.go @ @ -297,3 +297,44 @ @ func ( s *OrganizationsService ) ListPendingOrgInvitations ( ctx context.Context , or } return pendingInvitations , resp , nil } + +// CreateOrgInvitationOptions specifies the parameters to the OrganizationService.Invite +// method . +type CreateOrgInvitationOptions struct { + InviteeID *int ` json : '' invitee_id , omitempty '' ` + Email *string ` json : '' email , omitempty '' ` + // Specify role for new member . Can be one of : + // * admin - Organization owners with full administrative rights to the + // organization and complete access to all repositories and teams . + // * direct_member - Non-owner organization members with ability to see + // other members and join teams by invitation . + // * billing_manager - Non-owner organization members with
diff -- git a/github/github.go b/github/github.go index d96fa85..9c36013 100644 -- - a/github/github.go +++ b/github/github.go @ @ -501,6 +501,18 @ @ func ( r *RateLimitError ) Error ( ) string { r.Response.StatusCode , r.Message , r.Rate.Reset.Time.Sub ( time.Now ( ) ) ) } +// AcceptedError occurs when GitHub returns 202 Accepted response with an +// empty body , which means a job was scheduled on the GitHub side to process +// the information needed and cache it . +// Technically , 202 Accepted is not a real error , it 's just used to +// indicate that results are not ready yet , but should be available soon . +// The request can be repeated after some time . +type AcceptedError struct { } + +func ( *AcceptedError ) Error ( ) string { + return `` job scheduled on github side , try again later '' + } + // AbuseRateLimitError occurs when GitHub returns 403 Forbidden response with the // `` documentation_url '' field value equal to `` https : //developer.github.com/v3 # abuse-rate-limits '' . type AbuseRateLimitError struct { @ @ -564,14 +576,19 @ @ func ( e *Error ) Error ( ) string { } // CheckResponse checks the
diff -- git a/github/repos.go b/github/repos.go index 040cd31..ea886bd 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -508,14 +508,16 @ @ type Branch struct { // Protection represents a repository branch 's protection . type Protection struct { - RequiredStatusChecks *RequiredStatusChecks ` json : '' required_status_checks '' ` - Restrictions *BranchRestrictions ` json : '' restrictions '' ` + RequiredStatusChecks *RequiredStatusChecks ` json : '' required_status_checks '' ` + RequiredPullRequestReviews *RequiredPullRequestReviews ` json : '' required_pull_request_reviews '' ` + Restrictions *BranchRestrictions ` json : '' restrictions '' ` } // ProtectionRequest represents a request to create/edit a branch 's protection . type ProtectionRequest struct { - RequiredStatusChecks *RequiredStatusChecks ` json : '' required_status_checks '' ` - Restrictions *BranchRestrictionsRequest ` json : '' restrictions '' ` + RequiredStatusChecks *RequiredStatusChecks ` json : '' required_status_checks '' ` + RequiredPullRequestReviews *RequiredPullRequestReviews ` json : '' required_pull_request_reviews '' ` + Restrictions *BranchRestrictionsRequest ` json : '' restrictions '' ` } // RequiredStatusChecks represents the protection status of a individual branch . @ @ -529,6 +531,12 @ @ type RequiredStatusChecks struct { Contexts * [ ] string ` json : '' contexts , omitempty '' ` } +// RequiredPullRequestReviews represents the protection configuration for pull requests .
diff -- git a/github/repos_releases.go b/github/repos_releases.go index bca0f08..d5dfc70 100644 -- - a/github/repos_releases.go +++ b/github/repos_releases.go @ @ -251,10 +251,7 @ @ func ( s *RepositoriesService ) DownloadReleaseAsset ( ctx context.Context , owner , r if err ! = nil { return nil , `` '' , err } - - // TODO : remove custom Accept header when APIs fully launch . - acceptHeaders : = [ ] string { defaultMediaType , mediaTypeGraphQLNodeIDPreview } - req.Header.Set ( `` Accept '' , strings.Join ( acceptHeaders , `` , `` ) ) + req.Header.Set ( `` Accept '' , defaultMediaType ) s.client.clientMu.Lock ( ) defer s.client.clientMu.Unlock ( ) diff -- git a/github/repos_releases_test.go b/github/repos_releases_test.go index 6533119..aba0dab 100644 -- - a/github/repos_releases_test.go +++ b/github/repos_releases_test.go @ @ -220,10 +220,9 @ @ func TestRepositoriesService_DownloadReleaseAsset_Stream ( t *testing.T ) { client , mux , _ , teardown : = setup ( ) defer teardown ( ) - acceptHeaders : = [ ] string { defaultMediaType , mediaTypeGraphQLNodeIDPreview } mux.HandleFunc ( `` /repos/o/r/releases/assets/1 '' , func ( w http.ResponseWriter , r *http.Request ) { testMethod ( t , r , `` GET '' ) - testHeader ( t , r , `` Accept '' , strings.Join ( acceptHeaders , `` ,
diff -- git a/github/github.go b/github/github.go index 6d4e777..a58dbfb 100644 -- - a/github/github.go +++ b/github/github.go @ @ -96,6 +96,9 @ @ const ( // https : //developer.github.com/changes/2017-01-05-commit-search-api/ mediaTypeCommitSearchPreview = `` application/vnd.github.cloak-preview+json '' + + // https : //developer.github.com/changes/2016-12-14-reviews-api/ + mediaTypePullRequestReviewsPreview = `` application/vnd.github.black-cat-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/pulls_reviews.go b/github/pulls_reviews.go index ae3cdd4..f6acf28 100644 -- - a/github/pulls_reviews.go +++ b/github/pulls_reviews.go @ @ -5,15 +5,166 @ @ package github -import `` time '' +import ( + '' fmt '' + '' time '' + ) // PullRequestReview represents a review of a pull request . type PullRequestReview struct { - ID *int ` json : '' id , omitempty '' ` - User *User ` json : '' user , omitempty '' ` - Body *string ` json : '' body , omitempty '' ` - SubmittedAt *time.Time ` json : '' submitted_at , omitempty '' ` + ID *int ` json : '' id , omitempty '' ` + User *User ` json : '' user , omitempty '' ` + Body *string ` json : '' body , omitempty '' ` + SubmittedAt *time.Time ` json : '' submitted_at , omitempty '' `
diff -- git a/github/activity_events_test.go b/github/activity_events_test.go index 2b59d11..9234548 100644 -- - a/github/activity_events_test.go +++ b/github/activity_events_test.go @ @ -15,7 +15,7 @ @ import ( ) func TestActivityService_ListEvents ( t *testing.T ) { - setup ( ) + _ , mux , client , teardown : = setup ( ) defer teardown ( ) mux.HandleFunc ( `` /events '' , func ( w http.ResponseWriter , r *http.Request ) { @ @ -39,7 +39,7 @ @ func TestActivityService_ListEvents ( t *testing.T ) { } func TestActivityService_ListRepositoryEvents ( t *testing.T ) { - setup ( ) + _ , mux , client , teardown : = setup ( ) defer teardown ( ) mux.HandleFunc ( `` /repos/o/r/events '' , func ( w http.ResponseWriter , r *http.Request ) { @ @ -63,12 +63,15 @ @ func TestActivityService_ListRepositoryEvents ( t *testing.T ) { } func TestActivityService_ListRepositoryEvents_invalidOwner ( t *testing.T ) { + _ , _ , client , teardown : = setup ( ) + defer teardown ( ) + _ , _ , err : = client.Activity.ListRepositoryEvents ( context.Background ( ) , `` % '' , `` % '' , nil ) testURLParseError ( t , err ) } func TestActivityService_ListIssueEventsForRepository ( t *testing.T ) { -
diff -- git a/github/users_blocking.go b/github/users_blocking.go new file mode 100644 index 0000000..0a29530 -- - /dev/null +++ b/github/users_blocking.go @ @ -0,0 +1,79 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// ListBlockedUsers lists all the blocked users by the authenticated user +// +// GitHub API docs : https : //developer.github.com/v3/users/blocking/ # list-blocked-users +func ( s *UsersService ) ListBlockedUsers ( ctx context.Context , opt *ListOptions ) ( [ ] *User , *Response , error ) { + u : = `` user/blocks '' + u , err : = addOptions ( u , opt ) + if err ! = nil { + return nil , nil , err + } + + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil { + return nil , nil , err + } + + var blockedUsers [ ] *User + resp , err : = s.client.Do
diff -- git a/github/users_blocking.go b/github/users_blocking.go new file mode 100644 index 0000000..0a29530 -- - /dev/null +++ b/github/users_blocking.go @ @ -0,0 +1,79 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// ListBlockedUsers lists all the blocked users by the authenticated user +// +// GitHub API docs : https : //developer.github.com/v3/users/blocking/ # list-blocked-users +func ( s *UsersService ) ListBlockedUsers ( ctx context.Context , opt *ListOptions ) ( [ ] *User , *Response , error ) { + u : = `` user/blocks '' + u , err : = addOptions ( u , opt ) + if err ! = nil { + return nil , nil , err + } + + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil { + return nil , nil , err + } + + var blockedUsers [ ] *User + resp , err : = s.client.Do
diff -- git a/github/gen-accessors.go b/github/gen-accessors.go index 131c56c..42fb1ec 100644 -- - a/github/gen-accessors.go +++ b/github/gen-accessors.go @ @ -155,7 +155,7 @ @ func ( t *templateData ) dump ( ) error { return ioutil.WriteFile ( t.filename , clean , 0644 ) } -func newGetter ( receiverType , fieldName , fieldType , zeroValue string ) *getter { +func newGetter ( receiverType , fieldName , fieldType , zeroValue string , namedStruct bool ) *getter { return & getter { sortVal : strings.ToLower ( receiverType ) + `` . '' + strings.ToLower ( fieldName ) , ReceiverVar : strings.ToLower ( receiverType [ :1 ] ) , @ @ -163,6 +163,7 @ @ func newGetter ( receiverType , fieldName , fieldType , zeroValue string ) *getter { FieldName : fieldName , FieldType : fieldType , ZeroValue : zeroValue , + NamedStruct : namedStruct , } } @ @ -176,11 +177,12 @ @ func ( t *templateData ) addArrayType ( x *ast.ArrayType , receiverType , fieldName st return } - t.Getters = append ( t.Getters , newGetter ( receiverType , fieldName , `` [ ] '' +eltType , `` nil '' ) ) + t.Getters = append ( t.Getters , newGetter ( receiverType , fieldName , `` [
diff -- git a/github/gen-accessors.go b/github/gen-accessors.go index 131c56c..34dcf1a 100644 -- - a/github/gen-accessors.go +++ b/github/gen-accessors.go @ @ -155,7 +155,7 @ @ func ( t *templateData ) dump ( ) error { return ioutil.WriteFile ( t.filename , clean , 0644 ) } -func newGetter ( receiverType , fieldName , fieldType , zeroValue string ) *getter { +func newGetter ( receiverType , fieldName , fieldType , zeroValue string , namedStruct bool ) *getter { return & getter { sortVal : strings.ToLower ( receiverType ) + `` . '' + strings.ToLower ( fieldName ) , ReceiverVar : strings.ToLower ( receiverType [ :1 ] ) , @ @ -163,6 +163,7 @ @ func newGetter ( receiverType , fieldName , fieldType , zeroValue string ) *getter { FieldName : fieldName , FieldType : fieldType , ZeroValue : zeroValue , + NamedStruct : namedStruct , } } @ @ -176,11 +177,12 @ @ func ( t *templateData ) addArrayType ( x *ast.ArrayType , receiverType , fieldName st return } - t.Getters = append ( t.Getters , newGetter ( receiverType , fieldName , `` [ ] '' +eltType , `` nil '' ) ) + t.Getters = append ( t.Getters , newGetter ( receiverType , fieldName , `` [
diff -- git a/github/github-accessors.go b/github/github-accessors.go index 5b09491..4d1aad3 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -564,6 +564,38 @ @ func ( c *CommitsComparison ) GetBehindBy ( ) int { return *c.BehindBy } +// GetDiffURL returns the DiffURL field if it 's non-nil , zero value otherwise . +func ( c *CommitsComparison ) GetDiffURL ( ) string { + if c == nil || c.DiffURL == nil { + return `` '' + } + return *c.DiffURL + } + +// GetHTMLURL returns the HTMLURL field if it 's non-nil , zero value otherwise . +func ( c *CommitsComparison ) GetHTMLURL ( ) string { + if c == nil || c.HTMLURL == nil { + return `` '' + } + return *c.HTMLURL + } + +// GetPatchURL returns the PatchURL field if it 's non-nil , zero value otherwise . +func ( c *CommitsComparison ) GetPatchURL ( ) string { + if c == nil || c.PatchURL == nil { + return `` '' + } + return *c.PatchURL + } + +// GetPermalinkURL returns the PermalinkURL field if it 's non-nil , zero value otherwise . +func ( c *CommitsComparison ) GetPermalinkURL ( ) string { + if
diff -- git a/github/activity_events.go b/github/activity_events.go index f9c8f53..f749f6d 100644 -- - a/github/activity_events.go +++ b/github/activity_events.go @ @ -49,8 +49,6 @ @ func ( e *Event ) Payload ( ) ( payload interface { } ) { payload = & IntegrationInstallationEvent { } case `` IntegrationInstallationRepositoriesEvent '' : payload = & IntegrationInstallationRepositoriesEvent { } - case `` IssueActivityEvent '' : - payload = & IssueActivityEvent { } case `` IssueCommentEvent '' : payload = & IssueCommentEvent { } case `` IssuesEvent '' : diff -- git a/github/event_types.go b/github/event_types.go index f06bd68..b98492e 100644 -- - a/github/event_types.go +++ b/github/event_types.go @ @ -130,19 +130,6 @ @ type GollumEvent struct { Installation *Installation ` json : '' installation , omitempty '' ` } -// IssueActivityEvent represents the payload delivered by Issue webhook . -// -// Deprecated : Use IssuesEvent instead . -type IssueActivityEvent struct { - Action *string ` json : '' action , omitempty '' ` - Issue *Issue ` json : '' issue , omitempty '' ` - - // The following fields are only populated by Webhook events . - Repo *Repository ` json : '' repository , omitempty '' ` - Sender *User ` json : '' sender , omitempty '' ` - Installation
diff -- git a/github/github.go b/github/github.go index a0c78aa..58324a7 100644 -- - a/github/github.go +++ b/github/github.go @ @ -51,9 +51,6 @ @ const ( // https : //developer.github.com/changes/2014-12-09-new-attributes-for-stars-api/ mediaTypeStarringPreview = `` application/vnd.github.v3.star+json '' - // https : //developer.github.com/changes/2015-11-11-protected-branches-api/ - mediaTypeProtectedBranchesPreview = `` application/vnd.github.loki-preview+json '' - // https : //help.github.com/enterprise/2.4/admin/guides/migrations/exporting-the-github-com-organization-s-repositories/ mediaTypeMigrationsPreview = `` application/vnd.github.wyandotte-preview+json '' @ @ -114,11 +111,16 @ @ const ( // https : //developer.github.com/changes/2018-01-25-organization-invitation-api-preview/ mediaTypeOrganizationInvitationPreview = `` application/vnd.github.dazzler-preview+json '' + + // https : //developer.github.com/changes/2018-03-16-protected-branches-required-approving-reviews/ + mediaTypeRequiredApprovingReviewsPreview = `` application/vnd.github.luke-cage-preview+json '' + // https : //developer.github.com/changes/2018-02-22-label-description-search-preview/ mediaTypeLabelDescriptionSearchPreview = `` application/vnd.github.symmetra-preview+json '' // https : //developer.github.com/changes/2018-02-07-team-discussions-api/ mediaTypeTeamDiscussionsPreview = `` application/vnd.github.echo-preview+json '' + ) // A Client manages communication with the GitHub API . diff -- git a/github/repos.go b/github/repos.go index aa9b6ac..191c60d 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -565,6 +565,9 @ @ type PullRequestReviewsEnforcement struct { DismissStaleReviews bool ` json : '' dismiss_stale_reviews '' ` // RequireCodeOwnerReviews specifies if an approved review is required in pull requests including files with a designated code owner . RequireCodeOwnerReviews bool ` json : '' require_code_owner_reviews '' ` + // RequiredApprovingReviewCount specifies the number of approvals required before the pull request can be merged . + // Valid values are 1-6 . + RequiredApprovingReviewCount int `
diff -- git a/github/gists.go b/github/gists.go index 15276ea..9108b64 100644 -- - a/github/gists.go +++ b/github/gists.go @ @ -30,6 +30,7 @ @ type Gist struct { GitPushURL *string ` json : '' git_push_url , omitempty '' ` CreatedAt *time.Time ` json : '' created_at , omitempty '' ` UpdatedAt *time.Time ` json : '' updated_at , omitempty '' ` + NodeID *string ` json : '' node_id , omitempty '' ` } func ( g Gist ) String ( ) string { @ @ -60,6 +61,7 @ @ type GistCommit struct { User *User ` json : '' user , omitempty '' ` ChangeStatus *CommitStats ` json : '' change_status , omitempty '' ` CommittedAt *Timestamp ` json : '' committed_at , omitempty '' ` + NodeID *string ` json : '' node_id , omitempty '' ` } func ( gc GistCommit ) String ( ) string { @ @ -73,6 +75,7 @ @ type GistFork struct { ID *string ` json : '' id , omitempty '' ` CreatedAt *Timestamp ` json : '' created_at , omitempty '' ` UpdatedAt *Timestamp ` json : '' updated_at , omitempty '' ` + NodeID *string ` json : '' node_id , omitempty '' `
diff -- git a/github/checks.go b/github/checks.go new file mode 100644 index 0000000..2dff2ca -- - /dev/null +++ b/github/checks.go @ @ -0,0 +1,132 @ @ +// Copyright 2018 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + '' strings '' + '' time '' + ) + +// ChecksService provides access to the the Checks API in the +// GitHub API . +// +// GitHub API docs : https : //developer.github.com/v3/checks/ +type ChecksService service + +// CheckRun represents a GitHub check run on a repository associated with a GitHub app +type CheckRun struct { + ID *int64 ` json : '' id , omitempty '' ` + HeadSHA *string ` json : '' head_sha , omitempty '' ` + ExternalID *int64 ` json : '' external_id , omitempty '' ` + URL *string ` json : '' url , omitempty '' ` + HTMLURL *string ` json : '' html_url , omitempty '' ` + Status *string ` json : '' status , omitempty '' `
diff -- git a/github/checks.go b/github/checks.go new file mode 100644 index 0000000..162fba0 -- - /dev/null +++ b/github/checks.go @ @ -0,0 +1,156 @ @ +// Copyright 2018 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// ChecksService provides access to the Checks API in the +// GitHub API . +// +// GitHub API docs : https : //developer.github.com/v3/checks/ +type ChecksService service + +// CheckRun represents a GitHub check run on a repository associated with a GitHub app . +type CheckRun struct { + ID *int64 ` json : '' id , omitempty '' ` + HeadSHA *string ` json : '' head_sha , omitempty '' ` + ExternalID *int64 ` json : '' external_id , omitempty '' ` + URL *string ` json : '' url , omitempty '' ` + HTMLURL *string ` json : '' html_url , omitempty '' ` + Status *string ` json : '' status , omitempty '' ` + Conclusion *string ` json : '' conclusion
diff -- git a/github/checks.go b/github/checks.go new file mode 100644 index 0000000..35c81d8 -- - /dev/null +++ b/github/checks.go @ @ -0,0 +1,225 @ @ +// Copyright 2018 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// ChecksService provides access to the Checks API in the +// GitHub API . +// +// GitHub API docs : https : //developer.github.com/v3/checks/ +type ChecksService service + +// CheckRun represents a GitHub check run on a repository associated with a GitHub app . +type CheckRun struct { + ID *int64 ` json : '' id , omitempty '' ` + HeadSHA *string ` json : '' head_sha , omitempty '' ` + ExternalID *string ` json : '' external_id , omitempty '' ` + URL *string ` json : '' url , omitempty '' ` + HTMLURL *string ` json : '' html_url , omitempty '' ` + Status *string ` json : '' status , omitempty '' ` + Conclusion *string ` json : '' conclusion
diff -- git a/github/checks.go b/github/checks.go new file mode 100644 index 0000000..daed1f7 -- - /dev/null +++ b/github/checks.go @ @ -0,0 +1,332 @ @ +// Copyright 2018 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// ChecksService provides access to the Checks API in the +// GitHub API . +// +// GitHub API docs : https : //developer.github.com/v3/checks/ +type ChecksService service + +// CheckRun represents a GitHub check run on a repository associated with a GitHub app . +type CheckRun struct { + ID *int64 ` json : '' id , omitempty '' ` + HeadSHA *string ` json : '' head_sha , omitempty '' ` + ExternalID *string ` json : '' external_id , omitempty '' ` + URL *string ` json : '' url , omitempty '' ` + HTMLURL *string ` json : '' html_url , omitempty '' ` + Status *string ` json : '' status , omitempty '' ` + Conclusion *string ` json : '' conclusion
diff -- git a/github/checks.go b/github/checks.go new file mode 100644 index 0000000..165c5ff -- - /dev/null +++ b/github/checks.go @ @ -0,0 +1,428 @ @ +// Copyright 2018 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// ChecksService provides access to the Checks API in the +// GitHub API . +// +// GitHub API docs : https : //developer.github.com/v3/checks/ +type ChecksService service + +// CheckRun represents a GitHub check run on a repository associated with a GitHub app . +type CheckRun struct { + ID *int64 ` json : '' id , omitempty '' ` + HeadSHA *string ` json : '' head_sha , omitempty '' ` + ExternalID *string ` json : '' external_id , omitempty '' ` + URL *string ` json : '' url , omitempty '' ` + HTMLURL *string ` json : '' html_url , omitempty '' ` + Status *string ` json : '' status , omitempty '' ` + Conclusion *string ` json : '' conclusion
diff -- git a/github/repos_releases.go b/github/repos_releases.go index c23601d..ce09570 100644 -- - a/github/repos_releases.go +++ b/github/repos_releases.go @ @ -125,13 +125,37 @ @ func ( s *RepositoriesService ) getSingleRelease ( ctx context.Context , url string ) return release , resp , nil } +// repositoryReleaseRequest is a subset of RepositoryRelease and +// is used internally by CreateRelease and EditRelease to pass +// only the known fields for these endpoints . +// +// See https : //github.com/google/go-github/issues/992 for more +// information . +type repositoryReleaseRequest struct { + TagName *string ` json : '' tag_name , omitempty '' ` + TargetCommitish *string ` json : '' target_commitish , omitempty '' ` + Name *string ` json : '' name , omitempty '' ` + Body *string ` json : '' body , omitempty '' ` + Draft *bool ` json : '' draft , omitempty '' ` + Prerelease *bool ` json : '' prerelease , omitempty '' ` + } + // CreateRelease adds a new release for a repository . // // GitHub API docs : https : //developer.github.com/v3/repos/releases/ # create-a-release func ( s *RepositoriesService ) CreateRelease ( ctx context.Context , owner , repo string , release *RepositoryRelease ) ( *RepositoryRelease , *Response ,
diff -- git a/github/event_types.go b/github/event_types.go index da18f71..97472ce 100644 -- - a/github/event_types.go +++ b/github/event_types.go @ @ -172,14 +172,6 @ @ type IntegrationInstallationRepositoriesEvent struct { Sender *User ` json : '' sender , omitempty '' ` } -// Installation represents a GitHub integration installation . -type Installation struct { - ID *int ` json : '' id , omitempty '' ` - Account *User ` json : '' account , omitempty '' ` - AccessTokensURL *string ` json : '' access_tokens_url , omitempty '' ` - RepositoriesURL *string ` json : '' repositories_url , omitempty '' ` - } - // IssueCommentEvent is triggered when an issue comment is created on an issue // or pull request . // The Webhook event name is `` issue_comment '' . diff -- git a/github/github.go b/github/github.go index f04a011..3c3b985 100644 -- - a/github/github.go +++ b/github/github.go @ @ -90,6 +90,9 @ @ const ( // https : //developer.github.com/changes/2016-09-14-projects-api/ mediaTypeProjectsPreview = `` application/vnd.github.inertia-preview+json '' + + // https : //developer.github.com/v3/integrations/ + mediaTypeIntegrationPreview = `` application/vnd.github.machine-man-preview+json '' ) // A Client manages communication with the GitHub API . @ @ -120,6 +123,7 @ @ type Client struct { Gists *GistsService Git *GitService Gitignores *GitignoresService + Integrations *IntegrationsService Issues *IssuesService
diff -- git a/github/github.go b/github/github.go index 30b8390..62d9771 100644 -- - a/github/github.go +++ b/github/github.go @ @ -71,6 +71,7 @ @ type Client struct { Rate Rate // Services used for talking to different parts of the GitHub API . + OAuth *OAuthService Activity *ActivityService Gists *GistsService Git *GitService @ @ -133,6 +134,7 @ @ func NewClient ( httpClient *http.Client ) *Client { uploadURL , _ : = url.Parse ( uploadBaseURL ) c : = & Client { client : httpClient , BaseURL : baseURL , UserAgent : userAgent , UploadURL : uploadURL } + c.OAuth = & OAuthService { client : c } c.Activity = & ActivityService { client : c } c.Gists = & GistsService { client : c } c.Git = & GitService { client : c } @ @ -323,6 +325,7 @ @ func ( c *Client ) Do ( req *http.Request , v interface { } ) ( *Response , error ) { err = json.NewDecoder ( resp.Body ) .Decode ( v ) } } + return response , err } diff -- git a/github/oauth.go b/github/oauth.go new file mode 100644 index 0000000..349cec2 -- - /dev/null +++ b/github/oauth.go @ @ -0,0 +1,280 @ @ +// Copyright 2015 The
diff -- git a/github/github-accessors.go b/github/github-accessors.go index 6da009b..959e496 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -2948,6 +2948,46 @ @ func ( n *NewPullRequest ) GetTitle ( ) string { return *n.Title } +// GetDescription returns the Description field if it 's non-nil , zero value otherwise . +func ( n *NewTeam ) GetDescription ( ) string { + if n == nil || n.Description == nil { + return `` '' + } + return *n.Description + } + +// GetLDAPDN returns the LDAPDN field if it 's non-nil , zero value otherwise . +func ( n *NewTeam ) GetLDAPDN ( ) string { + if n == nil || n.LDAPDN == nil { + return `` '' + } + return *n.LDAPDN + } + +// GetParentTeamID returns the ParentTeamID field if it 's non-nil , zero value otherwise . +func ( n *NewTeam ) GetParentTeamID ( ) string { + if n == nil || n.ParentTeamID == nil { + return `` '' + } + return *n.ParentTeamID + } + +// GetPermission returns the Permission field if it 's non-nil , zero value otherwise . +func ( n *NewTeam ) GetPermission ( ) string { + if
diff -- git a/github/github-accessors.go b/github/github-accessors.go index 6da009b..ba79d34 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -2948,6 +2948,46 @ @ func ( n *NewPullRequest ) GetTitle ( ) string { return *n.Title } +// GetDescription returns the Description field if it 's non-nil , zero value otherwise . +func ( n *NewTeam ) GetDescription ( ) string { + if n == nil || n.Description == nil { + return `` '' + } + return *n.Description + } + +// GetLDAPDN returns the LDAPDN field if it 's non-nil , zero value otherwise . +func ( n *NewTeam ) GetLDAPDN ( ) string { + if n == nil || n.LDAPDN == nil { + return `` '' + } + return *n.LDAPDN + } + +// GetParentTeamID returns the ParentTeamID field if it 's non-nil , zero value otherwise . +func ( n *NewTeam ) GetParentTeamID ( ) int { + if n == nil || n.ParentTeamID == nil { + return 0 + } + return *n.ParentTeamID + } + +// GetPermission returns the Permission field if it 's non-nil , zero value otherwise . +func ( n *NewTeam ) GetPermission ( ) string { + if n
diff -- git a/github/orgs_teams_test.go b/github/orgs_teams_test.go index ff1101d..6f09f96 100644 -- - a/github/orgs_teams_test.go +++ b/github/orgs_teams_test.go @ @ -48,7 +48,8 @ @ func TestOrganizationsService_GetTeam ( t *testing.T ) { mux.HandleFunc ( `` /teams/1 '' , func ( w http.ResponseWriter , r *http.Request ) { testMethod ( t , r , `` GET '' ) - fmt.Fprint ( w , ` { `` id '' :1 , `` name '' : '' n '' , `` description '' : `` d '' , `` url '' : '' u '' , `` slug '' : `` s '' , `` permission '' : '' p '' , `` ldap_dn '' : '' cn=n , ou=groups , dc=example , dc=com '' } ` ) + fmt.Fprint ( w , ` { `` id '' :1 , `` name '' : '' n '' , `` description '' : `` d '' , `` url '' : '' u '' , `` slug '' : `` s '' , `` permission '' : '' p '' , `` ldap_dn '' : '' cn=n , ou=groups , dc=example , dc=com '' , `` parent '' : null } ` ) + } ) team , _ ,
diff -- git a/github/github.go b/github/github.go index 99ad8d0..6bc1c47 100644 -- - a/github/github.go +++ b/github/github.go @ @ -102,6 +102,9 @ @ const ( // https : //developer.github.com/changes/2017-07-26-team-review-request-thor-preview/ mediaTypeTeamReviewPreview = `` application/vnd.github.thor-preview+json '' + + // https : //developer.github.com/changes/2017-08-30-preview-nested-teams/ + mediaTypeNestedTeamsPreview = `` application/vnd.github.hellcat-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/orgs_teams.go b/github/orgs_teams.go index 684e2da..68851f3 100644 -- - a/github/orgs_teams.go +++ b/github/orgs_teams.go @ @ -39,6 +39,7 @ @ type Team struct { Organization *Organization ` json : '' organization , omitempty '' ` MembersURL *string ` json : '' members_url , omitempty '' ` RepositoriesURL *string ` json : '' repositories_url , omitempty '' ` + Parent *Team ` json : '' parent , omitempty '' ` // LDAPDN is only available in GitHub Enterprise and when the team // membership is synchronized with LDAP . @ @ -79,6 +80,9 @ @ func ( s *OrganizationsService ) ListTeams ( ctx context.Context , org string , opt *L return nil , nil , err } + // TODO : remove custom Accept header when this API fully launches . + req.Header.Set ( `` Accept '' , mediaTypeNestedTeamsPreview ) + var teams [ ] *Team resp , err
diff -- git a/github/github.go b/github/github.go index 99ad8d0..6bc1c47 100644 -- - a/github/github.go +++ b/github/github.go @ @ -102,6 +102,9 @ @ const ( // https : //developer.github.com/changes/2017-07-26-team-review-request-thor-preview/ mediaTypeTeamReviewPreview = `` application/vnd.github.thor-preview+json '' + + // https : //developer.github.com/changes/2017-08-30-preview-nested-teams/ + mediaTypeNestedTeamsPreview = `` application/vnd.github.hellcat-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/orgs_teams.go b/github/orgs_teams.go index 684e2da..39161d7 100644 -- - a/github/orgs_teams.go +++ b/github/orgs_teams.go @ @ -39,6 +39,7 @ @ type Team struct { Organization *Organization ` json : '' organization , omitempty '' ` MembersURL *string ` json : '' members_url , omitempty '' ` RepositoriesURL *string ` json : '' repositories_url , omitempty '' ` + Parent *Team ` json : '' parent , omitempty '' ` // LDAPDN is only available in GitHub Enterprise and when the team // membership is synchronized with LDAP . @ @ -79,6 +80,9 @ @ func ( s *OrganizationsService ) ListTeams ( ctx context.Context , org string , opt *L return nil , nil , err } + // TODO : remove custom Accept header when this API fully launches . + req.Header.Set ( `` Accept '' , mediaTypeNestedTeamsPreview ) + var teams [ ] *Team resp , err
diff -- git a/github/repos.go b/github/repos.go index 07c7aca..2108302 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -331,3 +331,97 @ @ func ( s *RepositoriesService ) ListLanguages ( owner string , repository string ) ( ma _ , err = s.client.Do ( req , & languages ) return languages , err } + +// Hook represents a GitHub ( web and service ) hook for a repository . +type Hook struct { + CreatedAt *time.Time ` json : '' created_at , omitempty '' ` + UpdatedAt *time.Time ` json : '' updated_at , omitempty '' ` + Name string ` json : '' name , omitempty '' ` + Events [ ] string ` json : '' events , omitempty '' ` + Active bool ` json : '' active , omitempty '' ` + Config map [ string ] interface { } ` json : '' config , omitempty '' ` + ID int ` json : '' id , omitempty '' ` + } + +// CreateHook creates a Hook for the specified repository . +// Name and Config are required fields . +// +// GitHub API docs : http : //developer.github.com/v3/repos/hooks/ # create-a-hook +func ( s *RepositoriesService ) CreateHook
diff -- git a/github/github.go b/github/github.go index 0b58e73..83af54a 100644 -- - a/github/github.go +++ b/github/github.go @ @ -84,6 +84,9 @ @ const ( // https : //developer.github.com/changes/2016-07-06-github-pages-preiew-api/ mediaTypePagesPreview = `` application/vnd.github.mister-fantastic-preview+json '' + + // https : //developer.github.com/v3/repos/traffic/ + mediaTypeTrafficPreview = `` application/vnd.github.spiderman-preview '' ) // A Client manages communication with the GitHub API . @ @ -144,6 +147,11 @ @ type UploadOptions struct { Name string ` url : '' name , omitempty '' ` } +// BreakdownOptions specifies the parameters to methods that support breakdown per day or week . +type BreakdownOptions struct { + Per string ` url : '' per , omitempty '' ` + } + // addOptions adds the parameters in opt as URL query parameters to s. opt // must be a struct whose fields may contain `` url '' tags . func addOptions ( s string , opt interface { } ) ( string , error ) { diff -- git a/github/repo_traffic.go b/github/repo_traffic.go new file mode 100644 index 0000000..7aa3c27 -- - /dev/null +++ b/github/repo_traffic.go @ @ -0,0 +1,170 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +//
diff -- git a/github/github.go b/github/github.go index 0b58e73..8448982 100644 -- - a/github/github.go +++ b/github/github.go @ @ -84,6 +84,9 @ @ const ( // https : //developer.github.com/changes/2016-07-06-github-pages-preiew-api/ mediaTypePagesPreview = `` application/vnd.github.mister-fantastic-preview+json '' + + // https : //developer.github.com/v3/repos/traffic/ + mediaTypeTrafficPreview = `` application/vnd.github.spiderman-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/repos_traffic.go b/github/repos_traffic.go new file mode 100644 index 0000000..73ac485 -- - /dev/null +++ b/github/repos_traffic.go @ @ -0,0 +1,173 @ @ +// Copyright 2016 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' fmt '' + '' strconv '' + '' time '' + ) + +// TrafficReferrer represent information about traffic from a referrer . +type TrafficReferrer struct { + Referrer *string ` json : '' referrer , omitempty '' ` + Count *int ` json : '' count , omitempty '' ` + Uniques *int ` json : '' uniques , omitempty '' ` + } + +// TrafficPath represent information about the traffic on a path of the repo . +type TrafficPath struct
diff -- git a/github/github.go b/github/github.go index 3a0727e..8c707be 100644 -- - a/github/github.go +++ b/github/github.go @ @ -108,6 +108,9 @ @ const ( // https : //developer.github.com/changes/2017-08-30-preview-nested-teams/ mediaTypeNestedTeamsPreview = `` application/vnd.github.hellcat-preview+json '' + + // https : //developer.github.com/changes/2017-11-09-repository-transfer-api-preview/ + mediaTypeRepositoryTransferPreview = `` application/vnd.github.nightshade-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/repos.go b/github/repos.go index 037ddfa..9f59944 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -1037,3 +1037,38 @ @ func ( s *RepositoriesService ) ReplaceAllTopics ( ctx context.Context , owner , repo return t.Names , resp , nil } + +// TransferRequest represents a request to transfer a repository . +type TransferRequest struct { + NewOwner string ` json : '' new_owner '' ` + TeamID [ ] int ` json : '' team_id , omitempty '' ` + } + +// Transfer transfers a repository from one account or organization to another . +// +// This method might return an *AcceptedError and a status code of +// 202 . This is because this is the status that GitHub returns to signify that +// it has now scheduled the transfer of the repository in a background task . +// A follow up request , after a delay
diff -- git a/github/orgs_teams.go b/github/orgs_teams.go index 6afcd1f..b08226f 100644 -- - a/github/orgs_teams.go +++ b/github/orgs_teams.go @ @ -46,17 +46,43 @ @ func ( t Team ) String ( ) string { // Invitation represents a team member 's inviation status type Invitation struct { - ID *int ` json : '' id , omitempty '' ` - Login *string ` json : '' login , omitempty '' ` - Email *string ` json : '' email , omitempty '' ` - Role *string ` json : '' role , omitempty '' ` - CreatedAt *time.Time ` json : '' created_at , omitempty '' ` + ID *int ` json : '' id , omitempty '' ` + Login *string ` json : '' login , omitempty '' ` + Email *string ` json : '' email , omitempty '' ` + Role *string ` json : '' role , omitempty '' ` + CreatedAt time.Time ` json : '' created_at , omitempty '' ` + Inviter *Inviter ` json : '' inviter , omitempty '' ` } func ( i Invitation ) String ( ) string { return Stringify ( i ) } +// Inviter represents the entity introduced in team and
diff -- git a/README.md b/README.md index 4d27032..dd25645 100644 -- - a/README.md +++ b/README.md @ @ -78,8 +78,8 @ @ fmt.Println ( resp.NextPage ) // outputs 3 For complete usage of go-github , see the full [ package docs ] [ ] . [ GitHub API ] : https : //developer.github.com/v3/ - [ goauth2 ] : https : //code.google.com/p/goauth2/ - [ goauth2 docs ] : https : //godoc.org/code.google.com/p/goauth2/oauth + [ goauth2 ] : https : //golang.org/x/oauth2 + [ goauth2 docs ] : https : //godoc.org/golang.org/x/oauth2 [ personal API token ] : https : //github.com/blog/1509-personal-api-tokens [ package docs ] : https : //godoc.org/github.com/google/go-github/github
diff -- git a/github/orgs.go b/github/orgs.go index 976a5fc..1633a2b 100644 -- - a/github/orgs.go +++ b/github/orgs.go @ @ -75,7 +75,7 @ @ func ( p Plan ) String ( ) string { // OrganizationsService.ListAll method . type OrganizationsListOptions struct { // Since filters Organizations by ID . - Since int ` url : '' since , omitempty '' ` + Since int64 ` url : '' since , omitempty '' ` ListOptions } diff -- git a/github/orgs_test.go b/github/orgs_test.go index ca4263e..927ff78 100644 -- - a/github/orgs_test.go +++ b/github/orgs_test.go @ @ -18,7 +18,7 @ @ func TestOrganizationsService_ListAll ( t *testing.T ) { client , mux , _ , teardown : = setup ( ) defer teardown ( ) - since : = 1342004 + since : = int64 ( 1342004 ) mux.HandleFunc ( `` /organizations '' , func ( w http.ResponseWriter , r *http.Request ) { testMethod ( t , r , `` GET '' ) testHeader ( t , r , `` Accept '' , mediaTypeGraphQLNodeIDPreview )
diff -- git a/github/activity_events_test.go b/github/activity_events_test.go index dc92a98..0b01c4a 100644 -- - a/github/activity_events_test.go +++ b/github/activity_events_test.go @ @ -88,7 +88,7 @ @ func TestActivityService_ListIssueEventsForRepository ( t *testing.T ) { t.Errorf ( `` Activities.ListIssueEventsForRepository returned error : % v '' , err ) } - want : = [ ] *IssueEvent { { ID : Int ( 1 ) } , { ID : Int ( 2 ) } } + want : = [ ] *IssueEvent { { ID : Int64 ( 1 ) } , { ID : Int64 ( 2 ) } } if ! reflect.DeepEqual ( events , want ) { t.Errorf ( `` Activities.ListIssueEventsForRepository returned % +v , want % +v '' , events , want ) } @ @ -301,7 +301,7 @ @ func TestActivityService_EventParsePayload_typed ( t *testing.T ) { t.Fatalf ( `` Unmarshal Event returned error : % v '' , err ) } - want : = & PushEvent { PushID : Int ( 1 ) } + want : = & PushEvent { PushID : Int64 ( 1 ) } got , err : = event.ParsePayload ( ) if err ! = nil { t.Fatalf ( `` ParsePayload returned unexpected error : % v ''
diff -- git a/github/activity.go b/github/activity.go index 491f9e7..886d06f 100644 -- - a/github/activity.go +++ b/github/activity.go @ @ -5,60 +5,10 @ @ package github -import ( - '' fmt '' - '' net/url '' - '' strconv '' - ) - // ActivityService handles communication with the activity related // methods of the GitHub API . // // GitHub API docs : http : //developer.github.com/v3/users/ type ActivityService struct { - client *Client - } - -// ActivityListStarredOptions specifies the optional parameters to the -// ActivityService.ListStarred method . -type ActivityListStarredOptions struct { - // How to sort the repository list . Possible values are : created , updated , - // pushed , full_name . Default is `` full_name '' . - Sort string - - // Direction in which to sort repositories . Possible values are : asc , desc . - // Default is `` asc '' when sort is `` full_name '' , otherwise default is `` desc '' . - Direction string - - // For paginated result sets , page of results to retrieve . - Page int - } - -// ListStarred lists all the repos starred by a user . Passing the empty string -// will list
diff -- git a/README.md b/README.md index f416c81..17077d7 100644 -- - a/README.md +++ b/README.md @ @ -238,6 +238,29 @ @ straightforward . [ roadmap ] : https : //docs.google.com/spreadsheet/ccc ? key=0ApoVX4GOiXr-dGNKN1pObFh6ek1DR2FKUjBNZ1FmaEE & usp=sharing [ contributing ] : CONTRIBUTING.md + # # Versioning # # + +In general , go-github follows [ semver ] ( http : //semver.org/ ) as closely as we can +for tagging releases of the package . For self-contained libraries , the +application of semantic versioning is relatively straightforward and generally +understood . But because go-github is a client library for the GitHub API , +which itself changes behavior , and because we are typically pretty aggressive +about implementing preview features of the GitHub API , we 've adopted the +following versioning policy : + +* We increment the **major version** with any incompatible change to + non-preview functionality , including changes to the exported Go API surface + or behavior of the API . +* We increment the **minor version** with any backwards-compatible changes to + functionality , as well as any changes to preview functionality in the GitHub + API . GitHub makes no guarantee about the stability of preview functionality , + so neither do
diff -- git a/examples/basicauth/main.go b/examples/basicauth/main.go index c6e58db..2d8b630 100644 -- - a/examples/basicauth/main.go +++ b/examples/basicauth/main.go @ @ -10,6 +10,7 @ @ package main import ( '' bufio '' + '' context '' '' fmt '' '' os '' '' strings '' @ @ -34,14 +35,14 @ @ func main ( ) { } client : = github.NewClient ( tp.Client ( ) ) - user , _ , err : = client.Users.Get ( `` '' ) + user , _ , err : = client.Users.Get ( context.Background ( ) , `` '' ) // Is this a two-factor auth error ? If so , prompt for OTP and try again . if _ , ok : = err . ( *github.TwoFactorAuthError ) ; err ! = nil & & ok { fmt.Print ( `` \nGitHub OTP : `` ) otp , _ : = r.ReadString ( '\n ' ) tp.OTP = strings.TrimSpace ( otp ) - user , _ , err = client.Users.Get ( `` '' ) + user , _ , err = client.Users.Get ( context.Background ( ) , `` '' ) } if err ! = nil { diff -- git a/github/activity.go b/github/activity.go index ad6da2b..d6c992c 100644 -- - a/github/activity.go +++ b/github/activity.go
diff -- git a/github/checks.go b/github/checks.go index ac924ac..7917908 100644 -- - a/github/checks.go +++ b/github/checks.go @ @ -47,14 +47,14 @ @ type CheckRunOutput struct { // CheckRunAnnotation represents an annotation object for a CheckRun output . type CheckRunAnnotation struct { - FileName *string ` json : '' filename , omitempty '' ` - BlobHRef *string ` json : '' blob_href , omitempty '' ` - StartLine *int ` json : '' start_line , omitempty '' ` - EndLine *int ` json : '' end_line , omitempty '' ` - WarningLevel *string ` json : '' warning_level , omitempty '' ` - Message *string ` json : '' message , omitempty '' ` - Title *string ` json : '' title , omitempty '' ` - RawDetails *string ` json : '' raw_details , omitempty '' ` + Path *string ` json : '' path , omitempty '' ` + BlobHRef *string ` json : '' blob_href , omitempty '' ` + StartLine *int ` json : '' start_line , omitempty '' ` + EndLine *int ` json : '' end_line , omitempty '' ` + AnnotationLevel *string ` json : '' annotation_level , omitempty '' ` + Message *string ` json :
diff -- git a/github/checks.go b/github/checks.go index ac924ac..7e7ba19 100644 -- - a/github/checks.go +++ b/github/checks.go @ @ -47,14 +47,14 @ @ type CheckRunOutput struct { // CheckRunAnnotation represents an annotation object for a CheckRun output . type CheckRunAnnotation struct { - FileName *string ` json : '' filename , omitempty '' ` - BlobHRef *string ` json : '' blob_href , omitempty '' ` - StartLine *int ` json : '' start_line , omitempty '' ` - EndLine *int ` json : '' end_line , omitempty '' ` - WarningLevel *string ` json : '' warning_level , omitempty '' ` - Message *string ` json : '' message , omitempty '' ` - Title *string ` json : '' title , omitempty '' ` - RawDetails *string ` json : '' raw_details , omitempty '' ` + Path *string ` json : '' path , omitempty '' ` + BlobHRef *string ` json : '' blob_href , omitempty '' ` + StartLine *int ` json : '' start_line , omitempty '' ` + EndLine *int ` json : '' end_line , omitempty '' ` + AnnotationLevel *string ` json : '' annotation_level , omitempty '' ` + Message *string ` json :
diff -- git a/examples/basicauth/main.go b/examples/basicauth/main.go index c6e58db..63f6c05 100644 -- - a/examples/basicauth/main.go +++ b/examples/basicauth/main.go @ @ -10,6 +10,7 @ @ package main import ( '' bufio '' + '' context '' '' fmt '' '' os '' '' strings '' @ @ -34,14 +35,15 @ @ func main ( ) { } client : = github.NewClient ( tp.Client ( ) ) - user , _ , err : = client.Users.Get ( `` '' ) + ctx : = context.Background ( ) + user , _ , err : = client.Users.Get ( ctx , `` '' ) // Is this a two-factor auth error ? If so , prompt for OTP and try again . if _ , ok : = err . ( *github.TwoFactorAuthError ) ; err ! = nil & & ok { fmt.Print ( `` \nGitHub OTP : `` ) otp , _ : = r.ReadString ( '\n ' ) tp.OTP = strings.TrimSpace ( otp ) - user , _ , err = client.Users.Get ( `` '' ) + user , _ , err = client.Users.Get ( ctx , `` '' ) } if err ! = nil { diff -- git a/github/activity.go b/github/activity.go index ad6da2b..00fa2f5 100644 -- -
diff -- git a/examples/basicauth/main.go b/examples/basicauth/main.go index c6e58db..63f6c05 100644 -- - a/examples/basicauth/main.go +++ b/examples/basicauth/main.go @ @ -10,6 +10,7 @ @ package main import ( '' bufio '' + '' context '' '' fmt '' '' os '' '' strings '' @ @ -34,14 +35,15 @ @ func main ( ) { } client : = github.NewClient ( tp.Client ( ) ) - user , _ , err : = client.Users.Get ( `` '' ) + ctx : = context.Background ( ) + user , _ , err : = client.Users.Get ( ctx , `` '' ) // Is this a two-factor auth error ? If so , prompt for OTP and try again . if _ , ok : = err . ( *github.TwoFactorAuthError ) ; err ! = nil & & ok { fmt.Print ( `` \nGitHub OTP : `` ) otp , _ : = r.ReadString ( '\n ' ) tp.OTP = strings.TrimSpace ( otp ) - user , _ , err = client.Users.Get ( `` '' ) + user , _ , err = client.Users.Get ( ctx , `` '' ) } if err ! = nil { diff -- git a/github/activity.go b/github/activity.go index ad6da2b..d6c992c 100644 -- -
diff -- git a/.travis.yml b/.travis.yml index 0cd374f..4d9fec0 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -1,18 +1,12 @ @ sudo : false language : go go : - - 1.5.4 - - 1.6.3 - - 1.7 - - tip + - 1.7.x + - 1.8.x + - master matrix : - include : - - go : 1.4.3 - script : - - go get -t -v ./ ... - - go test -v -race ./ ... allow_failures : - - go : tip + - go : master fast_finish : true install : - # Do nothing . This is needed to prevent default install action `` go get -t -v ./ ... '' from happening here ( we want it to happen inside script step ) . diff -- git a/README.md b/README.md index 99b93be..abb1b2f 100644 -- - a/README.md +++ b/README.md @ @ -7,7 +7,7 @ @ go-github is a Go client library for accessing the [ GitHub API ] [ ] . **Build Status : ** [ ! [ Build Status ] ( https : //travis-ci.org/google/go-github.svg ? branch=master ) ] ( https : //travis-ci.org/google/go-github ) **Test Coverage : ** [ ! [ Test Coverage ] ( https :
diff -- git a/AUTHORS b/AUTHORS index f521b6d..b31fb2a 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -69,6 +69,7 @ @ i2bskn < i2bskn @ gmail.com > Isao Jonas < isao.jonas @ gmail.com > isqua < isqua @ isqua.ru > Jameel Haffejee < RC1140 @ republiccommandos.co.za > +Jeremy Morris < jeremylevanmorris @ gmail.com > Jihoon Chung < j.c @ navercorp.com > Joe Tsai < joetsai @ digital-static.net > John Engelman < john.r.engelman @ gmail.com > diff -- git a/github/apps.go b/github/apps.go index ff33893..4c3e7c6 100644 -- - a/github/apps.go +++ b/github/apps.go @ @ -37,4 +37,4 @ @ func ( s *AppsService ) ListInstallations ( ctx context.Context , opt *ListOptions ) ( } return i , resp , nil - } + } \ No newline at end of file diff -- git a/github/apps_installation.go b/github/apps_installation.go index 6a27799..9c4d191 100644 -- - a/github/apps_installation.go +++ b/github/apps_installation.go @ @ -47,3 +47,38 @ @ func ( s *AppsService ) ListRepos ( ctx context.Context , opt *ListOptions ) ( [ ] *Repos return r.Repositories , resp , nil } + +// Add a single repository to an installation . +// +// GitHub API docs : https : //developer.github.com/v3/apps/installations/ # add-repository-to-installation +func ( s *AppService ) AddRepo ( ctx context.Context , instID int
diff -- git a/github/git_commits.go b/github/git_commits.go index b0c4da7..22cb49a 100644 -- - a/github/git_commits.go +++ b/github/git_commits.go @ @ -88,6 +88,7 @ @ type createCommit struct { } // CreateCommit creates a new commit in a repository . +// commit must not be nil . // // The commit.Committer is optional and will be filled with the commit.Author // data if omitted . If the commit.Author is omitted , it will be filled in with @ @ -95,22 +96,25 @ @ type createCommit struct { // // GitHub API docs : https : //developer.github.com/v3/git/commits/ # create-a-commit func ( s *GitService ) CreateCommit ( ctx context.Context , owner string , repo string , commit *Commit ) ( *Commit , *Response , error ) { + if commit == nil { + return nil , nil , fmt.Errorf ( `` commit must be provided '' ) + } + u : = fmt.Sprintf ( `` repos/ % v/ % v/git/commits '' , owner , repo ) - body : = & createCommit { } - if commit ! = nil { - parents : = make ( [ ] string , len ( commit.Parents ) ) - for i , parent : = range commit.Parents {
diff -- git a/github/repos_releases.go b/github/repos_releases.go index c23601d..ce09570 100644 -- - a/github/repos_releases.go +++ b/github/repos_releases.go @ @ -125,13 +125,37 @ @ func ( s *RepositoriesService ) getSingleRelease ( ctx context.Context , url string ) return release , resp , nil } +// repositoryReleaseRequest is a subset of RepositoryRelease and +// is used internally by CreateRelease and EditRelease to pass +// only the known fields for these endpoints . +// +// See https : //github.com/google/go-github/issues/992 for more +// information . +type repositoryReleaseRequest struct { + TagName *string ` json : '' tag_name , omitempty '' ` + TargetCommitish *string ` json : '' target_commitish , omitempty '' ` + Name *string ` json : '' name , omitempty '' ` + Body *string ` json : '' body , omitempty '' ` + Draft *bool ` json : '' draft , omitempty '' ` + Prerelease *bool ` json : '' prerelease , omitempty '' ` + } + // CreateRelease adds a new release for a repository . // // GitHub API docs : https : //developer.github.com/v3/repos/releases/ # create-a-release func ( s *RepositoriesService ) CreateRelease ( ctx context.Context , owner , repo string , release *RepositoryRelease ) ( *RepositoryRelease , *Response ,
diff -- git a/github/git_commits.go b/github/git_commits.go index 6e73420..c96fc99 100644 -- - a/github/git_commits.go +++ b/github/git_commits.go @ @ -19,6 +19,7 @ @ type Commit struct { Tree *Tree ` json : '' tree , omitempty '' ` Parents [ ] Commit ` json : '' parents , omitempty '' ` Stats *CommitStats ` json : '' stats , omitempty '' ` + URL *string ` json : url , omitempty '' ` } func ( c Commit ) String ( ) string { diff -- git a/github/repos.go b/github/repos.go index 5fb7a3e..0ce9254 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -255,3 +255,28 @ @ func ( s *RepositoriesService ) ListLanguages ( owner string , repository string ) ( ma return languages , resp , err } + +// Branch represents a repository branch +type Branch struct { + Name *string ` json : '' name , omitempty '' ` + Commit *Commit + } + +// ListBranches lists branches for the specified repository . +// +// GitHub API docs : http : //developer.github.com/v3/repos/ # list-branches +func ( s *RepositoriesService ) ListBranches ( owner string , repository string ) ( [ ] Branch , *Response , error ) { + u : = fmt.Sprintf ( ``
diff -- git a/github/github-accessors.go b/github/github-accessors.go index d9939c2..fa8c583 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -10548,6 +10548,22 @ @ func ( u *User ) GetURL ( ) string { return *u.URL } +// GetMessage returns the Message field if it 's non-nil , zero value otherwise . +func ( u *UserContext ) GetMessage ( ) string { + if u == nil || u.Message == nil { + return `` '' + } + return *u.Message + } + +// GetOcticon returns the Octicon field if it 's non-nil , zero value otherwise . +func ( u *UserContext ) GetOcticon ( ) string { + if u == nil || u.Octicon == nil { + return `` '' + } + return *u.Octicon + } + // GetEmail returns the Email field if it 's non-nil , zero value otherwise . func ( u *UserEmail ) GetEmail ( ) string { if u == nil || u.Email == nil { diff -- git a/github/github.go b/github/github.go index a0c78aa..f2c9768 100644 -- - a/github/github.go +++ b/github/github.go @ @ -119,6 +119,9 @ @ const ( // https : //developer.github.com/changes/2018-02-07-team-discussions-api/ mediaTypeTeamDiscussionsPreview = `` application/vnd.github.echo-preview+json '' + + // https : //developer.github.com/changes/2018-03-21-hovercard-api-preview/ + mediaTypeHovercardPreview = ``
diff -- git a/github/event_types.go b/github/event_types.go index da18f71..97472ce 100644 -- - a/github/event_types.go +++ b/github/event_types.go @ @ -172,14 +172,6 @ @ type IntegrationInstallationRepositoriesEvent struct { Sender *User ` json : '' sender , omitempty '' ` } -// Installation represents a GitHub integration installation . -type Installation struct { - ID *int ` json : '' id , omitempty '' ` - Account *User ` json : '' account , omitempty '' ` - AccessTokensURL *string ` json : '' access_tokens_url , omitempty '' ` - RepositoriesURL *string ` json : '' repositories_url , omitempty '' ` - } - // IssueCommentEvent is triggered when an issue comment is created on an issue // or pull request . // The Webhook event name is `` issue_comment '' . diff -- git a/github/github.go b/github/github.go index f04a011..3c3b985 100644 -- - a/github/github.go +++ b/github/github.go @ @ -90,6 +90,9 @ @ const ( // https : //developer.github.com/changes/2016-09-14-projects-api/ mediaTypeProjectsPreview = `` application/vnd.github.inertia-preview+json '' + + // https : //developer.github.com/v3/integrations/ + mediaTypeIntegrationPreview = `` application/vnd.github.machine-man-preview+json '' ) // A Client manages communication with the GitHub API . @ @ -120,6 +123,7 @ @ type Client struct { Gists *GistsService Git *GitService Gitignores *GitignoresService + Integrations *IntegrationsService Issues *IssuesService
diff -- git a/github/pulls_reviews_request.go b/github/pulls_reviews_request.go new file mode 100644 index 0000000..d136999 -- - /dev/null +++ b/github/pulls_reviews_request.go @ @ -0,0 +1,80 @ @ +// Copyright 2017 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import `` fmt '' + +// RequestReviewers submits a set of logins to be potential reviewers on a PR . +// +// GitHub API docs : https : //developer.github.com/v3/pulls/review_requests/ # create-a-review-request +func ( s *PullRequestsService ) RequestReviewers ( owner , repo string , number int , logins [ ] string ) ( *PullRequest , *Response , error ) { + u : = fmt.Sprintf ( `` repos/ % s/ % s/pulls/ % d/requested_reviewers '' , owner , repo , number ) + reviewers : = struct { + Reviewers [ ] string ` json : '' reviewers , omitempty '' ` + } { + Reviewers : logins , + } + req , err : = s.client.NewRequest ( `` POST '' , u , & reviewers ) + if err ! = nil { + return nil , nil
diff -- git a/github/pulls_reviewers.go b/github/pulls_reviewers.go new file mode 100644 index 0000000..06cae54 -- - /dev/null +++ b/github/pulls_reviewers.go @ @ -0,0 +1,83 @ @ +// Copyright 2017 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// RequestReviewers submits a set of logins to be potential reviewers on a PR . +// +// GitHub API docs : https : //developer.github.com/v3/pulls/review_requests/ # create-a-review-request +func ( s *PullRequestsService ) RequestReviewers ( ctx context.Context , owner , repo string , number int , logins [ ] string ) ( *PullRequest , *Response , error ) { + u : = fmt.Sprintf ( `` repos/ % s/ % s/pulls/ % d/requested_reviewers '' , owner , repo , number ) + reviewers : = struct { + Reviewers [ ] string ` json : '' reviewers , omitempty '' ` + } { + Reviewers : logins , + } + req , err : = s.client.NewRequest ( `` POST '' , u , & reviewers ) +
diff -- git a/github/orgs_teams.go b/github/orgs_teams.go index 6afcd1f..b08226f 100644 -- - a/github/orgs_teams.go +++ b/github/orgs_teams.go @ @ -46,17 +46,43 @ @ func ( t Team ) String ( ) string { // Invitation represents a team member 's inviation status type Invitation struct { - ID *int ` json : '' id , omitempty '' ` - Login *string ` json : '' login , omitempty '' ` - Email *string ` json : '' email , omitempty '' ` - Role *string ` json : '' role , omitempty '' ` - CreatedAt *time.Time ` json : '' created_at , omitempty '' ` + ID *int ` json : '' id , omitempty '' ` + Login *string ` json : '' login , omitempty '' ` + Email *string ` json : '' email , omitempty '' ` + Role *string ` json : '' role , omitempty '' ` + CreatedAt time.Time ` json : '' created_at , omitempty '' ` + Inviter *Inviter ` json : '' inviter , omitempty '' ` } func ( i Invitation ) String ( ) string { return Stringify ( i ) } +// Inviter represents the entity introduced in team and
diff -- git a/github/github-accessors.go b/github/github-accessors.go index 23b351a..d1b49cb 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -1508,6 +1508,22 @ @ func ( c *CommunityHealthFiles ) GetContributing ( ) *Metric { return c.Contributing } +// GetIssueTemplate returns the IssueTemplate field . +func ( c *CommunityHealthFiles ) GetIssueTemplate ( ) *Metric { + if c == nil { + return nil + } + return c.IssueTemplate + } + +// GetPullRequestTemplate returns the PullRequestTemplate field . +func ( c *CommunityHealthFiles ) GetPullRequestTemplate ( ) *Metric { + if c == nil { + return nil + } + return c.PullRequestTemplate + } + // GetLicense returns the License field . func ( c *CommunityHealthFiles ) GetLicense ( ) *Metric { if c == nil { diff -- git a/github/repos_community_health.go b/github/repos_community_health.go index b5c75d6..e4c4029 100644 -- - a/github/repos_community_health.go +++ b/github/repos_community_health.go @ @ -21,10 +21,12 @ @ type Metric struct { // CommunityHealthFiles represents the different files in the community health metrics response . type CommunityHealthFiles struct { - CodeOfConduct *Metric ` json : '' code_of_conduct '' ` - Contributing *Metric ` json : '' contributing '' ` - License *Metric ` json : '' license '' ` - Readme *Metric ` json : '' readme
diff -- git a/github/github-accessors.go b/github/github-accessors.go index 23b351a..e23ca2e 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -1508,6 +1508,14 @ @ func ( c *CommunityHealthFiles ) GetContributing ( ) *Metric { return c.Contributing } +// GetIssueTemplate returns the IssueTemplate field . +func ( c *CommunityHealthFiles ) GetIssueTemplate ( ) *Metric { + if c == nil { + return nil + } + return c.IssueTemplate + } + // GetLicense returns the License field . func ( c *CommunityHealthFiles ) GetLicense ( ) *Metric { if c == nil { @ @ -1516,6 +1524,14 @ @ func ( c *CommunityHealthFiles ) GetLicense ( ) *Metric { return c.License } +// GetPullRequestTemplate returns the PullRequestTemplate field . +func ( c *CommunityHealthFiles ) GetPullRequestTemplate ( ) *Metric { + if c == nil { + return nil + } + return c.PullRequestTemplate + } + // GetReadme returns the Readme field . func ( c *CommunityHealthFiles ) GetReadme ( ) *Metric { if c == nil { diff -- git a/github/repos_community_health.go b/github/repos_community_health.go index b5c75d6..73d1d57 100644 -- - a/github/repos_community_health.go +++ b/github/repos_community_health.go @ @ -21,10 +21,12 @ @ type Metric struct { // CommunityHealthFiles represents the different files in the community health metrics response . type
diff -- git a/github/github-accessors.go b/github/github-accessors.go index 23b351a..e23ca2e 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -1508,6 +1508,14 @ @ func ( c *CommunityHealthFiles ) GetContributing ( ) *Metric { return c.Contributing } +// GetIssueTemplate returns the IssueTemplate field . +func ( c *CommunityHealthFiles ) GetIssueTemplate ( ) *Metric { + if c == nil { + return nil + } + return c.IssueTemplate + } + // GetLicense returns the License field . func ( c *CommunityHealthFiles ) GetLicense ( ) *Metric { if c == nil { @ @ -1516,6 +1524,14 @ @ func ( c *CommunityHealthFiles ) GetLicense ( ) *Metric { return c.License } +// GetPullRequestTemplate returns the PullRequestTemplate field . +func ( c *CommunityHealthFiles ) GetPullRequestTemplate ( ) *Metric { + if c == nil { + return nil + } + return c.PullRequestTemplate + } + // GetReadme returns the Readme field . func ( c *CommunityHealthFiles ) GetReadme ( ) *Metric { if c == nil { diff -- git a/github/repos_community_health.go b/github/repos_community_health.go index b5c75d6..73d1d57 100644 -- - a/github/repos_community_health.go +++ b/github/repos_community_health.go @ @ -21,10 +21,12 @ @ type Metric struct { // CommunityHealthFiles represents the different files in the community health metrics response . type
diff -- git a/github/repos.go b/github/repos.go index 5fb7a3e..1e823f5 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -51,6 +51,34 @ @ func ( r Repository ) String ( ) string { return Stringify ( r ) } +// RepositorySpec specifies a repository . +type RepositorySpec interface { + Path ( ) string + } + +// RepositoryName identifies a repository by its owner and name . +type RepositoryName struct { + // Owner is the user login of the repository 's owner . + Owner string + + // Name is the repository 's name ( not including the owner ) . + Name string + } + +// Path implements RepositorySpec . +func ( r RepositoryName ) Path ( ) string { + return fmt.Sprintf ( `` repos/ % v/ % v '' , r.Owner , r.Name ) + } + +// RepositoryID is a numeric ID for a repository . GitHub repository IDs remain +// unchanged even if the repository is renamed . +type RepositoryID int64 + +// Path implements RepositorySpec . +func ( r RepositoryID ) Path ( ) string { + return fmt.Sprintf ( `` repositories/ % d '' , r ) + } + // RepositoryListOptions specifies
diff -- git a/github/orgs.go b/github/orgs.go index 8b126f0..e6947c9 100644 -- - a/github/orgs.go +++ b/github/orgs.go @ @ -154,6 +154,25 @ @ func ( s *OrganizationsService ) Get ( ctx context.Context , org string ) ( *Organizati return organization , resp , nil } +// GetByID fetches an organization . +// +// Note : GetByID uses the undocumented GitHub API endpoint /organizations/ : id . +func ( s *OrganizationsService ) GetByID ( ctx context.Context , id int ) ( *Organization , *Response , error ) { + u : = fmt.Sprintf ( `` organizations/ % d '' , id ) + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil { + return nil , nil , err + } + + organization : = new ( Organization ) + resp , err : = s.client.Do ( ctx , req , organization ) + if err ! = nil { + return nil , resp , err + } + + return organization , resp , nil + } + // Edit an organization . // // GitHub API docs : https : //developer.github.com/v3/orgs/ # edit-an-organization diff -- git a/github/orgs_test.go b/github/orgs_test.go
diff -- git a/README.md b/README.md index f416c81..039e264 100644 -- - a/README.md +++ b/README.md @ @ -25,7 +25,7 @ @ access different parts of the GitHub API . For example : client : = github.NewClient ( nil ) // list all organizations for user `` willnorris '' -orgs , _ , err : = client.Organizations.List ( ctx , `` willnorris '' , nil ) +orgs , _ , err : = client.Organizations.List ( context.Background ( ) , `` willnorris '' , nil ) `` ` Some API methods have optional parameters that can be passed . For example : @ @ -35,13 +35,23 @ @ client : = github.NewClient ( nil ) // list public repositories for org `` github '' opt : = & github.RepositoryListByOrgOptions { Type : `` public '' } -repos , _ , err : = client.Repositories.ListByOrg ( ctx , `` github '' , opt ) +repos , _ , err : = client.Repositories.ListByOrg ( context.Background ( ) , `` github '' , opt ) `` ` The services of a client divide the API into logical chunks and correspond to the structure of the GitHub API documentation at https : //developer.github.com/v3/ . + +NOTE : Using
diff -- git a/github/repos.go b/github/repos.go index 13daa7e..f497732 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -985,13 +985,13 @ @ func ( s *RepositoriesService ) RemoveAdminEnforcement ( ctx context.Context , owner , // Topics represents a collection of repository topics . type Topics struct { - Names [ ] string ` json : '' names , omitempty '' ` + Names [ ] string ` json : '' names '' ` } // ListAllTopics lists topics for a repository . // // GitHub API docs : https : //developer.github.com/v3/repos/ # list-all-topics-for-a-repository -func ( s *RepositoriesService ) ListAllTopics ( ctx context.Context , owner , repo string ) ( *Topics , *Response , error ) { +func ( s *RepositoriesService ) ListAllTopics ( ctx context.Context , owner , repo string ) ( [ ] string , *Response , error ) { u : = fmt.Sprintf ( `` repos/ % v/ % v/topics '' , owner , repo ) req , err : = s.client.NewRequest ( `` GET '' , u , nil ) if err ! = nil { @ @ -1007,15 +1007,19 @ @ func ( s *RepositoriesService ) ListAllTopics ( ctx context.Context , owner , repo str return nil , resp
diff -- git a/github/orgs_members.go b/github/orgs_members.go index 80454ad..957674c 100644 -- - a/github/orgs_members.go +++ b/github/orgs_members.go @ @ -270,3 +270,33 @ @ func ( s *OrganizationsService ) RemoveOrgMembership ( user , org string ) ( *Response , return s.client.Do ( req , nil ) } + +//ListPendingOrgInvitations returns a list of contains a role field which refers to the +//Organization Invitation role and will be one of the following values : +//direct_member , admin , billing_manager , hiring_manager , or reinstate . +//If the invitee is not a GitHub member , the login field in the return hash will be null . +// +// GitHub API docs : +// https : //developer.github.com/v3/orgs/members/ # list-pending-organization-invitations +func ( s *OrganizationsService ) ListPendingOrgInvitations ( org int , opt *ListOptions ) ( [ ] *Invitation , *Response , error ) { + u : = fmt.Sprintf ( `` orgs/ % v/invitations '' , org ) + u , err : = addOptions ( u , opt ) + if err ! = nil { + return nil , nil , err + } + + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil {
diff -- git a/github/orgs_members.go b/github/orgs_members.go index 80454ad..77f6912 100644 -- - a/github/orgs_members.go +++ b/github/orgs_members.go @ @ -270,3 +270,29 @ @ func ( s *OrganizationsService ) RemoveOrgMembership ( user , org string ) ( *Response , return s.client.Do ( req , nil ) } + +// ListPendingOrgInvitations returns a list of pending invitations . +// +// GitHub API docs : https : //developer.github.com/v3/orgs/members/ # list-pending-organization-invitations +func ( s *OrganizationsService ) ListPendingOrgInvitations ( org int , opt *ListOptions ) ( [ ] *Invitation , *Response , error ) { + u : = fmt.Sprintf ( `` orgs/ % v/invitations '' , org ) + u , err : = addOptions ( u , opt ) + if err ! = nil { + return nil , nil , err + } + + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil { + return nil , nil , err + } + + // TODO : remove custom Accept header when this API fully launches . + req.Header.Set ( `` Accept '' , mediaTypeOrgMembershipPreview ) + + pendingInvitations : = new ( [ ] *Invitation ) + resp , err
diff -- git a/github/github-accessors.go b/github/github-accessors.go index 794f5e2..31a8394 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -620,6 +620,14 @ @ func ( c *CommitStats ) GetTotal ( ) int { return *c.Total } +// GetHealthPercentage returns the HealthPercentage field if it 's non-nil , zero value otherwise . +func ( c *CommunityHealthMetrics ) GetHealthPercentage ( ) int { + if c == nil || c.HealthPercentage == nil { + return 0 + } + return *c.HealthPercentage + } + // GetAvatarURL returns the AvatarURL field if it 's non-nil , zero value otherwise . func ( c *Contributor ) GetAvatarURL ( ) string { if c == nil || c.AvatarURL == nil { diff -- git a/github/github.go b/github/github.go index b1742e4..b3c8509 100644 -- - a/github/github.go +++ b/github/github.go @ @ -97,6 +97,9 @ @ const ( // https : //developer.github.com/changes/2017-02-28-user-blocking-apis-and-webhook/ mediaTypeBlockUsersPreview = `` application/vnd.github.giant-sentry-fist-preview+json '' + + // https : //developer.github.com/changes/2017-02-09-community-health/ + mediaTypeRepositoryCommunityHealthMetricsPreview = `` application/vnd.github.black-panther-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/repos_community_health.go b/github/repos_community_health.go new file mode 100644 index 0000000..9d9aeac -- - /dev/null +++ b/github/repos_community_health.go @ @ -0,0 +1,62 @ @ +// Copyright 2017 The go-github AUTHORS . All rights reserved . +// +//
diff -- git a/github/github-accessors.go b/github/github-accessors.go index 794f5e2..f2ce4c7 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -620,6 +620,22 @ @ func ( c *CommitStats ) GetTotal ( ) int { return *c.Total } +// GetHealthPercentage returns the HealthPercentage field if it 's non-nil , zero value otherwise . +func ( c *CommunityHealthMetrics ) GetHealthPercentage ( ) int { + if c == nil || c.HealthPercentage == nil { + return 0 + } + return *c.HealthPercentage + } + +// GetUpdatedAt returns the UpdatedAt field if it 's non-nil , zero value otherwise . +func ( c *CommunityHealthMetrics ) GetUpdatedAt ( ) time.Time { + if c == nil || c.UpdatedAt == nil { + return time.Time { } + } + return *c.UpdatedAt + } + // GetAvatarURL returns the AvatarURL field if it 's non-nil , zero value otherwise . func ( c *Contributor ) GetAvatarURL ( ) string { if c == nil || c.AvatarURL == nil { @ @ -2556,6 +2572,38 @ @ func ( m *MembershipEvent ) GetScope ( ) string { return *m.Scope } +// GetHTMLURL returns the HTMLURL field if it 's non-nil , zero value otherwise . +func ( m *Metric ) GetHTMLURL
diff -- git a/github/github-accessors.go b/github/github-accessors.go index 794f5e2..f2ce4c7 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -620,6 +620,22 @ @ func ( c *CommitStats ) GetTotal ( ) int { return *c.Total } +// GetHealthPercentage returns the HealthPercentage field if it 's non-nil , zero value otherwise . +func ( c *CommunityHealthMetrics ) GetHealthPercentage ( ) int { + if c == nil || c.HealthPercentage == nil { + return 0 + } + return *c.HealthPercentage + } + +// GetUpdatedAt returns the UpdatedAt field if it 's non-nil , zero value otherwise . +func ( c *CommunityHealthMetrics ) GetUpdatedAt ( ) time.Time { + if c == nil || c.UpdatedAt == nil { + return time.Time { } + } + return *c.UpdatedAt + } + // GetAvatarURL returns the AvatarURL field if it 's non-nil , zero value otherwise . func ( c *Contributor ) GetAvatarURL ( ) string { if c == nil || c.AvatarURL == nil { @ @ -2556,6 +2572,38 @ @ func ( m *MembershipEvent ) GetScope ( ) string { return *m.Scope } +// GetHTMLURL returns the HTMLURL field if it 's non-nil , zero value otherwise . +func ( m *Metric ) GetHTMLURL
diff -- git a/assets/questions/incNumber.js b/assets/questions/incNumber.js new file mode 100644 index 0000000..89a0bb3 -- - /dev/null +++ b/assets/questions/incNumber.js @ @ -0,0 +1,165 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for incrementDecCodedNumber . + */ + + +/* eslint no-magic-numbers : [ `` error '' , + { `` ignore '' : [ 0 , 1 , 2 , 3 , 4 , 5 , 6 , 7 , 8 , 9 ] } ] */ + +globalData.questions [ 'incNumber ' ] = {
diff -- git a/assets/questions/longestSub.js b/assets/questions/longestSub.js new file mode 100755 index 0000000..d9c034e -- - /dev/null +++ b/assets/questions/longestSub.js @ @ -0,0 +1,79 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Run-Length Encoding . + */ + +globalData.questions [ 'longestSub ' ] = { // eslint-disable-line dot-notation + title : 'Run-Length Encoding ' , + starterCode : { + python : + ` def longestSubstring ( seq ) : + return `` '' + ` + } , + auxiliaryCode : { + python
diff -- git a/assets/question_sets/strings.js b/assets/question_sets/strings.js index 197eda5..2061a3d 100644 -- - a/assets/question_sets/strings.js +++ b/assets/question_sets/strings.js @ @ -26,5 +26,5 @ @ globalData.questionSets [ 'strings ' ] = { // eslint-disable-line dot-notation `` I will provide you with feedback . '' ] .join ( `` ) ] , - questionIds : [ 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' ] + questionIds : [ 'triangle ' , 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' ] } ; diff -- git a/assets/questions/longestSub.js b/assets/questions/longestSub.js new file mode 100755 index 0000000..a0345c3 -- - /dev/null +++ b/assets/questions/longestSub.js @ @ -0,0 +1,76 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express
diff -- git a/assets/question_sets/strings.js b/assets/question_sets/strings.js index 197eda5..4071519 100644 -- - a/assets/question_sets/strings.js +++ b/assets/question_sets/strings.js @ @ -26,5 +26,5 @ @ globalData.questionSets [ 'strings ' ] = { // eslint-disable-line dot-notation `` I will provide you with feedback . '' ] .join ( `` ) ] , - questionIds : [ 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' ] + questionIds : [ 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' , 'sortItinerary ' ] } ; diff -- git a/assets/questions/sortItinerary.js b/assets/questions/sortItinerary.js new file mode 100644 index 0000000..6272c64 -- - /dev/null +++ b/assets/questions/sortItinerary.js @ @ -0,0 +1,131 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express
diff -- git a/assets/questions/sortItinerary.js b/assets/questions/sortItinerary.js new file mode 100644 index 0000000..9c54b5e -- - /dev/null +++ b/assets/questions/sortItinerary.js @ @ -0,0 +1,159 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Sort Scrambled Itinerary . + */ + +globalData.questions [ 'sortItinerary ' ] = { // eslint-disable-line dot-notation + title : 'Sort Scrambled Itinerary ' , + starterCode : { + python : + ` def sortItinerary ( tickets ) : + return `` '' + ` + } , + auxiliaryCode : {
diff -- git a/assets/question_sets/all.js b/assets/question_sets/all.js index 838da17..cde91f6 100644 -- - a/assets/question_sets/all.js +++ b/assets/question_sets/all.js @ @ -37,8 +37,10 @ @ globalData.questionSets [ 'all ' ] = { // eslint-disable-line dot-notation 'incrementDecimalCodedNumber ' , 'internationalization ' , 'isPalindrome ' , + 'longestSubstring ' , 'reverseWords ' , 'runLengthEncoding ' , + 'sortItinerary ' , 'splitStringIntoWords' ] } ; diff -- git a/assets/question_sets/other.js b/assets/question_sets/other.js index ffe1304..849a705 100644 -- - a/assets/question_sets/other.js +++ b/assets/question_sets/other.js @ @ -36,6 +36,8 @ @ globalData.questionSets [ 'other ' ] = { // eslint-disable-line dot-notation 'findFirstNonRepeatingCharacter ' , 'getStrobogrammaticNumbers ' , 'incrementDecimalCodedNumber ' , + 'longestSubstring ' , + 'sortItinerary ' , 'splitStringIntoWords' ] } ; diff -- git a/assets/questions/sortItinerary.js b/assets/questions/sortItinerary.js new file mode 100644 index 0000000..d47758f -- - /dev/null +++ b/assets/questions/sortItinerary.js @ @ -0,0 +1,204 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +//
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index fa8231e..be192f3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -71,6 +71,9 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ng-click= '' resetCode ( ) '' > Reset Code < /button > + < div class= '' tie-code-auto-save '' ng-show= '' displayAutoSaveText '' > + Saving code now ... + < /div > < button class= '' tie-run-button '' ng-class= '' { 'active ' : ! nextButtonIsShown } '' ng-click= '' submitCode ( code ) '' @ @ -120,6 +123,12 @ @ tie.directive ( 'learnerView ' , [ function ( ) { top : calc ( 50 % - 25px ) ; width : 50px ; } + .tie-code-auto-save { + font-family : Roboto , 'Helvetica Neue ' , 'Lucida Grande ' , sans-serif ; + float : left ; + margin-top : 10px ; + margin-left : 10px ; + } .tie-code-reset { float : left ; margin-top : 10px ; @ @ -370,6 +379,13 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ] .join ( '\n ' ) ] ; + var SECONDS_TO_MILLISECONDS = 1000 ; + // Default time interval in seconds that codes
diff -- git a/client/app.html b/client/app.html index 19a9e1d..7de21bb 100644 -- - a/client/app.html +++ b/client/app.html @ @ -50,7 +50,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > - < script src= '' services/CodeStorageService.js '' > < /script > + < script src= '' services/LocalStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 562945f..8908742 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -61,7 +61,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < div > - < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage '' > + < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage track by $ index '' > < hr > < p ng-if= '' set.feedbackParagraphs ''
diff -- git a/client/app.html b/client/app.html index 13bbe3e..ecf62f4 100644 -- - a/client/app.html +++ b/client/app.html @ @ -51,7 +51,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > - < script src= '' services/CodeStorageService.js '' > < /script > + < script src= '' services/LocalStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index d6ec364..a5d4161 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -61,7 +61,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < div > - < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage '' > + < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage track by $ index '' > < hr > < p ng-if= '' set.feedbackParagraphs ''
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..3cd1dc5 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,57 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + + # Usage : + # Not meant for manual use + # Runs automatically before a git push command is executed + # Behaviour can be set up using `` bash scripts/setup_hooks.sh '' + + # Ask user if push should
diff -- git a/assets/tests/QuestionSchemaValidationService.js b/assets/tests/QuestionSchemaValidationService.js index 3b0a0b8..0d0f9da 100644 -- - a/assets/tests/QuestionSchemaValidationService.js +++ b/assets/tests/QuestionSchemaValidationService.js @ @ -60,6 +60,11 @ @ tie.factory ( 'QuestionSchemaValidationService ' , [ angular.isArray ( question.getTasks ( ) ) & & question.getTasks ( ) .length > 0 ) ; } , + verifyAtLeastOneBuggyOutputTestExists : function ( question ) { + return question.getTasks ( ) .some ( function ( task ) { + return task.getBuggyOutputTests ( ) .length > 0 ; + } ) ; + } , verifyStyleTestsAreArray : function ( question ) { return angular.isArray ( question.getStyleTests ( ) ) ; } , diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 156307b..e226acc 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -23,7 +23,7 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { var questions = [ ] ; // Hardcoded number of functions in QuestionSchemaValidationService . // Update if you add new question schema tests . - var EXPECTED_VERIFIER_FUNCTION_COUNT = 11 ; + var EXPECTED_VERIFIER_FUNCTION_COUNT = 12 ; // Should contain all question IDs . // TODO ( eyurko ) : Figure out a way to dynamically check to make sure // that all question IDs are specified . @ @ -47,6 +47,18 @ @ describe ( 'QuestionSchemaValidationService
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..9793840 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index dd56227..aa064a4 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -77,5 +77,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..a4825f6 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'tests/*.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data :
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..a4825f6 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'tests/*.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data :
diff -- git a/client/services/SolutionHandlerService.js b/client/services/SolutionHandlerService.js index 3a074d2..2779b24 100644 -- - a/client/services/SolutionHandlerService.js +++ b/client/services/SolutionHandlerService.js @ @ -49,9 +49,9 @ @ tie.factory ( 'SolutionHandlerService ' , [ studentCode.trim ( ) ) ; CodePreprocessorDispatcherService.preprocess ( language , codeSubmission , auxiliaryCode , - task.getMainFunctionName ( ) , task.getOutputFunctionName ( ) , - task.getCorrectnessTests ( ) , task.getBuggyOutputTests ( ) , - task.getPerformanceTests ( ) ) ; + task.getInputFunctionName ( ) , task.getMainFunctionName ( ) , + task.getOutputFunctionName ( ) , task.getCorrectnessTests ( ) , + task.getBuggyOutputTests ( ) , task.getPerformanceTests ( ) ) ; return CodeRunnerDispatcherService.runCodeAsync ( language , codeSubmission.getPreprocessedCode ( ) diff -- git a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js index 26947f2..c81d167 100644 -- - a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js +++ b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js @ @ -22,12 +22,12 @ @ tie.factory ( 'CodePreprocessorDispatcherService ' , [ function ( PythonCodePreprocessorService , LANGUAGE_PYTHON ) { return { preprocess : function ( - language , codeSubmission , auxiliaryCode , mainFunctionName , + language , codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests ) { if ( language === LANGUAGE_PYTHON ) { return PythonCodePreprocessorService.preprocess ( - codeSubmission , auxiliaryCode , mainFunctionName , outputFunctionName , + codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aa4c655..a935465 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -106,9 +106,6 @ @ tie.directive ( 'learnerView ' , [ function ( ) { font-family : Roboto , 'Helvetica Neue ' , 'Lucida Grande ' , sans-serif ; font-size : 15px ; } - .CodeMirror-scroll > .CodeMirror-gutters { - z-index : 1 ; - } .tie-arrow-highlighter { background-color : white ; border-radius : 100px ;
diff -- git a/hooks/pre-commit b/hooks/pre-commit new file mode 100644 index 0000000..9d1e387 -- - /dev/null +++ b/hooks/pre-commit @ @ -0,0 +1 @ @ +echo `` Test pre-commit hook '' diff -- git a/hooks/pre-commit-msg b/hooks/pre-commit-msg new file mode 100755 index 0000000..9ed8bbf -- - /dev/null +++ b/hooks/pre-commit-msg @ @ -0,0 +1,3 @ @ + # ! bin/sh + +echo `` # Please include a useful commit message ! '' > $ 1 diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100644 index 0000000..5e8f505 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,4 @ @ + # ! /bin/sh + # This is a test pre-push hook + +echo `` This script is running ''
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index d8ec165..e5cd917 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -444,8 +444,8 @ @ tie.directive ( 'learnerView ' , [ function ( ) { indentUnit : 4 , lineNumbers : true , mode : LANGUAGE_PYTHON , - smartIndent : false , - tabSize : 4 + smartIndent : true , + tabSize : 4 , } ; $ scope.showNextTask = function ( ) {
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.gitignore b/.gitignore index 30f930d..fdba19e 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ tools/* .DS_Store assets/.DS_Store karma_coverage_reports/* +assets/questions/*.js~ diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..ba9f9dc 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -477,10 +477,20 @ @ tie.directive ( 'learnerView ' , [ function ( ) { feedbackDiv.scrollTop = feedbackDiv.scrollHeight + additionalHeightForLoadingIndicator ; $ timeout ( function ( ) { + var index = 0 ; + fn = function ( ) { SolutionHandlerService.processSolutionAsync ( - tasks [ currentTaskIndex ] , code , + tasks [ index ] , code , question.getAuxiliaryCode ( language ) , language - ) .then ( setFeedback ) ; + ) .then ( function ( feedback ) { + if ( index == currentTaskIndex || ! feedback.isAnswerCorrect ( ) ) { + setFeedback ( feedback ) ; + } else { + index += 1 ; + fn ( ) ; + } + } ) } ; + fn ( ) ; } , DURATION_MSEC_WAIT_FOR_SCROLL ) ; } , 0 ) ; } ;
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..eec7dae 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..cc05003 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,18 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + seleniumAddress : 'http : //localhost:4444/wd/hub ' , + specs : [ 'testing/page-loading-spec.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data : text/html , < html > < /html > as resetUrl , but + // location.replace from the data : to the file : protocol is not allowed + // ( we 'll get  not allowed local resource  error ) , so we replace resetUrl with one + // with the file : protocol ( this particular one will open system 's root folder ) + browser.resetUrl = 'file :
diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..c586ff7 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'testing/page-loading-spec.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data : text/html , < html > < /html > as resetUrl , but + // location.replace from the data : to the file : protocol is not allowed + // ( we 'll get  not allowed local resource  error ) , so we replace resetUrl with one + // with the file : protocol ( this particular one will open system 's root folder ) + browser.resetUrl = 'file : // ' ; + } + } ;
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..a4825f6 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'tests/*.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data :
diff -- git a/client/domain/CorrectnessTestObjectFactory.js b/client/domain/CorrectnessTestObjectFactory.js index 587054d..63e448b 100644 -- - a/client/domain/CorrectnessTestObjectFactory.js +++ b/client/domain/CorrectnessTestObjectFactory.js @ @ -31,7 +31,9 @ @ tie.factory ( 'CorrectnessTestObjectFactory ' , [ } ; CorrectnessTest.prototype.matchesOutput = function ( output ) { - return this._allowedOutputs.indexOf ( output ) ! == -1 ; + return this._allowedOutputs.some ( function ( allowedOutput ) { + return angular.equals ( allowedOutput , output ) ; + } ) ; } ; CorrectnessTest.prototype.getAnyAllowedOutput = function ( ) {
diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } ,
diff -- git a/client/services/SolutionHandlerService.js b/client/services/SolutionHandlerService.js index 3a074d2..83731ad 100644 -- - a/client/services/SolutionHandlerService.js +++ b/client/services/SolutionHandlerService.js @ @ -49,9 +49,9 @ @ tie.factory ( 'SolutionHandlerService ' , [ studentCode.trim ( ) ) ; CodePreprocessorDispatcherService.preprocess ( language , codeSubmission , auxiliaryCode , - task.getMainFunctionName ( ) , task.getOutputFunctionName ( ) , - task.getCorrectnessTests ( ) , task.getBuggyOutputTests ( ) , - task.getPerformanceTests ( ) ) ; + task.getInputFunctionName ( ) , task.getMainFunctionName ( ) , + task.getOutputFunctionName ( ) , task.getCorrectnessTests ( ) , + task.getBuggyOutputTests ( ) , task.getPerformanceTests ( ) ) ; return CodeRunnerDispatcherService.runCodeAsync ( language , codeSubmission.getPreprocessedCode ( ) diff -- git a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js index 26947f2..c81d167 100644 -- - a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js +++ b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js @ @ -22,12 +22,12 @ @ tie.factory ( 'CodePreprocessorDispatcherService ' , [ function ( PythonCodePreprocessorService , LANGUAGE_PYTHON ) { return { preprocess : function ( - language , codeSubmission , auxiliaryCode , mainFunctionName , + language , codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests ) { if ( language === LANGUAGE_PYTHON ) { return PythonCodePreprocessorService.preprocess ( - codeSubmission , auxiliaryCode , mainFunctionName , outputFunctionName , + codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests
diff -- git a/.gitignore b/.gitignore index 30f930d..fdba19e 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ tools/* .DS_Store assets/.DS_Store karma_coverage_reports/* +assets/questions/*.js~ diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..ba9f9dc 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -477,10 +477,20 @ @ tie.directive ( 'learnerView ' , [ function ( ) { feedbackDiv.scrollTop = feedbackDiv.scrollHeight + additionalHeightForLoadingIndicator ; $ timeout ( function ( ) { + var index = 0 ; + fn = function ( ) { SolutionHandlerService.processSolutionAsync ( - tasks [ currentTaskIndex ] , code , + tasks [ index ] , code , question.getAuxiliaryCode ( language ) , language - ) .then ( setFeedback ) ; + ) .then ( function ( feedback ) { + if ( index == currentTaskIndex || ! feedback.isAnswerCorrect ( ) ) { + setFeedback ( feedback ) ; + } else { + index += 1 ; + fn ( ) ; + } + } ) } ; + fn ( ) ; } , DURATION_MSEC_WAIT_FOR_SCROLL ) ; } , 0 ) ; } ;
diff -- git a/.gitignore b/.gitignore index 30f930d..fdba19e 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ tools/* .DS_Store assets/.DS_Store karma_coverage_reports/* +assets/questions/*.js~ diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..8f15378 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -477,10 +477,22 @ @ tie.directive ( 'learnerView ' , [ function ( ) { feedbackDiv.scrollTop = feedbackDiv.scrollHeight + additionalHeightForLoadingIndicator ; $ timeout ( function ( ) { - SolutionHandlerService.processSolutionAsync ( - tasks [ currentTaskIndex ] , code , + var index = 0 ; + var fn = function ( ) { + SolutionHandlerService.processSolutionAsync ( + tasks [ index ] , code , question.getAuxiliaryCode ( language ) , language - ) .then ( setFeedback ) ; + ) .then ( function ( feedback ) { + if ( index === currentTaskIndex || + ! feedback.isAnswerCorrect ( ) ) { + setFeedback ( feedback ) ; + } else { + index += 1 ; + fn ( ) ; + } + } ) ; + } ; + fn ( ) ; } , DURATION_MSEC_WAIT_FOR_SCROLL ) ; } , 0 ) ; } ;
diff -- git a/.gitignore b/.gitignore index 30f930d..a945bff 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ tools/* .DS_Store assets/.DS_Store karma_coverage_reports/* +*~ diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 2eb93bc..640de81 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -492,10 +492,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { feedbackDiv.scrollTop = feedbackDiv.scrollHeight + additionalHeightForLoadingIndicator ; $ timeout ( function ( ) { + // Tasks from the first to current . + var tasksToCurrent = [ ] ; + for ( var index = 0 ; index < = currentTaskIndex ; index++ ) { + tasksToCurrent = tasksToCurrent.concat ( tasks [ index ] ) ; + } SolutionHandlerService.processSolutionAsync ( - tasks [ currentTaskIndex ] , code , + tasksToCurrent , code , question.getAuxiliaryCode ( language ) , language - ) .then ( setFeedback ) ; + ) .then ( setFeedback ) ; } , DURATION_MSEC_WAIT_FOR_SCROLL ) ; } , 0 ) ; CodeStorageService.storeCode ( diff -- git a/client/services/FeedbackGeneratorService.js b/client/services/FeedbackGeneratorService.js index 879cc34..aa9879b 100644 -- - a/client/services/FeedbackGeneratorService.js +++ b/client/services/FeedbackGeneratorService.js @ @ -161,7 +161,7 @ @ tie.factory ( 'FeedbackGeneratorService ' , [ } ; return { - getFeedback : function ( task , codeEvalResult , rawCodeLineIndexes ) { +
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 327696c..b33bf4b 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -545,6 +545,12 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-step-unlocked { background-color : rgb ( 0 , 128 , 0 ) ; } + .CodeMirror-line.tie-syntax-error-line { + background : # FBC2C4 ; + } + .tie-wrapper.night-mode .CodeMirror-line.tie-syntax-error-line { + background : # 891111 ; + } .tie-wrapper { height : 100 % ; } @ @ -583,6 +589,14 @ @ tie.directive ( 'learnerView ' , [ function ( ) { var ALLOWED_QUESTION_SET_IDS = [ 'strings ' , 'other ' , 'all ' ] ; /** + * Name of the class for styling highlighted syntax errors . + * + * @ type { string } + * @ constant + */ + var CSS_CLASS_SYNTAX_ERROR = 'tie-syntax-error-line ' ; + + /** * Sets a local variable language to the value of the constant * LANGUAGE_PYTHON . * @ @ -757,6 +771,28 @ @ tie.directive ( 'learnerView ' , [ function ( ) { } ; /** + * Highlights the syntax errors in the coding UI + * + * @ param { number } lineNumber + */ +
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index 9438279..2e3265b 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -79,9 +79,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < select ng-if= '' SERVER_URL '' class= '' tie-select-menu '' name= '' lang-select-menu '' > < option value= '' Python '' selected > Python < /option > < /select > - < button ng-if= '' ! SERVER_URL '' class= '' tie-python-primer tie-button '' > - < a class= '' tie-primer-link '' target= '' _blank '' ng-href= '' { { getPythonPrimerUrl ( ) } } '' > New to python ? < /a > - < /button > + < a ng-if= '' ! SERVER_URL '' class= '' tie-primer-link tie-python-primer '' target= '' _blank '' ng-href= '' { { getPythonPrimerUrl ( ) } } '' > New to python ? < /a > < button class= '' tie-code-reset tie-button protractor-test-reset-code-btn '' name= '' code-reset '' ng-click= '' resetCode ( ) '' > Reset Code @ @ -204,7 +202,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { float : left ; margin-top : 10px ; } - .night-mode .tie-code-reset , .night-mode .tie-python-primer { + .night-mode .tie-code-reset { background-color :
diff -- git a/client/services/code_preprocessors/PythonCodePreprocessorService.js b/client/services/code_preprocessors/PythonCodePreprocessorService.js index 5315cd9..d50f544 100644 -- - a/client/services/code_preprocessors/PythonCodePreprocessorService.js +++ b/client/services/code_preprocessors/PythonCodePreprocessorService.js @ @ -247,10 +247,10 @ @ tie.factory ( 'PythonCodePreprocessorService ' , [ ' time_array = [ ] ' , ' for input_size in [ ' + SMALL_INPUT_SIZE + ( ' , ' + LARGE_INPUT_SIZE + ' ] : ' ) , - ' start = time.time ( ) ' , + ' start = time.clock ( ) ' , ' output = ' + qualifiedEvaluationFunctionName + ( ' ( get_test_input ( test_input , input_size ) ) ' ) , - ' finish = time.time ( ) - start ' , + ' finish = time.clock ( ) - start ' , ' time_array.append ( finish ) ' , ' if time_array [ 1 ] > ' + UPPER_BOUND_RATIO_IF_LINEAR + ( ' * time_array [ 0 ] : ' ) , diff -- git a/client/services/code_preprocessors/PythonCodePreprocessorServiceSpec.js b/client/services/code_preprocessors/PythonCodePreprocessorServiceSpec.js index 5dcc3e9..dcc0511 100644 -- - a/client/services/code_preprocessors/PythonCodePreprocessorServiceSpec.js +++ b/client/services/code_preprocessors/PythonCodePreprocessorServiceSpec.js @ @ -604,9 +604,9 @ @ describe ( 'PythonCodePreprocessorService ' , function ( ) { 'def run_performance_test ( test_input ) : ' , ' time_array = [ ] ' , ' for input_size in [ 10 , 100 ] : ' , - '
diff -- git a/.DS_Store b/.DS_Store new file mode 100644 index 0000000..37762b3 Binary files /dev/null and b/.DS_Store differ diff -- git a/assets/.DS_Store b/assets/.DS_Store new file mode 100644 index 0000000..56a83de Binary files /dev/null and b/assets/.DS_Store differ diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 41aa28d..7fc1646 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -22,7 +22,6 @ @ globalData.questions [ 'i18n ' ] = { python : ` def abbreviate ( word ) : return `` '' - def are_all_unique ( words ) : return True ` @ @ -32,12 +31,10 @ @ def are_all_unique ( words ) : ` def forgetLastLetter ( word ) : result = `` % s % d '' % ( word [ 0 ] , len ( word ) - 2 ) if len ( word ) > 2 else word return result - def useFirstAndLastLetterAndLengthToAbbreviate ( word ) : if word : return `` % s % d % s '' % ( word [ 0 ] , len ( word ) - 2 , word [ len ( word ) - 1 ] ) return `` '' - def createListOfUniqueStrings ( atom , size ) : result = [ ] for i in range ( size )
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 647704a..3109350 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -29,27 +29,31 @ @ def are_all_unique ( words ) : } , auxiliaryCode : { python : - ` def forgetLastLetter ( word ) : - result = `` % s % d '' % ( word [ 0 ] , len ( word ) - 2 ) if len ( word ) > 2 else word - return result + ` class AuxiliaryCode ( object ) : + @ classmethod + def forgetLastLetter ( cls , word ) : + result = `` % s % d '' % ( word [ 0 ] , len ( word ) - 2 ) if len ( word ) > 2 else word + return result -def useFirstAndLastLetterAndLengthToAbbreviate ( word ) : - if word : - return `` % s % d % s '' % ( word [ 0 ] , len ( word ) - 2 , word [ len ( word ) - 1 ] ) - return `` '' + @ classmethod + def useFirstAndLastLetterAndLengthToAbbreviate ( cls , word ) : + if word : + return `` % s %
diff -- git a/client/services/SolutionHandlerService.js b/client/services/SolutionHandlerService.js index 3a074d2..83731ad 100644 -- - a/client/services/SolutionHandlerService.js +++ b/client/services/SolutionHandlerService.js @ @ -49,9 +49,9 @ @ tie.factory ( 'SolutionHandlerService ' , [ studentCode.trim ( ) ) ; CodePreprocessorDispatcherService.preprocess ( language , codeSubmission , auxiliaryCode , - task.getMainFunctionName ( ) , task.getOutputFunctionName ( ) , - task.getCorrectnessTests ( ) , task.getBuggyOutputTests ( ) , - task.getPerformanceTests ( ) ) ; + task.getInputFunctionName ( ) , task.getMainFunctionName ( ) , + task.getOutputFunctionName ( ) , task.getCorrectnessTests ( ) , + task.getBuggyOutputTests ( ) , task.getPerformanceTests ( ) ) ; return CodeRunnerDispatcherService.runCodeAsync ( language , codeSubmission.getPreprocessedCode ( ) diff -- git a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js index 26947f2..c81d167 100644 -- - a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js +++ b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js @ @ -22,12 +22,12 @ @ tie.factory ( 'CodePreprocessorDispatcherService ' , [ function ( PythonCodePreprocessorService , LANGUAGE_PYTHON ) { return { preprocess : function ( - language , codeSubmission , auxiliaryCode , mainFunctionName , + language , codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests ) { if ( language === LANGUAGE_PYTHON ) { return PythonCodePreprocessorService.preprocess ( - codeSubmission , auxiliaryCode , mainFunctionName , outputFunctionName , + codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests
diff -- git a/.gitignore b/.gitignore index 30f930d..a945bff 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ tools/* .DS_Store assets/.DS_Store karma_coverage_reports/* +*~ diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..27b6fb7 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -29,8 +29,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ng-repeat= '' questionId in questionIds track by $ index '' ng-click= '' navigateToQuestion ( $ index ) '' > < div class= '' tie-step-circle '' ng-class= '' { 'tie-step-active ' : currentQuestionIndex === $ index , 'tie-step-unlocked ' : questionsCompletionStatus [ $ index ] } '' > - < span class= '' tie-step-text '' , ng-show= '' ! questionsCompletionStatus [ $ index ] '' > { { $ index + 1 } } < /span > - < span class= '' tie-step-checkmark '' , ng-show= '' questionsCompletionStatus [ $ index ] '' > & # 10004 ; < /span > + < span class= '' tie-step-text '' > { { $ index + 1 } } < /span > < /div > < div ng-class= '' { 'tie-step-line ' : $ index < ( questionIds.length - 1 ) } '' > < /div > < /div >
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..0f49ab3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 647704a..477e23b 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -29,26 +29,31 @ @ def are_all_unique ( words ) : } , auxiliaryCode : { python : - ` def forgetLastLetter ( word ) : - result = `` % s % d '' % ( word [ 0 ] , len ( word ) - 2 ) if len ( word ) > 2 else word - return result + ` class AuxiliaryCode ( object ) : + @ classmethod + def forgetLastLetter ( cls , word ) : + result = `` % s % d '' % ( word [ 0 ] , len ( word ) - 2 ) if len ( word ) > 2 else word + return result -def useFirstAndLastLetterAndLengthToAbbreviate ( word ) : - if word : - return `` % s % d % s '' % ( word [ 0 ] , len ( word ) - 2 , word [ len ( word ) - 1 ] ) - return `` '' + @ classmethod + def useFirstAndLastLetterAndLengthToAbbreviate ( cls , word ) : + if word : + return `` % s %
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index 65f9b1b..ab468ed 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -116,7 +116,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < div class= '' tie-code-auto-save '' ng-class= '' { 'night-mode ' : isInDarkMode } '' ng-show= '' autosaveTextIsDisplayed '' > Saving code ... < /div > - < button class= '' tie-run-button tie-button tie-blue protractor-test-run-code-btn '' + < button class= '' tie-run-button tie-button tie-button-blue protractor-test-run-code-btn '' ng-class= '' { 'active ' : ! nextButtonIsShown } '' ng-click= '' submitCode ( editorContents.code ) '' ng-disabled= '' nextButtonIsShown '' > @ @ -137,6 +137,8 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > + < privacy-modal is-displayed='privacyModalIsDisplayed ' is-client-version= '' ! SERVER_URL '' > + < /privacy-modal > < style > div.CodeMirror span.CodeMirror-matchingbracket { color : rgb ( 75 , 206 , 75 ) ; @ @ -170,14 +172,22 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-button : hover { border : 1px solid # e4e4e4 ; } - .tie-button.tie-blue { + .tie-button-blue { background-color : rgb ( 66 , 133 , 244 ) ; color
diff -- git a/client/app.html b/client/app.html index 19a9e1d..e1be809 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' components/CodeSnippetDirective.js '' > < /script > < script src= '' components/LearnerViewDirective.js '' > < /script > < script src= '' components/SyntaxErrorSnippetDirective.js '' > < /script > + < script src= '' components/ModalDirective.js '' > < /script > < script src= '' domain/BuggyOutputTestObjectFactory.js '' > < /script > < script src= '' domain/CodeEvalResultObjectFactory.js '' > < /script > < script src= '' domain/CodeSubmissionObjectFactory.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 5fd15c8..7f80eb9 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -143,6 +143,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > + < modal > < /modal > < style > html { height : 100 % ; @ @ -547,6 +548,26 @ @ tie.directive ( 'learnerView ' , [ function ( ) { $ scope.editorContents = { code : `` } ; + /** + * Determines if the modal component will be displayed on the screen . + * + * @ type { boolean } + */ + $ scope.modalIsDisplayed
diff -- git a/client/app.html b/client/app.html index 19a9e1d..e1be809 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' components/CodeSnippetDirective.js '' > < /script > < script src= '' components/LearnerViewDirective.js '' > < /script > < script src= '' components/SyntaxErrorSnippetDirective.js '' > < /script > + < script src= '' components/ModalDirective.js '' > < /script > < script src= '' domain/BuggyOutputTestObjectFactory.js '' > < /script > < script src= '' domain/CodeEvalResultObjectFactory.js '' > < /script > < script src= '' domain/CodeSubmissionObjectFactory.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index f5b3c77..cf22597 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -153,6 +153,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > + < modal show='modalIsDisplayed ' title= ' { { modalTitle } } ' description= ' { { modalDescription } } ' > < /modal > < style > html { height : 100 % ; @ @ -582,6 +583,26 @ @ tie.directive ( 'learnerView ' , [ function ( ) { $ scope.editorContents = { code : `` } ; + /** + * Determines if the modal component will be displayed
diff -- git a/assets/questions/bestMeetupLocation.js b/assets/questions/bestMeetupLocation.js index 0a5e73d..4025fa9 100644 -- - a/assets/questions/bestMeetupLocation.js +++ b/assets/questions/bestMeetupLocation.js @ @ -76,13 +76,16 @ @ globalData.questions [ 'bestMeetupLocation ' ] = { // eslint-disable-line dot-notat mainFunctionName : 'bestMeetupLocation ' , correctnessTests : [ { input : [ '0 , 0 ' , '4 , 2 ' , '10 , 10 ' ] , - allowedOutputs : [ '4 , 2 ' ] + allowedOutputs : [ '4 , 2 ' ] , + tag : 'the general case' } , { input : [ '0 , 0 ' , '5 , 6 ' , '4 , 5 ' , '20 , 9 ' ] , - allowedOutputs : [ '4 , 5 ' , '4 , 6 ' , '5 , 5 ' , '5 , 6 ' ] + allowedOutputs : [ '4 , 5 ' , '4 , 6 ' , '5 , 5 ' , '5 , 6 ' ] , + tag : 'the general case' } , { input : [ ] , - allowedOutputs : [ `` ] + allowedOutputs : [ `` ] , + tag : 'empty input' } ] , buggyOutputTests : [ { buggyFunctionName : 'AuxiliaryCode.findAverageLocation
diff -- git a/assets/questions/bomberman.js b/assets/questions/bomberman.js index 5c23e53..fd2e4f8 100644 -- - a/assets/questions/bomberman.js +++ b/assets/questions/bomberman.js @ @ -96,25 +96,32 @ @ globalData.questions [ 'bomberman ' ] = { // eslint-disable-line dot-notation mainFunctionName : 'bomb ' , correctnessTests : [ { input : [ ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ ] , [ ] , [ ] ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` x '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 2 ] + allowedOutputs : [ 2 ] , + tag : 'single row boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 3 ] + allowedOutputs : [ 3 ] , + tag : 'single row boards' } , { input : [
diff -- git a/assets/questions/bomberman.js b/assets/questions/bomberman.js index 5c23e53..fd2e4f8 100644 -- - a/assets/questions/bomberman.js +++ b/assets/questions/bomberman.js @ @ -96,25 +96,32 @ @ globalData.questions [ 'bomberman ' ] = { // eslint-disable-line dot-notation mainFunctionName : 'bomb ' , correctnessTests : [ { input : [ ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ ] , [ ] , [ ] ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` x '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 2 ] + allowedOutputs : [ 2 ] , + tag : 'single row boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 3 ] + allowedOutputs : [ 3 ] , + tag : 'single row boards' } , { input : [
diff -- git a/assets/questions/bomberman.js b/assets/questions/bomberman.js index 5c23e53..fd2e4f8 100644 -- - a/assets/questions/bomberman.js +++ b/assets/questions/bomberman.js @ @ -96,25 +96,32 @ @ globalData.questions [ 'bomberman ' ] = { // eslint-disable-line dot-notation mainFunctionName : 'bomb ' , correctnessTests : [ { input : [ ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ ] , [ ] , [ ] ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` x '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 2 ] + allowedOutputs : [ 2 ] , + tag : 'single row boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 3 ] + allowedOutputs : [ 3 ] , + tag : 'single row boards' } , { input : [
diff -- git a/assets/questions/bomberman.js b/assets/questions/bomberman.js index 5c23e53..fd2e4f8 100644 -- - a/assets/questions/bomberman.js +++ b/assets/questions/bomberman.js @ @ -96,25 +96,32 @ @ globalData.questions [ 'bomberman ' ] = { // eslint-disable-line dot-notation mainFunctionName : 'bomb ' , correctnessTests : [ { input : [ ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ ] , [ ] , [ ] ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` x '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 2 ] + allowedOutputs : [ 2 ] , + tag : 'single row boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 3 ] + allowedOutputs : [ 3 ] , + tag : 'single row boards' } , { input : [
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index 32333a3..d73fd9b 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -884,10 +884,11 @ @ tie.directive ( 'learnerView ' , [ function ( ) { } } else { var feedbackParagraphs = feedback.getParagraphs ( ) ; + var errorLine = feedback.getErrorLineNumber ( ) ; for ( var i = 0 ; i < feedbackParagraphs.length ; i++ ) { clearAllHighlights ( ) ; - if ( feedbackParagraphs [ i ] .isErrorParagraph ( ) ) { - highlightLine ( feedbackParagraphs [ i ] .getErrorLineNumber ( ) ) ; + if ( errorLine ! == null ) { + highlightLine ( errorLine ) ; break ; } } diff -- git a/client/question/domain/FeedbackObjectFactory.js b/client/question/domain/FeedbackObjectFactory.js index 32bd394..4504ea5 100644 -- - a/client/question/domain/FeedbackObjectFactory.js +++ b/client/question/domain/FeedbackObjectFactory.js @ @ -61,6 +61,14 @ @ tie.factory ( 'FeedbackObjectFactory ' , [ * @ private */ this._feedbackCategory = feedbackCategory ; + + /** + * Line number that correlates to error that triggered . + * + * @ type { integer } + * @ private + */ + this._errorLineNumber = null ; } ; // Instance methods . @ @ -178,6 +186,24 @ @ tie.factory ( 'FeedbackObjectFactory ' , [ } ; /** + * A
diff -- git a/client/question/domain/PrereqCheckFailureObjectFactory.js b/client/question/domain/PrereqCheckFailureObjectFactory.js index ab8dad1..0297ecb 100644 -- - a/client/question/domain/PrereqCheckFailureObjectFactory.js +++ b/client/question/domain/PrereqCheckFailureObjectFactory.js @ @ -51,7 +51,7 @ @ tie.factory ( 'PrereqCheckFailureObjectFactory ' , [ * @ constructor */ var PrereqCheckFailure = function ( - type , badImports , starterCode , wrongLangKey ) { + type , badImports , starterCode , wrongLangKey , errorLine ) { /** * Indicates what type of failure occurred . * @ @ -86,6 +86,15 @ @ tie.factory ( 'PrereqCheckFailureObjectFactory ' , [ * @ private */ this._wrongLangKey = wrongLangKey ; + + /** + * Line number that correlates to error that triggered . + * Should be null if error type does not supply a line number + * + * @ type { integer | null } + * @ private + */ + this._errorLine = errorLine ; } ; // Instance methods . @ @ -243,6 +252,24 @ @ tie.factory ( 'PrereqCheckFailureObjectFactory ' , [ this._wrongLangKey = newKey ; } ; + /** + * A getter for the _errorLine property . + * + * @ returns { string } + */ + PrereqCheckFailure.prototype.getErrorLine = function ( ) { + return this._errorLine ; + } ; + + /** +
diff -- git a/client/question/domain/PrereqCheckErrorObjectFactory.js b/client/question/domain/PrereqCheckErrorObjectFactory.js new file mode 100644 index 0000000..74d3889 -- - /dev/null +++ b/client/question/domain/PrereqCheckErrorObjectFactory.js @ @ -0,0 +1,104 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Factory for creating a PrereqCheckError of a student 's TIE + * session . + */ + +tie.factory ( 'PrereqCheckErrorObjectFactory ' , [ + function ( ) { + /** + * PrereqCheckError objects are used to store information related to Prereq + errors . + */ + + /** + * Constructor for PrereqCheckError .
diff -- git a/.gitignore b/.gitignore index 30f930d..a945bff 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ tools/* .DS_Store assets/.DS_Store karma_coverage_reports/* +*~ diff -- git a/assets/questions/bomberman.js b/assets/questions/bomberman.js new file mode 100644 index 0000000..f0c5597 -- - /dev/null +++ b/assets/questions/bomberman.js @ @ -0,0 +1,148 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Bomberman . + */ + +globalData.questions [ 'bomberman ' ] = { // eslint-disable-line dot-notation + title : 'Bomberman ' , + starterCode : { + python : +
diff -- git a/.gitignore b/.gitignore index 30f930d..a945bff 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ tools/* .DS_Store assets/.DS_Store karma_coverage_reports/* +*~ diff -- git a/assets/questions/bomberman.js b/assets/questions/bomberman.js new file mode 100644 index 0000000..c62fdb3 -- - /dev/null +++ b/assets/questions/bomberman.js @ @ -0,0 +1,148 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Bomberman . + */ + +globalData.questions [ 'bomberman ' ] = { // eslint-disable-line dot-notation + title : 'Bomberman ' , + starterCode : { + python : +
diff -- git a/.gitignore b/.gitignore index 30f930d..fdba19e 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ tools/* .DS_Store assets/.DS_Store karma_coverage_reports/* +assets/questions/*.js~ diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..ca7e190 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -477,10 +477,14 @ @ tie.directive ( 'learnerView ' , [ function ( ) { feedbackDiv.scrollTop = feedbackDiv.scrollHeight + additionalHeightForLoadingIndicator ; $ timeout ( function ( ) { + var tasksToCurrent = [ ] ; // Tasks from the first to current . + for ( var i = 0 ; i < = currentTaskIndex ; i++ ) { + tasksToCurrent = tasksToCurrent.concat ( tasks [ i ] ) ; + } SolutionHandlerService.processSolutionAsync ( - tasks [ currentTaskIndex ] , code , + tasksToCurrent , code , question.getAuxiliaryCode ( language ) , language - ) .then ( setFeedback ) ; + ) .then ( setFeedback ) ; } , DURATION_MSEC_WAIT_FOR_SCROLL ) ; } , 0 ) ; } ; diff -- git a/client/services/FeedbackGeneratorService.js b/client/services/FeedbackGeneratorService.js index 879cc34..ff59e48 100644 -- - a/client/services/FeedbackGeneratorService.js +++ b/client/services/FeedbackGeneratorService.js @ @ -161,7 +161,7 @ @ tie.factory ( 'FeedbackGeneratorService ' , [ } ; return { - getFeedback : function ( task , codeEvalResult , rawCodeLineIndexes ) { + getFeedback
diff -- git a/.gitignore b/.gitignore index ed5d31d..a945bff 100644 -- - a/.gitignore +++ b/.gitignore @ @ -4,4 +4,3 @ @ tools/* assets/.DS_Store karma_coverage_reports/* *~ - diff -- git a/client/app.js b/client/app.js index 2bd611c..2878ef6 100644 -- - a/client/app.js +++ b/client/app.js @ @ -66,12 +66,24 @ @ tie.constant ( 'SYSTEM_CODE ' , { ] .join ( '\n ' ) } ) ; -// Name of the list in which correctness test results are stored . +// Name of the list in which correctness test results of all tasks are stored . tie.constant ( 'VARNAME_CORRECTNESS_TEST_RESULTS ' , 'correctness_test_results ' ) ; -// Name of the list in which buggy output test results are stored . +// Name of the list in which buggy output test results of all tasks are stored . tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; -// Name of the list in which performance test results are stored . +// Name of the list in which performance test results of all tasks are stored . tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; +// Name of the list in which +// correctness test results of one single task are stored . +tie.constant ( 'VARNAME_TASK_CORRECTNESS_TEST_RESULTS ' , + 'task_correctness_test_results '
diff -- git a/.gitignore b/.gitignore index ed5d31d..a945bff 100644 -- - a/.gitignore +++ b/.gitignore @ @ -4,4 +4,3 @ @ tools/* assets/.DS_Store karma_coverage_reports/* *~ - diff -- git a/client/app.js b/client/app.js index ec97263..c74705b 100644 -- - a/client/app.js +++ b/client/app.js @ @ -75,10 +75,22 @ @ tie.constant ( 'PREREQ_CHECK_TYPE_BAD_IMPORT ' , 'badImport ' ) ; // Name of the list in which correctness test results are stored . tie.constant ( 'VARNAME_CORRECTNESS_TEST_RESULTS ' , 'correctness_test_results ' ) ; -// Name of the list in which buggy output test results are stored . +// Name of the list in which buggy output test results of all tasks are stored . tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; -// Name of the list in which performance test results are stored . +// Name of the list in which performance test results of all tasks are stored . tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; +// Name of the list in which +// correctness test results of one single task are stored . +tie.constant ( 'VARNAME_TASK_CORRECTNESS_TEST_RESULTS ' , + 'task_correctness_test_results ' ) ; +// Name of the list in which +// buggy output test results of one single task are stored . +tie.constant
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..0f49ab3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..9793840 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..eec7dae 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..f9cf6ed 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,16 +343,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index dd56227..aa064a4 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -77,5 +77,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/client/services/SolutionHandlerService.js b/client/services/SolutionHandlerService.js index 3a074d2..2779b24 100644 -- - a/client/services/SolutionHandlerService.js +++ b/client/services/SolutionHandlerService.js @ @ -49,9 +49,9 @ @ tie.factory ( 'SolutionHandlerService ' , [ studentCode.trim ( ) ) ; CodePreprocessorDispatcherService.preprocess ( language , codeSubmission , auxiliaryCode , - task.getMainFunctionName ( ) , task.getOutputFunctionName ( ) , - task.getCorrectnessTests ( ) , task.getBuggyOutputTests ( ) , - task.getPerformanceTests ( ) ) ; + task.getInputFunctionName ( ) , task.getMainFunctionName ( ) , + task.getOutputFunctionName ( ) , task.getCorrectnessTests ( ) , + task.getBuggyOutputTests ( ) , task.getPerformanceTests ( ) ) ; return CodeRunnerDispatcherService.runCodeAsync ( language , codeSubmission.getPreprocessedCode ( ) diff -- git a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js index 26947f2..c81d167 100644 -- - a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js +++ b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js @ @ -22,12 +22,12 @ @ tie.factory ( 'CodePreprocessorDispatcherService ' , [ function ( PythonCodePreprocessorService , LANGUAGE_PYTHON ) { return { preprocess : function ( - language , codeSubmission , auxiliaryCode , mainFunctionName , + language , codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests ) { if ( language === LANGUAGE_PYTHON ) { return PythonCodePreprocessorService.preprocess ( - codeSubmission , auxiliaryCode , mainFunctionName , outputFunctionName , + codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests
diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 16d3944..85d2c58 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -21,6 +21,8 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation starterCode : { python : ` def reverseWords ( s ) : + # This reverseWords method processes a string ( s ) . + return `` '' ` } , diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index fc31b2d..dc8dcc2 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -89,14 +89,19 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /ui-codemirror > < /div > < /div > - < select ng-if= '' SERVER_URL '' - class= '' tie-select-menu '' - name= '' lang-select-menu '' > - < option value= '' Python '' selected > Python < /option > - < /select > < button class= '' tie-code-reset tie-button protractor-test-reset-code-btn '' name= '' code-reset '' ng-click= '' resetCode ( ) '' title= '' Click to clear your code '' > Reset Code < /button > + < p class= '' tie-language-label '' > Language : < span ng-if= '' supportedLanguageCount === 1 '' > { { languageLabel } } < /span > < /p > + < select + ng-if=
diff -- git a/client/app.html b/client/app.html index 19a9e1d..7de21bb 100644 -- - a/client/app.html +++ b/client/app.html @ @ -50,7 +50,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > - < script src= '' services/CodeStorageService.js '' > < /script > + < script src= '' services/LocalStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 562945f..8908742 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -61,7 +61,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < div > - < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage '' > + < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage track by $ index '' > < hr > < p ng-if= '' set.feedbackParagraphs ''
diff -- git a/client/app.html b/client/app.html index 13bbe3e..ecf62f4 100644 -- - a/client/app.html +++ b/client/app.html @ @ -51,7 +51,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > - < script src= '' services/CodeStorageService.js '' > < /script > + < script src= '' services/LocalStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index d6ec364..a5d4161 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -61,7 +61,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < div > - < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage '' > + < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage track by $ index '' > < hr > < p ng-if= '' set.feedbackParagraphs ''
diff -- git a/client/domain/QuestionSetObjectFactorySpec.js b/client/domain/QuestionSetObjectFactorySpec.js new file mode 100644 index 0000000..668568d -- - /dev/null +++ b/client/domain/QuestionSetObjectFactorySpec.js @ @ -0,0 +1,86 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Unit tests for QuestionSetObjectFactory domain objects . + */ + +describe ( 'QuestionSetObjectFactory ' , function ( ) { + var QuestionSetObjectFactory ; + + beforeEach ( module ( 'tie ' ) ) ; + beforeEach ( inject ( function ( $ injector ) { + QuestionSetObjectFactory = $ injector.get ( 'QuestionSetObjectFactory ' ) ; +
diff -- git a/client/services/FeedbackGeneratorServiceSpec.js b/client/services/FeedbackGeneratorServiceSpec.js index 92fa52f..c03b27f 100644 -- - a/client/services/FeedbackGeneratorServiceSpec.js +++ b/client/services/FeedbackGeneratorServiceSpec.js @ @ -19,6 +19,7 @ @ describe ( 'FeedbackGeneratorService ' , function ( ) { var BuggyOutputTestObjectFactory ; var CodeEvalResultObjectFactory ; + var CorrectnessTestObjectFactory ; var ErrorTracebackObjectFactory ; var FeedbackGeneratorService ; var SnapshotObjectFactory ; @ @ -32,11 +33,12 @ @ describe ( 'FeedbackGeneratorService ' , function ( ) { BuggyOutputTestObjectFactory = $ injector.get ( 'BuggyOutputTestObjectFactory ' ) ; CodeEvalResultObjectFactory = $ injector.get ( 'CodeEvalResultObjectFactory ' ) ; + CorrectnessTestObjectFactory = $ injector.get ( 'CorrectnessTestObjectFactory ' ) ; ErrorTracebackObjectFactory = $ injector.get ( 'ErrorTracebackObjectFactory ' ) ; FeedbackGeneratorService = $ injector.get ( 'FeedbackGeneratorService ' ) ; SnapshotObjectFactory = $ injector.get ( 'SnapshotObjectFactory ' ) ; - TracebackCoordinatesObjectFactory = $ injector.get ( - 'TracebackCoordinatesObjectFactory ' ) ; + TracebackCoordinatesObjectFactory = $ injector + .get ( 'TracebackCoordinatesObjectFactory ' ) ; TranscriptService = $ injector.get ( 'TranscriptService ' ) ; sampleErrorTraceback = ErrorTracebackObjectFactory.create ( @ @ -81,10 +83,61 @ @ describe ( 'FeedbackGeneratorService ' , function ( ) { c : 'j' } ) ) .toEqual ( ' { `` a '' : 3 , `` b '' : 5 , `` c '' : `` j '' } ' )
diff -- git a/client/services/code_evaluators/CodeRunnerDispatcherServiceSpec.js b/client/services/code_evaluators/CodeRunnerDispatcherServiceSpec.js new file mode 100644 index 0000000..2bc2a88 -- - /dev/null +++ b/client/services/code_evaluators/CodeRunnerDispatcherServiceSpec.js @ @ -0,0 +1,49 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Unit tests for the CodeRunnerDispatcherService . + */ + +describe ( 'CodeRunnerDispatcherService ' , function ( ) { + var CodeRunnerDispatcherService ; + var PythonCodeRunnerService ; + var LANGUAGE_PYTHON ; + + beforeEach ( module ( 'tie ' ) ) ; + beforeEach ( inject ( function ( $ injector ) { + CodeRunnerDispatcherService = $
diff -- git a/client/app.html b/client/app.html index d45841d..4c29a02 100644 -- - a/client/app.html +++ b/client/app.html @ @ -4,7 +4,10 @ @ < meta charset= '' UTF-8 '' > < meta name= '' viewport '' content= '' width=device-width , initial-scale=1.0 , user-scalable=yes '' > < link rel= '' stylesheet '' href= '' ../third_party/codemirror-5.19.0/lib/codemirror.css '' > + < link rel= '' stylesheet '' href= '' ../third_party/jquery-ui-1.12.1/jquery-ui.min.css '' > < link rel= '' stylesheet '' href= '' ../third_party/codemirror-5.19.0/lib/material.css '' > + < script src= '' ../third_party/jquery-3.2.1.min.js '' > < /script > + < script src= '' ../third_party/jquery-ui-1.12.1/jquery-ui.min.js '' > < /script > < script src= '' ../third_party/angular-1.6.1/angular.min.js '' > < /script > < script src= '' ../third_party/codemirror-5.19.0/lib/codemirror.js '' > < /script > < script src= '' ../third_party/codemirror-5.19.0/mode/python/python.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index ed13eee..5cace82 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -38,44 +38,47 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < div class= '' tie-coding-ui '' > - < div class= '' tie-feedback-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > - < div class= '' tie-feedback '' > - < p ng-repeat= '' paragraph
diff -- git a/assets/tests/TaskSchemaValidationService.js b/assets/tests/TaskSchemaValidationService.js index e6451be..4ac815f 100644 -- - a/assets/tests/TaskSchemaValidationService.js +++ b/assets/tests/TaskSchemaValidationService.js @ @ -201,7 +201,7 @ @ tie.factory ( 'TaskSchemaValidationService ' , [ verifyPerformanceTestsHaveLinearExpectedPerformance : function ( task ) { var performanceTests = task.getPerformanceTests ( ) ; return performanceTests.every ( function ( test ) { - return ALLOWED_RUNTIMES.includes ( test.getExpectedPerformance ( ) ) ; + return ALLOWED_RUNTIMES.indexOf ( test.getExpectedPerformance ( ) ) ! == -1 ; } ) ; } , verifyPerformanceTestsHaveEvaluationFunctionName : function ( task ) { diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..3cd1dc5 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,57 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS
diff -- git a/assets/tests/QuestionSchemaValidationService.js b/assets/tests/QuestionSchemaValidationService.js index 3b0a0b8..0d0f9da 100644 -- - a/assets/tests/QuestionSchemaValidationService.js +++ b/assets/tests/QuestionSchemaValidationService.js @ @ -60,6 +60,11 @ @ tie.factory ( 'QuestionSchemaValidationService ' , [ angular.isArray ( question.getTasks ( ) ) & & question.getTasks ( ) .length > 0 ) ; } , + verifyAtLeastOneBuggyOutputTestExists : function ( question ) { + return question.getTasks ( ) .some ( function ( task ) { + return task.getBuggyOutputTests ( ) .length > 0 ; + } ) ; + } , verifyStyleTestsAreArray : function ( question ) { return angular.isArray ( question.getStyleTests ( ) ) ; } , diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 156307b..0d79d0e 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -23,7 +23,7 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { var questions = [ ] ; // Hardcoded number of functions in QuestionSchemaValidationService . // Update if you add new question schema tests . - var EXPECTED_VERIFIER_FUNCTION_COUNT = 11 ; + var EXPECTED_VERIFIER_FUNCTION_COUNT = 12 ; // Should contain all question IDs . // TODO ( eyurko ) : Figure out a way to dynamically check to make sure // that all question IDs are specified . @ @ -47,6 +47,16 @ @ describe ( 'QuestionSchemaValidationService
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..a890175 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -29,8 +29,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ng-repeat= '' questionId in questionIds track by $ index '' ng-click= '' navigateToQuestion ( $ index ) '' > < div class= '' tie-step-circle '' ng-class= '' { 'tie-step-active ' : currentQuestionIndex === $ index , 'tie-step-unlocked ' : questionsCompletionStatus [ $ index ] } '' > - < span class= '' tie-step-text '' , ng-show= '' ! questionsCompletionStatus [ $ index ] '' > { { $ index + 1 } } < /span > - < span class= '' tie-step-checkmark '' , ng-show= '' questionsCompletionStatus [ $ index ] '' > & # 10004 ; < /span > + < span class= '' tie-step-text '' > { { $ index + 1 } } < /span > < /div > < div ng-class= '' { 'tie-step-line ' : $ index < ( questionIds.length - 1 ) } '' > < /div > < /div > @ @ -146,6 +145,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { outline : 0 ; } .tie-coding-ui , .tie-question-ui
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..0f49ab3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..9793840 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..9793840 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..00507a8 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -29,7 +29,8 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ng-repeat= '' questionId in questionIds track by $ index '' ng-click= '' navigateToQuestion ( $ index ) '' > < div class= '' tie-step-circle '' ng-class= '' { 'tie-step-active ' : currentQuestionIndex === $ index , 'tie-step-unlocked ' : questionsCompletionStatus [ $ index ] } '' > - < span class= '' tie-step-text '' > { { $ index + 1 } } < /span > + < span class= '' tie-step-text '' , ng-show= '' ! questionsCompletionStatus [ $ index ] '' > { { $ index + 1 } } < /span > + < span class= '' tie-step-checkmark , ng-hide '' , ng-show= '' questionsCompletionStatus [ $ index ] '' > & # 10003 ; < /span > < /div > < div ng-class= '' { 'tie-step-line ' : $ index < ( questionIds.length - 1 ) } '' > < /div > < /div > @ @ -328,7 +329,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { margin-top : auto ; width :
diff -- git a/client/services/SolutionHandlerService.js b/client/services/SolutionHandlerService.js index 3a074d2..83731ad 100644 -- - a/client/services/SolutionHandlerService.js +++ b/client/services/SolutionHandlerService.js @ @ -49,9 +49,9 @ @ tie.factory ( 'SolutionHandlerService ' , [ studentCode.trim ( ) ) ; CodePreprocessorDispatcherService.preprocess ( language , codeSubmission , auxiliaryCode , - task.getMainFunctionName ( ) , task.getOutputFunctionName ( ) , - task.getCorrectnessTests ( ) , task.getBuggyOutputTests ( ) , - task.getPerformanceTests ( ) ) ; + task.getInputFunctionName ( ) , task.getMainFunctionName ( ) , + task.getOutputFunctionName ( ) , task.getCorrectnessTests ( ) , + task.getBuggyOutputTests ( ) , task.getPerformanceTests ( ) ) ; return CodeRunnerDispatcherService.runCodeAsync ( language , codeSubmission.getPreprocessedCode ( ) diff -- git a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js index 26947f2..c81d167 100644 -- - a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js +++ b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js @ @ -22,12 +22,12 @ @ tie.factory ( 'CodePreprocessorDispatcherService ' , [ function ( PythonCodePreprocessorService , LANGUAGE_PYTHON ) { return { preprocess : function ( - language , codeSubmission , auxiliaryCode , mainFunctionName , + language , codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests ) { if ( language === LANGUAGE_PYTHON ) { return PythonCodePreprocessorService.preprocess ( - codeSubmission , auxiliaryCode , mainFunctionName , outputFunctionName , + codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests
diff -- git a/.eslintrc.json b/.eslintrc.json index 968f1b6..d21745e 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -55,8 +55,8 @ @ `` linebreak-style '' : `` error '' , `` max-depth '' : `` error '' , `` max-len '' : [ `` error '' , { - `` ignoreStrings '' : true , `` ignoreTemplateLiterals '' : true , + `` ignoreTrailingComments '' : true , `` ignoreUrls '' : true } ] , `` max-nested-callbacks '' : `` error '' , diff -- git a/assets/questions/checkBalancedParentheses.js b/assets/questions/checkBalancedParentheses.js index 3f044d0..5283e22 100644 -- - a/assets/questions/checkBalancedParentheses.js +++ b/assets/questions/checkBalancedParentheses.js @ @ -175,7 +175,8 @ @ globalData.questions [ 'checkBalancedParentheses ' ] = { // eslint-disable-line dot buggyOutputTests : [ ] , performanceTests : [ { inputDataAtom : ' ( ) ' , - transformationFunctionName : 'AuxiliaryCode.createBalancedParenthesesString ' , + transformationFunctionName : ( + 'AuxiliaryCode.createBalancedParenthesesString ' ) , expectedPerformance : 'linear ' , evaluationFunctionName : 'isBalanced' } ] diff -- git a/assets/questions/getStrobogrammaticNumbers.js b/assets/questions/getStrobogrammaticNumbers.js index dd539a5..81b943c 100644 -- - a/assets/questions/getStrobogrammaticNumbers.js +++ b/assets/questions/getStrobogrammaticNumbers.js @ @ -86,7 +86,10 @ @ globalData.questions [ 'getStrobogrammaticNumbers ' ] = { // eslint-disable-line do { buggyFunctionName : 'AuxiliaryCode.allowLeadingZeroInResult ' , messages : [ - `` Try running your code on 2-digit numbers . Did
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 7569333..b0249cc 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -41,8 +41,8 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < div class= '' tie-feedback-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > < div class= '' tie-feedback '' > < p ng-repeat= '' paragraph in feedbackParagraphs track by $ index '' - class= '' tie-feedback-paragraph '' - ng-class= '' { 'tie-feedback-paragraph-code ' : paragraph.isCodeParagraph ( ) } '' > + class= '' tie-feedback-paragraph '' + ng-class= '' { 'tie-feedback-paragraph-code ' : paragraph.isCodeParagraph ( ) } '' > < span ng-if= '' $ first '' > { { feedbackTimestamp } } < /span > < span ng-if= '' paragraph.isTextParagraph ( ) '' > { { paragraph.getContent ( ) } } @ @ -52,6 +52,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /span > < /p > < /div > + < div class= '' tie-feedback-syntax-error '' > + < a href class= '' tie-feedback-syntax-error-link '' , + ng-click= '' toggleSyntaxErrorHint ( ) '' , + ng-show= '' syntaxErrorFound '' > + { { isSyntaxErrorShown ? 'Hide error details ' : 'Display error
diff -- git a/assets/tests/QuestionSchemaValidationService.js b/assets/tests/QuestionSchemaValidationService.js index 3b0a0b8..175cb58 100644 -- - a/assets/tests/QuestionSchemaValidationService.js +++ b/assets/tests/QuestionSchemaValidationService.js @ @ -60,6 +60,23 @ @ tie.factory ( 'QuestionSchemaValidationService ' , [ angular.isArray ( question.getTasks ( ) ) & & question.getTasks ( ) .length > 0 ) ; } , + verifyAtLeastOneBuggyOutputTestExists : function ( question ) { + return question.getTasks ( ) .some ( function ( task ) { + return task.getBuggyOutputTests ( ) .length > 0 ; + } ) ; + } , + verifyAllBuggyOutputTestMessagesAreUnique : function ( question ) { + var messages = new Set ( ) ; + return question.getTasks ( ) .every ( function ( task ) { + return task.getBuggyOutputTests ( ) .every ( function ( test ) { + return test.getMessages ( ) .every ( function ( message ) { + var isUnique = ! ( message in messages ) ; + messages.add ( message ) ; + return isUnique ; + } ) ; + } ) ; + } ) ; + } , verifyStyleTestsAreArray : function ( question ) { return angular.isArray ( question.getStyleTests ( ) ) ; } , diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 156307b..3b953f4 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @
diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..cc05003 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,18 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + seleniumAddress : 'http : //localhost:4444/wd/hub ' , + specs : [ 'testing/page-loading-spec.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data : text/html , < html > < /html > as resetUrl , but + // location.replace from the data : to the file : protocol is not allowed + // ( we 'll get  not allowed local resource  error ) , so we replace resetUrl with one + // with the file : protocol ( this particular one will open system 's root folder ) + browser.resetUrl = 'file :
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..c2acd67 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,61 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + + # Usage : + # Not meant for manual use + # Runs automatically before a git push command is executed + # Behaviour can be set up using `` bash scripts/setup_hooks.sh '' + + # Ask user if push should
diff -- git a/assets/tests/TaskSchemaValidationService.js b/assets/tests/TaskSchemaValidationService.js index e6451be..174af03 100644 -- - a/assets/tests/TaskSchemaValidationService.js +++ b/assets/tests/TaskSchemaValidationService.js @ @ -201,7 +201,7 @ @ tie.factory ( 'TaskSchemaValidationService ' , [ verifyPerformanceTestsHaveLinearExpectedPerformance : function ( task ) { var performanceTests = task.getPerformanceTests ( ) ; return performanceTests.every ( function ( test ) { - return ALLOWED_RUNTIMES.includes ( test.getExpectedPerformance ( ) ) ; + return ( ALLOWED_RUNTIMES.indexOf ( test.getExpectedPerformance ( ) ) ! = -1 ) ; } ) ; } , verifyPerformanceTestsHaveEvaluationFunctionName : function ( task ) { diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..3cd1dc5 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,57 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an
diff -- git a/assets/tests/TaskSchemaValidationService.js b/assets/tests/TaskSchemaValidationService.js index e6451be..4ac815f 100644 -- - a/assets/tests/TaskSchemaValidationService.js +++ b/assets/tests/TaskSchemaValidationService.js @ @ -201,7 +201,7 @ @ tie.factory ( 'TaskSchemaValidationService ' , [ verifyPerformanceTestsHaveLinearExpectedPerformance : function ( task ) { var performanceTests = task.getPerformanceTests ( ) ; return performanceTests.every ( function ( test ) { - return ALLOWED_RUNTIMES.includes ( test.getExpectedPerformance ( ) ) ; + return ALLOWED_RUNTIMES.indexOf ( test.getExpectedPerformance ( ) ) ! == -1 ; } ) ; } , verifyPerformanceTestsHaveEvaluationFunctionName : function ( task ) { diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..3cd1dc5 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,57 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..7b450f6 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,15 +340,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller : [ ' $ scope ' , ' $ timeout ' , 'SolutionHandlerService ' , 'QuestionDataService ' , - 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , + 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , 'CodeStoreService ' , function ( $ scope , $ timeout , SolutionHandlerService , QuestionDataService , - LANGUAGE_PYTHON , FeedbackObjectFactory ) { + LANGUAGE_PYTHON , FeedbackObjectFactory , CodeStoreService ) { var DURATION_MSEC_WAIT_FOR_SCROLL = 20 ; var language = LANGUAGE_PYTHON ; // TODO ( sll ) : Generalize
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..0f49ab3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..2908b57 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..94f9594 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,16 +343,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..7467bcd 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,15 +343,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller : [ ' $ scope ' , ' $ timeout ' , 'SolutionHandlerService ' , 'QuestionDataService ' , - 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , + 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , 'CodeStoreService ' , function ( $ scope , $ timeout , SolutionHandlerService , QuestionDataService , - LANGUAGE_PYTHON , FeedbackObjectFactory ) { + LANGUAGE_PYTHON , FeedbackObjectFactory , CodeStoreService ) { var DURATION_MSEC_WAIT_FOR_SCROLL = 20 ; var language = LANGUAGE_PYTHON ; // TODO ( sll ) : Generalize
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..0f49ab3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..9793840 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/hooks/pre-commit b/hooks/pre-commit new file mode 100644 index 0000000..9d1e387 -- - /dev/null +++ b/hooks/pre-commit @ @ -0,0 +1 @ @ +echo `` Test pre-commit hook '' diff -- git a/hooks/pre-commit-msg b/hooks/pre-commit-msg new file mode 100755 index 0000000..9ed8bbf -- - /dev/null +++ b/hooks/pre-commit-msg @ @ -0,0 +1,3 @ @ + # ! bin/sh + +echo `` # Please include a useful commit message ! '' > $ 1 diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100644 index 0000000..5e8f505 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,4 @ @ + # ! /bin/sh + # This is a test pre-push hook + +echo `` This script is running ''
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..1d05d34 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -148,6 +148,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-coding-ui , .tie-question-ui { display : inline-block ; margin : 8px ; + white-space : normal ; } @ -webkit-keyframes tie-dot { from { -webkit-transform : translate ( 0px , 0px ) ; } @ @ -177,6 +178,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-question-ui-inner { padding-left : 32px ; padding-right : 32px ; + white-space : nowrap ; } .tie-question-ui-outer { display : table ;
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..7467bcd 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,15 +343,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller : [ ' $ scope ' , ' $ timeout ' , 'SolutionHandlerService ' , 'QuestionDataService ' , - 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , + 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , 'CodeStoreService ' , function ( $ scope , $ timeout , SolutionHandlerService , QuestionDataService , - LANGUAGE_PYTHON , FeedbackObjectFactory ) { + LANGUAGE_PYTHON , FeedbackObjectFactory , CodeStoreService ) { var DURATION_MSEC_WAIT_FOR_SCROLL = 20 ; var language = LANGUAGE_PYTHON ; // TODO ( sll ) : Generalize
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..94f9594 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,16 +343,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..94f9594 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,16 +343,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index dd56227..aa064a4 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -77,5 +77,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index dd56227..aa064a4 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -77,5 +77,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..cc05003 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,18 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + seleniumAddress : 'http : //localhost:4444/wd/hub ' , + specs : [ 'testing/page-loading-spec.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data : text/html , < html > < /html > as resetUrl , but + // location.replace from the data : to the file : protocol is not allowed + // ( we 'll get  not allowed local resource  error ) , so we replace resetUrl with one + // with the file : protocol ( this particular one will open system 's root folder ) + browser.resetUrl = 'file :
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..a890175 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -29,8 +29,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ng-repeat= '' questionId in questionIds track by $ index '' ng-click= '' navigateToQuestion ( $ index ) '' > < div class= '' tie-step-circle '' ng-class= '' { 'tie-step-active ' : currentQuestionIndex === $ index , 'tie-step-unlocked ' : questionsCompletionStatus [ $ index ] } '' > - < span class= '' tie-step-text '' , ng-show= '' ! questionsCompletionStatus [ $ index ] '' > { { $ index + 1 } } < /span > - < span class= '' tie-step-checkmark '' , ng-show= '' questionsCompletionStatus [ $ index ] '' > & # 10004 ; < /span > + < span class= '' tie-step-text '' > { { $ index + 1 } } < /span > < /div > < div ng-class= '' { 'tie-step-line ' : $ index < ( questionIds.length - 1 ) } '' > < /div > < /div > @ @ -146,6 +145,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { outline : 0 ; } .tie-coding-ui , .tie-question-ui
diff -- git a/assets/tests/TaskSchemaValidationService.js b/assets/tests/TaskSchemaValidationService.js index e6451be..4ac815f 100644 -- - a/assets/tests/TaskSchemaValidationService.js +++ b/assets/tests/TaskSchemaValidationService.js @ @ -201,7 +201,7 @ @ tie.factory ( 'TaskSchemaValidationService ' , [ verifyPerformanceTestsHaveLinearExpectedPerformance : function ( task ) { var performanceTests = task.getPerformanceTests ( ) ; return performanceTests.every ( function ( test ) { - return ALLOWED_RUNTIMES.includes ( test.getExpectedPerformance ( ) ) ; + return ALLOWED_RUNTIMES.indexOf ( test.getExpectedPerformance ( ) ) ! == -1 ; } ) ; } , verifyPerformanceTestsHaveEvaluationFunctionName : function ( task ) { diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..3cd1dc5 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,57 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3058388 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -86,7 +86,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < div class= '' tie-question-ui '' > < div class= '' tie-question-window '' > - < h3 > Question { { currentQuestionIndex + 1 } } : { { title } } < /h3 > + < h3 class= '' tie-question-title '' > { { title } } < /h3 > < div class= '' tie-previous-instructions '' > < div ng-repeat= '' previousInstruction in previousInstructions track by $ index '' > < p ng-repeat= '' paragraph in previousInstruction track by $ index '' > { { paragraph } } < /p > @ @ -336,6 +336,9 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-step-unlocked { background-color : rgb ( 0 , 128 , 0 ) ; } + .tie-question-title { + color : rgb ( 66 , 133 , 244 ) ; + } < /style > ` , controller : [
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..0f49ab3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..eec7dae 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..c586ff7 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'testing/page-loading-spec.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data : text/html , < html > < /html > as resetUrl , but + // location.replace from the data : to the file : protocol is not allowed + // ( we 'll get  not allowed local resource  error ) , so we replace resetUrl with one + // with the file : protocol ( this particular one will open system 's root folder ) + browser.resetUrl = 'file : // ' ; + } + } ;
diff -- git a/assets/questions/bstClosestValue.js b/assets/questions/bstClosestValue.js new file mode 100644 index 0000000..b7aaab6 -- - /dev/null +++ b/assets/questions/bstClosestValue.js @ @ -0,0 +1,177 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Find Closest Value in Binary Search Tree . + */ +/* eslint no-magic-numbers : [ `` error '' , { ignore : [ 1,4,14.7,2.5,24 ] } ] */ +globalData.questions [ 'bstClosestValue ' ] = { // eslint-disable-line dot-notation + title : 'Find Closest Value in Binary Search Tree ' , + starterCode :
diff -- git a/assets/question_sets/strings.js b/assets/question_sets/strings.js index cc03788..e7de01e 100644 -- - a/assets/question_sets/strings.js +++ b/assets/question_sets/strings.js @ @ -32,6 +32,7 @ @ globalData.questionSets [ 'strings ' ] = { // eslint-disable-line dot-notation 'isPalindrome ' , 'checkBalancedParentheses ' , 'internationalization ' , - 'runLengthEncoding' + 'runLengthEncoding ' , + 'bstClosestValue' ] } ; diff -- git a/assets/questions/bstClosestValue.js b/assets/questions/bstClosestValue.js new file mode 100644 index 0000000..2f8e89a -- - /dev/null +++ b/assets/questions/bstClosestValue.js @ @ -0,0 +1,217 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Find Closest Value in
diff -- git a/assets/question_sets/strings.js b/assets/question_sets/strings.js index cc03788..e7de01e 100644 -- - a/assets/question_sets/strings.js +++ b/assets/question_sets/strings.js @ @ -32,6 +32,7 @ @ globalData.questionSets [ 'strings ' ] = { // eslint-disable-line dot-notation 'isPalindrome ' , 'checkBalancedParentheses ' , 'internationalization ' , - 'runLengthEncoding' + 'runLengthEncoding ' , + 'bstClosestValue' ] } ; diff -- git a/assets/questions/bstClosestValue.js b/assets/questions/bstClosestValue.js new file mode 100644 index 0000000..9ca87a9 -- - /dev/null +++ b/assets/questions/bstClosestValue.js @ @ -0,0 +1,216 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Find Closest Value in
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 562945f..6580e2f 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -169,6 +169,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { div.CodeMirror span.CodeMirror-matchingbracket { color : rgb ( 75 , 206 , 75 ) ; } + .night-mode .tie-code-reset { + background-color : # 333a42 ; + color : white ; + } + .night-mode .tie-options-row a { + color : # E0E0E0 ; + } + .night-mode .tie-select-menu { + background-color : # 333a42 ; + color : white ; + } .tie-about-button { float : left ; }
diff -- git a/assets/questions/palindrome.js b/assets/questions/palindrome.js new file mode 100644 index 0000000..6949989 -- - /dev/null +++ b/assets/questions/palindrome.js @ @ -0,0 +1,150 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Valid Palindrome . + */ + +globalData.questions [ 'palindrome ' ] = { // eslint-disable-line dot-notation + title : 'Balanced Palindrome ' , + starterCode : { + python : + ` def isPalindrome ( s ) : + return False + ` + } , + auxiliaryCode : { + python :
diff -- git a/assets/question_sets/strings.js b/assets/question_sets/strings.js index 197eda5..68436f1 100644 -- - a/assets/question_sets/strings.js +++ b/assets/question_sets/strings.js @ @ -26,5 +26,5 @ @ globalData.questionSets [ 'strings ' ] = { // eslint-disable-line dot-notation `` I will provide you with feedback . '' ] .join ( `` ) ] , - questionIds : [ 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' ] + questionIds : [ 'manhattan ' , 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' ] } ; diff -- git a/assets/questions/manhattan.js b/assets/questions/manhattan.js new file mode 100644 index 0000000..768b0b1 -- - /dev/null +++ b/assets/questions/manhattan.js @ @ -0,0 +1,103 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..ff0618c -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,9 @ @ + # ! /bin/sh + +echo `` Running hook from new directory '' +echo `` Running linter tests '' +sh scripts/run_linter.sh +echo `` Running karma tests '' +sh scripts/run_karma_tests.sh + +exit 0
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..7467bcd 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,15 +343,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller : [ ' $ scope ' , ' $ timeout ' , 'SolutionHandlerService ' , 'QuestionDataService ' , - 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , + 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , 'CodeStoreService ' , function ( $ scope , $ timeout , SolutionHandlerService , QuestionDataService , - LANGUAGE_PYTHON , FeedbackObjectFactory ) { + LANGUAGE_PYTHON , FeedbackObjectFactory , CodeStoreService ) { var DURATION_MSEC_WAIT_FOR_SCROLL = 20 ; var language = LANGUAGE_PYTHON ; // TODO ( sll ) : Generalize
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..99fd9ee 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,16 +343,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..fef862d -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'testing/page-loading-spec.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data : text/html , < html > < /html > as resetUrl , but + // location.replace from the data : to the file : protocol is not allowed + // ( we 'll get  not allowed local resource  error ) , so we replace resetUrl with one + // with the file : protocol ( this particular one will open system 's root folder ) + browser.resetUrl = 'file : // ' ; + } + } ;
diff -- git a/client/components/CodeSnippetDirective.js b/client/components/CodeSnippetDirective.js index 961f332..363a1bd 100644 -- - a/client/components/CodeSnippetDirective.js +++ b/client/components/CodeSnippetDirective.js @ @ -30,6 +30,7 @ @ tie.directive ( 'codeSnippet ' , [ function ( ) { < style > .tie-code-snippet-line { line-height : 24px ; + word-wrap : break-word ; } < /style > ` ,
diff -- git a/client/services/SolutionHandlerService.js b/client/services/SolutionHandlerService.js index 3a074d2..83731ad 100644 -- - a/client/services/SolutionHandlerService.js +++ b/client/services/SolutionHandlerService.js @ @ -49,9 +49,9 @ @ tie.factory ( 'SolutionHandlerService ' , [ studentCode.trim ( ) ) ; CodePreprocessorDispatcherService.preprocess ( language , codeSubmission , auxiliaryCode , - task.getMainFunctionName ( ) , task.getOutputFunctionName ( ) , - task.getCorrectnessTests ( ) , task.getBuggyOutputTests ( ) , - task.getPerformanceTests ( ) ) ; + task.getInputFunctionName ( ) , task.getMainFunctionName ( ) , + task.getOutputFunctionName ( ) , task.getCorrectnessTests ( ) , + task.getBuggyOutputTests ( ) , task.getPerformanceTests ( ) ) ; return CodeRunnerDispatcherService.runCodeAsync ( language , codeSubmission.getPreprocessedCode ( ) diff -- git a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js index 26947f2..c81d167 100644 -- - a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js +++ b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js @ @ -22,12 +22,12 @ @ tie.factory ( 'CodePreprocessorDispatcherService ' , [ function ( PythonCodePreprocessorService , LANGUAGE_PYTHON ) { return { preprocess : function ( - language , codeSubmission , auxiliaryCode , mainFunctionName , + language , codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests ) { if ( language === LANGUAGE_PYTHON ) { return PythonCodePreprocessorService.preprocess ( - codeSubmission , auxiliaryCode , mainFunctionName , outputFunctionName , + codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests
diff -- git a/assets/question_sets/strings.js b/assets/question_sets/strings.js index 197eda5..9d3bab8 100644 -- - a/assets/question_sets/strings.js +++ b/assets/question_sets/strings.js @ @ -26,5 +26,5 @ @ globalData.questionSets [ 'strings ' ] = { // eslint-disable-line dot-notation `` I will provide you with feedback . '' ] .join ( `` ) ] , - questionIds : [ 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' ] + questionIds : [ 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' , 'common ' ] } ; diff -- git a/assets/questions/mostCommonChar.js b/assets/questions/mostCommonChar.js new file mode 100644 index 0000000..f4ec34a -- - /dev/null +++ b/assets/questions/mostCommonChar.js @ @ -0,0 +1,112 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express
diff -- git a/.gitignore b/.gitignore index 30f930d..fdba19e 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ tools/* .DS_Store assets/.DS_Store karma_coverage_reports/* +assets/questions/*.js~ diff -- git a/assets/questions/mostCommonChar.js b/assets/questions/mostCommonChar.js new file mode 100644 index 0000000..661374f -- - /dev/null +++ b/assets/questions/mostCommonChar.js @ @ -0,0 +1,118 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Most Common Character . + */ + +globalData.questions [ 'mostCommonCharacter ' ] = { // eslint-disable-line dot-notation + title : 'Most Common Character ' , + starterCode : {
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 005313b..5d6d72a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -37,101 +37,103 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > - < div class= '' tie-coding-ui '' > - < div class= '' tie-feedback-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > - < div class= '' tie-feedback '' > - < p ng-repeat= '' paragraph in feedbackParagraphs track by $ index '' - class= '' tie-feedback-paragraph '' - ng-class= '' { 'tie-feedback-paragraph-code ' : paragraph.isCodeParagraph ( ) } '' > - < span ng-if= '' $ first '' > { { feedbackTimestamp } } < /span > - < span ng-if= '' paragraph.isTextParagraph ( ) '' > + < div class= '' tie-question-ui '' > + < div class= '' tie-question-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > + < div class= '' tie-greetings '' > + < p ng-repeat= '' paragraph in greetingParagraphs track by $ index '' > { { paragraph.getContent ( ) } } - < /span > - < span ng-if= '' paragraph.isCodeParagraph ( ) '' > - < code-snippet
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 2ac23cd..a695574 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -37,101 +37,103 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > - < div class= '' tie-coding-ui '' > - < div class= '' tie-feedback-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > - < div class= '' tie-feedback '' > - < p ng-repeat= '' paragraph in feedbackParagraphs track by $ index '' - class= '' tie-feedback-paragraph '' - ng-class= '' { 'tie-feedback-paragraph-code ' : paragraph.isCodeParagraph ( ) } '' > - < span ng-if= '' $ first '' > { { feedbackTimestamp } } < /span > - < span ng-if= '' paragraph.isTextParagraph ( ) '' > + < div class= '' tie-question-ui '' > + < div class= '' tie-question-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > + < div class= '' tie-greetings '' > + < p ng-repeat= '' paragraph in greetingParagraphs track by $ index '' > { { paragraph.getContent ( ) } } - < /span > - < span ng-if= '' paragraph.isCodeParagraph ( ) '' > - < code-snippet
diff -- git a/client/app.html b/client/app.html index 576f3c6..8ec24f5 100644 -- - a/client/app.html +++ b/client/app.html @ @ -29,6 +29,7 @ @ < script src= '' domain/FeedbackObjectFactory.js '' > < /script > < script src= '' domain/FeedbackParagraphObjectFactory.js '' > < /script > < script src= '' domain/PerformanceTestObjectFactory.js '' > < /script > + < script src= '' domain/PreRequisiteCheckResultObjectFactory.js '' > < /script > < script src= '' domain/QuestionObjectFactory.js '' > < /script > < script src= '' domain/QuestionSetObjectFactory.js '' > < /script > < script src= '' domain/SnapshotObjectFactory.js '' > < /script > @ @ -42,7 +43,9 @ @ < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > + < script src= '' services/code_evaluators/PreRequisiteCheckDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > + < script src= '' services/code_evaluators/PythonPreRequisiteCheckService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > < script src= '' services/code_preprocessors/PythonCodePreprocessorService.js '' > < /script > < /head > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index b7eb876..c1db544 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -521,8 +521,8 @ @
diff -- git a/client/app.html b/client/app.html index 11e0f3a..19ed11e 100644 -- - a/client/app.html +++ b/client/app.html @ @ -30,6 +30,7 @ @ < script src= '' domain/FeedbackObjectFactory.js '' > < /script > < script src= '' domain/FeedbackParagraphObjectFactory.js '' > < /script > < script src= '' domain/PerformanceTestObjectFactory.js '' > < /script > + < script src= '' domain/PreRequisiteEvalResultObjectFactory.js '' > < /script > < script src= '' domain/QuestionObjectFactory.js '' > < /script > < script src= '' domain/QuestionSetObjectFactory.js '' > < /script > < script src= '' domain/SnapshotObjectFactory.js '' > < /script > @ @ -43,7 +44,9 @ @ < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > + < script src= '' services/code_evaluators/PreRequisiteCheckDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > + < script src= '' services/code_evaluators/PythonPreRequisiteCheckService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > < script src= '' services/code_preprocessors/PythonCodePreprocessorService.js '' > < /script > < /head > diff -- git a/client/app.js b/client/app.js index 6b870ce..567e5ed 100644 -- - a/client/app.js +++ b/client/app.js @ @ -33,6 +33,9 @ @
diff -- git a/assets/images/congrats_cake.gif b/assets/images/congrats_cake.gif new file mode 100644 index 0000000..8bf6014 Binary files /dev/null and b/assets/images/congrats_cake.gif differ diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index e36c4eb..b4f9c24 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -783,6 +783,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { congratulatoryFeedback.clear ( ) ; congratulatoryFeedback.appendTextParagraph ( `` Good work ! You 've completed this question . `` ) ; + congratulatoryFeedback.appendImageParagraph ( 'congrats_cake.gif ' ) ; congratulatoryFeedback.appendTextParagraph ( `` ( You can continue to submit additional answers , if you wish . ) '' ) ; diff -- git a/client/question/components/SpeechBalloonsContainerDirective.js b/client/question/components/SpeechBalloonsContainerDirective.js index 3f75e74..b2a5633 100644 -- - a/client/question/components/SpeechBalloonsContainerDirective.js +++ b/client/question/components/SpeechBalloonsContainerDirective.js @ @ -47,6 +47,9 @ @ tie.directive ( 'speechBalloonsContainer ' , [ function ( ) { < output-snippet content= '' paragraph.getContent ( ) '' > < /output-snippet > < /span > + < span ng-if= '' paragraph.isImageParagraph ( ) '' > + < img class= '' tie-question-completion-image '' ng-src= '' ../../assets/images/ { { paragraph.getContent ( ) } } '' > + < /span > < /p > < /tie-speech-balloon-left > < tie-speech-balloon-tail-left > < /tie-speech-balloon-tail-left > @ @ -109,6 +112,9 @ @ tie.directive ( 'speechBalloonsContainer ' , [ function ( ) { padding-right : 8px
diff -- git a/.gitattributes b/.gitattributes new file mode 100644 index 0000000..2ec754f -- - /dev/null +++ b/.gitattributes @ @ -0,0 +1,11 @ @ +* text=lf +*.js text +*.sh text +*.py text +*.md text +*.css text +*.html text +*.txt text + +*.png binary +*.jpg binary diff -- git a/scripts/setup.sh b/scripts/setup.sh index b0f3070..70fff87 100644 -- - a/scripts/setup.sh +++ b/scripts/setup.sh @ @ -23,7 +23,11 @ @ export OS= ` uname ` export MACHINE_TYPE= ` uname -m ` export TOOLS_DIR=./tools export NODE_DIR= $ TOOLS_DIR/node-6.9.1 -export NPM_CMD= $ NODE_DIR/bin/npm +if [ $ { OS } ==MINGW_NT-10.0 ] ; then + export NPM_CMD= $ NODE_DIR/npm +else + export NPM_CMD= $ NODE_DIR/bin/npm +fi export NODE_MODULES_DIR=./node_modules # Adjust PATH to include a reference to node . export PATH= $ NODE_DIR/bin : $ PATH @ @ -66,7 +70,8 @ @ fi # Download and install node.js , if necessary . echo Checking if node.js is installed in $ NODE_DIR if [ ! -d `` $ NODE_DIR '' ] ; then - echo Installing Node.js + echo Installing Node.js for $ { OS } + ON_WIN=false if [ $ { OS } == `` Darwin '' ] ; then if [ $ { MACHINE_TYPE } == 'x86_64 ' ] ; then
diff -- git a/assets/question_sets/strings.js b/assets/question_sets/strings.js index 197eda5..48590b0 100644 -- - a/assets/question_sets/strings.js +++ b/assets/question_sets/strings.js @ @ -26,5 +26,5 @ @ globalData.questionSets [ 'strings ' ] = { // eslint-disable-line dot-notation `` I will provide you with feedback . '' ] .join ( `` ) ] , - questionIds : [ 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' ] + questionIds : [ 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' , 'incNumber ' ] } ; diff -- git a/assets/questions/incNumber.js b/assets/questions/incNumber.js new file mode 100644 index 0000000..d0bc93f -- - /dev/null +++ b/assets/questions/incNumber.js @ @ -0,0 +1,169 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index c6bbd31..dcb4c58 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -52,15 +52,13 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /span > < /p > < /div > - < div class= '' tie-feedback-syntax-error '' > - < a href class= '' tie-feedback-syntax-error-link '' , - ng-click= '' toggleSyntaxErrorHint ( ) '' , - ng-show= '' syntaxErrorFound '' > - { { isSyntaxErrorShown ? 'Hide error details ' : 'Display error details ' } } - < /a > - < /div > + < a href class= '' tie-feedback-syntax-error-link '' ng-if= '' syntaxErrorString '' + ng-click= '' toggleSyntaxErrorHint ( ) '' > + { { isSyntaxErrorShown ? 'Hide error details ' : 'Display error details ' } } + < /a > < br > - < span class = `` tie-feedback-error-string '' , ng-show= '' isSyntaxErrorShown '' > + < span class= '' tie-feedback-syntax-error-string '' ng-if= '' syntaxErrorString '' + ng-show= '' isSyntaxErrorShown '' > { { syntaxErrorString } } < /span > < div class= '' tie-dot-container '' ng-if= '' loadingIndicatorIsShown '' > @ @ -240,9 +238,6 @ @ tie.directive ( 'learnerView ' , [ function (
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index f4d017c..8abe266 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -59,6 +59,10 @ @ tie.directive ( 'learnerView ' , [ function ( ) { on-state-change= '' scrollToBottomOfFeedbackWindow ( ) '' > < /syntax-error-snippet > < /span > + < span ng-if= '' paragraph.isOutputParagraph ( ) '' > + < output-snippet content= '' paragraph.getContent ( ) '' > + < /output-snippet > + < /span > < /p > < /div > < div class= '' tie-reinforcement '' > diff -- git a/client/question/components/OutputSnippetDirective.js b/client/question/components/OutputSnippetDirective.js new file mode 100755 index 0000000..1f00fb5 -- - /dev/null +++ b/client/question/components/OutputSnippetDirective.js @ @ -0,0 +1,108 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index f4d017c..8abe266 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -59,6 +59,10 @ @ tie.directive ( 'learnerView ' , [ function ( ) { on-state-change= '' scrollToBottomOfFeedbackWindow ( ) '' > < /syntax-error-snippet > < /span > + < span ng-if= '' paragraph.isOutputParagraph ( ) '' > + < output-snippet content= '' paragraph.getContent ( ) '' > + < /output-snippet > + < /span > < /p > < /div > < div class= '' tie-reinforcement '' > diff -- git a/client/question/components/OutputSnippetDirective.js b/client/question/components/OutputSnippetDirective.js new file mode 100755 index 0000000..1f00fb5 -- - /dev/null +++ b/client/question/components/OutputSnippetDirective.js @ @ -0,0 +1,108 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index f4d017c..8abe266 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -59,6 +59,10 @ @ tie.directive ( 'learnerView ' , [ function ( ) { on-state-change= '' scrollToBottomOfFeedbackWindow ( ) '' > < /syntax-error-snippet > < /span > + < span ng-if= '' paragraph.isOutputParagraph ( ) '' > + < output-snippet content= '' paragraph.getContent ( ) '' > + < /output-snippet > + < /span > < /p > < /div > < div class= '' tie-reinforcement '' > diff -- git a/client/question/components/OutputSnippetDirective.js b/client/question/components/OutputSnippetDirective.js new file mode 100755 index 0000000..1f00fb5 -- - /dev/null +++ b/client/question/components/OutputSnippetDirective.js @ @ -0,0 +1,108 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index f4d017c..8abe266 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -59,6 +59,10 @ @ tie.directive ( 'learnerView ' , [ function ( ) { on-state-change= '' scrollToBottomOfFeedbackWindow ( ) '' > < /syntax-error-snippet > < /span > + < span ng-if= '' paragraph.isOutputParagraph ( ) '' > + < output-snippet content= '' paragraph.getContent ( ) '' > + < /output-snippet > + < /span > < /p > < /div > < div class= '' tie-reinforcement '' > diff -- git a/client/question/components/OutputSnippetDirective.js b/client/question/components/OutputSnippetDirective.js new file mode 100755 index 0000000..ac3f4a3 -- - /dev/null +++ b/client/question/components/OutputSnippetDirective.js @ @ -0,0 +1,108 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either
