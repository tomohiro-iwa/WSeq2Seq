diff -- git a/src/main/java/com/google/acai/TestScope.java b/src/main/java/com/google/acai/TestScope.java index 1405bf6..12250b9 100644 -- - a/src/main/java/com/google/acai/TestScope.java +++ b/src/main/java/com/google/acai/TestScope.java @ @ -25,19 +25,23 @ @ import com.google.inject.Provider ; import com.google.inject.Scope ; import java.util.HashMap ; import java.util.Map ; +import java.util.concurrent.atomic.AtomicReference ; /** Scope for bindings annotated with { @ link TestScoped } . */ class TestScope implements Scope { static final TestScope INSTANCE = new TestScope ( ) ; - private final ThreadLocal < Map < Key < ? > , Object > > values = new ThreadLocal < > ( ) ; + private final InheritableThreadLocal < AtomicReference < Map < Key < ? > , Object > > > values = + new InheritableThreadLocal < > ( ) ; void enter ( ) { checkState ( values.get ( ) == null , `` TestScope is already in progress . `` ) ; - values.set ( new HashMap < > ( ) ) ; + values.set ( new AtomicReference < > ( new HashMap < > ( ) ) ) ; } void exit ( ) { checkState ( values.get ( ) ! = null , `` TestScope not in progress '' ) ; + // Make sure that any future accesses to the map in
diff -- git a/README.md b/README.md index 84749fc..426d575 100644 -- - a/README.md +++ b/README.md @ @ -28,7 +28,7 @ @ Building requires Go 1.2 to be installed : http : //golang.org/ export GOPATH= ` pwd ` git clone https : //github.com/google/namebench.git src/github.com/google/namebench go get github.com/mattn/go-sqlite3 - go get code.google.com/p/go.net/publicsuffix + go get golang.org/x/net/publicsuffix go get github.com/miekg/dns `` ` diff -- git a/history/filter.go b/history/filter.go index a3aab36..c6d6527 100644 -- - a/history/filter.go +++ b/history/filter.go @ @ -2,7 +2,7 @ @ package history import ( - '' code.google.com/p/go.net/publicsuffix '' + '' golang.org/x/net/publicsuffix '' '' log '' '' math/rand '' '' net/url ''
diff -- git a/.gitignore b/.gitignore index 034ed37..557c9e7 100644 -- - a/.gitignore +++ b/.gitignore @ @ -22,6 +22,7 @ @ MANIFEST-* /campfire-out /doxygen-out *.ninja* +/bazel-* # Misc node_modules diff -- git a/WORKSPACE b/WORKSPACE new file mode 100644 index 0000000..e69de29 diff -- git a/setup_bazel.sh b/setup_bazel.sh new file mode 100755 index 0000000..8b12df0 -- - /dev/null +++ b/setup_bazel.sh @ @ -0,0 +1,103 @ @ + # ! /bin/bash -e + + # Copyright 2015 Google Inc. All rights reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + + # Initializes the Bazel
diff -- git a/training/Dockerfile b/training/Dockerfile index 9bb6b07..2471d70 100644 -- - a/training/Dockerfile +++ b/training/Dockerfile @ @ -13,11 +13,16 @ @ RUN pip3 install -U pip RUN pip3 -- no-cache-dir install \ tensorflow \ - tensorflowjs + h5py==2.7.1 \ + keras==2.1.4 \ + numpy==1.14.1 \ + six==1.11.0 WORKDIR / -RUN git clone -- depth 1 https : //github.com/tensorflow/tensorflow.git +RUN git clone -- depth 1 https : //github.com/tensorflow/tensorflow.git -- branch r1.7 + +RUN git clone -- depth 1 https : //github.com/tensorflow/tfjs-converter.git -- branch v0.1.2 CMD python3 /tensorflow/tensorflow/examples/image_retraining/retrain.py \ -- image_dir /data/images \ @ @ -25,6 +30,10 @ @ CMD python3 /tensorflow/tensorflow/examples/image_retraining/retrain.py \ -- architecture mobilenet_0.25_224 \ -- output_labels /data/output_labels.txt \ -- saved_model_dir /data/saved_model & & \ + cd /tfjs-converter/python & & \ + # Removing arithmetic optimizer to keep Reshape op according to + # https : //github.com/tensorflow/tfjs/issues/85 + sed -i -e `` s/'arithmetic ' , //g '' tensorflowjs/converters/tf_saved_model_conversion.py & & \ python3 -m tensorflowjs.converters.converter \ -- input_format=tf_saved_model \ -- output_node_names='final_result ' \ diff -- git a/training/Dockerfile.gpu b/training/Dockerfile.gpu index 36fdc09..860ab35 100644 -- - a/training/Dockerfile.gpu +++ b/training/Dockerfile.gpu @ @ -13,11 +13,16 @ @ RUN pip3 install -U pip RUN pip3 -- no-cache-dir install \ tensorflow-gpu \ - tensorflowjs + h5py==2.7.1 \ + keras==2.1.4 \
diff -- git a/Blogger.Sample/Blogger.Sample.Shared/README.html b/Blogger.Sample/Blogger.Sample.Shared/README.html index a64c474..e8c9965 100644 -- - a/Blogger.Sample/Blogger.Sample.Shared/README.html +++ b/Blogger.Sample/Blogger.Sample.Shared/README.html @ @ -17,7 +17,7 @ @ < h3 > 1 . Checkout Instructions < /h3 > - < p > < b > Prerequisites : < /b > Install Visual Studio , and < a href= '' http : //mercurial.selenic.com/ '' > Mercurial < /a > . < /p > + < p > < b > Prerequisites : < /b > Install Visual Studio , and < a href= '' http : //www.mercurial-scm.org/ '' > Mercurial < /a > . < /p > < pre > < code > cd < i > [ someDirectory ] < /i > diff -- git a/Blogger.Sample/README.html b/Blogger.Sample/README.html index a64c474..e8c9965 100644 -- - a/Blogger.Sample/README.html +++ b/Blogger.Sample/README.html @ @ -17,7 +17,7 @ @ < h3 > 1 . Checkout Instructions < /h3 > - < p > < b > Prerequisites : < /b > Install Visual Studio , and < a href= '' http : //mercurial.selenic.com/ '' > Mercurial < /a > . < /p > + < p > < b > Prerequisites : < /b > Install Visual Studio , and < a href= '' http : //www.mercurial-scm.org/
diff -- git a/pasta/base/annotate.py b/pasta/base/annotate.py index 42b3653..91ccffc 100644 -- - a/pasta/base/annotate.py +++ b/pasta/base/annotate.py @ @ -37,7 +37,7 @ @ def _gen_wrapper ( f , scope=True , prefix=True , suffix=True , max_suffix_lines=None ) : @ contextlib.wraps ( f ) def wrapped ( self , node , *args , **kwargs ) : - with ( self.scope ( node ) if scope else _noop_context ( ) ) : + with ( self.scope ( node , trailing_comma=False ) if scope else _noop_context ( ) ) : if prefix : self.prefix ( node ) f ( self , node , *args , **kwargs ) @ @ -124,8 +124,16 @ @ class BaseVisitor ( ast.NodeVisitor ) : self.attr ( node , 'suffix ' , [ lambda : self.ws ( max_lines=max_lines ) ] ) @ contextlib.contextmanager - def scope ( self , node , attr=None ) : - `` '' '' Context manager to handle a parenthesized scope . '' '' '' + def scope ( self , node , attr=None , trailing_comma=False ) : + `` '' '' Context manager to handle a parenthesized scope . + + Arguments : + node : ( ast.AST ) Node to store the scope prefix and suffix on .
diff -- git a/SUMMARY.md b/SUMMARY.md index 4f6b7da..a18fe80 100644 -- - a/SUMMARY.md +++ b/SUMMARY.md @ @ -5,6 +5,7 @ @ * [ Buffer Overflow ] ( chapter-1/threat-BOF.md ) * [ Weak Crypto ] ( chapter-1/threat-CRY.md ) * [ Poor Developer Experience ] ( chapter-1/threat-DEX.md ) + * [ Denial of Service ] ( chapter-1/threat-DOS.md ) * [ Exfiltration of Data ] ( chapter-1/threat-EXF.md ) * [ Low Quality Code ] ( chapter-1/threat-LQC.md ) * [ Malicious Third-Party Code ] ( chapter-1/threat-MTP.md ) diff -- git a/chapter-1/threat-DOS.md b/chapter-1/threat-DOS.md new file mode 100644 index 0000000..4954f66 -- - /dev/null +++ b/chapter-1/threat-DOS.md @ @ -0,0 +1,45 @ @ + # Denial of Service + +Denial of service occurs when a well-behaved , authorized user can not +access a system because of misbehavior by another . + + '' Denial of service '' is most often associated with [ flooding ] [ ] a +network endpoint so it can not respond to the smaller number of +legitimate requests , but there are other vectors : + +* Supplying crafted strings to ambiguous ` RegExp ` s causing + [ excessive backtracking ] [ ] . +* Causing the server to use up [ a finite resource
diff -- git a/analyzer/analyzer.go b/analyzer/analyzer.go index da79cba..9d0aad0 100644 -- - a/analyzer/analyzer.go +++ b/analyzer/analyzer.go @ @ -622,48 +622,47 @ @ func ( pd *ParsedData ) parseBugReport ( fname , contents string ) error { } else { // No point running these if we do n't support the sdk version since we wo n't get any data from them . bs : = bugreportutils.ExtractBatterystatsCheckin ( contents ) - if strings.Contains ( bs , `` Exception occurred while dumping '' ) { // TODO : Display activity manager events even if battery data is invalid . Currently they will not be displayed . ce = `` Exception found in battery dump . '' errs = append ( errs , errors.New ( `` exception found in battery dump '' ) ) - close ( summariesCh ) - close ( checkinCh ) - } else { - pkgs , pkgErrs : = packageutils.ExtractAppsFromBugReport ( contents ) - errs = append ( errs , pkgErrs ... ) - - // Activity manager events are only parsed for supported sdk versions , even though they are still present in unsupported sdk version reports . - // This is as the events are rendered with Historian v2
diff -- git a/lib/src/interface/local_process_manager.dart b/lib/src/interface/local_process_manager.dart index 04b89e1..a5509a5 100644 -- - a/lib/src/interface/local_process_manager.dart +++ b/lib/src/interface/local_process_manager.dart @ @ -31,6 +31,9 @ @ List < String > _getArguments ( List < dynamic > command ) = > /// the underlying ` dart : io ` methods . Thus , the degenerate case of /// ` List < String > ` will trivially work as expected . class LocalProcessManager implements ProcessManager { + /// Creates a new ` LocalProcessManager ` . + const LocalProcessManager ( ) ; + @ override Future < Process > start ( @ checked List < Object > command , {
diff -- git a/importlab/resolve.py b/importlab/resolve.py index 23314bc..71a7363 100644 -- - a/importlab/resolve.py +++ b/importlab/resolve.py @ @ -102,6 +102,8 @ @ def infer_module_name ( filename , fspath ) : for f in fspath : short_name = f.relative_path ( filename ) if short_name : + if short_name.endswith ( `` /__init__ '' ) : + short_name = short_name [ : short_name.rfind ( '/ ' ) ] return short_name.replace ( os.path.sep , ' . ' ) # We have not found filename relative to anywhere in pythonpath . return `` diff -- git a/tests/test_resolve.py b/tests/test_resolve.py index 2a217d3..9891764 100644 -- - a/tests/test_resolve.py +++ b/tests/test_resolve.py @ @ -293,6 +293,15 @ @ class TestResolverUtils ( unittest.TestCase ) : resolve.infer_module_name ( `` /some/random/file '' , fspath ) , `` '' ) + def testInferInitModuleName ( self ) : + with utils.Tempdir ( ) as d : + os_fs = fs.OSFileSystem ( d.path ) + fspath = [ os_fs ] + py_file = d.create_file ( `` foo/__init__.py '' ) + self.assertEqual ( + resolve.infer_module_name ( py_file , fspath ) , + `` foo '' ) + def testGetAbsoluteName ( self ) : test_cases = [ ( `` x.y '' , `` a.b '' , `` x.y.a.b '' ) ,
diff -- git a/pom.xml b/pom.xml index df52547..5d1878d 100644 -- - a/pom.xml +++ b/pom.xml @ @ -5,7 +5,78 @ @ < groupId > org.certificate-transparency < /groupId > < artifactId > ctlog < /artifactId > - < version > 0.1.0 < /version > + < version > 0.1.0-SNAPSHOT < /version > + + < name > $ { project.groupId } : $ { project.artifactId } < /name > + < description > A application used to communicate with certificate transparency log servers. < /description > + < url > https : //certificate-transparency.org/ < /url > + + < licenses > + < license > + < name > The Apache License , Version 2.0 < /name > + < url > https : //www.apache.org/licenses/LICENSE-2.0.txt < /url > + < /license > + < /licenses > + + < developers > + < developer > + < name > Ed Maste < /name > + < email > emaste @ freebsd.org < /email > + < /developer > + < developer > + < name > Fiaz Hossain < /name > + < email > fiaz.hossain @ salesforce.com < /email > + < /developer > + < developer > + < name >
diff -- git a/pixiecore/cli/cli.go b/pixiecore/cli/cli.go index 9236b78..d0149eb 100644 -- - a/pixiecore/cli/cli.go +++ b/pixiecore/cli/cli.go @ @ -70,7 +70,7 @ @ func todo ( msg string , args ... interface { } ) { func serverConfigFlags ( cmd *cobra.Command ) { cmd.Flags ( ) .BoolP ( `` debug '' , `` d '' , false , `` Log more things that are n't directly related to booting a recognized client '' ) cmd.Flags ( ) .BoolP ( `` log-timestamps '' , `` t '' , false , `` Add a timestamp to each log line '' ) - cmd.Flags ( ) .StringP ( `` listen-addr '' , `` l '' , `` '' , `` IPv4 address to listen on '' ) + cmd.Flags ( ) .StringP ( `` listen-addr '' , `` l '' , `` 0.0.0.0 '' , `` IPv4 address to listen on '' ) cmd.Flags ( ) .IntP ( `` port '' , `` p '' , 80 , `` Port to listen on for HTTP '' ) cmd.Flags ( ) .Int ( `` status-port '' , 0 , `` HTTP port for status information ( can be the same as -- port ) '' ) cmd.Flags (
diff -- git a/README.md b/README.md index 0d3d156..2334673 100644 -- - a/README.md +++ b/README.md @ @ -260,6 +260,10 @ @ the ` env_variables ` section of ` app/app.yaml ` . parallel . Parallel updates are scheduled using goroutines and still happen in the context of a single incoming HTTP request , and setting this value too high might result in the App Engine instance running out of RAM . +* ` DATADOG_MIN_POINT_AGE ` : minimum age of a data point returned by Datadog + that makes it eligible for being written . Points that are very fresh + ( default is 1 minute ) are ignored , since Datadog might return incomplete + data for them if some input data is delayed . * ` ENABLE_STATUS_PAGE ` : can be set to 'yes ' to enable the status web page ( disabled by default ) . diff -- git a/app/app.yaml b/app/app.yaml index f603785..3b34d2e 100644 -- - a/app/app.yaml +++ b/app/app.yaml @ @ -16,6 +16,9 @ @ env_variables : SD_PROJECT_FOR_INTERNAL_METRICS : `` '' # Number of metrics to update in parallel . Must be between 1 and 100 ( chosen arbitrarily ) . UPDATE_PARALLELISM : 1 + # Points received from Datadog that
diff -- git a/README.md b/README.md index 7e48616..f6c4af9 100644 -- - a/README.md +++ b/README.md @ @ -142,3 +142,10 @ @ You can now use the JSON file to authorize programs to access the Gmail API The mbox files will now be imported , one by one , into the users ' mailboxes . You can monitor the migration by looking at the output , and inspect errors by viewing the ` import-mailbox-to-gmail.log ` file . + + # # # C. Options + +* Use the ` -- from_message ` parameter to start the upload from a particular message . + This allows you to resume an upload if the process previously stopped . + + e.g . ` ./import-mailbox-to-gmail.py -- from_message 74336 ` \ No newline at end of file diff -- git a/import-mailbox-to-gmail.py b/import-mailbox-to-gmail.py index 6ad3559..2cdc50e 100644 -- - a/import-mailbox-to-gmail.py +++ b/import-mailbox-to-gmail.py @ @ -105,6 +105,11 @ @ parser.add_argument ( default=0 , type=int , help='Debug level of the HTTP library : 0=None ( default ) , 4=Maximum . ' ) +parser.add_argument ( + ' -- from_message ' , + default=0 , + type=int , + help='Message number to resume from ( default : 0 ) ' ) parser.set_defaults (
diff -- git a/saver_genetic_orbits/Cargo.lock b/saver_genetic_orbits/Cargo.lock index 43e385c..4ad354a 100644 -- - a/saver_genetic_orbits/Cargo.lock +++ b/saver_genetic_orbits/Cargo.lock @ @ -480,7 +480,7 @ @ source = `` registry+https : //github.com/rust-lang/crates.io-index '' [ [ package ] ] name = `` libsqlite3-sys '' -version = `` 0.9.1 '' +version = `` 0.10.0 '' source = `` registry+https : //github.com/rust-lang/crates.io-index '' dependencies = [ `` pkg-config 0.3.11 ( registry+https : //github.com/rust-lang/crates.io-index ) '' , @ @ -795,11 +795,11 @ @ dependencies = [ [ [ package ] ] name = `` rusqlite '' -version = `` 0.13.0 '' +version = `` 0.15.0 '' source = `` registry+https : //github.com/rust-lang/crates.io-index '' dependencies = [ `` bitflags 1.0.3 ( registry+https : //github.com/rust-lang/crates.io-index ) '' , - `` libsqlite3-sys 0.9.1 ( registry+https : //github.com/rust-lang/crates.io-index ) '' , + `` libsqlite3-sys 0.10.0 ( registry+https : //github.com/rust-lang/crates.io-index ) '' , `` lru-cache 0.1.1 ( registry+https : //github.com/rust-lang/crates.io-index ) '' , `` time 0.1.40 ( registry+https : //github.com/rust-lang/crates.io-index ) '' , ] @ @ -824,7 +824,7 @ @ dependencies = [ `` num-traits 0.2.5 ( registry+https : //github.com/rust-lang/crates.io-index ) '' , `` rand 0.5.3 ( registry+https : //github.com/rust-lang/crates.io-index ) '' , `` regex 1.0.6 ( registry+https : //github.com/rust-lang/crates.io-index ) '' , - `` rusqlite
diff -- git a/docs/spec/00_intro.md b/docs/spec/00_intro.md index 2aee675..2c05b95 100644 -- - a/docs/spec/00_intro.md +++ b/docs/spec/00_intro.md @ @ -8,7 +8,7 @ @ Lovefield is designed to provide a relational query engine for web apps . * Lovefield is designed to handle databases whose data set is smaller than X ( current bound is 2GB ) but large enough to need a structural query engine . * Lovefield provides a limited subset of [ SQL-03 ] ( - http : //savage.net.au/SQL/sql-2003-2.bnf.html ) functionalities . + https : //ronsavage.github.io/SQL/sql-2003-2.bnf.html ) functionalities . * Lovefield uses existing storage technologies ( e.g . IndexedDB ) to persist data if requested . Developers are responsible to ensure that any data accessed from Lovefield query engine shall be treated as 'unsafe ' and sanitized in some
diff -- git a/extension/tamper.css b/extension/tamper.css index a592cbe..0601584 100644 -- - a/extension/tamper.css +++ b/extension/tamper.css @ @ -10,6 +10,7 @ @ body { tab-size : 4 ; -webkit-user-select : none ; color : # 222 ; + background-color : # 222 ; } # applink { @ @ -31,6 +32,7 @ @ h1 { label { display : block ; padding : 5px 0 ; + color : white ; } label > input [ type= '' checkbox '' ] { width : 13px ;
diff -- git a/messageview/messageview.go b/messageview/messageview.go index 34207da..c23e437 100644 -- - a/messageview/messageview.go +++ b/messageview/messageview.go @ @ -157,6 +157,10 @ @ func ( mv *MessageView ) SnapshotResponse ( res *http.Response ) error { } mv.compress = res.Header.Get ( `` Content-Encoding '' ) + // Do not uncompress if we have do n't have the full contents . + if res.StatusCode == http.StatusNoContent || res.StatusCode == http.StatusPartialContent { + mv.compress = `` '' + } res.Header.WriteSubset ( buf , map [ string ] bool { '' Content-Length '' : true , diff -- git a/messageview/messageview_test.go b/messageview/messageview_test.go index 4e4e9c3..6a27929 100644 -- - a/messageview/messageview_test.go +++ b/messageview/messageview_test.go @ @ -672,6 +672,30 @ @ func TestResponseViewDecodeGzipContentEncoding ( t *testing.T ) { } } +func TestResponseViewDecodeGzipContentEncodingPartial ( t *testing.T ) { + bodywant : = `` partial content '' + res : = proxyutil.NewResponse ( 206 , strings.NewReader ( bodywant ) , nil ) + res.TransferEncoding = [ ] string { `` chunked '' } + res.Header.Set ( `` Content-Encoding '' , `` gzip '' ) + + mv : = New ( ) + if err : = mv.SnapshotResponse ( res ) ; err ! = nil { + t.Fatalf ( `` SnapshotResponse ( ) : got
diff -- git a/docs/examples.md b/docs/examples.md index c274e29..ee167a4 100644 -- - a/docs/examples.md +++ b/docs/examples.md @ @ -52,6 +52,60 @ @ branches in the destination . After the first import , it should be always invoked copybara copy.bara.sky `` ` + # # GitHub SSH basic import + +This example will import private source code to an external GitHub repository , and uses SSH . + +PROTIP : You will need to have an ssh key setup without a password to accomplish this , Copybara doesn't +currently support ssh with a password . + +Create a `` copy.bara.sky `` config file like : + + `` ` python + # Update these references to your orginzations repos +sourceUrl = `` git @ github.com : organization/internal-repo.git '' +destinationUrl = `` git @ github.com : organization/external-repo.git '' + +core.workflow ( + name = `` default '' , + origin = git.origin ( + url = sourceUrl , + ref = `` master '' , + ) , + destination = git.destination ( + url = destinationUrl , + fetch = `` master '' , + push = `` master '' , + ) , + # Change path to the folder you want to
diff -- git a/composekey/README b/composekey/README index d5c2f30..3224d26 100644 -- - a/composekey/README +++ b/composekey/README @ @ -340,4 +340,6 @ @ Format : output sequence ( s ) comment 〝 \ '' REVERSED DOUBLE PRIME QUOTATION MARK 〞 / '' DOUBLE PRIME QUOTATION MARK < - ← LEFTWARDS ARROW -- > → RIGHTWARDS ARROW \ No newline at end of file +- > → RIGHTWARDS ARROW +⸘ ? ! INVERTED INTERROBANG +‽ ! ? INTERROBANG diff -- git a/composekey/background.js b/composekey/background.js index a2d2835..2d73244 100644 -- - a/composekey/background.js +++ b/composekey/background.js @ @ -349,6 +349,7 @ @ var lut = { `` % o '' : `` \u2030 '' , // PER MILLE SIGN `` . < `` : `` \u2039 '' , // SINGLE LEFT-POINTING ANGLE QUOTATION MARK `` . > '' : `` \u203a '' , // SINGLE RIGHT-POINTING ANGLE QUOTATION MARK + '' ! ? `` : `` \u203d '' , // INTERROBANG `` ^0 '' : `` \u2070 '' , // SUPERSCRIPT ZERO `` ^_i '' : `` \u2071 '' , // SUPERSCRIPT LATIN SMALL LETTER I `` ^4 '' : `` \u2074 '' , // SUPERSCRIPT FOUR @ @ -402,6 +403,7 @ @ var lut = { `` ^TM ''
diff -- git a/Example-iOS/Example-iOS.xcodeproj/project.pbxproj b/Example-iOS/Example-iOS.xcodeproj/project.pbxproj index 3d65a01..54e1bba 100644 -- - a/Example-iOS/Example-iOS.xcodeproj/project.pbxproj +++ b/Example-iOS/Example-iOS.xcodeproj/project.pbxproj @ @ -216,7 +216,7 @ @ ) ; runOnlyForDeploymentPostprocessing = 0 ; shellPath = /bin/sh ; - shellScript = `` diff \ '' $ { PODS_ROOT } /../Podfile.lock\ '' \ '' $ { PODS_ROOT } /Manifest.lock\ '' > /dev/null\nif [ [ $ ? ! = 0 ] ] ; then\n cat < < EOM\nerror : The sandbox is not in sync with the Podfile.lock . Run 'pod install ' or update your CocoaPods installation.\nEOM\n exit 1\nfi\n '' ; + shellScript = `` diff \ '' $ { PODS_PODFILE_DIR_PATH } /Podfile.lock\ '' \ '' $ { PODS_ROOT } /Manifest.lock\ '' > /dev/null\nif [ $ ? ! = 0 ] ; then\n # print error to STDERR\n echo \ '' error : The sandbox is not in sync with the Podfile.lock . Run 'pod install ' or update your CocoaPods installation.\ '' > & 2\n exit 1\nfi\n '' ; showEnvVarsInLog = 0 ; } ; /* End PBXShellScriptBuildPhase section */ diff -- git a/GTMAppAuth.podspec b/GTMAppAuth.podspec index 8c1eeaa..5770439 100644 -- - a/GTMAppAuth.podspec +++ b/GTMAppAuth.podspec @ @ -43,5 +43,5 @ @ requests with AppAuth . s.frameworks = 'Security ' , 'SystemConfiguration'
diff -- git a/GTMAppAuth.podspec b/GTMAppAuth.podspec index 814b1b6..015a6aa 100644 -- - a/GTMAppAuth.podspec +++ b/GTMAppAuth.podspec @ @ -44,5 +44,5 @ @ requests with AppAuth . s.frameworks = 'Security ' , 'SystemConfiguration' s.dependency 'GTMSessionFetcher ' , '~ > 1.1' - s.dependency 'AppAuth ' , '~ > 0.9.0' + s.dependency 'AppAuth ' , ' > = 0.9.0' end diff -- git a/Source/GTMTVAuthorizationRequest.m b/Source/GTMTVAuthorizationRequest.m index 1b4102e..e411c2b 100644 -- - a/Source/GTMTVAuthorizationRequest.m +++ b/Source/GTMTVAuthorizationRequest.m @ @ -27,6 +27,12 @ @ # endif // GTMAPPAUTH_USER_IMPORTS # import `` GTMTVServiceConfiguration.h '' + # if TARGET_OS_IOS + # import `` OIDURLQueryComponent+IOS.h '' + # elif TARGET_OS_MAC + # import `` OIDURLQueryComponent+Mac.h '' + # endif + @ implementation GTMTVAuthorizationRequest - ( instancetype )
diff -- git a/src/eval/mod.rs b/src/eval/mod.rs index fadd4d2..ec54256 100644 -- - a/src/eval/mod.rs +++ b/src/eval/mod.rs @ @ -280,7 +280,8 @ @ fn eval_comprehension_clause < 'a , T : FileLoader + 'static > ( } ; } Clause : :For ( ref k , ref v ) = > { - let iterable = v.eval ( context ) ? ; + let mut iterable = v.eval ( context ) ? ; + iterable.freeze_for_iteration ( ) ; for i in t ! ( iterable.into_iter ( ) , c ) ? { k.set ( context , i ) ? ; if tl.is_empty ( ) { @ @ -290,6 +291,7 @ @ fn eval_comprehension_clause < 'a , T : FileLoader + 'static > ( result.append ( & mut other ) ; } } + iterable.unfreeze_for_iteration ( ) ; } } } @ @ -715,17 +717,23 @ @ impl < T : FileLoader + 'static > Evaluate < T > for AstStatement { } , ref st , ) = > { - let iterable = e2.eval ( context ) ? ; + let mut iterable = e2.eval ( context ) ? ; + let mut result = Ok ( Value : :new ( None ) )
diff -- git a/docker_explorer/de.py b/docker_explorer/de.py index 705287a..ff20fe8 100644 -- - a/docker_explorer/de.py +++ b/docker_explorer/de.py @ @ -52,11 +52,8 @ @ class DockerExplorer ( object ) : `` '' '' self.docker_directory = docker_path if not os.path.isdir ( self.docker_directory ) : - err_message = ( - ' { 0 : s } is not a Docker directory\n' - 'Please specify the Docker\ 's directory path.\n' - 'hint : de.py -r /var/lib/docker ' ) .format ( self.docker_directory ) - raise errors.BadStorageException ( err_message ) + msg = ' { 0 : s } is not a Docker directory\n'.format ( self.docker_directory ) + raise errors.BadStorageException ( msg ) self.containers_directory = os.path.join ( self.docker_directory , 'containers ' ) @ @ -156,14 +153,23 @ @ class DockerExplorer ( object ) : Returns : list ( Container ) : the list of Container objects . + + Raises : + errors.BadStorageException : If required files or directories are not found + in the provided Docker directory. `` '' '' + if not os.path.isdir ( self.containers_directory ) : + raise errors.BadStorageException ( + 'Containers directory { 0 } does not exist'.format ( + self.containers_directory ) ) container_ids_list = os.listdir ( self.containers_directory ) if not container_ids_list : - print (
diff -- git a/starlark/example_test.go b/starlark/example_test.go index 81e0678..fc2fee0 100644 -- - a/starlark/example_test.go +++ b/starlark/example_test.go @ @ -7,10 +7,12 @ @ package starlark_test import ( '' fmt '' '' log '' + '' reflect '' '' sort '' '' strings '' '' sync '' '' sync/atomic '' + '' testing '' '' unsafe '' '' go.starlark.net/starlark '' @ @ -146,9 +148,9 @ @ func ExampleThread_Load_parallel ( ) { // c = 2 } -// ExampleThread_Load_parallelCycle demonstrates detection +// TestThread_Load_parallelCycle demonstrates detection // of cycles during parallel loading . -func ExampleThread_Load_parallelCycle ( ) { +func TestThreadLoad_ParallelCycle ( t *testing.T ) { cache : = & cache { cache : make ( map [ string ] *entry ) , fakeFilesystem : map [ string ] string { @ @ -171,11 +173,24 @ @ func ExampleThread_Load_parallelCycle ( ) { } got : = [ ] string { < -ch , < -ch } sort.Strings ( got ) - fmt.Println ( strings.Join ( got , `` \n '' ) ) - // Output : - // can not load a.star : can not load c.star : cycle in load graph - // can not load b.star : can not load a.star : can not load c.star
diff -- git a/pkg/collector/hotswap_pipeline.go b/pkg/collector/hotswap_pipeline.go new file mode 100644 index 0000000..b889373 -- - /dev/null +++ b/pkg/collector/hotswap_pipeline.go @ @ -0,0 +1,47 @ @ +// Copyright 2018 Google LLC +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package collector + +import ( + '' net/http '' + '' sync '' + ) + +// A HotSwapPipeline implements the same interface as a normal Pipeline , but with the added support for a new Pipeline to be swapped out in the middle of execution . In this manner , an external listener can load a new configuration , create a new Pipeline , and
diff -- git a/cmd/nel-collector/main.go b/cmd/nel-collector/main.go index 4a3eb92..d39119c 100644 -- - a/cmd/nel-collector/main.go +++ b/cmd/nel-collector/main.go @ @ -17,16 +17,21 @ @ package main import ( - '' flag '' '' log '' '' net/http '' - '' os '' '' github.com/google/nel-collector/pkg/collector '' - '' github.com/google/nel-collector/pkg/core '' + _ `` github.com/google/nel-collector/pkg/core '' ) -var keepNonNelReports = flag.Bool ( `` keep-non-nel-reports '' , false , `` keep non-NEL reports '' ) +var defaultConfig = [ ] byte ( ` + [ [ processor ] ] +type = `` KeepNelReports '' + + [ [ processor ] ] +type = `` DumpReportsAsCLF '' +dest = `` stdout '' + ` ) var rootBody = [ ] byte ( ` < html > @ @ -50,10 +55,10 @ @ func handleRoot ( w http.ResponseWriter , r *http.Request ) { func main ( ) { pipeline : = & collector.Pipeline { } - if ! *keepNonNelReports { - pipeline.AddProcessor ( core.KeepNelReports { } ) + err : = pipeline.LoadFromConfig ( defaultConfig ) + if err ! = nil { + log.Fatal ( err ) } - pipeline.AddProcessor ( core.DumpReportsAsCLF { os.Stdout } ) http.HandleFunc ( `` / '' , handleRoot ) http.Handle ( `` /upload/ '' ,
diff -- git a/README.md b/README.md index 2f4fc9e..49fc27f 100644 -- - a/README.md +++ b/README.md @ @ -77,6 +77,54 @ @ let text_result = compiler.compile_into_spirv_assembly ( assert ! ( text_result.as_text ( ) .starts_with ( `` ; SPIR-V\n '' ) ) ; `` ` +Setup + -- -- - + +To build the shaderc-rs crate the following tools must be installed and available on ` PATH ` : +- [ CMake ] ( https : //cmake.org/ ) +- [ Python ] ( https : //www.python.org/ ) ( works with both Python 2.x and 3.x ) +- a C++ compiler + +These requirements can be either installed with your favourite package manager or with installers +from the projects ' websites . Below are some example ways to get setup . + + # # # windows-msvc Specific Setup + +1 . ` rustup default stable-x86_64-pc-windows-msvc ` +2 . Install [ Build Tools for Visual Studio 2017 ] ( https : //visualstudio.microsoft.com/downloads/ # build-tools-for-visual-studio-2017 ) . If you have already been using this toolchain then its probably already installed . +3 . Install [ msys2 ] ( http : //www.msys2.org/ ) , following ALL of the instructions . +4 . Then in the msys2 terminal
diff -- git a/auto_forensicate/auto_acquire.py b/auto_forensicate/auto_acquire.py index a7b0176..2de3807 100644 -- - a/auto_forensicate/auto_acquire.py +++ b/auto_forensicate/auto_acquire.py @ @ -14,6 +14,7 @ @ # limitations under the License . `` `` '' Automated forensics acquisition script . '' '' '' +from __future__ import print_function from __future__ import unicode_literals import argparse @ @ -346,11 +347,11 @ @ class AutoForensicate ( object ) : green_color_code = 2 if not self._errors : - print self._Colorize ( + print ( self._Colorize ( green_color_code , ( 'Everything has completed successfully , feel free to shut the system' ' down . ' ) - ) + ) ) return should_retry = False @ @ -360,16 +361,16 @ @ class AutoForensicate ( object ) : should_retry = True if should_retry : - print self._Colorize ( + print ( self._Colorize ( red_color_code , - 'There was a problem with the upload , please re-run the script . ' ) + 'There was a problem with the upload , please re-run the script . ' ) ) else : - print self._Colorize ( + print ( self._Colorize ( red_color_code , ( 'There was a problem with the upload , please keep the system ' 'running and contact the security person who told you
diff -- git a/auto_forensicate/auto_acquire.py b/auto_forensicate/auto_acquire.py index a7b0176..2de3807 100644 -- - a/auto_forensicate/auto_acquire.py +++ b/auto_forensicate/auto_acquire.py @ @ -14,6 +14,7 @ @ # limitations under the License . `` `` '' Automated forensics acquisition script . '' '' '' +from __future__ import print_function from __future__ import unicode_literals import argparse @ @ -346,11 +347,11 @ @ class AutoForensicate ( object ) : green_color_code = 2 if not self._errors : - print self._Colorize ( + print ( self._Colorize ( green_color_code , ( 'Everything has completed successfully , feel free to shut the system' ' down . ' ) - ) + ) ) return should_retry = False @ @ -360,16 +361,16 @ @ class AutoForensicate ( object ) : should_retry = True if should_retry : - print self._Colorize ( + print ( self._Colorize ( red_color_code , - 'There was a problem with the upload , please re-run the script . ' ) + 'There was a problem with the upload , please re-run the script . ' ) ) else : - print self._Colorize ( + print ( self._Colorize ( red_color_code , ( 'There was a problem with the upload , please keep the system ' 'running and contact the security person who told you
diff -- git a/.travis.yml b/.travis.yml index fc0a225..9e69b4d 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -1,6 +1,7 @ @ language : python python : - '2.7' + - '3.5' install : - pip install -r requirements.txt script : diff -- git a/auto_forensicate/auto_acquire.py b/auto_forensicate/auto_acquire.py index a7b0176..e6b6297 100644 -- - a/auto_forensicate/auto_acquire.py +++ b/auto_forensicate/auto_acquire.py @ @ -14,6 +14,7 @ @ # limitations under the License . `` `` '' Automated forensics acquisition script . '' '' '' +from __future__ import print_function from __future__ import unicode_literals import argparse @ @ -90,7 +91,7 @ @ class AutoForensicate ( object ) : description='Autopush forensics evidence to Cloud Storage ' ) parser.add_argument ( ' -- acquire ' , action='append ' , help='Evidence to acquire ' , - choices= [ 'all ' ] +self._recipes.keys ( ) , required=True + choices= [ 'all ' ] +sorted ( list ( self._recipes.keys ( ) ) ) , required=True ) parser.add_argument ( 'destination ' , action='store ' , @ @ -204,10 +205,10 @ @ class AutoForensicate ( object ) : def _ParseRecipes ( self , options ) : if 'all ' in options.acquire : - options.acquire = self._recipes.keys ( ) + options.acquire = sorted ( list ( self._recipes.keys ( ) ) )
diff -- git a/Foundation/GTMNSString+HTML.m b/Foundation/GTMNSString+HTML.m index 04ec23a..c35e760 100644 -- - a/Foundation/GTMNSString+HTML.m +++ b/Foundation/GTMNSString+HTML.m @ @ -486,12 +486,14 @ @ static int EscapeMapCompare ( const void *ucharVoid , const void *mapVoid ) { NSScanner *scanner = [ NSScanner scannerWithString : hexSequence ] ; unsigned value ; if ( [ scanner scanHexInt : & value ] & & - value < USHRT_MAX & & + value < INT_MAX & & value > 0 & & [ scanner scanLocation ] == length - 4 ) { - unichar uchar = ( unichar ) value ; - NSString *charString = [ NSString stringWithCharacters : & uchar length:1 ] ; - [ finalString replaceCharactersInRange : escapeRange withString : charString ] ; + value = NSSwapHostIntToLittle ( value ) ; + NSString *charString = [ [ NSString alloc ] initWithBytes : & value length : sizeof ( value ) encoding : NSUTF32LittleEndianStringEncoding ] ; + if ( charString ) { + [ finalString replaceCharactersInRange : escapeRange withString : charString ] ; + } } } else { @ @ -500,12 +502,14 @ @ static int EscapeMapCompare ( const void *ucharVoid , const void *mapVoid ) { NSScanner *scanner = [ NSScanner scannerWithString : numberSequence ] ;
diff -- git a/package.json b/package.json index 026f3f7..98ab583 100644 -- - a/package.json +++ b/package.json @ @ -46,14 +46,15 @ @ } , `` dependencies '' : { `` cookie '' : `` ^0.3.1 '' , - `` fastify '' : `` ^0.39.1 '' , + `` fastify '' : `` ^0.42.0 '' , `` fastify-plugin '' : `` ^0.2.1 '' , - `` h2-auto-push '' : `` ^0.2.0 '' , - `` send '' : `` ^0.16.1 '' + `` fastify-static '' : `` ^0.7.0 '' , + `` h2-auto-push '' : `` ^0.2.0 '' } , `` devDependencies '' : { `` @ types/cookie '' : `` ^0.3.1 '' , `` @ types/get-port '' : `` ^3.2.0 '' , + `` @ types/node '' : `` ^9.4.0 '' , `` @ types/send '' : `` ^0.14.4 '' , `` ava '' : `` ^0.24.0 '' , `` codecov '' : `` ^3.0.0 '' , diff -- git a/samples/static-page/index.js b/samples/static-page/index.js index e155018..c9ac620 100644 -- - a/samples/static-page/index.js +++ b/samples/static-page/index.js @ @ -14,7 +14,7 @ @ const { ArgumentParser } = require ( 'argparse ' ) ; const fastify = require ( 'fastify ' ) ; -const fastifyAutoPush = require ( 'fastify-auto-push '
diff -- git a/.gitignore b/.gitignore index 2ce8308..bb42786 100644 -- - a/.gitignore +++ b/.gitignore @ @ -13,8 +13,8 @ @ /config.status /configure /depcomp -/helpers/auth_htpasswd -/helpers/auth_pamtester +/helpers/authproto_htpasswd +/helpers/authproto_pamtester /helpers/saver_mplayer /helpers/saver_mpv /helpers/saver_xscreensaver @ @ -25,7 +25,8 @ @ *.o # Binaries . -/auth_pam_x11 +/auth_x11 +/authproto_pam /dimmer /get_compositor /nvidia_break_compositor diff -- git a/Makefile.am b/Makefile.am index 3271715..8f184c8 100644 -- - a/Makefile.am +++ b/Makefile.am @ @ -18,6 +18,7 @ @ macros = \ -DHELPER_PATH=\ '' $ ( pkglibexecdir ) \ '' \ -DDOCS_PATH=\ '' $ ( docdir ) \ '' \ -DAUTH_EXECUTABLE=\ '' @ auth_executable @ \ '' \ + -DAUTHPROTO_EXECUTABLE=\ '' @ authproto_executable @ \ '' \ -DGLOBAL_SAVER_EXECUTABLE=\ '' @ global_saver_executable @ \ '' \ -DSAVER_EXECUTABLE=\ '' @ saver_executable @ \ '' \ -DPAM_SERVICE_NAME=\ '' @ pam_service_name @ \ '' @ @ -69,7 +70,7 @ @ helpers_SCRIPTS = \ helpers/saver_blank if HAVE_HTPASSWD helpers_SCRIPTS += \ - helpers/auth_htpasswd + helpers/authproto_htpasswd endif if HAVE_MPLAYER helpers_SCRIPTS += \ @ @ -81,7 +82,7 @ @ helpers_SCRIPTS += \ endif if HAVE_PAMTESTER helpers_SCRIPTS += \ - helpers/auth_pamtester + helpers/authproto_pamtester endif if HAVE_XSCREENSAVER helpers_SCRIPTS += \ @ @ -119,18 +120,31 @ @ until_nonidle_SOURCES = \ until_nonidle_CPPFLAGS = $ ( macros ) endif -if HAVE_PAM helpers_PROGRAMS += \ - auth_pam_x11 -auth_pam_x11_SOURCES =
diff -- git a/.gitignore b/.gitignore index 2ce8308..bb42786 100644 -- - a/.gitignore +++ b/.gitignore @ @ -13,8 +13,8 @ @ /config.status /configure /depcomp -/helpers/auth_htpasswd -/helpers/auth_pamtester +/helpers/authproto_htpasswd +/helpers/authproto_pamtester /helpers/saver_mplayer /helpers/saver_mpv /helpers/saver_xscreensaver @ @ -25,7 +25,8 @ @ *.o # Binaries . -/auth_pam_x11 +/auth_x11 +/authproto_pam /dimmer /get_compositor /nvidia_break_compositor diff -- git a/Makefile.am b/Makefile.am index 3271715..ff65792 100644 -- - a/Makefile.am +++ b/Makefile.am @ @ -18,6 +18,7 @ @ macros = \ -DHELPER_PATH=\ '' $ ( pkglibexecdir ) \ '' \ -DDOCS_PATH=\ '' $ ( docdir ) \ '' \ -DAUTH_EXECUTABLE=\ '' @ auth_executable @ \ '' \ + -DAUTHPROTO_EXECUTABLE=\ '' @ authproto_executable @ \ '' \ -DGLOBAL_SAVER_EXECUTABLE=\ '' @ global_saver_executable @ \ '' \ -DSAVER_EXECUTABLE=\ '' @ saver_executable @ \ '' \ -DPAM_SERVICE_NAME=\ '' @ pam_service_name @ \ '' @ @ -69,7 +70,7 @ @ helpers_SCRIPTS = \ helpers/saver_blank if HAVE_HTPASSWD helpers_SCRIPTS += \ - helpers/auth_htpasswd + helpers/authproto_htpasswd endif if HAVE_MPLAYER helpers_SCRIPTS += \ @ @ -81,7 +82,7 @ @ helpers_SCRIPTS += \ endif if HAVE_PAMTESTER helpers_SCRIPTS += \ - helpers/auth_pamtester + helpers/authproto_pamtester endif if HAVE_XSCREENSAVER helpers_SCRIPTS += \ @ @ -119,18 +120,31 @ @ until_nonidle_SOURCES = \ until_nonidle_CPPFLAGS = $ ( macros ) endif -if HAVE_PAM helpers_PROGRAMS += \ - auth_pam_x11 -auth_pam_x11_SOURCES =
diff -- git a/textfsm.py b/textfsm.py index 3b1d75c..12b2c0a 100755 -- - a/textfsm.py +++ b/textfsm.py @ @ -905,7 +905,7 @ @ class TextFSM ( object ) : for value in matched.groupdict ( ) : self._AssignVar ( matched , value ) - if self._Operations ( rule ) : + if self._Operations ( rule , line ) : # Not a Continue so check for state transition . if rule.new_state : if rule.new_state not in ( 'End ' , 'EOF ' ) : @ @ -941,7 +941,7 @ @ class TextFSM ( object ) : if _value is not None : _value.AssignVar ( matched.group ( value ) ) - def _Operations ( self , rule ) : + def _Operations ( self , rule , line ) : `` '' '' Operators on the data record . Operators come in two parts and are a ' . ' separated pair : @ @ -959,6 +959,7 @ @ class TextFSM ( object ) : Args : rule : FSMRule object . + line : A string , the current input line . Returns : True if state machine should restart state with new line . @ @ -981,11 +982,11 @ @ class TextFSM ( object
diff -- git a/clitable.py b/clitable.py index 2be2a91..1c53886 100755 -- - a/clitable.py +++ b/clitable.py @ @ -73,10 +73,37 @ @ class IndexTable ( object ) : self._index_handle = open ( self._index_file , 'r ' ) self._ParseIndex ( preread , precompile ) + def __del__ ( self ) : + `` '' '' Close index handle . '' '' '' + if hasattr ( self , '_index_handle ' ) : + self._index_handle.close ( ) + def __len__ ( self ) : `` '' '' Returns number of rows in table . '' '' '' return self.index.size + def __copy__ ( self ) : + `` '' '' Returns a copy of an IndexTable object . '' '' '' + clone = IndexTable ( ) + if hasattr ( self , '_index_file ' ) : + clone._index_file = self._index_file + clone._index_handle = self._index_handle + + clone.index = self.index + clone.compiled = self.compiled + return clone + + def __deepcopy__ ( self , memodict= { } ) : + `` '' '' Returns a deepcopy of an IndexTable object . '' '' '' + clone = IndexTable ( ) + if hasattr ( self , '_index_file ' ) : + clone._index_file = copy.deepcopy (
diff -- git a/Santa.xcodeproj/project.pbxproj b/Santa.xcodeproj/project.pbxproj index 0150abf..87d245a 100644 -- - a/Santa.xcodeproj/project.pbxproj +++ b/Santa.xcodeproj/project.pbxproj @ @ -166,6 +166,7 @ @ C7479F051E53704E0054C1CF /* SNTXPCBundleServiceInterface.m in Sources */ = { isa = PBXBuildFile ; fileRef = C7C721B01E23FF300051FAA6 /* SNTXPCBundleServiceInterface.m */ ; } ; C7479F071E5374BF0054C1CF /* SNTXPCControlInterface.m in Sources */ = { isa = PBXBuildFile ; fileRef = 0DCD605419115D17006B445C /* SNTXPCControlInterface.m */ ; } ; C7479F091E5374E50054C1CF /* SNTRule.m in Sources */ = { isa = PBXBuildFile ; fileRef = 0DE50F671912716A007B2B0C /* SNTRule.m */ ; } ; + C74D6CC61EEB3B9B00BB5A33 /* BundleExample.app in Resources */ = { isa = PBXBuildFile ; fileRef = C74D6CC51EEB3B9B00BB5A33 /* BundleExample.app */ ; } ; C76614EC1D142D3C00D150C1 /* SNTCommandCheckCache.m in Sources */ = { isa = PBXBuildFile ; fileRef = C76614EB1D142D3C00D150C1 /* SNTCommandCheckCache.m */ ; } ; C776A1071DEE160500A56616 /* SNTCommandSyncManager.m in Sources */ = { isa = PBXBuildFile ; fileRef = C776A1061DEE160500A56616 /* SNTCommandSyncManager.m */ ; } ; C78227631E1C3C7D006EB2D6 /* santabs.xpc in CopyFiles */ = { isa = PBXBuildFile ; fileRef = C78227541E1C3C58006EB2D6 /* santabs.xpc */ ; settings = { ATTRIBUTES = ( RemoveHeadersOnCopy , ) ; } ; } ; @ @ -431,6 +432,7 @ @ A6A91785C40257CC156B4F05 /* Pods-Santa.release.xcconfig */ = { isa = PBXFileReference ; includeInIndex = 1 ; lastKnownFileType
diff -- git a/.travis.yml b/.travis.yml new file mode 100644 index 0000000..4e9e6bf -- - /dev/null +++ b/.travis.yml @ @ -0,0 +1,5 @ @ +language : node_js +node_js : + - `` 7.10.1 '' +script : + - npm run test \ No newline at end of file diff -- git a/README.md b/README.md index f303858..1ac3626 100644 -- - a/README.md +++ b/README.md @ @ -1,3 +1,5 @ @ + [ ! [ Build Status ] ( https : //travis-ci.org/google/percy-node.svg ? branch=master ) ] ( https : //travis-ci.org/google/percy-node ) + # percy-node This is a wrapper of [ percy-js ] ( https : //github.com/percy/percy-js ) that simplifies the API so it can be used for automated visual regression testing in node environments such as testing an express app , an Angular app , or AngularJS app .
diff -- git a/.travis.yml b/.travis.yml index 7d02765..8340ab1 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -45,5 +45,5 @ @ script : env : global : - - GOPROXY=https : //storage.googleapis.com/go-cloud-modules/ + - GOPROXY=https : //storage.googleapis.com/wire-modules/ - GO111MODULE=on diff -- git a/internal/proxy/README.md b/internal/proxy/README.md new file mode 100644 index 0000000..7788efa -- - /dev/null +++ b/internal/proxy/README.md @ @ -0,0 +1,64 @ @ + # Wire module proxy + +The Travis build for Wire uses a [ Go module proxy ] [ ] for dependencies , for +efficiency and reliability , and to enforce that all of our dependencies meet our +license requirements . + +The proxy is set + [ here ] ( https : //github.com/google/wire/blob/master/.travis.yml # L48 ) . + + [ Go module proxy ] : https : //research.swtch.com/vgo-module + + # # Updating the GCS bucket + +When you add a new dependency , the Travis build will fail . To add the new +dependency to the proxy : + +1 . Ensure that the new dependency is covered under one of the ` notice ` , + ` permissive ` , or ` unencumbered ` licences under the categories defined by + [ Google Open Source ] ( https
diff -- git a/CONTRIBUTING.md b/CONTRIBUTING.md index a854130..e2f6080 100644 -- - a/CONTRIBUTING.md +++ b/CONTRIBUTING.md @ @ -1,70 +1,155 @ @ # How to Contribute -We would love to accept your patches and contributions to this project . Here is how you can help . +We would love to accept your patches and contributions to this project . Here is +how you can help . # # Filing issues -Filing issues is an important way you can contribute to the Wire Project . We want your feedback on things like bugs , desired API changes , or just anything that is n't working for you . + +Filing issues is an important way you can contribute to the Wire Project . We +want your feedback on things like bugs , desired API changes , or just anything +that is n't working for you . # # # Bugs -If your issue is a bug , open one [ here ] ( https : //github.com/google/wire/issues/new ) . The easiest way to file an issue with all the right information is to run ` go bug ` . ` go bug ` will print out a handy template of questions and system information that
diff -- git a/guetzli.make b/guetzli.make index cffae1b..1a8febc 100644 -- - a/guetzli.make +++ b/guetzli.make @ @ -15,7 +15,7 @ @ ifeq ( $ ( config ) , release ) TARGETDIR = bin/Release TARGET = $ ( TARGETDIR ) /guetzli OBJDIR = obj/Release - DEFINES += -DGFLAGS_NAMESPACE=google + DEFINES += INCLUDES += -I . -Ithird_party/butteraugli FORCE_INCLUDE += ALL_CPPFLAGS += $ ( CPPFLAGS ) -MMD -MP $ ( DEFINES ) $ ( INCLUDES ) @ @ -42,7 +42,7 @ @ ifeq ( $ ( config ) , debug ) TARGETDIR = bin/Debug TARGET = $ ( TARGETDIR ) /guetzli OBJDIR = obj/Debug - DEFINES += -DGFLAGS_NAMESPACE=google + DEFINES += INCLUDES += -I . -Ithird_party/butteraugli FORCE_INCLUDE += ALL_CPPFLAGS += $ ( CPPFLAGS ) -MMD -MP $ ( DEFINES ) $ ( INCLUDES ) diff -- git a/guetzli.vcxproj b/guetzli.vcxproj index 015d5ed..d14db62 100644 -- - a/guetzli.vcxproj +++ b/guetzli.vcxproj @ @ -97,7 +97,6 @ @ < ClCompile > < PrecompiledHeader > NotUsing < /PrecompiledHeader > < WarningLevel > Level3 < /WarningLevel > - < PreprocessorDefinitions > GFLAGS_NAMESPACE=google ; % ( PreprocessorDefinitions ) < /PreprocessorDefinitions > < AdditionalIncludeDirectories > . ; third_party\butteraugli ; % ( AdditionalIncludeDirectories ) < /AdditionalIncludeDirectories > < Optimization > Full < /Optimization > <
diff -- git a/guetzli.make b/guetzli.make index 1a8febc..b2ad562 100644 -- - a/guetzli.make +++ b/guetzli.make @ @ -19,12 +19,12 @ @ ifeq ( $ ( config ) , release ) INCLUDES += -I . -Ithird_party/butteraugli FORCE_INCLUDE += ALL_CPPFLAGS += $ ( CPPFLAGS ) -MMD -MP $ ( DEFINES ) $ ( INCLUDES ) - ALL_CFLAGS += $ ( CFLAGS ) $ ( ALL_CPPFLAGS ) -O3 + ALL_CFLAGS += $ ( CFLAGS ) $ ( ALL_CPPFLAGS ) -O3 -g ` pkg-config -- cflags libpng libgflags ` ALL_CXXFLAGS += $ ( CXXFLAGS ) $ ( ALL_CFLAGS ) -std=c++11 ALL_RESFLAGS += $ ( RESFLAGS ) $ ( DEFINES ) $ ( INCLUDES ) - LIBS += -lpng -lgflags_nothreads -lz -lpthread + LIBS += LDDEPS += - ALL_LDFLAGS += $ ( LDFLAGS ) -s + ALL_LDFLAGS += $ ( LDFLAGS ) ` pkg-config -- libs libpng libgflags ` LINKCMD = $ ( CXX ) -o `` $ @ '' $ ( OBJECTS ) $ ( RESOURCES ) $ ( ALL_LDFLAGS ) $ ( LIBS ) define PREBUILDCMDS endef @ @ -46,12 +46,12 @ @ ifeq ( $ ( config ) , debug ) INCLUDES += -I . -Ithird_party/butteraugli FORCE_INCLUDE += ALL_CPPFLAGS += $ ( CPPFLAGS )
diff -- git a/README.md b/README.md index 7bc67cf..a10e11f 100644 -- - a/README.md +++ b/README.md @ @ -13,12 +13,12 @ @ sequential ( nonprogressive ) JPEGs due to faster decompression speeds they offer . downloading an [ archive ] ( https : //github.com/google/guetzli/archive/master.zip ) and unpacking it . -2 . Install [ libpng ] ( http : //www.libpng.org/pub/png/libpng.html ) and - [ gflags ] ( https : //github.com/gflags/gflags ) . If using your operating system +2 . Install [ libpng ] ( http : //www.libpng.org/pub/png/libpng.html ) . + If using your operating system package manager , install development versions of the packages if the distinction exists . - * On Ubuntu , do ` apt-get install libpng-dev libgflags-dev ` . - * On Arch Linux , do ` pacman -S libpng gflags ` . + * On Ubuntu , do ` apt-get install libpng-dev ` . + * On Arch Linux , do ` pacman -S libpng ` . 3 . Run ` make ` and expect the binary to be created in ` bin/Release/guetzli ` . # # On Windows @ @ -29,7 +29,7 @ @ sequential ( nonprogressive ) JPEGs due to faster decompression speeds they offer . unpacking it
diff -- git a/BUILD.bazel b/BUILD.bazel index e36756f..1a81f84 100755 -- - a/BUILD.bazel +++ b/BUILD.bazel @ @ -26,6 +26,7 @ @ py_library ( `` @ concurrent// : concurrent '' , `` @ httplib2// : httplib2 '' , `` @ oauth2client// : oauth2client '' , + `` @ six// : six '' , ] , ) diff -- git a/transform/v2_2/metadata_.py b/transform/v2_2/metadata_.py index f63c0ce..a3baa8a 100755 -- - a/transform/v2_2/metadata_.py +++ b/transform/v2_2/metadata_.py @ @ -20,6 +20,8 @ @ import copy import hashlib import os +import six + _OverridesT = namedtuple ( 'OverridesT ' , [ 'layers ' , 'entrypoint ' , 'cmd ' , 'env ' , 'labels ' , 'ports ' , 'volumes ' , @ @ -29,7 +31,7 @ @ _OverridesT = namedtuple ( 'OverridesT ' , [ # Unix epoch 0 , representable in 32 bits . _DEFAULT_TIMESTAMP = '1970-01-01T00:00:00Z' -_EMPTY_LAYER = hashlib.sha256 ( `` ) .hexdigest ( ) +_EMPTY_LAYER = hashlib.sha256 ( `` .encode ( 'utf-8 ' ) ) .hexdigest ( ) class Overrides ( _OverridesT ) : @ @ -113,7 +115,7 @ @ def _DeepCopySkipNull ( `` '' '' Do a deep copy , skipping null entry . '' '' '' if isinstance ( data , dict ) : return dict
diff -- git a/build.gradle b/build.gradle index 5283f0e..8ffc382 100644 -- - a/build.gradle +++ b/build.gradle @ @ -4,7 +4,7 @ @ buildscript { } dependencies { classpath 'com.android.tools.build : gradle:2.3.3' - classpath 'me.tatarka : gradle-retrolambda:3.5.0' + classpath 'me.tatarka : gradle-retrolambda:3.7.0' // NOTE : Do not place your application dependencies here. } @ @ -31,7 +31,7 @ @ allprojects { android { compileSdkVersion 24 - buildToolsVersion '25.0.0' + buildToolsVersion '25.0.3' defaultConfig { applicationId `` com.google.android.mobly.snippet.bundled '' @ @ -50,6 +50,7 @ @ android { abortOnError true checkAllWarnings true warningsAsErrors true + disable 'HardwareIds ' , 'MissingApplicationIcon ' , 'GoogleAppIndexingWarning ' , 'InvalidPackage ' , 'OldTargetApi' } } @ @ -72,10 +73,10 @ @ artifacts { dependencies { compile 'com.android.support.test : runner:0.5' compile 'com.google.android.mobly : mobly-snippet-lib:1.2.0' - compile 'com.google.code.gson : gson:2.6.2' + compile 'com.google.code.gson : gson:2.8.2' compile 'com.google.guava : guava:20.0' - testCompile 'com.google.truth : truth:0.32' + testCompile 'com.google.truth : truth:0.36' testCompile 'junit : junit:4.12' } diff -- git a/src/main/AndroidManifest.xml b/src/main/AndroidManifest.xml index dc5d0af..0a0dad3 100644 -- - a/src/main/AndroidManifest.xml +++ b/src/main/AndroidManifest.xml @ @ -3,6 +3,8 @ @ xmlns : android= '' http : //schemas.android.com/apk/res/android '' package= '' com.google.android.mobly.snippet.bundled '' > + < uses-feature android : name= '' android.hardware.telephony '' android : required= '' false '' / >
diff -- git a/README.md b/README.md index 0dfcfbb..e7a73ab 100644 -- - a/README.md +++ b/README.md @ @ -38,6 +38,19 @ @ Note : this is not an official Google product . self.ad.api.wifiEnable ( ) `` ` + # # Develop + +If you want to contribute , use the usual github method of forking and asking +for a pull request . + +Before asking for a pull request , run the ` validate ` target to format and run +lint over the code . Fix any issues it indidates . When complete , ask for the +pull request . + + `` ` sh +./gradlew validate + `` ` + # # Other resources diff -- git a/build.gradle b/build.gradle index 5283f0e..419df38 100644 -- - a/build.gradle +++ b/build.gradle @ @ -4,7 +4,7 @ @ buildscript { } dependencies { classpath 'com.android.tools.build : gradle:2.3.3' - classpath 'me.tatarka : gradle-retrolambda:3.5.0' + classpath 'me.tatarka : gradle-retrolambda:3.7.0' // NOTE : Do not place your application dependencies here. } @ @ -31,7 +31,7 @ @ allprojects { android { compileSdkVersion 24 - buildToolsVersion '25.0.0' + buildToolsVersion '25.0.3' defaultConfig { applicationId `` com.google.android.mobly.snippet.bundled '' @ @ -50,6 +50,7 @ @ android { abortOnError true checkAllWarnings true warningsAsErrors true +
diff -- git a/api.go b/api.go index 6d83d03..24c9e49 100644 -- - a/api.go +++ b/api.go @ @ -16,12 +16,12 @ @ package safebrowsing import ( '' bytes '' + '' context '' '' fmt '' '' io/ioutil '' '' net/http '' '' net/url '' '' strings '' - '' time '' pb `` github.com/google/safebrowsing/internal/safebrowsing_proto '' @ @ -35,8 +35,8 @ @ const ( // The api interface specifies wrappers around the Safe Browsing API . type api interface { - ListUpdate ( req *pb.FetchThreatListUpdatesRequest ) ( *pb.FetchThreatListUpdatesResponse , error ) - HashLookup ( req *pb.FindFullHashesRequest ) ( *pb.FindFullHashesResponse , error ) + ListUpdate ( ctx context.Context , req *pb.FetchThreatListUpdatesRequest ) ( *pb.FetchThreatListUpdatesResponse , error ) + HashLookup ( ctx context.Context , req *pb.FindFullHashesRequest ) ( *pb.FindFullHashesResponse , error ) } // netAPI is an api object that talks to the server over HTTP . @ @ -48,7 +48,7 @ @ type netAPI struct { // newNetAPI creates a new netAPI object pointed at the provided root URL . // For every request , it will use the provided API key . // If the protocol is not specified in root , then this defaults to using HTTPS . -func newNetAPI ( root
diff -- git a/configure.ac b/configure.ac index a937c63..2ef5d93 100644 -- - a/configure.ac +++ b/configure.ac @ @ -4,6 +4,11 @ @ AC_CONFIG_SRCDIR ( [ src/google-authenticator.c ] ) AC_CONFIG_AUX_DIR ( [ build ] ) AC_CONFIG_MACRO_DIR ( [ build ] ) + # -- enable-silent-rules +m4_ifdef ( [ AM_SILENT_RULES ] , + [ AM_SILENT_RULES ( [ yes ] ) ] , + [ AC_SUBST ( [ AM_DEFAULT_VERBOSITY ] , [ 1 ] ) ] ) + AC_USE_SYSTEM_EXTENSIONS AM_INIT_AUTOMAKE ( [ foreign subdir-objects ] ) AM_MAINTAINER_MODE ( [ enable ] )
diff -- git a/WORKSPACE b/WORKSPACE index 800d7ce..9c36518 100644 -- - a/WORKSPACE +++ b/WORKSPACE @ @ -49,6 +49,11 @ @ maven_jar ( ) maven_jar ( + name = `` bouncycastle_1_56 '' , + artifact = `` org.bouncycastle : bcprov-jdk15on:1.56 '' , + ) + +maven_jar ( name = `` spongycastle_core_1_50 '' , artifact = `` com.madgag.spongycastle : core:1.50.0.0 '' , ) diff -- git a/build_defs.bzl b/build_defs.bzl index 13aa82b..61858bd 100644 -- - a/build_defs.bzl +++ b/build_defs.bzl @ @ -1,10 +1,10 @ @ -bouncycastle_versions = range ( 49 , 56 ) +bouncycastle_versions = range ( 49 , 57 ) # These targets run all tests . def bouncycastle_all_tests ( srcs , deps , size , test_class ) : `` '' '' BouncyCastle version-specific tests . '' '' '' - # Generates BouncyCastleAllTests_1_55 , ... , BouncyCastleAllTests_1_49 + # Generates BouncyCastleAllTests_1_56 , ... , BouncyCastleAllTests_1_49 for version in bouncycastle_versions : native.java_test ( name = `` BouncyCastleAllTests_1_ % s '' % version , @ @ -31,7 +31,7 @ @ def bouncycastle_all_tests ( srcs , deps , size , test_class ) : def bouncycastle_tests ( srcs , deps , size , test_class ) : `` '' '' BouncyCastle version-specific tests . '' '' '' - # Generates
diff -- git a/java/com/google/security/wycheproof/testcases/BigIntegerTest.java b/java/com/google/security/wycheproof/testcases/BigIntegerTest.java index cd5a992..8173a89 100644 -- - a/java/com/google/security/wycheproof/testcases/BigIntegerTest.java +++ b/java/com/google/security/wycheproof/testcases/BigIntegerTest.java @ @ -50,17 +50,12 @ @ public class BigIntegerTest extends TestCase { new BigInteger ( `` 164280218643672633986221 '' ) , new BigInteger ( `` 318665857834031151167461 '' ) , new BigInteger ( `` 7395010240794120709381 '' ) , - new BigInteger ( `` 164280218643672633986221 '' ) , - new BigInteger ( `` 318665857834031151167461 '' ) , new BigInteger ( `` 2995741773170734841812261 '' ) , new BigInteger ( `` 667636712015520329618581 '' ) , new BigInteger ( `` 3317044064679887385961981 '' ) , new BigInteger ( `` 3110269097300703345712981 '' ) , new BigInteger ( `` 552727880697763694556181 '' ) , - new BigInteger ( `` 360681321802296925566181 '' ) , - new BigInteger ( `` 7395010240794120709381 '' ) , new BigInteger ( `` 3404730287403079539471001 '' ) , - new BigInteger ( `` 164280218643672633986221 '' ) , // Richarg G.E . Pinch , `` Some primality testing algorithms '' // Some composites that passed Maple V 's primality test . new BigInteger ( `` 10710604680091 '' ) ,
diff -- git a/doc/index.md b/doc/index.md index c664ba1..0d570e6 100644 -- - a/doc/index.md +++ b/doc/index.md @ @ -1,7 +1,7 @ @ # Project Wycheproof This page describes the goals and strategies of project Wycheproof . See - [ README ] ( ../README.md ) for introduction to the project . + [ README ] ( ../README.md ) for an introduction to the project . # # Defense in depth @ @ -33,7 +33,7 @ @ rather than exploitability . Examples : One of the goals of Wycheproof is to test for compatibility issues . Switching JCE providers should not introduce vulnerabilities simply because -the solution was developed with another provider . +the solution was developed by another provider . An example for this was the following observation : When using AES-GCM then javax.crypto.CipherInputStream worked sort of with JCE and @ @ -49,10 +49,10 @ @ cryptographic libraries based on the bugs found would be biased : * Libraries used internally in Google get more attention . Serious vulnerabilities in these libraries should be fixed at the time the tests are added to Wycheproof . On the other hand it is also likely that - tests find a larger number of bugs in thsese
diff -- git a/README.md b/README.md index d9fee13..f5cf957 100644 -- - a/README.md +++ b/README.md @ @ -84,7 +84,7 @ @ providers in [ OpenJDK ] ( http : //openjdk.java.net/ ) . - Install [ Java Cryptography Extension ( JCE ) Unlimited Strength Jurisdiction Policy Files ] ( http : //stackoverflow.com/questions/6481627/java-security-illegal-key-size-or-default-parameters ) : this enables tests with large key -sizes . Otherwise you 'll see a lot of `` iilegal key size '' exceptions . +sizes . Otherwise you 'll see a lot of `` illegal key size '' exceptions . - Check out the tests @ @ -155,8 +155,8 @ @ BouncyCastleTest , SpongyCastleTest or OpenJDKTest -- these targets exclude all slow tests ( which are annotated with @ SlowTest ) . Most test targets are failing , and each failure might be a security issue . To -learn more about what a failed test means , you might want to check out our -documentation ( doc/bugs.md ) or the comments on top of the corresponding test +learn more about what a failed test means , you might want to check out [ our +documentation ] ( doc/bugs.md ) or the comments on top of the corresponding test function and test
diff -- git a/table/format.cc b/table/format.cc index aa63144..24e4e02 100644 -- - a/table/format.cc +++ b/table/format.cc @ @ -30,15 +30,14 @ @ Status BlockHandle : :DecodeFrom ( Slice* input ) { } void Footer : :EncodeTo ( std : :string* dst ) const { - # ifndef NDEBUG const size_t original_size = dst- > size ( ) ; - # endif metaindex_handle_.EncodeTo ( dst ) ; index_handle_.EncodeTo ( dst ) ; dst- > resize ( 2 * BlockHandle : :kMaxEncodedLength ) ; // Padding PutFixed32 ( dst , static_cast < uint32_t > ( kTableMagicNumber & 0xffffffffu ) ) ; PutFixed32 ( dst , static_cast < uint32_t > ( kTableMagicNumber > > 32 ) ) ; assert ( dst- > size ( ) == original_size + kEncodedLength ) ; + ( void ) original_size ; // Disable unused variable warning. } Status Footer : :DecodeFrom ( Slice* input ) {
diff -- git a/CONTRIBUTING.md b/CONTRIBUTING.md new file mode 100644 index 0000000..cd600ff -- - /dev/null +++ b/CONTRIBUTING.md @ @ -0,0 +1,36 @ @ + # Contributing + +We 'd love to accept your code patches ! However , before we can take them , we +have to jump a couple of legal hurdles . + + # # Contributor License Agreements + +Please fill out either the individual or corporate Contributor License +Agreement as appropriate . + +* If you are an individual writing original source code and you 're sure you +own the intellectual property , then sign an [ individual CLA ] ( https : //developers.google.com/open-source/cla/individual ) . +* If you work for a company that wants to allow you to contribute your work , +then sign a [ corporate CLA ] ( https : //developers.google.com/open-source/cla/corporate ) . + +Follow either of the two links above to access the appropriate CLA and +instructions for how to sign and return it . + + # # Submitting a Patch + +1 . Sign the contributors license agreement above . +2 . Decide which code you want to submit . A submission should be a set of changes +that addresses one
diff -- git a/.travis.yml b/.travis.yml new file mode 100644 index 0000000..54850e7 -- - /dev/null +++ b/.travis.yml @ @ -0,0 +1,16 @ @ +language : cpp +compiler : + - gcc + - clang +before_install : + - echo $ LANG + - echo $ LC_ALL +install : + - make all +script : + - make check +after_script : + - make clean +os : + - linux + - osx
diff -- git a/db/c.cc b/db/c.cc index 08ff0ad..66f8391 100644 -- - a/db/c.cc +++ b/db/c.cc @ @ -5,7 +5,9 @ @ # include `` leveldb/c.h '' # include < stdlib.h > + # ifndef _MSC_VER # include < unistd.h > + # endif # include `` leveldb/cache.h '' # include `` leveldb/comparator.h '' # include `` leveldb/db.h ''
diff -- git a/AUTHORS b/AUTHORS index cc37e22..b8945ee 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -17,6 +17,7 @ @ Anders Hasselqvist < anders.hasselqvist @ gmail.com > Chun-da Chen < capitalm.c @ gmail.com > Google Inc. < * @ google.com > Leandro Moreira < leandro.ribeiro.moreira @ gmail.com > +More Screens Ltd. < * @ morescreens.net > Philo Inc. < * @ philo.com > Richard Eklycke < richard @ eklycke.se > Sergio Ammirata < sergio @ ammirata.net > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index aa494ee..71fadc8 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -25,6 +25,7 @ @ Anders Hasselqvist < anders.hasselqvist @ gmail.com > Bei Li < beil @ google.com > Chun-da Chen < capitalm.c @ gmail.com > +David Cavar < pal3thorn @ gmail.com > Gabe Kopley < gabe @ philo.com > Haoming Chen < hmchen @ google.com > Jacob Trimble < modmaker @ google.com > diff -- git a/packager/file/file.cc b/packager/file/file.cc index 35273a4..a0f5aa6 100644 -- - a/packager/file/file.cc +++ b/packager/file/file.cc @ @ -9,9 +9,10 @ @ # include < gflags/gflags.h > # include < algorithm > # include < memory > - # include `` packager/base/files/important_file_writer.h '' + # include `` packager/base/files/file_util.h '' # include `` packager/base/logging.h '' # include `` packager/base/strings/string_piece.h ''
diff -- git a/core/src/main/java/com/google/googlejavaformat/java/CommandLineOptions.java b/core/src/main/java/com/google/googlejavaformat/java/CommandLineOptions.java index 47a6cfd..f636bc7 100644 -- - a/core/src/main/java/com/google/googlejavaformat/java/CommandLineOptions.java +++ b/core/src/main/java/com/google/googlejavaformat/java/CommandLineOptions.java @ @ -38,6 +38,8 @ @ final class CommandLineOptions { private final boolean removeJavadocOnlyImports ; private final boolean sortImports ; private final boolean removeUnusedImports ; + private final boolean dryRun ; + private final boolean setExitIfChanged ; CommandLineOptions ( ImmutableList < String > files , @ @ -52,7 +54,9 @ @ final class CommandLineOptions { boolean fixImportsOnly , boolean removeJavadocOnlyImports , boolean sortImports , - boolean removeUnusedImports ) { + boolean removeUnusedImports , + boolean dryRun , + boolean setExitIfChanged ) { this.files = files ; this.inPlace = inPlace ; this.lines = lines ; @ @ -66,6 +70,8 @ @ final class CommandLineOptions { this.removeJavadocOnlyImports = removeJavadocOnlyImports ; this.sortImports = sortImports ; this.removeUnusedImports = removeUnusedImports ; + this.dryRun = dryRun ; + this.setExitIfChanged = setExitIfChanged ; } /** The files to format . */ @ @ -141,6 +147,21 @ @ final class CommandLineOptions { return ! lines ( ) .isEmpty ( ) || ! offsets ( ) .isEmpty ( ) || ! lengths ( ) .isEmpty ( ) ; } + /** Returns true if dry-run mode was selected . */ + boolean isDryRun ( ) {
diff -- git a/core/src/main/java/com/google/googlejavaformat/java/CommandLineOptions.java b/core/src/main/java/com/google/googlejavaformat/java/CommandLineOptions.java index 47a6cfd..f636bc7 100644 -- - a/core/src/main/java/com/google/googlejavaformat/java/CommandLineOptions.java +++ b/core/src/main/java/com/google/googlejavaformat/java/CommandLineOptions.java @ @ -38,6 +38,8 @ @ final class CommandLineOptions { private final boolean removeJavadocOnlyImports ; private final boolean sortImports ; private final boolean removeUnusedImports ; + private final boolean dryRun ; + private final boolean setExitIfChanged ; CommandLineOptions ( ImmutableList < String > files , @ @ -52,7 +54,9 @ @ final class CommandLineOptions { boolean fixImportsOnly , boolean removeJavadocOnlyImports , boolean sortImports , - boolean removeUnusedImports ) { + boolean removeUnusedImports , + boolean dryRun , + boolean setExitIfChanged ) { this.files = files ; this.inPlace = inPlace ; this.lines = lines ; @ @ -66,6 +70,8 @ @ final class CommandLineOptions { this.removeJavadocOnlyImports = removeJavadocOnlyImports ; this.sortImports = sortImports ; this.removeUnusedImports = removeUnusedImports ; + this.dryRun = dryRun ; + this.setExitIfChanged = setExitIfChanged ; } /** The files to format . */ @ @ -141,6 +147,21 @ @ final class CommandLineOptions { return ! lines ( ) .isEmpty ( ) || ! offsets ( ) .isEmpty ( ) || ! lengths ( ) .isEmpty ( ) ; } + /** Returns true if dry-run mode was selected . */ + boolean isDryRun ( ) {
diff -- git a/g3doc/index.md b/g3doc/index.md index 405ce61..8b03ceb 100644 -- - a/g3doc/index.md +++ b/g3doc/index.md @ @ -940,7 +940,7 @ @ func work3 ( _ number : Int ) - > Int { return number * number } -work1 ( `` 10 '' ) .then { string in +work1 ( `` abc '' ) .then { string in return work2 ( string ) } .then { number in return work3 ( number ) // Never executed . @ @ -997,7 +997,7 @ @ high-level patterns that would also be great to provide out of the box . # # # All ` all ` class method waits for all the promises you give it to fulfill , and once -they have , the promise returned form ` all ` will be fulfilled with the array of +they have , the promise returned from ` all ` will be fulfilled with the array of all fulfilled values . Swift :
diff -- git a/g3doc/index.md b/g3doc/index.md index bd5d5f7..51bc9bf 100644 -- - a/g3doc/index.md +++ b/g3doc/index.md @ @ -443,7 +443,7 @ @ Or , the module , if ` CLANG_ENABLE_MODULES = YES ` : To use ` Promises ` for Objective-C , add the following to your ` Podfile ` : `` ` ruby -pod ` PromisesObjC ` , '~ > 1.0' +pod 'PromisesObjC ' , '~ > 1.0' `` ` Or , if you would also like to include the tests :
diff -- git a/CHANGELOG.md b/CHANGELOG.md index e433d7a..657f24c 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,11 @ @ + # # # # 1.0.2 + +* Improved ` toString ` implementations in file system entity classes +* Added ` ForwardingFileSystem ` and associated forwarding classes to the + main ` file ` library . +* Removed ` FileSystem.pathSeparator ` , and added a more comprehensive + ` FileSystem.path ` property . + # # # # 1.0.1 * Added ` FileSystem.systemTempDirectory ` diff -- git a/lib/src/backends/chroot/chroot_file_system.dart b/lib/src/backends/chroot/chroot_file_system.dart index 6e1c8d9..9ba2b81 100644 -- - a/lib/src/backends/chroot/chroot_file_system.dart +++ b/lib/src/backends/chroot/chroot_file_system.dart @ @ -69,7 +69,8 @ @ class ChrootFileSystem extends FileSystem { Link link ( path ) = > new _ChrootLink ( this , common.getPath ( path ) ) ; @ override - String get pathSeparator = > delegate.pathSeparator ; + p.Context get path = > + new p.Context ( style : delegate.path.style , current : _cwd ) ; /// Gets the system temp directory . This directory will be created on-demand /// in the local root of the file system . Once created , its location is fixed diff -- git a/lib/src/backends/local.dart b/lib/src/backends/local.dart index 78ed905..a76c41c 100644 -- - a/lib/src/backends/local.dart +++ b/lib/src/backends/local.dart @ @ -9,6
diff -- git a/lib/src/backends/record_replay/mutable_recording.dart b/lib/src/backends/record_replay/mutable_recording.dart index 5630591..f141d93 100644 -- - a/lib/src/backends/record_replay/mutable_recording.dart +++ b/lib/src/backends/record_replay/mutable_recording.dart @ @ -6,6 +6,7 @ @ import 'dart : async ' ; import 'dart : convert ' ; import 'package : file/file.dart ' ; +import 'package : intl/intl.dart ' ; import 'common.dart ' ; import 'encoding.dart ' ; @ @ -41,7 +42,7 @ @ class MutableRecording implements LiveRecording { Iterable < Future < Null > > futures = _events.map ( ( LiveInvocationEvent < dynamic > event ) = > event.done ) ; await Future - .wait < String > ( futures ) + .wait < Null > ( futures ) .timeout ( awaitPendingResults , onTimeout : ( ) { } ) ; } Directory dir = destination ; @ @ -53,6 +54,20 @ @ class MutableRecording implements LiveRecording { } } + /// Returns a new file for use with this recording . + /// + /// The file name will combine the specified [ name ] with [ newUid ] to ensure + /// that its name is unique among all recording files . + /// + /// It is up to the caller to create the file - it will not exist in the +
diff -- git a/constants.go b/constants.go index c2061c3..760640d 100644 -- - a/constants.go +++ b/constants.go @ @ -256,3 +256,15 @ @ const ( // Milliamperes is a unit of electric current consumption . type Milliamperes uint + +// HotplugEventType identifies the type of the hotplug event . +type HotplugEventType uint + +// Hotplug events . +const ( + HotplugEventDeviceArrived HotplugEventType = C.LIBUSB_HOTPLUG_EVENT_DEVICE_ARRIVED + HotplugEventDeviceLeft HotplugEventType = C.LIBUSB_HOTPLUG_EVENT_DEVICE_LEFT + HotplugEventAny HotplugEventType = HotplugEventDeviceArrived | HotplugEventDeviceLeft + ) + +const hotplugMatchAny = C.LIBUSB_HOTPLUG_MATCH_ANY diff -- git a/fakelibusb_test.go b/fakelibusb_test.go index 5774d90..378b025 100644 -- - a/fakelibusb_test.go +++ b/fakelibusb_test.go @ @ -209,6 +209,12 @ @ func ( f *fakeLibusb ) empty ( ) bool { return len ( f.submitted ) == 0 } +func ( f *fakeLibusb ) registerHotplugCallback ( ctx *libusbContext , events HotplugEventType , enumerate bool , vendorId int32 , productId int32 , devClass int32 , fn libusbHotplugCallback ) ( func ( ) , error ) { + // TODO : implement + return func ( ) { + } , nil + } + func newFakeLibusb ( ) *fakeLibusb { fl : = & fakeLibusb { fakeDevices : make ( map [ *libusbDevice ] *fakeDevice ) , diff -- git a/hotplug.c b/hotplug.c new file
diff -- git a/transfer_stream.go b/transfer_stream.go index 6e294fb..5dde5c1 100644 -- - a/transfer_stream.go +++ b/transfer_stream.go @ @ -31,18 +31,32 @ @ type stream struct { current transferIntf // total/used are the number of all/used bytes in the current transfer . total , used int - // delayedErr is the delayed error , returned to the user after all - // remaining data was read . - delayedErr error + // err is the first encountered error , returned to the user . + err error } -func ( s *stream ) setDelayedErr ( err error ) { - if s.delayedErr == nil { - s.delayedErr = err +func ( s *stream ) setErr ( err error ) { + if s.err == nil { + s.err = err close ( s.transfers ) } } +func ( s *stream ) done ( ) { + if s.err == nil { + close ( s.transfers ) + } + } + +func ( s *stream ) flush ( ) { + for t : = range s.transfers { + t.cancel ( ) + t.wait ( ) + t.free ( ) + } + s.transfers = nil + } + // ReadStream is a buffer
diff -- git a/endpoint_stream.go b/endpoint_stream.go index b9a2717..138aebc 100644 -- - a/endpoint_stream.go +++ b/endpoint_stream.go @ @ -14,7 +14,7 @ @ package gousb -func ( e *endpoint ) newStream ( size , count int , submit bool ) ( *stream , error ) { +func ( e *endpoint ) newStream ( size , count int ) ( *stream , error ) { var ts [ ] transferIntf for i : = 0 ; i < count ; i++ { t , err : = newUSBTransfer ( e.ctx , e.h , & e.Desc , size , e.Timeout ) @ @ -26,7 +26,7 @ @ func ( e *endpoint ) newStream ( size , count int , submit bool ) ( *stream , error ) { } ts = append ( ts , t ) } - return newStream ( ts , submit ) , nil + return newStream ( ts ) , nil } // NewStream prepares a new read stream that will keep reading data from the @ @ -36,9 +36,23 @ @ func ( e *endpoint ) newStream ( size , count int , submit bool ) ( *stream , error ) { // By keeping multiple transfers active at the
diff -- git a/AUTHORS b/AUTHORS index 9bcf017..ac153c9 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -13,3 +13,4 @ @ Thordur Bjornsson < thorduri @ secnorth.net > Vincent Serpoul < vincent @ serpoul.com > Josef Filzmaier < josef.filzmaier @ gmail.com > Nico MT < nicovell3 @ gmail.com > +Deomid `` rojer '' Ryabkov < rojer @ rojer.me > diff -- git a/device.go b/device.go index 3be599a..2cb3fce 100644 -- - a/device.go +++ b/device.go @ @ -45,6 +45,10 @ @ type DeviceDesc struct { // Configuration information Configs map [ int ] ConfigDesc + + iManufacturer int // The Manufacturer descriptor index + iProduct int // The Product descriptor index + iSerialNumber int // The SerialNumber descriptor index } // String returns a human-readable version of the device descriptor . @ @ -211,6 +215,24 @ @ func ( d *Device ) GetStringDescriptor ( descIndex int ) ( string , error ) { return libusb.getStringDesc ( d.handle , descIndex ) } +// Manufacturer returns the device 's manufacturer name . +// GetStringDescriptor 's string conversion rules apply . +func ( d *Device ) Manufacturer ( ) ( string , error ) { + return d.GetStringDescriptor ( d.Desc.iManufacturer ) + } + +// Product returns the
diff -- git a/internal/bgp/bgp.go b/internal/bgp/bgp.go index 9bd3f39..0267d57 100644 -- - a/internal/bgp/bgp.go +++ b/internal/bgp/bgp.go @ @ -8,9 +8,13 @ @ import ( '' io '' '' io/ioutil '' '' net '' + '' os '' '' reflect '' + '' strconv '' '' sync '' + '' syscall '' '' time '' + '' unsafe '' '' github.com/go-kit/kit/log '' ) @ @ -25,6 +29,7 @ @ type Session struct { peerASN uint32 holdTime time.Duration logger log.Logger + password string newHoldTime chan bool backoff backoff @ @ -144,6 +149,7 @ @ func ( s *Session ) sendUpdates ( ) bool { } // connect establishes the BGP session with the peer . +// sets TCP_MD5 sockopt if password is ! = '' '' , func ( s *Session ) connect ( ) error { s.mu.Lock ( ) defer s.mu.Unlock ( ) @ @ -154,13 +160,26 @ @ func ( s *Session ) connect ( ) error { ctx , cancel : = context.WithTimeout ( context.Background ( ) , 10*time.Second ) defer cancel ( ) + deadline , _ : = ctx.Deadline ( ) + // we need the same length timeout as the ctx . + timeout : = 10 + var
diff -- git a/internal/arp/arp.go b/internal/arp/arp.go index 5ccfd39..065d5ce 100644 -- - a/internal/arp/arp.go +++ b/internal/arp/arp.go @ @ -56,31 +56,11 @ @ const ( dropReasonNotLeader ) -func ( d dropReason ) String ( ) string { - switch d { - case dropReasonNone : - return `` '' - case dropReasonError : - return `` error '' - case dropReasonARPReply : - return `` unsolicited reply '' - case dropReasonEthernetDestination : - return `` bad ethernet destination '' - case dropReasonAnnounceIP : - return `` non-LB ip '' - case dropReasonNotLeader : - return `` not leader '' - } - return `` unknown '' - } - // Run starts the announcer , making it listen on the interface for ARP requests . It only responds to these // requests when a.leader is set to true , i.e . we are the current cluster wide leader for sending ARPs . func ( a *Announce ) Run ( ) { for { - if dropped : = a.readPacket ( ) ; dropped ! = dropReasonNone { - glog.Infof ( `` ARP packet dropped : % s '' , dropped ) - } + a.readPacket ( ) } } @ @ -118,6 +98,7 @
diff -- git a/eval.go b/eval.go index 3c87862..de0192e 100644 -- - a/eval.go +++ b/eval.go @ @ -255,7 +255,7 @ @ func Exec ( opts ExecOptions ) error { fmt.Printf ( `` ExecFile % s\n '' , opts.Filename ) defer fmt.Printf ( `` ExecFile % s done\n '' , opts.Filename ) } - f , err : = syntax.Parse ( opts.Filename , opts.Source ) + f , err : = syntax.Parse ( opts.Filename , opts.Source , 0 ) if err ! = nil { return err } @ @ -312,7 +312,7 @ @ func ( thread *Thread ) Pop ( ) { // If Eval fails during evaluation , it returns an *EvalError // containing a backtrace . func Eval ( thread *Thread , filename string , src interface { } , globals StringDict ) ( Value , error ) { - expr , err : = syntax.ParseExpr ( filename , src ) + expr , err : = syntax.ParseExpr ( filename , src , 0 ) if err ! = nil { return nil , err } diff -- git a/eval_test.go b/eval_test.go index e74445c..9ee38bc 100644 -- - a/eval_test.go +++ b/eval_test.go @ @ -437,7 +437,7 @ @ Error : floored division by
diff -- git a/eval.go b/eval.go index 3c87862..de0192e 100644 -- - a/eval.go +++ b/eval.go @ @ -255,7 +255,7 @ @ func Exec ( opts ExecOptions ) error { fmt.Printf ( `` ExecFile % s\n '' , opts.Filename ) defer fmt.Printf ( `` ExecFile % s done\n '' , opts.Filename ) } - f , err : = syntax.Parse ( opts.Filename , opts.Source ) + f , err : = syntax.Parse ( opts.Filename , opts.Source , 0 ) if err ! = nil { return err } @ @ -312,7 +312,7 @ @ func ( thread *Thread ) Pop ( ) { // If Eval fails during evaluation , it returns an *EvalError // containing a backtrace . func Eval ( thread *Thread , filename string , src interface { } , globals StringDict ) ( Value , error ) { - expr , err : = syntax.ParseExpr ( filename , src ) + expr , err : = syntax.ParseExpr ( filename , src , 0 ) if err ! = nil { return nil , err } diff -- git a/eval_test.go b/eval_test.go index e74445c..9ee38bc 100644 -- - a/eval_test.go +++ b/eval_test.go @ @ -437,7 +437,7 @ @ Error : floored division by
diff -- git a/cmd/skylark/skylark.go b/cmd/skylark/skylark.go index a3be90d..2268ab3 100644 -- - a/cmd/skylark/skylark.go +++ b/cmd/skylark/skylark.go @ @ -60,7 +60,9 @ @ func main ( ) { case 1 : // Execute specified file . filename : = flag.Args ( ) [ 0 ] - if err : = skylark.ExecFile ( thread , filename , nil , globals ) ; err ! = nil { + var err error + globals , err = skylark.ExecFile ( thread , filename , nil , nil ) + if err ! = nil { repl.PrintError ( err ) os.Exit ( 1 ) } diff -- git a/doc/spec.md b/doc/spec.md index b749187..c6cc939 100644 -- - a/doc/spec.md +++ b/doc/spec.md @ @ -1048,9 +1048,12 @ @ even though applications distinguish these two types . A built-in function value used in a Boolean context is always considered true . -Many built-in functions are defined in the `` universe '' block of the environment - ( see [ Name Resolution ] ( # name-resolution ) ) , and are thus available to -all Skylark programs . +Many built-in functions are predeclared in the environment + ( see [ Name Resolution ] ( # name-resolution ) ) . +Some built-in functions such as
diff -- git a/fire/core.py b/fire/core.py index 07698e0..1044432 100644 -- - a/fire/core.py +++ b/fire/core.py @ @ -60,6 +60,7 @ @ import pipes import shlex import sys import types +import re from fire import completion from fire import decorators @ @ -750,7 +751,7 @ @ def _ParseArgs ( fn_args , fn_defaults , num_required_args , kwargs , def _ParseKeywordArgs ( args , fn_spec ) : `` '' '' Parses the supplied arguments for keyword arguments . - Given a list of arguments , finds occurences of -- name value , and uses 'name' + Given a list of arguments , finds occurrences of -- name value , and uses 'name' as the keyword and 'value ' as the value . Constructs and returns a dictionary of these keyword arguments , and returns a list of the remaining arguments . @ @ -767,6 +768,9 @ @ def _ParseKeywordArgs ( args , fn_spec ) : kwargs : A dictionary mapping keywords to values . remaining_kwargs : A list of the unused kwargs from the original args . remaining_args : A list of the unused arguments from the original args . + Raises : + FireError : if a boolean shortcut arg is passed that could
diff -- git a/fire/core.py b/fire/core.py index 07698e0..5b3a068 100644 -- - a/fire/core.py +++ b/fire/core.py @ @ -60,6 +60,7 @ @ import pipes import shlex import sys import types +import re from fire import completion from fire import decorators @ @ -750,7 +751,7 @ @ def _ParseArgs ( fn_args , fn_defaults , num_required_args , kwargs , def _ParseKeywordArgs ( args , fn_spec ) : `` '' '' Parses the supplied arguments for keyword arguments . - Given a list of arguments , finds occurences of -- name value , and uses 'name' + Given a list of arguments , finds occurrences of -- name value , and uses 'name' as the keyword and 'value ' as the value . Constructs and returns a dictionary of these keyword arguments , and returns a list of the remaining arguments . @ @ -767,6 +768,9 @ @ def _ParseKeywordArgs ( args , fn_spec ) : kwargs : A dictionary mapping keywords to values . remaining_kwargs : A list of the unused kwargs from the original args . remaining_args : A list of the unused arguments from the original args . + Raises : + FireError : if a boolean shortcut arg is passed that could
diff -- git a/fire/core.py b/fire/core.py index a7e3ada..5dc40d0 100644 -- - a/fire/core.py +++ b/fire/core.py @ @ -565,7 +565,8 @ @ def _MakeParseFn ( fn ) : def _ParseFn ( args ) : `` '' '' Parses the list of ` args ` into ( varargs , kwargs ) , remaining_args . '' '' '' - kwargs , remaining_args = _ParseKeywordArgs ( args , all_args , fn_spec.varkw ) + kwargs , remaining_kwargs , remaining_args = \ + _ParseKeywordArgs ( args , all_args , fn_spec.varkw ) # Note : _ParseArgs modifies kwargs . parsed_args , kwargs , remaining_args , capacity = _ParseArgs ( @ @ -594,6 +595,7 @ @ def _MakeParseFn ( fn ) : varargs [ index ] = _ParseValue ( value , None , None , metadata ) varargs = parsed_args + varargs + remaining_args += remaining_kwargs consumed_args = args [ : len ( args ) - len ( remaining_args ) ] return ( varargs , kwargs ) , consumed_args , remaining_args , capacity @ @ -681,64 +683,72 @ @ def _ParseKeywordArgs ( args , fn_args , fn_keywords ) : fn_keywords : The argument name for **kwargs , or None if **kwargs not used Returns : kwargs : A dictionary mapping
diff -- git a/fire/parser.py b/fire/parser.py index a0cef6d..941c6f6 100644 -- - a/fire/parser.py +++ b/fire/parser.py @ @ -94,6 +94,9 @ @ def _LiteralEval ( value ) : SyntaxError : If the value string has a syntax error. `` '' '' root = ast.parse ( value , mode='eval ' ) + if isinstance ( root.body , ast.BinOp ) : + return value + for node in ast.walk ( root ) : for field , child in ast.iter_fields ( node ) : if isinstance ( child , list ) :
diff -- git a/fire/parser.py b/fire/parser.py index a0cef6d..b9cd9bb 100644 -- - a/fire/parser.py +++ b/fire/parser.py @ @ -94,6 +94,9 @ @ def _LiteralEval ( value ) : SyntaxError : If the value string has a syntax error. `` '' '' root = ast.parse ( value , mode='eval ' ) + if isinstance ( root.body , ast.BinOp ) : + return value + for node in ast.walk ( root ) : for field , child in ast.iter_fields ( node ) : if isinstance ( child , list ) : diff -- git a/fire/parser_test.py b/fire/parser_test.py index 2be6b83..7fd9ca7 100644 -- - a/fire/parser_test.py +++ b/fire/parser_test.py @ @ -69,10 +69,12 @ @ class ParserTest ( testutils.BaseTestCase ) : def testDefaultParseValueNumbers ( self ) : self.assertEqual ( parser.DefaultParseValue ( '23 ' ) , 23 ) + self.assertEqual ( parser.DefaultParseValue ( '-23 ' ) , -23 ) self.assertEqual ( parser.DefaultParseValue ( '23.0 ' ) , 23.0 ) self.assertIsInstance ( parser.DefaultParseValue ( '23 ' ) , int ) self.assertIsInstance ( parser.DefaultParseValue ( '23.0 ' ) , float ) self.assertEqual ( parser.DefaultParseValue ( '23.5 ' ) , 23.5 ) + self.assertEqual ( parser.DefaultParseValue ( '-23.5 ' ) , -23.5 ) def testDefaultParseValueStringNumbers ( self ) : self.assertEqual ( parser.DefaultParseValue ( ``
diff -- git a/src/backend/d3d12/D3D12Backend.cpp b/src/backend/d3d12/D3D12Backend.cpp index bc7fca2..184133b 100644 -- - a/src/backend/d3d12/D3D12Backend.cpp +++ b/src/backend/d3d12/D3D12Backend.cpp @ @ -62,22 +62,11 @ @ namespace backend { namespace d3d12 { backendDevice- > NextSerial ( ) ; } - void ExecuteCommandLists ( nxtDevice device , - std : :initializer_list < ID3D12CommandList* > commandLists ) { - Device* backendDevice = reinterpret_cast < Device* > ( device ) ; - backendDevice- > ExecuteCommandLists ( commandLists ) ; - } - void WaitForSerial ( nxtDevice device , uint64_t serial ) { Device* backendDevice = reinterpret_cast < Device* > ( device ) ; backendDevice- > WaitForSerial ( serial ) ; } - void OpenCommandList ( nxtDevice device , ComPtr < ID3D12GraphicsCommandList > * commandList ) { - Device* backendDevice = reinterpret_cast < Device* > ( device ) ; - return backendDevice- > OpenCommandList ( commandList ) ; - } - void ASSERT_SUCCESS ( HRESULT hr ) { ASSERT ( SUCCEEDED ( hr ) ) ; } diff -- git a/src/backend/d3d12/TextureD3D12.cpp b/src/backend/d3d12/TextureD3D12.cpp index 1bcfd7b..b608f95 100644 -- - a/src/backend/d3d12/TextureD3D12.cpp +++ b/src/backend/d3d12/TextureD3D12.cpp @ @ -44,6 +44,9 @ @ namespace backend { namespace d3d12 { resourceState |= D3D12_RESOURCE_STATE_RENDER_TARGET ; } } + if ( usage & nxt : :TextureUsageBit : :Present ) { +
diff -- git a/examples/Animometer.cpp b/examples/Animometer.cpp index 2af862a..0ea4457 100644 -- - a/examples/Animometer.cpp +++ b/examples/Animometer.cpp @ @ -57,7 +57,7 @ @ void init ( ) { float scalarOffset ; } c ; - out vec4 v_color ; + layout ( location = 0 ) out vec4 v_color ; const vec4 positions [ 3 ] = vec4 [ 3 ] ( vec4 ( 0.0f , 0.1f , 0.0f , 1.0f ) , @ @ -96,7 +96,7 @ @ void init ( ) { nxt : :ShaderModule fsModule = CreateShaderModule ( device , nxt : :ShaderStage : :Fragment , R '' ( # version 450 out vec4 fragColor ; - in vec4 v_color ; + layout ( location = 0 ) in vec4 v_color ; void main ( ) { fragColor = v_color ; } ) '' diff -- git a/src/backend/common/CommandBuffer.cpp b/src/backend/common/CommandBuffer.cpp index 76fb13c..4343673 100644 -- - a/src/backend/common/CommandBuffer.cpp +++ b/src/backend/common/CommandBuffer.cpp @ @ -436,8 +436,7 @ @ namespace backend { constexpr ValidationAspects requiredDispatchAspects = 1 < < VALIDATION_ASPECT_COMPUTE_PIPELINE | - 1 < < VALIDATION_ASPECT_BINDGROUPS | - 1 < < VALIDATION_ASPECT_VERTEX_BUFFERS ; + 1 < < VALIDATION_ASPECT_BINDGROUPS ; if ( ( requiredDispatchAspects & ~aspects ) .any ( ) ) { // Compute the lazily computed aspects
diff -- git a/src/backend/Framebuffer.cpp b/src/backend/Framebuffer.cpp index 5f9cff8..ba83290 100644 -- - a/src/backend/Framebuffer.cpp +++ b/src/backend/Framebuffer.cpp @ @ -103,19 +103,10 @ @ namespace backend { return nullptr ; } - // TODO ( kainino @ chromium.org ) : Remove this flag when the - // null=backbuffer hack is removed . Then , using null texture views can - // be completely disallowed . - bool usingBackbufferHack = false ; for ( auto & textureView : textureViews ) { if ( ! textureView ) { - if ( usingBackbufferHack ) { - // TODO ( kainino @ chromium.org ) update this too - HandleError ( `` Framebuffer has more than one null attachment '' ) ; - return nullptr ; - } - usingBackbufferHack = true ; - continue ; + HandleError ( `` Framebuffer attachment not set '' ) ; + return nullptr ; } // TODO ( cwallez @ chromium.org ) : Adjust for the mip-level once that is supported . diff -- git a/src/backend/RenderPass.cpp b/src/backend/RenderPass.cpp index b2e04a3..3746b25 100644 -- - a/src/backend/RenderPass.cpp +++ b/src/backend/RenderPass.cpp @ @ -94,6 +94,23 @ @ namespace backend { } } + for ( const auto & subpass : subpasses ) { + for ( unsigned int location
diff -- git a/examples/CHelloTriangle.cpp b/examples/CHelloTriangle.cpp index 8020acb..2d88274 100644 -- - a/examples/CHelloTriangle.cpp +++ b/examples/CHelloTriangle.cpp @ @ -81,8 +81,10 @ @ void frame ( ) { { nxtCommandBufferBuilder builder = nxtDeviceCreateCommandBufferBuilder ( device ) ; nxtCommandBufferBuilderBeginRenderPass ( builder , renderpass , framebuffer ) ; + nxtCommandBufferBuilderBeginRenderSubpass ( builder ) ; nxtCommandBufferBuilderSetPipeline ( builder , pipeline ) ; nxtCommandBufferBuilderDrawArrays ( builder , 3 , 1 , 0 , 0 ) ; + nxtCommandBufferBuilderEndRenderSubpass ( builder ) ; nxtCommandBufferBuilderEndRenderPass ( builder ) ; commands = nxtCommandBufferBuilderGetResult ( builder ) ; nxtCommandBufferBuilderRelease ( builder ) ; diff -- git a/examples/glTFViewer/glTFViewer.cpp b/examples/glTFViewer/glTFViewer.cpp index ccb5ae2..645a90b 100644 -- - a/examples/glTFViewer/glTFViewer.cpp +++ b/examples/glTFViewer/glTFViewer.cpp @ @ -445,18 +445,7 @ @ namespace { device = CreateCppNXTDevice ( ) ; queue = device.CreateQueueBuilder ( ) .GetResult ( ) ; - renderpass = device.CreateRenderPassBuilder ( ) - .SetAttachmentCount ( 1 ) - .AttachmentSetFormat ( 0 , nxt : :TextureFormat : :R8G8B8A8Unorm ) - .SetSubpassCount ( 1 ) - .SubpassSetColorAttachment ( 0 , 0 , 0 ) - .GetResult ( ) ; - framebuffer = device.CreateFramebufferBuilder ( ) - .SetRenderPass ( renderpass ) - // attachment 0 - > back buffer - // ( implicit ) // TODO ( kainino @ chromium.org ) :
diff -- git a/request_test.go b/request_test.go index eb389e3..ebb9adb 100644 -- - a/request_test.go +++ b/request_test.go @ @ -4,6 +4,7 @ @ import ( '' bytes '' '' encoding/json '' '' io '' + '' reflect '' '' strings '' '' testing '' '' time '' @ @ -504,6 +505,51 @ @ func unmarshalSamplePayload ( ) ( *Blog , error ) { return out , nil } +func TestUnmarshalManyPayload ( t *testing.T ) { + sample : = map [ string ] interface { } { + '' data '' : [ ] interface { } { + map [ string ] interface { } { + '' type '' : `` posts '' , + '' id '' : `` 1 '' , + '' attributes '' : map [ string ] interface { } { + '' body '' : `` First '' , + '' title '' : `` Post '' , + } , + } , + map [ string ] interface { } { + '' type '' : `` posts '' , + '' id '' : `` 2 '' , + '' attributes '' : map [ string ] interface { } { + ''
diff -- git a/README.md b/README.md index 8561bf4..7efab89 100644 -- - a/README.md +++ b/README.md @ @ -222,7 +222,7 @ @ Writes a JSON API response , with related records sideloaded , into an only . If you want to serialize many records , see , [ MarshalManyPayload ] ( # marshalmanypayload ) . - # # # # Handler Example Code + # # # # # Handler Example Code `` ` go func CreateBlog ( w http.ResponseWriter , r *http.Request ) { @ @ -270,7 +270,6 @ @ blogInterface : = make ( [ ] interface { } , len ( blogs ) ) for i , blog : = range blogs { blogInterface [ i ] = blog } - `` ` Alternatively , you can insert your ` Blog ` s into a slice of ` interface { } ` @ @ -283,7 +282,7 @ @ this , func FetchBlogs ( ) ( [ ] interface { } , error ) `` ` - # # # # Handler Example Code + # # # # # Handler Example Code `` ` go func ListBlogs ( w http.ResponseWriter , r *http.Request ) { @ @ -300,6 +299,44 @
diff -- git a/request.go b/request.go index 7e6d3eb..0cdc855 100644 -- - a/request.go +++ b/request.go @ @ -166,24 +166,84 @ @ func unmarshalNode ( data *Node , model reflect.Value , included *map [ string ] *Node ) continue } + // Check the JSON API Type if data.Type ! = args [ 1 ] { - er = fmt.Errorf ( `` Trying to Unmarshal an object of type % # v , but % # v does not match '' , data.Type , args [ 1 ] ) + er = fmt.Errorf ( + '' Trying to Unmarshal an object of type % # v , but % # v does not match '' , + data.Type , + args [ 1 ] , + ) break } - if fieldValue.Kind ( ) == reflect.String { - fieldValue.Set ( reflect.ValueOf ( data.ID ) ) - } else if fieldValue.Kind ( ) == reflect.Int { - id , err : = strconv.Atoi ( data.ID ) - if err ! = nil { - er = err - break - } - fieldValue.SetInt ( int64 ( id ) ) + // ID will have to be transmitted as astring per the JSON API spec
diff -- git a/README.md b/README.md index 25dd7d1..d21521d 100644 -- - a/README.md +++ b/README.md @ @ -298,6 +298,28 @ @ func ListBlogs ( w http.ResponseWriter , r *http.Request ) { } `` ` + # # # Links + +If you need to include [ link objects ] ( http : //jsonapi.org/format/ # document-links ) along with response data , implement the ` Linkable ` interface for document-links , and ` RelationshipLinkable ` for relationship links : + + `` ` go +func ( post Post ) JSONLinks ( ) *map [ string ] interface { } { + return & map [ string ] interface { } { + '' self '' : `` href '' : fmt.Sprintf ( `` https : //example.com/posts/ % d '' , post.ID ) , + } + } + +// Invoked for each relationship defined on the Post struct when marshaled +func ( post Post ) JSONRelationshipLinks ( relation string ) *map [ string ] interface { } { + if relation == `` comments '' { + return & map [ string ] interface { } { + '' related '' : fmt.Sprintf ( `` https : //example.com/posts/ % d/comments '' , post.ID
diff -- git a/README.md b/README.md index bcd7f9f..8ea14d5 100644 -- - a/README.md +++ b/README.md @ @ -300,6 +300,28 @ @ func ListBlogs ( w http.ResponseWriter , r *http.Request ) { } `` ` + # # # Links + +If you need to include [ link objects ] ( http : //jsonapi.org/format/ # document-links ) along with response data , implement the ` Linkable ` interface for document-links , and ` RelationshipLinkable ` for relationship links : + + `` ` go +func ( post Post ) JSONLinks ( ) *map [ string ] interface { } { + return & map [ string ] interface { } { + '' self '' : `` href '' : fmt.Sprintf ( `` https : //example.com/posts/ % d '' , post.ID ) , + } + } + +// Invoked for each relationship defined on the Post struct when marshaled +func ( post Post ) JSONRelationshipLinks ( relation string ) *map [ string ] interface { } { + if relation == `` comments '' { + return & map [ string ] interface { } { + '' related '' : fmt.Sprintf ( `` https : //example.com/posts/ % d/comments '' , post.ID
diff -- git a/autoload/maktaba/value.vim b/autoload/maktaba/value.vim index ef28f90..e060d92 100644 -- - a/autoload/maktaba/value.vim +++ b/autoload/maktaba/value.vim @ @ -51,6 +51,43 @ @ endfunction `` '' + '' Tests whether Funcrefs { X } and { Y } have the same function name . + '' This works around a behavior change in 7.4-1875 causing partials to not match + '' unless their argument lists match . + '' Example : > + '' call s : FuncNamesEqual ( + '' \ function ( 'X ' ) , + '' \ function ( 'X ' , [ 1 ] , { 'N ' : 2 } ) ) + '' < + '' These functions compare as equal even though their arg bindings differ . +function ! s : FuncNamesEqual ( X , Y ) abort + if ! has ( 'patch-7.4.1875 ' ) + `` Use simple equality . Partials were compared by name prior to patch 1875 . + return a : X == a : Y + endif + `` Compare functions by name only ( ignoring everything after comma or paren ) . + `` NOTE : This is robust without any clever handling of quotes and escapes + ``
diff -- git a/autoload/maktaba/path.vim b/autoload/maktaba/path.vim index dfd96f3..9c7595a 100644 -- - a/autoload/maktaba/path.vim +++ b/autoload/maktaba/path.vim @ @ -15,6 +15,7 @ @ else endif let s : trailing_slash = s : unescaped_slash . ' $ ' let s : trailing_slashes = s : unescaped_slash . '+ $ ' +let s : nontrailing_slash = s : unescaped_slash . '\ze . ' let s : drive_backslash = '\v^\a : \\\\' let s : drive_frontslash = '\v^\a : //' @ @ -81,6 +82,14 @ @ endfunction `` '' + '' Returns { path } with trailing slashes ( if any ) stripped ( forward or backslash , + '' depending on platform ) . +function ! maktaba # path # StripTrailingSlash ( path ) abort + return substitute ( a : path , s : trailing_slashes , `` , `` ) +endfunction + + + '' '' `` Returns the root component of { path } . `` In unix , / is the only root. `` In windows , the root can be \ ( which vim treats as the default drive ) , a drive @ @ -153,11 +162,21 @ @ endfunction `` '' - '' Splits { path } on the system separator
diff -- git a/autoload/maktaba/path.vim b/autoload/maktaba/path.vim index dfd96f3..619e02a 100644 -- - a/autoload/maktaba/path.vim +++ b/autoload/maktaba/path.vim @ @ -15,6 +15,7 @ @ else endif let s : trailing_slash = s : unescaped_slash . ' $ ' let s : trailing_slashes = s : unescaped_slash . '+ $ ' +let s : nontrailing_slash = s : unescaped_slash . '\ze . ' let s : drive_backslash = '\v^\a : \\\\' let s : drive_frontslash = '\v^\a : //' @ @ -81,6 +82,14 @ @ endfunction `` '' + '' Returns { path } with trailing slashes ( if any ) stripped ( forward or backslash , + '' depending on platform ) . +function ! maktaba # path # StripTrailingSlash ( path ) abort + return substitute ( a : path , s : trailing_slashes , `` , `` ) +endfunction + + + '' '' `` Returns the root component of { path } . `` In unix , / is the only root. `` In windows , the root can be \ ( which vim treats as the default drive ) , a drive @ @ -153,11 +162,21 @ @ endfunction `` '' - '' Splits { path } on the system separator
diff -- git a/autoload/maktaba/path.vim b/autoload/maktaba/path.vim index dfd96f3..9c7595a 100644 -- - a/autoload/maktaba/path.vim +++ b/autoload/maktaba/path.vim @ @ -15,6 +15,7 @ @ else endif let s : trailing_slash = s : unescaped_slash . ' $ ' let s : trailing_slashes = s : unescaped_slash . '+ $ ' +let s : nontrailing_slash = s : unescaped_slash . '\ze . ' let s : drive_backslash = '\v^\a : \\\\' let s : drive_frontslash = '\v^\a : //' @ @ -81,6 +82,14 @ @ endfunction `` '' + '' Returns { path } with trailing slashes ( if any ) stripped ( forward or backslash , + '' depending on platform ) . +function ! maktaba # path # StripTrailingSlash ( path ) abort + return substitute ( a : path , s : trailing_slashes , `` , `` ) +endfunction + + + '' '' `` Returns the root component of { path } . `` In unix , / is the only root. `` In windows , the root can be \ ( which vim treats as the default drive ) , a drive @ @ -153,11 +162,21 @ @ endfunction `` '' - '' Splits { path } on the system separator
diff -- git a/autoload/maktaba/log.vim b/autoload/maktaba/log.vim index 3d4aae1..0a48eca 100644 -- - a/autoload/maktaba/log.vim +++ b/autoload/maktaba/log.vim @ @ -41,6 +41,19 @ @ endfunction `` '' + '' Call { Handler } with { logitem } , trying both 1-arg and legacy 4-arg + '' signatures . +function ! s : CallHandler ( Handler , logitem ) abort + try + call maktaba # function # Call ( a : Handler , [ a : logitem ] ) + catch /E119 : / + `` Not enough arguments . Fall back to legacy 4-arg handler signature . + call maktaba # function # Call ( a : Handler , a : logitem ) + endtry +endfunction + + + '' '' `` Append { logitem } to s : log_queue and pass to handlers . function ! s : SendToHandlers ( logitem ) abort let l : maktaba = maktaba # Maktaba ( ) @ @ -65,12 +78,29 @ @ function ! s : SendToHandlers ( logitem ) abort `` Send to handlers . for l : Handler in l : maktaba.globals.loghandlers.Items ( ) - call maktaba # function # Call ( l : Handler , a : logitem ) + call s :
diff -- git a/pkg/db/db.go b/pkg/db/db.go index 1ab76a2..8cc26c9 100644 -- - a/pkg/db/db.go +++ b/pkg/db/db.go @ @ -31,8 +31,9 @ @ type DB struct { } type Record struct { - Val [ ] byte - Seq uint64 + Val [ ] byte + Seq uint64 + Repro bool } func Open ( filename string ) ( *DB , error ) { @ @ -51,15 +52,15 @ @ func Open ( filename string ) ( *DB , error ) { return db , nil } -func ( db *DB ) Save ( key string , val [ ] byte , seq uint64 ) { +func ( db *DB ) Save ( key string , val [ ] byte , seq uint64 , repro bool ) { if seq == seqDeleted { panic ( `` reserved seq '' ) } - if rec , ok : = db.Records [ key ] ; ok & & seq == rec.Seq & & bytes.Equal ( val , rec.Val ) { + if rec , ok : = db.Records [ key ] ; ok & & seq == rec.Seq & & repro == rec.Repro & & bytes.Equal ( val , rec.Val ) { return } - db.Records
diff -- git a/core/src/main/java/org/truth0/subjects/CollectionSubject.java b/core/src/main/java/org/truth0/subjects/CollectionSubject.java index e4fda7d..a954848 100644 -- - a/core/src/main/java/org/truth0/subjects/CollectionSubject.java +++ b/core/src/main/java/org/truth0/subjects/CollectionSubject.java @ @ -55,6 +55,12 @ @ public class CollectionSubject < S extends CollectionSubject < S , T , C > , T , C extend @ CheckReturnValue public Has < T , C > has ( ) { return new Has < T , C > ( ) { + @ Override public void size ( int size ) { + if ( getSubject ( ) .size ( ) ! = size ) { + fail ( `` has size '' , size ) ; + } + } + @ Override public void item ( T item ) { if ( ! getSubject ( ) .contains ( item ) ) { fail ( `` has item '' , item ) ; @ @ -177,6 +183,11 @ @ public class CollectionSubject < S extends CollectionSubject < S , T , C > , T , C extend public interface Has < E , C extends Collection < E > > { /** + * Attests that a Collection has the provided size + */ + void size ( int size ) ; + + /** * Attests
diff -- git a/types.go b/types.go index 90c4215..32ba6ef 100644 -- - a/types.go +++ b/types.go @ @ -293,11 +293,11 @ @ type TreeHeadSignature struct { // add-chain and add-pre-chain methods after base64 decoding ; see sections // 3.2 , 4.1 and 4.2. type SignedCertificateTimestamp struct { - SCTVersion Version ` tls : '' maxval:255 '' ` - LogID LogID - Timestamp uint64 - Extensions CTExtensions ` tls : '' minlen:0 , maxlen:65535 '' ` - Signature DigitallySigned // Signature over TLS-encoded CertificateTimestamp + SCTVersion Version ` tls : '' maxval:255 '' json : '' sct_version '' ` + LogID LogID ` json : '' id '' ` + Timestamp uint64 ` json : '' timestamp '' ` + Extensions CTExtensions ` tls : '' minlen:0 , maxlen:65535 '' json : '' extensions '' ` + Signature DigitallySigned ` json : `` signature '' ` // Signature over TLS-encoded CertificateTimestamp } // CertificateTimestamp is the collection of data that the signature in an diff -- git a/types_test.go b/types_test.go index 0a75c00..77f55b1 100644 -- - a/types_test.go +++ b/types_test.go @ @ -16,6 +16,7 @ @ package ct import ( '' encoding/hex '' + '' encoding/json '' '' strings '' '' testing '' @ @ -129,3 +130,37
diff -- git a/trillian/ctfe/ct_server/main.go b/trillian/ctfe/ct_server/main.go index 7409a63..27473c3 100644 -- - a/trillian/ctfe/ct_server/main.go +++ b/trillian/ctfe/ct_server/main.go @ @ -148,8 +148,7 @ @ func main ( ) { // Register handlers for all the configured logs using the correct RPC // client . for _ , c : = range cfg.LogConfigs.Config { - setupAndRegister ( ctx , clientMap [ c.LogBackendName ] , *rpcDeadline , c ) - if err ! = nil { + if err : = setupAndRegister ( ctx , clientMap [ c.LogBackendName ] , *rpcDeadline , c ) ; err ! = nil { glog.Exitf ( `` Failed to set up log instance for % +v : % v '' , cfg , err ) } }
diff -- git a/client/ctclient/ctclient.go b/client/ctclient/ctclient.go index 70f46e6..47d7765 100644 -- - a/client/ctclient/ctclient.go +++ b/client/ctclient/ctclient.go @ @ -212,8 +212,8 @ @ func getInclusionProofForHash ( ctx context.Context , logClient client.CheckLogClie hash : = sha256.Sum256 ( data ) return hash [ : ] } ) - if err : = verifier.VerifyInclusionProofByHash ( rsp.LeafIndex , int64 ( sth.TreeSize ) , rsp.AuditPath , sth.SHA256RootHash [ : ] , hash ) ; err ! = nil { - log.Fatalf ( `` Failed to VerifyInclusionProofByHash ( % d , % d ) = % v '' , rsp.LeafIndex , sth.TreeSize , err ) + if err : = verifier.VerifyInclusionProof ( rsp.LeafIndex , int64 ( sth.TreeSize ) , rsp.AuditPath , sth.SHA256RootHash [ : ] , hash ) ; err ! = nil { + log.Fatalf ( `` Failed to VerifyInclusionProof ( % d , % d ) = % v '' , rsp.LeafIndex , sth.TreeSize , err ) } fmt.Printf ( `` Verified that hash % x + proof = root hash % x\n '' , hash , sth.SHA256RootHash ) } diff -- git a/ctutil/loginfo.go b/ctutil/loginfo.go index 3aa1f0c..5b9ffdb 100644 -- - a/ctutil/loginfo.go +++ b/ctutil/loginfo.go @ @ -23,7 +23,7 @ @ import ( '' sync '' '' time '' -
diff -- git a/x509/x509.go b/x509/x509.go index 19d34ee..52c57e8 100644 -- - a/x509/x509.go +++ b/x509/x509.go @ @ -913,7 +913,7 @ @ func RemoveCTPoison ( tbsData [ ] byte ) ( [ ] byte , error ) { // extension ( there must be exactly 1 of these ) , preserving the order of other // extensions , and optionally changes the issuer name . The result is returned // as a DER-encoded TBSCertificate . -func BuildPrecertTBS ( tbsData [ ] byte , issuer *pkix.Name ) ( [ ] byte , error ) { +func BuildPrecertTBS ( tbsData [ ] byte , issuer *Certificate ) ( [ ] byte , error ) { var tbs tbsCertificate rest , err : = asn1.Unmarshal ( tbsData , & tbs ) if err ! = nil { @ @ -937,7 +937,7 @ @ func BuildPrecertTBS ( tbsData [ ] byte , issuer *pkix.Name ) ( [ ] byte , error ) { tbs.Raw = nil if issuer ! = nil { - asn1Issuer , err : = asn1.Marshal ( issuer.ToRDNSequence ( ) ) + asn1Issuer , err : = asn1.Marshal ( issuer.Subject.ToRDNSequence ( ) ) if err ! = nil { return nil , fmt.Errorf (
diff -- git a/x509/x509.go b/x509/x509.go index 8c52d3d..ec2d7a8 100644 -- - a/x509/x509.go +++ b/x509/x509.go @ @ -572,6 +572,8 @ @ var ( oidExtKeyUsageOCSPSigning = asn1.ObjectIdentifier { 1 , 3 , 6 , 1 , 5 , 5 , 7 , 3 , 9 } oidExtKeyUsageMicrosoftServerGatedCrypto = asn1.ObjectIdentifier { 1 , 3 , 6 , 1 , 4 , 1 , 311 , 10 , 3 , 3 } oidExtKeyUsageNetscapeServerGatedCrypto = asn1.ObjectIdentifier { 2 , 16 , 840 , 1 , 113730 , 4 , 1 } + // RFC 6962 s3.1 + oidExtKeyUsageCertificateTransparency = asn1.ObjectIdentifier { 1 , 3 , 6 , 1 , 4 , 1 , 11129 , 2 , 4 , 4 } ) // ExtKeyUsage represents an extended set of actions that are valid for a given key . @ @ -591,6 +593,7 @ @ const ( ExtKeyUsageOCSPSigning ExtKeyUsageMicrosoftServerGatedCrypto ExtKeyUsageNetscapeServerGatedCrypto + ExtKeyUsageCertificateTransparency ) // extKeyUsageOIDs contains the mapping between an ExtKeyUsage and its OID . @ @ -610,6 +613,7 @ @ var extKeyUsageOIDs = [ ] struct { { ExtKeyUsageOCSPSigning , oidExtKeyUsageOCSPSigning } , { ExtKeyUsageMicrosoftServerGatedCrypto , oidExtKeyUsageMicrosoftServerGatedCrypto } , { ExtKeyUsageNetscapeServerGatedCrypto , oidExtKeyUsageNetscapeServerGatedCrypto } , + { ExtKeyUsageCertificateTransparency , oidExtKeyUsageCertificateTransparency } , } func extKeyUsageFromOID (
diff -- git a/x509/go111_windows.go b/x509/go111_windows.go new file mode 100644 index 0000000..61c4016 -- - /dev/null +++ b/x509/go111_windows.go @ @ -0,0 +1,9 @ @ +// +build go-1.11 + +package x509 + +import ( + '' syscall '' + ) + +type syscallPtr = syscall.Pointer diff -- git a/x509/pre_go111_windows.go b/x509/pre_go111_windows.go new file mode 100644 index 0000000..8ae042f -- - /dev/null +++ b/x509/pre_go111_windows.go @ @ -0,0 +1,5 @ @ +// +build ! go-1.11 + +package x509 + +type syscallPtr = uintptr diff -- git a/x509/root_windows.go b/x509/root_windows.go index 92cc716..006ddbf 100644 -- - a/x509/root_windows.go +++ b/x509/root_windows.go @ @ -109,7 +109,7 @ @ func checkChainSSLServerPolicy ( c *Certificate , chainCtx *syscall.CertChainContex sslPara.Size = uint32 ( unsafe.Sizeof ( *sslPara ) ) para : = & syscall.CertChainPolicyPara { - ExtraPolicyPara : uintptr ( unsafe.Pointer ( sslPara ) ) , + ExtraPolicyPara : ( syscallPtr ) ( unsafe.Pointer ( sslPara ) ) , } para.Size = uint32 ( unsafe.Sizeof ( *para ) )
diff -- git a/guava/src/com/google/common/collect/ImmutableList.java b/guava/src/com/google/common/collect/ImmutableList.java index 9daa5cf..6b5bf00 100644 -- - a/guava/src/com/google/common/collect/ImmutableList.java +++ b/guava/src/com/google/common/collect/ImmutableList.java @ @ -16,6 +16,7 @ @ package com.google.common.collect ; +import static com.google.common.base.Preconditions.checkArgument ; import static com.google.common.base.Preconditions.checkElementIndex ; import static com.google.common.base.Preconditions.checkNotNull ; import static com.google.common.base.Preconditions.checkPositionIndexes ; @ @ -190,12 +191,17 @ @ public abstract class ImmutableList < E > extends ImmutableCollection < E > /** * Returns an immutable list containing the given elements , in order . * + * < p > The array { @ code others } must not be longer than { @ code Integer.MAX_VALUE - 12 } . + * * @ throws NullPointerException if any element is null * @ since 3.0 ( source-compatible since 2.0 ) */ @ SafeVarargs // For Eclipse . For internal javac we have disabled this pointless type of warning . public static < E > ImmutableList < E > of ( E e1 , E e2 , E e3 , E e4 , E e5 , E e6 , E e7 , E e8 , E e9 , E e10 , E e11 , E e12 , E ... others ) { + checkArgument ( + others.length < = Integer.MAX_VALUE - 12 , + ``
diff -- git a/guava-testlib/src/com/google/common/collect/testing/testers/MapEntrySetTester.java b/guava-testlib/src/com/google/common/collect/testing/testers/MapEntrySetTester.java index 660e7c2..b8a3777 100644 -- - a/guava-testlib/src/com/google/common/collect/testing/testers/MapEntrySetTester.java +++ b/guava-testlib/src/com/google/common/collect/testing/testers/MapEntrySetTester.java @ @ -114,6 +114,32 @ @ public class MapEntrySetTester < K , V > extends AbstractMapTester < K , V > { } expectReplacement ( entry ( k0 ( ) , v3 ( ) ) ) ; } + + @ MapFeature.Require ( { SUPPORTS_PUT , ALLOWS_NULL_VALUES } ) + @ CollectionSize.Require ( absent = ZERO ) + public void testSetValueWithNullValuesPresent ( ) { + for ( Entry < K , V > entry : getMap ( ) .entrySet ( ) ) { + if ( entry.getKey ( ) .equals ( k0 ( ) ) ) { + assertEquals ( `` entry.setValue ( ) should return the old value '' , v0 ( ) , entry.setValue ( null ) ) ; + break ; + } + } + expectReplacement ( entry ( k0 ( ) , ( V ) null ) ) ; + } + + @ MapFeature.Require ( value = SUPPORTS_PUT , absent = ALLOWS_NULL_VALUES ) + @ CollectionSize.Require ( absent = ZERO ) + public void testSetValueWithNullValuesAbsent ( ) { + for ( Entry < K , V > entry : getMap (
diff -- git a/guava-testlib/src/com/google/common/collect/testing/testers/MapEntrySetTester.java b/guava-testlib/src/com/google/common/collect/testing/testers/MapEntrySetTester.java index 660e7c2..b8a3777 100644 -- - a/guava-testlib/src/com/google/common/collect/testing/testers/MapEntrySetTester.java +++ b/guava-testlib/src/com/google/common/collect/testing/testers/MapEntrySetTester.java @ @ -114,6 +114,32 @ @ public class MapEntrySetTester < K , V > extends AbstractMapTester < K , V > { } expectReplacement ( entry ( k0 ( ) , v3 ( ) ) ) ; } + + @ MapFeature.Require ( { SUPPORTS_PUT , ALLOWS_NULL_VALUES } ) + @ CollectionSize.Require ( absent = ZERO ) + public void testSetValueWithNullValuesPresent ( ) { + for ( Entry < K , V > entry : getMap ( ) .entrySet ( ) ) { + if ( entry.getKey ( ) .equals ( k0 ( ) ) ) { + assertEquals ( `` entry.setValue ( ) should return the old value '' , v0 ( ) , entry.setValue ( null ) ) ; + break ; + } + } + expectReplacement ( entry ( k0 ( ) , ( V ) null ) ) ; + } + + @ MapFeature.Require ( value = SUPPORTS_PUT , absent = ALLOWS_NULL_VALUES ) + @ CollectionSize.Require ( absent = ZERO ) + public void testSetValueWithNullValuesAbsent ( ) { + for ( Entry < K , V > entry : getMap (
diff -- git a/guava-tests/test/com/google/common/collect/ImmutableMapTest.java b/guava-tests/test/com/google/common/collect/ImmutableMapTest.java index c40bbc6..55dad0c 100644 -- - a/guava-tests/test/com/google/common/collect/ImmutableMapTest.java +++ b/guava-tests/test/com/google/common/collect/ImmutableMapTest.java @ @ -646,6 +646,47 @ @ public class ImmutableMapTest extends TestCase { mapEntry ( `` three '' , 3 ) , mapEntry ( `` two '' , 2 ) ) ; } + + public void testToImmutableEnumMap ( ) { + Collector < Entry < AnEnum , Integer > , ? , ImmutableMap < AnEnum , Integer > > collector = + ImmutableMap.toImmutableEnumMap ( Entry : :getKey , Entry : :getValue ) ; + Equivalence < ImmutableMap < AnEnum , Integer > > equivalence = + Equivalence.equals ( ) + . < Entry < AnEnum , Integer > > pairwise ( ) + .onResultOf ( ImmutableMap : :entrySet ) ; + CollectorTester.of ( collector , equivalence ) + .expectCollects ( + ImmutableMap.of ( AnEnum.A , 1 , AnEnum.B , 2 , AnEnum.C , 3 ) , + mapEntry ( AnEnum.A , 1 ) , + mapEntry ( AnEnum.B , 2 ) , + mapEntry ( AnEnum.C , 3 ) ) ; + } + + public void testToImmutableEnumMap_exceptionOnDuplicateKey ( ) { + Collector < Entry < AnEnum , Integer > , ? , ImmutableMap < AnEnum ,
diff -- git a/guava-tests/test/com/google/common/hash/BloomFilterTest.java b/guava-tests/test/com/google/common/hash/BloomFilterTest.java index f28c239..94f87d1 100644 -- - a/guava-tests/test/com/google/common/hash/BloomFilterTest.java +++ b/guava-tests/test/com/google/common/hash/BloomFilterTest.java @ @ -17,10 +17,10 @ @ package com.google.common.hash ; import static com.google.common.base.Charsets.UTF_8 ; -import static com.google.common.hash.BloomFilterStrategies.BitArray ; import static com.google.common.truth.Truth.assertThat ; import com.google.common.collect.ImmutableSet ; +import com.google.common.hash.BloomFilterStrategies.LockFreeBitArray ; import com.google.common.math.LongMath ; import com.google.common.primitives.Ints ; import com.google.common.testing.EqualsTester ; @ @ -29,7 +29,12 @ @ import com.google.common.testing.SerializableTester ; import java.io.ByteArrayInputStream ; import java.io.ByteArrayOutputStream ; import java.math.RoundingMode ; +import java.time.Duration ; +import java.time.Instant ; +import java.util.ArrayList ; +import java.util.List ; import java.util.Random ; +import java.util.concurrent.ThreadLocalRandom ; import javax.annotation.Nullable ; import junit.framework.TestCase ; @ @ -39,15 +44,20 @ @ import junit.framework.TestCase ; * @ author Dimitris Andreou */ public class BloomFilterTest extends TestCase { + private static int NUM_PUTS = 1_000_000 ; + private static int GOLDEN_PRESENT_KEY = + ThreadLocalRandom.current ( ) .nextInt ( ) ; + @ AndroidIncompatible // OutOfMemoryError public void testLargeBloomFilterDoesntOverflow ( ) { long numBits = Integer.MAX_VALUE ; numBits++ ; - BitArray bitArray = new BitArray ( numBits ) ; + LockFreeBitArray lockFreeBitArray = new LockFreeBitArray ( numBits ) ; assertTrue ( - `` BitArray.bitSize ( ) must return a positive number , but was `` + bitArray.bitSize ( ) , - bitArray.bitSize ( ) > 0 )
diff -- git a/README.md b/README.md index cf39787..1c4b674 100644 -- - a/README.md +++ b/README.md @ @ -11,6 +11,9 @ @ Status : Early prototype phase The tools supports various tasks ( e.g . reproduce a crash locally ) needed by ClusterFuzz 's users . +Currently , it supports reproducing a crash locally . In the future , it will +support uploading a fuzzer , tailing fuzzer log , and uploading a testcase . + Installation -- -- -- -- -- -- -- -- - @ @ -18,15 +21,31 @ @ Installation ` pip install -U clusterfuzz ` + # # # For Goobuntu + +The default pip is of v1.5.4 , which has known issues when installing dependencies . You *must* upgrade to the version 9.0+ . + +Please be aware that the pip on Goobuntu is installed with apt-get . The binary is at ` /usr/bin/pip ` . When upgrading pip with ` sudo pip install -U pip ` , it installs to ` /usr/local/bin/pip ` , and ` sudo pip ` still points to ` /usr/bin/pip ` ( which is of the version 1.5.4 ) . + +Therefore , you must perform the below steps instead : + +1
diff -- git a/clusterfuzz/binary_providers.py b/clusterfuzz/binary_providers.py index 0581b01..2dd26c4 100644 -- - a/clusterfuzz/binary_providers.py +++ b/clusterfuzz/binary_providers.py @ @ -77,9 +77,6 @ @ class BinaryProvider ( object ) : build_dir = self.build_dir_name ( ) binary_location = os.path.join ( build_dir , self.binary_name ) - symbolizer_location = os.path.join ( os.path.dirname ( binary_location ) , - 'llvm-symbolizer ' ) - self.symbolizer_path = symbolizer_location if os.path.exists ( build_dir ) : return build_dir @ @ -105,7 +102,6 @ @ class BinaryProvider ( object ) : os.path.splitext ( filename ) [ 0 ] ) , build_dir ) stats = os.stat ( binary_location ) os.chmod ( binary_location , stats.st_mode | stat.S_IEXEC ) - os.chmod ( symbolizer_location , stats.st_mode | stat.S_IEXEC ) def get_binary_path ( self ) : return ' % s/ % s ' % ( self.get_build_directory ( ) , self.binary_name ) diff -- git a/clusterfuzz/common.py b/clusterfuzz/common.py index 1b94284..6884921 100644 -- - a/clusterfuzz/common.py +++ b/clusterfuzz/common.py @ @ -181,7 +181,7 @ @ def wait_execute ( proc , exit_on_error , capture_output=True , print_output=True ) : # fastest way to build strings . output_chunks.append ( chunk ) proc.wait ( ) - _print ( ' -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -
diff -- git a/build-deploy-artifact.sh b/build-deploy-artifact.sh new file mode 100755 index 0000000..3f566c2 -- - /dev/null +++ b/build-deploy-artifact.sh @ @ -0,0 +1,16 @ @ + # ! /bin/bash +bazel build -- javacopt `` -source 1.7 '' -- javacopt `` -target 1.7 '' //java/com/google/domain/registry/env/production : production_ear +OK= $ ? +if [ $ OK -eq 0 ] +then + echo `` Extracting ear file '' +else + echo `` Build failed '' + exit 1 +fi + +rm -rf mercury-donuts +mkdir mercury-donuts +cd mercury-donuts +jar -xf ../bazel-genfiles/java/com/google/domain/registry/env/production/production_ear.ear +cd ../ diff -- git a/java/google/registry/config/TestRegistryConfig.java b/java/google/registry/config/TestRegistryConfig.java index afbf770..3667094 100644 -- - a/java/google/registry/config/TestRegistryConfig.java +++ b/java/google/registry/config/TestRegistryConfig.java @ @ -34,7 +34,7 @ @ public class TestRegistryConfig implements RegistryConfig { @ Override public String getProjectId ( ) { - return `` domain-registry '' ; + return `` mercury-donuts '' ; } @ Override @ @ -84,7 +84,7 @ @ public class TestRegistryConfig implements RegistryConfig { @ Override public HostAndPort getServer ( ) { - throw new UnsupportedOperationException ( ) ; + return null ; } @ Override diff -- git a/java/google/registry/env/BUILD b/java/google/registry/env/BUILD index 17ccbda..b5902f3 100644 -- - a/java/google/registry/env/BUILD +++ b/java/google/registry/env/BUILD @ @ -4,3 +4,47 @ @ package ( licenses ( [ `` notice '' ] ) # Apache 2.0 +
diff -- git a/build-deploy-artifact.sh b/build-deploy-artifact.sh new file mode 100755 index 0000000..2d4549b -- - /dev/null +++ b/build-deploy-artifact.sh @ @ -0,0 +1,29 @ @ + # ! /bin/bash + +if [ -z `` $ 1 '' ] ; then + echo `` usage : build-deploy-artifact.sh ear_dir [ environment ] '' + echo `` ear_dir : Directory where the .ear file will be expanded . Required . '' + echo `` environment : The environment the build should target ( \ '' crash\ '' , e.g. ) . Defaults to production environment . '' + exit 1 +fi +EAR_DIR= $ 1 + +ENV_SUFFIX= '' '' +if [ -n `` $ 2 '' ] ; then + echo `` building for $ 2 environment '' + if [ `` $ 2 '' ! = `` production '' ] ; then + ENV_SUFFIX= '' _ $ 2 '' + fi +fi + +if ! bazel build -- javacopt `` -source 1.7 '' -- javacopt `` -target 1.7 '' //java/google/registry : registry $ { ENV_SUFFIX } .ear ; then + echo `` Build failed '' + exit 1 +fi + +echo `` Extracting .ear file to '' $ PWD/ $ EAR_DIR +rm -rf $ EAR_DIR +mkdir
diff -- git a/.gitignore b/.gitignore index 64fc08d..e8a414c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -9,7 +9,6 @ @ .mtj.tmp/ # Package Files # -*.jar *.war *.ear @ @ -76,3 +75,6 @ @ autogenerated/ # Python Ignores *.pyc + + # Avoid ignoring Gradle wrapper jar file ( .jar files are usually ignored ) + ! gradle-wrapper.jar diff -- git a/Jenkinsfile b/Jenkinsfile new file mode 100644 index 0000000..497e2f6 -- - /dev/null +++ b/Jenkinsfile @ @ -0,0 +1,13 @ @ +node { + stage 'Checkout' + checkout scm + + stage 'Build' + sh './gradlew clean build -x test' + + stage 'Test' + sh './gradlew clean test' + + // Publish the results of the tests + junit 'build/test-results/*.xml' + } diff -- git a/build-deploy-artifact.sh b/build-deploy-artifact.sh new file mode 100755 index 0000000..2d4549b -- - /dev/null +++ b/build-deploy-artifact.sh @ @ -0,0 +1,29 @ @ + # ! /bin/bash + +if [ -z `` $ 1 '' ] ; then + echo `` usage : build-deploy-artifact.sh ear_dir [ environment ] '' + echo `` ear_dir : Directory where the .ear file will be expanded . Required . '' + echo `` environment : The environment the build should target ( \ ''
diff -- git a/.gitignore b/.gitignore index 64fc08d..e8a414c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -9,7 +9,6 @ @ .mtj.tmp/ # Package Files # -*.jar *.war *.ear @ @ -76,3 +75,6 @ @ autogenerated/ # Python Ignores *.pyc + + # Avoid ignoring Gradle wrapper jar file ( .jar files are usually ignored ) + ! gradle-wrapper.jar diff -- git a/Jenkinsfile b/Jenkinsfile new file mode 100644 index 0000000..fc13f1d -- - /dev/null +++ b/Jenkinsfile @ @ -0,0 +1,24 @ @ +node { + stage 'Checkout' + checkout scm + + stage 'Build' + sh './gradlew clean build -x test' + + stage 'Test' + sh './gradlew clean test' + + // Publish the results of the tests + junit 'build/test-results/*.xml' + + def currentBranch = sh ( script : `` git show -s -- pretty= % d HEAD '' , returnStdout : true ) + println `` Current Branch : $ currentBranch '' + + // If we are on the 'master ' branch release to S3 bucket + if ( currentBranch.contains ( 'origin/master ' ) ) { + stage 'Release' + // Jenkins works in a detached state . Reattach back to master + sh 'git checkout -b origin/master' +
diff -- git a/.gitignore b/.gitignore index 64fc08d..e8a414c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -9,7 +9,6 @ @ .mtj.tmp/ # Package Files # -*.jar *.war *.ear @ @ -76,3 +75,6 @ @ autogenerated/ # Python Ignores *.pyc + + # Avoid ignoring Gradle wrapper jar file ( .jar files are usually ignored ) + ! gradle-wrapper.jar diff -- git a/Jenkinsfile b/Jenkinsfile new file mode 100644 index 0000000..38415a9 -- - /dev/null +++ b/Jenkinsfile @ @ -0,0 +1,25 @ @ +node { + stage 'Checkout' + checkout scm + + stage 'Build' + sh './gradlew clean build -x test' + + stage 'Test' + sh './gradlew clean test' + + // Publish the results of the tests + junit 'build/test-results/*.xml' + +// TODO : Enable when Jenkins supports disabling build on CI commit +// def currentBranch = sh ( script : `` git show -s -- pretty= % d HEAD '' , returnStdout : true ) +// println `` Current Branch : $ currentBranch '' +// +// // If we are on the 'master ' branch release to S3 bucket +// if ( currentBranch.contains ( 'origin/master ' ) ) { +// stage 'Release' +// // Jenkins works in a detached state
diff -- git a/compiler/stmt.py b/compiler/stmt.py index b5e5270..71c45bf 100644 -- - a/compiler/stmt.py +++ b/compiler/stmt.py @ @ -32,6 +32,30 @ @ _NATIVE_TYPE_PREFIX = 'type_' _nil_expr = expr.nil_expr + # Parser flags , set on 'from __future__ import * ' , see parser_flags on + # StatementVisitor below . Note these have the same values as CPython . +FUTURE_DIVISION = 0x2000 +FUTURE_ABSOLUTE_IMPORT = 0x4000 +FUTURE_PRINT_FUNCTION = 0x10000 +FUTURE_UNICODE_LITERALS = 0x20000 + + # Names for future features in 'from __future__ import * ' . Map from name in the + # import statement to a tuple of the flag for parser , and whether we 've ( grumpy ) + # implemented the feature yet . +future_features = { + `` division '' : ( FUTURE_DIVISION , False ) , + `` absolute_import '' : ( FUTURE_ABSOLUTE_IMPORT , False ) , + `` print_function '' : ( FUTURE_PRINT_FUNCTION , True ) , + `` unicode_literals '' : ( FUTURE_UNICODE_LITERALS , False ) , + } + + # These future features are already in the language proper as of 2.6 , so + # importing them via __future__ has no effect . +redundant_future_features = [ `` generators '' , `` with_statement '' ,
diff -- git a/lib/math.py b/lib/math.py new file mode 100644 index 0000000..730a9a7 -- - /dev/null +++ b/lib/math.py @ @ -0,0 +1,236 @ @ + # Copyright 2016 Google Inc. All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + +from __go__.math import ( Pi , E , Ceil , Copysign , Abs , Floor , Mod , Frexp , IsInf , + IsNaN , Exp2 , Modf , Trunc , Exp , Expm1 , Log , Log1p , Log10 , Pow , Sqrt , Acos , + Asin
diff -- git a/Makefile b/Makefile index 8f81c71..abd4d76 100644 -- - a/Makefile +++ b/Makefile @ @ -21,8 +21,15 @ @ GOOS ? = $ ( word 1 , $ ( GO_ENV ) ) GOARCH ? = $ ( word 2 , $ ( GO_ENV ) ) ROOT_DIR : = $ ( realpath . ) PKG_DIR : = build/pkg/ $ ( GOOS ) _ $ ( GOARCH ) +PYTHON ? = python +PYTHON_BIN : = $ ( shell which $ ( PYTHON ) ) +PYTHON_VER : = $ ( word 2 , $ ( shell $ ( PYTHON ) -V 2 > & 1 ) ) PY_DIR : = build/lib/python2.7/site-packages +ifeq ( $ ( filter 2.7. % , $ ( PYTHON_VER ) ) , ) + $ ( error unsupported Python version $ ( PYTHON_VER ) , Grumpy only supports 2.7.x . To use a different python binary such as python2 , run : 'make PYTHON=python2 ... ' ) +endif + export GOPATH : = $ ( ROOT_DIR ) /build export PYTHONPATH : = $ ( ROOT_DIR ) / $ ( PY_DIR ) export PATH : = $ ( ROOT_DIR ) /build/bin : $ ( PATH ) @ @ -90,30 +97,31 @
diff -- git a/contest_proposal.md b/contest_proposal.md index e0e09ee..44025b8 100644 -- - a/contest_proposal.md +++ b/contest_proposal.md @ @ -318,6 +318,10 @ @ The image is determined to be valid only if all of the following hold true : 3. the image is not truncated , is not occluded , and is not a depiction of any sort . + # # # Addendum : Optional `` closed '' defense submissions +If a researcher has an idea for a defense that they would like to try out , but they do not yet want to make the defense mechanism public , they can optionally submit a **closed defense** . A closed defense releases the pre-trained model and weights , but not the code , hyperparameters , nor any data required to train it . If staked ( by the review board , or by the submitter ) , successful attacks against a closed defense can still be granted the attacker prize . However , **closed defense submissions can not win the competition** . A closed defense can be re-submitted as an open defense , in which case the 90-day timer starts and it becomes eligible to win . + + # Additional Contest Mechanics
diff -- git a/unrestricted-advex/unrestricted_advex/attacks.py b/unrestricted-advex/unrestricted_advex/attacks.py index 63f3480..6167ee9 100644 -- - a/unrestricted-advex/unrestricted_advex/attacks.py +++ b/unrestricted-advex/unrestricted_advex/attacks.py @ @ -10,6 +10,7 @ @ import tensorflow as tf from cleverhans.attacks import SPSA from cleverhans.model import Model from foolbox.attacks import BoundaryAttack as FoolboxBoundaryAttack +from imagenet_c import corrupt from six.moves import xrange from unrestricted_advex.cleverhans_fast_spatial_attack import SpatialTransformationMethod @ @ -75,6 +76,53 @ @ class SpsaAttack ( Attack ) : return np.concatenate ( all_x_adv_np ) +class CommonCorruptionsAttack ( object ) : + name = `` common_corruptions '' + + def __init__ ( self ) : + pass + + def __call__ ( self , model_fn , images_batch_nhwc , y_np ) : + corruption_names = [ + 'gaussian_noise ' , + 'shot_noise ' , + 'impulse_noise ' , + 'defocus_blur ' , + 'glass_blur ' , + 'motion_blur ' , + 'zoom_blur ' , + 'snow ' , + 'frost ' , + 'fog ' , + 'brightness ' , + 'contrast ' , + 'elastic_transform ' , + 'pixelate ' , + 'jpeg_compression ' , + 'speckle_noise ' , + 'gaussian_blur ' , + 'spatter ' , + 'saturate ' ] + + all_worst_x = [ ] + for idx , x in enumerate ( images_batch_nhwc ) : +
diff -- git a/README.md b/README.md index ff4cdaa..ba05c70 100644 -- - a/README.md +++ b/README.md @ @ -25,10 +25,10 @ @ The top few distinct models for each dataset are shown below . You can see all s All percentages above correspond to the model 's accuracy at 80 % coverage . # # # # Bird or Bicycle dataset -| Defense | Submitted by | Clean data | Spatial grid attack | SPSA attack | Boundary attack | Submission Date | +| Defense | Submitted by | Clean data | Common corruptions | Spatial grid attack | SPSA attack | Boundary attack | Submission Date | | -- -- -- -- -- -- -- -- -- -- - | -- -- -- -- -- -- - | -- -- -- -- -- -- | -- -- -- -- -- -- | -- -- -- -- -- -- -- - | -- -- -- -- -- -- -- - | -- -- -- -- -- -- -- - | -| [ Keras ResNet < br > ( trained on ImageNet ) ] ( examples/undefended_keras_resnet ) | Google Brain | 100.0 % | 96.5 % | 1.6 % | 4.0 % | Sept
diff -- git a/README.md b/README.md index ff4cdaa..ba05c70 100644 -- - a/README.md +++ b/README.md @ @ -25,10 +25,10 @ @ The top few distinct models for each dataset are shown below . You can see all s All percentages above correspond to the model 's accuracy at 80 % coverage . # # # # Bird or Bicycle dataset -| Defense | Submitted by | Clean data | Spatial grid attack | SPSA attack | Boundary attack | Submission Date | +| Defense | Submitted by | Clean data | Common corruptions | Spatial grid attack | SPSA attack | Boundary attack | Submission Date | | -- -- -- -- -- -- -- -- -- -- - | -- -- -- -- -- -- - | -- -- -- -- -- -- | -- -- -- -- -- -- | -- -- -- -- -- -- -- - | -- -- -- -- -- -- -- - | -- -- -- -- -- -- -- - | -| [ Keras ResNet < br > ( trained on ImageNet ) ] ( examples/undefended_keras_resnet ) | Google Brain | 100.0 % | 96.5 % | 1.6 % | 4.0 % | Sept
diff -- git a/bird-or-bicycle/bin/process_tasker_data.py b/bird-or-bicycle/bin/process_tasker_data.py index bb5d850..9965aa1 100644 -- - a/bird-or-bicycle/bin/process_tasker_data.py +++ b/bird-or-bicycle/bin/process_tasker_data.py @ @ -61,6 +61,15 @ @ def _strip_name ( image_id ) : return image_id + # Images that are known to be mislabeled by taskers +KNOWN_BAD_IMAGES = { + 'e9310a5dce5bbb0f ' , + '1422b0695f2d3d51 ' , + '1988a12b8997bab2 ' , + '3519bf7ab7d2f7b6 ' , + '599a814b35fb994d ' , + } + if __name__ == '__main__ ' : unambiguous_bird_ids = [ ] @ @ -70,8 +79,7 @ @ if __name__ == '__main__ ' : unambiguous_bicycle_urls = [ ] rejection_reason_to_urls = defaultdict ( list ) - - filename = '/tmp/bird-or-bicycle-tasker-data.csv' + filename = '/Users/tomfeelslucky/Downloads/bird-or-bicycle-tasker-data - shuffled_urls_v0-0-1.csv' with open ( filename , 'r ' ) as f : reader = csv.reader ( f ) _ = next ( reader ) @ @ -80,7 +88,8 @ @ if __name__ == '__main__ ' : # print ( i ) # print ( row ) - url , image_id = row [ :2 ] + url , long_image_id = row [ :2 ] + image_id = _strip_name ( long_image_id ) tasker_1_data = row [ 2:9 ] tasker_2_data = row [ 9:16 ] @ @ -91,6 +100,11 @ @ if __name__ == '__main__ '
diff -- git a/unrestricted-advex/unrestricted_advex/attacks.py b/unrestricted-advex/unrestricted_advex/attacks.py index 63f3480..0b07bdb 100644 -- - a/unrestricted-advex/unrestricted_advex/attacks.py +++ b/unrestricted-advex/unrestricted_advex/attacks.py @ @ -5,13 +5,16 @ @ from __future__ import print_function import random from itertools import product , repeat +import PIL.Image import numpy as np import tensorflow as tf +import torchvision.transforms.functional from cleverhans.attacks import SPSA from cleverhans.model import Model from foolbox.attacks import BoundaryAttack as FoolboxBoundaryAttack from six.moves import xrange from unrestricted_advex.cleverhans_fast_spatial_attack import SpatialTransformationMethod +import itertools class Attack ( object ) : @ @ -33,6 +36,54 @ @ class CleanData ( Attack ) : return images_batch_nhwc +def apply_transformation ( x , angle , dx , dy ) : + return torchvision.transforms.functional.affine ( + x , + angle=angle , + translate= [ dx , dy ] , + shear=0 , + resample=PIL.Image.BICUBIC , + scale=1 + ) + + +class SimpleSpatialAttack ( Attack ) : + `` '' '' Fast attack from `` A Rotation and a Translation Suffice : Fooling CNNs with + Simple Transformations '' , Engstrom et al . 2018 + + https : //arxiv.org/pdf/1712.02779.pdf + `` '' '' + name = 'spatial_grid' + + def __init__ ( self , + image_shape_hwc , + spatial_limits , + grid_granularity , + black_border_size , + ) : + self.image_shape_hwc
diff -- git a/unrestricted-advex/unrestricted_advex/attacks.py b/unrestricted-advex/unrestricted_advex/attacks.py index 63f3480..927db41 100644 -- - a/unrestricted-advex/unrestricted_advex/attacks.py +++ b/unrestricted-advex/unrestricted_advex/attacks.py @ @ -2,16 +2,20 @ @ from __future__ import absolute_import from __future__ import division from __future__ import print_function +import itertools +import logging +import multiprocessing import random from itertools import product , repeat +import PIL.Image import numpy as np import tensorflow as tf +import torchvision.transforms.functional from cleverhans.attacks import SPSA from cleverhans.model import Model from foolbox.attacks import BoundaryAttack as FoolboxBoundaryAttack from six.moves import xrange -from unrestricted_advex.cleverhans_fast_spatial_attack import SpatialTransformationMethod class Attack ( object ) : @ @ -33,6 +37,155 @ @ class CleanData ( Attack ) : return images_batch_nhwc +def apply_transformation ( x , angle , dx , dy , black_border_size ) : + `` '' '' Apply a transformation to an image '' '' '' + x = PIL.Image.fromarray ( ( x * 255 . ) .astype ( np.uint8 ) ) + + # Apply black border + orig_width = x.width + orig_height = x.height + + padding_x = int ( float ( orig_height ) * black_border_size ) + padding_y = int ( float ( orig_width ) * black_border_size ) + + x = torchvision.transforms.functional.resize ( x , [ + orig_height - ( padding_y * 2 ) , +
diff -- git a/README.md b/README.md index aa893da..1a59b82 100644 -- - a/README.md +++ b/README.md @ @ -27,8 +27,9 @ @ All percentages above correspond to the model 's accuracy at 80 % coverage . # # # # Bird or Bicycle dataset | Defense | Submitted by | Clean data | Common corruptions | Spatial grid attack | SPSA attack | Boundary attack | Submission Date | | -- -- -- -- -- -- -- -- -- -- - | -- -- -- -- -- -- - | -- -- -- -- -- -- | -- -- -- -- -- -- | -- -- -- -- -- -- -- - | -- -- -- -- | -- -- -- - | -- -- -- -- -- -- -- - | -| [ Keras ResNet < br > ( trained on ImageNet ) ] ( examples/undefended_keras_resnet ) | Google Brain | 100.0 % | 99.2 % | 96.5 % | 1.6 % | 4.0 % | Sept 29th , 2018 | -| [ Pytorch ResNet < br > ( trained on bird-or-bicycle extras ) ] ( examples/undefended_pytorch_resnet ) | Google Brain | 98.8 % | 74.6 % | 29.1 % | 2.5
diff -- git a/package-lock.json b/package-lock.json index 2c6bd2b..ef406ae 100644 -- - a/package-lock.json +++ b/package-lock.json @ @ -137,9 +137,9 @ @ } } , `` @ types/inquirer '' : { - `` version '' : `` 0.0.38 '' , - `` resolved '' : `` https : //registry.npmjs.org/ @ types/inquirer/-/inquirer-0.0.38.tgz '' , - `` integrity '' : `` sha512-RyZaZKuHFAQTZcrVaW7QgdMYYqEk2FS3eNLfU1rszURBehIiOtiv3AXVkelAVNmZb9dD6pruXaom/5V57pMcEQ== '' , + `` version '' : `` 0.0.40 '' , + `` resolved '' : `` https : //registry.npmjs.org/ @ types/inquirer/-/inquirer-0.0.40.tgz '' , + `` integrity '' : `` sha512-MEUWlhRf/BxZIXHD4p3AR/HnmZYHBLoIDqwZcNB8wNWsIFyEOZPh23b0LFAnKDPYOdgD6Kz9Ju4K661AC/zBng== '' , `` dev '' : true , `` requires '' : { `` @ types/rx '' : `` 4.1.1 '' , @ @ -209,7 +209,7 @ @ `` @ types/rimraf '' : { `` version '' : `` 2.0.2 '' , `` resolved '' : `` https : //registry.npmjs.org/ @ types/rimraf/-/rimraf-2.0.2.tgz '' , - `` integrity '' : `` sha1-fw/Dzw/wrSqZu3I64XZPMKyvi24= '' , + `` integrity '' : `` sha512-Hm/bnWq0TCy7jmjeN5bKYij9vw5GrDFWME4IuxV08278NtU/VdGbzsBohcCUJ7+QMqmUq5hpRKB39HeQWJjztQ== '' , `` dev '' : true , `` requires '' : { `` @ types/glob '' : `` 5.0.30 '' , @ @ -413,7 +413,6 @ @ `` version '' : `` 1.0.10 '' , `` resolved '' : `` https
diff -- git a/tsconfig-google.json b/tsconfig-google.json index 2a9867a..0b47a8d 100644 -- - a/tsconfig-google.json +++ b/tsconfig-google.json @ @ -9,8 +9,6 @ @ `` noFallthroughCasesInSwitch '' : true , `` noEmitOnError '' : true , `` noImplicitReturns '' : true , - `` noUnusedLocals '' : true , - `` noUnusedParameters '' : true , `` pretty '' : true , `` strict '' : true , `` module '' : `` commonjs '' ,
diff -- git a/package.json b/package.json index 434c247..374e9f8 100644 -- - a/package.json +++ b/package.json @ @ -44,6 +44,7 @ @ `` read-package-json '' : `` ^2.0.10 '' , `` rimraf '' : `` ^2.6.1 '' , `` tslint '' : `` ^5.5.0 '' , + `` typescript '' : `` ^2.4.1 '' , `` update-notifier '' : `` ^2.2.0 '' , `` write-file-atomic '' : `` ^2.1.0 '' } , @ @ -63,11 +64,7 @ @ `` make-dir '' : `` ^1.0.0 '' , `` ncp '' : `` ^2.0.0 '' , `` source-map-support '' : `` ^0.4.15 '' , - `` tmp '' : `` 0.0.31 '' , - `` typescript '' : `` ^2.4.1 '' - } , - `` peerDependencies '' : { - `` typescript '' : `` ^2.4.1 '' + `` tmp '' : `` 0.0.31 '' } , `` ava '' : { `` require '' : [ diff -- git a/src/cli.ts b/src/cli.ts index e506fb1..4f13b8b 100644 -- - a/src/cli.ts +++ b/src/cli.ts @ @ -17,7 +17,6 @ @ import * as meow from 'meow ' ; import * as updateNotifier from 'update-notifier ' ; import { init } from './init ' ; -import { lint }
diff -- git a/src/format.ts b/src/format.ts index 386eeae..662e511 100644 -- - a/src/format.ts +++ b/src/format.ts @ @ -27,7 +27,7 @ @ const baseArgs = * @ param fix whether to automatically fix the format * @ param files files to format */ -export function format ( +export async function format ( options : Options , files : string [ ] = [ ] , fix = false ) : Promise < boolean > { const program = createProgram ( options ) ; const srcFiles = files.length > 0 ? @ @ -36,7 +36,16 @ @ export function format ( .map ( sourceFile = > sourceFile.fileName ) .filter ( f = > ! f.endsWith ( '.d.ts ' ) ) ; - return fix ? fixFormat ( srcFiles ) : checkFormat ( srcFiles ) ; + if ( fix ) { + return fixFormat ( srcFiles ) ; + } else { + const result = await checkFormat ( srcFiles ) ; + if ( ! result ) { + options.logger.error ( + 'clang-format reported errors ... run ` gts fix ` to address . ' ) ; + } + return result ; + } } /**
diff -- git a/package.json b/package.json index 0b32452..83675e2 100644 -- - a/package.json +++ b/package.json @ @ -26,7 +26,7 @ @ `` format-check '' : `` ./bin/format-check.sh '' , `` format '' : `` clang-format -i -style= ' { Language : JavaScript , BasedOnStyle : Google , ColumnLimit : 80 } ' src/*.ts test/*.ts '' , `` lint '' : `` tslint -c tslint.json -- project . -- type-check -t codeFrame '' , - `` lint-fix '' : `` tslint -c tslint.json -- project . -- type-check -t codeFrame -- fix '' , + `` lint-fix '' : `` tslint -c tslint.json -- project . -- type-check -t codeFrame -- fix '' , `` prepare '' : `` npm run compile '' , `` test '' : `` npm run compile & & nyc ava build/test/test*.js '' , `` posttest '' : `` npm run lint & & npm run format-check '' diff -- git a/src/format.ts b/src/format.ts index 386eeae..cb1a101 100644 -- - a/src/format.ts +++ b/src/format.ts @ @ -27,7 +27,7 @ @ const baseArgs = * @ param fix whether to automatically fix the format * @ param files files to format */ -export function format ( +export async function format ( options
diff -- git a/package.json b/package.json index 0fb439c..535529a 100644 -- - a/package.json +++ b/package.json @ @ -26,6 +26,7 @ @ `` format '' : `` clang-format -i -style= ' { Language : JavaScript , BasedOnStyle : Google , ColumnLimit : 80 } ' src/*.ts test/*.ts '' , `` lint '' : `` tslint -c tslint.json -- project . -- type-check -t codeFrame '' , `` lint-fix '' : `` tslint -c tslint.json -- project . -- type-check -t codeFrame -- fix '' , + `` prepublish '' : `` npm run compile '' , `` test '' : `` npm run compile & & ava build/test/test*.js '' , `` posttest '' : `` npm run lint & & npm run format-check '' } , diff -- git a/src/cli.ts b/src/cli.ts index 9683588..b80f45b 100644 -- - a/src/cli.ts +++ b/src/cli.ts @ @ -55,7 +55,7 @ @ const cli = meow ( ` Examples $ gts init -y - $ gts lint + $ gts check $ gts fix $ gts clean ` ) ; @ @ -81,8 +81,8 @ @ async function run ( verb : string ) : Promise < boolean > { if ( verb === 'init ' ) { return await
diff -- git a/libs/image/src/ImageDecoder.cpp b/libs/image/src/ImageDecoder.cpp index e445a4d..d90092b 100644 -- - a/libs/image/src/ImageDecoder.cpp +++ b/libs/image/src/ImageDecoder.cpp @ @ -496,7 +496,7 @ @ Image PSDDecoder : :decode ( ) { uint16_t depth ; uint16_t mode ; } ; - # pragma pop ( ) + # pragma pack ( pop ) static const uint16_t kColorModeRGB = 3 ; static const uint16_t kCompressionRAW = 0 ;
diff -- git a/build/windows/build.bat b/build/windows/build.bat index 957da9f..0ec71ec 100644 -- - a/build/windows/build.bat +++ b/build/windows/build.bat @ @ -23,6 +23,9 @ @ mkdir out\cmake-release cd out\cmake-release if errorlevel 1 exit /b % errorlevel % + : : Force Java JDK 8 . Kokoro machines default to 9 +SET JAVA_HOME=C : \Program Files\Java\jdk1.8.0_152 + cmake ..\.. -G Ninja ^ -DCMAKE_CXX_COMPILER : PATH= '' clang-cl.exe '' ^ -DCMAKE_C_COMPILER : PATH= '' clang-cl.exe '' ^
diff -- git a/samples/CMakeLists.txt b/samples/CMakeLists.txt index 7169074..9ca6805 100644 -- - a/samples/CMakeLists.txt +++ b/samples/CMakeLists.txt @ @ -143,6 +143,7 @ @ endfunction ( ) if ( NOT ANDROID ) add_assimp_demo ( frame_generator ) + add_assimp_demo ( gltf_viewer ) add_assimp_demo ( lightbulb ) add_assimp_demo ( material_sandbox ) add_assimp_demo ( sample_full_pbr ) diff -- git a/samples/app/MeshAssimp.cpp b/samples/app/MeshAssimp.cpp index c2ec772..14693c0 100644 -- - a/samples/app/MeshAssimp.cpp +++ b/samples/app/MeshAssimp.cpp @ @ -17,6 +17,7 @ @ # include `` MeshAssimp.h '' # include < string.h > + # include < array > # include < filament/Color.h > # include < filament/VertexBuffer.h > @ @ -29,12 +30,19 @ @ # include < filament/TransformManager.h > # include < math/norm.h > + # include < math/vec3.h > + # include < math/TVecHelpers.h > # include < assimp/Importer.hpp > # include < assimp/postprocess.h > # include < assimp/cimport.h > # include < assimp/scene.h > + # include < stb_image.h > + + # include < stdlib.h > + + using namespace filament ; using namespace filamat ; using namespace math ; @ @ -48,7 +56,107 @ @ static constexpr uint8_t DEFAULT_TRANSPARENT_PACKAGE [ ] = { # include `` generated/material/aiDefaultTrans.inc '' } ; +static constexpr uint8_t GLTF2_PACKAGE [ ] = { + # include
diff -- git a/filament/include/filament/VertexBuffer.h b/filament/include/filament/VertexBuffer.h index 96d9a7e..1c7093f 100644 -- - a/filament/include/filament/VertexBuffer.h +++ b/filament/include/filament/VertexBuffer.h @ @ -33,6 +33,9 @ @ class FVertexBuffer ; class Engine ; +/** + * Holds a set of buffers that define the geometry of a Renderable . + */ class UTILS_PUBLIC VertexBuffer : public FilamentAPI { struct BuilderDetails ; @ @ -88,14 +91,62 @ @ public : } ; } ; - // Return the vertex count + /** + * Returns the vertex count . + */ size_t getVertexCount ( ) const noexcept ; - // noop if bufferIndex > = bufferCount + /** + * Moves the given buffer data into the slot at the given index . + * + * Does nothing if bufferIndex > = bufferCount . + */ void setBufferAt ( Engine & engine , uint8_t bufferIndex , BufferDescriptor & & buffer , uint32_t byteOffset = 0 , uint32_t byteSize = 0 ) ; + + /** + * Specifies the quaternion type for the `` populateTangentQuaternions '' utility . + */ + enum QuatType { + HALF4 , // 2 bytes per component as half-floats ( 8 bytes per quat ) + SHORT4 , // 2 bytes per component
diff -- git a/filament/src/driver/vulkan/VulkanBuffer.cpp b/filament/src/driver/vulkan/VulkanBuffer.cpp index da6a253..a995e74 100644 -- - a/filament/src/driver/vulkan/VulkanBuffer.cpp +++ b/filament/src/driver/vulkan/VulkanBuffer.cpp @ @ -48,6 +48,7 @ @ void VulkanBuffer : :loadFromCpu ( const void* cpuData , uint32_t byteOffset , uint32_ vmaMapMemory ( mContext.allocator , stage- > memory , & mapped ) ; memcpy ( mapped , cpuData , numBytes ) ; vmaUnmapMemory ( mContext.allocator , stage- > memory ) ; + vmaFlushAllocation ( mContext.allocator , stage- > memory , byteOffset , numBytes ) ; // Create and submit a one-off command buffer to allow uploading outside a frame . VkCommandBuffer cmdbuffer ; diff -- git a/filament/src/driver/vulkan/VulkanDriverImpl.cpp b/filament/src/driver/vulkan/VulkanDriverImpl.cpp index f94844e..688f581 100644 -- - a/filament/src/driver/vulkan/VulkanDriverImpl.cpp +++ b/filament/src/driver/vulkan/VulkanDriverImpl.cpp @ @ -21,7 +21,9 @ @ # pragma clang diagnostic ignored `` -Wundef '' # pragma clang diagnostic ignored `` -Wunused-variable '' # pragma clang diagnostic ignored `` -Wmissing-field-initializers '' + # pragma clang diagnostic ignored `` -Wtautological-compare '' # define VMA_IMPLEMENTATION + # include < cstdio > # include `` vk_mem_alloc.h '' # pragma clang diagnostic pop diff -- git a/filament/src/driver/vulkan/VulkanHandles.cpp b/filament/src/driver/vulkan/VulkanHandles.cpp index 8dbd3c2..857d271 100644 -- - a/filament/src/driver/vulkan/VulkanHandles.cpp +++ b/filament/src/driver/vulkan/VulkanHandles.cpp @ @ -343,6 +343,7 @ @ void VulkanUniformBuffer : :loadFromCpu ( const void* cpuData , uint32_t numBytes ) { vmaMapMemory ( mContext.allocator
diff -- git a/filament/include/filament/driver/ExternalContext.h b/filament/include/filament/driver/ExternalContext.h index f3d7edf..8ffab64 100644 -- - a/filament/include/filament/driver/ExternalContext.h +++ b/filament/include/filament/driver/ExternalContext.h @ @ -70,6 +70,8 @ @ public : // swap draw buffers ( i.e . for double-buffered rendering ) . virtual void commit ( SwapChain* swapChain ) noexcept = 0 ; + virtual void setPresentationTime ( long time ) noexcept = 0 ; + virtual bool canCreateFence ( ) noexcept { return false ; } virtual Fence* createFence ( ) noexcept = 0 ; virtual void destroyFence ( Fence* fence ) noexcept = 0 ; diff -- git a/filament/src/driver/opengl/ContextManagerCocoa.h b/filament/src/driver/opengl/ContextManagerCocoa.h index a28bc17..5703de2 100644 -- - a/filament/src/driver/opengl/ContextManagerCocoa.h +++ b/filament/src/driver/opengl/ContextManagerCocoa.h @ @ -45,6 +45,8 @ @ public : return driver : :FenceStatus : :ERROR ; } + void setPresentationTime ( long time ) noexcept final override { } + Stream* createStream ( void* nativeStream ) noexcept final { return nullptr ; } void destroyStream ( Stream* stream ) noexcept final { } void attach ( Stream* stream , intptr_t tname ) noexcept final { } diff -- git a/filament/src/driver/opengl/ContextManagerEGL.cpp b/filament/src/driver/opengl/ContextManagerEGL.cpp index 400e0ad..40d422e 100644 -- - a/filament/src/driver/opengl/ContextManagerEGL.cpp +++ b/filament/src/driver/opengl/ContextManagerEGL.cpp @ @ -63,6 +63,9 @ @ using namespace utils ; namespace filament { using namespace driver ; +using PFNEGLGETNATIVECLIENTBUFFERANDROIDPROC = +
diff -- git a/filament/include/filament/driver/ExternalContext.h b/filament/include/filament/driver/ExternalContext.h index f3d7edf..8ffab64 100644 -- - a/filament/include/filament/driver/ExternalContext.h +++ b/filament/include/filament/driver/ExternalContext.h @ @ -70,6 +70,8 @ @ public : // swap draw buffers ( i.e . for double-buffered rendering ) . virtual void commit ( SwapChain* swapChain ) noexcept = 0 ; + virtual void setPresentationTime ( long time ) noexcept = 0 ; + virtual bool canCreateFence ( ) noexcept { return false ; } virtual Fence* createFence ( ) noexcept = 0 ; virtual void destroyFence ( Fence* fence ) noexcept = 0 ; diff -- git a/filament/src/driver/opengl/ContextManagerCocoa.h b/filament/src/driver/opengl/ContextManagerCocoa.h index a28bc17..5703de2 100644 -- - a/filament/src/driver/opengl/ContextManagerCocoa.h +++ b/filament/src/driver/opengl/ContextManagerCocoa.h @ @ -45,6 +45,8 @ @ public : return driver : :FenceStatus : :ERROR ; } + void setPresentationTime ( long time ) noexcept final override { } + Stream* createStream ( void* nativeStream ) noexcept final { return nullptr ; } void destroyStream ( Stream* stream ) noexcept final { } void attach ( Stream* stream , intptr_t tname ) noexcept final { } diff -- git a/filament/src/driver/opengl/ContextManagerEGL.cpp b/filament/src/driver/opengl/ContextManagerEGL.cpp index 400e0ad..c747e2f 100644 -- - a/filament/src/driver/opengl/ContextManagerEGL.cpp +++ b/filament/src/driver/opengl/ContextManagerEGL.cpp @ @ -63,6 +63,9 @ @ using namespace utils ; namespace filament { using namespace driver ; +using PFNEGLGETNATIVECLIENTBUFFERANDROIDPROC = +
diff -- git a/bintray.gradle b/bintray.gradle index 05700a4..6c2ac54 100644 -- - a/bintray.gradle +++ b/bintray.gradle @ @ -23,6 +23,10 @ @ task sourcesJar ( type : Jar ) { task javadoc ( type : Javadoc ) { source = android.sourceSets.main.java.srcDirs classpath += project.files ( android.getBootClasspath ( ) .join ( File.pathSeparator ) ) + // Exclude classes with `` Internal '' in the name from generated Javadoc , as these are obfuscated + // and not part of the Volley API . + exclude 'com/android/volley/internal/**' + } task javadocJar ( type : Jar , dependsOn : javadoc ) { @ @ -45,8 +49,9 @ @ publishing { packaging 'aar' } - // Release AAR , Sources , and JavaDoc + // Release AAR , sources , javadoc , and proguard mapping artifact `` $ buildDir/outputs/aar/volley-release.aar '' + artifact `` $ buildDir/outputs/mapping/release/mapping.txt '' artifact sourcesJar artifact javadocJar } diff -- git a/proguard-rules.pro b/proguard-rules.pro new file mode 100644 index 0000000..a486c96 -- - /dev/null +++ b/proguard-rules.pro @ @ -0,0 +1,9 @ @ +-keepparameternames +-renamesourcefileattribute SourceFile +-keepattributes Exceptions , InnerClasses , Signature , Deprecated , SourceFile , LineNumberTable , *Annotation* , EnclosingMethod + + # Keep all public/protected classes/methods/fields , except for classes in the internal package
diff -- git a/Gruntfile.js b/Gruntfile.js new file mode 100644 index 0000000..a707433 -- - /dev/null +++ b/Gruntfile.js @ @ -0,0 +1,161 @ @ +/** + * google-code-prettify + * https : //github.com/google/code-prettify + * + * Copyright ( C ) 2017 Google Inc. + * Licensed under Apache 2.0 license . + */ + +module.exports = function ( grunt ) { + 'use strict ' ; + + // project configuration + grunt.initConfig ( { + // metadata + pkg : grunt.file.readJSON ( 'package.json ' ) , + + // grunt-preprocess + preprocess : { + // https : //github.com/jsoverson/preprocess # optionstype + options : { + // renders @ include directives ( similar to SSI server-side includes ) + // where JS files are resolved relative to this directory + srcDir : 'js-modules ' , + type : 'js' + } , + prettify : { + src : 'js-modules/prettify.js ' , + dest : 'src/prettify.js' + } , + runprettify : { + options : { + context : { + // to control where defs.js is included ( top level ) + RUN_PRETTIFY : true + } + } , + src : 'js-modules/run_prettify.js ' , + dest
diff -- git a/Gruntfile.js b/Gruntfile.js new file mode 100644 index 0000000..7993abc -- - /dev/null +++ b/Gruntfile.js @ @ -0,0 +1,189 @ @ +/** + * google-code-prettify + * https : //github.com/google/code-prettify + * + * Copyright ( C ) 2017 Google Inc. + * Licensed under Apache 2.0 license . + */ + +module.exports = function ( grunt ) { + 'use strict ' ; + + // project configuration + grunt.initConfig ( { + // metadata + pkg : grunt.file.readJSON ( 'package.json ' ) , + + // grunt-preprocess + preprocess : { + // https : //github.com/jsoverson/preprocess # optionstype + options : { + // renders @ include directives ( similar to SSI server-side includes ) + // where JS files are resolved relative to this directory + srcDir : 'js-modules ' , + type : 'js' + } , + prettify : { + src : 'js-modules/prettify.js ' , + dest : 'src/prettify.js' + } , + runprettify : { + options : { + context : { + // to control where defs.js is included ( top level ) + RUN_PRETTIFY : true + } + } , + src : 'js-modules/run_prettify.js ' , + dest
diff -- git a/scoreboard/models.py b/scoreboard/models.py index 0171bc5..6764801 100644 -- - a/scoreboard/models.py +++ b/scoreboard/models.py @ @ -151,6 +151,9 @ @ class User ( db.Model ) : def promote ( self ) : `` '' '' Promote a user to admin . '' '' '' empty_team = self.team and set ( self.team.players.all ( ) ) == set ( [ self ] ) + if self.team and len ( self.team.answers ) : + raise AssertionError ( + ' Can not promote player whose team has solved answers ! ' ) self.admin = True team = self.team self.team = None diff -- git a/scoreboard/rest.py b/scoreboard/rest.py index 90cb3bf..c8f858c 100644 -- - a/scoreboard/rest.py +++ b/scoreboard/rest.py @ @ -110,21 +110,23 @ @ class User ( flask_restful.Resource ) : @ flask_restful.marshal_with ( resource_fields ) def get ( self , user_id ) : - if not models.User.current ( ) .uid == user_id and not models.User.current ( ) .admin : + if not flask.g.uid == user_id and not flask.g.admin : raise errors.AccessDeniedError ( 'No access to that user . ' ) return models.User.query.get_or_404 ( user_id ) @ flask_restful.marshal_with ( resource_fields ) def put ( self , user_id ) : - if not models.User.current ( ) .uid == user_id and not
diff -- git a/scoreboard/tests/base.py b/scoreboard/tests/base.py index fe3e945..86deae5 100644 -- - a/scoreboard/tests/base.py +++ b/scoreboard/tests/base.py @ @ -14,6 +14,8 @ @ `` '' '' Base test module , MUST be imported first . '' '' '' +import contextlib +import functools import json import logging import os.path @ @ -87,6 +89,20 @ @ class RestTestCase ( BaseTestCase ) : super ( RestTestCase , self ) .tearDown ( ) pbkdf2.crypt = self._orig_pbkdf2 + def postJSON ( self , path , data , client=None ) : + client = client or self.client + return client.post ( + path , data=json.dumps ( data ) , + content_type='application/json ' ) + + @ contextlib.contextmanager + def swapClient ( self , client ) : + old_client = self.client + self.client = client + yield + self.client = old_client + + @ staticmethod def _pbkdf2_dummy ( value , *unused_args ) : return value @ @ -169,6 +185,24 @ @ class MaxQueryBlock ( object ) : logging.debug ( 'SQLAlchemy : % s ' , statement ) +def authenticated_test ( f ) : + `` '' '' Swaps out the client for an authenticated client . '' '' '' + @ functools.wraps ( f ) + def wrapped_test ( self )
diff -- git a/main.py b/main.py index cbf8140..abd4994 100644 -- - a/main.py +++ b/main.py @ @ -14,19 +14,25 @ @ import sys -from scoreboard import wsgi -if __name__ == '__main__ ' : - if 'createdb ' in sys.argv : - from scoreboard import models +def main ( argv ) : + if argv [ 1 ] == 'runtests ' : + from scoreboard.tests import base + base.run_all_tests ( ) + return + + # This needs to only be imported when not testing + from scoreboard import wsgi + from scoreboard import models + if 'createdb ' in argv : models.db.create_all ( ) - elif 'createdata ' in sys.argv : - from scoreboard import models + elif 'createdata ' in argv : from scoreboard.tests import data models.db.create_all ( ) data.create_all ( ) - elif 'runtests ' in sys.argv : - from scoreboard.tests import base - base.run_all_tests ( ) else : wsgi.app.run ( host='0.0.0.0 ' , debug=True , port=wsgi.app.config.get ( 'PORT ' , 9999 ) ) + + +if __name__ == '__main__ ' : + main ( sys.argv ) diff -- git a/scoreboard/config_defaults.py b/scoreboard/config_defaults.py index 4ff3a7a..267d985 100644 -- - a/scoreboard/config_defaults.py +++ b/scoreboard/config_defaults.py @ @ -37,6 +37,7 @ @ class Defaults ( object
diff -- git a/scoreboard/models.py b/scoreboard/models.py index 0171bc5..6764801 100644 -- - a/scoreboard/models.py +++ b/scoreboard/models.py @ @ -151,6 +151,9 @ @ class User ( db.Model ) : def promote ( self ) : `` '' '' Promote a user to admin . '' '' '' empty_team = self.team and set ( self.team.players.all ( ) ) == set ( [ self ] ) + if self.team and len ( self.team.answers ) : + raise AssertionError ( + ' Can not promote player whose team has solved answers ! ' ) self.admin = True team = self.team self.team = None diff -- git a/scoreboard/rest.py b/scoreboard/rest.py index 90cb3bf..c8f858c 100644 -- - a/scoreboard/rest.py +++ b/scoreboard/rest.py @ @ -110,21 +110,23 @ @ class User ( flask_restful.Resource ) : @ flask_restful.marshal_with ( resource_fields ) def get ( self , user_id ) : - if not models.User.current ( ) .uid == user_id and not models.User.current ( ) .admin : + if not flask.g.uid == user_id and not flask.g.admin : raise errors.AccessDeniedError ( 'No access to that user . ' ) return models.User.query.get_or_404 ( user_id ) @ flask_restful.marshal_with ( resource_fields ) def put ( self , user_id ) : - if not models.User.current ( ) .uid == user_id and not
diff -- git a/main.py b/main.py index cbf8140..abd4994 100644 -- - a/main.py +++ b/main.py @ @ -14,19 +14,25 @ @ import sys -from scoreboard import wsgi -if __name__ == '__main__ ' : - if 'createdb ' in sys.argv : - from scoreboard import models +def main ( argv ) : + if argv [ 1 ] == 'runtests ' : + from scoreboard.tests import base + base.run_all_tests ( ) + return + + # This needs to only be imported when not testing + from scoreboard import wsgi + from scoreboard import models + if 'createdb ' in argv : models.db.create_all ( ) - elif 'createdata ' in sys.argv : - from scoreboard import models + elif 'createdata ' in argv : from scoreboard.tests import data models.db.create_all ( ) data.create_all ( ) - elif 'runtests ' in sys.argv : - from scoreboard.tests import base - base.run_all_tests ( ) else : wsgi.app.run ( host='0.0.0.0 ' , debug=True , port=wsgi.app.config.get ( 'PORT ' , 9999 ) ) + + +if __name__ == '__main__ ' : + main ( sys.argv ) diff -- git a/scoreboard/config_defaults.py b/scoreboard/config_defaults.py index 4ff3a7a..267d985 100644 -- - a/scoreboard/config_defaults.py +++ b/scoreboard/config_defaults.py @ @ -37,6 +37,7 @ @ class Defaults ( object
diff -- git a/scoreboard/models.py b/scoreboard/models.py index 0171bc5..30df5fd 100644 -- - a/scoreboard/models.py +++ b/scoreboard/models.py @ @ -399,8 +399,6 @ @ class Challenge ( db.Model ) : cat_slug = db.Column ( db.String ( 100 ) , db.ForeignKey ( 'category.slug ' ) ) answers = db.relationship ( 'Answer ' , backref=db.backref ( 'challenge ' , lazy='joined ' ) , lazy='select ' ) - attachments = db.relationship ( 'Attachment ' , backref='challenge ' , - lazy='joined ' ) def __repr__ ( self ) : return ' < Challenge : % d/ % s > ' % ( self.cid , self.name ) @ @ -507,11 +505,12 @ @ class Challenge ( db.Model ) : aid_set.add ( a [ 'aid ' ] ) attachment = Attachment.query.get ( a [ 'aid ' ] ) if not attachment : - Attachment.create ( a [ 'aid ' ] , a [ 'filename ' ] , a [ 'content_type ' ] , self ) + logging.warning ( 'Trying to add attachment that does not exist ' ) + self.attachments.append ( attachment ) for a in old_attachments : if a.aid not in aid_set : - a.delete ( ) + self.attachments.remove ( a ) def set_prerequisite ( self , prerequisite ) :
diff -- git a/scoreboard/main.py b/scoreboard/main.py index 64ed419..4156511 100644 -- - a/scoreboard/main.py +++ b/scoreboard/main.py @ @ -85,17 +85,18 @ @ def setup_logging ( app ) : logging.getLogger ( ) .handlers [ 0 ] .setFormatter ( log_formatter ) # Install a default error handler - error_titles = { - 401 : 'Unauthorized ' , - 403 : 'Forbidden ' , - 500 : 'Internal Error ' , - } return app def api_error_handler ( ex ) : `` '' '' Handle errors as appropriate depending on path . '' '' '' + + error_titles = { + 401 : 'Unauthorized ' , + 403 : 'Forbidden ' , + 500 : 'Internal Error ' , + } try : status_code = ex.code except AttributeError : diff -- git a/scoreboard/models.py b/scoreboard/models.py index 0171bc5..30df5fd 100644 -- - a/scoreboard/models.py +++ b/scoreboard/models.py @ @ -399,8 +399,6 @ @ class Challenge ( db.Model ) : cat_slug = db.Column ( db.String ( 100 ) , db.ForeignKey ( 'category.slug ' ) ) answers = db.relationship ( 'Answer ' , backref=db.backref ( 'challenge ' , lazy='joined ' ) , lazy='select ' ) - attachments = db.relationship ( 'Attachment ' , backref='challenge ' , - lazy='joined ' ) def __repr__ (
diff -- git a/scoreboard/config_defaults.py b/scoreboard/config_defaults.py index 6a126fd..d2e423e 100644 -- - a/scoreboard/config_defaults.py +++ b/scoreboard/config_defaults.py @ @ -25,6 +25,7 @ @ class Defaults ( object ) : ERROR_404_HELP = False FIRST_BLOOD = 0 GAME_TIME = ( None , None ) + INVITE_KEY = None LOGIN_METHOD = 'local' MAIL_FROM = 'ctf @ scoreboard' MAIL_FROM_NAME = None diff -- git a/scoreboard/rest.py b/scoreboard/rest.py index bf43321..56a90d3 100644 -- - a/scoreboard/rest.py +++ b/scoreboard/rest.py @ @ -163,9 +163,14 @ @ class UserList ( flask_restful.Resource ) : data = flask.request.get_json ( ) if not data.get ( 'nick ' , `` ) : raise errors.ValidationError ( 'Need a player nick . ' ) - if ( app.config.get ( 'TEAMS ' ) and not data.get ( 'team_name ' , `` ) and not - data.get ( 'team_id ' , 0 ) ) : + if ( app.config.get ( 'TEAMS ' ) and + not data.get ( 'team_name ' , `` ) and + not data.get ( 'team_id ' , 0 ) ) : raise errors.ValidationError ( 'Need a team name . ' ) + if ( app.config.get ( 'INVITE_KEY ' ) and + data.get ( 'invite_key ' , `` ) .strip ( ) ! = + app.config.get ( 'INVITE_KEY ' )
diff -- git a/README.md b/README.md index 233ed91..4afab24 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,24 @ @ -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . +**Warning : ** this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . # GraphicsFuzz [ ! [ License ] ( https : //img.shields.io/badge/License-Apache % 202.0-blue.svg ) ] ( https : //opensource.org/licenses/Apache-2.0 ) + # # # GraphicsFuzz is a testing framework for automatically finding and simplifying bugs in GLSL and SPIR-V shader compilers . - # # Introduction +**NB : ** the ** [ GLSL reducer ] ( docs/reduce.md ) ** is available as a stand-alone tool . -GraphicsFuzz is a testing framework for automatically finding and simplifying bugs in graphics shader compilers . Our tools currently manipulate GLSL shaders , but we can indirectly test other targets such as SPIR-V , HLSL and Metal . Our current priority is testing Vulkan drivers . +* [ Introduction : why and how to test shader
diff -- git a/README.md b/README.md index 233ed91..d4472dd 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,43 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . - # GraphicsFuzz [ ! [ License ] ( https : //img.shields.io/badge/License-Apache % 202.0-blue.svg ) ] ( https : //opensource.org/licenses/Apache-2.0 ) + # # GraphicsFuzz is a testing framework for shader compilers - # # Introduction - -GraphicsFuzz is a testing framework for automatically finding and simplifying bugs in graphics shader compilers . Our tools currently manipulate GLSL shaders , but we can indirectly test other targets such as SPIR-V , HLSL and Metal . Our current priority is testing Vulkan drivers . - -* [ Getting started ] ( docs/getting_started.md ) -* [ Developer getting started ] ( docs/development.md ) -* [ Contributing ( requires Google CLA ) ] ( CONTRIBUTING.md ) -* [ License ( Apache 2.0 ) ] ( LICENSE ) - - # # The problem - -A graphics driver takes a *shader program* as input and executes it on a GPU ( graphics processing unit )
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..052d15a 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,55 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..f1003b0 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,59 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/README.md b/README.md index 233ed91..d4472dd 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,43 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . - # GraphicsFuzz [ ! [ License ] ( https : //img.shields.io/badge/License-Apache % 202.0-blue.svg ) ] ( https : //opensource.org/licenses/Apache-2.0 ) + # # GraphicsFuzz is a testing framework for shader compilers - # # Introduction - -GraphicsFuzz is a testing framework for automatically finding and simplifying bugs in graphics shader compilers . Our tools currently manipulate GLSL shaders , but we can indirectly test other targets such as SPIR-V , HLSL and Metal . Our current priority is testing Vulkan drivers . - -* [ Getting started ] ( docs/getting_started.md ) -* [ Developer getting started ] ( docs/development.md ) -* [ Contributing ( requires Google CLA ) ] ( CONTRIBUTING.md ) -* [ License ( Apache 2.0 ) ] ( LICENSE ) - - # # The problem - -A graphics driver takes a *shader program* as input and executes it on a GPU ( graphics processing unit )
diff -- git a/README.md b/README.md index 233ed91..d4472dd 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,43 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not an officially supported Google product . - # GraphicsFuzz [ ! [ License ] ( https : //img.shields.io/badge/License-Apache % 202.0-blue.svg ) ] ( https : //opensource.org/licenses/Apache-2.0 ) + # # GraphicsFuzz is a testing framework for shader compilers - # # Introduction - -GraphicsFuzz is a testing framework for automatically finding and simplifying bugs in graphics shader compilers . Our tools currently manipulate GLSL shaders , but we can indirectly test other targets such as SPIR-V , HLSL and Metal . Our current priority is testing Vulkan drivers . - -* [ Getting started ] ( docs/getting_started.md ) -* [ Developer getting started ] ( docs/development.md ) -* [ Contributing ( requires Google CLA ) ] ( CONTRIBUTING.md ) -* [ License ( Apache 2.0 ) ] ( LICENSE ) - - # # The problem - -A graphics driver takes a *shader program* as input and executes it on a GPU ( graphics processing unit )
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..0baaa81 100644 -- - a/README.md +++ b/README.md @ @ -1,91 +1,59 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/.idea/codeStyles/Project.xml b/.idea/codeStyles/Project.xml index 5717df9..d4eeeb8 100644 -- - a/.idea/codeStyles/Project.xml +++ b/.idea/codeStyles/Project.xml @ @ -1,7 +1,6 @ @ < component name= '' ProjectCodeStyleConfiguration '' > < code_scheme name= '' Project '' version= '' 173 '' > < option name= '' RIGHT_MARGIN '' value= '' 100 '' / > - < option name= '' WRAP_WHEN_TYPING_REACHES_RIGHT_MARGIN '' value= '' true '' / > < JavaCodeStyleSettings > < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 1000 '' / > @ @ -20,6 +19,7 @ @ < option name= '' ENABLED '' value= '' false '' / > < /editorconfig > < codeStyleSettings language= '' JAVA '' > + < option name= '' BINARY_OPERATION_SIGN_ON_NEXT_LINE '' value= '' true '' / > < option name= '' WRAP_LONG_LINES '' value= '' true '' / > < option name= '' WRAP_ON_TYPING '' value= '' 1 '' / > < indentOptions > diff -- git a/README.md b/README.md index 233ed91..9893ae7 100644 -- - a/README.md +++ b/README.md @ @ -1,65 +1,46 @ @ - -Warning : this repository is a work-in-progress . Things may break while we transition this project to open source . This is not
diff -- git a/ko/build/gobuild_test.go b/ko/build/gobuild_test.go index 6e486a4..dfd39fb 100644 -- - a/ko/build/gobuild_test.go +++ b/ko/build/gobuild_test.go @ @ -201,7 +201,7 @ @ func TestGoBuild ( t *testing.T ) { t.Run ( `` check determinism '' , func ( t *testing.T ) { expectedHash : = v1.Hash { Algorithm : `` sha256 '' , - Hex : `` 7f4dbad13dfe30c580152f62973627701b72d62654b7c0c62249891f82b80a59 '' , + Hex : `` 118e77d59f3b68ad30e76ed9a4e1af9842ede1396f15daca2d7c249402d32acd '' , } appLayer : = ls [ baseLayers ] diff -- git a/v1/tarball/layer_test.go b/v1/tarball/layer_test.go index ecd9471..fdcc880 100644 -- - a/v1/tarball/layer_test.go +++ b/v1/tarball/layer_test.go @ @ -193,7 +193,7 @ @ func assertSizesAreEqual ( t *testing.T , a , b v1.Layer ) { // Compression settings matter in order for the digest , size , // compressed assertions to pass // -// Since our v1util.GzipReadCloser uses gzip.BestCompression +// Since our v1util.GzipReadCloser uses gzip.DefaultCompression // we need our fixture to use the same - bazel 's pkg_tar doesn't // seem to let you control compression settings func setupFixtures ( t *testing.T ) { @ @ -213,7 +213,7 @ @ func setupFixtures ( t *testing.T ) { defer out.Close ( ) - gw , _ : = gzip.NewWriterLevel ( out , gzip.BestCompression ) + gw , _ : = gzip.NewWriterLevel ( out
diff -- git a/v1/BUILD.bazel b/v1/BUILD.bazel index 6840f01..9877a0b 100644 -- - a/v1/BUILD.bazel +++ b/v1/BUILD.bazel @ @ -7,6 +7,7 @ @ go_library ( `` doc.go '' , `` hash.go '' , `` image.go '' , + `` layer.go '' , `` manifest.go '' , ] , importpath = `` github.com/google/go-containerregistry/v1 '' , diff -- git a/v1/image.go b/v1/image.go index 18bbff6..9f7381c 100644 -- - a/v1/image.go +++ b/v1/image.go @ @ -15,38 +15,23 @ @ package v1 import ( - '' io '' - '' github.com/google/go-containerregistry/v1/types '' ) // Image defines the interface for interacting with an OCI v1 image . type Image interface { - // FSLayers returns the ordered collection of filesystem layers that comprise this image . - // The order of the list is most-recent first , and oldest base layer last . - FSLayers ( ) ( [ ] Hash , error ) - - // DiffIDs returns the ordered list of uncompressed layer hashes ( matches FSLayers ) . + // Layers returns the ordered collection of filesystem layers that comprise this image . // The order of the list is most-recent first , and oldest base layer last . - DiffIDs ( ) ( [ ] Hash , error
diff -- git a/name/registry.go b/name/registry.go index 6bca9f9..7618b3f 100644 -- - a/name/registry.go +++ b/name/registry.go @ @ -16,7 +16,7 @ @ package name import `` net/url '' -const defaultRegistry = `` index.docker.io '' +const DefaultRegistry = `` index.docker.io '' // Registry stores a docker registry name in a structured form . type Registry struct { @ @ -28,7 +28,7 @ @ func ( r Registry ) RegistryStr ( ) string { if r.registry ! = `` '' { return r.registry } - return defaultRegistry + return DefaultRegistry } // Name returns the name from which the Registry was derived . diff -- git a/name/repository.go b/name/repository.go index 3f8f589..7c296e3 100644 -- - a/name/repository.go +++ b/name/repository.go @ @ -33,7 +33,7 @ @ type Repository struct { // See https : //docs.docker.com/docker-hub/official_repos func hasImplicitNamespace ( repo string , reg Registry ) bool { - return ! strings.ContainsRune ( repo , '/ ' ) & & reg.RegistryStr ( ) == defaultRegistry + return ! strings.ContainsRune ( repo , '/ ' ) & & reg.RegistryStr ( ) == DefaultRegistry } // RepositoryStr returns the repository component of the Repository . diff -- git a/v1/remote/image.go b/v1/remote/image.go index d27e6c5..b07d398 100644 -- - a/v1/remote/image.go +++ b/v1/remote/image.go @ @ -19,6 +19,7 @
diff -- git a/BUILD.bazel b/BUILD.bazel deleted file mode 100644 index bb5c106..0000000 -- - a/BUILD.bazel +++ /dev/null @ @ -1,16 +0,0 @ @ -load ( `` @ bazel_gazelle// : def.bzl '' , `` gazelle '' ) - -licenses ( [ `` notice '' ] ) # Apache 2.0 - -exports_files ( [ `` LICENSE '' ] ) - -gazelle ( - name = `` gazelle '' , - command = `` fix '' , - external = `` vendored '' , - extra_args = [ - `` -build_file_name '' , - `` BUILD.bazel , BUILD '' , # Prioritize ` BUILD.bazel ` for newly added files . - ] , - prefix = `` github.com/google/go-containerregistry '' , - ) diff -- git a/cmd/crane/BUILD.bazel b/cmd/crane/BUILD.bazel deleted file mode 100644 index a758e3a..0000000 -- - a/cmd/crane/BUILD.bazel +++ /dev/null @ @ -1,18 +0,0 @ @ -load ( `` @ io_bazel_rules_go//go : def.bzl '' , `` go_binary '' , `` go_library '' ) - -go_library ( - name = `` go_default_library '' , - srcs = [ - `` main.go '' , - ] , - importpath = `` github.com/google/go-containerregistry/cmd/crane '' , - visibility = [ `` //visibility : private '' ] , - deps =
diff -- git a/.bazelrc b/.bazelrc new file mode 100644 index 0000000..68e9acc -- - /dev/null +++ b/.bazelrc @ @ -0,0 +1,15 @ @ +build -- deleted_packages=\ +vendor/k8s.io/code-generator/cmd/deepcopy-gen , \ +vendor/k8s.io/code-generator/cmd/deepcopy-gen/args , \ +vendor/k8s.io/code-generator/pkg/util , \ +vendor/k8s.io/gengo/args , \ +vendor/k8s.io/gengo/examples/deepcopy-gen/generators , \ +vendor/k8s.io/gengo/examples/deepcopy-gen/generators/args + +test -- test_output=errors \ + -- deleted_packages=\ +vendor/k8s.io/code-generator/cmd/deepcopy-gen , \ +vendor/k8s.io/code-generator/cmd/deepcopy-gen/args , \ +vendor/k8s.io/code-generator/pkg/util , \ +vendor/k8s.io/gengo/args , \ +vendor/k8s.io/gengo/examples/deepcopy-gen/generators , \ diff -- git a/.gitattributes b/.gitattributes new file mode 100644 index 0000000..e303040 -- - /dev/null +++ b/.gitattributes @ @ -0,0 +1,5 @ @ + # This file is documented at https : //git-scm.com/docs/gitattributes . + # Linguist-specific attributes are documented at + # https : //github.com/github/linguist . + +**/zz_generated_*.go linguist-generated=true diff -- git a/.travis.yml b/.travis.yml index 762bf22..5d768ec 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -8,7 +8,7 @ @ language : before_install : # Bazel requires JDK8 - sudo apt-get install oracle-java8-installer - + install : - go get -u github.com/bazelbuild/buildifier/buildifier @ @ -24,9 +24,9 @ @ addons : - bazel script : - - bazel clean & & bazel build //v1/ ... //name/ ... //authn/ ... //cmd/ ... - - bazel clean & & bazel test -- test_output=errors //v1/ ... //name/ ... //authn/ ... //cmd/ ...
diff -- git a/Gopkg.lock b/Gopkg.lock index c0fa96f..32d5852 100644 -- - a/Gopkg.lock +++ b/Gopkg.lock @ @ -65,6 +65,7 @ @ name = `` github.com/google/go-cmp '' packages = [ `` cmp '' , + `` cmp/cmpopts '' , `` cmp/internal/diff '' , `` cmp/internal/function '' , `` cmp/internal/value '' @ @ -118,6 +119,12 @ @ revision = `` 94b14834a20132093826ea5e2da5502a13908ad3 '' [ [ projects ] ] + name = `` gopkg.in/yaml.v2 '' + packages = [ `` . '' ] + revision = `` 5420a8b6744d3b0345ab293f6fcba19c978f1183 '' + version = `` v2.2.1 '' + + [ [ projects ] ] name = `` k8s.io/code-generator '' packages = [ `` cmd/deepcopy-gen '' , @ @ -144,6 +151,6 @ @ [ solve-meta ] analyzer-name = `` dep '' analyzer-version = 1 - inputs-digest = `` 954de238cd4402db836aa6ca162d813309f1e477cebb52979829fa6cd9144eb1 '' + inputs-digest = `` 89d88798457456ac32dc8bd7d8162c450168fc9ed5d2c840d4e9648931a4e6fa '' solver-name = `` gps-cdcl '' solver-version = 1 diff -- git a/ko/BUILD.bazel b/ko/BUILD.bazel new file mode 100644 index 0000000..8b77fd2 -- - /dev/null +++ b/ko/BUILD.bazel @ @ -0,0 +1,8 @ @ +load ( `` @ io_bazel_rules_go//go : def.bzl '' , `` go_library '' ) + +go_library ( + name = `` go_default_library '' , + srcs = [ `` doc.go '' ] , +
diff -- git a/.bazelrc b/.bazelrc new file mode 100644 index 0000000..68e9acc -- - /dev/null +++ b/.bazelrc @ @ -0,0 +1,15 @ @ +build -- deleted_packages=\ +vendor/k8s.io/code-generator/cmd/deepcopy-gen , \ +vendor/k8s.io/code-generator/cmd/deepcopy-gen/args , \ +vendor/k8s.io/code-generator/pkg/util , \ +vendor/k8s.io/gengo/args , \ +vendor/k8s.io/gengo/examples/deepcopy-gen/generators , \ +vendor/k8s.io/gengo/examples/deepcopy-gen/generators/args + +test -- test_output=errors \ + -- deleted_packages=\ +vendor/k8s.io/code-generator/cmd/deepcopy-gen , \ +vendor/k8s.io/code-generator/cmd/deepcopy-gen/args , \ +vendor/k8s.io/code-generator/pkg/util , \ +vendor/k8s.io/gengo/args , \ +vendor/k8s.io/gengo/examples/deepcopy-gen/generators , \ diff -- git a/.gitattributes b/.gitattributes new file mode 100644 index 0000000..e303040 -- - /dev/null +++ b/.gitattributes @ @ -0,0 +1,5 @ @ + # This file is documented at https : //git-scm.com/docs/gitattributes . + # Linguist-specific attributes are documented at + # https : //github.com/github/linguist . + +**/zz_generated_*.go linguist-generated=true diff -- git a/.travis.yml b/.travis.yml index 762bf22..5d768ec 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -8,7 +8,7 @ @ language : before_install : # Bazel requires JDK8 - sudo apt-get install oracle-java8-installer - + install : - go get -u github.com/bazelbuild/buildifier/buildifier @ @ -24,9 +24,9 @ @ addons : - bazel script : - - bazel clean & & bazel build //v1/ ... //name/ ... //authn/ ... //cmd/ ... - - bazel clean & & bazel test -- test_output=errors //v1/ ... //name/ ... //authn/ ... //cmd/ ...
diff -- git a/v1/remote/write.go b/v1/remote/write.go index 966271f..9edf9cf 100644 -- - a/v1/remote/write.go +++ b/v1/remote/write.go @ @ -286,7 +286,7 @ @ func ( w *writer ) commitImage ( ) error { } // The image was successfully pushed ! - fmt.Printf ( `` % v : digest : % v size : % d\n '' , w.ref , digest , len ( raw ) ) + log.Printf ( `` % v : digest : % v size : % d\n '' , w.ref , digest , len ( raw ) ) return nil }
diff -- git a/Gopkg.lock b/Gopkg.lock index b2181bd..f15f5dc 100644 -- - a/Gopkg.lock +++ b/Gopkg.lock @ @ -246,6 +246,6 @ @ [ solve-meta ] analyzer-name = `` dep '' analyzer-version = 1 - inputs-digest = `` bb7854d92d8574aed0913c19aa937407357a6d3191d9dda7b4dace8e1951dc98 '' + inputs-digest = `` 747a1af3275517cedca99e49ebb4df86abe67be9f978fb857bfa475a303a0ab6 '' solver-name = `` gps-cdcl '' solver-version = 1 diff -- git a/cmd/ko/BUILD.bazel b/cmd/ko/BUILD.bazel index 2bea86a..28b9f64 100644 -- - a/cmd/ko/BUILD.bazel +++ b/cmd/ko/BUILD.bazel @ @ -6,6 +6,7 @ @ go_library ( `` commands.go '' , `` config.go '' , `` filestuff.go '' , + `` local.go '' , `` main.go '' , `` resolve.go '' , ] , @ @ -18,6 +19,7 @ @ go_library ( `` //ko/resolve : go_default_library '' , `` //name : go_default_library '' , `` //v1 : go_default_library '' , + `` //v1/daemon : go_default_library '' , `` //v1/remote : go_default_library '' , `` //vendor/github.com/spf13/cobra : go_default_library '' , `` //vendor/github.com/spf13/viper : go_default_library '' , diff -- git a/cmd/ko/commands.go b/cmd/ko/commands.go index df2874d..5554c03 100644 -- - a/cmd/ko/commands.go +++ b/cmd/ko/commands.go @ @ -62,6 +62,7 @ @ func addKubeCommands ( topLevel *cobra.Command ) { UnknownFlags : true , } , } ) + lo : = & LocalOptions { } fo : = & FilenameOptions { } apply :
diff -- git a/.bazelrc b/.bazelrc index 68e9acc..397ecf8 100644 -- - a/.bazelrc +++ b/.bazelrc @ @ -4,7 +4,8 @ @ vendor/k8s.io/code-generator/cmd/deepcopy-gen/args , \ vendor/k8s.io/code-generator/pkg/util , \ vendor/k8s.io/gengo/args , \ vendor/k8s.io/gengo/examples/deepcopy-gen/generators , \ -vendor/k8s.io/gengo/examples/deepcopy-gen/generators/args +vendor/k8s.io/gengo/examples/deepcopy-gen/generators/args , \ +vendor/github.com/spf13/cobra/cobra/cmd test -- test_output=errors \ -- deleted_packages=\ @ @ -13,3 +14,4 @ @ vendor/k8s.io/code-generator/cmd/deepcopy-gen/args , \ vendor/k8s.io/code-generator/pkg/util , \ vendor/k8s.io/gengo/args , \ vendor/k8s.io/gengo/examples/deepcopy-gen/generators , \ +vendor/github.com/spf13/cobra/cobra/cmd diff -- git a/Gopkg.lock b/Gopkg.lock index c0fa96f..e6062d0 100644 -- - a/Gopkg.lock +++ b/Gopkg.lock @ @ -73,10 +73,10 @ @ version = `` v0.2.0 '' [ [ projects ] ] - branch = `` master '' - name = `` github.com/google/subcommands '' + name = `` github.com/inconshreveable/mousetrap '' packages = [ `` . '' ] - revision = `` a3682377147edf596d303faabd89f81977b3f678 '' + revision = `` 76626ae9c91c4f2a10f34cad8ce83ea42c93bb75 '' + version = `` v1.0 '' [ [ projects ] ] name = `` github.com/pkg/errors '' @ @ -84,6 +84,12 @ @ revision = `` 645ef00459ed84a119197bfb8d8205042c6df63d '' version = `` v0.8.0 '' + # Use HEAD ( 2018-04-21 ) to pick up : + # https : //github.com/spf13/cobra/pull/662 + [ [ constraint ] ] + name = `` github.com/spf13/cobra '' + revision = `` 615425954c3b0d9485a7027d4d451fdcdfdee84e '' + [ [ projects ] ] name
diff -- git a/tools/flutter_location.bat b/tools/flutter_location.bat new file mode 100644 index 0000000..61b183d -- - /dev/null +++ b/tools/flutter_location.bat @ @ -0,0 +1,44 @ @ + : : Copyright 2018 Google LLC + : : + : : Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + : : you may not use this file except in compliance with the License . + : : You may obtain a copy of the License at + : : + : : http : //www.apache.org/licenses/LICENSE-2.0 + : : + : : Unless required by applicable law or agreed to in writing , software + : : distributed under the License is distributed on an `` AS IS '' BASIS , + : : WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + : : See the License for the specific language governing permissions and + : : limitations under the License . + @ echo off +SETLOCAL ENABLEDELAYEDEXPANSION + +set BASE_DIR= % ~dp0 +set CONFIG_FILE_DIR= % BASE_DIR % ..\..\ +set CONFIG_FILE= % CONFIG_FILE_DIR % .flutter_location_config + + : : Default to a sibling directory to this repository . +set FLUTTER_DIR= % BASE_DIR %
diff -- git a/tools/flutter_location.bat b/tools/flutter_location.bat new file mode 100644 index 0000000..61b183d -- - /dev/null +++ b/tools/flutter_location.bat @ @ -0,0 +1,44 @ @ + : : Copyright 2018 Google LLC + : : + : : Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + : : you may not use this file except in compliance with the License . + : : You may obtain a copy of the License at + : : + : : http : //www.apache.org/licenses/LICENSE-2.0 + : : + : : Unless required by applicable law or agreed to in writing , software + : : distributed under the License is distributed on an `` AS IS '' BASIS , + : : WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + : : See the License for the specific language governing permissions and + : : limitations under the License . + @ echo off +SETLOCAL ENABLEDELAYEDEXPANSION + +set BASE_DIR= % ~dp0 +set CONFIG_FILE_DIR= % BASE_DIR % ..\..\ +set CONFIG_FILE= % CONFIG_FILE_DIR % .flutter_location_config + + : : Default to a sibling directory to this repository . +set FLUTTER_DIR= % BASE_DIR %
diff -- git a/linux/Makefile b/linux/Makefile new file mode 100644 index 0000000..2a9c315 -- - /dev/null +++ b/linux/Makefile @ @ -0,0 +1,21 @ @ + # Copyright 2018 Google LLC + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . +TARGETS=all clean +SUBDIRS=library example + + $ ( TARGETS ) : $ ( SUBDIRS ) + $ ( SUBDIRS ) : + $ ( MAKE ) -C $ @ $ ( MAKECMDGOALS ) + +.PHONY : $ ( TARGETS ) $ ( SUBDIRS ) diff -- git a/linux/README.md b/linux/README.md new file mode 100644 index
diff -- git a/macos/library/FLEChannels.h b/macos/library/FLEChannels.h new file mode 100644 index 0000000..1270bb5 -- - /dev/null +++ b/macos/library/FLEChannels.h @ @ -0,0 +1,108 @ @ +// Copyright 2018 Google LLC +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + + # import < Foundation/Foundation.h > + +/** + * An object encapsulating a method call from Flutter . + * + * TODO : Move serialization details into a method codec class , to match mobile Flutter plugin APIs . + */ + @ interface FLEMethodCall : NSObject + +/** + * Returns a new FLEMethodCall created from a JSON message received from the Flutter
diff -- git a/.clang-format b/.clang-format new file mode 100644 index 0000000..80002f6 -- - /dev/null +++ b/.clang-format @ @ -0,0 +1,5 @ @ +BasedOnStyle : Google + -- - +Language : Cpp +DerivePointerAlignment : false +PointerAlignment : Right diff -- git a/linux/library/include/flutter_desktop_embedding/channels.h b/linux/library/include/flutter_desktop_embedding/channels.h new file mode 100644 index 0000000..fdffee5 -- - /dev/null +++ b/linux/library/include/flutter_desktop_embedding/channels.h @ @ -0,0 +1,120 @ @ +// Copyright 2018 Google LLC +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + # ifndef LINUX_INCLUDE_FLUTTER_DESKTOP_EMBEDDING_CHANNELS_H_ + # define LINUX_INCLUDE_FLUTTER_DESKTOP_EMBEDDING_CHANNELS_H_ + + # include < json/json.h > + + # include < memory > + # include < string > + +
diff -- git a/library/linux/src/embedder.cc b/library/linux/src/embedder.cc index 3bd1b44..2bc7f99 100644 -- - a/library/linux/src/embedder.cc +++ b/library/linux/src/embedder.cc @ @ -26,6 +26,7 @ @ # include < flutter_embedder.h > + # include `` library/linux/src/internal/key_event_plugin.h '' # include `` library/linux/src/internal/keyboard_hook_handler.h '' # include `` library/linux/src/internal/plugin_handler.h '' # include `` library/linux/src/internal/text_input_plugin.h '' @ @ -272,13 +273,17 @ @ GLFWwindow *CreateFlutterWindow ( size_t initial_width , size_t initial_height , FlutterEmbedderState *state = new FlutterEmbedderState ( ) ; state- > plugin_handler = std : :make_unique < PluginHandler > ( engine ) ; state- > engine = engine ; + + auto key_event_plugin = std : :make_unique < KeyEventPlugin > ( ) ; + state- > keyboard_hook_handlers.push_back ( key_event_plugin.get ( ) ) ; auto input_plugin = std : :make_unique < TextInputPlugin > ( ) ; state- > keyboard_hook_handlers.push_back ( input_plugin.get ( ) ) ; - + glfwSetWindowUserPointer ( window , state ) ; + AddPlugin ( window , std : :move ( key_event_plugin ) ) ; AddPlugin ( window , std : :move ( input_plugin ) ) ; - + int width , height ; glfwGetWindowSize ( window , & width , & height ) ; GLFWwindowSizeCallback ( window , width , height ) ; diff -- git a/library/linux/src/internal/key_event_plugin.cc b/library/linux/src/internal/key_event_plugin.cc new
diff -- git a/library/linux/src/embedder.cc b/library/linux/src/embedder.cc index 3bd1b44..5ce1396 100644 -- - a/library/linux/src/embedder.cc +++ b/library/linux/src/embedder.cc @ @ -26,6 +26,7 @ @ # include < flutter_embedder.h > + # include `` library/linux/src/internal/key_event_handler.h '' # include `` library/linux/src/internal/keyboard_hook_handler.h '' # include `` library/linux/src/internal/plugin_handler.h '' # include `` library/linux/src/internal/text_input_plugin.h '' @ @ -50,6 +51,10 @ @ struct FlutterEmbedderState { // deleted from the heap . std : :vector < flutter_desktop_embedding : :KeyboardHookHandler * > keyboard_hook_handlers ; + // Handles raw key interactions from GLFW . + // TODO : Move key_event_handler once + // https : //github.com/google/flutter-desktop-embedding/issues/102 is resolved . + std : :unique_ptr < flutter_desktop_embedding : :KeyEventHandler > key_event_handler ; } ; static constexpr char kDefaultWindowTitle [ ] = `` Flutter '' ; @ @ -272,6 +277,10 @ @ GLFWwindow *CreateFlutterWindow ( size_t initial_width , size_t initial_height , FlutterEmbedderState *state = new FlutterEmbedderState ( ) ; state- > plugin_handler = std : :make_unique < PluginHandler > ( engine ) ; state- > engine = engine ; + + state- > key_event_handler = + std : :make_unique < KeyEventHandler > ( state- > plugin_handler.get ( ) ) ; + state- > keyboard_hook_handlers.push_back ( state- > key_event_handler.get ( ) ) ; auto input_plugin = std :
diff -- git a/src/command.h b/src/command.h index b2e8540..72c2981 100644 -- - a/src/command.h +++ b/src/command.h @ @ -329,7 +329,11 @ @ class BufferCommand : public Command { void SetDatumType ( const DatumType & type ) { datum_type_ = type ; } const DatumType & GetDatumType ( ) const { return datum_type_ ; } - void SetValues ( std : :vector < Value > & & values ) { values_ = std : :move ( values ) ; } + void SetValues ( std : :vector < Value > & & values ) { + values_ = std : :move ( values ) ; + size_ = static_cast < uint32_t > ( values_.size ( ) * datum_type_.SizeInBytes ( ) ) / + datum_type_.ColumnCount ( ) / datum_type_.RowCount ( ) ; + } const std : :vector < Value > & GetValues ( ) const { return values_ ; } private : diff -- git a/src/vkscript/command_parser_test.cc b/src/vkscript/command_parser_test.cc index 8ab8e30..27f63d7 100644 -- - a/src/vkscript/command_parser_test.cc +++ b/src/vkscript/command_parser_test.cc @ @ -2588,6 +2588,7 @ @ TEST_F ( CommandParserTest , SSBOSubdataWithFloat ) { EXPECT_EQ ( static_cast < uint32_t > ( 0 ) , cmd- > GetDescriptorSet ( ) ) ; EXPECT_EQ ( 6U , cmd- > GetBinding ( )
diff -- git a/src/vulkan/buffer.cc b/src/vulkan/buffer.cc index bb4ac0b..6a3cff4 100644 -- - a/src/vulkan/buffer.cc +++ b/src/vulkan/buffer.cc @ @ -105,6 +105,9 @ @ void Buffer : :Shutdown ( ) { vkFreeMemory ( GetDevice ( ) , memory_ , nullptr ) ; memory_ = VK_NULL_HANDLE ; } + + if ( ! is_buffer_host_accessible_ ) + Resource : :Shutdown ( ) ; } Result Buffer : :InvalidateMemoryIfNeeded ( ) { diff -- git a/src/vulkan/graphics_pipeline.cc b/src/vulkan/graphics_pipeline.cc index 1c182be..57f5df9 100644 -- - a/src/vulkan/graphics_pipeline.cc +++ b/src/vulkan/graphics_pipeline.cc @ @ -530,6 +530,8 @ @ void GraphicsPipeline : :Shutdown ( ) { Pipeline : :Shutdown ( ) ; frame_- > Shutdown ( ) ; + if ( vertex_buffer_ ) + vertex_buffer_- > Shutdown ( ) ; vkDestroyRenderPass ( device_ , render_pass_ , nullptr ) ; } diff -- git a/src/vulkan/image.cc b/src/vulkan/image.cc index 5aed264..ca9d4a9 100644 -- - a/src/vulkan/image.cc +++ b/src/vulkan/image.cc @ @ -119,6 +119,8 @ @ void Image : :Shutdown ( ) { view_ = VK_NULL_HANDLE ; image_ = VK_NULL_HANDLE ; memory_ = VK_NULL_HANDLE ; + + Resource : :Shutdown ( ) ; } Result Image : :CopyToHost ( VkCommandBuffer command ) { diff -- git a/src/vulkan/pipeline.cc b/src/vulkan/pipeline.cc index 89d357a..e252196 100644 -- - a/src/vulkan/pipeline.cc +++ b/src/vulkan/pipeline.cc @ @ -65,11 +65,12 @ @ void
diff -- git a/docs/vk_script.md b/docs/vk_script.md index 2d5cf3b..c997ae3 100644 -- - a/docs/vk_script.md +++ b/docs/vk_script.md @ @ -259,13 +259,13 @ @ Sets the clear color . Defaults to ( 0 , 0 , 0 , 0 ) . # # # Clear Depth * ` clear depth _value_ ` -Sets the depth clear value . Defaults to 1.0 . +Sets the depth clear value . The _value_ is a float and defaults to 1.0 . # # # Clear Stencil * ` clear stencil _value_ ` -Sets the stencil clear value . Defaults to 0.0 . +Sets the stencil clear value . The _value_ is an integer and defaults to 0 . # # # Clear
diff -- git a/src/script.h b/src/script.h index 7248984..024ca9c 100644 -- - a/src/script.h +++ b/src/script.h @ @ -24,6 +24,7 @ @ # include `` amber/recipe.h '' # include `` amber/result.h '' + # include `` src/buffer.h '' # include `` src/command.h '' # include `` src/engine.h '' # include `` src/feature.h '' @ @ -62,6 +63,19 @ @ class Script : public RecipeImpl { return shaders_ ; } + Result AddBuffer ( std : :unique_ptr < Buffer > buffer ) { + if ( name_to_buffer_.count ( buffer- > GetName ( ) ) > 0 ) + return Result ( `` duplicate buffer name provided '' ) ; + + buffers_.push_back ( std : :move ( buffer ) ) ; + name_to_buffer_ [ buffers_.back ( ) - > GetName ( ) ] = buffers_.back ( ) .get ( ) ; + return { } ; + } + + const std : :vector < std : :unique_ptr < Buffer > > & GetBuffers ( ) const { + return buffers_ ; + } + void AddRequiredFeature ( Feature feature ) { engine_info_.required_features.push_back ( feature ) ; } @ @ -98,8 +112,10 @ @ class Script : public RecipeImpl { ScriptType script_type_ ; EngineData
diff -- git a/src/CMakeLists.txt b/src/CMakeLists.txt index 6ef2910..230c8db 100644 -- - a/src/CMakeLists.txt +++ b/src/CMakeLists.txt @ @ -40,7 +40,6 @ @ set ( AMBER_SOURCES vkscript/datum_type_parser.cc vkscript/executor.cc vkscript/format_parser.cc - vkscript/nodes.cc vkscript/parser.cc vkscript/script.cc vkscript/section_parser.cc diff -- git a/src/amberscript/parser.cc b/src/amberscript/parser.cc index c11d3fb..d45c52a 100644 -- - a/src/amberscript/parser.cc +++ b/src/amberscript/parser.cc @ @ -432,7 +432,7 @ @ Result Parser : :ParseBuffer ( ) { if ( ! r.IsSuccess ( ) ) return r ; - auto buffer = MakeUnique < Buffer > ( type ) ; + auto buffer = MakeUnique < DataBuffer > ( type ) ; token = tokenizer_- > NextToken ( ) ; if ( ! token- > IsString ( ) ) @ @ -474,7 +474,7 @ @ Result Parser : :ParseBuffer ( ) { return { } ; } -Result Parser : :ParseBufferFramebuffer ( Buffer* buffer ) { +Result Parser : :ParseBufferFramebuffer ( DataBuffer* buffer ) { auto token = tokenizer_- > NextToken ( ) ; if ( token- > IsEOL ( ) || token- > IsEOS ( ) ) return Result ( `` BUFFER framebuffer missing DIMS values '' ) ; @ @ -506,7 +506,7 @ @ Result Parser : :ParseBufferFramebuffer ( Buffer* buffer ) { return ValidateEndOfStatement ( `` BUFFER framebuffer command
diff -- git a/src/amberscript/parser.cc b/src/amberscript/parser.cc index c11d3fb..d45c52a 100644 -- - a/src/amberscript/parser.cc +++ b/src/amberscript/parser.cc @ @ -432,7 +432,7 @ @ Result Parser : :ParseBuffer ( ) { if ( ! r.IsSuccess ( ) ) return r ; - auto buffer = MakeUnique < Buffer > ( type ) ; + auto buffer = MakeUnique < DataBuffer > ( type ) ; token = tokenizer_- > NextToken ( ) ; if ( ! token- > IsString ( ) ) @ @ -474,7 +474,7 @ @ Result Parser : :ParseBuffer ( ) { return { } ; } -Result Parser : :ParseBufferFramebuffer ( Buffer* buffer ) { +Result Parser : :ParseBufferFramebuffer ( DataBuffer* buffer ) { auto token = tokenizer_- > NextToken ( ) ; if ( token- > IsEOL ( ) || token- > IsEOS ( ) ) return Result ( `` BUFFER framebuffer missing DIMS values '' ) ; @ @ -506,7 +506,7 @ @ Result Parser : :ParseBufferFramebuffer ( Buffer* buffer ) { return ValidateEndOfStatement ( `` BUFFER framebuffer command '' ) ; } -Result Parser : :ParseBufferInitializer ( Buffer* buffer ) { +Result Parser : :ParseBufferInitializer ( DataBuffer* buffer ) { auto token = tokenizer_- > NextToken ( )
diff -- git a/src/amberscript/parser.cc b/src/amberscript/parser.cc index c11d3fb..d45c52a 100644 -- - a/src/amberscript/parser.cc +++ b/src/amberscript/parser.cc @ @ -432,7 +432,7 @ @ Result Parser : :ParseBuffer ( ) { if ( ! r.IsSuccess ( ) ) return r ; - auto buffer = MakeUnique < Buffer > ( type ) ; + auto buffer = MakeUnique < DataBuffer > ( type ) ; token = tokenizer_- > NextToken ( ) ; if ( ! token- > IsString ( ) ) @ @ -474,7 +474,7 @ @ Result Parser : :ParseBuffer ( ) { return { } ; } -Result Parser : :ParseBufferFramebuffer ( Buffer* buffer ) { +Result Parser : :ParseBufferFramebuffer ( DataBuffer* buffer ) { auto token = tokenizer_- > NextToken ( ) ; if ( token- > IsEOL ( ) || token- > IsEOS ( ) ) return Result ( `` BUFFER framebuffer missing DIMS values '' ) ; @ @ -506,7 +506,7 @ @ Result Parser : :ParseBufferFramebuffer ( Buffer* buffer ) { return ValidateEndOfStatement ( `` BUFFER framebuffer command '' ) ; } -Result Parser : :ParseBufferInitializer ( Buffer* buffer ) { +Result Parser : :ParseBufferInitializer ( DataBuffer* buffer ) { auto token = tokenizer_- > NextToken ( )
diff -- git a/Android.mk b/Android.mk index 2be059a..3c4dfb1 100644 -- - a/Android.mk +++ b/Android.mk @ @ -30,7 +30,6 @ @ LOCAL_SRC_FILES : = \ src/vkscript/datum_type_parser.cc \ src/vkscript/executor.cc \ src/vkscript/format_parser.cc \ - src/vkscript/nodes.cc \ src/vkscript/parser.cc \ src/vkscript/script.cc \ src/vkscript/section_parser.cc diff -- git a/src/CMakeLists.txt b/src/CMakeLists.txt index 6ef2910..230c8db 100644 -- - a/src/CMakeLists.txt +++ b/src/CMakeLists.txt @ @ -40,7 +40,6 @ @ set ( AMBER_SOURCES vkscript/datum_type_parser.cc vkscript/executor.cc vkscript/format_parser.cc - vkscript/nodes.cc vkscript/parser.cc vkscript/script.cc vkscript/section_parser.cc diff -- git a/src/dawn/engine_dawn.cc b/src/dawn/engine_dawn.cc index 56c0e88..2a6ba5b 100644 -- - a/src/dawn/engine_dawn.cc +++ b/src/dawn/engine_dawn.cc @ @ -236,10 +236,6 @ @ Result EngineDawn : :CreatePipeline ( PipelineType type ) { return { } ; } -Result EngineDawn : :AddRequirement ( Feature , const Format* ) { - return Result ( `` Dawn : AddRequirement not implemented '' ) ; - } - Result EngineDawn : :SetShader ( ShaderType type , const std : :vector < uint32_t > & code ) { : :dawn : :ShaderModuleDescriptor descriptor ; diff -- git a/src/dawn/engine_dawn.h b/src/dawn/engine_dawn.h index 965ba4c..6648415 100644 -- - a/src/dawn/engine_dawn.h +++ b/src/dawn/engine_dawn.h @ @ -50,7 +50,6 @ @ class EngineDawn : public Engine { // pipeline requires a compute shader . A graphics pipeline requires a vertex // and a fragment shader . Result CreatePipeline ( PipelineType
diff -- git a/docs/vk_script.md b/docs/vk_script.md index 9448b56..2d5cf3b 100644 -- - a/docs/vk_script.md +++ b/docs/vk_script.md @ @ -42,6 +42,9 @ @ The _framebuffer_ and _depthstencil_ commands allow setting the format for the given buffer . The valid values are listed below in the *Image Formats* section . +The _fence\_timeout_ option allows setting an integer number of milliseconds +for any fence timeouts . + The last option is _extensions_ . Any string which is n't a _feature_ , _framebuffer_ or _depthstencil_ is assumed to be an _extension_ . The extensions must be of the format [ a-zA-Z0-9_ ] + . If the device extension is not available diff -- git a/src/engine.h b/src/engine.h index 82e3655..4c2677b 100644 -- - a/src/engine.h +++ b/src/engine.h @ @ -50,8 +50,11 @ @ class Engine { virtual Result Shutdown ( ) = 0 ; // Enable |feature| . If the feature requires a pixel format it will be - // provided in |format| , otherwise |format| is a nullptr . - virtual Result AddRequirement ( Feature feature , const Format* format ) = 0 ; + // provided in |format| , otherwise |format| is a nullptr . If the feature + // requires a uint32 value it will be set
diff -- git a/.gitignore b/.gitignore index 96b3bed..eae46e1 100644 -- - a/.gitignore +++ b/.gitignore @ @ -4,3 +4,4 @ @ third_party/googletest third_party/shaderc third_party/spirv-tools third_party/spirv-headers +.vs diff -- git a/CMakeLists.txt b/CMakeLists.txt index c7c2bd9..296194b 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -12,12 +12,23 @ @ # See the License for the specific language governing permissions and # limitations under the License . -cmake_minimum_required ( VERSION 2.8.12 ) +cmake_minimum_required ( VERSION 3.1 ) +if ( POLICY CMP0048 ) + cmake_policy ( SET CMP0048 NEW ) +endif ( ) +if ( POLICY CMP0054 ) + # Avoid dereferencing variables or interpret keywords that have been + # quoted or bracketed . + # https : //cmake.org/cmake/help/v3.1/policy/CMP0054.html + cmake_policy ( SET CMP0054 NEW ) +endif ( ) project ( amber ) enable_testing ( ) set ( CMAKE_RUNTIME_OUTPUT_DIRECTORY $ { PROJECT_BINARY_DIR } ) +set ( CMAKE_POSITION_INDEPENDENT_CODE ON ) +set ( CMAKE_CXX_STANDARD 11 ) include ( CheckIncludeFile ) include ( GNUInstallDirs ) @ @ -38,12 +49,6 @ @ if ( `` $ { CMAKE_BUILD_TYPE } '' STREQUAL `` '' ) set ( CMAKE_BUILD_TYPE `` Debug '' ) endif ( ) -set ( CUSTOM_CXX_FLAGS - -std=c++11 - -Wall - -Werror - -Wextra ) - if ( ( ``
diff -- git a/.gitignore b/.gitignore index 96b3bed..eae46e1 100644 -- - a/.gitignore +++ b/.gitignore @ @ -4,3 +4,4 @ @ third_party/googletest third_party/shaderc third_party/spirv-tools third_party/spirv-headers +.vs diff -- git a/CMakeLists.txt b/CMakeLists.txt index c7c2bd9..296194b 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -12,12 +12,23 @ @ # See the License for the specific language governing permissions and # limitations under the License . -cmake_minimum_required ( VERSION 2.8.12 ) +cmake_minimum_required ( VERSION 3.1 ) +if ( POLICY CMP0048 ) + cmake_policy ( SET CMP0048 NEW ) +endif ( ) +if ( POLICY CMP0054 ) + # Avoid dereferencing variables or interpret keywords that have been + # quoted or bracketed . + # https : //cmake.org/cmake/help/v3.1/policy/CMP0054.html + cmake_policy ( SET CMP0054 NEW ) +endif ( ) project ( amber ) enable_testing ( ) set ( CMAKE_RUNTIME_OUTPUT_DIRECTORY $ { PROJECT_BINARY_DIR } ) +set ( CMAKE_POSITION_INDEPENDENT_CODE ON ) +set ( CMAKE_CXX_STANDARD 11 ) include ( CheckIncludeFile ) include ( GNUInstallDirs ) @ @ -38,12 +49,6 @ @ if ( `` $ { CMAKE_BUILD_TYPE } '' STREQUAL `` '' ) set ( CMAKE_BUILD_TYPE `` Debug '' ) endif ( ) -set ( CUSTOM_CXX_FLAGS - -std=c++11 - -Wall - -Werror - -Wextra ) - if ( ( ``
diff -- git a/.travis.yml b/.travis.yml index 59a904c..3a88ce0 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -1,3 +1,5 @ @ +sudo : required + language : android jdk : @ @ -7,8 +9,8 @ @ android : components : - platform-tools - tools - - build-tools-23.0.3 - - android-23 + - build-tools-26.0.1 + - android-26 - extra-android-support - extra-android-m2repository licenses : diff -- git a/build.gradle b/build.gradle index 2735df9..33cd1f1 100644 -- - a/build.gradle +++ b/build.gradle @ @ -167,7 +167,7 @ @ pluginBundle { // Releases must be built on Java 1.7 . Building on Java 1.8 will make the // plugin runnable only on Java 1.8 . // See https : //github.com/grpc/grpc-java/issues/805 -task checkJavaVersion < < { +tasks.create ( `` checkJavaVersion '' ) .doLast { JavaVersion javaVersion = JavaVersion.current ( ) if ( ! javaVersion.isJava7 ( ) ) { throw new GradleException ( @ @ -198,6 +198,10 @ @ if ( System.env.TRAVIS == 'true ' ) { test { testLogging { showStandardStreams = true + exceptionFormat = 'full' + showExceptions true + showCauses true + showStackTraces true } } } diff -- git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties index 919bdd7..c71f03e 100644 -- - a/gradle/wrapper/gradle-wrapper.properties +++ b/gradle/wrapper/gradle-wrapper.properties @ @ -3,4 +3,4 @ @ distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists zipStoreBase=GRADLE_USER_HOME
diff -- git a/.travis.yml b/.travis.yml index da09272..f962711 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -7,8 +7,8 @ @ android : components : - platform-tools - tools - - build-tools-23.0.3 - - android-23 + - build-tools-26.0.0 + - android-26 - extra-android-support - extra-android-m2repository licenses : diff -- git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties index 919bdd7..c71f03e 100644 -- - a/gradle/wrapper/gradle-wrapper.properties +++ b/gradle/wrapper/gradle-wrapper.properties @ @ -3,4 +3,4 @ @ distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists zipStoreBase=GRADLE_USER_HOME zipStorePath=wrapper/dists -distributionUrl=https\ : //services.gradle.org/distributions/gradle-3.0-all.zip +distributionUrl=https\ : //services.gradle.org/distributions/gradle-4.0-all.zip diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy index 8af2a72..c9b4f40 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy @ @ -37,7 +37,10 @ @ import org.gradle.api.GradleException import org.gradle.api.Plugin import org.gradle.api.Project import org.gradle.api.Task +import org.gradle.api.artifacts.Configuration +import org.gradle.api.attributes.Attribute ; import org.gradle.api.file.ConfigurableFileTree +import org.gradle.api.file.FileCollection import org.gradle.api.internal.file.FileResolver import org.gradle.api.plugins.AppliedPlugin import org.gradle.api.tasks.SourceSet @ @ -241,9 +244,26 @ @ class ProtobufPlugin implements Plugin < Project > { sourceSetNames.each { sourceSetName - > def extractProtosTask = maybeAddExtractProtosTask ( sourceSetName ) generateProtoTask.dependsOn ( extractProtosTask ) + } - def extractIncludeProtosTask = maybeAddExtractIncludeProtosTask ( sourceSetName ) + if ( variant.hasProperty ( `` compileConfiguration '' ) ) { + // For Android Gradle plugin > = 2.5 + def artifactType = Attribute.of ( `` artifactType '' , String ) + def extractIncludeProtosTask = + maybeAddExtractIncludeProtosTask ( + variant.name , + variant.compileConfiguration.incoming.artifactView
diff -- git a/.travis.yml b/.travis.yml index da09272..f962711 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -7,8 +7,8 @ @ android : components : - platform-tools - tools - - build-tools-23.0.3 - - android-23 + - build-tools-26.0.0 + - android-26 - extra-android-support - extra-android-m2repository licenses : diff -- git a/build.gradle b/build.gradle index 6cddded..fc4eef3 100644 -- - a/build.gradle +++ b/build.gradle @ @ -193,6 +193,10 @ @ if ( System.env.TRAVIS == 'true ' ) { test { testLogging { showStandardStreams = true + exceptionFormat = 'full' + showExceptions true + showCauses true + showStackTraces true } } } diff -- git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties index 919bdd7..c71f03e 100644 -- - a/gradle/wrapper/gradle-wrapper.properties +++ b/gradle/wrapper/gradle-wrapper.properties @ @ -3,4 +3,4 @ @ distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists zipStoreBase=GRADLE_USER_HOME zipStorePath=wrapper/dists -distributionUrl=https\ : //services.gradle.org/distributions/gradle-3.0-all.zip +distributionUrl=https\ : //services.gradle.org/distributions/gradle-4.0-all.zip diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy index 8af2a72..c9b4f40 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy @ @ -37,7 +37,10 @ @ import org.gradle.api.GradleException import org.gradle.api.Plugin import org.gradle.api.Project import org.gradle.api.Task +import org.gradle.api.artifacts.Configuration +import org.gradle.api.attributes.Attribute ; import org.gradle.api.file.ConfigurableFileTree +import org.gradle.api.file.FileCollection import org.gradle.api.internal.file.FileResolver import org.gradle.api.plugins.AppliedPlugin import org.gradle.api.tasks.SourceSet @ @ -241,9 +244,26 @ @ class ProtobufPlugin implements Plugin < Project > { sourceSetNames.each { sourceSetName - > def extractProtosTask = maybeAddExtractProtosTask ( sourceSetName ) generateProtoTask.dependsOn ( extractProtosTask ) + } - def
diff -- git a/.travis.yml b/.travis.yml index 59a904c..6a410d2 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -7,8 +7,8 @ @ android : components : - platform-tools - tools - - build-tools-23.0.3 - - android-23 + - build-tools-26.0.0 + - android-26 - extra-android-support - extra-android-m2repository licenses : diff -- git a/build.gradle b/build.gradle index 2735df9..33cd1f1 100644 -- - a/build.gradle +++ b/build.gradle @ @ -167,7 +167,7 @ @ pluginBundle { // Releases must be built on Java 1.7 . Building on Java 1.8 will make the // plugin runnable only on Java 1.8 . // See https : //github.com/grpc/grpc-java/issues/805 -task checkJavaVersion < < { +tasks.create ( `` checkJavaVersion '' ) .doLast { JavaVersion javaVersion = JavaVersion.current ( ) if ( ! javaVersion.isJava7 ( ) ) { throw new GradleException ( @ @ -198,6 +198,10 @ @ if ( System.env.TRAVIS == 'true ' ) { test { testLogging { showStandardStreams = true + exceptionFormat = 'full' + showExceptions true + showCauses true + showStackTraces true } } } diff -- git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties index 919bdd7..c71f03e 100644 -- - a/gradle/wrapper/gradle-wrapper.properties +++ b/gradle/wrapper/gradle-wrapper.properties @ @ -3,4 +3,4 @ @ distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists zipStoreBase=GRADLE_USER_HOME zipStorePath=wrapper/dists -distributionUrl=https\ : //services.gradle.org/distributions/gradle-3.0-all.zip +distributionUrl=https\ : //services.gradle.org/distributions/gradle-4.0-all.zip diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufPlugin.groovy index 3c41ccb..f122796 100644
diff -- git a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy index 45951dd..56e03e5 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy @ @ -202,8 +202,7 @ @ public class GenerateProtoTask extends DefaultTask { throw new IllegalStateException ( `` requested descriptor path but descriptor generation is off '' ) } - return descriptorSetOptions.path ! = null - ? descriptorSetOptions.path : `` $ { outputBaseDir } /descriptor_set.desc '' + return descriptorSetOptions.path ! = null ? descriptorSetOptions.path : `` $ { outputBaseDir } /descriptor_set.desc '' } public GenerateProtoTask ( ) { diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy index bbc5049..1cd51d3 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy @ @ -31,7 +31,6 @ @ package com.google.protobuf.gradle import org.gradle.api.NamedDomainObjectContainer import org.gradle.api.Project -import org.gradle.api.internal.file.FileResolver import org.gradle.api.tasks.SourceSet import org.gradle.util.ConfigureUtil @ @ -50,7 +49,7 @ @ public class ProtobufConfigurator { */ public String generatedFilesBaseDir - public ProtobufConfigurator ( Project project , FileResolver fileResolver ) { + public ProtobufConfigurator ( Project project ) { this.project = project if ( Utils.isAndroidProject ( project ) ) { tasks = new AndroidGenerateProtoTaskCollection ( ) diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufConvention.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufConvention.groovy index 91b75bb..97194c4 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufConvention.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/ProtobufConvention.groovy @ @ -33,15 +33,14 @ @ package com.google.protobuf.gradle import com.google.common.collect.ArrayListMultimap import com.google.common.collect.Multimap import org.gradle.api.Project -import org.gradle.api.internal.file.FileResolver import org.gradle.util.ConfigureUtil /** * Adds the protobuf { } block
diff -- git a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy index 45951dd..56e03e5 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy @ @ -202,8 +202,7 @ @ public class GenerateProtoTask extends DefaultTask { throw new IllegalStateException ( `` requested descriptor path but descriptor generation is off '' ) } - return descriptorSetOptions.path ! = null - ? descriptorSetOptions.path : `` $ { outputBaseDir } /descriptor_set.desc '' + return descriptorSetOptions.path ! = null ? descriptorSetOptions.path : `` $ { outputBaseDir } /descriptor_set.desc '' } public GenerateProtoTask ( ) { diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy index bbc5049..1cd51d3 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/ProtobufConfigurator.groovy @ @ -31,7 +31,6 @ @ package com.google.protobuf.gradle import org.gradle.api.NamedDomainObjectContainer import org.gradle.api.Project -import org.gradle.api.internal.file.FileResolver import org.gradle.api.tasks.SourceSet import org.gradle.util.ConfigureUtil @ @ -50,7 +49,7 @ @ public class ProtobufConfigurator { */ public String generatedFilesBaseDir - public ProtobufConfigurator ( Project project , FileResolver fileResolver ) { + public ProtobufConfigurator ( Project project ) { this.project = project if ( Utils.isAndroidProject ( project ) ) { tasks = new AndroidGenerateProtoTaskCollection ( ) diff -- git a/src/main/groovy/com/google/protobuf/gradle/ProtobufConvention.groovy b/src/main/groovy/com/google/protobuf/gradle/ProtobufConvention.groovy index 91b75bb..97194c4 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/ProtobufConvention.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/ProtobufConvention.groovy @ @ -33,15 +33,14 @ @ package com.google.protobuf.gradle import com.google.common.collect.ArrayListMultimap import com.google.common.collect.Multimap import org.gradle.api.Project -import org.gradle.api.internal.file.FileResolver import org.gradle.util.ConfigureUtil /** * Adds the protobuf { } block
diff -- git a/.travis.yml b/.travis.yml index c01643b..2350393 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -14,9 +14,6 @ @ android : licenses : - '.+' -install : - - ./gradlew install - script : - ./gradlew clean assemble test -- stacktrace diff -- git a/build.gradle b/build.gradle index 5725d63..2ec0d84 100644 -- - a/build.gradle +++ b/build.gradle @ @ -34,38 +34,46 @ @ buildscript { classpath 'org.ajoberstar : gradle-git:0.1.0' classpath 'com.jfrog.bintray.gradle : gradle-bintray-plugin:0.5' classpath `` com.gradle.publish : plugin-publish-plugin:0.9.4 '' - classpath 'junit : junit:4.12' classpath 'org.jacoco : org.jacoco.core:0.7.4.201502262128' } } -subprojects { - buildscript { - repositories { - jcenter ( ) - mavenLocal ( ) - } - dependencies { - classpath `` com.google.protobuf : protobuf-gradle-plugin : $ { rootProject.version } '' - } - } - repositories { - mavenCentral ( ) - jcenter ( ) - } - } - repositories { mavenLocal ( ) mavenCentral ( ) } +// Write the plugin 's classpath to a file to share with the tests +task createClasspathManifest { + def outputDir = file ( `` $ buildDir/ $ name '' ) + + inputs.files sourceSets.main.runtimeClasspath + outputs.dir outputDir + + doLast { + outputDir.mkdirs ( ) + file ( `` $ outputDir/plugin-classpath.txt
diff -- git a/src/main/groovy/com/google/protobuf/gradle/Utils.groovy b/src/main/groovy/com/google/protobuf/gradle/Utils.groovy index c031465..fa190e9 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/Utils.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/Utils.groovy @ @ -63,7 +63,7 @ @ class Utils { static void addFilesToTaskInputs ( Project project , TaskInputs inputs , Object files ) { if ( compareGradleVersion ( project , `` 3.0 '' ) > = 0 ) { - inputs.file ( files ) .skipWhenEmpty ( ) + inputs.files ( files ) .skipWhenEmpty ( ) } else { // source ( ) is deprecated since Gradle 3.0 inputs.source ( files ) diff -- git a/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy b/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy index 0080c68..6ac6f9b 100644 -- - a/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy +++ b/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy @ @ -54,7 +54,7 @ @ buildscript { result.task ( `` : testProjectAndroid : build '' ) .outcome == TaskOutcome.SUCCESS where : - androidPluginVersion < < [ `` 2.2.0 '' , `` 2.2.0 '' , `` 3.0.0-alpha7 '' ] - gradleVersion < < [ `` 2.14.1 '' , `` 3.0 '' , `` 4.1-milestone-1 '' ] + androidPluginVersion < < [ `` 2.2.0 '' , `` 2.2.0 '' , `` 2.3.0 '' , `` 2.3.0 '' ] + gradleVersion < < [ `` 2.14.1 '' , `` 3.0 '' , `` 4.2 '' , `` 4.3-rc-2 '' ] } } diff -- git a/src/test/groovy/com/google/plugins/ProtobufJavaPluginTest.groovy
diff -- git a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy index 327bba2..7ac48a2 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy @ @ -31,6 +31,7 @ @ package com.google.protobuf.gradle import com.google.common.base.Preconditions import com.google.common.collect.ImmutableList +import com.google.common.primitives.Ints import org.gradle.api.DefaultTask import org.gradle.api.GradleException @ @ -46,6 +47,8 @ @ import org.gradle.util.ConfigureUtil */ // TODO ( zhangkun83 ) : add per-plugin output dir reconfiguraiton . public class GenerateProtoTask extends DefaultTask { + private static final int VISTA_CMD_LENGTH_LIMIT = 8191 + private static final int XP_CMD_LENGTH_LIMIT = 2047 private final List includeDirs = [ ] private final NamedDomainObjectContainer < PluginOptions > builtins @ @ -372,7 +375,7 @ @ public class GenerateProtoTask extends DefaultTask { List < String > dirs = includeDirs*.path.collect { `` -I $ { it } '' } logger.debug `` ProtobufCompile using directories $ { dirs } '' logger.debug `` ProtobufCompile using files $ { protoFiles } '' - List < String > cmd = [ tools.protoc.path ] + List cmd = [ tools.protoc.path ] cmd.addAll ( dirs ) // Handle code generation built-ins @ @ -410,8 +413,33 @ @ public class GenerateProtoTask extends DefaultTask { } } - cmd.addAll protoFiles - logger.log ( LogLevel.INFO , cmd.toString ( ) ) + int lengthLimit = getCmdLengthLimit ( ) + + String baseCmd =
diff -- git a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy index 327bba2..a40af3f 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy @ @ -31,6 +31,7 @ @ package com.google.protobuf.gradle import com.google.common.base.Preconditions import com.google.common.collect.ImmutableList +import com.google.common.primitives.Ints import org.gradle.api.DefaultTask import org.gradle.api.GradleException @ @ -46,6 +47,8 @ @ import org.gradle.util.ConfigureUtil */ // TODO ( zhangkun83 ) : add per-plugin output dir reconfiguraiton . public class GenerateProtoTask extends DefaultTask { + static final int VISTA_CMD_LENGTH_LIMIT = 8191 + static final int XP_CMD_LENGTH_LIMIT = 2047 private final List includeDirs = [ ] private final NamedDomainObjectContainer < PluginOptions > builtins @ @ -372,13 +375,13 @ @ public class GenerateProtoTask extends DefaultTask { List < String > dirs = includeDirs*.path.collect { `` -I $ { it } '' } logger.debug `` ProtobufCompile using directories $ { dirs } '' logger.debug `` ProtobufCompile using files $ { protoFiles } '' - List < String > cmd = [ tools.protoc.path ] - cmd.addAll ( dirs ) + List < String > baseCmd = [ tools.protoc.path ] + baseCmd.addAll ( dirs ) // Handle code generation built-ins builtins.each { builtin - > String outPrefix = makeOptionsPrefix ( builtin.options ) - cmd += `` -- $ { builtin.name } _out= $ { outPrefix } $ { getOutputDir ( builtin
diff -- git a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy index 751654b..0127d65 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy @ @ -447,14 +447,14 @ @ public class GenerateProtoTask extends DefaultTask { } } - List < String > cmds = generateCmds ( baseCmd.join ( `` `` ) , protoFiles , getCmdLengthLimit ( ) ) - for ( String cmd : cmds ) { + List < List < String > > cmds = generateCmds ( baseCmd , protoFiles , getCmdLengthLimit ( ) ) + for ( List < String > cmd : cmds ) { compileFiles ( cmd ) } } - private void compileFiles ( String cmd ) { - logger.log ( LogLevel.INFO , cmd ) + private void compileFiles ( List < String > cmd ) { + logger.log ( LogLevel.INFO , cmd.toString ( ) ) StringBuffer stdout = new StringBuffer ( ) StringBuffer stderr = new StringBuffer ( ) @ @ -468,23 +468,32 @ @ public class GenerateProtoTask extends DefaultTask { } } - static List < String > generateCmds ( String baseCmd , List < File > protoFiles , int cmdLengthLimit ) { - List < String > cmds = [ ] + static List < List < String > > generateCmds
diff -- git a/src/main/groovy/com/google/protobuf/gradle/Utils.groovy b/src/main/groovy/com/google/protobuf/gradle/Utils.groovy index c031465..fa190e9 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/Utils.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/Utils.groovy @ @ -63,7 +63,7 @ @ class Utils { static void addFilesToTaskInputs ( Project project , TaskInputs inputs , Object files ) { if ( compareGradleVersion ( project , `` 3.0 '' ) > = 0 ) { - inputs.file ( files ) .skipWhenEmpty ( ) + inputs.files ( files ) .skipWhenEmpty ( ) } else { // source ( ) is deprecated since Gradle 3.0 inputs.source ( files ) diff -- git a/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy b/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy index 0080c68..584ee08 100644 -- - a/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy +++ b/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy @ @ -54,7 +54,7 @ @ buildscript { result.task ( `` : testProjectAndroid : build '' ) .outcome == TaskOutcome.SUCCESS where : - androidPluginVersion < < [ `` 2.2.0 '' , `` 2.2.0 '' , `` 3.0.0-alpha7 '' ] - gradleVersion < < [ `` 2.14.1 '' , `` 3.0 '' , `` 4.1-milestone-1 '' ] + androidPluginVersion < < [ `` 2.2.0 '' , `` 2.2.0 '' , `` 3.0.0-beta7 '' , `` 3.0.0-beta7 '' ] + gradleVersion < < [ `` 2.14.1 '' , `` 3.0 '' , `` 4.1 '' , `` 4.3-rc-2 '' ] } } diff -- git a/src/test/groovy/com/google/plugins/ProtobufJavaPluginTest.groovy
diff -- git a/src/main/groovy/com/google/protobuf/gradle/Utils.groovy b/src/main/groovy/com/google/protobuf/gradle/Utils.groovy index c031465..fa190e9 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/Utils.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/Utils.groovy @ @ -63,7 +63,7 @ @ class Utils { static void addFilesToTaskInputs ( Project project , TaskInputs inputs , Object files ) { if ( compareGradleVersion ( project , `` 3.0 '' ) > = 0 ) { - inputs.file ( files ) .skipWhenEmpty ( ) + inputs.files ( files ) .skipWhenEmpty ( ) } else { // source ( ) is deprecated since Gradle 3.0 inputs.source ( files ) diff -- git a/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy b/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy index 0080c68..a60044c 100644 -- - a/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy +++ b/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy @ @ -54,7 +54,7 @ @ buildscript { result.task ( `` : testProjectAndroid : build '' ) .outcome == TaskOutcome.SUCCESS where : - androidPluginVersion < < [ `` 2.2.0 '' , `` 2.2.0 '' , `` 3.0.0-alpha7 '' ] - gradleVersion < < [ `` 2.14.1 '' , `` 3.0 '' , `` 4.1-milestone-1 '' ] + androidPluginVersion < < [ `` 2.2.0 '' , `` 2.2.0 '' , `` 2.3.0 '' , `` 3.0.0-alpha7 '' ] + gradleVersion < < [ `` 2.14.1 '' , `` 3.0 '' , `` 4.2 '' , `` 4.3-rc-2 '' ] } } diff -- git a/src/test/groovy/com/google/plugins/ProtobufJavaPluginTest.groovy
diff -- git a/src/main/groovy/com/google/protobuf/gradle/Utils.groovy b/src/main/groovy/com/google/protobuf/gradle/Utils.groovy index c031465..fa190e9 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/Utils.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/Utils.groovy @ @ -63,7 +63,7 @ @ class Utils { static void addFilesToTaskInputs ( Project project , TaskInputs inputs , Object files ) { if ( compareGradleVersion ( project , `` 3.0 '' ) > = 0 ) { - inputs.file ( files ) .skipWhenEmpty ( ) + inputs.files ( files ) .skipWhenEmpty ( ) } else { // source ( ) is deprecated since Gradle 3.0 inputs.source ( files ) diff -- git a/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy b/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy index 0080c68..6ac6f9b 100644 -- - a/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy +++ b/src/test/groovy/com/google/plugins/ProtobufAndroidPluginTest.groovy @ @ -54,7 +54,7 @ @ buildscript { result.task ( `` : testProjectAndroid : build '' ) .outcome == TaskOutcome.SUCCESS where : - androidPluginVersion < < [ `` 2.2.0 '' , `` 2.2.0 '' , `` 3.0.0-alpha7 '' ] - gradleVersion < < [ `` 2.14.1 '' , `` 3.0 '' , `` 4.1-milestone-1 '' ] + androidPluginVersion < < [ `` 2.2.0 '' , `` 2.2.0 '' , `` 2.3.0 '' , `` 2.3.0 '' ] + gradleVersion < < [ `` 2.14.1 '' , `` 3.0 '' , `` 4.2 '' , `` 4.3-rc-2 '' ] } } diff -- git a/src/test/groovy/com/google/plugins/ProtobufJavaPluginTest.groovy
diff -- git a/README.md b/README.md index edc44b9..1297c06 100644 -- - a/README.md +++ b/README.md @ @ -222,6 +222,12 @ @ protobuf { } `` ` +The syntax for ` artifact ` follows [ Artifact Classifiers ] ( https : //docs.gradle.org/3.3/userguide/dependency_management.html # sub : classifiers ) +where the default classifier is ` os.detector.classifier ` ( ie + ` `` $ { os.detector.os } - $ { os.detector.arch } '' ` ) and the default extension is ` `` exe '' ` . +Non-C++ implementations of codegen plugins can be used if a constant + ` classifier ` is specified ( eg ` `` com.example : example-generator:1.0.0 : -jvm8_32 '' ` ) . + # # # # Customize code generation tasks The Protobuf plugin generates a task for each `` protoc `` run , which is for a diff -- git a/src/main/groovy/com/google/protobuf/gradle/ToolsLocator.groovy b/src/main/groovy/com/google/protobuf/gradle/ToolsLocator.groovy index 37d2f24..eee247d 100644 -- - a/src/main/groovy/com/google/protobuf/gradle/ToolsLocator.groovy +++ b/src/main/groovy/com/google/protobuf/gradle/ToolsLocator.groovy @ @ -79,13 +79,13 @ @ class ToolsLocator { transitive = false extendsFrom = [ ] } - def groupId , artifact , version - ( groupId , artifact , version ) = locator.artifact.split ( `` : '' ) + def groupId , artifact , version , classifier , extension +
diff -- git a/.gitignore b/.gitignore index 9011c0e..4b43a97 100644 -- - a/.gitignore +++ b/.gitignore @ @ -68,6 +68,9 @ @ tools/polly docs/_build # TAEF crash logs . WexLogFileOutput/* + # SPIR-V dependencies . +external/SPIRV-Headers +external/SPIRV-Tools # ============================================================================== # # Files created in tree by the Go bindings . diff -- git a/CMakeLists.txt b/CMakeLists.txt index 31d7f96..024a0cd 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -86,6 +86,10 @ @ option ( HLSL_OPTIONAL_PROJS_IN_DEFAULT `` Include optional projects in default buil # SPIRV change starts option ( ENABLE_SPIRV_CODEGEN `` Enables SPIR-V code generation . '' OFF ) +option ( SPIRV_BUILD_TESTS `` Build targets for the SPIR-V unit tests . '' OFF ) +if ( $ { SPIRV_BUILD_TESTS } ) + set ( ENABLE_SPIRV_CODEGEN ON ) +endif ( ) if ( $ { ENABLE_SPIRV_CODEGEN } ) add_definitions ( -DENABLE_SPIRV_CODEGEN ) endif ( ) @ @ -636,6 +640,8 @ @ if ( WITH_POLLY ) endif ( ) endif ( WITH_POLLY ) +add_subdirectory ( external ) # SPIRV change + if ( LLVM_INCLUDE_TOOLS ) add_subdirectory ( tools ) endif ( ) diff -- git a/appveyor.yml b/appveyor.yml index 899b388..664a3ce 100644 -- - a/appveyor.yml +++ b/appveyor.yml @ @ -8,13 +8,18 @ @ environment : HLSL_BLD_DIR : c : \projects\DirectXShaderCompiler.bin install
diff -- git a/mobly/controllers/android_device_lib/snippet_client.py b/mobly/controllers/android_device_lib/snippet_client.py index f3ffade..db75865 100644 -- - a/mobly/controllers/android_device_lib/snippet_client.py +++ b/mobly/controllers/android_device_lib/snippet_client.py @ @ -17,14 +17,18 @ @ import logging import re -from mobly.controllers.android_device_lib import adb +from mobly import utils from mobly.controllers.android_device_lib import jsonrpc_client_base -_INSTRUMENTATION_RUNNER_PACKAGE = 'com.google.android.mobly.snippet.SnippetRunner' +_INSTRUMENTATION_RUNNER_PACKAGE = ( + 'com.google.android.mobly.snippet.SnippetRunner ' ) -_LAUNCH_CMD = 'am instrument -e action start -e port % s % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE +_LAUNCH_CMD = ( + 'am instrument -w -e action start -e port % s % s/ ' + + _INSTRUMENTATION_RUNNER_PACKAGE ) -_STOP_CMD = 'am instrument -w -e action stop % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE +_STOP_CMD = ( + 'am instrument -w -e action stop % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) class Error ( Exception ) : @ @ -59,6 +63,7 @ @ class SnippetClient ( jsonrpc_client_base.JsonRpcClientBase ) : self.package = package self.log = log self._serial = self._adb.serial + self._proc = None def _do_start_app ( self ) : `` '' '' Overrides superclass . '' '' '' @ @ -67,11 +72,18 @ @ class SnippetClient ( jsonrpc_client_base.JsonRpcClientBase ) : # helpful since they need to create their own instrumentations and # manifest . self.log.info ( 'Launching snippet apk % s ' , self.package ) - self._adb.shell ( cmd ) +
diff -- git a/docs/conf.py b/docs/conf.py index d092091..2e12371 100644 -- - a/docs/conf.py +++ b/docs/conf.py @ @ -31,6 +31,7 @ @ # extensions coming with Sphinx ( named 'sphinx.ext . * ' ) or your custom # ones . extensions = [ 'sphinx.ext.autodoc ' , + 'sphinx.ext.napoleon ' , 'sphinx.ext.todo ' , 'sphinx.ext.viewcode ' ] @ @ -78,7 +79,7 @ @ language = 'en' # List of patterns , relative to source directory , that match files and # directories to ignore when looking for source files . # This patterns also effect to html_static_path and html_extra_path -exclude_patterns = [ '_build ' , 'Thumbs.db ' , '.DS_Store ' ] +exclude_patterns = [ '_build ' , 'Thumbs.db ' , '.DS_Store ' , 'tutorial.md ' ] # The name of the Pygments ( syntax highlighting ) style to use . pygments_style = 'sphinx' @ @ -103,7 +104,7 @ @ html_theme = 'alabaster' # Add any paths that contain custom static files ( such as style sheets ) here , # relative to this directory . They are copied after the builtin static files , # so a file named `` default.css '' will overwrite the builtin `` default.css '' . -html_static_path = [ '_static
diff -- git a/mobly/controllers/android_device_lib/snippet_client.py b/mobly/controllers/android_device_lib/snippet_client.py index 3d85e40..617c0e6 100644 -- - a/mobly/controllers/android_device_lib/snippet_client.py +++ b/mobly/controllers/android_device_lib/snippet_client.py @ @ -24,15 +24,27 @ @ _INSTRUMENTATION_RUNNER_PACKAGE = ( 'com.google.android.mobly.snippet.SnippetRunner ' ) # TODO ( adorokhine ) : delete this in Mobly 1.6 when snippet v0 support is removed . -_LAUNCH_CMD_V0 = ( 'am instrument -w -e action start -e port % s % s/ ' + +_LAUNCH_CMD_V0 = ( ' % s am instrument -w -e action start -e port % s % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) _LAUNCH_CMD_V1 = ( - 'am instrument -w -e action start % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) + ' % s am instrument -w -e action start % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) _STOP_CMD = ( 'am instrument -w -e action stop % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) + # Test that uses UiAutomation requires the shell session to be maintained while + # test is in progress . However , this requirement does not hold for the test that + # deals with device USB disconnection ( Once device disconnects , the shell + # session that started the instrument ends , and UiAutomation fails with error : + # `` UiAutomation not connected '' ) . To
diff -- git a/mobly/controllers/android_device_lib/snippet_client.py b/mobly/controllers/android_device_lib/snippet_client.py index 3d85e40..5b83358 100644 -- - a/mobly/controllers/android_device_lib/snippet_client.py +++ b/mobly/controllers/android_device_lib/snippet_client.py @ @ -24,15 +24,27 @ @ _INSTRUMENTATION_RUNNER_PACKAGE = ( 'com.google.android.mobly.snippet.SnippetRunner ' ) # TODO ( adorokhine ) : delete this in Mobly 1.6 when snippet v0 support is removed . -_LAUNCH_CMD_V0 = ( 'am instrument -w -e action start -e port % s % s/ ' + +_LAUNCH_CMD_V0 = ( ' % s am instrument -w -e action start -e port % s % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) _LAUNCH_CMD_V1 = ( - 'am instrument -w -e action start % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) + ' % s am instrument -w -e action start % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) _STOP_CMD = ( 'am instrument -w -e action stop % s/ ' + _INSTRUMENTATION_RUNNER_PACKAGE ) + # Test that uses UiAutomation requires the shell session to be maintained while + # test is in progress . However , this requirement does not hold for the test that + # deals with device USB disconnection ( Once device disconnects , the shell + # session that started the instrument ends , and UiAutomation fails with error : + # `` UiAutomation not connected '' ) . To
diff -- git a/mobly/base_test.py b/mobly/base_test.py index 7353afd..ece150a 100644 -- - a/mobly/base_test.py +++ b/mobly/base_test.py @ @ -87,6 +87,7 @ @ class BaseTestClass ( object ) : self.user_params = configs.user_params self.register_controller = configs.register_controller self.results = records.TestResult ( ) + self.summary_writer = configs.summary_writer self.current_test_name = None self._generated_test_table = collections.OrderedDict ( ) @ @ -383,6 +384,8 @ @ class BaseTestClass ( object ) : elif tr_record.result == records.TestResultEnums.TEST_RESULT_SKIP : self._exec_procedure_func ( self._on_skip , tr_record ) self.results.add_record ( tr_record ) + self.summary_writer.dump ( tr_record.to_dict ( ) , + records.TestSummaryEntryType.RECORD ) def _assert_function_name_in_stack ( self , expected_func_name ) : `` '' '' Asserts that the current stack contains the given function name . '' '' '' @ @ -504,6 +507,8 @ @ class BaseTestClass ( object ) : test_record = records.TestResultRecord ( test_name , self.TAG ) test_record.test_skip ( exception ) self.results.add_record ( test_record ) + self.summary_writer.dump ( test_record.to_dict ( ) , + records.TestSummaryEntryType.RECORD ) def run ( self , test_names=None ) : `` '' '' Runs tests within a test class . @ @ -534,6 +539,8 @ @ class BaseTestClass ( object ) : class_record.test_begin ( ) class_record.test_error ( e ) self.results.add_class_error ( class_record ) + self.summary_writer.dump ( class_record.to_dict ( ) , + records.TestSummaryEntryType.RECORD ) return
diff -- git a/docs/conf.py b/docs/conf.py index d092091..6407969 100644 -- - a/docs/conf.py +++ b/docs/conf.py @ @ -20,7 +20,6 @ @ # import sys # sys.path.insert ( 0 , u'mobly ' ) - # -- General configuration -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # If your documentation needs a minimal Sphinx version , state it here . @ @ -31,6 +30,7 @ @ # extensions coming with Sphinx ( named 'sphinx.ext . * ' ) or your custom # ones . extensions = [ 'sphinx.ext.autodoc ' , + 'sphinx.ext.napoleon ' , 'sphinx.ext.todo ' , 'sphinx.ext.viewcode ' ] @ @ -78,7 +78,7 @ @ language = 'en' # List of patterns , relative to source directory , that match files and # directories to ignore when looking for source files . # This patterns also effect to html_static_path and html_extra_path -exclude_patterns = [ '_build ' , 'Thumbs.db ' , '.DS_Store ' ] +exclude_patterns = [ '_build ' , 'Thumbs.db ' , '.DS_Store ' , 'tutorial.md ' ] # The name of the Pygments ( syntax highlighting ) style to use . pygments_style = 'sphinx' @
diff -- git a/mobly/utils.py b/mobly/utils.py index efe2c0f..1ff4dfd 100644 -- - a/mobly/utils.py +++ b/mobly/utils.py @ @ -21,6 +21,7 @ @ import functools import logging import os import platform +import psutil import random import signal import socket @ @ -340,9 +341,8 @ @ def start_standing_subprocess ( cmd , check_health_delay=0 ) : cmd , stdout=subprocess.PIPE , stderr=subprocess.PIPE , - shell=True , - preexec_fn=os.setpgrp ) - logging.debug ( `` Start standing subprocess with cmd : % s '' , cmd ) + shell=True ) + logging.debug ( 'Start standing subprocess with cmd : % s ' , cmd ) if check_health_delay > 0 : time.sleep ( check_health_delay ) _assert_subprocess_running ( proc ) @ @ -361,12 +361,23 @ @ def stop_standing_subprocess ( proc , kill_signal=signal.SIGTERM ) : proc : Subprocess to terminate. `` '' '' pid = proc.pid - logging.debug ( `` Stop standing subprocess % d '' , pid ) + logging.debug ( 'Stop standing subprocess % d ' , pid ) _assert_subprocess_running ( proc ) + process = psutil.Process ( pid ) + success = True + for child in process.children ( recursive=True ) : + try : + child.kill ( ) + except : + success = False + logging.exception ( 'Failed
diff -- git a/mobly/controllers/android_device.py b/mobly/controllers/android_device.py index 3af1040..610091c 100644 -- - a/mobly/controllers/android_device.py +++ b/mobly/controllers/android_device.py @ @ -46,8 +46,8 @ @ ANDROID_DEVICE_NOT_LIST_CONFIG_MSG = 'Configuration should be a list , abort ! ' # Keys for attributes in configs that alternate the controller module behavior . KEY_DEVICE_REQUIRED = 'required' - # Default Timeout to wait for USB ON -DEFAULT_TIMEOUT_USB_ON = 5 * 60 + # Default Timeout to wait for boot completion +DEFAULT_TIMEOUT_BOOT_COMPLETION_SECOND = 15 * 60 class Error ( signals.ControllerError ) : @ @ -536,7 +536,7 @ @ class AndroidDevice ( object ) : action_that_reconnects_usb ( ) # Make sure device is reconnected before returning from this # context - ad.wait_for_adb_detection ( SOME_TIMEOUT ) + ad.adb.wait_for_device ( timeout=SOME_TIMEOUT ) `` '' '' self._stop_logcat_process ( ) # Only need to stop dispatcher because it continuously polling device @ @ -682,7 +682,8 @ @ class AndroidDevice ( object ) : mode per security restrictions. `` '' '' self.adb.root ( ) - self.adb.wait_for_device ( ) + self.adb.wait_for_device ( + timeout=DEFAULT_TIMEOUT_BOOT_COMPLETION_SECOND ) def load_snippet ( self , name , package ) : `` '' '' Starts the snippet apk with the given package name and connects . @ @ -920,33 +921,31 @ @ class AndroidDevice (
diff -- git a/mobly/base_test.py b/mobly/base_test.py index b3ccf43..7353afd 100644 -- - a/mobly/base_test.py +++ b/mobly/base_test.py @ @ -357,14 +357,11 @ @ class BaseTestClass ( object ) : except Exception as e : logging.exception ( e ) tr_record.add_error ( 'teardown_test ' , e ) - self._exec_procedure_func ( self._on_fail , tr_record ) except ( signals.TestFailure , AssertionError ) as e : tr_record.test_fail ( e ) - self._exec_procedure_func ( self._on_fail , tr_record ) except signals.TestSkip as e : # Test skipped . tr_record.test_skip ( e ) - self._exec_procedure_func ( self._on_skip , tr_record ) except ( signals.TestAbortClass , signals.TestAbortAll ) as e : # Abort signals , pass along . tr_record.test_fail ( e ) @ @ -372,15 +369,19 @ @ class BaseTestClass ( object ) : except signals.TestPass as e : # Explicit test pass . tr_record.test_pass ( e ) - self._exec_procedure_func ( self._on_pass , tr_record ) except Exception as e : # Exception happened during test . tr_record.test_error ( e ) - self._exec_procedure_func ( self._on_fail , tr_record ) else : tr_record.test_pass ( ) - self._exec_procedure_func ( self._on_pass , tr_record ) finally : + if tr_record.result in ( records.TestResultEnums.TEST_RESULT_ERROR , + records.TestResultEnums.TEST_RESULT_FAIL ) : + self._exec_procedure_func ( self._on_fail , tr_record ) + elif tr_record.result == records.TestResultEnums.TEST_RESULT_PASS
diff -- git a/.travis.yml b/.travis.yml index cc15a37..2578ab0 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -13,14 +13,10 @ @ cache : matrix : include : - - env : BUILD=cabal GHCVER=7.10.3 CABALVER=1.22 - addons : { apt : { packages : [ cabal-install-1.22 , ghc-7.10.3 ] , sources : [ hvr-ghc ] } } - env : BUILD=cabal GHCVER=8.0.1 CABALVER=1.24 addons : { apt : { packages : [ cabal-install-1.24 , ghc-8.0.1 ] , sources : [ hvr-ghc ] } } - env : BUILD=cabal GHCVER=8.2.1 CABALVER=2.0 addons : { apt : { packages : [ cabal-install-2.0 , ghc-8.2.1 ] , sources : [ hvr-ghc ] } } - - env : BUILD=stack STACK='stack -- resolver=lts-6.22' - addons : { apt : { packages : [ libgmp-dev ] } } - env : BUILD=stack STACK='stack -- resolver=lts-7.4' addons : { apt : { packages : [ libgmp-dev ] } } - env : BUILD=stack STACK='stack -- resolver=lts-8.24' diff -- git a/README.md b/README.md index ac9c73f..9f12a4c 100644 -- - a/README.md +++ b/README.md @ @ -96,7 +96,7 @ @ will generate the haskell files ` Proto/Project/ { Foo , Bar } .hs ` . - Services are not supported . - Extensions (
diff -- git a/proto-lens-tests/proto-lens-tests.cabal b/proto-lens-tests/proto-lens-tests.cabal index 72f0808..92c38ea 100644 -- - a/proto-lens-tests/proto-lens-tests.cabal +++ b/proto-lens-tests/proto-lens-tests.cabal @ @ -127,6 +127,7 @ @ Test-Suite text_format_test hs-source-dirs : tests build-depends : HUnit , base + , bytestring , lens-family , pretty , proto-lens @ @ -134,6 +135,7 @ @ Test-Suite text_format_test , proto-lens-tests , test-framework , test-framework-hunit + , text Test-Suite enum_test default-language : Haskell2010 diff -- git a/proto-lens-tests/tests/canonical.proto b/proto-lens-tests/tests/canonical.proto index 5134ec9..b3c11b7 100644 -- - a/proto-lens-tests/tests/canonical.proto +++ b/proto-lens-tests/tests/canonical.proto @ @ -19,3 +19,8 @ @ message Test3 { message Test4 { repeated int32 d = 4 [ packed=true ] ; } + +message Test5 { + required bytes e = 1 ; + } + diff -- git a/proto-lens-tests/tests/text_format_test.hs b/proto-lens-tests/tests/text_format_test.hs index 2a0af78..4ff1175 100644 -- - a/proto-lens-tests/tests/text_format_test.hs +++ b/proto-lens-tests/tests/text_format_test.hs @ @ -7,6 +7,11 @ @ { - # LANGUAGE OverloadedStrings # - } module Main where +import qualified Data.ByteString +import Data.Char ( ord ) +import Data.Monoid ( ( < > ) ) +import qualified Data.Text.Lazy +import Data.Word ( Word8 ) import Data.ProtoLens ( def , Message , showMessage , showMessageShort , pprintMessage ) import Lens.Family2 ( ( & ) , ( .~ ) ) @ @ -29,6 +34,9 @ @ def3 = def def4 : : Test4
diff -- git a/proto-lens-descriptors/src/Proto/Google/Protobuf/Compiler/Plugin.hs b/proto-lens-descriptors/src/Proto/Google/Protobuf/Compiler/Plugin.hs index 898bf4a..8e5d3fc 100644 -- - a/proto-lens-descriptors/src/Proto/Google/Protobuf/Compiler/Plugin.hs +++ b/proto-lens-descriptors/src/Proto/Google/Protobuf/Compiler/Plugin.hs @ @ -25,22 +25,26 @ @ data CodeGeneratorRequest = CodeGeneratorRequest { _CodeGeneratorRequest'fileToGen ! ( Prelude.Maybe Data.Text.Text ) , _CodeGeneratorRequest'protoFile : : ! [ Proto.Google.Protobuf.Descriptor.FileDescriptorProto ] } - deriving ( Prelude.Show , Prelude.Eq ) + deriving ( Prelude.Show , Prelude.Eq , Prelude.Ord ) instance ( a ~ [ Data.Text.Text ] , b ~ [ Data.Text.Text ] , Prelude.Functor f ) = > Lens.Labels.HasLens `` fileToGenerate '' f CodeGeneratorRequest CodeGeneratorRequest a b where lensOf _ - = Lens.Family2.Unchecked.lens _CodeGeneratorRequest'fileToGenerate - ( \ x__ y__ - > x__ { _CodeGeneratorRequest'fileToGenerate = y__ } ) + = ( Prelude.. ) + ( Lens.Family2.Unchecked.lens _CodeGeneratorRequest'fileToGenerate + ( \ x__ y__ - > x__ { _CodeGeneratorRequest'fileToGenerate = y__ } ) ) + Prelude.id instance ( a ~ Data.Text.Text , b ~ Data.Text.Text , Prelude.Functor f ) = > Lens.Labels.HasLens `` parameter '' f CodeGeneratorRequest CodeGeneratorRequest a b where lensOf _ - = ( Prelude.. ) maybe'parameter + = ( Prelude.. ) + ( Lens.Family2.Unchecked.lens _CodeGeneratorRequest'parameter + ( \ x__ y__ - > x__ { _CodeGeneratorRequest'parameter = y__ } ) ) ( Data.ProtoLens.maybeLens Data.ProtoLens.fieldDefault ) instance ( a ~ Prelude.Maybe Data.Text.Text , @ @
diff -- git a/proto-lens-protoc/src/Data/ProtoLens/Compiler/Generate.hs b/proto-lens-protoc/src/Data/ProtoLens/Compiler/Generate.hs index 81b2719..a86e37a 100644 -- - a/proto-lens-protoc/src/Data/ProtoLens/Compiler/Generate.hs +++ b/proto-lens-protoc/src/Data/ProtoLens/Compiler/Generate.hs @ @ -36,14 +36,15 @ @ import Proto.Google.Protobuf.Descriptor , FieldDescriptorProto'Label ( .. ) , FieldDescriptorProto'Type ( .. ) , FileDescriptorProto + , FieldOptions , defaultValue , label , mapEntry , maybe'oneofIndex + , maybe'packed , name , number , options - , packed , syntax , type' , typeName @ @ -642,7 +643,7 @ @ fieldAccessorExpr syntaxType env f = accessorCon @ @ Var ( UnQual hsFieldName ) @ @ fromString ( overloadedField k ) @ @ fromString ( overloadedField v ) | otherwise - > `` Data.ProtoLens.RepeatedField '' - @ @ if fd ^ . options.packed + @ @ if isPackedField syntaxType fd then `` Data.ProtoLens.Packed '' else `` Data.ProtoLens.Unpacked '' hsFieldName @ @ -660,6 +661,19 @ @ isDefaultingOptional syntaxType f -- For now , we treat oneof 's like proto2 optional fields . & & isNothing ( f ^ . maybe'oneofIndex ) +isPackedField : : SyntaxType - > FieldDescriptorProto - > Bool +isPackedField s f = case f ^ . options . maybe'packed of + Just t - > t + -- proto3 fields are packed by default . Annoyingly , we need to +
diff -- git a/proto-lens-protoc/src/Definitions.hs b/proto-lens-protoc/src/Definitions.hs index 4688121..548156c 100644 -- - a/proto-lens-protoc/src/Definitions.hs +++ b/proto-lens-protoc/src/Definitions.hs @ @ -14,6 +14,7 @ @ module Definitions , MessageInfo ( .. ) , FieldInfo ( .. ) , EnumInfo ( .. ) + , EnumValueInfo ( .. ) , qualifyEnv , unqualifyEnv , collectDefinitions @ @ -21,6 +22,8 @ @ module Definitions ) where import Data.Char ( toUpper ) +import Data.Int ( Int32 ) +import Data.List ( mapAccumL ) import qualified Data.Map as Map import Data.Maybe ( fromMaybe ) import Data.Monoid @ @ -32,6 +35,7 @ @ import Lens.Family2 ( ( ^ . ) ) import Bootstrap.Proto.Google.Protobuf.Descriptor ( DescriptorProto , EnumDescriptorProto + , EnumValueDescriptorProto , FieldDescriptorProto , FileDescriptorProto , enumType @ @ -39,6 +43,7 @ @ import Bootstrap.Proto.Google.Protobuf.Descriptor , messageType , name , nestedType + , number , package , typeName , value @ @ -81,9 +86,18 @ @ data FieldInfo = FieldInfo data EnumInfo n = EnumInfo { enumName : : n , enumDescriptor : : EnumDescriptorProto - , enumValueNames : : [ n ] - -- ^ The Haskell name of each enum value . - -- This corresponds 1-1 with `` value '' in EnumDescriptorProto . + , enumValues : : [ EnumValueInfo
diff -- git a/docs/tutorial.md b/docs/tutorial.md index 1e88a15..2f7d3b2 100644 -- - a/docs/tutorial.md +++ b/docs/tutorial.md @ @ -42,8 +42,9 @ @ Notice ` _Foo'_unknownFields : : ! Data.ProtoLens.FieldSet ` ; it stores fields that Instances generated are : * ` Lens.Labels.HasLens ` and ` Lens.Labels.HasLens ' ` are for overloading field names ( see [ Field Overloading ] ( # field-overloading ) . -* ` Data.Default.Class.Default ` for having [ default message values ] ( https : //developers.google.com/protocol-buffers/docs/proto3 # default ) . -* ` Data.ProtoLens.Message ` for enabling serialization by providing reflection of all of the fields that may be used by this type . +* ` Data.ProtoLens.Message ` for having [ default message values ] and enabling serialization by providing reflection of all of the fields that may be used by this type . + + [ default message values ] : https : //developers.google.com/protocol-buffers/docs/proto3 # default # # Oneof Generation @ @ -102,7 +103,7 @ @ accessBaz foo = foo -- | Creates a 'Foo ' with an incoming 'Int32' createFoo : : Int32 - > Foo -createFoo i = def & maybe'bar .~ ( _Just # _Foo'Baz # i ) +createFoo i = defMessage & maybe'bar .~ ( _Just
diff -- git a/proto-lens-protoc/src/Data/ProtoLens/Compiler/Definitions.hs b/proto-lens-protoc/src/Data/ProtoLens/Compiler/Definitions.hs index 5b1d3f7..7e171c3 100644 -- - a/proto-lens-protoc/src/Data/ProtoLens/Compiler/Definitions.hs +++ b/proto-lens-protoc/src/Data/ProtoLens/Compiler/Definitions.hs @ @ -12,9 +12,10 @ @ module Data.ProtoLens.Compiler.Definitions ( Env , Definition ( .. ) , MessageInfo ( .. ) - , OneofInfo ( .. ) - , OneofFieldInfo ( .. ) , FieldInfo ( .. ) + , OneofInfo ( .. ) + , OneofCase ( .. ) + , FieldName ( .. ) , EnumInfo ( .. ) , EnumValueInfo ( .. ) , qualifyEnv @ @ -25,9 +26,9 @ @ module Data.ProtoLens.Compiler.Definitions import Data.Char ( isUpper , toUpper ) import Data.Int ( Int32 ) -import Data.List ( mapAccumL ) +import Data.List ( mapAccumL , foldl ' ) import qualified Data.Map as Map -import Data.Maybe ( fromMaybe , isNothing ) +import Data.Maybe ( fromMaybe ) import Data.Monoid import qualified Data.Set as Set import Data.String ( fromString ) @ @ -78,32 +79,45 @ @ data Definition n = Message ( MessageInfo n ) | Enum ( EnumInfo n ) data MessageInfo n = MessageInfo { messageName : : n -- ^ Haskell type name , messageDescriptor : : DescriptorProto - , messageFields : : [ FieldInfo ] - -- ^ The Haskell names for each field
diff -- git a/proto-lens-protoc/src/Data/ProtoLens/Compiler/Definitions.hs b/proto-lens-protoc/src/Data/ProtoLens/Compiler/Definitions.hs index 5b1d3f7..546aa45 100644 -- - a/proto-lens-protoc/src/Data/ProtoLens/Compiler/Definitions.hs +++ b/proto-lens-protoc/src/Data/ProtoLens/Compiler/Definitions.hs @ @ -7,14 +7,20 @ @ -- | This module takes care of collecting all the definitions in a .proto file -- and assigning Haskell names to all of the defined things ( messages , enums -- and field names ) . - { - # LANGUAGE DeriveFunctor , OverloadedStrings # - } + { - # LANGUAGE DeriveFunctor # - } + { - # LANGUAGE GeneralizedNewtypeDeriving # - } + { - # LANGUAGE OverloadedStrings # - } module Data.ProtoLens.Compiler.Definitions ( Env , Definition ( .. ) , MessageInfo ( .. ) - , OneofInfo ( .. ) - , OneofFieldInfo ( .. ) , FieldInfo ( .. ) + , OneofInfo ( .. ) + , OneofCase ( .. ) + , FieldName ( .. ) + , Symbol + , nameFromSymbol + , promoteSymbol , EnumInfo ( .. ) , EnumValueInfo ( .. ) , qualifyEnv @ @ -25,12 +31,12 @ @ module Data.ProtoLens.Compiler.Definitions import Data.Char ( isUpper , toUpper ) import Data.Int ( Int32 ) -import Data.List ( mapAccumL ) +import Data.List ( mapAccumL , foldl ' ) import qualified Data.Map as
diff -- git a/proto-lens-discrimination/LICENSE b/proto-lens-discrimination/LICENSE new file mode 100644 index 0000000..6905853 -- - /dev/null +++ b/proto-lens-discrimination/LICENSE @ @ -0,0 +1,30 @ @ +Copyright ( c ) 2016 , Google Inc. + +All rights reserved . + +Redistribution and use in source and binary forms , with or without +modification , are permitted provided that the following conditions are met : + + * Redistributions of source code must retain the above copyright + notice , this list of conditions and the following disclaimer . + + * Redistributions in binary form must reproduce the above + copyright notice , this list of conditions and the following + disclaimer in the documentation and/or other materials provided + with the distribution . + + * Neither the name of Google Inc. nor the names of other + contributors may be used to endorse or promote products derived + from this software without specific prior written permission . + +THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS + '' AS IS '' AND ANY EXPRESS OR IMPLIED WARRANTIES , INCLUDING , BUT NOT +LIMITED TO , THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR +A PARTICULAR PURPOSE ARE DISCLAIMED . IN
diff -- git a/index.js b/index.js index d51703e..57e25f8 100755 -- - a/index.js +++ b/index.js @ @ -140,7 +140,7 @ @ const LOG = { UNTITLED_SCRIPT_TITLE : 'Untitled Script ' , VERSION_CREATE : 'Creating a new version ... ' , VERSION_CREATED : ( versionNumber ) = > ` Created version $ { versionNumber } . ` , - VERSION_DESCRIPTION : ( { versionNumber , description } ) = > ` $ { versionNumber } - $ { description || ' ( no description ) ' } ` , + VERSION_DESCRIPTION : ( { versionNumber , description } ) = > ` $ { versionNumber } - $ { description || ' ( no description ) ' } ` , VERSION_NUM : ( numVersions ) = > ` ~ $ { numVersions } $ { pluralize ( 'Version ' , numVersions ) } ~ ` , } ; @ @ -153,6 +153,7 @ @ Forgot $ { PROJECT_NAME } commands ? Get help : \n $ { PROJECT_NAME } -- help ` , DEPLOYMENT_COUNT : ` Unable to deploy ; Only one deployment can be created at a time ` , FOLDER_EXISTS : ` Project file ( $ { DOT.PROJECT.PATH } ) already
diff -- git a/EarlGrey/Action/GREYActions.m b/EarlGrey/Action/GREYActions.m index 4f53d6c..41fc9ee 100644 -- - a/EarlGrey/Action/GREYActions.m +++ b/EarlGrey/Action/GREYActions.m @ @ -329,7 +329,35 @ @ if ( [ element grey_isWebAccessibilityElement ] ) { [ GREYActions grey_webSetText : element text : text ] ; } else { + BOOL elementIsUITextField = [ element isKindOfClass : [ UITextField class ] ] ; + + // Did begin editing notifications . + [ element sendActionsForControlEvents : UIControlEventEditingDidBegin ] ; + if ( elementIsUITextField ) { + NSNotification *notification = + [ NSNotification notificationWithName : UITextFieldTextDidBeginEditingNotification object : element ] ; + [ NSNotificationCenter.defaultCenter postNotification : notification ] ; + } + + // Actually change the text . [ element setText : text ] ; + + // Did change editing notifications . + [ element sendActionsForControlEvents : UIControlEventEditingChanged ] ; + if ( elementIsUITextField ) { + NSNotification *notification = + [ NSNotification notificationWithName : UITextFieldTextDidChangeNotification object : element ] ; + [ NSNotificationCenter.defaultCenter postNotification : notification ] ; + } + + // Did end editing notifications . + [ element sendActionsForControlEvents : UIControlEventEditingDidEndOnExit ] ; + [ element sendActionsForControlEvents : UIControlEventEditingDidEnd ] ; + if ( elementIsUITextField ) { + NSNotification *notification = + [ NSNotification
diff -- git a/gem/lib/earlgrey/configure_earlgrey.rb b/gem/lib/earlgrey/configure_earlgrey.rb new file mode 100644 index 0000000..d2de776 -- - /dev/null +++ b/gem/lib/earlgrey/configure_earlgrey.rb @ @ -0,0 +1,403 @ @ + # + # Copyright 2016 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + + # global export for unqualified use in Pods file +def configure_for_earlgrey ( *args ) + EarlGrey.configure_for_earlgrey ( *args ) +end + +module EarlGrey + class < < self + attr_accessor : swift , : carthage + attr_reader : project_name , : test_target , : test_target_name , : scheme_file , :
diff -- git a/EarlGrey/Common/GREYAppleInternals.h b/EarlGrey/Common/GREYAppleInternals.h index 13e8dfa..5a9c191 100644 -- - a/EarlGrey/Common/GREYAppleInternals.h +++ b/EarlGrey/Common/GREYAppleInternals.h @ @ -146,6 +146,17 @ @ IOHIDEventRef IOHIDEventCreateDigitizerFingerEvent ( CFAllocatorRef allocator , * UITouch objects , and the relevant touch interaction state . */ - ( UITouchesEvent * ) _touchesEvent ; + +/** + * Sends a motion began event for the specified subtype . + */ +- ( void ) _sendMotionBegan : ( UIEventSubtype ) subtype ; + +/** + * Sends a motion ended event for the specified subtype . + */ +- ( void ) _sendMotionEnded : ( UIEventSubtype ) subtype ; + @ end @ interface UIScrollView ( GREYExposed ) diff -- git a/EarlGrey/Core/EarlGreyImpl.h b/EarlGrey/Core/EarlGreyImpl.h index 031fc13..dbf8e99 100644 -- - a/EarlGrey/Core/EarlGreyImpl.h +++ b/EarlGrey/Core/EarlGreyImpl.h @ @ -134,8 +134,8 @ @ typedef NS_ENUM ( NSInteger , GREYKeyboardDismissalErrorCode ) { * will be registered . * * @ param deviceOrientation The desired orientation of the device . - * @ param [ out ] errorOrNil Error that will be populated on failure . If @ c nil , a test - * failure will be reported if the rotation attempt fails . + * @ param [ out ] errorOrNil Error that will be populated on
diff -- git a/gem/Gemfile b/gem/Gemfile index 3384fe1..5532e86 100644 -- - a/gem/Gemfile +++ b/gem/Gemfile @ @ -16,8 +16,3 @ @ source 'https : //rubygems.org' gemspec - -gem 'coveralls ' , require : false -gem 'rspec' -gem 'rubocop' -gem 'thor ' # enable : bundle exec thor spec diff -- git a/gem/Rakefile b/gem/Rakefile index 2003e7b..9452eea 100644 -- - a/gem/Rakefile +++ b/gem/Rakefile @ @ -24,13 +24,14 @ @ require_relative 'support/bump' # Skip tagging the repo on Gem releases because that'll # conflict with EarlGrey carthage tagged releases . raise `` Ca n't find tag_version to patch '' unless Bundler : :GemHelper.instance.method ( : tag_version ) + class Bundler : :GemHelper def tag_version nil end end -task default : [ : spec , : rubocop , : warn ] +task default : % i [ spec rubocop warn ] # rake spec RSpec : :Core : :RakeTask.new do |task| diff -- git a/gem/bin/earlgrey b/gem/bin/earlgrey index 6d7b92c..68c1da1 100644 -- - a/gem/bin/earlgrey +++ b/gem/bin/earlgrey @ @ -15,6 +15,6 @ @ # See the License for the specific language governing permissions and # limitations under the License . -require_relative '../lib/earlgrey' +require 'earlgrey/cli' EarlGrey : :CLI.start diff -- git a/gem/earlgrey.gemspec b/gem/earlgrey.gemspec index 550271d..af011f1 100644 -- - a/gem/earlgrey.gemspec +++
diff -- git a/CONTRIBUTING.md b/CONTRIBUTING.md index 0acf517..2df0ce9 100644 -- - a/CONTRIBUTING.md +++ b/CONTRIBUTING.md @ @ -66,6 +66,8 @ @ The submitted code should adhere to the following : clarifications for every issue created . * For in-depth discussions please use the [ EarlGrey Google Group ] ( https : //groups.google.com/forum/ # ! forum/earlgrey-discuss ) instead of starting a Github Issue . +* In case of an API update , please make sure the changes are documented in the [ cheatsheet.html ] ( ./docs/cheatsheet/cheatsheet.html ) + file . The PDF and .PNG cheatsheet files are to be updated only when we update the EarlGrey CocoaPod . # # # Don'ts diff -- git a/Demo/EarlGreyExample/Images.xcassets/AppIcon.appiconset/Contents.json b/Demo/EarlGreyExample/Images.xcassets/AppIcon.appiconset/Contents.json index 6229cbc..03efe4a 100644 -- - a/Demo/EarlGreyExample/Images.xcassets/AppIcon.appiconset/Contents.json +++ b/Demo/EarlGreyExample/Images.xcassets/AppIcon.appiconset/Contents.json @ @ -75,4 +75,5 @ @ `` version '' : 1 , `` author '' : `` xcode '' } - } \ No newline at end of file + } + diff -- git a/EarlGrey.xcodeproj/project.pbxproj b/EarlGrey.xcodeproj/project.pbxproj index 30af699..b052da0 100644 -- - a/EarlGrey.xcodeproj/project.pbxproj +++ b/EarlGrey.xcodeproj/project.pbxproj @ @ -8,10 +8,8 @ @ /* Begin PBXBuildFile section */ 59A993281C99453200914F9A /* EarlGrey.h in Headers */ = { isa = PBXBuildFile ; fileRef = FD1001791C5B46C200B2DB0A /* EarlGrey.h */ ; settings = {
diff -- git a/.gitignore b/.gitignore index 7386e2b..149266f 100644 -- - a/.gitignore +++ b/.gitignore @ @ -32,6 +32,7 @ @ examples/statsassembly/statsassembly examples/arpscan/arpscan examples/bidirectional/bidirectional examples/bytediff/bytediff +examples/reassemblydump/reassemblydump layers/gen macs/gen pcap/pcap_tester diff -- git a/.travis.golint.sh b/.travis.golint.sh index 64c62ff..ed74c65 100755 -- - a/.travis.golint.sh +++ b/.travis.golint.sh @ @ -3,7 +3,7 @ @ cd `` $ ( dirname $ 0 ) '' go get github.com/golang/lint/golint -DIRS= '' . tcpassembly tcpassembly/tcpreader ip4defrag macs pcapgo pcap afpacket pfring routing '' +DIRS= '' . tcpassembly tcpassembly/tcpreader ip4defrag reassembly macs pcapgo pcap afpacket pfring routing '' # Add subdirectories here as we clean up golint on each . for subdir in $ DIRS ; do pushd $ subdir diff -- git a/.travis.yml b/.travis.yml index 141b06a..7d73126 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -3,10 +3,12 @ @ install : - go get github.com/google/gopacket - go get github.com/google/gopacket/layers - go get github.com/google/gopacket/tcpassembly + - go get github.com/google/gopacket/reassembly script : - go test github.com/google/gopacket - go test github.com/google/gopacket/layers - go test github.com/google/gopacket/tcpassembly + - go test github.com/google/gopacket/reassembly - ./.travis.gofmt.sh - ./.travis.govet.sh - ./.travis.golint.sh diff -- git a/decode.go b/decode.go index f10194b..ae65760 100644 -- - a/decode.go +++ b/decode.go @ @ -16,11 +16,15 @ @ type DecodeFeedback interface { // is shorter than internal layer variables
diff -- git a/dhcpv6.go b/dhcpv6.go new file mode 100644 index 0000000..6d12674 -- - /dev/null +++ b/dhcpv6.go @ @ -0,0 +1,479 @ @ +// Copyright 2018 Google , Inc. All rights reserved . +// +// Use of this source code is governed by a BSD-style license +// that can be found in the LICENSE file in the root of the source +// tree . + +package layers + +import ( + '' bytes '' + '' encoding/binary '' + '' errors '' + '' fmt '' + '' net '' + + '' github.com/google/gopacket '' + ) + +// DHCPv6MsgType represents a DHCPv6 operation +type DHCPv6MsgType byte + +// Constants that represent DHCP operations +const ( + DHCPv6MsgTypeUnspecified DHCPv6MsgType = iota + DHCPv6MsgTypeSolicit + DHCPv6MsgTypeAdverstise + DHCPv6MsgTypeRequest + DHCPv6MsgTypeConfirm + DHCPv6MsgTypeRenew + DHCPv6MsgTypeRebind + DHCPv6MsgTypeReply + DHCPv6MsgTypeRelease + DHCPv6MsgTypeDecline + DHCPv6MsgTypeReconfigure + DHCPv6MsgTypeInformationRequest + DHCPv6MsgTypeRelayForward + DHCPv6MsgTypeRelayReply + ) + +// String returns a string version of a DHCPv6MsgType . +func ( o DHCPv6MsgType ) String ( ) string { + switch o { + case DHCPv6MsgTypeUnspecified : + return `` Unspecified '' + case DHCPv6MsgTypeSolicit : + return `` Solicit '' + case DHCPv6MsgTypeAdverstise : + return `` Adverstise ''
diff -- git a/dhcpv6.go b/dhcpv6.go new file mode 100644 index 0000000..27b01a9 -- - /dev/null +++ b/dhcpv6.go @ @ -0,0 +1,420 @ @ +// Copyright 2018 Google , Inc. All rights reserved . +// +// Use of this source code is governed by a BSD-style license +// that can be found in the LICENSE file in the root of the source +// tree . + +package layers + +import ( + '' bytes '' + '' encoding/binary '' + '' errors '' + '' fmt '' + '' net '' + + '' github.com/google/gopacket '' + ) + +// DHCPv6MsgType represents a DHCPv6 operation +type DHCPv6MsgType byte + +// Constants that represent DHCP operations +const ( + DHCPv6MsgTypeUnspecified DHCPv6MsgType = iota + DHCPv6MsgTypeSolicit + DHCPv6MsgTypeAdverstise + DHCPv6MsgTypeRequest + DHCPv6MsgTypeConfirm + DHCPv6MsgTypeRenew + DHCPv6MsgTypeRebind + DHCPv6MsgTypeReply + DHCPv6MsgTypeRelease + DHCPv6MsgTypeDecline + DHCPv6MsgTypeReconfigure + DHCPv6MsgTypeInformationRequest + DHCPv6MsgTypeRelayForward + DHCPv6MsgTypeRelayReply + ) + +// String returns a string version of a DHCPv6MsgType . +func ( o DHCPv6MsgType ) String ( ) string { + switch o { + case DHCPv6MsgTypeUnspecified : + return `` Unspecified '' + case DHCPv6MsgTypeSolicit : + return `` Solicit '' + case DHCPv6MsgTypeAdverstise : + return `` Adverstise ''
diff -- git a/afpacket/header.go b/afpacket/header.go index 797712e..0b9918e 100644 -- - a/afpacket/header.go +++ b/afpacket/header.go @ @ -15,8 +15,6 @ @ import ( ) // # include < linux/if_packet.h > -// # include < linux/if_ether.h > -// # define VLAN_HLEN 4 import `` C '' // Our model of handling all TPacket versions is a little hacky , to say the @ @ -65,13 +63,6 @ @ func makeSlice ( start uintptr , length int ) ( data [ ] byte ) { return } -func insertVlanHeader ( data [ ] byte , vlanTCI int ) [ ] byte { - eth : = make ( [ ] byte , 0 , len ( data ) +C.VLAN_HLEN ) - eth = append ( eth , data [ 0 : C.ETH_ALEN*2 ] ... ) - eth = append ( eth , [ ] byte { 0x81 , 0 , byte ( ( vlanTCI > > 8 ) & 0xff ) , byte ( vlanTCI & 0xff ) } ... ) - return append ( eth , data [ C.ETH_ALEN*2 : ] ... ) - } - func ( h *v1header ) getStatus ( ) int { return int ( h.tp_status ) } @
diff -- git a/layers/base_test.go b/layers/base_test.go index a6a5ea9..bed5d4f 100644 -- - a/layers/base_test.go +++ b/layers/base_test.go @ @ -9,8 +9,9 @ @ package layers import ( - '' github.com/google/gopacket '' '' testing '' + + '' github.com/google/gopacket '' ) func min ( a , b int ) int { diff -- git a/layers/icmp6.go b/layers/icmp6.go index 5354a16..09afd11 100644 -- - a/layers/icmp6.go +++ b/layers/icmp6.go @ @ -24,12 +24,21 @ @ const ( ICMPv6TypeParameterProblem = 4 ICMPv6TypeEchoRequest = 128 ICMPv6TypeEchoReply = 129 + // The following are from RFC 4861 ICMPv6TypeRouterSolicitation = 133 ICMPv6TypeRouterAdvertisement = 134 ICMPv6TypeNeighborSolicitation = 135 ICMPv6TypeNeighborAdvertisement = 136 ICMPv6TypeRedirect = 137 + + // The following are from RFC 2710 + ICMPv6TypeMLDv1MulticastListenerQueryMessage = 130 + ICMPv6TypeMLDv1MulticastListenerReportMessage = 131 + ICMPv6TypeMLDv1MulticastListenerDoneMessage = 132 + + // The following are from RFC 3810 + ICMPv6TypeMLDv2MulticastListenerReportMessageV2 = 143 ) const ( @ @ -234,6 +243,18 @ @ func ( i *ICMPv6 ) NextLayerType ( ) gopacket.LayerType { return LayerTypeICMPv6NeighborAdvertisement case ICMPv6TypeRedirect : return LayerTypeICMPv6Redirect + case ICMPv6TypeMLDv1MulticastListenerQueryMessage : // Same Code for MLDv1 Query and MLDv2 Query + if len ( i.Payload ) > 20 { // Only payload size differs + return LayerTypeMLDv2MulticastListenerQuery + } else { + return LayerTypeMLDv1MulticastListenerQuery + } + case
diff -- git a/examples/bidirectional/main.go b/examples/bidirectional/main.go index 4b0b240..1d533e6 100644 -- - a/examples/bidirectional/main.go +++ b/examples/bidirectional/main.go @ @ -163,6 +163,10 @ @ func main ( ) { streamFactory : = & myFactory { bidiMap : make ( map [ key ] *bidi ) } streamPool : = tcpassembly.NewStreamPool ( streamFactory ) assembler : = tcpassembly.NewAssembler ( streamPool ) + // Limit memory usage by auto-flushing connection state if we get over 100K + // packets in memory , or over 1000 for a single stream . + assembler.MaxBufferedPagesTotal = 100000 + assembler.MaxBufferedPagesPerConnection = 1000 log.Println ( `` reading in packets '' ) // Read in packets , pass to assembler .
diff -- git a/tools/gcf_init/deploy_gcf.py b/tools/gcf_init/deploy_gcf.py index 43679c3..59d0219 100755 -- - a/tools/gcf_init/deploy_gcf.py +++ b/tools/gcf_init/deploy_gcf.py @ @ -1,5 +1,5 @ @ - # -*- coding : utf-8 -*- # ! /usr/bin/env python + # -*- coding : utf-8 -*- import subprocess import sys @ @ -11,7 +11,7 @ @ index_file = './index.yaml' if len ( sys.argv ) > 1 : function_names = [ sys.argv [ 1 ] ] else : - function_names = [ 'gettasks ' , 'getrecenttasks ' ] + function_names = [ 'gettasks ' , 'getrecenttasks ' , 'closetask ' , 'closetasks ' ] config.LoadConfig ( ) @ @ -19,7 +19,7 @ @ for function in function_names : print 'Deploying function { 0 : s } '.format ( function ) cmd = ( 'gcloud -- project { 0 : s } beta functions deploy { 1 : s } -- stage-bucket ' ' { 2 : s } -- region { 3 : s } -- trigger-http'.format ( config.PROJECT , function , - config.BUCKET_NAME , config.TURBINIA_REGION ) ) + config.BUCKET_NAME , config.TURBINIA_REGION ) ) print subprocess.check_call ( cmd , shell=True ) print '/nCreating Datastore index from { 0 : s } '.format ( index_file ) diff -- git a/tools/gcf_init/index.js b/tools/gcf_init/index.js
diff -- git a/requirements.txt b/requirements.txt index 1e84fb0..1f99921 100644 -- - a/requirements.txt +++ b/requirements.txt @ @ -4,3 +4,6 @ @ google-cloud-pubsub==0.26.0 google-cloud-storage==1.6.0 google-cloud-core==0.26.0 urllib3 [ secure ] +celery==4.1.0 +kombu==4.1.0 +redis==2.10.6 diff -- git a/tests/client.py b/tests/client.py index d449d7f..560a3e5 100644 -- - a/tests/client.py +++ b/tests/client.py @ @ -33,7 +33,8 @ @ class TestTurbiniaClient ( unittest.TestCase ) : @ mock.patch ( 'turbinia.client.task_manager.PSQTaskManager.setup ' ) def testTurbiniaClientInit ( self , _ ) : `` '' '' Basic test for client . '' '' '' - config.LoadConfig ( ) client = TurbiniaClient ( ) + config.LoadConfig ( ) + client = TurbiniaClient ( ) self.assertTrue ( hasattr ( client , 'task_manager ' ) ) @ mock.patch ( 'turbinia.client.GoogleCloudFunction.ExecuteFunction ' ) diff -- git a/tests/pubsub.py b/tests/pubsub.py index 4c9ac87..a38ffb2 100644 -- - a/tests/pubsub.py +++ b/tests/pubsub.py @ @ -22,6 +22,8 @ @ import mock from turbinia import evidence from turbinia import pubsub +from turbinia import message +from turbinia import celery from turbinia import TurbiniaException @ @ -31,7 +33,7 @ @ def getTurbiniaRequest ( ) : Returns : TurbiniaRequest object. `` '' '' - request = pubsub.TurbiniaRequest ( + request = message.TurbiniaRequest ( request_id='deadbeef ' , context= { 'kw ' : [ 1 , 2 ] } ) rawdisk =
diff -- git a/.travis.yml b/.travis.yml new file mode 100644 index 0000000..ea24c75 -- - /dev/null +++ b/.travis.yml @ @ -0,0 +1,11 @ @ +language : python +python : '2.7' +cache : + - pip + +install : + - pip install mock nose coverage + - pip install . + +script : + - ./run_tests.py diff -- git a/run_tests.py b/run_tests.py old mode 100644 new mode 100755 index 7f38293..41b8523 -- - a/run_tests.py +++ b/run_tests.py @ @ -1,3 +1,4 @ @ + # ! /usr/bin/env python # -*- coding : utf-8 -*- # Copyright 2016 Google Inc. # @ @ -14,17 +15,9 @ @ # limitations under the License . `` `` '' Script to run the tests . '' '' '' -import os -import sys -import unittest +import subprocess if __name__ == '__main__ ' : - base_dir = os.path.dirname ( os.path.abspath ( __file__ ) ) - # Change PYTHONPATH to include full path to turbinia . - sys.path.insert ( 0 , base_dir ) - - test_suite = unittest.TestLoader ( ) .discover ( - os.path.join ( base_dir , 'tests ' ) , pattern='*.py ' ) - test_results = unittest.TextTestRunner ( verbosity=2 ) .run ( test_suite ) - if not test_results.wasSuccessful ( ) :
diff -- git a/turbinia/pubsub.py b/turbinia/pubsub.py index fb9909f..495aecf 100644 -- - a/turbinia/pubsub.py +++ b/turbinia/pubsub.py @ @ -111,7 +111,8 @ @ class TurbiniaPubSub ( object ) : config.LoadConfig ( ) client = pubsub.Client ( project=config.PROJECT ) self.topic = client.topic ( self.topic_name ) - log.debug ( 'Connecting to PubSub Subscription on { 0 : s } '.format ( self.topic ) ) + log.debug ( 'Connecting to PubSub Subscription on { 0 : s } '.format ( + self.topic_name ) ) self.subscription = self.topic.subscription ( self.topic_name ) def _validate_message ( self , message ) : @ @ -133,7 +134,7 @ @ class TurbiniaPubSub ( object ) : return request def check_messages ( self ) : - `` '' '' Checks for a pubsub message . + `` '' '' Checks for pubsub messages . Returns : A list of any TurbiniaRequest objects received , else an empty list
diff -- git a/turbinia/turbiniactl.py b/turbinia/turbiniactl.py deleted file mode 100755 index 84d3ca1..0000000 -- - a/turbinia/turbiniactl.py +++ /dev/null @ @ -1,441 +0,0 @ @ - # ! /usr/bin/env python - # - # Copyright 2017 Google Inc. - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - # you may not use this file except in compliance with the License . - # You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software - # distributed under the License is distributed on an `` AS IS '' BASIS , - # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . - # See the License for the specific language governing permissions and - # limitations under the License . - '' '' '' Command line interface for Turbinia . '' '' '' - # pylint : disable=bad-indentation - -from __future__ import print_function -from __future__ import unicode_literals - -import argparse -import getpass -import logging -import os -import sys - -from turbinia.client import TurbiniaClient -from turbinia.client import TurbiniaCeleryClient
diff -- git a/app/elements/io-schedule-subnav.html b/app/elements/io-schedule-subnav.html index 78307cd..1c78eba 100644 -- - a/app/elements/io-schedule-subnav.html +++ b/app/elements/io-schedule-subnav.html @ @ -163,7 +163,7 @ @ Fired when the clears filter `` x '' is clicked . on-tap= '' toggleFilters '' > < span hidden $ = '' [ [ app.isPhoneSize ] ] '' > Filter < /span > < ! -- paper-icon-buttons supports its own disabled property . yay ! -- > - < paper-icon-button icon= '' io : filter-list '' aria-label= '' Filter list '' + < paper-icon-button icon= '' [ [ _computeFilterIcon ( showFilters ) ] ] '' aria-label= '' Filter list '' disabled= '' [ [ _disableFilterBtn ] ] '' > < /paper-icon-button > < /div > @ @ -284,6 +284,10 @ @ Fired when the clears filter `` x '' is clicked . clearFilters : function ( ) { this.fire ( 'filters-clear ' ) ; + } , + + _computeFilterIcon : function ( filtering ) { + return filtering ? 'io : close ' : 'io : filter-list ' ; } } ) diff -- git a/app/elements/io-schedule.scss b/app/elements/io-schedule.scss index 337be1e..2aaf713 100644 -- - a/app/elements/io-schedule.scss +++ b/app/elements/io-schedule.scss @ @ -188,7 +188,7 @ @ $ filterBannerHeight : 72px ; } .filters__panel { -
diff -- git a/backend/cron.yaml.template b/backend/cron.yaml.template index af52824..a014d0f 100644 -- - a/backend/cron.yaml.template +++ b/backend/cron.yaml.template @ @ -8,6 +8,9 @ @ cron : - description : sync schedule data url : $ PREFIX $ /sync/gcs schedule : every 30 minutes +- description : user data wipeout + url : $ PREFIX $ /task/wipeout + schedule : every 24 hours # - description : sessions start notifications # url : $ PREFIX $ /task/clock # schedule : every 1 minutes diff -- git a/backend/handler.go b/backend/handler.go index 71b1541..8c364ec 100644 -- - a/backend/handler.go +++ b/backend/handler.go @ @ -73,6 +73,7 @ @ func registerHandlers ( ) { handle ( `` /task/ping-user '' , handlePingUser ) handle ( `` /task/ping-device '' , handlePingDevice ) handle ( `` /task/clock '' , handleClock ) + handle ( `` /task/wipeout '' , handleWipeout ) // debug handlers ; not available in prod if ! isProd ( ) || isDevServer ( ) { handle ( `` /debug/srvget '' , debugServiceGetURL ) @ @ -777,6 +778,35 @ @ func handleClock ( w http.ResponseWriter , r *http.Request ) { } } +// handleWipeout deletes any user that has been inactive for 30 days or more +// It must be run every day +func
diff -- git a/app/scripts/helper/elements.js b/app/scripts/helper/elements.js index 14b123a..c9c010c 100644 -- - a/app/scripts/helper/elements.js +++ b/app/scripts/helper/elements.js @ @ -302,6 +302,13 @ @ IOWA.Elements = ( function ( ) { IOWA.Elements.GoogleSignIn.signIn ( ) ; } ; + template.keyboardSignIn = function ( e ) { + // Listen for Enter or Space press + if ( e.keyCode === 13 || e.keyCode === 32 ) { + this.signIn ( ) ; + } + } ; + template.signOut = function ( e ) { if ( e ) { e.preventDefault ( ) ; @ @ -314,6 +321,13 @ @ IOWA.Elements = ( function ( ) { IOWA.Elements.GoogleSignIn.signOut ( ) ; } ; + template.keyboardSignOut = function ( e ) { + // Listen for Enter or Space press + if ( e.keyCode === 13 || e.keyCode === 32 ) { + this.signOut ( ) ; + } + } ; + template.initFabScroll = function ( ) { if ( this.app.isPhoneSize ) { return ; diff -- git a/app/templates/layout_full.html b/app/templates/layout_full.html index 7e5a324..7c32828 100644 -- - a/app/templates/layout_full.html +++ b/app/templates/layout_full.html @ @ -286,7 +286,7 @ @ limitations under the License . < ! -- Note : Use on-click instead of on-tap so oauth popup is not blocked . Needs
diff -- git a/portability-gateway/src/main/java/org/dataportabilityproject/gateway/PortabilityAuthServiceProviderRegistry.java b/portability-gateway/src/main/java/org/dataportabilityproject/gateway/PortabilityAuthServiceProviderRegistry.java new file mode 100644 index 0000000..c83e351 -- - /dev/null +++ b/portability-gateway/src/main/java/org/dataportabilityproject/gateway/PortabilityAuthServiceProviderRegistry.java @ @ -0,0 +1,58 @ @ +/* + * Copyright 2018 The Data-Portability Project Authors . + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * https : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ + +package org.dataportabilityproject.gateway ; + +import com.google.common.base.Preconditions ; +import com.google.common.collect.ImmutableMap ; +import com.google.common.collect.ImmutableSet ; +import java.util.List ; +import java.util.Map ; +import org.dataportabilityproject.spi.gateway.auth.AuthDataGenerator ; +import org.dataportabilityproject.spi.gateway.auth.AuthServiceProvider ; +import org.dataportabilityproject.spi.gateway.auth.AuthServiceProviderRegistry ; +import org.dataportabilityproject.types.transfer.PortableType ; + +public class PortabilityAuthServiceProviderRegistry implements AuthServiceProviderRegistry { + + private ImmutableMap < String , AuthServiceProvider >
diff -- git a/portability-api/src/main/java/org/dataportabilityproject/webapp/ApiServer.java b/portability-api/src/main/java/org/dataportabilityproject/webapp/ApiServer.java new file mode 100644 index 0000000..b7d8675 -- - /dev/null +++ b/portability-api/src/main/java/org/dataportabilityproject/webapp/ApiServer.java @ @ -0,0 +1,58 @ @ +/* +* Copyright 2017 The Data-Portability Project Authors . +* +* Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +* you may not use this file except in compliance with the License . +* You may obtain a copy of the License at +* +* https : //www.apache.org/licenses/LICENSE-2.0 +* +* Unless required by applicable law or agreed to in writing , software +* distributed under the License is distributed on an `` AS IS '' BASIS , +* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +* See the License for the specific language governing permissions and +* limitations under the License . +*/ +package org.dataportabilityproject.webapp ; + +import com.google.inject.Inject ; +import com.sun.net.httpserver.HttpHandler ; +import com.sun.net.httpserver.HttpServer ; +import java.io.IOException ; +import java.net.InetSocketAddress ; +import java.util.Map ; +import java.util.Map.Entry ; +import java.util.concurrent.Executors ; +import org.slf4j.Logger ; +import org.slf4j.LoggerFactory ; + +/** Server that handles requests to API/web server . */ +final class ApiServer { + private final Logger logger = LoggerFactory.getLogger ( ApiServer.class ) ; + +
diff -- git a/portability-api/src/main/java/org/dataportabilityproject/webapp/ApiServer.java b/portability-api/src/main/java/org/dataportabilityproject/webapp/ApiServer.java new file mode 100644 index 0000000..b7d8675 -- - /dev/null +++ b/portability-api/src/main/java/org/dataportabilityproject/webapp/ApiServer.java @ @ -0,0 +1,58 @ @ +/* +* Copyright 2017 The Data-Portability Project Authors . +* +* Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +* you may not use this file except in compliance with the License . +* You may obtain a copy of the License at +* +* https : //www.apache.org/licenses/LICENSE-2.0 +* +* Unless required by applicable law or agreed to in writing , software +* distributed under the License is distributed on an `` AS IS '' BASIS , +* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +* See the License for the specific language governing permissions and +* limitations under the License . +*/ +package org.dataportabilityproject.webapp ; + +import com.google.inject.Inject ; +import com.sun.net.httpserver.HttpHandler ; +import com.sun.net.httpserver.HttpServer ; +import java.io.IOException ; +import java.net.InetSocketAddress ; +import java.util.Map ; +import java.util.Map.Entry ; +import java.util.concurrent.Executors ; +import org.slf4j.Logger ; +import org.slf4j.LoggerFactory ; + +/** Server that handles requests to API/web server . */ +final class ApiServer { + private final Logger logger = LoggerFactory.getLogger ( ApiServer.class ) ; + +
diff -- git a/.travis.yml b/.travis.yml index 9e4cf9a..35b0858 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -48,3 +48,11 @ @ notifications : secure : U+Xfg5/isDKa6JWpy98kauwcirWDAGlmVYcqBRkNBztH6uKvpJQX94Ftj3ciRyWU4f2Dm+fmBRtMnCsRBOied7XK8r+J/MFL7E+jP3FHT/3v/sRROhS15nX3vPPJDVMpU5G3UDe2d1n8VE6RyK6a6bGvOaFFBnt9WLdyoKKmM2gmR6ie/iBIJlQdYy4nMuu8Q0ExDuEX6gWCAyCzl9iC3uUHHOPCCuQPiEDD9zN17UYI+kbcYNjIbVJItyjGG9W3oBcVZm7Rn8mpB+kaV33iioMqz6oUC5vzPjwDw0vVk9AivZH1GQDhDvuJMFvFgJ5w7lj+rV6J6c9RvpHpMTZGFy4Fx7HoaTukqO53g74Vz63c9ql/L+hRXbkO7pkfB4PQJSpdF0Dc7Zq8hRZMcoMo6YW0+zYH0PtSESMo4+FK8WtmBtRwKcWCAaPdsDsYtnhj3ezjLijEqeKuk98AaV11Dik+C6/xmhmmfWqe+JizmSnCrRQz4h7H/2vsX8KSDip8hftvimjRkx0nYLsEwEjy7k5QmFsJ8zK47XJPUxiEimW86xoOP9Jesvtx+Ns+vRNa6wqXok2WM5cwD2oYQ7xdopBh98rQdrQiKnwFU6NE8us1tyKNwnJ2xuNrXbt+7PcJodCXTIlOkQIIAGUQx2CAR4TLAk564e/hqD+GW9102zw= on_success : change # default : always on_failure : always # default : always + + # Deploy the demo docker image to Docker Hub +deploy : + provider : script + script : bash docker_push + skip_cleanup : true + on : + branch : master diff -- git a/docker_push.sh b/docker_push.sh new file mode 100644 index 0000000..35b87b0 -- - /dev/null +++ b/docker_push.sh @ @ -0,0 +1,8 @ @ + # ! /bin/bash + + # Script used to push new docker images to docker hug by travis . + +./gradlew -PcloudType=local : distributions : demo-server : dockerize + # These envionment variable 's are set via the Travis UI/CLI +echo `` $ DOCKER_PASSWORD '' | docker login -u `` $ DOCKER_USERNAME '' -- password-stdin +docker push datatransferproject/demo
diff -- git a/extensions/data-transfer/portability-data-transfer-flickr/src/main/java/org/dataportabilityproject/datatransfer/flickr/photos/FlickrPhotosImporter.java b/extensions/data-transfer/portability-data-transfer-flickr/src/main/java/org/dataportabilityproject/datatransfer/flickr/photos/FlickrPhotosImporter.java index b656bd3..a3af120 100644 -- - a/extensions/data-transfer/portability-data-transfer-flickr/src/main/java/org/dataportabilityproject/datatransfer/flickr/photos/FlickrPhotosImporter.java +++ b/extensions/data-transfer/portability-data-transfer-flickr/src/main/java/org/dataportabilityproject/datatransfer/flickr/photos/FlickrPhotosImporter.java @ @ -27,8 +27,15 @ @ import com.flickr4java.flickr.uploader.UploadMetaData ; import com.flickr4java.flickr.uploader.Uploader ; import com.google.common.annotations.VisibleForTesting ; import com.google.common.base.Strings ; +import java.io.BufferedInputStream ; +import java.io.IOException ; +import java.net.HttpURLConnection ; +import java.net.URL ; +import java.util.Collection ; +import java.util.UUID ; import org.dataportabilityproject.spi.cloud.storage.JobStore ; import org.dataportabilityproject.spi.transfer.provider.ImportResult ; +import org.dataportabilityproject.spi.transfer.provider.ImportResult.ResultType ; import org.dataportabilityproject.spi.transfer.provider.Importer ; import org.dataportabilityproject.spi.transfer.types.TempPhotosData ; import org.dataportabilityproject.types.transfer.auth.AppCredentials ; @ @ -37,12 +44,6 @ @ import org.dataportabilityproject.types.transfer.models.photos.PhotoAlbum ; import org.dataportabilityproject.types.transfer.models.photos.PhotoModel ; import org.dataportabilityproject.types.transfer.models.photos.PhotosContainerResource ; -import java.io.BufferedInputStream ; -import java.io.IOException ; -import java.net.HttpURLConnection ; -import java.net.URL ; -import java.util.UUID ; - public class FlickrPhotosImporter implements Importer < AuthData , PhotosContainerResource > { @ VisibleForTesting static final String CACHE_ALBUM_METADATA_PREFIX = `` meta- '' ; @ VisibleForTesting static final String COPY_PREFIX = `` Copy of - `` ; @ @ -88,38 +89,50 @ @ public class FlickrPhotosImporter implements Importer < AuthData , PhotosContainerR jobStore.create ( jobId , tempPhotosData ) ; } - for ( PhotoAlbum album : data.getAlbums ( ) ) { - tempPhotosData.addAlbum ( CACHE_ALBUM_METADATA_PREFIX + album.getId ( ) , album ) ; + if ( data.getAlbums ( ) ! = null ) { + importAlbums ( data.getAlbums ( ) , tempPhotosData ) ;
diff -- git a/distributions/demo-google-deployment/bin/setup_gke_environment.sh b/distributions/demo-google-deployment/bin/setup_gke_environment.sh index b57280d..073c44e 100755 -- - a/distributions/demo-google-deployment/bin/setup_gke_environment.sh +++ b/distributions/demo-google-deployment/bin/setup_gke_environment.sh @ @ -309,6 +309,13 @ @ echo `` Created GCS bucket $ GCS_BUCKET_NAME '' print_step `` Granting service account $ { SERVICE_ACCOUNT } viewer privileges to 'app-data ' bucket '' gsutil acl -p $ { PROJECT_ID } ch -u $ { SERVICE_ACCOUNT } : R $ { GCS_BUCKET_NAME } + # TODO : what if the bucket already exists ? +print_step `` Creating GCS 'user-data ' bucket for storing encrypted user data '' +BUCKET_NAME= '' user-data- $ PROJECT_ID '' +GCS_BUCKET_NAME= '' gs : // $ BUCKET_NAME/ '' +gsutil mb -p $ { PROJECT_ID } $ { GCS_BUCKET_NAME } +echo `` Created GCS bucket $ GCS_BUCKET_NAME '' + print_step `` Creating a key to encrypt app secrets '' gcloud kms keyrings create portability_secrets -- location global # Currently only one purposes is supported : `` encryption '' . Ca n't have separate encrypt/decrypt keys . diff -- git a/extensions/cloud/portability-cloud-google/src/main/java/org/datatransferproject/cloud/google/GoogleCloudExtensionModule.java b/extensions/cloud/portability-cloud-google/src/main/java/org/datatransferproject/cloud/google/GoogleCloudExtensionModule.java index ca9c2a7..a35ad67 100644 -- - a/extensions/cloud/portability-cloud-google/src/main/java/org/datatransferproject/cloud/google/GoogleCloudExtensionModule.java +++ b/extensions/cloud/portability-cloud-google/src/main/java/org/datatransferproject/cloud/google/GoogleCloudExtensionModule.java @ @ -27,6 +27,9 @ @ import com.google.api.client.json.JsonFactory ; import com.google.auth.oauth2.GoogleCredentials ; import com.google.cloud.datastore.Datastore ; import com.google.cloud.datastore.DatastoreOptions ; +import com.google.cloud.storage.Bucket ; +import com.google.cloud.storage.Storage ; +import com.google.cloud.storage.StorageOptions ; import com.google.common.annotations.VisibleForTesting ;
diff -- git a/Documentation/Integration.md b/Documentation/Integration.md index 7e0e85b..4c68d91 100644 -- - a/Documentation/Integration.md +++ b/Documentation/Integration.md @ @ -2,29 +2,121 @ @ This guide covers the following options for integrating your service , with the primary use case being the integration of a new transfer service . -* Integrate a new transfer service -* Integrate a new data type -* Integrate a new cloud provider +* [ Integrate a new transfer service ] ( # integrate-a-new-transfer-service ) +* [ Integrate a new data model ] ( # integrate-a-new-data-model ) +* [ Integrate a new cloud provider ] ( # integrate-a-new-cloud-provider ) # # Integrate a new transfer service -A new service can be integrated into the Data Transfer Project by creating a 1 ) Transfer Extension and 2 ) Auth Extension . - +A new service can be integrated into the Data Transfer Project by creating the following extensions : + +1 . Transfer Extension +1 . Auth Extension +1 . Optionally , a new Data Model may be required if your does not exist . Please see Integrate a new Data Model ( below ) for more information . + # # # Transfer Extension -* Transfer Extensions are located in the
diff -- git a/tools/reviewer/aa/commands/DiffCommand.java b/tools/reviewer/aa/commands/DiffCommand.java index 9a2a641..7225c00 100644 -- - a/tools/reviewer/aa/commands/DiffCommand.java +++ b/tools/reviewer/aa/commands/DiffCommand.java @ @ -97,7 +97,7 @ @ public class DiffCommand implements AaCommand { Diff.newBuilder ( ) .setWorkspace ( workspaceName ) .setDescription ( description.get ( ) ) - .setBug ( buglink.get ( ) ) + .addIssue ( buglink.get ( ) ) .addAllReviewer ( getReviewers ( reviewers.get ( ) ) ) .setId ( response.getLastDiffId ( ) ) .setCreatedTimestamp ( currentTime ) @ @ -151,7 +151,7 @ @ public class DiffCommand implements AaCommand { if ( ! buglink.get ( ) .isEmpty ( ) ) { // replace buglink if specified - diffBuilder.setBug ( buglink.get ( ) ) ; + diffBuilder.addIssue ( buglink.get ( ) ) ; } diffBuilder.setModifiedTimestamp ( new Long ( System.currentTimeMillis ( ) ) ) ; diff -- git a/tools/reviewer/local_server/service/code_review.proto b/tools/reviewer/local_server/service/code_review.proto index fb5fb5b..d384d3e 100644 -- - a/tools/reviewer/local_server/service/code_review.proto +++ b/tools/reviewer/local_server/service/code_review.proto @ @ -75,16 +75,17 @ @ message Diff { Author author = 3 ; repeated Reviewer reviewer = 4 ; string description = 5 ; - string bug = 6 ; + // List of urls to github issues + repeated string issue = 6 ; Status status = 7 ; string workspace = 8 ; int64 created_timestamp = 9
diff -- git a/tools/reviewer/aa/commands/DiffCommand.java b/tools/reviewer/aa/commands/DiffCommand.java index 9a2a641..ddf848a 100644 -- - a/tools/reviewer/aa/commands/DiffCommand.java +++ b/tools/reviewer/aa/commands/DiffCommand.java @ @ -85,6 +85,13 @ @ public class DiffCommand implements AaCommand { .collect ( Collectors.toList ( ) ) ) ; } + private ImmutableList < String > getIssues ( String issuesInput ) { + return ImmutableList.copyOf ( + Arrays.stream ( issuesInput.split ( `` , '' ) ) + .filter ( x - > ! x.equals ( `` '' ) ) + .collect ( Collectors.toList ( ) ) ) ; + } + private Diff createDiff ( ) { DiffNumberResponse response = codeReviewBlockingStub.getAvailableDiffNumber ( Empty.getDefaultInstance ( ) ) ; @ @ -97,7 +104,7 @ @ public class DiffCommand implements AaCommand { Diff.newBuilder ( ) .setWorkspace ( workspaceName ) .setDescription ( description.get ( ) ) - .setBug ( buglink.get ( ) ) + .addAllIssue ( getIssues ( buglink.get ( ) ) ) .addAllReviewer ( getReviewers ( reviewers.get ( ) ) ) .setId ( response.getLastDiffId ( ) ) .setCreatedTimestamp ( currentTime ) @ @ -151,7 +158,7 @ @ public class DiffCommand implements AaCommand { if ( ! buglink.get ( ) .isEmpty ( ) ) { // replace buglink if specified - diffBuilder.setBug ( buglink.get ( ) ) ; + diffBuilder.addAllIssue
diff -- git a/tools/reviewer/local_server/service/code_review.proto b/tools/reviewer/local_server/service/code_review.proto index 25a481f..ba06dfd 100644 -- - a/tools/reviewer/local_server/service/code_review.proto +++ b/tools/reviewer/local_server/service/code_review.proto @ @ -78,7 +78,8 @ @ message Diff { string workspace = 8 ; int64 created_timestamp = 9 ; int64 modified_timestamp = 10 ; - repeated Thread thread = 13 ; + // Threads on a line . + repeated Thread line_thread = 13 ; repeated string cc = 14 ; // Threads on the whole diff , not on a particular file or line . repeated Thread diff_thread = 15 ; diff -- git a/tools/reviewer/webapp/README.md b/tools/reviewer/webapp/README.md index 9c987f0..815eca9 100644 -- - a/tools/reviewer/webapp/README.md +++ b/tools/reviewer/webapp/README.md @ @ -1,13 +1,21 @ @ + # # You need installed + [ node ] ( https : //nodejs.org/ ) LTS + [ npm ] ( https : //www.npmjs.com/ ) + [ protoc ] ( https : //github.com/protocolbuffers/protobuf/releases ) +Optional : + [ firebase ] ( https : //firebase.google.com/docs/hosting/quickstart ) + [ angular ] ( https : //angular.io/ ) + # # For the first time -Run ` ng install ` for the first time . +Run ` npm install ` to install npm modules -Run ` npm run protoc ` to generate proto functions . -You need google-protobuf 3.5 or
diff -- git a/tools/reviewer/local_server/service/code_review.proto b/tools/reviewer/local_server/service/code_review.proto index 25a481f..4331241 100644 -- - a/tools/reviewer/local_server/service/code_review.proto +++ b/tools/reviewer/local_server/service/code_review.proto @ @ -78,7 +78,8 @ @ message Diff { string workspace = 8 ; int64 created_timestamp = 9 ; int64 modified_timestamp = 10 ; - repeated Thread thread = 13 ; + // Threads on a line . + repeated Thread line_thread = 13 ; repeated string cc = 14 ; // Threads on the whole diff , not on a particular file or line . repeated Thread diff_thread = 15 ; @ @ -104,6 +105,7 @ @ message Thread { int32 line_number = 4 ; bool is_done = 5 ; repeated Comment comment = 6 ; + bool is_diff_thread = 7 ; } message Comment { diff -- git a/tools/reviewer/webapp/README.md b/tools/reviewer/webapp/README.md index 9c987f0..815eca9 100644 -- - a/tools/reviewer/webapp/README.md +++ b/tools/reviewer/webapp/README.md @ @ -1,13 +1,21 @ @ + # # You need installed + [ node ] ( https : //nodejs.org/ ) LTS + [ npm ] ( https : //www.npmjs.com/ ) + [ protoc ] ( https : //github.com/protocolbuffers/protobuf/releases ) +Optional : + [ firebase ] ( https : //firebase.google.com/docs/hosting/quickstart ) + [ angular ] ( https : //angular.io/ ) + # # For the first time
diff -- git a/completion.sh b/completion.sh deleted file mode 100755 index 292dc34..0000000 -- - a/completion.sh +++ /dev/null @ @ -1,18 +0,0 @ @ - # ! /bin/bash - -if [ [ `` $ ( basename -- `` $ 0 '' ) '' == `` completion.sh '' ] ] ; then - echo `` Do n't run $ 0 , source it '' > & 2 - exit 1 -fi - -platform= $ ( uname ) -if [ `` $ platform '' == `` Darwin '' ] ; then - echo `` Current OS is macOS , we assume you installed bazel via Homebrew '' - source $ ( brew -- prefix ) /etc/bash_completion.d/bazel-complete.bash -elif [ `` $ platform '' == `` Linux '' ] ; then - echo `` Current OS is Linux , we assume you installed bazel via APT '' - source /etc/bash_completion.d/bazel -else - echo `` Unknown platform '' - exit 1 -fi diff -- git a/tools/completion.sh b/tools/completion.sh new file mode 100755 index 0000000..292dc34 -- - /dev/null +++ b/tools/completion.sh @ @ -0,0 +1,18 @ @ + # ! /bin/bash + +if [ [ `` $ ( basename -- `` $ 0 '' ) '' == `` completion.sh ''
diff -- git a/commands.txt b/commands.txt index c1ef5dd..0093a9c 100644 -- - a/commands.txt +++ b/commands.txt @ @ -37,5 +37,6 @ @ bazel run //tools : unused_deps -- < BUILD target , e.g //folder : target > # Bash completion # This assumes you 've installed ` bazel ` via APT or Homebrew - # To enable bundled-in autocomplete for ` bazel ` , run : -source completion.sh + # To enable bundled-in autocomplete for ` bazel ` , run completion.sh + # completion.sh present at https : //github.com/google/startup-os/tree/master/tools +sh tools/completion.sh diff -- git a/completion.sh b/completion.sh deleted file mode 100755 index 292dc34..0000000 -- - a/completion.sh +++ /dev/null @ @ -1,18 +0,0 @ @ - # ! /bin/bash - -if [ [ `` $ ( basename -- `` $ 0 '' ) '' == `` completion.sh '' ] ] ; then - echo `` Do n't run $ 0 , source it '' > & 2 - exit 1 -fi - -platform= $ ( uname ) -if [ `` $ platform '' == `` Darwin '' ] ; then - echo `` Current OS is macOS , we assume you installed bazel via Homebrew '' - source $ ( brew -- prefix ) /etc/bash_completion.d/bazel-complete.bash
diff -- git a/.circleci/config.yml b/.circleci/config.yml index eaabfe7..45d2378 100644 -- - a/.circleci/config.yml +++ b/.circleci/config.yml @ @ -33,6 +33,7 @ @ jobs : - run : sudo apt update - run : sudo apt -y install yapf3 clang-format python3-pkg-resources - run : sudo ln -s /usr/bin/yapf3 /usr/bin/yapf + - run : './tools/deps/check_dependencies.sh' - run : './tools/fix_formatting.sh' build : diff -- git a/dependencies.yaml b/dependencies.yaml index 129bbaa..553ba3a 100644 -- - a/dependencies.yaml +++ b/dependencies.yaml @ @ -1,6 +1,7 @ @ options : languages : [ `` java '' ] licenses : [ `` permissive '' ] + namePrefix : `` mvn '' resolvers : - id : `` mavencentral '' type : `` default '' @ @ -8,7 +9,6 @ @ options : thirdPartyDirectory : `` third_party/maven/ '' transitivity : runtime_deps versionConflictPolicy : highest - namePrefix : `` mvn '' dependencies : com.google.api : @ @ -172,12 +172,12 @ @ dependencies : lang : java version : `` 2.6 '' - org.yaml : - snakeyaml : - lang : java - version : `` 1.21 '' - org.slf4j : slf4j-simple : lang : java version : `` 1.7.25 '' + + org.yaml : + snakeyaml : + lang : java + version : `` 1.21
diff -- git a/AUTHORS b/AUTHORS new file mode 100644 index 0000000..da06cba -- - /dev/null +++ b/AUTHORS @ @ -0,0 +1,6 @ @ + # Below is a list of people and organizations that have contributed + # to the Charts project . Names should be added to the list like so : + # + # Name/Organization < email address > + +Google Inc. diff -- git a/CONTRIBUTING.md b/CONTRIBUTING.md new file mode 100644 index 0000000..6258dd6 -- - /dev/null +++ b/CONTRIBUTING.md @ @ -0,0 +1,68 @ @ + # How to Contribute + +We 'd love to accept your patches and contributions to this project . There are +just a few small guidelines you need to follow . + + # # Contributor License Agreement + +Contributions to this project must be accompanied by a Contributor License +Agreement . You ( or your employer ) retain the copyright to your contribution , +this simply gives us permission to use and redistribute your contributions as +part of the project . Head over to < https : //cla.developers.google.com/ > to see +your current agreements on file or to sign a new one . + +You generally only need to submit a CLA once
diff -- git a/.gitignore b/.gitignore new file mode 100644 index 0000000..e2015c6 -- - /dev/null +++ b/.gitignore @ @ -0,0 +1,3 @ @ +.bundle +_site + diff -- git a/docs/Gemfile b/docs/Gemfile new file mode 100644 index 0000000..abdcac9 -- - /dev/null +++ b/docs/Gemfile @ @ -0,0 +1,15 @ @ + # This file enables generation of documentation html from markdown locally . + # + # Ruby 2.10 or later is required . + # To install needed dependencies : + # + # gem install bundler + # bundle install -- path .bundle + # + # To generate and serve html locally : + # + # bundle exec jekyll serve + # + # -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- +source 'https : //rubygems.org' +gem 'github-pages ' , group : : jekyll_plugins diff -- git a/docs/Gemfile.lock b/docs/Gemfile.lock new file mode 100644 index 0000000..8207cf4 -- - /dev/null +++ b/docs/Gemfile.lock @ @ -0,0 +1,239 @ @ +GEM + remote : https : //rubygems.org/ + specs : + activesupport ( 4.2.9
diff -- git a/LICENSE b/LICENSE deleted file mode 100644 index d645695..0000000 -- - a/LICENSE +++ /dev/null @ @ -1,202 +0,0 @ @ - - Apache License - Version 2.0 , January 2004 - http : //www.apache.org/licenses/ - - TERMS AND CONDITIONS FOR USE , REPRODUCTION , AND DISTRIBUTION - - 1 . Definitions . - - `` License '' shall mean the terms and conditions for use , reproduction , - and distribution as defined by Sections 1 through 9 of this document . - - `` Licensor '' shall mean the copyright owner or entity authorized by - the copyright owner that is granting the License . - - `` Legal Entity '' shall mean the union of the acting entity and all - other entities that control , are controlled by , or are under common - control with that entity . For the purposes of this definition , - `` control '' means ( i ) the power , direct or indirect , to cause the - direction or management of such entity , whether by contract or - otherwise , or ( ii ) ownership of fifty percent ( 50 % ) or more of the
diff -- git a/.gitignore b/.gitignore index e2015c6..f4e5d61 100644 -- - a/.gitignore +++ b/.gitignore @ @ -1,3 +1,13 @ @ .bundle _site +.DS_Store +.dart_tool/ + +.packages +.pub/ + +build/ +**/ios/.generated/ +**/ios/Flutter/Generated.xcconfig +**/ios/Runner/GeneratedPluginRegistrant . *
diff -- git a/charts_common/lib/src/chart/cartesian/axis/simple_ordinal_scale.dart b/charts_common/lib/src/chart/cartesian/axis/simple_ordinal_scale.dart index 83f8d3f..c9f4793 100644 -- - a/charts_common/lib/src/chart/cartesian/axis/simple_ordinal_scale.dart +++ b/charts_common/lib/src/chart/cartesian/axis/simple_ordinal_scale.dart @ @ -122,7 +122,7 @ @ class SimpleOrdinalScale implements OrdinalScale { ( _cachedStepSizePixels * i ) ; } // If it was n't found - return 0 ; + return 0.0 ; } @ override
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index d9a01dd..bd7c5bb 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -13,25 +13,24 @ @ // See the License for the specific language governing permissions and // limitations under the License . -export 'src/chart/common/behavior/chart_behavior.dart ' show ChartBehavior ; +export 'src/chart/bar/bar_chart.dart ' show BarChart ; +export 'src/chart/bar/bar_label_decorator.dart ' show BarLabelDecorator ; +export 'src/chart/bar/bar_renderer.dart' + show BarRenderer , ImmutableBarRendererElement ; +export 'src/chart/bar/bar_renderer_config.dart ' show BarRendererConfig ; +export 'src/chart/bar/bar_renderer_decorator.dart ' show BarRendererDecorator ; +export 'src/chart/bar/base_bar_renderer_config.dart' + show BarGroupingType , BaseBarRendererConfig ; +export 'src/chart/cartesian/axis/axis.dart ' show domainAxisKey , measureAxisKey ; +export 'src/chart/cartesian/axis/spec/axis_spec.dart ' show AxisSpec ; +export 'src/chart/cartesian/cartesian_chart.dart ' show CartesianChart ; +export 'src/chart/cartesian/cartesian_renderer.dart ' show BaseCartesianRenderer ; +export 'src/chart/common/base_chart.dart ' show BaseChart , LifecycleListener ; export 'src/chart/common/behavior/a11y/a11y_explore_behavior.dart' show ExploreModeTrigger ; export 'src/chart/common/behavior/a11y/a11y_node.dart ' show A11yNode ; export 'src/chart/common/behavior/a11y/domain_a11y_explore_behavior.dart' show DomainA11yExploreBehavior , VocalizationCallback ; -export 'src/chart/common/behavior/zoom/pan_and_zoom_behavior.dart' - show PanAndZoomBehavior ; -export 'src/chart/common/behavior/zoom/pan_behavior.dart ' show PanBehavior ; -export 'src/chart/common/chart_canvas.dart ' show ChartCanvas , FillPatternType ; -export 'src/chart/common/base_chart.dart ' show BaseChart , LifecycleListener ; -export 'src/chart/common/canvas_shapes.dart' - show CanvasBarStack , CanvasPie , CanvasPieSlice , CanvasRect ; -export 'src/chart/common/chart_context.dart ' show ChartContext ; -export 'src/chart/common/datum_details.dart' - show DatumDetails , DomainFormatter , MeasureFormatter ; -export 'src/chart/common/series_renderer.dart ' show SeriesRenderer ; -export 'src/chart/common/series_renderer_config.dart' - show
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index 7e26415..f07678c 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -23,7 +23,8 @ @ export 'src/chart/bar/base_bar_renderer_config.dart' show BarGroupingType , BaseBarRendererConfig ; export 'src/chart/cartesian/axis/axis.dart ' show domainAxisKey , measureAxisKey ; export 'src/chart/cartesian/axis/spec/axis_spec.dart ' show AxisSpec ; -export 'src/chart/cartesian/cartesian_chart.dart ' show CartesianChart ; +export 'src/chart/cartesian/cartesian_chart.dart' + show CartesianChart , NumericCartesianChart , OrdinalCartesianChart ; export 'src/chart/cartesian/cartesian_renderer.dart ' show BaseCartesianRenderer ; export 'src/chart/common/base_chart.dart ' show BaseChart , LifecycleListener ; export 'src/chart/common/behavior/a11y/a11y_explore_behavior.dart' @ @ -52,11 +53,17 @ @ export 'src/chart/common/behavior/legend/legend_entry.dart ' show LegendEntry ; export 'src/chart/common/behavior/legend/legend_entry_generator.dart' show LegendEntryGenerator ; export 'src/chart/common/behavior/line_point_highlighter.dart' - show LinePointHighlighter ; + show LinePointHighlighter , LinePointHighlighterFollowLineType ; export 'src/chart/common/behavior/range_annotation.dart' show RangeAnnotation , RangeAnnotationAxisType , RangeAnnotationSegment ; -export 'src/chart/common/behavior/select_nearest.dart' - show SelectNearest , SelectNearestTrigger ; +export 'src/chart/common/behavior/selection/lock_selection.dart' + show LockSelection ; +export 'src/chart/common/behavior/selection/select_nearest.dart' + show SelectNearest ; +export 'src/chart/common/behavior/selection/selection_trigger.dart' + show SelectionTrigger ; +export 'src/chart/common/behavior/slider/slider.dart' + show Slider , SliderListenerCallback , SliderListenerDragState , SliderStyle ; export 'src/chart/common/behavior/zoom/pan_and_zoom_behavior.dart' show PanAndZoomBehavior ; export 'src/chart/common/behavior/zoom/pan_behavior.dart ' show PanBehavior ; @ @ -87,6 +94,10 @ @ export 'src/chart/scatter_plot/point_renderer.dart ' show PointRenderer ; export 'src/chart/scatter_plot/point_renderer_config.dart' show PointRendererConfig ; export 'src/chart/scatter_plot/scatter_plot_chart.dart ' show ScatterPlotChart ; +export 'src/chart/scatter_plot/symbol_annotation_renderer.dart' + show SymbolAnnotationRenderer ; +export 'src/chart/scatter_plot/symbol_annotation_renderer_config.dart' + show SymbolAnnotationRendererConfig ; export 'src/chart/time_series/time_series_chart.dart ' show TimeSeriesChart ;
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index 7e26415..47604c5 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -23,7 +23,8 @ @ export 'src/chart/bar/base_bar_renderer_config.dart' show BarGroupingType , BaseBarRendererConfig ; export 'src/chart/cartesian/axis/axis.dart ' show domainAxisKey , measureAxisKey ; export 'src/chart/cartesian/axis/spec/axis_spec.dart ' show AxisSpec ; -export 'src/chart/cartesian/cartesian_chart.dart ' show CartesianChart ; +export 'src/chart/cartesian/cartesian_chart.dart' + show CartesianChart , NumericCartesianChart , OrdinalCartesianChart ; export 'src/chart/cartesian/cartesian_renderer.dart ' show BaseCartesianRenderer ; export 'src/chart/common/base_chart.dart ' show BaseChart , LifecycleListener ; export 'src/chart/common/behavior/a11y/a11y_explore_behavior.dart' @ @ -37,6 +38,8 @ @ export 'src/chart/common/behavior/chart_behavior.dart' ChartBehavior , InsideJustification , OutsideJustification ; +export 'src/chart/common/behavior/calculation/percent_injector.dart' + show PercentInjector , PercentInjectorTotalType ; export 'src/chart/common/behavior/domain_highlighter.dart' show DomainHighlighter ; export 'src/chart/common/behavior/initial_selection.dart' @ @ -52,11 +55,17 @ @ export 'src/chart/common/behavior/legend/legend_entry.dart ' show LegendEntry ; export 'src/chart/common/behavior/legend/legend_entry_generator.dart' show LegendEntryGenerator ; export 'src/chart/common/behavior/line_point_highlighter.dart' - show LinePointHighlighter ; + show LinePointHighlighter , LinePointHighlighterFollowLineType ; export 'src/chart/common/behavior/range_annotation.dart' show RangeAnnotation , RangeAnnotationAxisType , RangeAnnotationSegment ; -export 'src/chart/common/behavior/select_nearest.dart' - show SelectNearest , SelectNearestTrigger ; +export 'src/chart/common/behavior/selection/lock_selection.dart' + show LockSelection ; +export 'src/chart/common/behavior/selection/select_nearest.dart' + show SelectNearest ; +export 'src/chart/common/behavior/selection/selection_trigger.dart' + show SelectionTrigger ; +export 'src/chart/common/behavior/slider/slider.dart' + show Slider , SliderListenerCallback , SliderListenerDragState , SliderStyle ; export 'src/chart/common/behavior/zoom/pan_and_zoom_behavior.dart' show PanAndZoomBehavior ; export 'src/chart/common/behavior/zoom/pan_behavior.dart ' show PanBehavior ; @ @ -87,6 +96,10 @ @ export 'src/chart/scatter_plot/point_renderer.dart ' show PointRenderer ;
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index 7e26415..7ebeb6b 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -23,7 +23,8 @ @ export 'src/chart/bar/base_bar_renderer_config.dart' show BarGroupingType , BaseBarRendererConfig ; export 'src/chart/cartesian/axis/axis.dart ' show domainAxisKey , measureAxisKey ; export 'src/chart/cartesian/axis/spec/axis_spec.dart ' show AxisSpec ; -export 'src/chart/cartesian/cartesian_chart.dart ' show CartesianChart ; +export 'src/chart/cartesian/cartesian_chart.dart' + show CartesianChart , NumericCartesianChart , OrdinalCartesianChart ; export 'src/chart/cartesian/cartesian_renderer.dart ' show BaseCartesianRenderer ; export 'src/chart/common/base_chart.dart ' show BaseChart , LifecycleListener ; export 'src/chart/common/behavior/a11y/a11y_explore_behavior.dart' @ @ -37,6 +38,8 @ @ export 'src/chart/common/behavior/chart_behavior.dart' ChartBehavior , InsideJustification , OutsideJustification ; +export 'src/chart/common/behavior/calculation/percent_injector.dart' + show PercentInjector , PercentInjectorTotalType ; export 'src/chart/common/behavior/domain_highlighter.dart' show DomainHighlighter ; export 'src/chart/common/behavior/initial_selection.dart' @ @ -52,14 +55,22 @ @ export 'src/chart/common/behavior/legend/legend_entry.dart ' show LegendEntry ; export 'src/chart/common/behavior/legend/legend_entry_generator.dart' show LegendEntryGenerator ; export 'src/chart/common/behavior/line_point_highlighter.dart' - show LinePointHighlighter ; + show LinePointHighlighter , LinePointHighlighterFollowLineType ; export 'src/chart/common/behavior/range_annotation.dart' show RangeAnnotation , RangeAnnotationAxisType , RangeAnnotationSegment ; -export 'src/chart/common/behavior/select_nearest.dart' - show SelectNearest , SelectNearestTrigger ; +export 'src/chart/common/behavior/sliding_viewport.dart ' show SlidingViewport ; +export 'src/chart/common/behavior/selection/lock_selection.dart' + show LockSelection ; +export 'src/chart/common/behavior/selection/select_nearest.dart' + show SelectNearest ; +export 'src/chart/common/behavior/selection/selection_trigger.dart' + show SelectionTrigger ; +export 'src/chart/common/behavior/slider/slider.dart' + show Slider , SliderListenerCallback , SliderListenerDragState , SliderStyle ; export 'src/chart/common/behavior/zoom/pan_and_zoom_behavior.dart' show PanAndZoomBehavior ; -export 'src/chart/common/behavior/zoom/pan_behavior.dart ' show PanBehavior ; +export 'src/chart/common/behavior/zoom/pan_behavior.dart' + show PanBehavior ,
diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index 7e26415..6630fc8 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -14,16 +14,77 @ @ // limitations under the License . export 'src/chart/bar/bar_chart.dart ' show BarChart ; -export 'src/chart/bar/bar_label_decorator.dart ' show BarLabelDecorator ; +export 'src/chart/bar/bar_label_decorator.dart' + show BarLabelAnchor , BarLabelDecorator , BarLabelPosition ; +export 'src/chart/bar/bar_lane_renderer_config.dart ' show BarLaneRendererConfig ; export 'src/chart/bar/bar_renderer.dart' show BarRenderer , ImmutableBarRendererElement ; -export 'src/chart/bar/bar_renderer_config.dart ' show BarRendererConfig ; +export 'src/chart/bar/bar_renderer_config.dart' + show + BarRendererConfig , + CornerStrategy , + ConstCornerStrategy , + NoCornerStrategy ; export 'src/chart/bar/bar_renderer_decorator.dart ' show BarRendererDecorator ; +export 'src/chart/bar/bar_target_line_renderer.dart ' show BarTargetLineRenderer ; +export 'src/chart/bar/bar_target_line_renderer_config.dart' + show BarTargetLineRendererConfig ; export 'src/chart/bar/base_bar_renderer_config.dart' show BarGroupingType , BaseBarRendererConfig ; -export 'src/chart/cartesian/axis/axis.dart ' show domainAxisKey , measureAxisKey ; -export 'src/chart/cartesian/axis/spec/axis_spec.dart ' show AxisSpec ; -export 'src/chart/cartesian/cartesian_chart.dart ' show CartesianChart ; +export 'src/chart/cartesian/axis/axis.dart' + show + domainAxisKey , + measureAxisIdKey , + measureAxisKey , + Axis , + NumericAxis , + OrdinalAxis , + OrdinalViewport ; +export 'src/chart/cartesian/axis/numeric_extents.dart ' show NumericExtents ; +export 'src/chart/cartesian/axis/draw_strategy/gridline_draw_strategy.dart' + show GridlineRendererSpec ; +export 'src/chart/cartesian/axis/draw_strategy/none_draw_strategy.dart' + show NoneRenderSpec ; +export 'src/chart/cartesian/axis/draw_strategy/small_tick_draw_strategy.dart' + show SmallTickRendererSpec ; +export 'src/chart/cartesian/axis/tick_formatter.dart' + show SimpleTickFormatterBase , TickFormatter ; +export 'src/chart/cartesian/axis/spec/axis_spec.dart' + show + AxisSpec , + LineStyleSpec , + TextStyleSpec , + TickLabelAnchor ,
diff -- git a/.gitignore b/.gitignore index e2015c6..f4e5d61 100644 -- - a/.gitignore +++ b/.gitignore @ @ -1,3 +1,13 @ @ .bundle _site +.DS_Store +.dart_tool/ + +.packages +.pub/ + +build/ +**/ios/.generated/ +**/ios/Flutter/Generated.xcconfig +**/ios/Runner/GeneratedPluginRegistrant . * diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index 7e26415..fccb810 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -14,16 +14,81 @ @ // limitations under the License . export 'src/chart/bar/bar_chart.dart ' show BarChart ; -export 'src/chart/bar/bar_label_decorator.dart ' show BarLabelDecorator ; +export 'src/chart/bar/bar_label_decorator.dart' + show BarLabelAnchor , BarLabelDecorator , BarLabelPosition ; +export 'src/chart/bar/bar_lane_renderer_config.dart ' show BarLaneRendererConfig ; export 'src/chart/bar/bar_renderer.dart' show BarRenderer , ImmutableBarRendererElement ; -export 'src/chart/bar/bar_renderer_config.dart ' show BarRendererConfig ; +export 'src/chart/bar/bar_renderer_config.dart' + show + BarRendererConfig , + CornerStrategy , + ConstCornerStrategy , + NoCornerStrategy ; export 'src/chart/bar/bar_renderer_decorator.dart ' show BarRendererDecorator ; +export 'src/chart/bar/bar_target_line_renderer.dart ' show BarTargetLineRenderer ; +export 'src/chart/bar/bar_target_line_renderer_config.dart' + show BarTargetLineRendererConfig ; export 'src/chart/bar/base_bar_renderer_config.dart' show BarGroupingType , BaseBarRendererConfig ; -export 'src/chart/cartesian/axis/axis.dart ' show domainAxisKey , measureAxisKey ; -export 'src/chart/cartesian/axis/spec/axis_spec.dart ' show AxisSpec ; -export 'src/chart/cartesian/cartesian_chart.dart ' show CartesianChart ; +export 'src/chart/cartesian/axis/axis.dart' + show + domainAxisKey , + measureAxisIdKey , + measureAxisKey , + Axis , + NumericAxis , + OrdinalAxis , + OrdinalViewport ; +export 'src/chart/cartesian/axis/numeric_extents.dart ' show NumericExtents ; +export 'src/chart/cartesian/axis/draw_strategy/gridline_draw_strategy.dart' + show GridlineRendererSpec ; +export 'src/chart/cartesian/axis/draw_strategy/none_draw_strategy.dart' +
diff -- git a/.gitignore b/.gitignore index e2015c6..f4e5d61 100644 -- - a/.gitignore +++ b/.gitignore @ @ -1,3 +1,13 @ @ .bundle _site +.DS_Store +.dart_tool/ + +.packages +.pub/ + +build/ +**/ios/.generated/ +**/ios/Flutter/Generated.xcconfig +**/ios/Runner/GeneratedPluginRegistrant . * diff -- git a/charts_common/lib/common.dart b/charts_common/lib/common.dart index 7e26415..fccb810 100644 -- - a/charts_common/lib/common.dart +++ b/charts_common/lib/common.dart @ @ -14,16 +14,81 @ @ // limitations under the License . export 'src/chart/bar/bar_chart.dart ' show BarChart ; -export 'src/chart/bar/bar_label_decorator.dart ' show BarLabelDecorator ; +export 'src/chart/bar/bar_label_decorator.dart' + show BarLabelAnchor , BarLabelDecorator , BarLabelPosition ; +export 'src/chart/bar/bar_lane_renderer_config.dart ' show BarLaneRendererConfig ; export 'src/chart/bar/bar_renderer.dart' show BarRenderer , ImmutableBarRendererElement ; -export 'src/chart/bar/bar_renderer_config.dart ' show BarRendererConfig ; +export 'src/chart/bar/bar_renderer_config.dart' + show + BarRendererConfig , + CornerStrategy , + ConstCornerStrategy , + NoCornerStrategy ; export 'src/chart/bar/bar_renderer_decorator.dart ' show BarRendererDecorator ; +export 'src/chart/bar/bar_target_line_renderer.dart ' show BarTargetLineRenderer ; +export 'src/chart/bar/bar_target_line_renderer_config.dart' + show BarTargetLineRendererConfig ; export 'src/chart/bar/base_bar_renderer_config.dart' show BarGroupingType , BaseBarRendererConfig ; -export 'src/chart/cartesian/axis/axis.dart ' show domainAxisKey , measureAxisKey ; -export 'src/chart/cartesian/axis/spec/axis_spec.dart ' show AxisSpec ; -export 'src/chart/cartesian/cartesian_chart.dart ' show CartesianChart ; +export 'src/chart/cartesian/axis/axis.dart' + show + domainAxisKey , + measureAxisIdKey , + measureAxisKey , + Axis , + NumericAxis , + OrdinalAxis , + OrdinalViewport ; +export 'src/chart/cartesian/axis/numeric_extents.dart ' show NumericExtents ; +export 'src/chart/cartesian/axis/draw_strategy/gridline_draw_strategy.dart' + show GridlineRendererSpec ; +export 'src/chart/cartesian/axis/draw_strategy/none_draw_strategy.dart' +
diff -- git a/README.md b/README.md index 9345252..b209e1c 100644 -- - a/README.md +++ b/README.md @ @ -1,5 +1,5 @ @ Charts is a general charting library , currently enabled for the - [ Flutter mobile app toolkit ] ( https : //flutter.io ) . + [ Flutter mobile UI framework ] ( https : //flutter.io ) . *Note* : This is not an official Google product . diff -- git a/charts_flutter/example/android.iml b/charts_flutter/example/android.iml new file mode 100644 index 0000000..462b903 -- - /dev/null +++ b/charts_flutter/example/android.iml @ @ -0,0 +1,12 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < module type= '' JAVA_MODULE '' version= '' 4 '' > + < component name= '' NewModuleRootManager '' inherit-compiler-output= '' true '' > + < exclude-output / > + < content url= '' file : // $ MODULE_DIR $ /android '' > + < sourceFolder url= '' file : // $ MODULE_DIR $ /android/app/src/main/java '' isTestSource= '' false '' / > + < /content > + < orderEntry type= '' jdk '' jdkName= '' Android API 25 Platform '' jdkType= '' Android SDK '' / > + < orderEntry type= '' sourceFolder '' forTests= '' false ''
diff -- git a/charts_flutter/example/android/app/src/main/AndroidManifest.xml b/charts_flutter/example/android/app/src/main/AndroidManifest.xml index ac8855d..9144147 100644 -- - a/charts_flutter/example/android/app/src/main/AndroidManifest.xml +++ b/charts_flutter/example/android/app/src/main/AndroidManifest.xml @ @ -20,7 +20,7 @ @ android : name= '' .MainActivity '' android : launchMode= '' singleTop '' android : theme= '' @ style/LaunchTheme '' - android : configChanges= '' orientation|keyboardHidden|keyboard|screenSize|locale|layoutDirection|fontScale '' + android : configChanges= '' orientation|keyboardHidden|keyboard|screenSize|locale|layoutDirection|fontScale|screenLayout|density '' android : hardwareAccelerated= '' true '' android : windowSoftInputMode= '' adjustResize '' > < ! -- This keeps the window background of the activity showing
diff -- git a/common/src/jni/main/cpp/conscrypt/native_crypto.cc b/common/src/jni/main/cpp/conscrypt/native_crypto.cc index f0d4d90..ce5d24e 100644 -- - a/common/src/jni/main/cpp/conscrypt/native_crypto.cc +++ b/common/src/jni/main/cpp/conscrypt/native_crypto.cc @ @ -9638,6 +9638,85 @ @ static int NativeCrypto_ENGINE_SSL_read_BIO_heap ( JNIEnv* env , jclass , jlong ssl_ return result ; } +static void NativeCrypto_ENGINE_SSL_force_read ( JNIEnv* env , jclass , jlong ssl_address , CONSCRYPT_UNUSED jobject ssl_holder , + jobject shc ) { + CHECK_ERROR_QUEUE_ON_RETURN ; + SSL* ssl = to_SSL ( env , ssl_address , true ) ; + if ( ssl == nullptr ) { + return ; + } + JNI_TRACE ( `` ssl= % p NativeCrypto_ENGINE_SSL_force_read shc= % p '' , ssl , shc ) ; + if ( shc == nullptr ) { + conscrypt : :jniutil : :throwNullPointerException ( env , `` sslHandshakeCallbacks == null '' ) ; + JNI_TRACE ( `` ssl= % p NativeCrypto_ENGINE_SSL_force_read = > sslHandshakeCallbacks == null '' , + ssl ) ; + return ; + } + AppData* appData = toAppData ( ssl ) ; + if ( appData == nullptr ) { + conscrypt : :jniutil : :throwSSLExceptionStr ( env , `` Unable to retrieve application data '' ) ; + JNI_TRACE ( `` ssl= % p NativeCrypto_ENGINE_SSL_force_read = > appData == null '' ,
diff -- git a/android/lint.xml b/android/lint.xml index 0f057a9..b998dd1 100644 -- - a/android/lint.xml +++ b/android/lint.xml @ @ -2,7 +2,7 @ @ < lint > < ! -- ExtendedSSLSession only gets instantiated in new APIs on Android . -- > < issue id= '' NewApi '' > - < ignore path= '' **/org/conscrypt/DelegatingExtendedSSLSession.java '' / > + < ignore path= '' **/org/conscrypt/ExtendedSessionAdapter.java '' / > < /issue > < ! -- Android SparseArrays ca n't be used in common directory . -- > diff -- git a/android/src/main/java/org/conscrypt/Platform.java b/android/src/main/java/org/conscrypt/Platform.java index 32b4b6d..21563c1 100644 -- - a/android/src/main/java/org/conscrypt/Platform.java +++ b/android/src/main/java/org/conscrypt/Platform.java @ @ -701,7 +701,7 @ @ final class Platform { return sslSession ; } - return new DelegatingExtendedSSLSession ( sslSession ) ; + return ExtendedSessionAdapter.wrap ( sslSession ) ; } public static SSLSession unwrapSSLSession ( SSLSession sslSession ) { @ @ -709,11 +709,7 @ @ final class Platform { return sslSession ; } - if ( sslSession instanceof DelegatingExtendedSSLSession ) { - return ( ( DelegatingExtendedSSLSession ) sslSession ) .getDelegate ( ) ; - } - - return sslSession ; + return ExtendedSessionAdapter.getDelegate ( sslSession ) ; } /* diff -- git a/benchmark-base/build.gradle b/benchmark-base/build.gradle index 0d08920..7836bd8 100644 -- - a/benchmark-base/build.gradle +++ b/benchmark-base/build.gradle @ @ -1,11 +1,14 @
diff -- git a/benchmark-base/src/main/java/org/conscrypt/EngineHandshakeBenchmark.java b/benchmark-base/src/main/java/org/conscrypt/EngineHandshakeBenchmark.java index 8c218b1..2ffeef6 100644 -- - a/benchmark-base/src/main/java/org/conscrypt/EngineHandshakeBenchmark.java +++ b/benchmark-base/src/main/java/org/conscrypt/EngineHandshakeBenchmark.java @ @ -101,12 +101,12 @ @ public final class EngineHandshakeBenchmark { EngineHandshakeBenchmark bm = new EngineHandshakeBenchmark ( new Config ( ) { @ Override public BufferType bufferType ( ) { - return BufferType.HEAP ; + return BufferType.DIRECT ; } @ Override public EngineType engineType ( ) { - return EngineType.NETTY ; + return EngineType.CONSCRYPT_UNPOOLED ; } @ Override diff -- git a/common/src/jni/main/cpp/NativeCrypto.cpp b/common/src/jni/main/cpp/NativeCrypto.cpp index d6fa53f..bf169d1 100644 -- - a/common/src/jni/main/cpp/NativeCrypto.cpp +++ b/common/src/jni/main/cpp/NativeCrypto.cpp @ @ -5731,10 +5731,7 @ @ static AppData* toAppData ( const SSL* ssl ) { return reinterpret_cast < AppData* > ( SSL_get_app_data ( ssl ) ) ; } -/** - * Verify the X509 certificate via SSL_CTX_set_cert_verify_callback - */ -static int cert_verify_callback ( X509_STORE_CTX* x509_store_ctx , void* arg ) { +static int cert_verify_callback ( X509_STORE_CTX *x509_store_ctx , void *arg ) { /* Get the correct index to the SSLobject stored into X509_STORE_CTX . */ SSL* ssl = reinterpret_cast < SSL* > ( X509_STORE_CTX_get_ex_data ( x509_store_ctx , SSL_get_ex_data_X509_STORE_CTX_idx ( ) ) ) ; @ @ -5747,12 +5744,27 @ @ static int cert_verify_callback ( X509_STORE_CTX* x509_store_ctx , void* arg ) { JNI_TRACE ( `` ssl= % p cert_verify_callback
diff -- git a/benchmark-android/src/main/java/org/conscrypt/AndroidEngineFactory.java b/benchmark-android/src/main/java/org/conscrypt/AndroidEngineFactory.java index 65dcf68..42d9a22 100644 -- - a/benchmark-android/src/main/java/org/conscrypt/AndroidEngineFactory.java +++ b/benchmark-android/src/main/java/org/conscrypt/AndroidEngineFactory.java @ @ -35,8 +35,7 @ @ public enum AndroidEngineFactory implements EngineFactory { public SSLEngine newClientEngine ( String cipher , boolean useAlpn ) { SSLEngine engine = initEngine ( clientContext.createSSLEngine ( ) , cipher , true ) ; if ( useAlpn ) { - Conscrypt.Engines.setAlpnProtocols ( - engine , new String [ ] { `` h2 '' } ) ; + Conscrypt.setAlpnProtocols ( engine , new String [ ] { `` h2 '' } ) ; } return engine ; } @ @ -45,8 +44,7 @ @ public enum AndroidEngineFactory implements EngineFactory { public SSLEngine newServerEngine ( String cipher , boolean useAlpn ) { SSLEngine engine = initEngine ( serverContext.createSSLEngine ( ) , cipher , false ) ; if ( useAlpn ) { - Conscrypt.Engines.setAlpnProtocols ( - engine , new String [ ] { `` h2 '' } ) ; + Conscrypt.setAlpnProtocols ( engine , new String [ ] { `` h2 '' } ) ; } return engine ; } diff -- git a/common/src/main/java/org/conscrypt/ClientSessionContext.java b/common/src/main/java/org/conscrypt/ClientSessionContext.java index 9465b27..66007f9 100644 -- - a/common/src/main/java/org/conscrypt/ClientSessionContext.java +++ b/common/src/main/java/org/conscrypt/ClientSessionContext.java @ @ -43,7 +43,7 @ @ public final class ClientSessionContext extends AbstractSessionContext { /**
diff -- git a/common/src/main/java/org/conscrypt/ActiveSession.java b/common/src/main/java/org/conscrypt/ActiveSession.java index 545668c..663534a 100644 -- - a/common/src/main/java/org/conscrypt/ActiveSession.java +++ b/common/src/main/java/org/conscrypt/ActiveSession.java @ @ -304,6 +304,11 @ @ final class ActiveSession implements SSLSession { */ void onPeerCertificatesReceived ( String peerHost , int peerPort , X509Certificate [ ] peerCertificates ) { + configurePeer ( peerHost , peerPort , peerCertificates ) ; + } + + private void configurePeer ( + String peerHost , int peerPort , X509Certificate [ ] peerCertificates ) { this.peerHost = peerHost ; this.peerPort = peerPort ; this.peerCertificates = peerCertificates ; @ @ -316,9 +321,13 @ @ final class ActiveSession implements SSLSession { */ void onHandshakeCompleted ( String peerHost , int peerPort ) { id = null ; - this.peerHost = peerHost ; - this.peerPort = peerPort ; this.localCertificates = ssl.getLocalCertificates ( ) ; + if ( this.peerCertificates == null ) { + // Under some as-yet-undetermined circumstances , the cert_verify_callback ( which calls + // onPeerCertificatesReceived ) is n't called by BoringSSL during the handshake , leaving + // us without the peer certificates . If that happens , fetch them explicitly . + configurePeer ( peerHost , peerPort , ssl.getPeerCertificates ( ) ) ; + } } /** diff -- git a/common/src/main/java/org/conscrypt/SslWrapper.java b/common/src/main/java/org/conscrypt/SslWrapper.java index 863509b..cf83470
diff -- git a/openjdk/build.gradle b/openjdk/build.gradle index f7d7e2a..16119eb 100644 -- - a/openjdk/build.gradle +++ b/openjdk/build.gradle @ @ -205,13 +205,13 @ @ model { } } - tasks { - $ .binaries.withType ( SharedLibraryBinarySpec ) .each { + tasks { t - > + $ .binaries.withType ( SharedLibraryBinarySpec ) .each { binary - > // Build the native artifact classifier from the OS and architecture . - def archName = it.targetPlatform.architecture.name.replaceAll ( '- ' , '_ ' ) + def archName = binary.targetPlatform.architecture.name.replaceAll ( '- ' , '_ ' ) def classifier = classifierFor ( osName , archName ) def normalizedClassifier = normalizeClassifier ( `` $ classifier '' ) - def source = it.sharedLibraryFile + def source = binary.sharedLibraryFile // Copies the native library to a resource location that will be included in the jar . task `` copyNativeLib $ { normalizedClassifier } '' ( type : Copy ) { @ @ -225,6 +225,18 @ @ model { // Make sure we build and copy the native library to the output directory . compileJava.dependsOn `` copyNativeLib $ { normalizedClassifier } '' + + // Now define a task to strip the binary ( linux only ) + def stripTask = binary.tasks.taskName ( ``
diff -- git a/appveyor.yml b/appveyor.yml index 7cb3de1..b9b2aa4 100644 -- - a/appveyor.yml +++ b/appveyor.yml @ @ -6,12 +6,12 @ @ environment : ANDROID_TOOLS_URL : `` https : //dl.google.com/android/repository/tools_r25.2.3-windows.zip '' NINJA_URL : `` https : //github.com/ninja-build/ninja/releases/download/v1.6.0/ninja-win.zip '' CMAKE_URL : `` https : //cmake.org/files/v3.4/cmake-3.4.0-win32-x86.zip '' - MSVC : `` 14.0 '' + MSVC : `` 2017\Community '' clone_folder : `` C : \\projects\\conscrypt '' shallow_clone : true -os : Visual Studio 2015 +os : Visual Studio 2017 platform : # - x86 @ @ -55,26 +55,21 @ @ init : - set PATH=C : \Program Files ( x86 ) \Windows Kits\8.1\bin\x86 ; % PATH % before_build : - # Set up Visual Studio in 64-bit mode - - call `` C : \Program Files ( x86 ) \Microsoft Visual Studio % MSVC % \VC\vcvarsall.bat '' x64 - # Build BoringSSL in 64-bit + - call `` C : \Program Files ( x86 ) \Microsoft Visual Studio\ % MSVC % \VC\Auxiliary\Build\vcvarsall.bat '' x64 - cd `` % BORINGSSL_HOME % '' - mkdir build64 - cd build64 - cmake -DCMAKE_POSITION_INDEPENDENT_CODE=TRUE -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_FLAGS_RELEASE=/MT -DCMAKE_CXX_FLAGS_RELEASE=/MT -GNinja .. - ninja - # Set up Visual Studio in 32-bit mode - - call `` C : \Program Files (
diff -- git a/common/src/jni/main/cpp/NativeCrypto.cpp b/common/src/jni/main/cpp/NativeCrypto.cpp index 11ffffd..780e69c 100644 -- - a/common/src/jni/main/cpp/NativeCrypto.cpp +++ b/common/src/jni/main/cpp/NativeCrypto.cpp @ @ -7622,8 +7622,6 @ @ static void NativeCrypto_SSL_shutdown ( JNIEnv* env , jclass , jlong ssl_address , return ; } if ( fdObject == nullptr ) { - Errors : :jniThrowNullPointerException ( env , `` fd == null '' ) ; - JNI_TRACE ( `` ssl= % p NativeCrypto_SSL_shutdown = > fd == null '' , ssl ) ; return ; } if ( shc == nullptr ) { diff -- git a/libcore-stub/src/main/java/libcore/java/security/TestKeyStore.java b/libcore-stub/src/main/java/libcore/java/security/TestKeyStore.java deleted file mode 100644 index d6f4ad8..0000000 -- - a/libcore-stub/src/main/java/libcore/java/security/TestKeyStore.java +++ /dev/null @ @ -1,1122 +0,0 @ @ -/* - * Copyright ( C ) 2010 The Android Open Source Project - * - * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - * you may not use this file except in compliance with the License . - * You may obtain a copy of the License at - * - * http : //www.apache.org/licenses/LICENSE-2.0 - * - * Unless required by applicable law or agreed to in writing , software - * distributed under the License is distributed on an `` AS IS ''
diff -- git a/common/src/main/java/org/conscrypt/NativeCrypto.java b/common/src/main/java/org/conscrypt/NativeCrypto.java index 509b2ef..33e470a 100644 -- - a/common/src/main/java/org/conscrypt/NativeCrypto.java +++ b/common/src/main/java/org/conscrypt/NativeCrypto.java @ @ -724,7 +724,8 @ @ public final class NativeCrypto { // prevent apps from connecting to servers they were previously able to connect to . /** X.509 based cipher suites enabled by default ( if requested ) , in preference order . */ - static final String [ ] DEFAULT_X509_CIPHER_SUITES = EVP_has_aes_hardware ( ) == 1 ? + static final boolean HAS_AES_HARDWARE = EVP_has_aes_hardware ( ) == 1 ; + static final String [ ] DEFAULT_X509_CIPHER_SUITES = HAS_AES_HARDWARE ? new String [ ] { `` TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 '' , `` TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 '' , @ @ -760,8 +761,10 @ @ public final class NativeCrypto { /** TLS-PSK cipher suites enabled by default ( if requested ) , in preference order . */ static final String [ ] DEFAULT_PSK_CIPHER_SUITES = new String [ ] { - `` TLS_ECDHE_PSK_WITH_CHACHA20_POLY1305_SHA256 '' , `` TLS_ECDHE_PSK_WITH_AES_128_CBC_SHA '' , - `` TLS_ECDHE_PSK_WITH_AES_256_CBC_SHA '' , `` TLS_PSK_WITH_AES_128_CBC_SHA '' , + `` TLS_ECDHE_PSK_WITH_CHACHA20_POLY1305_SHA256 '' , + `` TLS_ECDHE_PSK_WITH_AES_128_CBC_SHA '' , + `` TLS_ECDHE_PSK_WITH_AES_256_CBC_SHA '' , + `` TLS_PSK_WITH_AES_128_CBC_SHA '' , `` TLS_PSK_WITH_AES_256_CBC_SHA '' , } ; diff -- git a/libcore-stub/src/main/java/libcore/java/security/CpuFeatures.java b/libcore-stub/src/main/java/libcore/java/security/CpuFeatures.java index 3b7ce36..c8f8053 100644 -- -
diff -- git a/openjdk-integ-tests/src/test/java/libcore/javax/net/ssl/AbstractSSLTest.java b/openjdk-integ-tests/src/test/java/libcore/javax/net/ssl/AbstractSSLTest.java new file mode 100644 index 0000000..3bfc8e7 -- - /dev/null +++ b/openjdk-integ-tests/src/test/java/libcore/javax/net/ssl/AbstractSSLTest.java @ @ -0,0 +1,31 @ @ +/* + * Copyright ( C ) 2017 The Android Open Source Project + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ +package libcore.javax.net.ssl ; + +import static org.conscrypt.TestUtils.installConscryptAsDefaultProvider ; + +import org.junit.BeforeClass ; + +/** + * Abstract base class for all SSL integration tests . This sets up the default TLS provider . + */ +public abstract class AbstractSSLTest { + + @ BeforeClass +
diff -- git a/build.gradle b/build.gradle index 0bbdabc..b1e5ace 100644 -- - a/build.gradle +++ b/build.gradle @ @ -5,7 +5,6 @ @ buildscript { jcenter ( ) } dependencies { - classpath 'com.google.gradle : osdetector-gradle-plugin:1.4.0' classpath 'com.android.tools.build : gradle:2.2.2 ' // jcenter has the latest classpath 'com.github.dcendents : android-maven-gradle-plugin:1.5' } diff -- git a/common/src/jni/main/cpp/NativeCrypto.cpp b/common/src/jni/main/cpp/NativeCrypto.cpp new file mode 100644 index 0000000..7757fe6 -- - /dev/null +++ b/common/src/jni/main/cpp/NativeCrypto.cpp @ @ -0,0 +1,9170 @ @ +/* + * Copyright ( C ) 2007-2008 The Android Open Source Project + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License .
diff -- git a/.travis.yml b/.travis.yml index 55f02e9..5bb1509 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -71,15 +71,16 @ @ before_script : - ninja - popd + # TODO ( nathanmittler ) : Need to figure out how to make 32-bit builds work # Build BoringSSL for 32-bit - - if [ [ `` $ TRAVIS_OS_NAME '' == `` linux '' ] ] ; - then - mkdir $ BORINGSSL_HOME/build32 ; - pushd $ BORINGSSL_HOME/build32 ; - cmake -DCMAKE_TOOLCHAIN_FILE=../util/32-bit-toolchain.cmake -DCMAKE_POSITION_INDEPENDENT_CODE=TRUE -DCMAKE_BUILD_TYPE=Release -DCMAKE_ASM_FLAGS= '' -Wa , -- noexecstack -m32 -msse2 '' -GNinja .. ; - ninja ; - popd ; - fi + # - if [ [ `` $ TRAVIS_OS_NAME '' == `` linux '' ] ] ; + # then + # mkdir $ BORINGSSL_HOME/build32 ; + # pushd $ BORINGSSL_HOME/build32 ; + # cmake -DCMAKE_TOOLCHAIN_FILE=../util/32-bit-toolchain.cmake -DCMAKE_POSITION_INDEPENDENT_CODE=TRUE -DCMAKE_BUILD_TYPE=Release -DCMAKE_ASM_FLAGS= '' -Wa , -- noexecstack -m32 -msse2 '' -GNinja .. ; + # ninja ; + # popd ; + # fi # newest Android NDK - if [ [ `` $ TRAVIS_OS_NAME '' == `` linux '' ] ] ; diff -- git a/appveyor.yml b/appveyor.yml index d0fdba5..aaa0b5c 100644 -- - a/appveyor.yml +++ b/appveyor.yml @ @ -70,12 +70,13 @ @ before_build
diff -- git a/apache/opensanscondensed/METADATA.pb b/apache/opensanscondensed/METADATA.pb index 1ad8731..eaca62d 100644 -- - a/apache/opensanscondensed/METADATA.pb +++ b/apache/opensanscondensed/METADATA.pb @ @ -7,34 +7,34 @ @ fonts { name : `` Open Sans Condensed '' style : `` normal '' weight : 300 - filename : `` OpenSans-CondLight.ttf '' - post_script_name : `` OpenSans-CondensedLight '' - full_name : `` Open Sans Cond Light '' - copyright : `` Digitized data copyright © 2011 , Google Corporation . '' + filename : `` OpenSansCondensed-Light.ttf '' + post_script_name : `` OpenSansCondensed-Light '' + full_name : `` Open Sans Condensed Light '' + copyright : `` Digitized data copyright 2011 , Google Corporation . '' } fonts { name : `` Open Sans Condensed '' style : `` italic '' weight : 300 - filename : `` OpenSans-CondLightItalic.ttf '' - post_script_name : `` OpenSans-CondensedLightItalic '' - full_name : `` Open Sans Cond Light Italic '' - copyright : `` Digitized data copyright © 2010-2011 , Google Corporation . '' + filename : `` OpenSansCondensed-LightItalic.ttf '' + post_script_name : `` OpenSansCondensed-LightItalic '' + full_name : `` Open Sans Condensed Light Italic '' + copyright : `` Digitized data copyright 2010-2011 , Google Corporation . '' } fonts { name : ``
diff -- git a/ofl/mogra/DESCRIPTION.en_us.html b/ofl/mogra/DESCRIPTION.en_us.html new file mode 100644 index 0000000..084c4bd -- - /dev/null +++ b/ofl/mogra/DESCRIPTION.en_us.html @ @ -0,0 +1,9 @ @ + < p > +Mogra ( મોગરા ) is a display typeface that supports the Gujarati and Latin scripts . +With dense letterforms that borrow heavily from a broad-nibbed marker , Mogra emphasises the definitive Gujarati out-stroke with mass , weight , and flair . +The implied bloating of the marker pen creates an interesting roundness that contrasts against the relatively fixed angle the pen holds . + < /p > + < p > +The Mogra project is led by Lipi Raval , a type designer based in Ahmedabad , India . +To contribute , see < a href= '' https : //github.com/lipiraval/mogra '' > github.com/lipiraval/mogra < /a > + < /p > diff -- git a/ofl/mogra/METADATA.pb b/ofl/mogra/METADATA.pb new file mode 100644 index 0000000..312e0fa -- - /dev/null +++ b/ofl/mogra/METADATA.pb @ @ -0,0 +1,18 @ @ +name : `` Mogra '' +designer : `` Lipi Raval '' +license : `` OFL '' +category : `` DISPLAY '' +date_added : `` 2017-05-09 '' +fonts { + name : `` Mogra '' + style : `` normal '' + weight
diff -- git a/ofl/comfortaa/Comfortaa-Bold.ttf b/ofl/comfortaa/Comfortaa-Bold.ttf index 5beebe0..36c17bf 100644 Binary files a/ofl/comfortaa/Comfortaa-Bold.ttf and b/ofl/comfortaa/Comfortaa-Bold.ttf differ diff -- git a/ofl/comfortaa/Comfortaa-Light.ttf b/ofl/comfortaa/Comfortaa-Light.ttf index 67fa2f7..daa0168 100644 Binary files a/ofl/comfortaa/Comfortaa-Light.ttf and b/ofl/comfortaa/Comfortaa-Light.ttf differ diff -- git a/ofl/comfortaa/Comfortaa-Regular.ttf b/ofl/comfortaa/Comfortaa-Regular.ttf index 3f900aa..0b910f1 100644 Binary files a/ofl/comfortaa/Comfortaa-Regular.ttf and b/ofl/comfortaa/Comfortaa-Regular.ttf differ diff -- git a/ofl/comfortaa/METADATA.pb b/ofl/comfortaa/METADATA.pb index 10e7d61..c249ab7 100644 -- - a/ofl/comfortaa/METADATA.pb +++ b/ofl/comfortaa/METADATA.pb @ @ -10,7 +10,7 @ @ fonts { filename : `` Comfortaa-Light.ttf '' post_script_name : `` Comfortaa-Light '' full_name : `` Comfortaa Light '' - copyright : `` Copyright ( c ) 2011 , Johan Aakerlund ( aajohan @ gmail.com ) , with Reserved Font Name \ '' Comfortaa\ '' '' + copyright : `` Copyright 2011 The Comfortaa Project Authors ( aajohan @ gmail.com ) , with Reserved Font Name \ '' Comfortaa\ '' . '' } fonts { name : `` Comfortaa '' @ @ -18,8 +18,8 @ @ fonts { weight : 400 filename : `` Comfortaa-Regular.ttf '' post_script_name : `` Comfortaa-Regular '' - full_name : `` Comfortaa '' - copyright : `` Copyright ( c ) 2011 , Johan Aakerlund ( aajohan @ gmail.com ) , with Reserved Font Name \ '' Comfortaa\ '' '' + full_name : `` Comfortaa Regular
diff -- git a/apache/opensans/METADATA.pb b/apache/opensans/METADATA.pb index c93502b..28fb53b 100644 -- - a/apache/opensans/METADATA.pb +++ b/apache/opensans/METADATA.pb @ @ -10,25 +10,25 @ @ fonts { filename : `` OpenSans-Light.ttf '' post_script_name : `` OpenSans-Light '' full_name : `` Open Sans Light '' - copyright : `` Digitized data copyright © 2010-2011 , Google Corporation . '' + copyright : `` Digitized data copyright 2010-2011 , Google Corporation . '' } fonts { name : `` Open Sans '' style : `` italic '' weight : 300 filename : `` OpenSans-LightItalic.ttf '' - post_script_name : `` OpenSansLight-Italic '' + post_script_name : `` OpenSans-LightItalic '' full_name : `` Open Sans Light Italic '' - copyright : `` Digitized data copyright © 2010-2011 , Google Corporation . '' + copyright : `` Digitized data copyright 2010-2011 , Google Corporation . '' } fonts { name : `` Open Sans '' style : `` normal '' weight : 400 filename : `` OpenSans-Regular.ttf '' - post_script_name : `` OpenSans '' - full_name : `` Open Sans '' - copyright : `` Digitized data copyright © 2010-2011 , Google Corporation . '' + post_script_name : `` OpenSans-Regular '' + full_name : `` Open Sans Regular '' + copyright :
diff -- git a/apache/opensans/METADATA.pb b/apache/opensans/METADATA.pb index c93502b..28fb53b 100644 -- - a/apache/opensans/METADATA.pb +++ b/apache/opensans/METADATA.pb @ @ -10,25 +10,25 @ @ fonts { filename : `` OpenSans-Light.ttf '' post_script_name : `` OpenSans-Light '' full_name : `` Open Sans Light '' - copyright : `` Digitized data copyright © 2010-2011 , Google Corporation . '' + copyright : `` Digitized data copyright 2010-2011 , Google Corporation . '' } fonts { name : `` Open Sans '' style : `` italic '' weight : 300 filename : `` OpenSans-LightItalic.ttf '' - post_script_name : `` OpenSansLight-Italic '' + post_script_name : `` OpenSans-LightItalic '' full_name : `` Open Sans Light Italic '' - copyright : `` Digitized data copyright © 2010-2011 , Google Corporation . '' + copyright : `` Digitized data copyright 2010-2011 , Google Corporation . '' } fonts { name : `` Open Sans '' style : `` normal '' weight : 400 filename : `` OpenSans-Regular.ttf '' - post_script_name : `` OpenSans '' - full_name : `` Open Sans '' - copyright : `` Digitized data copyright © 2010-2011 , Google Corporation . '' + post_script_name : `` OpenSans-Regular '' + full_name : `` Open Sans Regular '' + copyright :
diff -- git a/ufl/ubuntu/DESCRIPTION.en_us.html b/ufl/ubuntu/DESCRIPTION.en_us.html index 8818cdd..8a8d0c0 100644 -- - a/ufl/ubuntu/DESCRIPTION.en_us.html +++ b/ufl/ubuntu/DESCRIPTION.en_us.html @ @ -3,25 +3,17 @ @ The < a href= '' http : //font.ubuntu.com '' > Ubuntu Font Family < /a > are a set of matchin The development is being funded by Canonical Ltd on behalf the wider Free Software community and the Ubuntu project . The technical font design work and implementation is being undertaken by < a href= '' http : //www.daltonmaag.com/ '' > Dalton Maag < /a > . < /p > - < p > Both the final font Truetype/OpenType files and the design files used to produce the font family are distributed under an open licence and you are expressly encouraged to experiment , modify , share and improve . < /p > - < p > The new Ubuntu Font Family was started to enable the personality of Ubuntu to be seen and felt in every menu , button and dialog . The typeface is sans-serif , uses OpenType features and is manually hinted for clarity on desktop and mobile computing screens . < /p > - < p > The scope of the Ubuntu Font Family includes all the
diff -- git a/ofl/sansita/DESCRIPTION.en_us.html b/ofl/sansita/DESCRIPTION.en_us.html new file mode 100644 index 0000000..cf48d92 -- - /dev/null +++ b/ofl/sansita/DESCRIPTION.en_us.html @ @ -0,0 +1 @ @ + < p > Sansita is a tasty new < a href= '' http : //omnibus-type.com/ '' > Omnibus Type < /a > font designed by Pablo Cosgaya . The flavor of Sansita 's lowercase explores the relationship between typography and calligraphy . The elegance of Sansita 's uppercase makes this an excellent choice for packaging , brief texts , branding and slogans. < /p > \ No newline at end of file diff -- git a/ofl/sansita/METADATA.pb b/ofl/sansita/METADATA.pb new file mode 100644 index 0000000..a3a14de -- - /dev/null +++ b/ofl/sansita/METADATA.pb @ @ -0,0 +1,80 @ @ +name : `` Sansita '' +designer : `` Pablo Cosgaya '' +license : `` OFL '' +category : `` SANS_SERIF '' +date_added : `` 2016-12-04 '' +fonts { + name : `` Sansita '' + style : `` normal '' + weight : 400 + filename : `` Sansita-Regular.ttf '' + post_script_name : `` Sansita-Regular '' + full_name : `` Sansita Regular '' + copyright : `` Copyright 2016 The Sansita Project Authors ( omnibus.type @ gmail.com ) '' + } +fonts {
diff -- git a/TRIVIA.md b/TRIVIA.md index 8532243..b517c62 100644 -- - a/TRIVIA.md +++ b/TRIVIA.md @ @ -56,6 +56,8 @ @ Here is a list of 3rd party directories : * http : //typewonder.com * http : //www.localfont.com * http : //open-foundry.com +* https : //typeresources.github.io/glyph-gazer/ +* http : //cdn.canelodigital.cl/fonts/ There are also handcrafted directories with rich samples : @ @ -64,6 +66,7 @ @ There are also handcrafted directories with rich samples : * http : //100daysoffonts.com * http : //jxnblk.com/type-a/ * https : //jonsuh.com/100-days-of-scriptures/ +* http : //codepen.io/nxworld/pen/XKRaRm # # Rightsholder contacts diff -- git a/tools/encodings/GF 2016 Glyph Sets/CustomFilter.plist b/tools/encodings/GF 2016 Glyph Sets/CustomFilter.plist new file mode 100644 index 0000000..663e8f0 -- - /dev/null +++ b/tools/encodings/GF 2016 Glyph Sets/CustomFilter.plist @ @ -0,0 +1,1820 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < ! DOCTYPE plist PUBLIC `` -//Apple//DTD PLIST 1.0//EN '' `` http : //www.apple.com/DTDs/PropertyList-1.0.dtd '' > + < plist version= '' 1.0 '' > + < array > + < dict > + < key > name < /key > + < string > Incompatible Master < /string > + < key > predicate < /key > + < string > mastersCompatible
diff -- git a/ofl/poppins/METADATA.pb b/ofl/poppins/METADATA.pb index 7735234..7a5749f 100644 -- - a/ofl/poppins/METADATA.pb +++ b/ofl/poppins/METADATA.pb @ @ -10,7 +10,7 @ @ fonts { filename : `` Poppins-Light.ttf '' post_script_name : `` Poppins-Light '' full_name : `` Poppins Light '' - copyright : `` Copyright ( c ) 2014 Indian Type Foundry ( info @ indiantypefoundry.com ) '' + copyright : `` Copyright 2014-2017 Indian Type Foundry ( info @ indiantypefoundry.com ) '' } fonts { name : `` Poppins '' @ @ -19,7 +19,7 @ @ fonts { filename : `` Poppins-Regular.ttf '' post_script_name : `` Poppins-Regular '' full_name : `` Poppins Regular '' - copyright : `` Copyright ( c ) 2014 Indian Type Foundry ( info @ indiantypefoundry.com ) '' + copyright : `` Copyright 2014-2017 Indian Type Foundry ( info @ indiantypefoundry.com ) '' } fonts { name : `` Poppins '' @ @ -28,7 +28,7 @ @ fonts { filename : `` Poppins-Medium.ttf '' post_script_name : `` Poppins-Medium '' full_name : `` Poppins Medium '' - copyright : `` Copyright ( c ) 2014 Indian Type Foundry ( info @ indiantypefoundry.com ) '' + copyright : `` Copyright 2014-2017 Indian Type Foundry ( info @ indiantypefoundry.com ) ''
diff -- git a/ofl/montserrat/DESCRIPTION.en_us.html b/ofl/montserrat/DESCRIPTION.en_us.html index f8e1b33..466ead3 100644 -- - a/ofl/montserrat/DESCRIPTION.en_us.html +++ b/ofl/montserrat/DESCRIPTION.en_us.html @ @ -21,7 +21,3 @ @ city look so beautiful. < /p > < a href= '' http : //www.google.com/fonts/specimen/Montserrat+Subrayada '' > Subrayada < /a > families . Many of the letterforms are special in the Alternates family , while . < /p > - - < p > Updated in September 2012. < /p > - - < p > Updated in June 2014 , with Thin , Light and Black weights. < /p > diff -- git a/ofl/montserrat/METADATA.pb b/ofl/montserrat/METADATA.pb index 434adb4..b274638 100644 -- - a/ofl/montserrat/METADATA.pb +++ b/ofl/montserrat/METADATA.pb @ @ -8,9 +8,18 @ @ fonts { style : `` normal '' weight : 100 filename : `` Montserrat-Thin.ttf '' - post_script_name : `` Montserrat-Hairline '' - full_name : `` Montserrat Hairline '' - copyright : `` Copyright © 2014 by Julieta Ulanovsky . All rights reserved . '' + post_script_name : `` Montserrat-Thin '' + full_name : `` Montserrat Thin '' + copyright : `` Copyright 2011 - 2016 The Montserrat Project Authors ( julieta.ulanovsky @ gmail.com ) '' + } +fonts { + name : `` Montserrat '' + style : `` normal '' +
diff -- git a/tools/encodings/GF 2016 Glyph Sets/Cyrillic/FilterLists/Google Cyrillic Expert Nice Names.txt b/tools/encodings/GF 2016 Glyph Sets/Cyrillic/FilterLists/Google Cyrillic Expert Nice Names.txt deleted file mode 100644 index bb807b2..0000000 -- - a/tools/encodings/GF 2016 Glyph Sets/Cyrillic/FilterLists/Google Cyrillic Expert Nice Names.txt +++ /dev/null @ @ -1,398 +0,0 @ @ -Iegrave-cy -Io-cy -Dje-cy -Gje-cy -E-cy -Dze-cy -I-cy -Yi-cy -Je-cy -Lje-cy -Nje-cy -Tshe-cy -Kje-cy -Iigrave-cy -Ushort-cy -Dzhe-cy -A-cy -Be-cy -Ve-cy -Ge-cy -De-cy -Ie-cy -Zhe-cy -Ze-cy -Ii-cy -Iishort-cy -Ka-cy -El-cy -Em-cy -En-cy -O-cy -Pe-cy -Er-cy -Es-cy -Te-cy -U-cy -Ef-cy -Ha-cy -Tse-cy -Che-cy -Sha-cy -Shcha-cy -Hardsign-cy -Yeru-cy -Softsign-cy -Ereversed-cy -Iu-cy -Ia-cy -a-cy -be-cy -ve-cy -ge-cy -de-cy -ie-cy -zhe-cy -ze-cy -ii-cy -iishort-cy -ka-cy -el-cy -em-cy -en-cy -o-cy -pe-cy -er-cy -es-cy -te-cy -u-cy -ef-cy -ha-cy -tse-cy -che-cy -sha-cy -shcha-cy -hardsign-cy -yeru-cy -softsign-cy -ereversed-cy -iu-cy -ia-cy -iegrave-cy -io-cy -dje-cy -gje-cy -e-cy -dze-cy -i-cy -yi-cy -je-cy -lje-cy -nje-cy -tshe-cy -kje-cy -iigrave-cy -ushort-cy -dzhe-cy -Yat-cy -yat-cy -Yusbig-cy -yusbig-cy -Fita-cy -fita-cy -Izhitsa-cy -izhitsa-cy -Gheupturn-cy -gheupturn-cy -Ghestroke-cy -ghestroke-cy -Ghemiddlehook-cy -ghemiddlehook-cy -Zhedescender-cy -zhedescender-cy -Zedescender-cy -zedescender-cy -Kadescender-cy -kadescender-cy -Kaverticalstroke-cy -kaverticalstroke-cy -Kastroke-cy -kastroke-cy -Kabashkir-cy -kabashkir-cy -Endescender-cy -endescender-cy -Enghe-cy -enghe-cy -Pemiddlehook-cy -pemiddlehook-cy -Haabkhasian-cy -haabkhasian-cy -Esdescender-cy -esdescender-cy -Tedescender-cy -tedescender-cy -Ustrait-cy -ustrait-cy -Ustraitstroke-cy -ustraitstroke-cy -Hadescender-cy -hadescender-cy -Tetse-cy -tetse-cy -Chedescender-cy -chedescender-cy -Cheverticalstroke-cy -cheverticalstroke-cy -Shha-cy -shha-cy -Cheabkhasian-cy -cheabkhasian-cy -Palochka-cy -Zhebreve-cy -zhebreve-cy -Chekhakassian-cy -chekhakassian-cy -palochka-cy -Abreve-cy
diff -- git a/ofl/overpass/DESCRIPTION.en_us.html b/ofl/overpass/DESCRIPTION.en_us.html new file mode 100644 index 0000000..89f152b -- - /dev/null +++ b/ofl/overpass/DESCRIPTION.en_us.html @ @ -0,0 +1 @ @ + < p > An open source font family inspired by Highway Gothic . Sponsored by < a href= '' https : //www.redhat.com/ '' > Red Hat < /a > & mdash ; Created by < a href= '' https : //www.delvefonts.com '' > Delve Fonts < /a > . < /p > \ No newline at end of file diff -- git a/ofl/overpass/METADATA.pb b/ofl/overpass/METADATA.pb new file mode 100644 index 0000000..b083be3 -- - /dev/null +++ b/ofl/overpass/METADATA.pb @ @ -0,0 +1,152 @ @ +name : `` Overpass '' +designer : `` Delve Withrington '' +license : `` OFL '' +category : `` SANS_SERIF '' +date_added : `` 2016-12-02 '' +fonts { + name : `` Overpass '' + style : `` normal '' + weight : 100 + filename : `` Overpass-Thin.ttf '' + post_script_name : `` Overpass-Thin '' + full_name : `` Overpass Thin '' + copyright : `` Copyright 2016 by Red Hat , Inc. All rights reserved . '' + } +fonts { + name : `` Overpass '' + style : `` italic '' +
diff -- git a/ofl/nunitosans/NunitoSans-Black.ttf b/ofl/nunitosans/NunitoSans-Black.ttf index d57d97a..093fbf9 100644 Binary files a/ofl/nunitosans/NunitoSans-Black.ttf and b/ofl/nunitosans/NunitoSans-Black.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-BlackItalic.ttf b/ofl/nunitosans/NunitoSans-BlackItalic.ttf index e5c22dd..00db009 100644 Binary files a/ofl/nunitosans/NunitoSans-BlackItalic.ttf and b/ofl/nunitosans/NunitoSans-BlackItalic.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-Bold.ttf b/ofl/nunitosans/NunitoSans-Bold.ttf index a22225b..a3ca4b6 100644 Binary files a/ofl/nunitosans/NunitoSans-Bold.ttf and b/ofl/nunitosans/NunitoSans-Bold.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-BoldItalic.ttf b/ofl/nunitosans/NunitoSans-BoldItalic.ttf index 753f7c6..1bccb97 100644 Binary files a/ofl/nunitosans/NunitoSans-BoldItalic.ttf and b/ofl/nunitosans/NunitoSans-BoldItalic.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-ExtraBold.ttf b/ofl/nunitosans/NunitoSans-ExtraBold.ttf index 5ce89bb..a732425 100644 Binary files a/ofl/nunitosans/NunitoSans-ExtraBold.ttf and b/ofl/nunitosans/NunitoSans-ExtraBold.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-ExtraBoldItalic.ttf b/ofl/nunitosans/NunitoSans-ExtraBoldItalic.ttf index 8b62d4e..05e26d6 100644 Binary files a/ofl/nunitosans/NunitoSans-ExtraBoldItalic.ttf and b/ofl/nunitosans/NunitoSans-ExtraBoldItalic.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-ExtraLight.ttf b/ofl/nunitosans/NunitoSans-ExtraLight.ttf index aba8a71..2ad4ac0 100644 Binary files a/ofl/nunitosans/NunitoSans-ExtraLight.ttf and b/ofl/nunitosans/NunitoSans-ExtraLight.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-ExtraLightItalic.ttf b/ofl/nunitosans/NunitoSans-ExtraLightItalic.ttf index f0cd1ea..b73b0fa 100644 Binary files a/ofl/nunitosans/NunitoSans-ExtraLightItalic.ttf and b/ofl/nunitosans/NunitoSans-ExtraLightItalic.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-Italic.ttf b/ofl/nunitosans/NunitoSans-Italic.ttf index d6e8761..85269a1 100644 Binary files a/ofl/nunitosans/NunitoSans-Italic.ttf and b/ofl/nunitosans/NunitoSans-Italic.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-Light.ttf b/ofl/nunitosans/NunitoSans-Light.ttf index 3f5090b..2f5d049 100644 Binary files a/ofl/nunitosans/NunitoSans-Light.ttf and b/ofl/nunitosans/NunitoSans-Light.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-LightItalic.ttf b/ofl/nunitosans/NunitoSans-LightItalic.ttf index 2299a8e..bac17d0 100644 Binary files a/ofl/nunitosans/NunitoSans-LightItalic.ttf and b/ofl/nunitosans/NunitoSans-LightItalic.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-Regular.ttf b/ofl/nunitosans/NunitoSans-Regular.ttf index 17eb3d6..9abe932 100644 Binary files a/ofl/nunitosans/NunitoSans-Regular.ttf and b/ofl/nunitosans/NunitoSans-Regular.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-SemiBold.ttf b/ofl/nunitosans/NunitoSans-SemiBold.ttf index 94516ce..c27eaf4 100644 Binary files a/ofl/nunitosans/NunitoSans-SemiBold.ttf and b/ofl/nunitosans/NunitoSans-SemiBold.ttf differ diff -- git a/ofl/nunitosans/NunitoSans-SemiBoldItalic.ttf b/ofl/nunitosans/NunitoSans-SemiBoldItalic.ttf index 742f204..59b6402 100644 Binary files a/ofl/nunitosans/NunitoSans-SemiBoldItalic.ttf and b/ofl/nunitosans/NunitoSans-SemiBoldItalic.ttf differ
diff -- git a/ofl/cormorant/Cormorant-Bold.ttf b/ofl/cormorant/Cormorant-Bold.ttf new file mode 100644 index 0000000..ae748bf Binary files /dev/null and b/ofl/cormorant/Cormorant-Bold.ttf differ diff -- git a/ofl/cormorant/Cormorant-BoldItalic.ttf b/ofl/cormorant/Cormorant-BoldItalic.ttf new file mode 100644 index 0000000..f439e6b Binary files /dev/null and b/ofl/cormorant/Cormorant-BoldItalic.ttf differ diff -- git a/ofl/cormorant/Cormorant-Italic.ttf b/ofl/cormorant/Cormorant-Italic.ttf new file mode 100644 index 0000000..d09effb Binary files /dev/null and b/ofl/cormorant/Cormorant-Italic.ttf differ diff -- git a/ofl/cormorant/Cormorant-Light.ttf b/ofl/cormorant/Cormorant-Light.ttf new file mode 100644 index 0000000..e8c398b Binary files /dev/null and b/ofl/cormorant/Cormorant-Light.ttf differ diff -- git a/ofl/cormorant/Cormorant-LightItalic.ttf b/ofl/cormorant/Cormorant-LightItalic.ttf new file mode 100644 index 0000000..1b777e9 Binary files /dev/null and b/ofl/cormorant/Cormorant-LightItalic.ttf differ diff -- git a/ofl/cormorant/Cormorant-Medium.ttf b/ofl/cormorant/Cormorant-Medium.ttf new file mode 100644 index 0000000..fb3e7f1 Binary files /dev/null and b/ofl/cormorant/Cormorant-Medium.ttf differ diff -- git a/ofl/cormorant/Cormorant-MediumItalic.ttf b/ofl/cormorant/Cormorant-MediumItalic.ttf new file mode 100644 index 0000000..0bd40f3 Binary files /dev/null and b/ofl/cormorant/Cormorant-MediumItalic.ttf differ diff -- git a/ofl/cormorant/Cormorant-Regular.ttf b/ofl/cormorant/Cormorant-Regular.ttf new file mode 100644 index 0000000..a5e507d Binary files /dev/null and b/ofl/cormorant/Cormorant-Regular.ttf differ diff -- git a/ofl/cormorant/Cormorant-SemiBold.ttf b/ofl/cormorant/Cormorant-SemiBold.ttf new file mode 100644 index 0000000..4e29c6f Binary files /dev/null and b/ofl/cormorant/Cormorant-SemiBold.ttf differ diff -- git a/ofl/cormorant/Cormorant-SemiBoldItalic.ttf b/ofl/cormorant/Cormorant-SemiBoldItalic.ttf new file mode 100644 index 0000000..b1d9936 Binary files /dev/null and b/ofl/cormorant/Cormorant-SemiBoldItalic.ttf differ diff -- git a/ofl/cormorant/DESCRIPTION.en_us.html b/ofl/cormorant/DESCRIPTION.en_us.html new file mode 100644 index 0000000..7c46361 -- - /dev/null +++ b/ofl/cormorant/DESCRIPTION.en_us.html @ @ -0,0 +1,4 @ @ + < p > Cormorant is a free
diff -- git a/tools/encodings/GF 2016 Glyph Sets/Cyrillic/FilterLists/Google Cyrillic Expert Nice Names.txt b/tools/encodings/GF 2016 Glyph Sets/Cyrillic/FilterLists/Google Cyrillic Expert Nice Names.txt deleted file mode 100644 index bb807b2..0000000 -- - a/tools/encodings/GF 2016 Glyph Sets/Cyrillic/FilterLists/Google Cyrillic Expert Nice Names.txt +++ /dev/null @ @ -1,398 +0,0 @ @ -Iegrave-cy -Io-cy -Dje-cy -Gje-cy -E-cy -Dze-cy -I-cy -Yi-cy -Je-cy -Lje-cy -Nje-cy -Tshe-cy -Kje-cy -Iigrave-cy -Ushort-cy -Dzhe-cy -A-cy -Be-cy -Ve-cy -Ge-cy -De-cy -Ie-cy -Zhe-cy -Ze-cy -Ii-cy -Iishort-cy -Ka-cy -El-cy -Em-cy -En-cy -O-cy -Pe-cy -Er-cy -Es-cy -Te-cy -U-cy -Ef-cy -Ha-cy -Tse-cy -Che-cy -Sha-cy -Shcha-cy -Hardsign-cy -Yeru-cy -Softsign-cy -Ereversed-cy -Iu-cy -Ia-cy -a-cy -be-cy -ve-cy -ge-cy -de-cy -ie-cy -zhe-cy -ze-cy -ii-cy -iishort-cy -ka-cy -el-cy -em-cy -en-cy -o-cy -pe-cy -er-cy -es-cy -te-cy -u-cy -ef-cy -ha-cy -tse-cy -che-cy -sha-cy -shcha-cy -hardsign-cy -yeru-cy -softsign-cy -ereversed-cy -iu-cy -ia-cy -iegrave-cy -io-cy -dje-cy -gje-cy -e-cy -dze-cy -i-cy -yi-cy -je-cy -lje-cy -nje-cy -tshe-cy -kje-cy -iigrave-cy -ushort-cy -dzhe-cy -Yat-cy -yat-cy -Yusbig-cy -yusbig-cy -Fita-cy -fita-cy -Izhitsa-cy -izhitsa-cy -Gheupturn-cy -gheupturn-cy -Ghestroke-cy -ghestroke-cy -Ghemiddlehook-cy -ghemiddlehook-cy -Zhedescender-cy -zhedescender-cy -Zedescender-cy -zedescender-cy -Kadescender-cy -kadescender-cy -Kaverticalstroke-cy -kaverticalstroke-cy -Kastroke-cy -kastroke-cy -Kabashkir-cy -kabashkir-cy -Endescender-cy -endescender-cy -Enghe-cy -enghe-cy -Pemiddlehook-cy -pemiddlehook-cy -Haabkhasian-cy -haabkhasian-cy -Esdescender-cy -esdescender-cy -Tedescender-cy -tedescender-cy -Ustrait-cy -ustrait-cy -Ustraitstroke-cy -ustraitstroke-cy -Hadescender-cy -hadescender-cy -Tetse-cy -tetse-cy -Chedescender-cy -chedescender-cy -Cheverticalstroke-cy -cheverticalstroke-cy -Shha-cy -shha-cy -Cheabkhasian-cy -cheabkhasian-cy -Palochka-cy -Zhebreve-cy -zhebreve-cy -Chekhakassian-cy -chekhakassian-cy -palochka-cy -Abreve-cy
diff -- git a/ofl/barlow/Barlow-Black.ttf b/ofl/barlow/Barlow-Black.ttf index 302b01e..bed3189 100644 Binary files a/ofl/barlow/Barlow-Black.ttf and b/ofl/barlow/Barlow-Black.ttf differ diff -- git a/ofl/barlow/Barlow-BlackItalic.ttf b/ofl/barlow/Barlow-BlackItalic.ttf index 1739ace..92ea0c0 100644 Binary files a/ofl/barlow/Barlow-BlackItalic.ttf and b/ofl/barlow/Barlow-BlackItalic.ttf differ diff -- git a/ofl/barlow/Barlow-Bold.ttf b/ofl/barlow/Barlow-Bold.ttf index 27116c1..10bd8a8 100644 Binary files a/ofl/barlow/Barlow-Bold.ttf and b/ofl/barlow/Barlow-Bold.ttf differ diff -- git a/ofl/barlow/Barlow-BoldItalic.ttf b/ofl/barlow/Barlow-BoldItalic.ttf index 317f835..8f5e9d5 100644 Binary files a/ofl/barlow/Barlow-BoldItalic.ttf and b/ofl/barlow/Barlow-BoldItalic.ttf differ diff -- git a/ofl/barlow/Barlow-ExtraBold.ttf b/ofl/barlow/Barlow-ExtraBold.ttf index b98bcb6..28c9b30 100644 Binary files a/ofl/barlow/Barlow-ExtraBold.ttf and b/ofl/barlow/Barlow-ExtraBold.ttf differ diff -- git a/ofl/barlow/Barlow-ExtraBoldItalic.ttf b/ofl/barlow/Barlow-ExtraBoldItalic.ttf index ae99541..a792334 100644 Binary files a/ofl/barlow/Barlow-ExtraBoldItalic.ttf and b/ofl/barlow/Barlow-ExtraBoldItalic.ttf differ diff -- git a/ofl/barlow/Barlow-ExtraLight.ttf b/ofl/barlow/Barlow-ExtraLight.ttf index 1f858c0..8170619 100644 Binary files a/ofl/barlow/Barlow-ExtraLight.ttf and b/ofl/barlow/Barlow-ExtraLight.ttf differ diff -- git a/ofl/barlow/Barlow-ExtraLightItalic.ttf b/ofl/barlow/Barlow-ExtraLightItalic.ttf index 38e417f..a337fe2 100644 Binary files a/ofl/barlow/Barlow-ExtraLightItalic.ttf and b/ofl/barlow/Barlow-ExtraLightItalic.ttf differ diff -- git a/ofl/barlow/Barlow-Italic.ttf b/ofl/barlow/Barlow-Italic.ttf index 4ac5394..a783056 100644 Binary files a/ofl/barlow/Barlow-Italic.ttf and b/ofl/barlow/Barlow-Italic.ttf differ diff -- git a/ofl/barlow/Barlow-Light.ttf b/ofl/barlow/Barlow-Light.ttf index 21cb3c7..9a25be6 100644 Binary files a/ofl/barlow/Barlow-Light.ttf and b/ofl/barlow/Barlow-Light.ttf differ diff -- git a/ofl/barlow/Barlow-LightItalic.ttf b/ofl/barlow/Barlow-LightItalic.ttf index 502747e..e043348 100644 Binary files a/ofl/barlow/Barlow-LightItalic.ttf and b/ofl/barlow/Barlow-LightItalic.ttf differ diff -- git a/ofl/barlow/Barlow-Medium.ttf b/ofl/barlow/Barlow-Medium.ttf index 03b3295..68a47b5 100644 Binary files a/ofl/barlow/Barlow-Medium.ttf and b/ofl/barlow/Barlow-Medium.ttf differ diff -- git a/ofl/barlow/Barlow-MediumItalic.ttf b/ofl/barlow/Barlow-MediumItalic.ttf index c152ae0..4083240 100644 Binary files a/ofl/barlow/Barlow-MediumItalic.ttf and b/ofl/barlow/Barlow-MediumItalic.ttf differ diff -- git a/ofl/barlow/Barlow-Regular.ttf b/ofl/barlow/Barlow-Regular.ttf index 24e9df7..9288d28 100644 Binary files a/ofl/barlow/Barlow-Regular.ttf and b/ofl/barlow/Barlow-Regular.ttf differ diff -- git a/ofl/barlow/Barlow-SemiBold.ttf
diff -- git a/ofl/neuton/METADATA.pb b/ofl/neuton/METADATA.pb index e4e31ac..a4b9b75 100644 -- - a/ofl/neuton/METADATA.pb +++ b/ofl/neuton/METADATA.pb @ @ -6,11 +6,11 @ @ date_added : `` 2011-02-09 '' fonts { name : `` Neuton '' style : `` normal '' - weight : 200 + weight : 250 filename : `` Neuton-ExtraLight.ttf '' post_script_name : `` Neuton-ExtraLight '' - full_name : `` Neuton Extralight '' - copyright : `` Copyright ( c ) 2010 , 2011 Brian M Zick ( http : //21326.info/ artistenator @ gmail.com ) , with Reserved Font Name \ '' Neuton\ '' . This Font Software is licensed under the SIL Open Font License , Version 1.1 . This license is available with a FAQ at : http : //scripts.sil.org/OFL '' + full_name : `` Neuton ExtraLight '' + copyright : `` Copyright 2010 The Neuton Project Authors ( http : //21326.info/ ) '' } fonts { name : `` Neuton '' @ @ -19,7 +19,7 @ @ fonts { filename : `` Neuton-Light.ttf '' post_script_name : `` Neuton-Light '' full_name : `` Neuton Light '' - copyright : `` Copyright ( c ) 2010 , 2011 Brian M Zick ( http : //21326.info/ artistenator @ gmail.com ) , with
diff -- git a/ofl/neuton/METADATA.pb b/ofl/neuton/METADATA.pb index e4e31ac..ef0aa19 100644 -- - a/ofl/neuton/METADATA.pb +++ b/ofl/neuton/METADATA.pb @ @ -9,8 +9,8 @ @ fonts { weight : 200 filename : `` Neuton-ExtraLight.ttf '' post_script_name : `` Neuton-ExtraLight '' - full_name : `` Neuton Extralight '' - copyright : `` Copyright ( c ) 2010 , 2011 Brian M Zick ( http : //21326.info/ artistenator @ gmail.com ) , with Reserved Font Name \ '' Neuton\ '' . This Font Software is licensed under the SIL Open Font License , Version 1.1 . This license is available with a FAQ at : http : //scripts.sil.org/OFL '' + full_name : `` Neuton ExtraLight '' + copyright : `` Copyright 2010 The Neuton Project Authors ( http : //www.21326.info/ ) , with Reserved Font Name \ '' Neuton\ '' . '' } fonts { name : `` Neuton '' @ @ -19,7 +19,7 @ @ fonts { filename : `` Neuton-Light.ttf '' post_script_name : `` Neuton-Light '' full_name : `` Neuton Light '' - copyright : `` Copyright ( c ) 2010 , 2011 Brian M Zick ( http : //21326.info/ artistenator @ gmail.com ) , with Reserved Font Name \ '' Neuton\ '' . This Font
diff -- git a/ofl/rubik/METADATA.pb b/ofl/rubik/METADATA.pb index fa4b295..31c9cdc 100644 -- - a/ofl/rubik/METADATA.pb +++ b/ofl/rubik/METADATA.pb @ @ -10,7 +10,7 @ @ fonts { filename : `` Rubik-Light.ttf '' post_script_name : `` Rubik-Light '' full_name : `` Rubik Light '' - copyright : `` Copyright ( c ) 2015 by Hubert & Fischer . All rights reserved . '' + copyright : `` Copyright 2015 The Rubik Project Authors ( meir @ sadan.com ) '' } fonts { name : `` Rubik '' @ @ -19,7 +19,7 @ @ fonts { filename : `` Rubik-LightItalic.ttf '' post_script_name : `` Rubik-LightItalic '' full_name : `` Rubik Light Italic '' - copyright : `` Copyright ( c ) 2015 by Hubert & Fischer . All rights reserved . '' + copyright : `` Copyright 2015 The Rubik Project Authors ( meir @ sadan.com ) '' } fonts { name : `` Rubik '' @ @ -28,7 +28,7 @ @ fonts { filename : `` Rubik-Regular.ttf '' post_script_name : `` Rubik-Regular '' full_name : `` Rubik '' - copyright : `` Copyright ( c ) 2015 by Hubert & Fischer . All rights reserved . '' + copyright : `` Copyright 2015 The Rubik Project Authors
diff -- git a/tools/encodings/GF Glyph Sets/GF-latin-plus_unique-glyphs.nam b/tools/encodings/GF Glyph Sets/GF-latin-plus_unique-glyphs.nam index bc922e5..355a3b8 100644 -- - a/tools/encodings/GF Glyph Sets/GF-latin-plus_unique-glyphs.nam +++ b/tools/encodings/GF Glyph Sets/GF-latin-plus_unique-glyphs.nam @ @ -187,7 +187,6 @ @ 0x02BA ʺ MODIFIER LETTER DOUBLE PRIME 0x02BC ʼ MODIFIER LETTER APOSTROPHE 0x02C7 ˇ CARON -0x02C9 ˉ MODIFIER LETTER MACRON 0x02D8 ˘ BREVE 0x02D9 ˙ DOT ABOVE 0x02DB ˛ OGONEK diff -- git a/tools/encodings/GF Glyph Sets/GF-latin-pro_unique-glyphs.nam b/tools/encodings/GF Glyph Sets/GF-latin-pro_unique-glyphs.nam index 1dbf6c3..d07a3ce 100644 -- - a/tools/encodings/GF Glyph Sets/GF-latin-pro_unique-glyphs.nam +++ b/tools/encodings/GF Glyph Sets/GF-latin-pro_unique-glyphs.nam @ @ -5,6 +5,7 @ @ 0x02BE ʾ MODIFIER LETTER RIGHT HALF RING 0x02BF ʿ MODIFIER LETTER LEFT HALF RING 0x02C8 ˈ MODIFIER LETTER VERTICAL LINE +0x02C9 ˉ MODIFIER LETTER MACRON 0x02CA ˊ MODIFIER LETTER ACUTE ACCENT 0x02CB ˋ MODIFIER LETTER GRAVE ACCENT 0x02CC ˌ MODIFIER LETTER LOW VERTICAL LINE diff -- git a/tools/encodings/GF Glyph Sets/filter lists/nice names/plus_unique-glyphs.txt b/tools/encodings/GF Glyph Sets/filter lists/nice names/plus_unique-glyphs.txt index 8fd0ba1..3d291e7 100644 -- - a/tools/encodings/GF Glyph Sets/filter lists/nice names/plus_unique-glyphs.txt +++ b/tools/encodings/GF Glyph Sets/filter lists/nice names/plus_unique-glyphs.txt @ @ -186,7 +186,6 @ @ primemod doubleprimemod apostrophemod caron -firsttonechinese breve dotaccent ogonek diff -- git a/tools/encodings/GF Glyph Sets/filter lists/nice names/pro_unique-glyphs.txt b/tools/encodings/GF Glyph Sets/filter lists/nice names/pro_unique-glyphs.txt index 3d1e795..0d7438c 100644 -- - a/tools/encodings/GF Glyph Sets/filter lists/nice names/pro_unique-glyphs.txt +++ b/tools/encodings/GF Glyph Sets/filter lists/nice names/pro_unique-glyphs.txt @
diff -- git a/profile/encode.go b/profile/encode.go index dda001f..8a87080 100644 -- - a/profile/encode.go +++ b/profile/encode.go @ @ -214,7 +214,12 @ @ var profileDecoder = [ ] decoder { // int64 keep_frames = 8 func ( b *buffer , m message ) error { return decodeInt64 ( b , & m. ( *Profile ) .keepFramesX ) } , // int64 time_nanos = 9 - func ( b *buffer , m message ) error { return decodeInt64 ( b , & m. ( *Profile ) .TimeNanos ) } , + func ( b *buffer , m message ) error { + if m. ( *Profile ) .TimeNanos ! = 0 { + return ErrConcatProfile + } + return decodeInt64 ( b , & m. ( *Profile ) .TimeNanos ) + } , // int64 duration_nanos = 10 func ( b *buffer , m message ) error { return decodeInt64 ( b , & m. ( *Profile ) .DurationNanos ) } , // ValueType period_type = 11 diff -- git a/profile/profile.go b/profile/profile.go index fd58671..f81151d 100644 -- - a/profile/profile.go +++ b/profile/profile.go @ @ -164,7 +164,7 @ @ func ParseData ( data [ ] byte ) ( *Profile , error ) { return nil , fmt.Errorf (
diff -- git a/internal/driver/driver_test.go b/internal/driver/driver_test.go index 0726fbe..278e790 100644 -- - a/internal/driver/driver_test.go +++ b/internal/driver/driver_test.go @ @ -16,8 +16,17 @ @ package driver import ( '' bytes '' + '' crypto/ecdsa '' + '' crypto/elliptic '' + '' crypto/rand '' + '' crypto/tls '' + '' crypto/x509 '' + '' encoding/pem '' '' fmt '' '' io/ioutil '' + '' math/big '' + '' net/http '' + _ `` net/http/pprof '' '' os '' '' regexp '' '' runtime '' @ @ -329,6 +338,15 @ @ func ( f testFlags ) Parse ( func ( ) ) [ ] string { return f.args } +func emptyFlags ( ) testFlags { + return testFlags { + bools : map [ string ] bool { } , + ints : map [ string ] int { } , + floats : map [ string ] float64 { } , + strings : map [ string ] string { } , + } + } + func baseFlags ( ) testFlags { return testFlags { bools : map [ string ] bool { @ @ -1020,6 +1038,98 @ @ func TestSymbolzAfterMerge ( t *testing.T ) { } } +func TestHttpsInsecure ( t *testing.T ) {
diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..1630cf6 -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,326 @ @ +// Copyright © 2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' bytes '' + '' encoding/json '' + '' fmt '' + '' html/template '' + '' net/http '' + '' path/filepath '' + '' time '' + ) + +var flameGraphTemplate = template.Must ( template.New ( `` graph '' ) .Parse ( ` < ! DOCTYPE html > + < html lang= ''
diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..25c996d -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,352 @ @ +// Copyright © 2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' bytes '' + '' encoding/json '' + '' fmt '' + '' html/template '' + '' net/http '' + '' path/filepath '' + '' time '' + + '' github.com/google/pprof/third_party/d3 '' + '' github.com/google/pprof/third_party/d3flamegraph '' + '' github.com/google/pprof/third_party/d3tip '' + ) + +var flameGraphTemplate = template.Must ( template.New ( `` graph '' )
diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 2f73c29..0ff468c 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -11,4 +11,5 @ @ Raul Silvera < rsilvera @ google.com > Tipp Moseley < tipp @ google.com > Hyoun Kyu Cho < netforce @ google.com > +Martin Spier < spiermar @ gmail.com > diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..72a09ee -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,87 @ @ +// Copyright 2017 Google Inc. All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' encoding/json '' + '' html/template '' +
diff -- git a/internal/driver/cli.go b/internal/driver/cli.go index 4fe9187..355c799 100644 -- - a/internal/driver/cli.go +++ b/internal/driver/cli.go @ @ -113,7 +113,7 @ @ func parseFlags ( o *plugin.Options ) ( *source , [ ] string , error ) { return nil , nil , fmt.Errorf ( `` -- http is not compatible with an output format on the command line '' ) } - si : = pprofVariables [ `` sample_index '' ] .value + si : = pprofVariables [ `` sample_index '' ] .stringValue ( ) si = sampleIndex ( flagTotalDelay , si , `` delay '' , `` -total_delay '' , o.UI ) si = sampleIndex ( flagMeanDelay , si , `` delay '' , `` -mean_delay '' , o.UI ) si = sampleIndex ( flagContentions , si , `` contentions '' , `` -contentions '' , o.UI ) @ @ -162,6 +162,7 @ @ func installFlags ( flag plugin.FlagSet ) flagsInstalled { bools : make ( map [ string ] *bool ) , floats : make ( map [ string ] *float64 ) , strings : make ( map [ string ] *string ) , + stringLists : make ( map [ string ] * [ ] *string ) , }
diff -- git a/internal/driver/driver_test.go b/internal/driver/driver_test.go index 3e0c1a6..019c9c2 100644 -- - a/internal/driver/driver_test.go +++ b/internal/driver/driver_test.go @ @ -80,6 +80,7 @ @ func TestParse ( t *testing.T ) { { `` tags '' , `` heap '' } , { `` tags , unit=bytes '' , `` heap '' } , { `` traces '' , `` cpu '' } , + { `` traces '' , `` heap_tags '' } , { `` dot , alloc_space , flat , focus= [ 234 ] 00 '' , `` heap_alloc '' } , { `` dot , alloc_space , flat , tagshow= [ 2 ] 00 '' , `` heap_alloc '' } , { `` dot , alloc_space , flat , hide=line.*1 ? 23 ? `` , `` heap_alloc '' } , @ @ -398,6 +399,17 @ @ func ( testFetcher ) Fetch ( s string , d , t time.Duration ) ( *profile.Profile , string for _ , s : = range p.Sample { s.NumLabel [ `` bytes '' ] = append ( s.NumLabel [ `` bytes '' ] , tags ... ) } + case `` heap_tags '' : + p = heapProfile ( ) + + for i : = 0
diff -- git a/profile/prune.go b/profile/prune.go index cf9cbb3..83a1c03 100644 -- - a/profile/prune.go +++ b/profile/prune.go @ @ -22,6 +22,41 @ @ import ( '' strings '' ) +var ( + reservedNames = [ ] string { `` ( anonymous namespace ) '' , `` operator ( ) '' } + bracketRx = func ( ) *regexp.Regexp { + var quotedNames [ ] string + for _ , name : = range append ( reservedNames , `` ( `` ) { + quotedNames = append ( quotedNames , regexp.QuoteMeta ( name ) ) + } + return regexp.MustCompile ( strings.Join ( quotedNames , `` | '' ) ) + } ( ) + ) + +// simplifyFunc does some primitive simplification of function names . +func simplifyFunc ( f string ) string { + // Account for leading ' . ' on the PPC ELF v1 ABI . + funcName : = strings.TrimPrefix ( f , `` . '' ) + // Account for unsimplified names -- try to remove the argument list by trimming + // starting from the first ' ( ' , but skipping reserved names that have ' ( ' . + if indeces : = bracketRx.FindAllStringSubmatchIndex ( funcName
diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..f4796c3 -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,330 @ @ +// Copyright © 2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' bytes '' + '' encoding/json '' + '' fmt '' + '' html/template '' + '' net/http '' + '' path/filepath '' + '' time '' + ) + +var flameGraphTemplate = template.Must ( template.New ( `` graph '' ) .Parse ( ` < ! DOCTYPE html > + < html lang= ''
diff -- git a/internal/driver/flamegraph.go b/internal/driver/flamegraph.go new file mode 100644 index 0000000..25c996d -- - /dev/null +++ b/internal/driver/flamegraph.go @ @ -0,0 +1,352 @ @ +// Copyright © 2017 Martin Spier < spiermar @ gmail.com > +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package driver + +import ( + '' bytes '' + '' encoding/json '' + '' fmt '' + '' html/template '' + '' net/http '' + '' path/filepath '' + '' time '' + + '' github.com/google/pprof/third_party/d3 '' + '' github.com/google/pprof/third_party/d3flamegraph '' + '' github.com/google/pprof/third_party/d3tip '' + ) + +var flameGraphTemplate = template.Must ( template.New ( `` graph '' )
diff -- git a/internal/driver/driver_test.go b/internal/driver/driver_test.go index 4931d39..304ccce 100644 -- - a/internal/driver/driver_test.go +++ b/internal/driver/driver_test.go @ @ -472,7 +472,7 @ @ func testFetchSymbols ( source , post string ) ( [ ] byte , error ) { type testSymbolzSymbolizer struct { } func ( testSymbolzSymbolizer ) Symbolize ( variables string , sources plugin.MappingSources , p *profile.Profile ) error { - return symbolz.Symbolize ( sources , testFetchSymbols , p , nil ) + return symbolz.Symbolize ( p , false , sources , testFetchSymbols , nil ) } func fakeDemangler ( name string ) string { diff -- git a/internal/symbolizer/symbolizer.go b/internal/symbolizer/symbolizer.go index e1f531c..5a06c3a 100644 -- - a/internal/symbolizer/symbolizer.go +++ b/internal/symbolizer/symbolizer.go @ @ -42,21 +42,26 @ @ type Symbolizer struct { // test taps for dependency injection var symbolzSymbolize = symbolz.Symbolize var localSymbolize = doLocalSymbolize +var demangleFunction = Demangle // Symbolize attempts to symbolize profile p. First uses binutils on // local binaries ; if the source is a URL it attempts to get any // missed entries using symbolz . func ( s *Symbolizer ) Symbolize ( mode string , sources plugin.MappingSources , p *profile.Profile ) error { - remote , local , force , demanglerMode : = true , true , false , ``
diff -- git a/doc/developer/profile.proto.md b/doc/developer/profile.proto.md index 9932e7e..6cb66f6 100644 -- - a/doc/developer/profile.proto.md +++ b/doc/developer/profile.proto.md @ @ -128,9 +128,11 @ @ size of 6MB . Labels can be string-based or numeric . They are represented by the Label message , with a key identifying the label and either a string or numeric -value . For numeric labels , by convention the key represents the measurement unit -of the numeric value . So for the previous example , the samples would have labels - { “ bytes ” , 2097152 } and { “ bytes ” , 4194304 } . +value . For numeric labels , the measurement unit can be specified in the profile +If no unit is specified and the key is `` request '' or `` alignment '' , +then the units are assumed to be `` bytes '' . Otherwise when no unit is specified +the key will be used as the measurement unit of the numeric value . All tags with +the same key should have the same unit . # # Keep and drop expressions diff -- git a/internal/driver/driver_focus.go b/internal/driver/driver_focus.go index d6f9875..8618a9c 100644 -- - a/internal/driver/driver_focus.go +++ b/internal/driver/driver_focus.go @ @ -87,9 +87,9 @ @ func compileTagFilter (
diff -- git a/doc/developer/profile.proto.md b/doc/developer/profile.proto.md index 9932e7e..6cb66f6 100644 -- - a/doc/developer/profile.proto.md +++ b/doc/developer/profile.proto.md @ @ -128,9 +128,11 @ @ size of 6MB . Labels can be string-based or numeric . They are represented by the Label message , with a key identifying the label and either a string or numeric -value . For numeric labels , by convention the key represents the measurement unit -of the numeric value . So for the previous example , the samples would have labels - { “ bytes ” , 2097152 } and { “ bytes ” , 4194304 } . +value . For numeric labels , the measurement unit can be specified in the profile +If no unit is specified and the key is `` request '' or `` alignment '' , +then the units are assumed to be `` bytes '' . Otherwise when no unit is specified +the key will be used as the measurement unit of the numeric value . All tags with +the same key should have the same unit . # # Keep and drop expressions diff -- git a/internal/driver/driver.go b/internal/driver/driver.go index 0f174b6..acae69f 100644 -- - a/internal/driver/driver.go +++ b/internal/driver/driver.go @ @ -23,6 +23,7 @ @ import ( ''
diff -- git a/doc/developer/profile.proto.md b/doc/developer/profile.proto.md index 9932e7e..d3b0b84 100644 -- - a/doc/developer/profile.proto.md +++ b/doc/developer/profile.proto.md @ @ -128,9 +128,11 @ @ size of 6MB . Labels can be string-based or numeric . They are represented by the Label message , with a key identifying the label and either a string or numeric -value . For numeric labels , by convention the key represents the measurement unit -of the numeric value . So for the previous example , the samples would have labels - { “ bytes ” , 2097152 } and { “ bytes ” , 4194304 } . +value . For numeric labels , the measurement unit can be specified in the profile . +If no unit is specified and the key is `` request '' or `` alignment '' , +then the units are assumed to be `` bytes '' . Otherwise when no unit is specified +the key will be used as the measurement unit of the numeric value . All tags with +the same key should have the same unit . # # Keep and drop expressions diff -- git a/internal/driver/driver.go b/internal/driver/driver.go index 0f174b6..d4b2201 100644 -- - a/internal/driver/driver.go +++ b/internal/driver/driver.go @ @ -23,6 +23,7 @ @ import (
diff -- git a/internal/driver/webhtml.go b/internal/driver/webhtml.go index 48f0fa1..52547f6 100644 -- - a/internal/driver/webhtml.go +++ b/internal/driver/webhtml.go @ @ -14,152 +14,195 @ @ package driver -import `` html/template '' +import ( + '' html/template '' + ) // addTemplates adds a set of template definitions to templates . func addTemplates ( templates *template.Template ) { template.Must ( templates.Parse ( ` { { define `` css '' } } < style type= '' text/css '' > -html { - height : 100 % ; - min-height : 100 % ; - margin : 0px ; +* { + margin : 0 ; + padding : 0 ; + box-sizing : border-box ; } -body { - margin : 0px ; - width : 100 % ; +html , body { height : 100 % ; - min-height : 100 % ; - overflow : hidden ; } - # graphcontainer { +body { + font-family : 'Roboto ' , -apple-system , BlinkMacSystemFont , 'Segoe UI ' , Helvetica , Arial , sans-serif , 'Apple Color Emoji ' , 'Segoe UI Emoji ' , 'Segoe UI Symbol ' ; + font-size : 13px ; + line-height : 1.4 ; display : flex ; flex-direction : column
diff -- git a/boringssl/Dockerfile b/boringssl/Dockerfile index 6ee4741..acfb5b6 100644 -- - a/boringssl/Dockerfile +++ b/boringssl/Dockerfile @ @ -16,8 +16,5 @ @ FROM ossfuzz/base-libfuzzer MAINTAINER mike.aizatsky @ gmail.com - RUN apt-get install -y cmake ninja-build golang -VOLUME /src/boringssl -CMD /src/oss-fuzz/boringssl/build.sh - +COPY build.sh /src/ diff -- git a/docs/debugging.md b/docs/debugging.md index 6345720..c8121d2 100644 -- - a/docs/debugging.md +++ b/docs/debugging.md @ @ -5,7 +5,7 @ @ container : `` ` bash $ python scripts/helper.py shell $ LIB_NAME # runs /bin/bash within container - $ bash /src/oss-fuzz/ $ LIB_NAME/build.sh # to run the build script manually + $ compile # run compilation manually `` ` # # Debugging Fuzzers diff -- git a/docs/new_library.md b/docs/new_library.md index fb5067d..68486d8 100644 -- - a/docs/new_library.md +++ b/docs/new_library.md @ @ -42,7 +42,7 @ @ It is very simple for most libraries : FROM ossfuzz/base-libfuzzer # base image with clang toolchain MAINTAINER YOUR_EMAIL # each file should have a maintainer RUN apt-get install -y ... # install required packages to build a project -CMD /src/oss-fuzz/LIB_NAME/build.sh # specify build script for the project . +COPY build.sh /src/ # install build script for the project . `` ` Expat example : [ expat/Dockerfile ] ( ../expat/Dockerfile ) diff -- git a/expat/Dockerfile b/expat/Dockerfile index d57215f..0de1faf 100644 --
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py index 48bb117..71e4cf6 100755 -- - a/infra/gcb/build.py +++ b/infra/gcb/build.py @ @ -195,27 +195,42 @ @ def get_build_steps ( project_yaml , dockerfile_path ) : env.append ( 'OUT= ' + out ) env.append ( 'MSAN_LIBS_PATH=/workspace/msan ' ) + # To disable running of all fuzz targets while doing |test_all| step . + env.append ( 'SKIP_TEST_TARGET_RUN=1 ' ) + workdir = workdir_from_dockerfile ( dockerfile_path ) if not workdir : workdir = '/src' - build_steps.append ( { + build_steps.extend ( [ # compile - 'name ' : image , - 'env ' : env , - 'args ' : [ - 'bash ' , - '-c ' , - # Remove /out to break loudly when a build script incorrectly uses - # /out instead of $ OUT . - # ` cd /src & & cd { workdir } ` ( where { workdir } is parsed from the - # Dockerfile ) . Container Builder overrides our workdir so we need to add - # this step to set it back . - # We also remove /work and /src to save disk space after a step . - # Container Builder does n't pass -- rm to
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py index 7410c0f..6940bd4 100755 -- - a/infra/gcb/build.py +++ b/infra/gcb/build.py @ @ -185,9 +185,6 @ @ def get_build_steps ( project_yaml , dockerfile_path ) : env.append ( 'OUT= ' + out ) - # To disable running of all fuzz targets while doing |test_all| step . - env.append ( 'SKIP_TEST_TARGET_RUN=1 ' ) - workdir = workdir_from_dockerfile ( dockerfile_path ) if not workdir : workdir = '/src' @ @ -209,17 +206,6 @ @ def get_build_steps ( project_yaml , dockerfile_path ) : 'rm -r /out & & cd /src & & cd { 1 } & & mkdir -p { 0 } & & compile & & rm -rf /work & & rm -rf /src'.format ( out , workdir ) , ] , } , - # test binaries - { 'name ' : 'gcr.io/oss-fuzz-base/base-runner ' , - 'env ' : env , - 'args ' : [ - 'bash ' , - '-c ' , - # Verify that fuzzers have been built properly and are not broken . - # TODO ( mmoroz ) : raise a notification if not passing the tests . - 'test_all' - ] - } , # zip binaries { 'name ' :
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py index 7410c0f..6940bd4 100755 -- - a/infra/gcb/build.py +++ b/infra/gcb/build.py @ @ -185,9 +185,6 @ @ def get_build_steps ( project_yaml , dockerfile_path ) : env.append ( 'OUT= ' + out ) - # To disable running of all fuzz targets while doing |test_all| step . - env.append ( 'SKIP_TEST_TARGET_RUN=1 ' ) - workdir = workdir_from_dockerfile ( dockerfile_path ) if not workdir : workdir = '/src' @ @ -209,17 +206,6 @ @ def get_build_steps ( project_yaml , dockerfile_path ) : 'rm -r /out & & cd /src & & cd { 1 } & & mkdir -p { 0 } & & compile & & rm -rf /work & & rm -rf /src'.format ( out , workdir ) , ] , } , - # test binaries - { 'name ' : 'gcr.io/oss-fuzz-base/base-runner ' , - 'env ' : env , - 'args ' : [ - 'bash ' , - '-c ' , - # Verify that fuzzers have been built properly and are not broken . - # TODO ( mmoroz ) : raise a notification if not passing the tests . - 'test_all' - ] - } , # zip binaries { 'name ' :
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py index 48bb117..71e4cf6 100755 -- - a/infra/gcb/build.py +++ b/infra/gcb/build.py @ @ -195,27 +195,42 @ @ def get_build_steps ( project_yaml , dockerfile_path ) : env.append ( 'OUT= ' + out ) env.append ( 'MSAN_LIBS_PATH=/workspace/msan ' ) + # To disable running of all fuzz targets while doing |test_all| step . + env.append ( 'SKIP_TEST_TARGET_RUN=1 ' ) + workdir = workdir_from_dockerfile ( dockerfile_path ) if not workdir : workdir = '/src' - build_steps.append ( { + build_steps.extend ( [ # compile - 'name ' : image , - 'env ' : env , - 'args ' : [ - 'bash ' , - '-c ' , - # Remove /out to break loudly when a build script incorrectly uses - # /out instead of $ OUT . - # ` cd /src & & cd { workdir } ` ( where { workdir } is parsed from the - # Dockerfile ) . Container Builder overrides our workdir so we need to add - # this step to set it back . - # We also remove /work and /src to save disk space after a step . - # Container Builder does n't pass -- rm to
diff -- git a/projects/libxml2/libxml2_xml_read_memory_fuzzer.cc b/projects/libxml2/libxml2_xml_read_memory_fuzzer.cc deleted file mode 100644 index 4ae6035..0000000 -- - a/projects/libxml2/libxml2_xml_read_memory_fuzzer.cc +++ /dev/null @ @ -1,44 +0,0 @ @ -// Copyright 2015 The Chromium Authors . All rights reserved . -// Use of this source code is governed by a BSD-style license that can be -// found in the LICENSE file . - - # include < cassert > - # include < cstddef > - # include < cstdint > - - # include < functional > - # include < limits > - # include < string > - - # include `` libxml/parser.h '' - # include `` libxml/xmlsave.h '' - -void ignore ( void* ctx , const char* msg , ... ) { - // Error handler to avoid spam of error messages from libxml parser . - } - -extern `` C '' int LLVMFuzzerTestOneInput ( const uint8_t* data , size_t size ) { - xmlSetGenericErrorFunc ( NULL , & ignore ) ; - - // Test default empty options value and some random combination . - std : :string data_string ( reinterpret_cast < const char* > ( data ) , size ) ; - const std : :size_t data_hash = std
diff -- git a/projects/libxml2/libxml2_xml_read_memory_fuzzer.cc b/projects/libxml2/libxml2_xml_read_memory_fuzzer.cc deleted file mode 100644 index 4ae6035..0000000 -- - a/projects/libxml2/libxml2_xml_read_memory_fuzzer.cc +++ /dev/null @ @ -1,44 +0,0 @ @ -// Copyright 2015 The Chromium Authors . All rights reserved . -// Use of this source code is governed by a BSD-style license that can be -// found in the LICENSE file . - - # include < cassert > - # include < cstddef > - # include < cstdint > - - # include < functional > - # include < limits > - # include < string > - - # include `` libxml/parser.h '' - # include `` libxml/xmlsave.h '' - -void ignore ( void* ctx , const char* msg , ... ) { - // Error handler to avoid spam of error messages from libxml parser . - } - -extern `` C '' int LLVMFuzzerTestOneInput ( const uint8_t* data , size_t size ) { - xmlSetGenericErrorFunc ( NULL , & ignore ) ; - - // Test default empty options value and some random combination . - std : :string data_string ( reinterpret_cast < const char* > ( data ) , size ) ; - const std : :size_t data_hash = std
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py index 48bb117..71e4cf6 100755 -- - a/infra/gcb/build.py +++ b/infra/gcb/build.py @ @ -195,27 +195,42 @ @ def get_build_steps ( project_yaml , dockerfile_path ) : env.append ( 'OUT= ' + out ) env.append ( 'MSAN_LIBS_PATH=/workspace/msan ' ) + # To disable running of all fuzz targets while doing |test_all| step . + env.append ( 'SKIP_TEST_TARGET_RUN=1 ' ) + workdir = workdir_from_dockerfile ( dockerfile_path ) if not workdir : workdir = '/src' - build_steps.append ( { + build_steps.extend ( [ # compile - 'name ' : image , - 'env ' : env , - 'args ' : [ - 'bash ' , - '-c ' , - # Remove /out to break loudly when a build script incorrectly uses - # /out instead of $ OUT . - # ` cd /src & & cd { workdir } ` ( where { workdir } is parsed from the - # Dockerfile ) . Container Builder overrides our workdir so we need to add - # this step to set it back . - # We also remove /work and /src to save disk space after a step . - # Container Builder does n't pass -- rm to
diff -- git a/infra/base-images/base-runner/bad_build_check b/infra/base-images/base-runner/bad_build_check index e133ea9..1509a77 100755 -- - a/infra/base-images/base-runner/bad_build_check +++ b/infra/base-images/base-runner/bad_build_check @ @ -1,4 +1,4 @ @ - # ! /bin/bash -ux + # ! /bin/bash -u # Copyright 2017 Google Inc. # # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; @ @ -15,56 +15,63 @ @ # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # - # Verify that the given fuzzer has proper coverage instrumentation . + # A minimal number of runs to test fuzz target with a non-empty input . +MIN_NUMBER_OF_RUNS=4 + + # The `` example '' target has 73 with ASan , 65 with UBSan , and 6648 with MSan . + # Real world targets have greater values ( arduinojson :
diff -- git a/infra/base-images/base-builder/Dockerfile b/infra/base-images/base-builder/Dockerfile index 2a9a85e..a99543d 100644 -- - a/infra/base-images/base-builder/Dockerfile +++ b/infra/base-images/base-builder/Dockerfile @ @ -37,7 +37,7 @ @ ENV COVERAGE_FLAGS= '' -fsanitize=fuzzer-no-link '' # Use '-Wno-unused-command-line-argument ' to suppress `` warning : -ldl : 'linker ' input unused '' # messages which are treated as errors by some projects . -ENV COVERAGE_FLAGS_coverage `` -fprofile-instr-generate -fcoverage-mapping -pthread -Wl , -ldl -Wno-unused-command-line-argument '' +ENV COVERAGE_FLAGS_coverage `` -fprofile-instr-generate -fcoverage-mapping -Wl , -- no-as-needed -Wl , -lpthread -Wl , -ldl -Wl , -lm -Wno-unused-command-line-argument '' # Default sanitizer and fuzzing engine to use . ENV SANITIZER= '' address ''
diff -- git a/infra/base-images/base-runner/bad_build_check b/infra/base-images/base-runner/bad_build_check index e133ea9..9ff33c6 100755 -- - a/infra/base-images/base-runner/bad_build_check +++ b/infra/base-images/base-runner/bad_build_check @ @ -1,4 +1,4 @ @ - # ! /bin/bash -ux + # ! /bin/bash -u # Copyright 2017 Google Inc. # # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; @ @ -18,41 +18,38 @ @ # Verify that the given fuzzer has proper coverage instrumentation . function check_instrumentation { local FUZZER= $ 1 + local LOG_PATH_FOR_BROKEN_TARGET= $ 2 local CHECK_FAILED=0 + local FUZZER_OUTPUT= '' /tmp/ $ ( basename $ FUZZER ) .output '' if [ [ `` $ FUZZING_ENGINE '' = libfuzzer ] ] ; then - CHECK_FAILED= $ ( $ FUZZER -max_total_time=4 2 > & 1 | egrep `` ERROR : no interesting inputs were found . Is the code instrumented '' -c ) + $ FUZZER -runs=4 & > $ FUZZER_OUTPUT + CHECK_FAILED= $ ( cat $ FUZZER_OUTPUT | egrep `` ERROR : no interesting inputs were found . Is the code instrumented '' -c ) if ( ( $ CHECK_FAILED > 0 ) ) ; then - echo `` BAD BUILD : the code does not seem to have coverage instrumentation . '' + echo
diff -- git a/infra/base-images/base-runner/bad_build_check b/infra/base-images/base-runner/bad_build_check index e133ea9..1509a77 100755 -- - a/infra/base-images/base-runner/bad_build_check +++ b/infra/base-images/base-runner/bad_build_check @ @ -1,4 +1,4 @ @ - # ! /bin/bash -ux + # ! /bin/bash -u # Copyright 2017 Google Inc. # # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; @ @ -15,56 +15,63 @ @ # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # - # Verify that the given fuzzer has proper coverage instrumentation . + # A minimal number of runs to test fuzz target with a non-empty input . +MIN_NUMBER_OF_RUNS=4 + + # The `` example '' target has 73 with ASan , 65 with UBSan , and 6648 with MSan . + # Real world targets have greater values ( arduinojson :
diff -- git a/infra/base-images/base-runner/bad_build_check b/infra/base-images/base-runner/bad_build_check index e133ea9..b2c2521 100755 -- - a/infra/base-images/base-runner/bad_build_check +++ b/infra/base-images/base-runner/bad_build_check @ @ -1,4 +1,4 @ @ - # ! /bin/bash -ux + # ! /bin/bash -u # Copyright 2017 Google Inc. # # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; @ @ -15,56 +15,65 @ @ # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # - # Verify that the given fuzzer has proper coverage instrumentation . + # A minimal number of runs to test fuzz target with a non-empty input . +MIN_NUMBER_OF_RUNS=4 + + # The `` example '' target has 73 with ASan , 65 with UBSan , and 6648 with MSan . + # Real world targets have greater values ( arduinojson :
diff -- git a/docs/reproducing.md b/docs/reproducing.md index 109b22c..0c337cc 100644 -- - a/docs/reproducing.md +++ b/docs/reproducing.md @ @ -29,8 +29,15 @ @ If you are not sure how to build the fuzzer using the project 's build system , you may also use Docker ( [ how ? ] ( installing_docker.md ) , [ why ? ] ( faq.md # why-do-you-use-docker ) ) commands to replicate the exact build steps used by OSS-Fuzz and then feed the reproducer input to the fuzz target . - # # Build failures -We will also report build failures for your project . To reproduce these , follow the [ Building using docker ] ( # building-using-docker ) and if necessary the [ Reproducing build checks ] ( reproducing-build-checks ) sections below . +- *Pull the latest Docker images : * + + `` ` bash + $ python infra/helper.py pull_images + `` ` + + Docker images get regularly updated . In some cases , a particular issue can be + reproduced only with a fresh images being used . + # # Building using Docker `` ` bash @ @ -67,6 +74,14 @ @ $ python infra/helper.py reproduce $ PROJECT_NAME < fuzz_target_name > < testcase_pa
diff -- git a/boringssl/Jenkinsfile b/boringssl/Jenkinsfile index bb7325b..8701c04 100644 -- - a/boringssl/Jenkinsfile +++ b/boringssl/Jenkinsfile @ @ -20,7 +20,6 @ @ def libfuzzerPipeline = fileLoader.fromGit ( libfuzzerPipeline { git = `` https : //boringssl.googlesource.com/boringssl '' - dockerfile = `` oss-fuzz/boringssl/Dockerfile '' } diff -- git a/docs/new_library.md b/docs/new_library.md index fe81c79..f8cc75d 100644 -- - a/docs/new_library.md +++ b/docs/new_library.md @ @ -29,7 +29,6 @ @ def libfuzzerBuild = fileLoader.fromGit ( 'infra/libfuzzer-pipeline.groovy ' , libfuzzerBuild { git = `` git : //git.code.sf.net/p/expat/code_git '' - dockerfile = `` oss-fuzz/expat/Dockerfile '' } `` ` diff -- git a/expat/Jenkinsfile b/expat/Jenkinsfile index 8f2908a..32afa56 100644 -- - a/expat/Jenkinsfile +++ b/expat/Jenkinsfile @ @ -19,5 +19,4 @ @ def libfuzzerBuild = fileLoader.fromGit ( 'infra/libfuzzer-pipeline.groovy ' , libfuzzerBuild { git = `` git : //git.code.sf.net/p/expat/code_git '' - dockerfile = `` oss-fuzz/expat/Dockerfile '' } diff -- git a/freetype2/Jenkinsfile b/freetype2/Jenkinsfile index e26395c..9267970 100644 -- - a/freetype2/Jenkinsfile +++ b/freetype2/Jenkinsfile @ @ -20,6 +20,5 @ @ def libfuzzerBuild = fileLoader.fromGit ( libfuzzerBuild { git = `` git : //git.sv.nongnu.org/freetype/freetype2.git '' - dockerfile = `` oss-fuzz/freetype2/Dockerfile '' } diff -- git a/infra/libfuzzer-pipeline.groovy b/infra/libfuzzer-pipeline.groovy index 5faba5a..66d17c8 100644 -- - a/infra/libfuzzer-pipeline.groovy +++ b/infra/libfuzzer-pipeline.groovy @ @ -22,12 +22,11 @ @ def call ( body ) { body ( ) // Mandatory configuration -
diff -- git a/infra/base-images/base-runner/bad_build_check b/infra/base-images/base-runner/bad_build_check index e133ea9..1509a77 100755 -- - a/infra/base-images/base-runner/bad_build_check +++ b/infra/base-images/base-runner/bad_build_check @ @ -1,4 +1,4 @ @ - # ! /bin/bash -ux + # ! /bin/bash -u # Copyright 2017 Google Inc. # # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; @ @ -15,56 +15,63 @ @ # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # - # Verify that the given fuzzer has proper coverage instrumentation . + # A minimal number of runs to test fuzz target with a non-empty input . +MIN_NUMBER_OF_RUNS=4 + + # The `` example '' target has 73 with ASan , 65 with UBSan , and 6648 with MSan . + # Real world targets have greater values ( arduinojson :
diff -- git a/infra/base-images/base-runner/download_corpus b/infra/base-images/base-runner/download_corpus deleted file mode 100755 index 6d88245..0000000 -- - a/infra/base-images/base-runner/download_corpus +++ /dev/null @ @ -1,26 +0,0 @ @ - # ! /bin/bash -u - # Copyright 2018 Google Inc. - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - # you may not use this file except in compliance with the License . - # You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software - # distributed under the License is distributed on an `` AS IS '' BASIS , - # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . - # See the License for the specific language governing permissions and - # limitations under the License . - # - # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py index 7410c0f..6940bd4 100755 -- - a/infra/gcb/build.py +++ b/infra/gcb/build.py @ @ -185,9 +185,6 @ @ def get_build_steps ( project_yaml , dockerfile_path ) : env.append ( 'OUT= ' + out ) - # To disable running of all fuzz targets while doing |test_all| step . - env.append ( 'SKIP_TEST_TARGET_RUN=1 ' ) - workdir = workdir_from_dockerfile ( dockerfile_path ) if not workdir : workdir = '/src' @ @ -209,17 +206,6 @ @ def get_build_steps ( project_yaml , dockerfile_path ) : 'rm -r /out & & cd /src & & cd { 1 } & & mkdir -p { 0 } & & compile & & rm -rf /work & & rm -rf /src'.format ( out , workdir ) , ] , } , - # test binaries - { 'name ' : 'gcr.io/oss-fuzz-base/base-runner ' , - 'env ' : env , - 'args ' : [ - 'bash ' , - '-c ' , - # Verify that fuzzers have been built properly and are not broken . - # TODO ( mmoroz ) : raise a notification if not passing the tests . - 'test_all' - ] - } , # zip binaries { 'name ' :
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py deleted file mode 100755 index 7ebf4c0..0000000 -- - a/infra/gcb/build.py +++ /dev/null @ @ -1,350 +0,0 @ @ - # ! /usr/bin/python2 - '' '' '' Starts project build on Google Cloud Builder . - -Usage : build.py < project_dir > - '' '' '' - -import base64 -import collections -import datetime -import os -import re -import subprocess -import sys -import time -import urllib -import yaml - -from oauth2client.client import GoogleCredentials -from oauth2client.service_account import ServiceAccountCredentials -from googleapiclient.discovery import build - -BUILD_TIMEOUT = 10 * 60 * 60 - -CONFIGURATIONS = { - 'sanitizer-address ' : [ 'SANITIZER=address ' ] , - 'sanitizer-memory ' : [ 'SANITIZER=memory ' ] , - 'sanitizer-undefined ' : [ 'SANITIZER=undefined ' ] , - 'sanitizer-coverage ' : [ 'SANITIZER=coverage ' ] , - 'engine-libfuzzer ' : [ 'FUZZING_ENGINE=libfuzzer ' ] , - 'engine-afl ' : [ 'FUZZING_ENGINE=afl ' ] , - 'engine-honggfuzz ' : [ 'FUZZING_ENGINE=honggfuzz ' ] , - 'engine-none ' : [ 'FUZZING_ENGINE=none ' ] , - } - -EngineInfo = collections.namedtuple ( 'EngineInfo ' , - [ 'upload_bucket ' , 'supported_sanitizers ' ] ) - -ENGINE_INFO = { - 'libfuzzer ' : - EngineInfo ( - upload_bucket='clusterfuzz-builds '
diff -- git a/projects/libpng/build.sh b/projects/libpng/build.sh old mode 100755 new mode 100644 index 0b6a239..7b8150f -- - a/projects/libpng/build.sh +++ b/projects/libpng/build.sh @ @ -1,4 +1,5 @ @ # ! /bin/bash -eu + # Copyright 2017 Glenn Randers-Pehrson # Copyright 2016 Google Inc. # # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; @ @ -13,6 +14,12 @ @ # See the License for the specific language governing permissions and # limitations under the License . # + # Last changed in libpng 1.6.32 [ August 24 , 2017 ] + # + # Revisions by Glenn Randers-Pehson , 2017 : + # 1 . Build only the library , not the tools ( changed `` make -j $ ( nproc ) all '' to + # `` make -j $ ( nproc ) libpng16.la '' ) . + # 2 . Disabled WARNING and WRITE options in pnglibconf.dfa . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
diff -- git a/projects/skia/Dockerfile b/projects/skia/Dockerfile index e1d54ee..fe05fa6 100644 -- - a/projects/skia/Dockerfile +++ b/projects/skia/Dockerfile @ @ -17,13 +17,18 @ @ FROM gcr.io/oss-fuzz-base/base-builder MAINTAINER kjlubick @ chromium.org -RUN apt-get update & & apt-get install -y python wget libglu1-mesa-dev patchelf + # Mesa needed to build swiftshader +RUN apt-get update & & apt-get install -y python wget libglu1-mesa-dev cmake -RUN git clone 'https : //chromium.googlesource.com/chromium/tools/depot_tools.git' +RUN git clone 'https : //chromium.googlesource.com/chromium/tools/depot_tools.git ' -- depth 1 ENV PATH= '' $ { SRC } /depot_tools : $ { PATH } '' - # checkout all sources needed to build your project -RUN git clone https : //skia.googlesource.com/skia.git +RUN git clone https : //swiftshader.googlesource.com/SwiftShader -- depth 1 +WORKDIR SwiftShader +RUN git submodule update -- init +WORKDIR .. + +RUN git clone https : //skia.googlesource.com/skia.git -- depth 1 # current directory for build script WORKDIR skia @ @ -86,3 +91,4 @ @ COPY json.dict $ SRC/skia/json.dict COPY BUILD.gn.diff $ SRC/skia/BUILD.gn.diff RUN cat BUILD.gn.diff > > BUILD.gn +WORKDIR .. \ No newline at end of file diff -- git a/projects/skia/build.sh b/projects/skia/build.sh index 80ec0bf..c33a2c6 100644 -- - a/projects/skia/build.sh +++ b/projects/skia/build.sh @ @ -15,17 +15,45 @ @ # # # # # # # # # # # # #
diff -- git a/infra/base-images/base-clang/checkout_build_install_llvm.sh b/infra/base-images/base-clang/checkout_build_install_llvm.sh index d4ab51c..dd9a6cc 100755 -- - a/infra/base-images/base-clang/checkout_build_install_llvm.sh +++ b/infra/base-images/base-clang/checkout_build_install_llvm.sh @ @ -26,10 +26,11 @ @ cd $ SRC/chromium_tools git clone https : //chromium.googlesource.com/chromium/src/tools/clang cd clang -OUR_LLVM_REVISION=333631 # For manual bumping . +OUR_LLVM_REVISION=335507 # For manual bumping . +FORCE_OUR_REVISION=0 # To allow for manual downgrades . LLVM_REVISION= $ ( grep -Po `` CLANG_REVISION = '\K\d+ ( ? = ' ) '' scripts/update.py ) -if [ $ OUR_LLVM_REVISION -gt $ LLVM_REVISION ] ; then +if [ $ OUR_LLVM_REVISION -gt $ LLVM_REVISION ] || [ $ FORCE_OUR_REVISION -ne 0 ] ; then LLVM_REVISION= $ OUR_LLVM_REVISION fi diff -- git a/infra/base-images/base-runner/Dockerfile b/infra/base-images/base-runner/Dockerfile index decb55d..7aac7c5 100644 -- - a/infra/base-images/base-runner/Dockerfile +++ b/infra/base-images/base-runner/Dockerfile @ @ -19,7 +19,7 @ @ MAINTAINER mike.aizatsky @ gmail.com RUN apt-get install -y zip file libunwind8 binutils libblocksruntime0 \ fonts-dejavu python3 COPY bad_build_check coverage llvm-cov llvm-profdata llvm-symbolizer reproduce \ - run_fuzzer sancov test_all test_report minijail0 run_minijail /usr/local/bin/ + run_fuzzer sancov test_all minijail0 run_minijail /usr/local/bin/ # Default environment options for various sanitizers . # Note that these match the settings used in ClusterFuzz and diff -- git a/infra/base-images/base-runner/coverage b/infra/base-images/base-runner/coverage index e70efee..65fd025 100755 -- - a/infra/base-images/base-runner/coverage +++ b/infra/base-images/base-runner/coverage @ @ -46,6 +46,9 @ @ function run_fuzz_target { # Run each fuzz
diff -- git a/projects/ots/Dockerfile b/projects/ots/Dockerfile index 25f29b0..fa265ef 100644 -- - a/projects/ots/Dockerfile +++ b/projects/ots/Dockerfile @ @ -19,5 +19,4 @ @ MAINTAINER mmoroz @ chromium.org RUN apt-get install -y make autoconf automake libtool pkg-config zlib1g-dev RUN git clone -- depth 1 https : //github.com/khaledhosny/ots.git WORKDIR ots -COPY build.sh ots_fuzzer . * $ SRC/ -COPY seed_corpus $ SRC/seed_corpus +COPY build.sh ots-fuzzer . * $ SRC/ diff -- git a/projects/ots/build.sh b/projects/ots/build.sh index 238520d..02d9db6 100755 -- - a/projects/ots/build.sh +++ b/projects/ots/build.sh @ @ -19,12 +19,9 @ @ ./autogen.sh ./configure -make libots.a libwoff2.a libbrotli.a - # Build the fuzzer . - $ CXX $ CXXFLAGS -std=c++11 -Iinclude \ - $ SRC/ots_fuzzer.cc -o $ OUT/ots_fuzzer \ - -lFuzzingEngine -lz $ SRC/ots/libots.a $ SRC/ots/libwoff2.a $ SRC/ots/libbrotli.a +make -j $ ( nproc ) V=1 CXXFLAGS= '' $ CXXFLAGS -DOTS_FUZZER_NO_MAIN '' LDFLAGS= '' -lFuzzingEngine '' ots-fuzzer +mv ots-fuzzer $ OUT/ -cp $ SRC/ots_fuzzer.options $ OUT/ -zip $ OUT/ots_fuzzer_seed_corpus.zip $ SRC/seed_corpus/* +cp $ SRC/ots-fuzzer.options $ OUT/ +zip -j -r $ OUT/ots-fuzzer_seed_corpus.zip $ SRC/ots/tests/fonts diff -- git a/projects/ots/ots-fuzzer.options b/projects/ots/ots-fuzzer.options new file mode 100644 index 0000000..dc3492c -- - /dev/null +++ b/projects/ots/ots-fuzzer.options @ @ -0,0 +1,2 @ @ + [ libfuzzer ] +max_len = 16800 diff -- git a/projects/ots/ots_fuzzer.cc b/projects/ots/ots_fuzzer.cc deleted file mode 100644 index
diff -- git a/projects/firefox/Dockerfile b/projects/firefox/Dockerfile new file mode 100644 index 0000000..d6188a8 -- - /dev/null +++ b/projects/firefox/Dockerfile @ @ -0,0 +1,26 @ @ + # Copyright 2018 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + # + # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
diff -- git a/projects/nss/Dockerfile b/projects/nss/Dockerfile index 5b2976f..f494a9b 100644 -- - a/projects/nss/Dockerfile +++ b/projects/nss/Dockerfile @ @ -16,11 +16,11 @ @ FROM ossfuzz/base-builder MAINTAINER mmoroz @ chromium.org -RUN apt-get install -y make autoconf automake libtool mercurial zlib1g-dev +RUN apt-get install -y make mercurial zlib1g-dev gyp ninja-build libssl-dev RUN hg clone https : //hg.mozilla.org/projects/nspr nspr RUN hg clone https : //hg.mozilla.org/projects/nss nss RUN git clone -- depth 1 https : //github.com/mozilla/nss-fuzzing-corpus.git nss-corpus WORKDIR nss -COPY build.sh fuzzers/* $ SRC/ +COPY build.sh $ SRC/ diff -- git a/projects/nss/build.sh b/projects/nss/build.sh index 6a35c47..98024b1 100755 -- - a/projects/nss/build.sh +++ b/projects/nss/build.sh @ @ -15,54 +15,6 @ @ # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # - # Build the library . -make CCC= '' $ CXX '' XCFLAGS= '' $ CXXFLAGS '' SANITIZER_CFLAGS= '' $
diff -- git a/infra/gcb/build.py b/infra/gcb/build.py deleted file mode 100755 index 7ebf4c0..0000000 -- - a/infra/gcb/build.py +++ /dev/null @ @ -1,350 +0,0 @ @ - # ! /usr/bin/python2 - '' '' '' Starts project build on Google Cloud Builder . - -Usage : build.py < project_dir > - '' '' '' - -import base64 -import collections -import datetime -import os -import re -import subprocess -import sys -import time -import urllib -import yaml - -from oauth2client.client import GoogleCredentials -from oauth2client.service_account import ServiceAccountCredentials -from googleapiclient.discovery import build - -BUILD_TIMEOUT = 10 * 60 * 60 - -CONFIGURATIONS = { - 'sanitizer-address ' : [ 'SANITIZER=address ' ] , - 'sanitizer-memory ' : [ 'SANITIZER=memory ' ] , - 'sanitizer-undefined ' : [ 'SANITIZER=undefined ' ] , - 'sanitizer-coverage ' : [ 'SANITIZER=coverage ' ] , - 'engine-libfuzzer ' : [ 'FUZZING_ENGINE=libfuzzer ' ] , - 'engine-afl ' : [ 'FUZZING_ENGINE=afl ' ] , - 'engine-honggfuzz ' : [ 'FUZZING_ENGINE=honggfuzz ' ] , - 'engine-none ' : [ 'FUZZING_ENGINE=none ' ] , - } - -EngineInfo = collections.namedtuple ( 'EngineInfo ' , - [ 'upload_bucket ' , 'supported_sanitizers ' ] ) - -ENGINE_INFO = { - 'libfuzzer ' : - EngineInfo ( - upload_bucket='clusterfuzz-builds '
diff -- git a/docs/faq.md b/docs/faq.md index f040f2a..d1141f4 100644 -- - a/docs/faq.md +++ b/docs/faq.md @ @ -93,6 +93,16 @ @ If your fuzz target is running for many days and does not find bugs or new cover In either case , look at the [ coverage reports ] ( clusterfuzz.md # coverage-reports ) for your target ( s ) and figure out why some parts of the code are not covered . + # # Why are code coverage reports public ? + +We work with open source projects and try to keep as much information public as +possible . The only information that we keep private is the following : +- Bugs that were found in the past 90 days and were not fixed 30+ days ago . +- Corpora , as it may contain inputs that are one-mutation-off a bug reproducer . + +We believe that making code coverage reports public does not put users at risk , +as the bugs are still there in both covered and non-covered parts of the code . + # # What happens when I rename a fuzz target ? If you rename your fuzz targets , the existing bugs for those targets
diff -- git a/docs/faq.md b/docs/faq.md index f040f2a..f8e24ea 100644 -- - a/docs/faq.md +++ b/docs/faq.md @ @ -93,6 +93,12 @ @ If your fuzz target is running for many days and does not find bugs or new cover In either case , look at the [ coverage reports ] ( clusterfuzz.md # coverage-reports ) for your target ( s ) and figure out why some parts of the code are not covered . + # # Why are code coverage reports public ? + +We work with open source projects and try to keep as much information public as +possible . We believe that public code coverage reports do not put users at risk , +as they do not indicate the presence of bugs or lack thereof . + # # What happens when I rename a fuzz target ? If you rename your fuzz targets , the existing bugs for those targets will get closed and fuzzing will start from scratch from a fresh corpora ( seed corpus only ) . Similar corpora will get accumulated over time depending on the number of cpu cycles that original fuzz target has run . If this is not desirable , make sure to
diff -- git a/projects/libvpx/Dockerfile b/projects/libvpx/Dockerfile new file mode 100644 index 0000000..2386439 -- - /dev/null +++ b/projects/libvpx/Dockerfile @ @ -0,0 +1,22 @ @ + # Copyright 2018 Google Inc. + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + # + # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
diff -- git a/boringssl/Jenkinsfile b/boringssl/Jenkinsfile index bb7325b..8701c04 100644 -- - a/boringssl/Jenkinsfile +++ b/boringssl/Jenkinsfile @ @ -20,7 +20,6 @ @ def libfuzzerPipeline = fileLoader.fromGit ( libfuzzerPipeline { git = `` https : //boringssl.googlesource.com/boringssl '' - dockerfile = `` oss-fuzz/boringssl/Dockerfile '' } diff -- git a/docs/new_library.md b/docs/new_library.md index fe81c79..f8cc75d 100644 -- - a/docs/new_library.md +++ b/docs/new_library.md @ @ -29,7 +29,6 @ @ def libfuzzerBuild = fileLoader.fromGit ( 'infra/libfuzzer-pipeline.groovy ' , libfuzzerBuild { git = `` git : //git.code.sf.net/p/expat/code_git '' - dockerfile = `` oss-fuzz/expat/Dockerfile '' } `` ` diff -- git a/expat/Jenkinsfile b/expat/Jenkinsfile index 8f2908a..32afa56 100644 -- - a/expat/Jenkinsfile +++ b/expat/Jenkinsfile @ @ -19,5 +19,4 @ @ def libfuzzerBuild = fileLoader.fromGit ( 'infra/libfuzzer-pipeline.groovy ' , libfuzzerBuild { git = `` git : //git.code.sf.net/p/expat/code_git '' - dockerfile = `` oss-fuzz/expat/Dockerfile '' } diff -- git a/freetype2/Jenkinsfile b/freetype2/Jenkinsfile index e26395c..9267970 100644 -- - a/freetype2/Jenkinsfile +++ b/freetype2/Jenkinsfile @ @ -20,6 +20,5 @ @ def libfuzzerBuild = fileLoader.fromGit ( libfuzzerBuild { git = `` git : //git.sv.nongnu.org/freetype/freetype2.git '' - dockerfile = `` oss-fuzz/freetype2/Dockerfile '' } diff -- git a/infra/libfuzzer-pipeline.groovy b/infra/libfuzzer-pipeline.groovy index 5faba5a..daaf201 100644 -- - a/infra/libfuzzer-pipeline.groovy +++ b/infra/libfuzzer-pipeline.groovy @ @ -22,13 +22,12 @ @ def call ( body ) { body ( ) // Mandatory configuration -
diff -- git a/projects/wuffs/build.sh b/projects/wuffs/build.sh index 48846e8..84aaede 100755 -- - a/projects/wuffs/build.sh +++ b/projects/wuffs/build.sh @ @ -22,5 +22,5 @ @ for f in fuzz/c/std/*_fuzzer.cc ; do b= $ ( basename $ f _fuzzer.cc ) $ CXX $ CXXFLAGS -std=c++11 $ f -o $ OUT/ $ { b } _fuzzer -lFuzzingEngine - zip -- junk-paths $ OUT/ $ { b } _fuzzer_seed_corpus.zip test/testdata/*. $ b + zip -- junk-paths $ OUT/ $ { b } _fuzzer_seed_corpus.zip test/data/*. $ b done
diff -- git a/infra/base-images/base-runner/bad_build_check b/infra/base-images/base-runner/bad_build_check index e133ea9..d5ffa17 100755 -- - a/infra/base-images/base-runner/bad_build_check +++ b/infra/base-images/base-runner/bad_build_check @ @ -19,34 +19,29 @ @ function check_instrumentation { local FUZZER= $ 1 local CHECK_FAILED=0 + local FUZZER_OUTPUT= '' /tmp/ $ ( basename $ FUZZER ) .output '' if [ [ `` $ FUZZING_ENGINE '' = libfuzzer ] ] ; then - CHECK_FAILED= $ ( $ FUZZER -max_total_time=4 2 > & 1 | egrep `` ERROR : no interesting inputs were found . Is the code instrumented '' -c ) + $ FUZZER -runs=4 & > $ FUZZER_OUTPUT + CHECK_FAILED= $ ( cat $ FUZZER_OUTPUT | egrep `` ERROR : no interesting inputs were found . Is the code instrumented '' -c ) if ( ( $ CHECK_FAILED > 0 ) ) ; then - echo `` BAD BUILD : the code does not seem to have coverage instrumentation . '' + echo `` BAD BUILD : the target does not seem to have coverage instrumentation . '' + exit 1 fi - fi - # honggfuzz is not fully integrated , avoid performing the following check . - if [ [ `` $ FUZZING_ENGINE '' ! = honggfuzz ] ] ; then - if ( (
diff -- git a/projects/bignum-fuzzer/Dockerfile b/projects/bignum-fuzzer/Dockerfile index 373d99c..1d9d1cc 100644 -- - a/projects/bignum-fuzzer/Dockerfile +++ b/projects/bignum-fuzzer/Dockerfile @ @ -21,7 +21,7 @ @ RUN add-apt-repository -y ppa : gophers/archive & & apt-get update & & apt-get insta RUN ln -s /usr/lib/go-1.9/bin/go /usr/bin/go # Install Rust nightly -RUN curl -s https : //static.rust-lang.org/rustup.sh | sh -s -- -- channel=nightly +RUN curl -s https : //static.rust-lang.org/rustup.sh | sh -s -- -- channel=nightly -- date=2018-08-26 RUN git clone -- depth 1 https : //github.com/guidovranken/bignum-fuzzer RUN git clone -- depth 1 https : //github.com/openssl/openssl
diff -- git a/infra/base-images/base-runner/bad_build_check b/infra/base-images/base-runner/bad_build_check index e133ea9..d5ffa17 100755 -- - a/infra/base-images/base-runner/bad_build_check +++ b/infra/base-images/base-runner/bad_build_check @ @ -19,34 +19,29 @ @ function check_instrumentation { local FUZZER= $ 1 local CHECK_FAILED=0 + local FUZZER_OUTPUT= '' /tmp/ $ ( basename $ FUZZER ) .output '' if [ [ `` $ FUZZING_ENGINE '' = libfuzzer ] ] ; then - CHECK_FAILED= $ ( $ FUZZER -max_total_time=4 2 > & 1 | egrep `` ERROR : no interesting inputs were found . Is the code instrumented '' -c ) + $ FUZZER -runs=4 & > $ FUZZER_OUTPUT + CHECK_FAILED= $ ( cat $ FUZZER_OUTPUT | egrep `` ERROR : no interesting inputs were found . Is the code instrumented '' -c ) if ( ( $ CHECK_FAILED > 0 ) ) ; then - echo `` BAD BUILD : the code does not seem to have coverage instrumentation . '' + echo `` BAD BUILD : the target does not seem to have coverage instrumentation . '' + exit 1 fi - fi - # honggfuzz is not fully integrated , avoid performing the following check . - if [ [ `` $ FUZZING_ENGINE '' ! = honggfuzz ] ] ; then - if ( (
diff -- git a/gapidapk/android/app/src/main/java/com/google/android/gapid/FileCache.java b/gapidapk/android/app/src/main/java/com/google/android/gapid/FileCache.java index 207c5cd..d95670d 100644 -- - a/gapidapk/android/app/src/main/java/com/google/android/gapid/FileCache.java +++ b/gapidapk/android/app/src/main/java/com/google/android/gapid/FileCache.java @ @ -49,42 +49,47 @ @ public abstract class FileCache { private V scopedBuild ( K key ) { String name ; + File path = null ; try ( Counter.Scope t = Counter.time ( `` filename '' ) ) { try ( Counter.Scope t2 = Counter.time ( `` generate '' ) ) { name = builder.filename ( key ) ; } - try ( Counter.Scope t2 = Counter.time ( `` sanitize '' ) ) { - char [ ] src = name.toCharArray ( ) ; - char [ ] dst = new char [ src.length ] ; - for ( int i = 0 ; i < src.length ; i++ ) { - char c = src [ i ] ; - if ( ( c ! = ' . ' ) & & ( c ! = '- ' ) & & - ! ( c > = 'a ' & & c < = 'z ' ) & & - ! ( c > = 'A ' & & c < = 'Z ' ) & & - ! ( c > = '0
diff -- git a/cmd/do/env.go b/cmd/do/env.go index d726b74..99a6472 100644 -- - a/cmd/do/env.go +++ b/cmd/do/env.go @ @ -40,19 +40,11 @ @ func env ( cfg Config ) *shell.Env { system32 : = cmd.Parent ( ) windows : = system32.Parent ( ) path = append ( path , system32.System ( ) , windows.System ( ) ) + path = append ( path , exePaths ( `` node.exe '' , `` adb.exe '' ) ... ) } else { - added : = map [ file.Path ] bool { } - for _ , name : = range [ ] string { `` sh '' , `` uname '' , `` sed '' , `` clang '' , `` gcc '' , `` node '' , `` adb '' } { - exe , err : = file.FindExecutable ( name ) - if err ! = nil { - continue - } - dir : = exe.Parent ( ) - if ! added [ dir ] { - path = append ( path , dir.System ( ) ) - added [ dir ] = true - } - } + path = append ( path , exePaths ( + '' sh '' , ``
diff -- git a/gapis/api/gles/compat.go b/gapis/api/gles/compat.go index 7027be9..5ee0cd1 100644 -- - a/gapis/api/gles/compat.go +++ b/gapis/api/gles/compat.go @ @ -20,6 +20,7 @ @ import ( '' reflect '' '' strings '' + '' github.com/google/gapid/core/app/analytics '' '' github.com/google/gapid/core/data/dictionary '' '' github.com/google/gapid/core/log '' '' github.com/google/gapid/core/math/u32 '' @ @ -1073,7 +1074,12 @ @ func compat ( ctx context.Context , device *device.Instance ) ( transform.Transformer case *GlEGLImageTargetTexture2DOES : { eglImage : = GetState ( s ) .EGLImages.Get ( EGLImageKHR ( cmd.Image ) ) - + if eglImage == nil { + analytics.SendBug ( 1498 ) + log.E ( ctx , `` Encountered nil eglImage . Replay may be corrupt . See : https : //github.com/google/gapid/issues/1498 '' ) + out.MutateAndWrite ( ctx , id , cmd ) + return + } // Create GL texture as compat replacement of the EGL image ( on first use ) switch eglImage.Target { case EGLenum_EGL_GL_TEXTURE_2D :
diff -- git a/gapis/api/vulkan/BUILD.bazel b/gapis/api/vulkan/BUILD.bazel index e3052b7..1498461 100644 -- - a/gapis/api/vulkan/BUILD.bazel +++ b/gapis/api/vulkan/BUILD.bazel @ @ -62,6 +62,8 @ @ go_library ( `` resources.go '' , `` state.go '' , `` state_rebuilder.go '' , + `` image_rebuild_helper.go '' , + `` image_rebuild_shaders.go '' , `` vulkan.go '' , `` vulkan_terminator.go '' , `` wireframe.go '' , @ @ -128,6 +130,7 @ @ go_test ( srcs = [ `` externs_test.go '' , `` footprint_builder_test.go '' , + `` image_rebuild_helper_test.go '' , ] , embed = [ `` : go_default_library '' ] , deps = [ diff -- git a/gapis/api/vulkan/footprint_builder.go b/gapis/api/vulkan/footprint_builder.go index c9a53fe..6717676 100644 -- - a/gapis/api/vulkan/footprint_builder.go +++ b/gapis/api/vulkan/footprint_builder.go @ @ -17,6 +17,7 @ @ package vulkan import ( '' context '' '' fmt '' + '' time '' '' github.com/google/gapid/core/log '' '' github.com/google/gapid/core/math/interval '' @ @ -1640,6 +1641,8 @ @ func ( vb *FootprintBuilder ) BuildFootprint ( ctx context.Context , // Records the current last draw framebuffer image data , so that later when // the user request a command , we can always guarantee that the last draw // framebuffer is alive . + log.W ( ctx , `` id : % v , cmd : % v '' , id
diff -- git a/gapis/api/vulkan/BUILD.bazel b/gapis/api/vulkan/BUILD.bazel index e3052b7..1498461 100644 -- - a/gapis/api/vulkan/BUILD.bazel +++ b/gapis/api/vulkan/BUILD.bazel @ @ -62,6 +62,8 @ @ go_library ( `` resources.go '' , `` state.go '' , `` state_rebuilder.go '' , + `` image_rebuild_helper.go '' , + `` image_rebuild_shaders.go '' , `` vulkan.go '' , `` vulkan_terminator.go '' , `` wireframe.go '' , @ @ -128,6 +130,7 @ @ go_test ( srcs = [ `` externs_test.go '' , `` footprint_builder_test.go '' , + `` image_rebuild_helper_test.go '' , ] , embed = [ `` : go_default_library '' ] , deps = [ diff -- git a/gapis/api/vulkan/image_rebuild_helper.go b/gapis/api/vulkan/image_rebuild_helper.go new file mode 100644 index 0000000..05732b7 -- - /dev/null +++ b/gapis/api/vulkan/image_rebuild_helper.go @ @ -0,0 +1,1050 @ @ +// Copyright ( C ) 2017 Google Inc. +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT
diff -- git a/gapii/cc/vulkan_extras.inl b/gapii/cc/vulkan_extras.inl index 200d13b..1ca72cf 100644 -- - a/gapii/cc/vulkan_extras.inl +++ b/gapii/cc/vulkan_extras.inl @ @ -70,6 +70,23 @ @ uint32_t SpyOverride_vkCreateSwapchainKHR ( VkDevice device , VkSwapchainCreateInfoKHR* pCreateInfo , VkAllocationCallbacks* pAllocator , VkSwapchainKHR* pImage ) ; +uint32_t SpyOverride_vkDebugMarkerSetObjectTagEXT ( + VkDevice device , VkDebugMarkerObjectTagInfoEXT* pTagInfo ) { + return VkResult : :VK_SUCCESS ; + } + +uint32_t SpyOverride_vkDebugMarkerSetObjectNameEXT ( + VkDevice device , VkDebugMarkerObjectNameInfoEXT* pNameInfo ) { + return VkResult : :VK_SUCCESS ; + } + +void SpyOverride_vkCmdDebugMarkerBeginEXT ( + VkCommandBuffer commandBuffer , VkDebugMarkerMarkerInfoEXT* pMarkerInfo ) { } + +void SpyOverride_vkCmdDebugMarkerEndEXT ( VkCommandBuffer commandBuffer ) { } + +void SpyOverride_vkCmdDebugMarkerInsertEXT ( + VkCommandBuffer commandBuffer , VkDebugMarkerMarkerInfoEXT* pMarkerInfo ) { } void SpyOverride_RecreateInstance ( const VkInstanceCreateInfo* , VkInstance* ) { } void SpyOverride_RecreateState ( ) { } void SpyOverride_RecreatePhysicalDevices ( VkInstance , uint32_t* , @ @ -206,8 +223,7 @ @ void SpyOverride_RecreateCmdSetViewport ( VkCommandBuffer , uint32_t , uint32_t , const VkViewport* ) { } void SpyOverride_RecreateCmdSetDepthBias ( VkCommandBuffer , float , float , float ) { } -void SpyOverride_RecreateCmdSetDepthBounds ( VkCommandBuffer , float , float ) { - } +void SpyOverride_RecreateCmdSetDepthBounds ( VkCommandBuffer , float , float ) { } void SpyOverride_RecreateCmdSetLineWidth ( VkCommandBuffer , float ) { } void SpyOverride_RecreateCmdSetStencilCompareMask (
diff -- git a/gapis/memory/read.go b/gapis/memory/read.go index cf7a98c..4c38b11 100644 -- - a/gapis/memory/read.go +++ b/gapis/memory/read.go @ @ -85,7 +85,7 @ @ func decode ( d *Decoder , v reflect.Value ) { decode ( d , v.Index ( i ) ) } case reflect.Slice : - if t.Elem ( ) .Kind ( ) == reflect.Uint8 & & ! t.Elem ( ) .Implements ( tyCharTy ) { + if t.Elem ( ) == tyUint8Ty { d.Data ( v.Interface ( ) . ( [ ] uint8 ) ) } else { for i , c : = 0 , v.Len ( ) ; i < c ; i++ { diff -- git a/gapis/memory/types.go b/gapis/memory/types.go index da35a59..5d8ff87 100644 -- - a/gapis/memory/types.go +++ b/gapis/memory/types.go @ @ -30,6 +30,7 @ @ var ( tyAlignedTy = reflect.TypeOf ( ( *AlignedTy ) ( nil ) ) .Elem ( ) tyEncodable = reflect.TypeOf ( ( *Encodable ) ( nil ) ) .Elem ( ) tyDecodable = reflect.TypeOf ( ( *Decodable ) ( nil ) ) .Elem ( ) + tyUint8Ty = reflect.TypeOf ( uint8 ( 0 ) ) ) // Int is a signed integer type . diff -- git a/gapis/memory/write.go b/gapis/memory/write.go index d9a09ff..f47b0ef 100644 -- - a/gapis/memory/write.go +++ b/gapis/memory/write.go @
diff -- git a/core/event/task/signal_test.go b/core/event/task/signal_test.go index 541bd82..e9e51cb 100644 -- - a/core/event/task/signal_test.go +++ b/core/event/task/signal_test.go @ @ -49,7 +49,7 @ @ func TestSignalTryWait ( t *testing.T ) { ctx : = log.Testing ( t ) signal , fire : = task.NewSignal ( ) fire ( ctx ) - assert.With ( ctx ) .That ( signal.TryWait ( ctx , 0 ) ) .Equals ( true ) + assert.With ( ctx ) .That ( signal.TryWait ( ctx , ExpectBlocking ) ) .Equals ( true ) } func TestSignalTryWaitTimeout ( t *testing.T ) {
diff -- git a/gapic/src/main/com/google/gapid/image/ArrayImage.java b/gapic/src/main/com/google/gapid/image/ArrayImage.java index 553feb8..152f341 100644 -- - a/gapic/src/main/com/google/gapid/image/ArrayImage.java +++ b/gapic/src/main/com/google/gapid/image/ArrayImage.java @ @ -435,21 +435,29 @ @ public abstract class ArrayImage implements Image { if ( isRGBA ) { for ( int i = 0 , end = buffer.remaining ( ) - 3 ; i < = end ; ) { float value = buffer.get ( i++ ) ; - min = Math.min ( min , value ) ; - max = Math.max ( max , value ) ; + if ( ! Float.isNaN ( value ) & & ! Float.isInfinite ( value ) ) { + min = Math.min ( min , value ) ; + max = Math.max ( max , value ) ; + } value = buffer.get ( i++ ) ; - min = Math.min ( min , value ) ; - max = Math.max ( max , value ) ; + if ( ! Float.isNaN ( value ) & & ! Float.isInfinite ( value ) ) { + min = Math.min ( min , value ) ; + max = Math.max ( max , value ) ; + } value = buffer.get ( i++ ) ; - min = Math.min ( min ,
diff -- git a/gapis/gfxapi/gles/resources.go b/gapis/gfxapi/gles/resources.go index c4f0ce3..24e836e 100644 -- - a/gapis/gfxapi/gles/resources.go +++ b/gapis/gfxapi/gles/resources.go @ @ -67,7 +67,7 @ @ func ( t *Texture ) ResourceType ( ctx context.Context ) gfxapi.ResourceType { // ResourceData returns the resource data given the current state . func ( t *Texture ) ResourceData ( ctx context.Context , s *gfxapi.State ) ( interface { } , error ) { - ctx = log.Enter ( ctx , `` Texture.Resource ( ) '' ) + ctx = log.Enter ( ctx , `` Texture.ResourceData ( ) '' ) switch t.Kind { case GLenum_GL_TEXTURE_2D : levels : = make ( [ ] *image.Info2D , len ( t.Levels ) ) @ @ -156,7 +156,7 @ @ func ( s *Shader ) ResourceType ( ctx context.Context ) gfxapi.ResourceType { // ResourceData returns the resource data given the current state . func ( s *Shader ) ResourceData ( ctx context.Context , t *gfxapi.State ) ( interface { } , error ) { - ctx = log.Enter ( ctx , `` Shader.Resource ( ) '' ) + ctx = log.Enter ( ctx , `` Shader.ResourceData ( ) '' ) var ty gfxapi.ShaderType switch s.ShaderType { case GLenum_GL_VERTEX_SHADER : @ @ -259,35 +259,42 @ @
diff -- git a/gapis/gfxapi/vulkan/state.go b/gapis/gfxapi/vulkan/state.go index 43337d3..3e000b9 100644 -- - a/gapis/gfxapi/vulkan/state.go +++ b/gapis/gfxapi/vulkan/state.go @ @ -21,57 +21,48 @ @ import ( ) func ( st *State ) getFramebufferAttachmentInfo ( attachment gfxapi.FramebufferAttachment ) ( w , h uint32 , f VkFormat , attachmentIndex uint32 , err error ) { - if st.LastUsedFramebuffer ! = nil { - var index int - - switch attachment { - case gfxapi.FramebufferAttachment_Color0 : - index = 0 - case gfxapi.FramebufferAttachment_Color1 : - index = 1 - case gfxapi.FramebufferAttachment_Color2 : - index = 2 - case gfxapi.FramebufferAttachment_Color3 : - index = 3 - case gfxapi.FramebufferAttachment_Depth : - break - case gfxapi.FramebufferAttachment_Stencil : - fallthrough - default : - return 0 , 0 , VkFormat_VK_FORMAT_UNDEFINED , 0 , fmt.Errorf ( `` Framebuffer attachment % v currently unsupported '' , attachment ) - } + returnError : = func ( format_str string , e ... interface { } ) ( w , h uint32 , f VkFormat , attachmentIndex uint32 , err error ) { + return 0 , 0 , VkFormat_VK_FORMAT_UNDEFINED , 0 , fmt.Errorf ( format_str , e ... ) + } - currentColorIndex : = 0 - for _ , a : = range st.LastUsedFramebuffer.ImageAttachments.KeysSorted
diff -- git a/gapis/shadertools/CMakeBuild.cmake b/gapis/shadertools/CMakeBuild.cmake index 58dbd08..516509f 100644 -- - a/gapis/shadertools/CMakeBuild.cmake +++ b/gapis/shadertools/CMakeBuild.cmake @ @ -14,4 +14,5 @ @ build_subdirectory ( cc ) +cgo_dependency ( khronos ) cgo_dependency ( spv )
diff -- git a/gapis/api/vulkan/api/pipeline.api b/gapis/api/vulkan/api/pipeline.api index ed161ac..3869078 100644 -- - a/gapis/api/vulkan/api/pipeline.api +++ b/gapis/api/vulkan/api/pipeline.api @ @ -528,11 +528,8 @ @ cmd VkResult vkCreateGraphicsPipelines ( obj.RenderPass = RenderPasses [ create_info.renderPass ] obj.Subpass = create_info.subpass if ( ( as ! u32 ( create_info.flags ) & as ! u32 ( VK_PIPELINE_CREATE_DERIVATIVE_BIT ) ) ! = 0 ) { - if ( create_info.basePipelineIndex ! = -1 ) { - obj.BasePipelineIndex = create_info.basePipelineIndex - } else { - obj.BasePipeline = create_info.basePipelineHandle - } + obj.BasePipelineIndex = create_info.basePipelineIndex + obj.BasePipeline = create_info.basePipelineHandle } else { obj.BasePipelineIndex = 0 obj.BasePipeline = as ! VkPipeline ( 0 ) @ @ -625,11 +622,8 @ @ cmd VkResult vkCreateComputePipelines ( } obj.Stage = stage_data if ( ( as ! u32 ( info.flags ) & as ! u32 ( VK_PIPELINE_CREATE_DERIVATIVE_BIT ) ) ! = 0 ) { - if ( info.basePipelineIndex ! = -1 ) { - obj.BasePipelineIndex = info.basePipelineIndex - } else { - obj.BasePipeline = info.basePipelineHandle - } + obj.BasePipelineIndex = info.basePipelineIndex + obj.BasePipeline = info.basePipelineHandle } else { obj.BasePipelineIndex = 0 obj.BasePipeline = as ! VkPipeline ( 0 )
diff -- git a/gapis/resolve/command_tree.go b/gapis/resolve/command_tree.go index 9b2d5ec..e9b117a 100644 -- - a/gapis/resolve/command_tree.go +++ b/gapis/resolve/command_tree.go @ @ -54,7 +54,7 @ @ type commandTree struct { root api.CmdIDGroup } -func ( t *commandTree ) index ( indices [ ] uint64 ) api.SpanItem { +func ( t *commandTree ) index ( indices [ ] uint64 ) ( api.SpanItem , api.SubCmdIdx ) { group : = api.CmdGroupOrRoot ( t.root ) subCmdRootId : = api.SubCmdIdx { } for _ , idx : = range indices { @ @ -66,12 +66,13 @ @ func ( t *commandTree ) index ( indices [ ] uint64 ) api.SpanItem { subCmdRootId = item.Id group = item case api.SubCmdIdx : - return append ( subCmdRootId , item ... ) + id : = append ( subCmdRootId , item ... ) + return id , id default : - return item + return item , subCmdRootId } } - return group + return group , subCmdRootId } func ( t *commandTree ) indices ( id api.CmdID ) [ ] uint64 { @ @ -98,19 +99,33 @ @ func CommandTreeNode ( ctx context.Context , c *path.CommandTreeNode ) ( *service.Com cmdTree : = boxed . ( *commandTree ) - switch item : = cmdTree.index
diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index edf2a0c..b5bd7b7 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -25,14 +25,14 @ @ protoc_go ( `` github.com/google/gapid/core/image '' `` core/image '' `` image.proto '' ) protoc_java ( `` core/image '' `` image.proto '' `` com/google/gapid/proto/image/Image '' ) protoc_go ( `` github.com/google/gapid/core/os/android/apk '' `` core/os/android/apk '' `` apk.proto '' ) protoc_go ( `` github.com/google/gapid/core/os/android '' `` core/os/android '' `` keycodes.proto '' ) -protoc_go ( `` github.com/google/gapid/gapidapk/pkginfo '' `` gapidapk/pkginfo '' `` pkginfo.proto '' ) -protoc_java ( `` gapidapk/pkginfo '' `` pkginfo.proto '' `` com/google/gapid/proto/pkginfo/PkgInfo '' ) protoc_go ( `` github.com/google/gapid/core/os/device/bind '' `` core/os/device/bind '' `` bind.proto '' ) protoc_go ( `` github.com/google/gapid/core/os/device '' `` core/os/device '' `` device.proto '' ) protoc_java ( `` core/os/device '' `` device.proto '' `` com/google/gapid/proto/device/Device '' ) protoc_cc ( `` github.com/google/gapid/core/os/device '' `` core/os/device '' `` device.proto '' ) protoc_go ( `` github.com/google/gapid/core/stream '' `` core/stream '' `` stream.proto '' ) protoc_java ( `` core/stream '' `` stream.proto '' `` com/google/gapid/proto/stream/Stream '' ) +protoc_go ( `` github.com/google/gapid/gapidapk/pkginfo '' `` gapidapk/pkginfo '' `` pkginfo.proto '' ) +protoc_java ( `` gapidapk/pkginfo '' `` pkginfo.proto '' `` com/google/gapid/proto/pkginfo/PkgInfo '' ) protoc_go ( `` github.com/google/gapid/gapis/atom/atom_pb '' `` gapis/atom/atom_pb '' `` atom.proto '' ) protoc_cc
diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index edf2a0c..b5bd7b7 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -25,14 +25,14 @ @ protoc_go ( `` github.com/google/gapid/core/image '' `` core/image '' `` image.proto '' ) protoc_java ( `` core/image '' `` image.proto '' `` com/google/gapid/proto/image/Image '' ) protoc_go ( `` github.com/google/gapid/core/os/android/apk '' `` core/os/android/apk '' `` apk.proto '' ) protoc_go ( `` github.com/google/gapid/core/os/android '' `` core/os/android '' `` keycodes.proto '' ) -protoc_go ( `` github.com/google/gapid/gapidapk/pkginfo '' `` gapidapk/pkginfo '' `` pkginfo.proto '' ) -protoc_java ( `` gapidapk/pkginfo '' `` pkginfo.proto '' `` com/google/gapid/proto/pkginfo/PkgInfo '' ) protoc_go ( `` github.com/google/gapid/core/os/device/bind '' `` core/os/device/bind '' `` bind.proto '' ) protoc_go ( `` github.com/google/gapid/core/os/device '' `` core/os/device '' `` device.proto '' ) protoc_java ( `` core/os/device '' `` device.proto '' `` com/google/gapid/proto/device/Device '' ) protoc_cc ( `` github.com/google/gapid/core/os/device '' `` core/os/device '' `` device.proto '' ) protoc_go ( `` github.com/google/gapid/core/stream '' `` core/stream '' `` stream.proto '' ) protoc_java ( `` core/stream '' `` stream.proto '' `` com/google/gapid/proto/stream/Stream '' ) +protoc_go ( `` github.com/google/gapid/gapidapk/pkginfo '' `` gapidapk/pkginfo '' `` pkginfo.proto '' ) +protoc_java ( `` gapidapk/pkginfo '' `` pkginfo.proto '' `` com/google/gapid/proto/pkginfo/PkgInfo '' ) protoc_go ( `` github.com/google/gapid/gapis/atom/atom_pb '' `` gapis/atom/atom_pb '' `` atom.proto '' ) protoc_cc
diff -- git a/gapii/cc/android/gvr_install.h b/gapii/cc/android/gvr_install.h index 53f28fa..bc4e793 100644 -- - a/gapii/cc/android/gvr_install.h +++ b/gapii/cc/android/gvr_install.h @ @ -20,10 +20,11 @ @ namespace gapii { +class Installer ; class GvrImports ; // install_gvr installs interceptor hooks into all the GVR functions . -bool install_gvr ( void* gvr_lib , GvrImports* imports ) ; +bool install_gvr ( Installer* installer , void* gvr_lib , GvrImports* imports ) ; } // namespace gapii diff -- git a/gapii/cc/android/installer.cpp b/gapii/cc/android/installer.cpp index 4f756dc..6ac0cc1 100644 -- - a/gapii/cc/android/installer.cpp +++ b/gapii/cc/android/installer.cpp @ @ -14,6 +14,7 @ @ * limitations under the License . */ + # include `` installer.h '' # include `` ../gles_exports.h '' # include `` core/cc/assert.h '' @ @ -117,27 +118,16 @ @ void recordInterceptorError ( void* , const char* message ) { GAPID_WARNING ( `` Interceptor error : % s '' , message ) ; } -class Installer { -public : - Installer ( ) ; - ~Installer ( ) ; - - void* install ( void* func_import , const void* func_export ) ; + } // anonymous namespace -private : - void install_gles ( ) ; - } ; +namespace gapii { -Installer : :Installer ( ) { +Installer : :Installer ( const char* libInterceptorPath ) {
diff -- git a/core/stream/fmts/d.go b/core/stream/fmts/d.go index 96ad3ae..a21c652 100644 -- - a/core/stream/fmts/d.go +++ b/core/stream/fmts/d.go @ @ -40,4 +40,18 @ @ var ( Channel : stream.Channel_Depth , } } , } + + D_X8U24_NORM = & stream.Format { + // According to Vulkan Spec , the first 8 bit is not used , + // the following 24 bits are used for depth . + Components : [ ] *stream.Component { { + DataType : & stream.U8 , + Sampling : stream.LinearNormalized , + Channel : stream.Channel_Undefined , + } , { + DataType : & stream.U24 , + Sampling : stream.LinearNormalized , + Channel : stream.Channel_Depth , + } } , + } ) diff -- git a/core/stream/fmts/ds.go b/core/stream/fmts/ds.go index 8834ea9..4ad4159 100644 -- - a/core/stream/fmts/ds.go +++ b/core/stream/fmts/ds.go @ @ -29,6 +29,18 @ @ var ( } } , } + DS_NU16S8 = & stream.Format { + Components : [ ] *stream.Component { { + DataType : & stream.U16 , + Sampling : stream.LinearNormalized , + Channel : stream.Channel_Depth , + } , { + DataType : & stream.S8 , + Sampling : stream.Linear , + Channel : stream.Channel_Stencil , + } } , + } + DS_NU24U8 = & stream.Format {
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/.gitignore b/.gitignore index cab8980..fbbbfc2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,12 +11,7 @ @ # General patterns *.gfxtrace *ycm_extra_conf.py* -*_binary.go -*_binary_test.go *_embed.go -*_snippets . * -snippets.base64 -snippets.text gapir.log gapis.log # Vim diff -- git a/CMakeLists.txt b/CMakeLists.txt index 068e487..69e40f0 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -74,7 +74,6 @ @ build_subdirectory ( gapir ) build_subdirectory ( gapis ) build_subdirectory ( gapidapk ) build_subdirectory ( test ) -build_subdirectory ( tools ) endif ( ) scan_for_protos ( ) @ @ -82,26 +81,4 @ @ scan_for_protos ( ) # Add root as include path for all c includes . include_directories ( $ { CMAKE_SOURCE_DIR } ) - - # The codergen rules are still slightly broken , because of the cpp - # generation steps . - # Might have to add an explicit dependancy on codergen-all to fix it . -codergen ( - gapil/snippets - framework/binary/any - framework/binary/test - gapis/atom - gapis/atom/test - gapis/gfxapi - gapis/gfxapi/core - gapis/gfxapi/gles - gapis/gfxapi/test - gapis/gfxapi/test/gfxapi_test_import - gapis/gfxapi/vulkan - gapis/memory - gapis/replay/protocol - gapis/resolve - test/integration/replay/gles - ) - include ( Package ) diff -- git a/CMakeProto.cmake b/CMakeProto.cmake index 5f36f22..96ba391 100644 -- - a/CMakeProto.cmake +++ b/CMakeProto.cmake @ @ -22,8 +22,6 @
diff -- git a/integration/maptest/map_test.go b/integration/maptest/map_test.go index 553c573..ecb3616 100644 -- - a/integration/maptest/map_test.go +++ b/integration/maptest/map_test.go @ @ -41,7 +41,7 @ @ func createBatchLeaves ( batch , n int ) [ ] *trillian.MapLeaf { leaves : = make ( [ ] *trillian.MapLeaf , 0 , n ) for i : = 0 ; i < n ; i++ { leaves = append ( leaves , & trillian.MapLeaf { - Index : testonly.HashKey ( fmt.Sprintf ( `` batch- % d-key- % d '' , batch , i ) ) , + Index : testonly.TransparentHash ( fmt.Sprintf ( `` batch- % d-key- % d '' , batch , i ) ) , LeafValue : [ ] byte ( fmt.Sprintf ( `` batch- % d-value- % d '' , batch , i ) ) , } ) } @ @ -133,9 +133,9 @ @ func TestInclusion ( t *testing.T ) { desc : `` maphasher multi '' , HashStrategy : trillian.HashStrategy_TEST_MAP_HASHER , leaves : [ ] *trillian.MapLeaf { - { Index : testonly.TransparentHash ( `` A '' ) , LeafValue : [ ] byte ( `` A '' ) } , - { Index : testonly.TransparentHash ( `` B '' ) , LeafValue : [ ]
diff -- git a/integration/map.go b/integration/map.go index 941a217..b06394c 100644 -- - a/integration/map.go +++ b/integration/map.go @ @ -30,6 +30,8 @ @ import ( '' github.com/google/trillian/testonly '' ) +const treeID = int64 ( 0 ) + // RunMapIntegration runs a map integration test using the given map ID and client . func RunMapIntegration ( ctx context.Context , mapID int64 , pubKey crypto.PublicKey , client trillian.TrillianMapClient ) error { { @ @ -127,8 +129,8 @ @ func RunMapIntegration ( ctx context.Context , mapID int64 , pubKey crypto.PublicKey if got , want : = leaf.LeafValue , ev.LeafValue ; ! bytes.Equal ( got , want ) { return fmt.Errorf ( `` got value % s , want % s '' , got , want ) } - leafHash : = h.HashLeaf ( leaf.LeafValue ) - if err : = merkle.VerifyMapInclusionProof ( leaf.Index , leafHash , r.GetMapRoot ( ) .GetRootHash ( ) , incl.Inclusion , h ) ; err ! = nil { + leafHash : = h.HashLeaf ( treeID , leaf.Index , h.BitLen ( ) , leaf.LeafValue ) + if err : = merkle.VerifyMapInclusionProof ( treeID , leaf.Index , leafHash , r.GetMapRoot ( ) .GetRootHash ( ) , incl.Inclusion , h ) ; err ! =
diff -- git a/integration/map.go b/integration/map.go index 941a217..b06394c 100644 -- - a/integration/map.go +++ b/integration/map.go @ @ -30,6 +30,8 @ @ import ( '' github.com/google/trillian/testonly '' ) +const treeID = int64 ( 0 ) + // RunMapIntegration runs a map integration test using the given map ID and client . func RunMapIntegration ( ctx context.Context , mapID int64 , pubKey crypto.PublicKey , client trillian.TrillianMapClient ) error { { @ @ -127,8 +129,8 @ @ func RunMapIntegration ( ctx context.Context , mapID int64 , pubKey crypto.PublicKey if got , want : = leaf.LeafValue , ev.LeafValue ; ! bytes.Equal ( got , want ) { return fmt.Errorf ( `` got value % s , want % s '' , got , want ) } - leafHash : = h.HashLeaf ( leaf.LeafValue ) - if err : = merkle.VerifyMapInclusionProof ( leaf.Index , leafHash , r.GetMapRoot ( ) .GetRootHash ( ) , incl.Inclusion , h ) ; err ! = nil { + leafHash : = h.HashLeaf ( treeID , leaf.Index , h.BitLen ( ) , leaf.LeafValue ) + if err : = merkle.VerifyMapInclusionProof ( treeID , leaf.Index , leafHash , r.GetMapRoot ( ) .GetRootHash ( ) , incl.Inclusion , h ) ; err ! =
diff -- git a/integration/map.go b/integration/map.go deleted file mode 100644 index 9f83230..0000000 -- - a/integration/map.go +++ /dev/null @ @ -1,168 +0,0 @ @ -// Copyright 2016 Google Inc. All Rights Reserved . -// -// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; -// you may not use this file except in compliance with the License . -// You may obtain a copy of the License at -// -// http : //www.apache.org/licenses/LICENSE-2.0 -// -// Unless required by applicable law or agreed to in writing , software -// distributed under the License is distributed on an `` AS IS '' BASIS , -// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . -// See the License for the specific language governing permissions and -// limitations under the License . - -package integration - -import ( - '' bytes '' - '' context '' - '' crypto '' - '' encoding/hex '' - '' fmt '' - '' math/rand '' - - '' github.com/golang/glog '' - '' github.com/google/trillian '' - tcrypto `` github.com/google/trillian/crypto '' - '' github.com/google/trillian/merkle '' - '' github.com/google/trillian/merkle/maphasher '' - '' github.com/google/trillian/testonly '' - ) - -const treeID = int64
diff -- git a/storage/cache/subtree_cache.go b/storage/cache/subtree_cache.go index b05162e..f491c33 100644 -- - a/storage/cache/subtree_cache.go +++ b/storage/cache/subtree_cache.go @ @ -58,6 +58,8 @ @ const ( depthQuantum = 8 // logStrataDepth is the strata that must be used for all log subtrees . logStrataDepth = 8 + // maxLogDepth is the number of bits in a log path . + maxLogDepth = 64 ) // SubtreeCache provides a caching access to Subtree storage . Currently there are assumptions @ @ -82,22 +84,6 @ @ type SubtreeCache struct { prepare storage.PrepareSubtreeWriteFunc } -// Suffix represents the tail of a NodeID , indexing into the Subtree which -// corresponds to the prefix of the NodeID . -type Suffix struct { - // bits is the number of bits in the node ID suffix . - bits byte - // path is the suffix itself . - path [ ] byte - } - -func ( s Suffix ) serialize ( ) string { - r : = make ( [ ] byte , 1 , 1+ ( len ( s.path ) ) ) - r [ 0 ] = s.bits - r = append ( r , s.path ... ) - return base64.StdEncoding.EncodeToString ( r ) -
diff -- git a/log/sequencer.go b/log/sequencer.go index 3017037..02253ab 100644 -- - a/log/sequencer.go +++ b/log/sequencer.go @ @ -61,6 +61,8 @ @ var ( // configuration should be changed instead . // A factor < 1 WILL lead to token shortages , therefore it 'll be normalized to 1 . QuotaIncreaseFactor = 1.1 + + seqOpts = storage.NewGetOpts ( storage.Sequence , false , trillian.TreeType_LOG ) ) func quotaIncreaseFactor ( ) float64 { @ @ -407,7 +409,7 @ @ func ( s Sequencer ) IntegrateBatch ( ctx context.Context , logID int64 , limit int , g stageStart = s.timeSource.Now ( ) return nil - } ) + } , seqOpts ) if err ! = nil { return 0 , err } @ @ -479,5 +481,5 @ @ func ( s Sequencer ) SignRoot ( ctx context.Context , logID int64 ) error { glog.V ( 2 ) .Infof ( `` % v : new signed root , size % v , tree-revision % v '' , logID , newLogRoot.TreeSize , newLogRoot.TreeRevision ) return nil - } ) + } , seqOpts ) } diff -- git a/quota/mysqlqm/mysql_quota_test.go b/quota/mysqlqm/mysql_quota_test.go index 4fe2e69..26b339a 100644 -- - a/quota/mysqlqm/mysql_quota_test.go +++ b/quota/mysqlqm/mysql_quota_test.go @ @ -33,6 +33,8 @ @ import (
diff -- git a/log/sequencer.go b/log/sequencer.go index 3017037..8cd1768 100644 -- - a/log/sequencer.go +++ b/log/sequencer.go @ @ -284,13 +284,13 @ @ func ( s logSequencingTask ) update ( ctx context.Context , leaves [ ] *trillian.LogLea // IntegrateBatch wraps up all the operations needed to take a batch of queued // leaves and integrate them into the tree . -func ( s Sequencer ) IntegrateBatch ( ctx context.Context , logID int64 , limit int , guardWindow , maxRootDurationInterval time.Duration ) ( int , error ) { +func ( s Sequencer ) IntegrateBatch ( ctx context.Context , tree *trillian.Tree , limit int , guardWindow , maxRootDurationInterval time.Duration ) ( int , error ) { start : = s.timeSource.Now ( ) - label : = strconv.FormatInt ( logID , 10 ) + label : = strconv.FormatInt ( tree.TreeId , 10 ) numLeaves : = 0 var newLogRoot *trillian.SignedLogRoot - err : = s.logStorage.ReadWriteTransaction ( ctx , logID , func ( ctx context.Context , tx storage.LogTreeTX ) error { + err : = s.logStorage.ReadWriteTransaction ( ctx , tree , func ( ctx context.Context , tx storage.LogTreeTX ) error { stageStart : = s.timeSource.Now ( ) defer seqBatches.Inc ( label ) defer func ( ) { seqLatency.Observe
diff -- git a/quota/noop.go b/quota/noop.go new file mode 100644 index 0000000..77a9ad1 -- - /dev/null +++ b/quota/noop.go @ @ -0,0 +1,96 @ @ +// Copyright 2017 Google Inc. All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package quota + +import ( + '' context '' + '' fmt '' + ) + +type noopManager struct { } + +const ( + noopUser = `` noopQuotaUser '' // arbitrary string + ) + +// Noop returns a noop implementation of Manager . It allows all requests without restriction . +func Noop ( ) Manager { + return & noopManager
diff -- git a/merkle/merkle_path.go b/merkle/merkle_path.go index dc0dc12..7b3eebf 100644 -- - a/merkle/merkle_path.go +++ b/merkle/merkle_path.go @ @ -19,10 +19,12 @ @ import ( '' github.com/golang/glog '' '' github.com/google/trillian/storage '' + '' github.com/vektra/errors '' ) -// Verbosity level for logging of debug related items +// Verbosity levels for logging of debug related items const vLevel = 2 +const vvLevel = 4 // NodeFetch bundles a nodeID with additional information on how to use the node to construct the // correct proof . @ @ -39,12 +41,12 @ @ func ( n NodeFetch ) Equivalent ( other NodeFetch ) bool { // CalcInclusionProofNodeAddresses returns the tree node IDs needed to // build an inclusion proof for a specified leaf and tree size . The maxBitLen parameter // is copied into all the returned nodeIDs . -func CalcInclusionProofNodeAddresses ( treeSize , index int64 , maxBitLen int ) ( [ ] NodeFetch , error ) { - if index > = treeSize || index < 0 || treeSize < 1 || maxBitLen < 0 { - return [ ] NodeFetch { } , fmt.Errorf ( `` invalid params ts : % d index : % d , bitlen : % d '' , treeSize , index
diff -- git a/examples/ct/ct_handlers.go b/examples/ct/ct_handlers.go index b530d16..70a9eee 100644 -- - a/examples/ct/ct_handlers.go +++ b/examples/ct/ct_handlers.go @ @ -48,6 +48,10 @ @ const ( getProofParamHash = `` hash '' // The name of the get-proof-by-hash tree size parameter getProofParamTreeSize = `` tree_size '' + // The name of the get-sth-consistency first snapshot param + getSTHConsistencyParamFirst = `` first '' + // The name of the get-sth-consistency second snapshot param + getSTHConsistencyParamSecond = `` second '' ) // CTRequestHandlers provides HTTP handler functions for CT V1 as defined in RFC 6962 @ @ -103,7 +107,7 @ @ type getEntriesResponse struct { Entries [ ] getEntriesEntry ` json : '' entries '' ` } -// getSthResponse is a struct for marshalling get-sth responses . See RFC 6962 Section 4.3 +// getSTHResponse is a struct for marshalling get-sth responses . See RFC 6962 Section 4.3 type getSTHResponse struct { TreeSize int64 ` json : '' tree_size '' ` TimestampMillis int64 ` json : '' timestamp '' ` @ @ -118,6 +122,12 @ @ type getProofByHashResponse struct { AuditPath [ ] [ ] byte ` json : '' audit_path '' ` } +// getSTHConsistencyResponse is a struct for mashalling get-sth-consistency responses . See +// RFC 6962 section
diff -- git a/integration/ct_prep_test.sh b/integration/ct_prep_test.sh index e29df8b..5ecadd3 100755 -- - a/integration/ct_prep_test.sh +++ b/integration/ct_prep_test.sh @ @ -55,7 +55,7 @ @ for ( ( i=0 ; i < RPC_SERVER_COUNT ; i++ ) ) ; do RPC_SERVERS= '' $ { RPC_SERVERS } , localhost : $ { port } '' echo `` Starting Log RPC server on port $ { port } '' - ./trillian_log_server -- port $ { port } -- http_port=-1 & + ./trillian_log_server -- rpc_endpoint= '' localhost : $ { port } '' -- http_endpoint= '' & pid= $ ! RPC_SERVER_PIDS+= ( $ { pid } ) waitForServerStartup $ { port } @ @ -86,7 +86,7 @ @ pushd `` $ { TRILLIAN_ROOT } '' > /dev/null declare -a LOG_SIGNER_PIDS for ( ( i=0 ; i < LOG_SIGNER_COUNT ; i++ ) ) ; do echo `` Starting Log signer '' - ./trillian_log_signer `` $ { SIGNER_ELECTION_OPTS } '' -- sequencer_interval= '' 1s '' -- batch_size=500 -- export_metrics=false -- num_sequencers 2 & + ./trillian_log_signer `` $ { SIGNER_ELECTION_OPTS } '' -- sequencer_interval= '' 1s '' -- batch_size=500 -- http_endpoint= '' -- num_sequencers 2 & pid= $ ! LOG_SIGNER_PIDS+= ( $ { pid } ) done diff -- git a/integration/log_integration_test.sh b/integration/log_integration_test.sh index
diff -- git a/integration/map.go b/integration/map.go index 5e5ceba..941a217 100644 -- - a/integration/map.go +++ b/integration/map.go @ @ -17,19 +17,21 @ @ package integration import ( '' bytes '' '' context '' + '' crypto '' '' encoding/hex '' '' fmt '' '' math/rand '' '' github.com/golang/glog '' '' github.com/google/trillian '' + tcrypto `` github.com/google/trillian/crypto '' '' github.com/google/trillian/merkle '' '' github.com/google/trillian/merkle/maphasher '' '' github.com/google/trillian/testonly '' ) // RunMapIntegration runs a map integration test using the given map ID and client . -func RunMapIntegration ( ctx context.Context , mapID int64 , client trillian.TrillianMapClient ) error { +func RunMapIntegration ( ctx context.Context , mapID int64 , pubKey crypto.PublicKey , client trillian.TrillianMapClient ) error { { // Ensure we 're starting with an empty map r , err : = client.GetSignedMapRoot ( ctx , & trillian.GetSignedMapRootRequest { MapId : mapID } ) @ @ -108,6 +110,14 @ @ func RunMapIntegration ( ctx context.Context , mapID int64 , client trillian.Trillia if got , want : = r.GetMapRoot ( ) .GetMapRevision ( ) , int64 ( numBatches ) ; got ! = want { return fmt.Errorf ( `` got SMH with revision % d , want % d '' , got , want ) } + // SignedMapRoot
diff -- git a/storage/cloudspanner/log_storage.go b/storage/cloudspanner/log_storage.go index 0def762..63b77ee 100644 -- - a/storage/cloudspanner/log_storage.go +++ b/storage/cloudspanner/log_storage.go @ @ -536,11 +536,14 @ @ func ( tx *logTX ) DequeueLeaves ( ctx context.Context , limit int , cutoff time.Time ) rows = genDequeueRowsOld ( tx.getLogStorageConfig ( ) , tx.treeID , now.Unix ( ) , rand.Int31n ( numByteValues ) ) } ret : = make ( [ ] *trillian.LogLeaf , 0 , limit ) + readOpts : = & spanner.ReadOptions { Limit : limit } + drain : = 0 for _ , rs : = range rows { - rows : = tx.stx.Read ( ctx , unseqTable , rs , [ ] string { colBucket , colQueueTimestampNanos , colMerkleLeafHash , colLeafIdentityHash } ) + rows : = tx.stx.ReadWithOptions ( ctx , unseqTable , rs , [ ] string { colBucket , colQueueTimestampNanos , colMerkleLeafHash , colLeafIdentityHash } , readOpts ) if err : = rows.Do ( func ( r *spanner.Row ) error { if len ( ret ) > = limit { - return errFinished + drain++ + return nil } var l trillian.LogLeaf var qe QueuedEntry @ @ -562,8 +565,11 @ @ func ( tx *logTX ) DequeueLeaves ( ctx context.Context , limit int
diff -- git a/.travis.yml b/.travis.yml index 952375a..392817d 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -17,14 +17,17 @ @ install : mkdir -p $ HOME/gopath/src/github.com/google ln -s $ TRAVIS_BUILD_DIR $ HOME/gopath/src/github.com/google/trillian fi - - mkdir protoc + - mkdir ../protoc - | ( - cd protoc + cd ../protoc wget https : //github.com/google/protobuf/releases/download/v3.2.0/protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip unzip protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip + git clone https : //github.com/googleapis/googleapis.git + cd include/google + ln -s ../../googleapis/google/rpc ) - - export PATH= $ ( pwd ) /protoc/bin : $ PATH + - export PATH= $ ( pwd ) /../protoc/bin : $ PATH - go get -d ./ ... - if [ [ $ TRAVIS_OS_NAME == `` osx '' ] ] ; then brew update > /dev/null & & brew install mariadb & & mysql.server start ; fi - go get -u github.com/client9/misspell/cmd/misspell diff -- git a/client/client.go b/client/client.go index 45196ac..bd0742e 100644 -- - a/client/client.go +++ b/client/client.go @ @ -27,6 +27,7 @ @ import ( '' github.com/google/trillian/client/backoff '' '' github.com/google/trillian/crypto '' '' github.com/google/trillian/merkle '' + '' google.golang.org/genproto/googleapis/rpc/code '' '' google.golang.org/grpc '' '' google.golang.org/grpc/codes '' ) @ @ -206,6 +207,13 @ @ func ( c *LogClient ) queueLeaf ( ctx context.Context ,
diff -- git a/.travis.yml b/.travis.yml index 952375a..392817d 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -17,14 +17,17 @ @ install : mkdir -p $ HOME/gopath/src/github.com/google ln -s $ TRAVIS_BUILD_DIR $ HOME/gopath/src/github.com/google/trillian fi - - mkdir protoc + - mkdir ../protoc - | ( - cd protoc + cd ../protoc wget https : //github.com/google/protobuf/releases/download/v3.2.0/protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip unzip protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip + git clone https : //github.com/googleapis/googleapis.git + cd include/google + ln -s ../../googleapis/google/rpc ) - - export PATH= $ ( pwd ) /protoc/bin : $ PATH + - export PATH= $ ( pwd ) /../protoc/bin : $ PATH - go get -d ./ ... - if [ [ $ TRAVIS_OS_NAME == `` osx '' ] ] ; then brew update > /dev/null & & brew install mariadb & & mysql.server start ; fi - go get -u github.com/client9/misspell/cmd/misspell diff -- git a/client/client.go b/client/client.go index 45196ac..bd0742e 100644 -- - a/client/client.go +++ b/client/client.go @ @ -27,6 +27,7 @ @ import ( '' github.com/google/trillian/client/backoff '' '' github.com/google/trillian/crypto '' '' github.com/google/trillian/merkle '' + '' google.golang.org/genproto/googleapis/rpc/code '' '' google.golang.org/grpc '' '' google.golang.org/grpc/codes '' ) @ @ -206,6 +207,13 @ @ func ( c *LogClient ) queueLeaf ( ctx context.Context ,
diff -- git a/.travis.yml b/.travis.yml index 952375a..392817d 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -17,14 +17,17 @ @ install : mkdir -p $ HOME/gopath/src/github.com/google ln -s $ TRAVIS_BUILD_DIR $ HOME/gopath/src/github.com/google/trillian fi - - mkdir protoc + - mkdir ../protoc - | ( - cd protoc + cd ../protoc wget https : //github.com/google/protobuf/releases/download/v3.2.0/protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip unzip protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip + git clone https : //github.com/googleapis/googleapis.git + cd include/google + ln -s ../../googleapis/google/rpc ) - - export PATH= $ ( pwd ) /protoc/bin : $ PATH + - export PATH= $ ( pwd ) /../protoc/bin : $ PATH - go get -d ./ ... - if [ [ $ TRAVIS_OS_NAME == `` osx '' ] ] ; then brew update > /dev/null & & brew install mariadb & & mysql.server start ; fi - go get -u github.com/client9/misspell/cmd/misspell diff -- git a/client/client.go b/client/client.go index 45196ac..bd0742e 100644 -- - a/client/client.go +++ b/client/client.go @ @ -27,6 +27,7 @ @ import ( '' github.com/google/trillian/client/backoff '' '' github.com/google/trillian/crypto '' '' github.com/google/trillian/merkle '' + '' google.golang.org/genproto/googleapis/rpc/code '' '' google.golang.org/grpc '' '' google.golang.org/grpc/codes '' ) @ @ -206,6 +207,13 @ @ func ( c *LogClient ) queueLeaf ( ctx context.Context ,
diff -- git a/.travis.yml b/.travis.yml index 952375a..392817d 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -17,14 +17,17 @ @ install : mkdir -p $ HOME/gopath/src/github.com/google ln -s $ TRAVIS_BUILD_DIR $ HOME/gopath/src/github.com/google/trillian fi - - mkdir protoc + - mkdir ../protoc - | ( - cd protoc + cd ../protoc wget https : //github.com/google/protobuf/releases/download/v3.2.0/protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip unzip protoc-3.2.0- $ { TRAVIS_OS_NAME } -x86_64.zip + git clone https : //github.com/googleapis/googleapis.git + cd include/google + ln -s ../../googleapis/google/rpc ) - - export PATH= $ ( pwd ) /protoc/bin : $ PATH + - export PATH= $ ( pwd ) /../protoc/bin : $ PATH - go get -d ./ ... - if [ [ $ TRAVIS_OS_NAME == `` osx '' ] ] ; then brew update > /dev/null & & brew install mariadb & & mysql.server start ; fi - go get -u github.com/client9/misspell/cmd/misspell diff -- git a/client/client.go b/client/client.go index 45196ac..bd0742e 100644 -- - a/client/client.go +++ b/client/client.go @ @ -27,6 +27,7 @ @ import ( '' github.com/google/trillian/client/backoff '' '' github.com/google/trillian/crypto '' '' github.com/google/trillian/merkle '' + '' google.golang.org/genproto/googleapis/rpc/code '' '' google.golang.org/grpc '' '' google.golang.org/grpc/codes '' ) @ @ -206,6 +207,13 @ @ func ( c *LogClient ) queueLeaf ( ctx context.Context ,
diff -- git a/client/client.go b/client/client.go index bd0742e..ceb43a3 100644 -- - a/client/client.go +++ b/client/client.go @ @ -34,30 +34,35 @ @ import ( // LogClient represents a client for a given Trillian log instance . type LogClient struct { - LogID int64 - client trillian.TrillianLogClient - hasher merkle.TreeHasher - STR trillian.SignedLogRoot - MaxTries int - pubKey gocrypto.PublicKey + LogID int64 + client trillian.TrillianLogClient + hasher merkle.TreeHasher + root trillian.SignedLogRoot + pubKey gocrypto.PublicKey } // New returns a new LogClient . -func New ( logID int64 , client trillian.TrillianLogClient , hasher merkle.TreeHasher , pubKey gocrypto.PublicKey ) *LogClient { +func New ( logID int64 , client trillian.TrillianLogClient , hasher merkle.TreeHasher , pubKey gocrypto.PublicKey ) VerifyingLogClient { return & LogClient { - LogID : logID , - client : client , - hasher : hasher , - MaxTries : 3 , - pubKey : pubKey , + LogID : logID , + client : client , + hasher : hasher , + pubKey : pubKey , } } +// Root returns the current trusted SignedLogRoot . +// The client blindly trusts the first Root it sees . +// All others must have consistency proofs between the last Root seen and the new one . +func
diff -- git a/client/client.go b/client/client.go index bd0742e..13965b3 100644 -- - a/client/client.go +++ b/client/client.go @ @ -34,30 +34,34 @ @ import ( // LogClient represents a client for a given Trillian log instance . type LogClient struct { - LogID int64 - client trillian.TrillianLogClient - hasher merkle.TreeHasher - STR trillian.SignedLogRoot - MaxTries int - pubKey gocrypto.PublicKey + LogID int64 + client trillian.TrillianLogClient + hasher merkle.TreeHasher + root trillian.SignedLogRoot + pubKey gocrypto.PublicKey } // New returns a new LogClient . -func New ( logID int64 , client trillian.TrillianLogClient , hasher merkle.TreeHasher , pubKey gocrypto.PublicKey ) *LogClient { +func New ( logID int64 , client trillian.TrillianLogClient , hasher merkle.TreeHasher , pubKey gocrypto.PublicKey ) VerifyingLogClient { return & LogClient { - LogID : logID , - client : client , - hasher : hasher , - MaxTries : 3 , - pubKey : pubKey , + LogID : logID , + client : client , + hasher : hasher , + pubKey : pubKey , } } +// Root returns the last valid root seen by UpdateRoot . +// Returns an empty SignedLogRoot if UpdateRoot has not been called . +func ( c *LogClient ) Root ( ) trillian.SignedLogRoot { + return c.root +
diff -- git a/storage/mysql/storage_test.go b/storage/mysql/storage_test.go index f28ff35..a8924c6 100644 -- - a/storage/mysql/storage_test.go +++ b/storage/mysql/storage_test.go @ @ -32,24 +32,6 @ @ import ( '' github.com/google/trillian/testonly '' ) -// Explicit test for node id conversion to / from protos . -func TestNodeIDSerialization ( t *testing.T ) { - nodeID : = storage.NodeID { Path : [ ] byte ( `` hello '' ) , PrefixLenBits : 3 , PathLenBits : 40 } - - serializedBytes , err : = encodeNodeID ( nodeID ) - if err ! = nil { - t.Fatalf ( `` Failed to serialize NodeID : % v , % v '' , nodeID , err ) - } - - nodeID2 , err : = decodeNodeID ( serializedBytes ) - if err ! = nil { - t.Fatalf ( `` Failed to deserialize NodeID : % v , % v '' , nodeID , err ) - } - if expected , got : = nodeID.String ( ) , nodeID2.String ( ) ; expected ! = got { - t.Errorf ( `` Round trip of nodeID failed : % v % v '' , expected , got ) - } - } - func TestNodeRoundTrip ( t *testing.T )
diff -- git a/util/proxy/logproxy.go b/util/proxy/logproxy.go new file mode 100644 index 0000000..fa11c70 -- - /dev/null +++ b/util/proxy/logproxy.go @ @ -0,0 +1,84 @ @ +// Copyright 2017 Google Inc. All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package logproxy forwards Trillian Log Server requests to another server . +package logproxy + +import ( + '' golang.org/x/net/context '' + + '' github.com/google/trillian '' + ) + +// Log implements the TrillianLogServer interface . +// For each RPC , Log forwards the request to the assicated method in +// the TrillianLogClient . +type Log struct { + c trillian.TrillianLogClient +
diff -- git a/docs/source/Schemas.md b/docs/source/Schemas.md index daeb90a..70d3e22 100755 -- - a/docs/source/Schemas.md +++ b/docs/source/Schemas.md @ @ -278,6 +278,9 @ @ Current understood attributes : - ` key ` ( on a field ) : this field is meant to be used as a key when sorting a vector of the type of table it sits in . Can be used for in-place binary search . +- ` map_entry ` ( on a table ) : The table must have a string field annotated with + the key attribute.enable vectors of this table to be parsed as a JSON + object instead of an array of object . # # JSON Parsing diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index f77b13e..d2f5d22 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -14,8 +14,8 @ @ * limitations under the License . */ - # ifndef FLATBUFFERS_H_ - # define FLATBUFFERS_H_ + # ifndef INCLUDE_FLATBUFFERS_FLATBUFFERS_H_ + # define INCLUDE_FLATBUFFERS_FLATBUFFERS_H_ # include < assert.h > @ @ -45,7 +45,7 @ @ # define FLATBUFFERS_LITTLEENDIAN 0 # else # define FLATBUFFERS_LITTLEENDIAN 1 - # endif // __BIG_ENDIAN__ + # endif // __BIG_ENDIAN__ # elif defined ( _MSC_VER ) # if defined ( _M_PPC ) # define FLATBUFFERS_LITTLEENDIAN 0 @
diff -- git a/CMakeLists.txt b/CMakeLists.txt index bc71610..affa05b 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -144,8 +144,8 @ @ elseif ( $ { CMAKE_CXX_COMPILER_ID } MATCHES `` Clang '' ) `` $ { CMAKE_CXX_FLAGS } -fsigned-char '' ) elseif ( MSVC ) - # warning C4512 : assignment operator could not be generated - set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } /wd4512 '' ) + # Visual Studio pedantic build settings + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } /W4 /WX '' ) endif ( ) if ( FLATBUFFERS_CODE_COVERAGE ) diff -- git a/include/flatbuffers/flexbuffers.h b/include/flatbuffers/flexbuffers.h index a5d24fd..3bd86f7 100644 -- - a/include/flatbuffers/flexbuffers.h +++ b/include/flatbuffers/flexbuffers.h @ @ -26,6 +26,11 @ @ # include < intrin.h > # endif + # if defined ( _MSC_VER ) + # pragma warning ( push ) + # pragma warning ( disable : 4127 ) // C4127 : conditional expression is constant + # endif + namespace flexbuffers { class Reference ; @ @ -105,7 +110,7 @ @ inline Type ToTypedVectorElementType ( Type t ) { inline Type ToFixedTypedVectorElementType ( Type t , uint8_t *len ) { assert ( IsFixedTypedVector ( t ) ) ; auto fixed_type = t - TYPE_VECTOR_INT2 ; - *len
diff -- git a/BUILD b/BUILD index 0b940e5..db61a99 100644 -- - a/BUILD +++ b/BUILD @ @ -10,6 +10,8 @ @ exports_files ( [ `` LICENSE '' , ] ) +load ( `` : build_defs.bzl '' , `` flatbuffer_cc_library '' ) + FLATBUFFERS_COPTS = [ `` -Wno-implicit-fallthrough '' , `` -linclude '' , @ @ -109,6 +111,18 @ @ cc_binary ( ] , ) +cc_library ( + name = `` runtime_cc '' , + hdrs = [ + `` include/flatbuffers/base.h '' , + `` include/flatbuffers/flatbuffers.h '' , + `` include/flatbuffers/stl_emulation.h '' , + `` include/flatbuffers/util.h '' , + ] , + includes = [ `` include '' ] , + linkstatic = 1 , + ) + # Test binary . cc_test ( name = `` flatbuffers_test '' , @ @ -147,3 +161,22 @ @ cc_test ( ] , includes = [ `` include/ '' ] , ) + + # Test bzl rules + +flatbuffer_cc_library ( + name = `` monster_test_cc_fbs '' , + srcs = [ `` tests/monster_test.fbs '' ] , + include_paths = [ `` tests/include_test '' ] , + includes = [ + `` tests/include_test/include_test1.fbs '' , + `` tests/include_test/sub/include_test2.fbs '' , + ] , + ) +
diff -- git a/CMakeLists.txt b/CMakeLists.txt index d313980..d74123a 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -226,7 +226,7 @ @ endif ( ) if ( FLATBUFFERS_BUILD_GRPCTEST ) if ( CMAKE_COMPILER_IS_GNUCXX ) - set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter '' ) + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter -Wno-shadow '' ) endif ( ) add_executable ( grpctest $ { FlatBuffers_GRPCTest_SRCS } ) target_link_libraries ( grpctest grpc++_unsecure pthread dl ) diff -- git a/grpc/tests/grpctest.cpp b/grpc/tests/grpctest.cpp index f0a1f57..2207fb5 100644 -- - a/grpc/tests/grpctest.cpp +++ b/grpc/tests/grpctest.cpp @ @ -27,24 +27,21 @ @ using namespace MyGame : :Example ; // code . It implements all rpcs specified in the FlatBuffers schema . class ServiceImpl final : public MyGame : :Example : :MonsterStorage : :Service { virtual : :grpc : :Status Store ( : :grpc : :ServerContext* context , - const flatbuffers : :BufferRef < Monster > *request , - flatbuffers : :BufferRef < Stat > *response ) + const flatbuffers : :grpc : :Message < Monster > *request , + flatbuffers : :grpc : :Message < Stat > *response ) override { // Create a response from the incoming request name . fbb_.Clear ( ) ; auto stat_offset = CreateStat (
diff -- git a/appveyor.yml b/appveyor.yml index 262d9b0..1fffead 100644 -- - a/appveyor.yml +++ b/appveyor.yml @ @ -5,6 +5,12 @ @ branches : os : Visual Studio 2015 environment : + + global : + # Workaround for https : //github.com/conda/conda-build/issues/636 + PYTHONIOENCODING : UTF-8 + CONDA_INSTALL_LOCN : `` C : \\Miniconda35-x64 '' + matrix : - CMAKE_VS_VERSION : `` 10 2010 '' - CMAKE_VS_VERSION : `` 14 2015 '' @ @ -26,17 +32,39 @ @ build : project : ALL_BUILD.vcxproj verbosity : minimal +install : + - set PATH= % CONDA_INSTALL_LOCN % ; % CONDA_INSTALL_LOCN % \scripts ; % PATH % ; + test_script : + - `` cd tests '' + - rem `` Building all code '' + - generate_code.bat -b % CONFIGURATION % + - 7z a GeneratedMyGameCode.zip MyGame\ - rem `` -- -- -- -- -- -- -- -- C++ -- -- -- -- -- -- -- -- - '' + - `` cd .. '' - `` % CONFIGURATION % \\flattests.exe '' - - rem `` -- -- -- -- -- -- -- -- Java -- -- -- -- -- -- -- -- - '' - `` cd tests '' + - rem `` -- --
diff -- git a/CMakeLists.txt b/CMakeLists.txt index d313980..d74123a 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -226,7 +226,7 @ @ endif ( ) if ( FLATBUFFERS_BUILD_GRPCTEST ) if ( CMAKE_COMPILER_IS_GNUCXX ) - set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter '' ) + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter -Wno-shadow '' ) endif ( ) add_executable ( grpctest $ { FlatBuffers_GRPCTest_SRCS } ) target_link_libraries ( grpctest grpc++_unsecure pthread dl ) diff -- git a/grpc/tests/grpctest.cpp b/grpc/tests/grpctest.cpp index f0a1f57..2207fb5 100644 -- - a/grpc/tests/grpctest.cpp +++ b/grpc/tests/grpctest.cpp @ @ -27,24 +27,21 @ @ using namespace MyGame : :Example ; // code . It implements all rpcs specified in the FlatBuffers schema . class ServiceImpl final : public MyGame : :Example : :MonsterStorage : :Service { virtual : :grpc : :Status Store ( : :grpc : :ServerContext* context , - const flatbuffers : :BufferRef < Monster > *request , - flatbuffers : :BufferRef < Stat > *response ) + const flatbuffers : :grpc : :Message < Monster > *request , + flatbuffers : :grpc : :Message < Stat > *response ) override { // Create a response from the incoming request name . fbb_.Clear ( ) ; auto stat_offset = CreateStat (
diff -- git a/CMakeLists.txt b/CMakeLists.txt index d313980..d74123a 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -226,7 +226,7 @ @ endif ( ) if ( FLATBUFFERS_BUILD_GRPCTEST ) if ( CMAKE_COMPILER_IS_GNUCXX ) - set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter '' ) + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter -Wno-shadow '' ) endif ( ) add_executable ( grpctest $ { FlatBuffers_GRPCTest_SRCS } ) target_link_libraries ( grpctest grpc++_unsecure pthread dl ) diff -- git a/grpc/tests/grpctest.cpp b/grpc/tests/grpctest.cpp index f0a1f57..2207fb5 100644 -- - a/grpc/tests/grpctest.cpp +++ b/grpc/tests/grpctest.cpp @ @ -27,24 +27,21 @ @ using namespace MyGame : :Example ; // code . It implements all rpcs specified in the FlatBuffers schema . class ServiceImpl final : public MyGame : :Example : :MonsterStorage : :Service { virtual : :grpc : :Status Store ( : :grpc : :ServerContext* context , - const flatbuffers : :BufferRef < Monster > *request , - flatbuffers : :BufferRef < Stat > *response ) + const flatbuffers : :grpc : :Message < Monster > *request , + flatbuffers : :grpc : :Message < Stat > *response ) override { // Create a response from the incoming request name . fbb_.Clear ( ) ; auto stat_offset = CreateStat (
diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index b51ebf3..2966052 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -856,7 +856,7 @ @ bool GenerateGoGRPC ( const Parser & parser , const std : :string & path , const std : :string & file_name ) ; -// Generate GRPC Java classes . + // Generate GRPC Java classes . // See idl_gen_grpc.cpp bool GenerateJavaGRPC ( const Parser & parser , const std : :string & path ,
diff -- git a/CMakeLists.txt b/CMakeLists.txt index d313980..d74123a 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -226,7 +226,7 @ @ endif ( ) if ( FLATBUFFERS_BUILD_GRPCTEST ) if ( CMAKE_COMPILER_IS_GNUCXX ) - set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter '' ) + set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } -Wno-unused-parameter -Wno-shadow '' ) endif ( ) add_executable ( grpctest $ { FlatBuffers_GRPCTest_SRCS } ) target_link_libraries ( grpctest grpc++_unsecure pthread dl ) diff -- git a/docs/source/doxyfile b/docs/source/doxyfile index 770da9f..5c38cb9 100755 -- - a/docs/source/doxyfile +++ b/docs/source/doxyfile @ @ -765,6 +765,7 @ @ INPUT = `` FlatBuffers.md '' \ `` ../../CONTRIBUTING.md '' \ `` Tutorial.md '' \ `` GoApi.md '' \ + `` gRPC/CppUsage.md '' \ `` groups '' \ `` ../../java/com/google/flatbuffers '' \ `` ../../python/flatbuffers/builder.py '' \ diff -- git a/docs/source/doxygen_layout.xml b/docs/source/doxygen_layout.xml index 77866df..504d15c 100644 -- - a/docs/source/doxygen_layout.xml +++ b/docs/source/doxygen_layout.xml @ @ -39,6 +39,10 @ @ title= '' Use in Python '' / > < tab type= '' user '' url= '' @ ref flexbuffers '' title= '' Schema-less version '' / > + < tab type= '' usergroup '' url= '' '' title= '' gRPC '' > + < tab type= '' user '' url= '' @ ref flatbuffers_grpc_guide_use_cpp
diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index c166e4b..0f45d20 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -154,6 +154,10 @ @ typedef uintmax_t largest_scalar_t ; // We support aligning the contents of buffers up to this size . # define FLATBUFFERS_MAX_ALIGNMENT 16 +static FLATBUFFERS_CONSTEXPR const size_t kFileIdentifierLength = 4 ; + +typedef std : :allocator < uint8_t > DefaultAllocator ; + # ifndef FLATBUFFERS_CPP98_STL // Pointer to relinquished memory . typedef std : :unique_ptr < uint8_t , std : :function < void ( uint8_t * /* unused */ ) > > @ @ -542,22 +546,28 @ @ struct String : public Vector < char > { } } ; -// Simple indirection for buffer allocation , to allow this to be overridden -// with custom allocation ( see the FlatBufferBuilder constructor ) . -class simple_allocator { - public : - virtual ~simple_allocator ( ) { } - virtual uint8_t *allocate ( size_t size ) const { return new uint8_t [ size ] ; } - virtual void deallocate ( uint8_t *p ) const { delete [ ] p ; } - } ; - // This is a minimal replication of std : :vector < uint8_t > functionality , // except growing
diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index c166e4b..66332df 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -123,6 +123,15 @ @ # define FLATBUFFERS_NOEXCEPT # endif +// NOTE : the FLATBUFFERS_DELETE_FUNC macro may change the access mode to +// private , so be sure to put it at the end or reset access mode explicitly . + # if ( ! defined ( _MSC_VER ) || _MSC_FULL_VER > = 180020827 ) & & \ + ( ! defined ( __GNUC__ ) || ( __GNUC__ * 100 + __GNUC_MINOR__ > = 404 ) ) + # define FLATBUFFERS_DELETE_FUNC ( func ) func = delete ; + # else + # define FLATBUFFERS_DELETE_FUNC ( func ) private : func ; + # endif + # if defined ( _MSC_VER ) # pragma warning ( push ) # pragma warning ( disable : 4127 ) // C4127 : conditional expression is constant @ @ -154,12 +163,6 @ @ typedef uintmax_t largest_scalar_t ; // We support aligning the contents of buffers up to this size . # define FLATBUFFERS_MAX_ALIGNMENT 16 - # ifndef FLATBUFFERS_CPP98_STL -// Pointer to relinquished memory . -typedef std : :unique_ptr < uint8_t , std : :function < void ( uint8_t * /*
diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index c166e4b..bd2810b 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -105,8 +105,10 @ @ # if ( ! defined ( _MSC_VER ) || _MSC_VER > 1600 ) & & \ ( ! defined ( __GNUC__ ) || ( __GNUC__ * 100 + __GNUC_MINOR__ > = 407 ) ) # define FLATBUFFERS_FINAL_CLASS final + # define FLATBUFFERS_OVERRIDE override # else # define FLATBUFFERS_FINAL_CLASS + # define FLATBUFFERS_OVERRIDE # endif # if ( ! defined ( _MSC_VER ) || _MSC_VER > = 1900 ) & & \ @ @ -123,6 +125,24 @ @ # define FLATBUFFERS_NOEXCEPT # endif +// NOTE : the FLATBUFFERS_DELETE_FUNC macro may change the access mode to +// private , so be sure to put it at the end or reset access mode explicitly . + # if ( ! defined ( _MSC_VER ) || _MSC_FULL_VER > = 180020827 ) & & \ + ( ! defined ( __GNUC__ ) || ( __GNUC__ * 100 + __GNUC_MINOR__ > = 404 ) ) + # define FLATBUFFERS_DELETE_FUNC ( func ) func = delete ; + # else + # define FLATBUFFERS_DELETE_FUNC ( func ) private : func ; + # endif + + # ifdef
diff -- git a/.gitignore b/.gitignore index c1011c3..cd0182d 100644 -- - a/.gitignore +++ b/.gitignore @ @ -45,6 +45,7 @ @ grpctest grpctest.exe snapshot.sh tags +tests/dart_gen tests/go_gen tests/monsterdata_java_wire.mon tests/monsterdata_java_wire_sp.mon @ @ -93,3 +94,4 @ @ js/flatbuffers.mjs .ninja_log build.ninja rules.ninja +.vscode/ diff -- git a/BUILD b/BUILD index 4b10991..7610efc 100644 -- - a/BUILD +++ b/BUILD @ @ -86,6 +86,7 @ @ cc_binary ( `` grpc/src/compiler/schema_interface.h '' , `` src/flatc_main.cpp '' , `` src/idl_gen_cpp.cpp '' , + `` src/idl_gen_dart.cpp '' , `` src/idl_gen_general.cpp '' , `` src/idl_gen_go.cpp '' , `` src/idl_gen_grpc.cpp '' , diff -- git a/CMakeLists.txt b/CMakeLists.txt index 16a70b8..f913198 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -45,6 +45,7 @ @ set ( FlatBuffers_Library_SRCS set ( FlatBuffers_Compiler_SRCS $ { FlatBuffers_Library_SRCS } src/idl_gen_cpp.cpp + src/idl_gen_dart.cpp src/idl_gen_general.cpp src/idl_gen_go.cpp src/idl_gen_js.cpp diff -- git a/android/.project b/android/.project deleted file mode 100644 index e7d5931..0000000 -- - a/android/.project +++ /dev/null @ @ -1,20 +0,0 @ @ - < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > - < ! -- Copyright ( c ) 2014 Google , Inc. - - This software is provided 'as-is ' , without any express or implied - warranty . In no event will the authors be held liable for any damages
diff -- git a/.gitignore b/.gitignore index c1011c3..cd0182d 100644 -- - a/.gitignore +++ b/.gitignore @ @ -45,6 +45,7 @ @ grpctest grpctest.exe snapshot.sh tags +tests/dart_gen tests/go_gen tests/monsterdata_java_wire.mon tests/monsterdata_java_wire_sp.mon @ @ -93,3 +94,4 @ @ js/flatbuffers.mjs .ninja_log build.ninja rules.ninja +.vscode/ diff -- git a/BUILD b/BUILD index 4b10991..7610efc 100644 -- - a/BUILD +++ b/BUILD @ @ -86,6 +86,7 @ @ cc_binary ( `` grpc/src/compiler/schema_interface.h '' , `` src/flatc_main.cpp '' , `` src/idl_gen_cpp.cpp '' , + `` src/idl_gen_dart.cpp '' , `` src/idl_gen_general.cpp '' , `` src/idl_gen_go.cpp '' , `` src/idl_gen_grpc.cpp '' , diff -- git a/CMakeLists.txt b/CMakeLists.txt index a3388dd..90860c3 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -45,6 +45,7 @ @ set ( FlatBuffers_Library_SRCS set ( FlatBuffers_Compiler_SRCS $ { FlatBuffers_Library_SRCS } src/idl_gen_cpp.cpp + src/idl_gen_dart.cpp src/idl_gen_general.cpp src/idl_gen_go.cpp src/idl_gen_js.cpp diff -- git a/dart/.packages b/dart/.packages new file mode 100644 index 0000000..6ca9a71 -- - /dev/null +++ b/dart/.packages @ @ -0,0 +1,2 @ @ + # Generated by pub on 2018-04-06 16:01:23.784220 . +flat_buffers : lib/ diff -- git a/dart/LICENSE b/dart/LICENSE new file mode 100644 index 0000000..81764fd -- - /dev/null +++ b/dart/LICENSE @ @ -0,0 +1,24 @ @ +Copyright 2012 , the Dart project authors . All rights reserved . +Redistribution and use in source and binary forms ,
diff -- git a/.gitignore b/.gitignore index c1011c3..cd0182d 100644 -- - a/.gitignore +++ b/.gitignore @ @ -45,6 +45,7 @ @ grpctest grpctest.exe snapshot.sh tags +tests/dart_gen tests/go_gen tests/monsterdata_java_wire.mon tests/monsterdata_java_wire_sp.mon @ @ -93,3 +94,4 @ @ js/flatbuffers.mjs .ninja_log build.ninja rules.ninja +.vscode/ diff -- git a/BUILD b/BUILD index 4b10991..7610efc 100644 -- - a/BUILD +++ b/BUILD @ @ -86,6 +86,7 @ @ cc_binary ( `` grpc/src/compiler/schema_interface.h '' , `` src/flatc_main.cpp '' , `` src/idl_gen_cpp.cpp '' , + `` src/idl_gen_dart.cpp '' , `` src/idl_gen_general.cpp '' , `` src/idl_gen_go.cpp '' , `` src/idl_gen_grpc.cpp '' , diff -- git a/CMakeLists.txt b/CMakeLists.txt index a3388dd..90860c3 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -45,6 +45,7 @ @ set ( FlatBuffers_Library_SRCS set ( FlatBuffers_Compiler_SRCS $ { FlatBuffers_Library_SRCS } src/idl_gen_cpp.cpp + src/idl_gen_dart.cpp src/idl_gen_general.cpp src/idl_gen_go.cpp src/idl_gen_js.cpp diff -- git a/dart/.gitignore b/dart/.gitignore new file mode 100644 index 0000000..9d46fd7 -- - /dev/null +++ b/dart/.gitignore @ @ -0,0 +1,5 @ @ +.pub/ +.packages +.dart_tool/ +build/ +doc/api/ diff -- git a/dart/LICENSE b/dart/LICENSE new file mode 100644 index 0000000..81764fd -- - /dev/null +++ b/dart/LICENSE @ @ -0,0 +1,24 @ @ +Copyright 2012 , the Dart project authors . All rights reserved . +Redistribution and use in source and binary forms , with or without +modification , are permitted
diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index 6453c30..d0b96ab 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -573,15 +573,12 @ @ class vector_downward { scratch_ ( nullptr ) { } ~vector_downward ( ) { - if ( buf_ ) Deallocate ( allocator_ , buf_ , reserved_ ) ; - if ( own_allocator_ & & allocator_ ) { delete allocator_ ; } + clear_buffer ( ) ; + clear_allocator ( ) ; } void reset ( ) { - if ( buf_ ) { - Deallocate ( allocator_ , buf_ , reserved_ ) ; - buf_ = nullptr ; - } + clear_buffer ( ) ; clear ( ) ; } @ @ -599,6 +596,29 @ @ class vector_downward { scratch_ = buf_ ; } + void clear_allocator ( ) { + if ( own_allocator_ & & allocator_ ) { delete allocator_ ; } + allocator_ = nullptr ; + own_allocator_ = false ; + } + + void clear_buffer ( ) { + if ( buf_ ) Deallocate ( allocator_ , buf_ , reserved_ ) ; + buf_ = nullptr ; + } + + // Relinquish the pointer to the caller . + uint8_t *release_raw ( size_t & allocated_bytes , size_t
diff -- git a/.gitignore b/.gitignore index 9dfabef..135dc5c 100755 -- - a/.gitignore +++ b/.gitignore @ @ -66,3 +66,6 @ @ build/VS2010/FlatBuffers.opensdf build/VS2010/ipch/**/*.ipch *.so Testing/Temporary +.cproject +.settings/ +.project diff -- git a/CMakeLists.txt b/CMakeLists.txt index affa05b..242a1b6 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -48,6 +48,7 @ @ set ( FlatBuffers_Compiler_SRCS src/idl_gen_python.cpp src/idl_gen_fbs.cpp src/idl_gen_grpc.cpp + src/idl_gen_ts.cpp src/flatc.cpp src/flatc_main.cpp grpc/src/compiler/schema_interface.h diff -- git a/include/flatbuffers/code_generators.h b/include/flatbuffers/code_generators.h index 16e368e..3e85df2 100644 -- - a/include/flatbuffers/code_generators.h +++ b/include/flatbuffers/code_generators.h @ @ -114,6 +114,8 @ @ class BaseGenerator { std : :string WrapInNameSpace ( const Definition & def ) const ; + std : :string GetNameSpace ( const Definition & def ) const ; + const Parser & parser_ ; const std : :string & path_ ; const std : :string & file_name_ ; diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index 5b7a72a..dabfb4f 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -357,6 +357,7 @ @ struct IDLOptions { bool allow_non_utf8 ; std : :string include_prefix ; bool binary_schema_comments ; + bool skip_flatbuffers_import ; // Possible options for the more general generator below . enum Language { @ @ -369,6 +370,7 @ @ struct IDLOptions { kPhp = 1 < < 6 , kJson = 1 < < 7 , kBinary = 1 <
diff -- git a/.gitignore b/.gitignore index 77a77b9..729e5a1 100755 -- - a/.gitignore +++ b/.gitignore @ @ -66,5 +66,7 @ @ build/VS2010/FlatBuffers.opensdf build/VS2010/ipch/**/*.ipch *.so Testing/Temporary +.cproject +.settings/ +.project net/**/obj - diff -- git a/include/flatbuffers/code_generators.h b/include/flatbuffers/code_generators.h index 16e368e..3e85df2 100644 -- - a/include/flatbuffers/code_generators.h +++ b/include/flatbuffers/code_generators.h @ @ -114,6 +114,8 @ @ class BaseGenerator { std : :string WrapInNameSpace ( const Definition & def ) const ; + std : :string GetNameSpace ( const Definition & def ) const ; + const Parser & parser_ ; const std : :string & path_ ; const std : :string & file_name_ ; diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index deb1edf..9978d34 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -358,7 +358,9 @ @ struct IDLOptions { bool allow_non_utf8 ; std : :string include_prefix ; bool binary_schema_comments ; + bool skip_flatbuffers_import ; std : :string go_namespace ; + bool reexport_ts_modules ; // Possible options for the more general generator below . enum Language { @ @ -371,6 +373,7 @ @ struct IDLOptions { kPhp = 1 < < 6 , kJson = 1 < < 7 , kBinary = 1 < < 8 , + kTs = 1 < < 9 , kMAX } ; @ @ -400,6 +403,8 @
diff -- git a/.gitignore b/.gitignore index c6c3067..aedeb3c 100755 -- - a/.gitignore +++ b/.gitignore @ @ -48,6 +48,7 @ @ tests/monsterdata_java_wire.mon tests/monsterdata_go_wire.mon tests/monsterdata_javascript_wire.mon tests/unicode_test.mon +tests/ts/ CMakeLists.txt.user CMakeScripts/** CTestTestfile.cmake diff -- git a/tests/JavaScriptTest.js b/tests/JavaScriptTest.js index c656974..7ed313a 100644 -- - a/tests/JavaScriptTest.js +++ b/tests/JavaScriptTest.js @ @ -3,7 +3,7 @ @ var assert = require ( 'assert ' ) ; var fs = require ( 'fs ' ) ; var flatbuffers = require ( '../js/flatbuffers ' ) .flatbuffers ; -var MyGame = require ( './monster_test_generated ' ) .MyGame ; +var MyGame = require ( process.argv [ 2 ] ) .MyGame ; function main ( ) { diff -- git a/tests/JavaScriptTest.sh b/tests/JavaScriptTest.sh index 75db007..cdba5fa 100755 -- - a/tests/JavaScriptTest.sh +++ b/tests/JavaScriptTest.sh @ @ -16,4 +16,4 @ @ pushd `` $ ( dirname $ 0 ) '' > /dev/null ../flatc -b monster_test.fbs unicode_test.json -node JavaScriptTest +node JavaScriptTest ./monster_test_generated diff -- git a/tests/TypeScriptTest.sh b/tests/TypeScriptTest.sh index 4e37451..a5d44d5 100755 -- - a/tests/TypeScriptTest.sh +++ b/tests/TypeScriptTest.sh @ @ -15,11 +15,9 @ @ # limitations under the License . pushd `` $ ( dirname $ 0 ) '' > /dev/null -../flatc -- ts -- no-fb-import -- gen-mutable monster_test.fbs +../flatc -- ts -- no-fb-import -- gen-mutable -o ts monster_test.fbs ../flatc -b monster_test.fbs unicode_test.json npm install
diff -- git a/src/idl_gen_js.cpp b/src/idl_gen_js.cpp index edcb780..9fac550 100644 -- - a/src/idl_gen_js.cpp +++ b/src/idl_gen_js.cpp @ @ -955,7 +955,7 @ @ void GenStruct ( const Parser & parser , StructDef & struct_def , if ( lang_.language == IDLOptions : :kTs ) { code += `` static create '' + struct_def.name + `` ( builder : flatbuffers.Builder '' ; - code += arguments + `` ) : flatbuffers.Offset|null { \n '' ; + code += arguments + `` ) : flatbuffers.Offset { \n '' ; } else { code += object_name + `` .create '' + struct_def.name + `` = function ( builder '' ; code += arguments + `` ) { \n '' ; @ @ -1049,8 +1049,7 @ @ void GenStruct ( const Parser & parser , StructDef & struct_def , type += `` | Uint8Array '' ; } code += `` Vector ( builder : flatbuffers.Builder , data : '' + type + - `` ) : flatbuffers.Offset|null { \n '' ; - code += `` if ( ! data ) { \n return null ; \n } \n '' ; + `` ) : flatbuffers.Offset { \n '' ; } else { code += object_name + `` .create ''
diff -- git a/.gitignore b/.gitignore index 9dfabef..135dc5c 100755 -- - a/.gitignore +++ b/.gitignore @ @ -66,3 +66,6 @ @ build/VS2010/FlatBuffers.opensdf build/VS2010/ipch/**/*.ipch *.so Testing/Temporary +.cproject +.settings/ +.project diff -- git a/CMakeLists.txt b/CMakeLists.txt index affa05b..242a1b6 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -48,6 +48,7 @ @ set ( FlatBuffers_Compiler_SRCS src/idl_gen_python.cpp src/idl_gen_fbs.cpp src/idl_gen_grpc.cpp + src/idl_gen_ts.cpp src/flatc.cpp src/flatc_main.cpp grpc/src/compiler/schema_interface.h diff -- git a/include/flatbuffers/code_generators.h b/include/flatbuffers/code_generators.h index 16e368e..3e85df2 100644 -- - a/include/flatbuffers/code_generators.h +++ b/include/flatbuffers/code_generators.h @ @ -114,6 +114,8 @ @ class BaseGenerator { std : :string WrapInNameSpace ( const Definition & def ) const ; + std : :string GetNameSpace ( const Definition & def ) const ; + const Parser & parser_ ; const std : :string & path_ ; const std : :string & file_name_ ; diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index 5b7a72a..dabfb4f 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -357,6 +357,7 @ @ struct IDLOptions { bool allow_non_utf8 ; std : :string include_prefix ; bool binary_schema_comments ; + bool skip_flatbuffers_import ; // Possible options for the more general generator below . enum Language { @ @ -369,6 +370,7 @ @ struct IDLOptions { kPhp = 1 < < 6 , kJson = 1 < < 7 , kBinary = 1 <
diff -- git a/.gitignore b/.gitignore index 77a77b9..c6c3067 100755 -- - a/.gitignore +++ b/.gitignore @ @ -66,5 +66,8 @ @ build/VS2010/FlatBuffers.opensdf build/VS2010/ipch/**/*.ipch *.so Testing/Temporary +.cproject +.settings/ +.project net/**/obj - +node_modules/ diff -- git a/include/flatbuffers/code_generators.h b/include/flatbuffers/code_generators.h index 16e368e..3e85df2 100644 -- - a/include/flatbuffers/code_generators.h +++ b/include/flatbuffers/code_generators.h @ @ -114,6 +114,8 @ @ class BaseGenerator { std : :string WrapInNameSpace ( const Definition & def ) const ; + std : :string GetNameSpace ( const Definition & def ) const ; + const Parser & parser_ ; const std : :string & path_ ; const std : :string & file_name_ ; diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index deb1edf..9978d34 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -358,7 +358,9 @ @ struct IDLOptions { bool allow_non_utf8 ; std : :string include_prefix ; bool binary_schema_comments ; + bool skip_flatbuffers_import ; std : :string go_namespace ; + bool reexport_ts_modules ; // Possible options for the more general generator below . enum Language { @ @ -371,6 +373,7 @ @ struct IDLOptions { kPhp = 1 < < 6 , kJson = 1 < < 7 , kBinary = 1 < < 8 , + kTs = 1 < < 9 , kMAX } ; @ @ -400,6 +403,8
diff -- git a/java/com/google/flatbuffers/Table.java b/java/com/google/flatbuffers/Table.java index c426389..f5a8160 100644 -- - a/java/com/google/flatbuffers/Table.java +++ b/java/com/google/flatbuffers/Table.java @ @ -18,6 +18,7 @ @ package com.google.flatbuffers ; import static com.google.flatbuffers.Constants . * ; import java.nio.ByteBuffer ; +import java.nio.ByteOrder ; // All tables in the generated code derive from this class , and add their own accessors . public class Table { @ @ -46,7 +47,9 @ @ public class Table { if ( bb.hasArray ( ) ) { return new String ( bb.array ( ) , offset + SIZEOF_INT , bb.getInt ( offset ) , FlatBufferBuilder.utf8charset ) ; } else { - // We ca n't access .array ( ) , since the ByteBuffer is read-only . + // We ca n't access .array ( ) , since the ByteBuffer is read-only , + // off-heap or a memory map + ByteBuffer bb = this.bb.duplicate ( ) .order ( ByteOrder.LITTLE_ENDIAN ) ; // We 're forced to make an extra copy : byte [ ] copy = new byte [ bb.getInt ( offset ) ] ; int old_pos = bb.position ( ) ; @ @ -77,6 +80,9 @ @ public class Table { protected ByteBuffer __vector_as_bytebuffer ( int vector_offset , int elem_size ) { int
diff -- git a/include/flatbuffers/flatbuffers.h b/include/flatbuffers/flatbuffers.h index e830c44..351fc79 100644 -- - a/include/flatbuffers/flatbuffers.h +++ b/include/flatbuffers/flatbuffers.h @ @ -455,9 +455,9 @ @ struct String : public Vector < char > { // with custom allocation ( see the FlatBufferBuilder constructor ) . class simple_allocator { public : - virtual ~simple_allocator ( ) { } - virtual uint8_t *allocate ( size_t size ) const { return new uint8_t [ size ] ; } - virtual void deallocate ( uint8_t *p ) const { delete [ ] p ; } + virtual ~simple_allocator ( ) { } + virtual uint8_t *allocate ( size_t size ) { return new uint8_t [ size ] ; } + virtual void deallocate ( uint8_t *p ) { delete [ ] p ; } } ; // This is a minimal replication of std : :vector < uint8_t > functionality , @ @ -466,7 +466,7 @ @ class simple_allocator { class vector_downward { public : explicit vector_downward ( size_t initial_size , - const simple_allocator & allocator ) + simple_allocator & allocator ) : reserved_ ( initial_size ) , buf_ ( allocator.allocate ( reserved_ ) ) , cur_ ( buf_ + reserved_ ) , @ @ -489,12 +489,8 @ @ class
diff -- git a/build/Xcode/FlatBuffers.xcodeproj/project.pbxproj b/build/Xcode/FlatBuffers.xcodeproj/project.pbxproj index c30aa8d..ead87f8 100644 -- - a/build/Xcode/FlatBuffers.xcodeproj/project.pbxproj +++ b/build/Xcode/FlatBuffers.xcodeproj/project.pbxproj @ @ -338,6 +338,7 @ @ 02575EDE5A1349C9A3584E32 /* RelWithDebInfo */ = { isa = XCBuildConfiguration ; buildSettings = { + CONFIGURATION_BUILD_DIR = . ; ONLY_ACTIVE_ARCH = YES ; SDKROOT = /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.9.sdk ; SYMROOT = build ; @ @ -758,6 +759,7 @ @ 60917B4900A4484898ED29EF /* Debug */ = { isa = XCBuildConfiguration ; buildSettings = { + CONFIGURATION_BUILD_DIR = . ; ONLY_ACTIVE_ARCH = YES ; SDKROOT = /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.9.sdk ; SYMROOT = build ; @ @ -767,6 +769,7 @ @ 65B8F01CB7E6407CB262E6B6 /* Release */ = { isa = XCBuildConfiguration ; buildSettings = { + CONFIGURATION_BUILD_DIR = . ; ONLY_ACTIVE_ARCH = YES ; SDKROOT = /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.9.sdk ; SYMROOT = build ; @ @ -926,6 +929,7 @ @ C839EDC9489F432994623A13 /* MinSizeRel */ = { isa = XCBuildConfiguration ; buildSettings = { + CONFIGURATION_BUILD_DIR = . ; ONLY_ACTIVE_ARCH = YES ; SDKROOT = /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.9.sdk ; SYMROOT = build ; diff -- git a/build/Xcode/FlatBuffers.xcodeproj/project.xcworkspace/contents.xcworkspacedata b/build/Xcode/FlatBuffers.xcodeproj/project.xcworkspace/contents.xcworkspacedata deleted file mode 100644 index bcc0adb..0000000 -- - a/build/Xcode/FlatBuffers.xcodeproj/project.xcworkspace/contents.xcworkspacedata +++ /dev/null @ @ -1,7 +0,0 @ @ - < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > - < Workspace - version = ``
diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index 2781852..03ddb52 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -559,6 +559,10 @ @ private : const StructDef *parent_struct_def ) ; FLATBUFFERS_CHECKED_ERROR ParseTable ( const StructDef & struct_def , std : :string *value , uoffset_t *ovalue ) ; + FLATBUFFERS_CHECKED_ERROR ProcessTableFields ( size_t fieldn , + const StructDef & struct_def , + std : :string *value , + uoffset_t *ovalue ) ; void SerializeStruct ( const StructDef & struct_def , const Value & val ) ; void AddVector ( bool sortbysize , int count ) ; FLATBUFFERS_CHECKED_ERROR ParseVector ( const Type & type , uoffset_t *ovalue ) ; diff -- git a/src/idl_parser.cpp b/src/idl_parser.cpp index f03ad9a..1f96bae 100644 -- - a/src/idl_parser.cpp +++ b/src/idl_parser.cpp @ @ -853,17 +853,35 @ @ void Parser : :SerializeStruct ( const StructDef & struct_def , const Value & val ) { CheckedError Parser : :ParseTable ( const StructDef & struct_def , std : :string *value , uoffset_t *ovalue ) { - EXPECT ( ' { ' ) ; + // We allow tables both as JSON object { .. } with field names + // or vector [ .. ] with all fields in order + const bool is_nested_list = Is ( '
diff -- git a/CMakeLists.txt b/CMakeLists.txt index f0691dd..ec21fd8 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -157,3 +157,48 @ @ if ( FLATBUFFERS_BUILD_TESTS ) `` $ { CMAKE_CURRENT_BINARY_DIR } '' ) add_test ( NAME flattests COMMAND flattests ) endif ( ) + + # -- -- -- -- -- -- -- -- -- - Debianization -- -- -- -- -- -- -- -- -- -- - +if ( UNIX ) + + # Set build environment + SET ( CPACK_GENERATOR `` TGZ ; DEB '' ) + SET ( CPACK_SOURCE_TGZ `` ON '' ) + + # Common package information + SET ( CPACK_PACKAGE_DESCRIPTION_SUMMARY + `` FlatBuffers is an efficient cross platform serialization library for C++ , with support for Java , C # and Go . It was created at Google specifically for game development and other performance-critical applications . '' ) + SET ( CPACK_DEBIAN_PACKAGE_HOMEPAGE `` https : //github.com/google/flatbuffers '' ) + SET ( CPACK_DEBIAN_PACKAGE_MAINTAINER `` Vitaly Isaev < vitalyisaev2 @ gmail.com > '' ) + SET ( CPACK_DEBIAN_PACKAGE_ARCHITECTURE `` amd64 '' ) + + # Versioning + EXECUTE_PROCESS ( + COMMAND date + % Y % m % d + OUTPUT_VARIABLE DATE + OUTPUT_STRIP_TRAILING_WHITESPACE + ) + EXECUTE_PROCESS
diff -- git a/include/flatbuffers/base.h b/include/flatbuffers/base.h index f051755..38127f0 100644 -- - a/include/flatbuffers/base.h +++ b/include/flatbuffers/base.h @ @ -10,10 +10,10 @ @ # include < cstdlib > # include < cstring > # include < string > - # ifndef ARDUINO - # include < utility > - # else + # if defined ( ARDUINO ) & & ! defined ( ARDUINOSTL_M_H ) # include < utility.h > + # else + # include < utility > # endif # include < type_traits > # include < vector >
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 6dc73e7..8b58083 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -34,6 +34,7 @ @ set ( FlatBuffers_Compiler_SRCS src/idl_gen_general.cpp src/idl_gen_go.cpp src/idl_gen_js.cpp + src/idl_gen_kotlin.cpp src/idl_gen_php.cpp src/idl_gen_python.cpp src/idl_gen_fbs.cpp diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index 1ed360b..4f8589d 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -524,6 +524,12 @ @ extern bool GenerateJava ( const Parser & parser , const std : :string & path , const std : :string & file_name ) ; +// Generate Kotlin files from the definitions in the Parser object . +// See idl_gen_kotlin.cpp . +extern bool GenerateKotlin ( const Parser & parser , + const std : :string & path , + const std : :string & file_name ) ; + // Generate Php code from the definitions in the Parser object . // See idl_gen_php . extern bool GeneratePhp ( const Parser & parser , diff -- git a/include/flatbuffers/idl_gen_base.h b/include/flatbuffers/idl_gen_base.h new file mode 100644 index 0000000..595b57a -- - /dev/null +++ b/include/flatbuffers/idl_gen_base.h @ @ -0,0 +1,105 @ @ +/* + * Copyright 2014 Google Inc. All rights reserved . + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 6dc73e7..d733dbb 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -20,6 +20,7 @ @ set ( FlatBuffers_Library_SRCS include/flatbuffers/flatbuffers.h include/flatbuffers/hash.h include/flatbuffers/idl.h + include/flatbuffers/idl_gen_base_code_generator.h include/flatbuffers/util.h include/flatbuffers/reflection.h include/flatbuffers/reflection_generated.h @ @ -34,6 +35,7 @ @ set ( FlatBuffers_Compiler_SRCS src/idl_gen_general.cpp src/idl_gen_go.cpp src/idl_gen_js.cpp + src/idl_gen_kotlin.cpp src/idl_gen_php.cpp src/idl_gen_python.cpp src/idl_gen_fbs.cpp diff -- git a/include/flatbuffers/idl.h b/include/flatbuffers/idl.h index 1ed360b..4f8589d 100644 -- - a/include/flatbuffers/idl.h +++ b/include/flatbuffers/idl.h @ @ -524,6 +524,12 @ @ extern bool GenerateJava ( const Parser & parser , const std : :string & path , const std : :string & file_name ) ; +// Generate Kotlin files from the definitions in the Parser object . +// See idl_gen_kotlin.cpp . +extern bool GenerateKotlin ( const Parser & parser , + const std : :string & path , + const std : :string & file_name ) ; + // Generate Php code from the definitions in the Parser object . // See idl_gen_php . extern bool GeneratePhp ( const Parser & parser , diff -- git a/include/flatbuffers/idl_gen_base_code_generator.h b/include/flatbuffers/idl_gen_base_code_generator.h new file mode 100644 index 0000000..6988902 -- - /dev/null +++ b/include/flatbuffers/idl_gen_base_code_generator.h @ @ -0,0 +1,211 @ @ +/* + * Copyright 2014 Google Inc. All rights reserved . + * + * Licensed under the Apache License
diff -- git a/src/idl_parser.cpp b/src/idl_parser.cpp index 2cce519..858f9f8 100644 -- - a/src/idl_parser.cpp +++ b/src/idl_parser.cpp @ @ -914,6 +914,10 @ @ CheckedError Parser : :ParseTable ( const StructDef & struct_def , std : :string *value , size_t fieldn = 0 ; auto err = ParseTableDelimiters ( fieldn , & struct_def , [ & ] ( const std : :string & name ) - > CheckedError { + if ( name == `` $ schema '' ) { + NEXT ( ) ; // Ignore this field . + return NoError ( ) ; + } auto field = struct_def.fields.Lookup ( name ) ; if ( ! field ) { if ( ! opts.skip_unexpected_fields_in_json ) {
diff -- git a/CONTRIBUTING.md b/CONTRIBUTING.md new file mode 100644 index 0000000..aebd885 -- - /dev/null +++ b/CONTRIBUTING.md @ @ -0,0 +1,28 @ @ +Contributing { # contributing } +============ + +Want to contribute ? Great ! First , read this page ( including the small print at +the end ) . + + # Before you contribute +Before we can use your code , you must sign the + [ Google Individual Contributor License Agreement ] ( https : //developers.google.com/open-source/cla/individual ? csw=1 ) + ( CLA ) , which you can do online . The CLA is necessary mainly because you own the +copyright to your changes , even after your contribution becomes part of our +codebase , so we need your permission to use and distribute your code . We also +need to be sure of various other things—for instance that you 'll tell us if you +know that your code infringes on other people 's patents . You do n't have to sign +the CLA until after you 've submitted your code for review and a member has +approved it , but you must do it before we can put your code into our codebase . +Before you start
diff -- git a/.gitignore b/.gitignore index c6bcf20..dd94593 100755 -- - a/.gitignore +++ b/.gitignore @ @ -33,4 +33,4 @ @ flattests flatsamplebinary flatsampletext snapshot.sh - +tests/go_gen diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2fa4160..fc0363a 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -12,6 +12,7 @ @ set ( FlatBuffers_Compiler_SRCS src/idl_parser.cpp src/idl_gen_cpp.cpp src/idl_gen_java.cpp + src/idl_gen_go.cpp src/idl_gen_text.cpp src/flatc.cpp ) diff -- git a/docs/html/md__go_usage.html b/docs/html/md__go_usage.html new file mode 100644 index 0000000..8d0f6f4 -- - /dev/null +++ b/docs/html/md__go_usage.html @ @ -0,0 +1,106 @ @ + < ! DOCTYPE html PUBLIC `` -//W3C//DTD XHTML 1.0 Transitional//EN '' `` http : //www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd '' > + < html xmlns= '' http : //www.w3.org/1999/xhtml '' > + < head > + < meta http-equiv= '' Content-Type '' content= '' text/xhtml ; charset=UTF-8 '' / > + < meta http-equiv= '' X-UA-Compatible '' content= '' IE=9 '' / > + < meta name= '' generator '' content= '' Doxygen 1.8.7 '' / > + < title > FlatBuffers : Use in Go < /title > + < link href= '' tabs.css '' rel= '' stylesheet '' type= '' text/css '' / > + < script type= '' text/javascript '' src= '' jquery.js '' > < /script > + < script type= ''
diff -- git a/src/idl_gen_rust.cpp b/src/idl_gen_rust.cpp index 38773e4..686d882 100644 -- - a/src/idl_gen_rust.cpp +++ b/src/idl_gen_rust.cpp @ @ -36,7 +36,7 @ @ std : :string MakeSnakeCase ( const std : :string & in ) { if ( islower ( in [ i ] ) ) { s += static_cast < char > ( in [ i ] ) ; } else { - if ( i > 0 ) { + if ( i > 0 & & in [ i ] ! = '_ ' ) { s += '_ ' ; } s += static_cast < char > ( tolower ( in [ i ] ) ) ;
diff -- git a/src/cycleclock.h b/src/cycleclock.h index ca26cca..d3fa837 100644 -- - a/src/cycleclock.h +++ b/src/cycleclock.h @ @ -45,6 +45,10 @ @ extern `` C '' uint64_t __rdtsc ( ) ; # include < sys/time.h > # endif + # if defined ( __pnacl__ ) + # include < time.h > + # endif + namespace benchmark { // NOTE : only i386 and x86_64 have been well tested . // PPC , sparc , alpha , and ia64 are based on @ @ -132,6 +136,14 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { struct timeval tv ; gettimeofday ( & tv , nullptr ) ; return static_cast < int64_t > ( tv.tv_sec ) * 1000000 + tv.tv_usec ; + # elif defined ( __pnacl__ ) + // Portable Native Client compiles to architecture-agnostic bytecode , + // and does not provide any API to access cycle counter . + + // Initialize to always return if clock_gettime fails + struct timespec ts = { 0 , 0 } ; + clock_gettime ( CLOCK_MONOTONIC , & ts ) ; + return static_cast < int64_t > ( ts.tv_sec ) * 1000000000 + ts.tv_nsec ; # else // The soft failover to a generic
diff -- git a/src/CMakeLists.txt b/src/CMakeLists.txt index 7707773..244484b 100644 -- - a/src/CMakeLists.txt +++ b/src/CMakeLists.txt @ @ -18,6 +18,9 @ @ set_target_properties ( benchmark PROPERTIES VERSION $ { GENERIC_LIB_VERSION } SOVERSION $ { GENERIC_LIB_SOVERSION } ) +target_include_directories ( benchmark PUBLIC + $ < BUILD_INTERFACE : $ { CMAKE_CURRENT_SOURCE_DIR } /../include > + ) # Link threads . target_link_libraries ( benchmark $ { BENCHMARK_CXX_LIBRARIES } $ { CMAKE_THREAD_LIBS_INIT } )
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index b3b0a8e..fc448e6 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -11,11 +11,1199 @ @ // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . // See the License for the specific language governing permissions and // limitations under the License . + +// Support for registering benchmarks for functions . + +/* Example usage : +// Define a function that executes the code to be measured a +// specified number of times : +static void BM_StringCreation ( benchmark : :State & state ) { + while ( state.KeepRunning ( ) ) + std : :string empty_string ; + } + +// Register the function as a benchmark +BENCHMARK ( BM_StringCreation ) ; + +// Define another benchmark +static void BM_StringCopy ( benchmark : :State & state ) { + std : :string x = `` hello '' ; + while ( state.KeepRunning ( ) ) + std : :string copy ( x ) ; + } +BENCHMARK ( BM_StringCopy ) ; + +// Augment the main ( ) program to invoke benchmarks if specified +// via the -- benchmarks command line flag . E.g. , +// my_unittest -- benchmark_filter=all +// my_unittest
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..915702e 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..456b0a6 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,65 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -228,6 +235,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..68c1ee2 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..90fd5c4 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..35f594a 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/src/complexity.cc b/src/complexity.cc index a4c57c4..24b3ed4 100644 -- - a/src/complexity.cc +++ b/src/complexity.cc @ @ -194,16 +194,16 @ @ std : :vector < BenchmarkReporter : :Run > ComputeStats ( CHECK_EQ ( run_iterations , run.iterations ) ; if ( run.error_occurred ) continue ; real_accumulated_time_stat += - Stat1_d ( run.real_accumulated_time / run.iterations , run.iterations ) ; + Stat1_d ( run.real_accumulated_time / run.iterations ) ; cpu_accumulated_time_stat += - Stat1_d ( run.cpu_accumulated_time / run.iterations , run.iterations ) ; - items_per_second_stat += Stat1_d ( run.items_per_second , run.iterations ) ; - bytes_per_second_stat += Stat1_d ( run.bytes_per_second , run.iterations ) ; + Stat1_d ( run.cpu_accumulated_time / run.iterations ) ; + items_per_second_stat += Stat1_d ( run.items_per_second ) ; + bytes_per_second_stat += Stat1_d ( run.bytes_per_second ) ; // user counters for ( auto const & cnt : run.counters ) { auto it = counter_stats.find ( cnt.first ) ; CHECK_NE ( it , counter_stats.end ( ) ) ; - it- > second.s += Stat1_d ( cnt.second , run.iterations ) ; + it- > second.s += Stat1_d ( cnt.second ) ; } } diff -- git a/src/stat.h b/src/stat.h index 136c3aa..0a0e87a 100644 -- - a/src/stat.h +++ b/src/stat.h @ @ -119,18 +119,23 @ @ class Stat1 { if ( numsamples_ == 0 )
diff -- git a/tools/gbench/Inputs/test1_run1.json b/tools/gbench/Inputs/test1_run1.json index 3d70592..d7ec6a9 100644 -- - a/tools/gbench/Inputs/test1_run1.json +++ b/tools/gbench/Inputs/test1_run1.json @ @ -78,6 +78,20 @ @ `` time_unit '' : `` ns '' } , { + `` name '' : `` BM_ThirdFaster '' , + `` iterations '' : 1000 , + `` real_time '' : 100 , + `` cpu_time '' : 100 , + `` time_unit '' : `` ns '' + } , + { + `` name '' : `` BM_BadTimeUnit '' , + `` iterations '' : 1000 , + `` real_time '' : 0.4 , + `` cpu_time '' : 0.5 , + `` time_unit '' : `` s '' + } , + { `` name '' : `` BM_DifferentTimeUnit '' , `` iterations '' : 1 , `` real_time '' : 1 , diff -- git a/tools/gbench/Inputs/test1_run2.json b/tools/gbench/Inputs/test1_run2.json index f078d5f..59a5ffa 100644 -- - a/tools/gbench/Inputs/test1_run2.json +++ b/tools/gbench/Inputs/test1_run2.json @ @ -78,6 +78,20 @ @ `` time_unit '' : `` ns '' } , { + `` name '' : `` BM_ThirdFaster '' , + `` iterations '' : 1000 , + `` real_time '' : 66.665 , + `` cpu_time '' : 66.664 , + `` time_unit '' : ``
diff -- git a/src/cycleclock.h b/src/cycleclock.h index ca26cca..e0f9b01 100644 -- - a/src/cycleclock.h +++ b/src/cycleclock.h @ @ -43,6 +43,11 @ @ extern `` C '' uint64_t __rdtsc ( ) ; # ifndef BENCHMARK_OS_WINDOWS # include < sys/time.h > + # include < time.h > + # endif + + # ifdef BENCHMARK_OS_EMSCRIPTEN + # include < emscripten.h > # endif namespace benchmark { @ @ -65,6 +70,10 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { // counter pauses ; it does not continue counting , nor does it // reset to zero . return mach_absolute_time ( ) ; + # elif defined ( BENCHMARK_OS_EMSCRIPTEN ) + // this goes above x86-specific code because old versions of Emscripten + // define __x86_64__ , although they have nothing to do with it . + return static_cast < int64_t > ( emscripten_get_now ( ) * 1e+6 ) ; # elif defined ( __i386__ ) int64_t ret ; __asm__ volatile ( `` rdtsc '' : `` =A '' ( ret ) ) ; @ @ -99,6 +108,22 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { _asm rdtsc # elif defined ( COMPILER_MSVC ) return __rdtsc ( ) ; + # elif defined ( BENCHMARK_OS_NACL
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 28baa58..754fb87 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -168,6 +168,9 @ @ class BenchmarkReporter ; void Initialize ( int* argc , char** argv ) ; +// Report to stdout all arguments in 'argv ' as unrecognized except the first . +void ReportUnrecognizedArguments ( int argc , char** argv ) ; + // Generate a list of benchmarks matching the specified -- benchmark_filter flag // and if -- benchmark_list_tests is specified return after printing the name // of each matching benchmark . Otherwise run each matching benchmark and @ @ -858,6 +861,10 @ @ class Fixture : public internal : :Benchmark { # define BENCHMARK_MAIN ( ) \ int main ( int argc , char** argv ) { \ : :benchmark : :Initialize ( & argc , argv ) ; \ + if ( argc > 1 ) { \ + : :benchmark : :ReportUnrecognizedArguments ( argc , argv ) ; \ + return 1 ; \ + } \ : :benchmark : :RunSpecifiedBenchmarks ( ) ; \ } diff -- git a/src/benchmark.cc b/src/benchmark.cc index 95f6a25..0374ec8 100644 -- - a/src/benchmark.cc +++ b/src/benchmark.cc @ @ -664,4 +664,10 @ @ void Initialize ( int* argc ,
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 2ded481..5cc302f 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -223,6 +230,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -228,6 +235,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..98d2be2 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..90fd5c4 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..35f594a 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..35f594a 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..456b0a6 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,65 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -228,6 +235,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..f681078 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..98dca3d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2526faf..4296b23 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -44,6 +44,10 @ @ add_cxx_compiler_flag ( -pedantic-errors ) add_cxx_compiler_flag ( -fno-strict-aliasing RELEASE ) add_cxx_compiler_flag ( -Wthread-safety ) +if ( HAVE_WTHREAD_SAFETY ) + add_definitions ( -DHAVE_WTHREAD_SAFETY ) + cxx_feature_check ( THREAD_SAFETY_ATTRIBUTES ) +endif ( ) # C++ feature checks cxx_feature_check ( STD_REGEX ) diff -- git a/cmake/thread_safety_attributes.cpp b/cmake/thread_safety_attributes.cpp new file mode 100644 index 0000000..46161ba -- - /dev/null +++ b/cmake/thread_safety_attributes.cpp @ @ -0,0 +1,4 @ @ + # define HAVE_THREAD_SAFETY_ATTRIBUTES + # include `` ../src/mutex.h '' + +int main ( ) { } diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 2532454..292ffc2 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -1,386 +1,48 @ @ -// Support for registering benchmarks for functions . - -/* Example usage : -// Define a function that executes the code to be measured a -// specified number of times : -static void BM_StringCreation ( benchmark : :State & state ) { - while ( state.KeepRunning ( ) ) - std : :string empty_string ; - } +// Copyright 2015 Google Inc. All rights reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2526faf..4296b23 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -44,6 +44,10 @ @ add_cxx_compiler_flag ( -pedantic-errors ) add_cxx_compiler_flag ( -fno-strict-aliasing RELEASE ) add_cxx_compiler_flag ( -Wthread-safety ) +if ( HAVE_WTHREAD_SAFETY ) + add_definitions ( -DHAVE_WTHREAD_SAFETY ) + cxx_feature_check ( THREAD_SAFETY_ATTRIBUTES ) +endif ( ) # C++ feature checks cxx_feature_check ( STD_REGEX ) diff -- git a/cmake/thread_safety_attributes.cpp b/cmake/thread_safety_attributes.cpp new file mode 100644 index 0000000..46161ba -- - /dev/null +++ b/cmake/thread_safety_attributes.cpp @ @ -0,0 +1,4 @ @ + # define HAVE_THREAD_SAFETY_ATTRIBUTES + # include `` ../src/mutex.h '' + +int main ( ) { } diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 2532454..0597f20 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -135,7 +135,8 @ @ BENCHMARK ( BM_MultiThreaded ) - > Threads ( 4 ) ; # ifndef BENCHMARK_BENCHMARK_H_ # define BENCHMARK_BENCHMARK_H_ - # include < stdint.h > + # include < cassert > + # include < cstdint > # include < functional > # include < memory > @ @ -153,14 +154,18 @ @ void Initialize ( int* argc , const char** argv ) ; // Otherwise , run all benchmarks specified by the -- benchmark_filter flag , // and exit after running the benchmarks . -void RunSpecifiedBenchmarks
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index d529e4b..f4e8762 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -433,7 +433,7 @ @ class State { if ( BENCHMARK_BUILTIN_EXPECT ( ! started_ , false ) ) { StartKeepRunning ( ) ; } - bool const res = -- total_iterations_ ; + bool const res = ( -- total_iterations_ ! = 0 ) ; if ( BENCHMARK_BUILTIN_EXPECT ( ! res , false ) ) { FinishKeepRunning ( ) ; }
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2526faf..4296b23 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -44,6 +44,10 @ @ add_cxx_compiler_flag ( -pedantic-errors ) add_cxx_compiler_flag ( -fno-strict-aliasing RELEASE ) add_cxx_compiler_flag ( -Wthread-safety ) +if ( HAVE_WTHREAD_SAFETY ) + add_definitions ( -DHAVE_WTHREAD_SAFETY ) + cxx_feature_check ( THREAD_SAFETY_ATTRIBUTES ) +endif ( ) # C++ feature checks cxx_feature_check ( STD_REGEX ) diff -- git a/cmake/thread_safety_attributes.cpp b/cmake/thread_safety_attributes.cpp new file mode 100644 index 0000000..46161ba -- - /dev/null +++ b/cmake/thread_safety_attributes.cpp @ @ -0,0 +1,4 @ @ + # define HAVE_THREAD_SAFETY_ATTRIBUTES + # include `` ../src/mutex.h '' + +int main ( ) { } diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 2532454..ac88929 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -135,7 +135,8 @ @ BENCHMARK ( BM_MultiThreaded ) - > Threads ( 4 ) ; # ifndef BENCHMARK_BENCHMARK_H_ # define BENCHMARK_BENCHMARK_H_ - # include < stdint.h > + # include < cassert > + # include < cstdint > # include < functional > # include < memory > @ @ -153,14 +154,18 @ @ void Initialize ( int* argc , const char** argv ) ; // Otherwise , run all benchmarks specified by the -- benchmark_filter flag , // and exit after running the benchmarks . -void RunSpecifiedBenchmarks
diff -- git a/README.md b/README.md index 2f2d78f..37c6268 100644 -- - a/README.md +++ b/README.md @ @ -545,12 +545,19 @ @ The number of runs of each benchmark is specified globally by the ` Repetitions ` on the registered benchmark object . When a benchmark is run more than once the mean , median and standard deviation of the runs will be reported . -Additionally the ` -- benchmark_report_aggregates_only= { true|false } ` flag or - ` ReportAggregatesOnly ( bool ) ` function can be used to change how repeated tests -are reported . By default the result of each repeated run is reported . When this -option is ` true ` only the mean , median and standard deviation of the runs is reported . -Calling ` ReportAggregatesOnly ( bool ) ` on a registered benchmark object overrides -the value of the flag for that benchmark . +Additionally the ` -- benchmark_report_aggregates_only= { true|false } ` , ` -- benchmark_display_aggregates_only= { true|false } ` flags or + ` ReportAggregatesOnly ( bool ) ` , ` DisplayAggregatesOnly ( bool ) ` functions can be +used to change how repeated tests are reported . By default the result of each +repeated run is
diff -- git a/src/cycleclock.h b/src/cycleclock.h index ca26cca..e0f9b01 100644 -- - a/src/cycleclock.h +++ b/src/cycleclock.h @ @ -43,6 +43,11 @ @ extern `` C '' uint64_t __rdtsc ( ) ; # ifndef BENCHMARK_OS_WINDOWS # include < sys/time.h > + # include < time.h > + # endif + + # ifdef BENCHMARK_OS_EMSCRIPTEN + # include < emscripten.h > # endif namespace benchmark { @ @ -65,6 +70,10 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { // counter pauses ; it does not continue counting , nor does it // reset to zero . return mach_absolute_time ( ) ; + # elif defined ( BENCHMARK_OS_EMSCRIPTEN ) + // this goes above x86-specific code because old versions of Emscripten + // define __x86_64__ , although they have nothing to do with it . + return static_cast < int64_t > ( emscripten_get_now ( ) * 1e+6 ) ; # elif defined ( __i386__ ) int64_t ret ; __asm__ volatile ( `` rdtsc '' : `` =A '' ( ret ) ) ; @ @ -99,6 +108,22 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { _asm rdtsc # elif defined ( COMPILER_MSVC ) return __rdtsc ( ) ; + # elif defined ( BENCHMARK_OS_NACL
diff -- git a/src/CMakeLists.txt b/src/CMakeLists.txt index 7707773..244484b 100644 -- - a/src/CMakeLists.txt +++ b/src/CMakeLists.txt @ @ -18,6 +18,9 @ @ set_target_properties ( benchmark PROPERTIES VERSION $ { GENERIC_LIB_VERSION } SOVERSION $ { GENERIC_LIB_SOVERSION } ) +target_include_directories ( benchmark PUBLIC + $ < BUILD_INTERFACE : $ { CMAKE_CURRENT_SOURCE_DIR } /../include > + ) # Link threads . target_link_libraries ( benchmark $ { BENCHMARK_CXX_LIBRARIES } $ { CMAKE_THREAD_LIBS_INIT } )
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..5fa34c9 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,6 +23,18 @ @ matrix : - compiler : gcc addons : apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + addons : + apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc +
diff -- git a/src/internal_macros.h b/src/internal_macros.h index 46913f4..2b3f32f 100644 -- - a/src/internal_macros.h +++ b/src/internal_macros.h @ @ -30,9 +30,13 @ @ # elif defined ( _WIN32 ) # define BENCHMARK_OS_WINDOWS 1 # elif defined ( __APPLE__ ) -// TODO ( ericwf ) This does n't actually check that it is a Mac OSX system . Just -// that it is an apple system . - # define BENCHMARK_OS_MACOSX 1 + # include `` TargetConditionals.h '' + # if defined ( TARGET_OS_MAC ) + # define BENCHMARK_OS_MACOSX 1 + # if defined ( TARGET_OS_IPHONE ) + # define BENCHMARK_OS_IOS 1 + # endif + # endif # elif defined ( __FreeBSD__ ) # define BENCHMARK_OS_FREEBSD 1 # elif defined ( __linux__ ) diff -- git a/src/sysinfo.cc b/src/sysinfo.cc index dd1e663..34f9871 100644 -- - a/src/sysinfo.cc +++ b/src/sysinfo.cc @ @ -295,8 +295,13 @ @ void InitializeSystemInfo ( ) { ( size == sizeof ( cpu_freq ) ) ) { cpuinfo_cycles_per_second = cpu_freq ; } else { + # if defined BENCHMARK_OS_IOS + fprintf ( stderr , `` CPU frequency can not be detected . \n '' ) ; + cpuinfo_cycles_per_second = 0 ; + # else fprintf ( stderr , `` % s\n '' , strerror
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..f681078 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/src/complexity.cc b/src/complexity.cc index a4c57c4..24b3ed4 100644 -- - a/src/complexity.cc +++ b/src/complexity.cc @ @ -194,16 +194,16 @ @ std : :vector < BenchmarkReporter : :Run > ComputeStats ( CHECK_EQ ( run_iterations , run.iterations ) ; if ( run.error_occurred ) continue ; real_accumulated_time_stat += - Stat1_d ( run.real_accumulated_time / run.iterations , run.iterations ) ; + Stat1_d ( run.real_accumulated_time / run.iterations ) ; cpu_accumulated_time_stat += - Stat1_d ( run.cpu_accumulated_time / run.iterations , run.iterations ) ; - items_per_second_stat += Stat1_d ( run.items_per_second , run.iterations ) ; - bytes_per_second_stat += Stat1_d ( run.bytes_per_second , run.iterations ) ; + Stat1_d ( run.cpu_accumulated_time / run.iterations ) ; + items_per_second_stat += Stat1_d ( run.items_per_second ) ; + bytes_per_second_stat += Stat1_d ( run.bytes_per_second ) ; // user counters for ( auto const & cnt : run.counters ) { auto it = counter_stats.find ( cnt.first ) ; CHECK_NE ( it , counter_stats.end ( ) ) ; - it- > second.s += Stat1_d ( cnt.second , run.iterations ) ; + it- > second.s += Stat1_d ( cnt.second ) ; } } diff -- git a/src/stat.h b/src/stat.h index 136c3aa..0a0e87a 100644 -- - a/src/stat.h +++ b/src/stat.h @ @ -119,18 +119,23 @ @ class Stat1 { if ( numsamples_ == 0 )
diff -- git a/AUTHORS b/AUTHORS index c4b059d..49f500f 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -32,6 +32,7 @ @ Oleksandr Sochka < sasha.sochka @ gmail.com > Paul Redmond < paul.redmond @ gmail.com > Radoslav Yovchev < radoslav.tm @ gmail.com > Shuo Chen < chenshuo @ chenshuo.com > +Yixuan Qiu < yixuanq @ gmail.com > Yusuke Suzuki < utatane.tea @ gmail.com > Dirac Research Zbigniew Skowron < zbychs @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 8ca4565..c0c0292 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -50,6 +50,7 @ @ Pierre Phaneuf < pphaneuf @ google.com > Radoslav Yovchev < radoslav.tm @ gmail.com > Ray Glover < ray.glover @ uk.ibm.com > Shuo Chen < chenshuo @ chenshuo.com > +Yixuan Qiu < yixuanq @ gmail.com > Yusuke Suzuki < utatane.tea @ gmail.com > Tobias Ulvgård < tobias.ulvgard @ dirac.se > Zbigniew Skowron < zbychs @ gmail.com > diff -- git a/src/complexity.cc b/src/complexity.cc index a4c57c4..24b3ed4 100644 -- - a/src/complexity.cc +++ b/src/complexity.cc @ @ -194,16 +194,16 @ @ std : :vector < BenchmarkReporter : :Run > ComputeStats ( CHECK_EQ ( run_iterations , run.iterations ) ; if ( run.error_occurred ) continue ; real_accumulated_time_stat += - Stat1_d ( run.real_accumulated_time / run.iterations , run.iterations ) ; +
diff -- git a/AUTHORS b/AUTHORS index 8c15b87..35019e6 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. +International Business Machines Corporation Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 96cd15a..2cd3990 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -47,6 +47,7 @ @ Pascal Leroy < phl @ google.com > Paul Redmond < paul.redmond @ gmail.com > Pierre Phaneuf < pphaneuf @ google.com > Radoslav Yovchev < radoslav.tm @ gmail.com > +Ray Glover < ray.glover @ uk.ibm.com > Shuo Chen < chenshuo @ chenshuo.com > Yusuke Suzuki < utatane.tea @ gmail.com > Tobias Ulvgård < tobias.ulvgard @ dirac.se > diff -- git a/tools/compare_bench.py b/tools/compare_bench.py index 8a7e799..d54baaa 100755 -- - a/tools/compare_bench.py +++ b/tools/compare_bench.py @ @ -59,7 +59,7 @ @ def main ( ) : json1 = gbench.util.run_or_load_benchmark ( test1 , benchmark_options ) json2 = gbench.util.run_or_load_benchmark ( test2 , benchmark_options ) output_lines = gbench.report.generate_difference_report ( json1 , json2 ) - print 'Comparing % s to % s
diff -- git a/src/benchmark_register.cc b/src/benchmark_register.cc index cf78bbf..7227356 100644 -- - a/src/benchmark_register.cc +++ b/src/benchmark_register.cc @ @ -31,6 +31,7 @ @ # include < fstream > # include < iostream > # include < memory > + # include < sstream > # include < thread > # include `` check.h '' @ @ -162,8 +163,15 @ @ bool BenchmarkFamilies : :FindBenchmarks ( StringPrintF ( `` % s : '' , family- > arg_names_ [ arg_i ] .c_str ( ) ) ; } } - + + # ifdef __ANDROID__ + // workaround for Android , http : //stackoverflow.com/questions/22774009/android-ndk-stdto-string-support + std : :ostringstream ss ; + ss < < arg ; + instance.name += ss.str ( ) ; + # else instance.name += std : :to_string ( arg ) ; + # endif ++arg_i ; } diff -- git a/src/colorprint.cc b/src/colorprint.cc index 513376b..d2f82fe 100644 -- - a/src/colorprint.cc +++ b/src/colorprint.cc @ @ -89,7 +89,11 @ @ std : :string FormatString ( const char* msg , va_list args ) { std : :size_t size = 256 ; char local_buff [ 256 ] ; + # ifdef __ANDROID__ + auto ret = : :vsnprintf ( local_buff , size , msg , args_cp ) ; +
diff -- git a/CMakeLists.txt b/CMakeLists.txt index 356994a..f7f1566 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -5,7 +5,6 @ @ project ( benchmark ) foreach ( p CMP0054 # CMake 3.1 CMP0056 # export EXE_LINKER_FLAGS to try_run - CMP0063 # CMake 3.3 - honour symbol visability for static libraries ) if ( POLICY $ { p } ) cmake_policy ( SET $ { p } NEW )
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -228,6 +235,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..9f9ca91 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..35f594a 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/src/sysinfo.cc b/src/sysinfo.cc index 34f9871..7feb79e 100644 -- - a/src/sysinfo.cc +++ b/src/sysinfo.cc @ @ -75,7 +75,9 @ @ bool ReadIntFromFile ( const char* file , long* value ) { char line [ 1024 ] ; char* err ; memset ( line , '\0 ' , sizeof ( line ) ) ; - CHECK ( read ( fd , line , sizeof ( line ) - 1 ) ) ; + ssize_t read_err = read ( fd , line , sizeof ( line ) - 1 ) ; + ( ( void ) read_err ) ; // prevent unused warning + CHECK ( read_err > = 0 ) ; const long temp_value = strtol ( line , & err , 10 ) ; if ( line [ 0 ] ! = '\0 ' & & ( *err == '\n ' || *err == '\0 ' ) ) { *value = temp_value ;
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 1e853e2..9b123f1 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -231,7 +231,13 @ @ BENCHMARK_UNUSED static int stream_init_anchor = InitializeStreams ( ) ; # ifndef BENCHMARK_HAS_NO_INLINE_ASSEMBLY template < class Tp > inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { + // Clang does n't like the 'X ' constraint on ` value ` and certain GCC versions + // do n't like the 'g ' constraint . Attempt to placate them both . + # if defined ( __clang__ ) asm volatile ( `` '' : : `` g '' ( value ) : `` memory '' ) ; + # else + asm volatile ( `` '' : : `` X '' ( value ) : `` memory '' ) ; + # endif } // Force the compiler to flush pending writes to global memory . Acts as an // effective read/write barrier diff -- git a/test/CMakeLists.txt b/test/CMakeLists.txt index d89135a..93c0025 100644 -- - a/test/CMakeLists.txt +++ b/test/CMakeLists.txt @ @ -1,6 +1,7 @ @ # Enable the tests find_package ( Threads REQUIRED ) +include ( CheckCXXCompilerFlag ) # NOTE : Some tests use ` < cassert > ` to perform the test
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..a591743 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,18 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF & & echo disabling 32 bit build +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLLVM_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..6bbd13b 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,6 +23,18 @ @ matrix : - compiler : gcc addons : apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + addons : + apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc +
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -228,6 +235,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..40dfd50 100644 -- - a/README.md +++ b/README.md @ @ -393,6 +393,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..456b0a6 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,65 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/src/cycleclock.h b/src/cycleclock.h index ca26cca..d3fa837 100644 -- - a/src/cycleclock.h +++ b/src/cycleclock.h @ @ -45,6 +45,10 @ @ extern `` C '' uint64_t __rdtsc ( ) ; # include < sys/time.h > # endif + # if defined ( __pnacl__ ) + # include < time.h > + # endif + namespace benchmark { // NOTE : only i386 and x86_64 have been well tested . // PPC , sparc , alpha , and ia64 are based on @ @ -132,6 +136,14 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { struct timeval tv ; gettimeofday ( & tv , nullptr ) ; return static_cast < int64_t > ( tv.tv_sec ) * 1000000 + tv.tv_usec ; + # elif defined ( __pnacl__ ) + // Portable Native Client compiles to architecture-agnostic bytecode , + // and does not provide any API to access cycle counter . + + // Initialize to always return if clock_gettime fails + struct timespec ts = { 0 , 0 } ; + clock_gettime ( CLOCK_MONOTONIC , & ts ) ; + return static_cast < int64_t > ( ts.tv_sec ) * 1000000000 + ts.tv_nsec ; # else // The soft failover to a generic
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 8cde61b..1e853e2 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -577,9 +577,17 @ @ class Benchmark { // Set the minimum amount of time to use when running this benchmark . This // option overrides the ` benchmark_min_time ` flag . - // REQUIRES : ` t > 0 ` + // REQUIRES : ` t > 0 ` and ` Iterations ` has not been called on this benchmark . Benchmark* MinTime ( double t ) ; + // Specify the amount of iterations that should be run by this benchmark . + // REQUIRES : 'n > 0 ' and ` MinTime ` has not been called on this benchmark . + // + // NOTE : This function should only be used when *exact* iteration control is + // needed and never to control or limit how long a benchmark runs , where + // ` -- benchmark_min_time=N ` or ` MinTime ( ... ) ` should be used instead . + Benchmark* Iterations ( size_t n ) ; + // Specify the amount of times to repeat this benchmark . This option overrides // the ` benchmark_repetitions ` flag . //
diff -- git a/AUTHORS b/AUTHORS index 8c15b87..35019e6 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. +International Business Machines Corporation Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 96cd15a..2cd3990 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -47,6 +47,7 @ @ Pascal Leroy < phl @ google.com > Paul Redmond < paul.redmond @ gmail.com > Pierre Phaneuf < pphaneuf @ google.com > Radoslav Yovchev < radoslav.tm @ gmail.com > +Ray Glover < ray.glover @ uk.ibm.com > Shuo Chen < chenshuo @ chenshuo.com > Yusuke Suzuki < utatane.tea @ gmail.com > Tobias Ulvgård < tobias.ulvgard @ dirac.se > diff -- git a/tools/compare_bench.py b/tools/compare_bench.py index 8a7e799..d54baaa 100755 -- - a/tools/compare_bench.py +++ b/tools/compare_bench.py @ @ -59,7 +59,7 @ @ def main ( ) : json1 = gbench.util.run_or_load_benchmark ( test1 , benchmark_options ) json2 = gbench.util.run_or_load_benchmark ( test2 , benchmark_options ) output_lines = gbench.report.generate_difference_report ( json1 , json2 ) - print 'Comparing % s to % s
diff -- git a/src/CMakeLists.txt b/src/CMakeLists.txt index d517b3c..7707773 100644 -- - a/src/CMakeLists.txt +++ b/src/CMakeLists.txt @ @ -49,7 +49,7 @ @ write_basic_package_version_file ( `` $ { version_config } '' VERSION $ { GIT_VERSION } COMPATIBILITY SameMajorVersion ) -configure_file ( `` $ { CMAKE_SOURCE_DIR } /cmake/Config.cmake.in '' `` $ { project_config } '' @ ONLY ) +configure_file ( `` $ { PROJECT_SOURCE_DIR } /cmake/Config.cmake.in '' `` $ { project_config } '' @ ONLY ) # Install target ( will install the library to specified CMAKE_INSTALL_PREFIX variable ) install (
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -228,6 +235,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..9f9ca91 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..90fd5c4 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..90fd5c4 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9109430..1b14138 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 8c15b87..391434c 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -25,6 +25,7 @ @ Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > Lei Xu < eddyxu @ gmail.com > Matt Clarkson < mattyclarkson @ gmail.com > +Maxim Vafin < maxvafin @ gmail.com > Nick Hutchinson < nshutchinson @ gmail.com > Oleksandr Sochka < sasha.sochka @ gmail.com > Paul Redmond < paul.redmond @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 96cd15a..0f7f6ed 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -41,6 +41,7 @ @ Kaito Udagawa < umireon @ gmail.com > Kai Wolf < kai.wolf @ gmail.com > Lei Xu < eddyxu @ gmail.com > Matt Clarkson < mattyclarkson @ gmail.com > +Maxim Vafin < maxvafin @ gmail.com > Nick Hutchinson < nshutchinson @ gmail.com > Oleksandr Sochka < sasha.sochka @ gmail.com > Pascal Leroy < phl @ google.com > diff -- git a/src/sysinfo.cc b/src/sysinfo.cc index 34f9871..7feb79e 100644 -- - a/src/sysinfo.cc +++ b/src/sysinfo.cc @ @ -75,7 +75,9 @ @ bool ReadIntFromFile ( const char* file , long* value ) { char line [ 1024 ] ; char* err ; memset ( line , '\0 ' , sizeof ( line )
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 1e853e2..4755322 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -231,7 +231,13 @ @ BENCHMARK_UNUSED static int stream_init_anchor = InitializeStreams ( ) ; # ifndef BENCHMARK_HAS_NO_INLINE_ASSEMBLY template < class Tp > inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { + // Clang does n't like the 'X ' constraint on ` value ` and certain GCC versions + // do n't like the 'g ' constraint . Attempt to placate them both . + # if defined ( __clang__ ) asm volatile ( `` '' : : `` g '' ( value ) : `` memory '' ) ; + # else + asm volatile ( `` '' : : `` i , r , m '' ( value ) : `` memory '' ) ; + # endif } // Force the compiler to flush pending writes to global memory . Acts as an // effective read/write barrier diff -- git a/test/CMakeLists.txt b/test/CMakeLists.txt index d89135a..b55612b 100644 -- - a/test/CMakeLists.txt +++ b/test/CMakeLists.txt @ @ -1,6 +1,7 @ @ # Enable the tests find_package ( Threads REQUIRED ) +include ( CheckCXXCompilerFlag ) # NOTE : Some tests use ` < cassert > `
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..a591743 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,18 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF & & echo disabling 32 bit build +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLLVM_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..6bbd13b 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,6 +23,18 @ @ matrix : - compiler : gcc addons : apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + addons : + apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc +
diff -- git a/src/internal_macros.h b/src/internal_macros.h index 46913f4..2b3f32f 100644 -- - a/src/internal_macros.h +++ b/src/internal_macros.h @ @ -30,9 +30,13 @ @ # elif defined ( _WIN32 ) # define BENCHMARK_OS_WINDOWS 1 # elif defined ( __APPLE__ ) -// TODO ( ericwf ) This does n't actually check that it is a Mac OSX system . Just -// that it is an apple system . - # define BENCHMARK_OS_MACOSX 1 + # include `` TargetConditionals.h '' + # if defined ( TARGET_OS_MAC ) + # define BENCHMARK_OS_MACOSX 1 + # if defined ( TARGET_OS_IPHONE ) + # define BENCHMARK_OS_IOS 1 + # endif + # endif # elif defined ( __FreeBSD__ ) # define BENCHMARK_OS_FREEBSD 1 # elif defined ( __linux__ ) diff -- git a/src/sysinfo.cc b/src/sysinfo.cc index dd1e663..34f9871 100644 -- - a/src/sysinfo.cc +++ b/src/sysinfo.cc @ @ -295,8 +295,13 @ @ void InitializeSystemInfo ( ) { ( size == sizeof ( cpu_freq ) ) ) { cpuinfo_cycles_per_second = cpu_freq ; } else { + # if defined BENCHMARK_OS_IOS + fprintf ( stderr , `` CPU frequency can not be detected . \n '' ) ; + cpuinfo_cycles_per_second = 0 ; + # else fprintf ( stderr , `` % s\n '' , strerror
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..82bd94f 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..90fd5c4 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..35f594a 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..456b0a6 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,65 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -228,6 +235,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..68c1ee2 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..a591743 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,18 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF & & echo disabling 32 bit build +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLLVM_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..314ac64 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,6 +23,18 @ @ matrix : - compiler : gcc addons : apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + addons : + apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..98dca3d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 2ded481..5cc302f 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -223,6 +230,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..68c1ee2 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..35f594a 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index 7dad6f4..bd3b0ff 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -382,16 +382,17 @ @ namespace internal { class ThreadTimer ; class ThreadManager ; +enum ReportMode # if defined ( BENCHMARK_HAS_CXX11 ) -enum ReportMode : unsigned { + : unsigned # else -enum ReportMode { # endif + { RM_Unspecified , // The mode has not been manually specified RM_Default , // The mode is user-specified as default . RM_ReportAggregatesOnly } ; - } + } // namespace internal // State is passed to a running Benchmark and contains state for the // benchmark to use . @ @ -815,7 +816,7 @ @ class LambdaBenchmark : public Benchmark { } ; # endif - } // end namespace internal + } // namespace internal inline internal : :Benchmark* RegisterBenchmark ( const char* name , internal : :Function* fn ) { @ @ -867,7 +868,7 @ @ class Fixture : public internal : :Benchmark { virtual void BenchmarkCase ( State & ) = 0 ; } ; - } // namespace internal + } // namespace benchmark // -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index fc448e6..7dad6f4 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -286,7 +286,7 @ @ Benchmark* RegisterBenchmarkInternal ( Benchmark* ) ; int InitializeStreams ( ) ; BENCHMARK_UNUSED static int stream_init_anchor = InitializeStreams ( ) ; - } // end namespace internal + } // namespace internal # if ! defined ( __GNUC__ ) || defined ( __pnacl__ ) || defined ( EMSCRIPTN ) @ @ -556,7 +556,7 @ @ class State { const int threads ; const size_t max_iterations ; - // TODO make me private + // TODO ( EricWF ) make me private State ( size_t max_iters , const std : :vector < int > & ranges , int thread_i , int n_threads , internal : :ThreadTimer* timer , internal : :ThreadManager* manager ) ; @ @ -671,7 +671,7 @ @ class Benchmark { // Specify if each repetition of the benchmark should be reported separately // or if only the final statistics should be reported . If the benchmark // is not repeated then the single result is always reported . - Benchmark* ReportAggregatesOnly ( bool v = true ) ; + Benchmark* ReportAggregatesOnly ( bool value = true ) ; // If
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 28baa58..ff3f3d4 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -858,6 +858,13 @ @ class Fixture : public internal : :Benchmark { # define BENCHMARK_MAIN ( ) \ int main ( int argc , char** argv ) { \ : :benchmark : :Initialize ( & argc , argv ) ; \ + for ( int i = 1 ; i < argc ; ++i ) { \ + fprintf ( stdout , `` % s : error : unrecognised command-line flag : % s\n '' , \ + argv [ 0 ] , argv [ i ] ) ; \ + } \ + if ( argc > 1 ) { \ + return 1 ; \ + } \ : :benchmark : :RunSpecifiedBenchmarks ( ) ; \ }
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..3401ed2 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..713823c 100644 -- - a/README.md +++ b/README.md @ @ -393,6 +393,78 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/src/sysinfo.cc b/src/sysinfo.cc index 34f9871..7feb79e 100644 -- - a/src/sysinfo.cc +++ b/src/sysinfo.cc @ @ -75,7 +75,9 @ @ bool ReadIntFromFile ( const char* file , long* value ) { char line [ 1024 ] ; char* err ; memset ( line , '\0 ' , sizeof ( line ) ) ; - CHECK ( read ( fd , line , sizeof ( line ) - 1 ) ) ; + ssize_t read_err = read ( fd , line , sizeof ( line ) - 1 ) ; + ( ( void ) read_err ) ; // prevent unused warning + CHECK ( read_err > = 0 ) ; const long temp_value = strtol ( line , & err , 10 ) ; if ( line [ 0 ] ! = '\0 ' & & ( *err == '\n ' || *err == '\0 ' ) ) { *value = temp_value ;
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..a3f6a1b 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -21,6 +21,10 @ @ matrix : - compiler : gcc env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc addons : apt : sources : @ @ -44,6 +48,17 @ @ matrix :
diff -- git a/src/internal_macros.h b/src/internal_macros.h index 46913f4..2b3f32f 100644 -- - a/src/internal_macros.h +++ b/src/internal_macros.h @ @ -30,9 +30,13 @ @ # elif defined ( _WIN32 ) # define BENCHMARK_OS_WINDOWS 1 # elif defined ( __APPLE__ ) -// TODO ( ericwf ) This does n't actually check that it is a Mac OSX system . Just -// that it is an apple system . - # define BENCHMARK_OS_MACOSX 1 + # include `` TargetConditionals.h '' + # if defined ( TARGET_OS_MAC ) + # define BENCHMARK_OS_MACOSX 1 + # if defined ( TARGET_OS_IPHONE ) + # define BENCHMARK_OS_IOS 1 + # endif + # endif # elif defined ( __FreeBSD__ ) # define BENCHMARK_OS_FREEBSD 1 # elif defined ( __linux__ ) diff -- git a/src/sysinfo.cc b/src/sysinfo.cc index dd1e663..34f9871 100644 -- - a/src/sysinfo.cc +++ b/src/sysinfo.cc @ @ -295,8 +295,13 @ @ void InitializeSystemInfo ( ) { ( size == sizeof ( cpu_freq ) ) ) { cpuinfo_cycles_per_second = cpu_freq ; } else { + # if defined BENCHMARK_OS_IOS + fprintf ( stderr , `` CPU frequency can not be detected . \n '' ) ; + cpuinfo_cycles_per_second = 0 ; + # else fprintf ( stderr , `` % s\n '' , strerror
diff -- git a/README.md b/README.md index 456b0a6..4446637 100644 -- - a/README.md +++ b/README.md @ @ -365,7 +365,7 @ @ static void BM_vector_push_back ( benchmark : :State & state ) { } `` ` -Note that ` ClobberMemory ( ) ` is only available for GNU based compilers . +Note that ` ClobberMemory ( ) ` is only available for GNU or MSVC based compilers . # # # Set time unit manually If a benchmark runs a few milliseconds it may be hard to visually compare the diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f72a64a..8cde61b 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -165,6 +165,10 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include < utility > # endif + # if defined ( _MSC_VER ) + # include < intrin.h > // for _ReadWriteBarrier + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -215,11 +219,16 @ @ BENCHMARK_UNUSED static int stream_init_anchor = InitializeStreams ( ) ; } // end namespace internal + + # if ! defined ( __GNUC__ ) || defined ( __pnacl__ ) || defined ( EMSCRIPTN ) + # define BENCHMARK_HAS_NO_INLINE_ASSEMBLY + # endif + //
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..713823c 100644 -- - a/README.md +++ b/README.md @ @ -393,6 +393,78 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/src/cycleclock.h b/src/cycleclock.h index ca26cca..d3fa837 100644 -- - a/src/cycleclock.h +++ b/src/cycleclock.h @ @ -45,6 +45,10 @ @ extern `` C '' uint64_t __rdtsc ( ) ; # include < sys/time.h > # endif + # if defined ( __pnacl__ ) + # include < time.h > + # endif + namespace benchmark { // NOTE : only i386 and x86_64 have been well tested . // PPC , sparc , alpha , and ia64 are based on @ @ -132,6 +136,14 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { struct timeval tv ; gettimeofday ( & tv , nullptr ) ; return static_cast < int64_t > ( tv.tv_sec ) * 1000000 + tv.tv_usec ; + # elif defined ( __pnacl__ ) + // Portable Native Client compiles to architecture-agnostic bytecode , + // and does not provide any API to access cycle counter . + + // Initialize to always return if clock_gettime fails + struct timespec ts = { 0 , 0 } ; + clock_gettime ( CLOCK_MONOTONIC , & ts ) ; + return static_cast < int64_t > ( ts.tv_sec ) * 1000000000 + ts.tv_nsec ; # else // The soft failover to a generic
diff -- git a/tools/compare_bench.py b/tools/compare_bench.py index 8a7e799..d54baaa 100755 -- - a/tools/compare_bench.py +++ b/tools/compare_bench.py @ @ -59,7 +59,7 @ @ def main ( ) : json1 = gbench.util.run_or_load_benchmark ( test1 , benchmark_options ) json2 = gbench.util.run_or_load_benchmark ( test2 , benchmark_options ) output_lines = gbench.report.generate_difference_report ( json1 , json2 ) - print 'Comparing % s to % s ' % ( test1 , test2 ) + print ( 'Comparing % s to % s ' % ( test1 , test2 ) ) for ln in output_lines : print ( ln ) diff -- git a/tools/gbench/report.py b/tools/gbench/report.py index 6776d03..8f1b0fa 100644 -- - a/tools/gbench/report.py +++ b/tools/gbench/report.py @ @ -132,7 +132,7 @ @ class TestReportDifference ( unittest.TestCase ) : json1 , json2 = self.load_results ( ) output_lines_with_header = generate_difference_report ( json1 , json2 , use_color=False ) output_lines = output_lines_with_header [ 2 : ] - print `` \n '' .join ( output_lines_with_header ) + print ( `` \n '' .join ( output_lines_with_header ) ) self.assertEqual ( len ( output_lines ) , len ( expect_lines ) ) for i in xrange ( 0 , len ( output_lines ) ) : parts = [ x for x in output_lines [ i ] .split ( ' ' ) if
diff -- git a/src/benchmark_register.cc b/src/benchmark_register.cc index cf78bbf..0753e5c 100644 -- - a/src/benchmark_register.cc +++ b/src/benchmark_register.cc @ @ -31,6 +31,7 @ @ # include < fstream > # include < iostream > # include < memory > + # include < sstream > # include < thread > # include `` check.h '' @ @ -162,8 +163,15 @ @ bool BenchmarkFamilies : :FindBenchmarks ( StringPrintF ( `` % s : '' , family- > arg_names_ [ arg_i ] .c_str ( ) ) ; } } - + + # if defined ( __ANDROID__ ) & & ( defined ( __GLIBCXX__ ) || defined ( __GLIBCPP__ ) ) + // workaround for Android , http : //stackoverflow.com/questions/22774009/android-ndk-stdto-string-support + std : :ostringstream ss ; + ss < < arg ; + instance.name += ss.str ( ) ; + # else instance.name += std : :to_string ( arg ) ; + # endif ++arg_i ; } diff -- git a/src/colorprint.cc b/src/colorprint.cc index 513376b..4124bc0 100644 -- - a/src/colorprint.cc +++ b/src/colorprint.cc @ @ -89,7 +89,11 @ @ std : :string FormatString ( const char* msg , va_list args ) { std : :size_t size = 256 ; char local_buff [ 256 ] ; + # if defined (
diff -- git a/src/benchmark_register.cc b/src/benchmark_register.cc index cf78bbf..0753e5c 100644 -- - a/src/benchmark_register.cc +++ b/src/benchmark_register.cc @ @ -31,6 +31,7 @ @ # include < fstream > # include < iostream > # include < memory > + # include < sstream > # include < thread > # include `` check.h '' @ @ -162,8 +163,15 @ @ bool BenchmarkFamilies : :FindBenchmarks ( StringPrintF ( `` % s : '' , family- > arg_names_ [ arg_i ] .c_str ( ) ) ; } } - + + # if defined ( __ANDROID__ ) & & ( defined ( __GLIBCXX__ ) || defined ( __GLIBCPP__ ) ) + // workaround for Android , http : //stackoverflow.com/questions/22774009/android-ndk-stdto-string-support + std : :ostringstream ss ; + ss < < arg ; + instance.name += ss.str ( ) ; + # else instance.name += std : :to_string ( arg ) ; + # endif ++arg_i ; } diff -- git a/src/colorprint.cc b/src/colorprint.cc index 513376b..2dec4a8 100644 -- - a/src/colorprint.cc +++ b/src/colorprint.cc @ @ -89,7 +89,7 @ @ std : :string FormatString ( const char* msg , va_list args ) { std : :size_t size = 256 ; char local_buff [ 256 ] ; - auto ret = std
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 28baa58..754fb87 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -168,6 +168,9 @ @ class BenchmarkReporter ; void Initialize ( int* argc , char** argv ) ; +// Report to stdout all arguments in 'argv ' as unrecognized except the first . +void ReportUnrecognizedArguments ( int argc , char** argv ) ; + // Generate a list of benchmarks matching the specified -- benchmark_filter flag // and if -- benchmark_list_tests is specified return after printing the name // of each matching benchmark . Otherwise run each matching benchmark and @ @ -858,6 +861,10 @ @ class Fixture : public internal : :Benchmark { # define BENCHMARK_MAIN ( ) \ int main ( int argc , char** argv ) { \ : :benchmark : :Initialize ( & argc , argv ) ; \ + if ( argc > 1 ) { \ + : :benchmark : :ReportUnrecognizedArguments ( argc , argv ) ; \ + return 1 ; \ + } \ : :benchmark : :RunSpecifiedBenchmarks ( ) ; \ } diff -- git a/src/benchmark.cc b/src/benchmark.cc index 95f6a25..e829176 100644 -- - a/src/benchmark.cc +++ b/src/benchmark.cc @ @ -664,4 +664,10 @ @ void Initialize ( int* argc ,
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index b3b0a8e..fc448e6 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -11,11 +11,1199 @ @ // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . // See the License for the specific language governing permissions and // limitations under the License . + +// Support for registering benchmarks for functions . + +/* Example usage : +// Define a function that executes the code to be measured a +// specified number of times : +static void BM_StringCreation ( benchmark : :State & state ) { + while ( state.KeepRunning ( ) ) + std : :string empty_string ; + } + +// Register the function as a benchmark +BENCHMARK ( BM_StringCreation ) ; + +// Define another benchmark +static void BM_StringCopy ( benchmark : :State & state ) { + std : :string x = `` hello '' ; + while ( state.KeepRunning ( ) ) + std : :string copy ( x ) ; + } +BENCHMARK ( BM_StringCopy ) ; + +// Augment the main ( ) program to invoke benchmarks if specified +// via the -- benchmarks command line flag . E.g. , +// my_unittest -- benchmark_filter=all +// my_unittest
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..68c1ee2 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..456b0a6 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,65 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..915702e 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 2cfb70b..456b0a6 100644 -- - a/README.md +++ b/README.md @ @ -432,6 +432,65 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 8cde61b..420d454 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -577,9 +577,13 @ @ class Benchmark { // Set the minimum amount of time to use when running this benchmark . This // option overrides the ` benchmark_min_time ` flag . - // REQUIRES : ` t > 0 ` + // REQUIRES : ` t > 0 ` and ` Iterations ` has not been called on this benchmark . Benchmark* MinTime ( double t ) ; + // Specify the amount of iterations that should be run by this benchmark . + // REQUIRES : 'n > 0 ' and ` MinTime ` has not been called on this benchmark . + Benchmark* Iterations ( size_t n ) ; + // Specify the amount of times to repeat this benchmark . This option overrides // the ` benchmark_repetitions ` flag . // REQUIRES : ` n > 0 ` @ @ -668,6 +672,7 @ @ class Benchmark { TimeUnit time_unit_ ; int range_multiplier_ ; double min_time_ ; + size_t iterations_ ; int repetitions_ ; bool use_real_time_ ; bool use_manual_time_ ; diff -- git a/src/benchmark.cc b/src/benchmark.cc index a93a83d..4adb97a 100644 -- - a/src/benchmark.cc +++ b/src/benchmark.cc
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index fc448e6..7dad6f4 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -286,7 +286,7 @ @ Benchmark* RegisterBenchmarkInternal ( Benchmark* ) ; int InitializeStreams ( ) ; BENCHMARK_UNUSED static int stream_init_anchor = InitializeStreams ( ) ; - } // end namespace internal + } // namespace internal # if ! defined ( __GNUC__ ) || defined ( __pnacl__ ) || defined ( EMSCRIPTN ) @ @ -556,7 +556,7 @ @ class State { const int threads ; const size_t max_iterations ; - // TODO make me private + // TODO ( EricWF ) make me private State ( size_t max_iters , const std : :vector < int > & ranges , int thread_i , int n_threads , internal : :ThreadTimer* timer , internal : :ThreadManager* manager ) ; @ @ -671,7 +671,7 @ @ class Benchmark { // Specify if each repetition of the benchmark should be reported separately // or if only the final statistics should be reported . If the benchmark // is not repeated then the single result is always reported . - Benchmark* ReportAggregatesOnly ( bool v = true ) ; + Benchmark* ReportAggregatesOnly ( bool value = true ) ; // If
diff -- git a/tools/compare_bench.py b/tools/compare_bench.py index 8a7e799..d54baaa 100755 -- - a/tools/compare_bench.py +++ b/tools/compare_bench.py @ @ -59,7 +59,7 @ @ def main ( ) : json1 = gbench.util.run_or_load_benchmark ( test1 , benchmark_options ) json2 = gbench.util.run_or_load_benchmark ( test2 , benchmark_options ) output_lines = gbench.report.generate_difference_report ( json1 , json2 ) - print 'Comparing % s to % s ' % ( test1 , test2 ) + print ( 'Comparing % s to % s ' % ( test1 , test2 ) ) for ln in output_lines : print ( ln ) diff -- git a/tools/gbench/report.py b/tools/gbench/report.py index 6776d03..8f1b0fa 100644 -- - a/tools/gbench/report.py +++ b/tools/gbench/report.py @ @ -132,7 +132,7 @ @ class TestReportDifference ( unittest.TestCase ) : json1 , json2 = self.load_results ( ) output_lines_with_header = generate_difference_report ( json1 , json2 , use_color=False ) output_lines = output_lines_with_header [ 2 : ] - print `` \n '' .join ( output_lines_with_header ) + print ( `` \n '' .join ( output_lines_with_header ) ) self.assertEqual ( len ( output_lines ) , len ( expect_lines ) ) for i in xrange ( 0 , len ( output_lines ) ) : parts = [ x for x in output_lines [ i ] .split ( ' ' ) if
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index b3b0a8e..fc448e6 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -11,11 +11,1199 @ @ // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . // See the License for the specific language governing permissions and // limitations under the License . + +// Support for registering benchmarks for functions . + +/* Example usage : +// Define a function that executes the code to be measured a +// specified number of times : +static void BM_StringCreation ( benchmark : :State & state ) { + while ( state.KeepRunning ( ) ) + std : :string empty_string ; + } + +// Register the function as a benchmark +BENCHMARK ( BM_StringCreation ) ; + +// Define another benchmark +static void BM_StringCopy ( benchmark : :State & state ) { + std : :string x = `` hello '' ; + while ( state.KeepRunning ( ) ) + std : :string copy ( x ) ; + } +BENCHMARK ( BM_StringCopy ) ; + +// Augment the main ( ) program to invoke benchmarks if specified +// via the -- benchmarks command line flag . E.g. , +// my_unittest -- benchmark_filter=all +// my_unittest
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..40dfd50 100644 -- - a/README.md +++ b/README.md @ @ -393,6 +393,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..90fd5c4 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a545fa..8c15b87 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 33cd941..96cd15a 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0993952..6e47dff 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,60 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/README.md b/README.md index 456b0a6..4446637 100644 -- - a/README.md +++ b/README.md @ @ -365,7 +365,7 @ @ static void BM_vector_push_back ( benchmark : :State & state ) { } `` ` -Note that ` ClobberMemory ( ) ` is only available for GNU based compilers . +Note that ` ClobberMemory ( ) ` is only available for GNU or MSVC based compilers . # # # Set time unit manually If a benchmark runs a few milliseconds it may be hard to visually compare the diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f72a64a..8cde61b 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -165,6 +165,10 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include < utility > # endif + # if defined ( _MSC_VER ) + # include < intrin.h > // for _ReadWriteBarrier + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -215,11 +219,16 @ @ BENCHMARK_UNUSED static int stream_init_anchor = InitializeStreams ( ) ; } // end namespace internal + + # if ! defined ( __GNUC__ ) || defined ( __pnacl__ ) || defined ( EMSCRIPTN ) + # define BENCHMARK_HAS_NO_INLINE_ASSEMBLY + # endif + //
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..98dca3d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 0af13fe..d5efddb 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 5a4b355..cb36aee 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -28,3 +28,4 @ @ Yusuke Suzuki < utatane.tea @ gmail.com > Dirac Research Zbigniew Skowron < zbychs @ gmail.com > Dominik Czarnota < dominik.b.czarnota @ gmail.com > +Björn Gaier < bjoerngaier @ web.de > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index ed55bcf..f35b059 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -44,3 +44,4 @ @ Yusuke Suzuki < utatane.tea @ gmail.com > Tobias Ulvgård < tobias.ulvgard @ dirac.se > Zbigniew Skowron < zbychs @ gmail.com > Dominik Czarnota < dominik.b.czarnota @ gmail.com > +Björn Gaier < bjoerngaier @ web.de >
diff -- git a/AUTHORS b/AUTHORS index 5a4b355..cb36aee 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -28,3 +28,4 @ @ Yusuke Suzuki < utatane.tea @ gmail.com > Dirac Research Zbigniew Skowron < zbychs @ gmail.com > Dominik Czarnota < dominik.b.czarnota @ gmail.com > +Björn Gaier < bjoerngaier @ web.de > diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2c72252..16357a1 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -121,6 +121,20 @ @ find_package ( Threads REQUIRED ) # Set up directories include_directories ( $ { PROJECT_SOURCE_DIR } /include ) + # Set up pathes to javascript +set ( JQUERY_NAME `` jquery-2.2.1.min.js '' ) +set ( HIGHSTOCK_NAME `` highstock.js '' ) + +set ( JQUERY_PATH `` $ { PROJECT_SOURCE_DIR } /include/benchmark/ $ { JQUERY_NAME } '' ) +set ( HIGHSTOCK_PATH `` $ { PROJECT_SOURCE_DIR } /include/benchmark/ $ { HIGHSTOCK_NAME } '' ) + +configure_file ( $ { PROJECT_SOURCE_DIR } /include/benchmark/filePath.h.in $ { PROJECT_BINARY_DIR } /include/benchmark/filePath.h @ ONLY ) + +set ( JQUERY_PATH `` $ { CMAKE_INSTALL_PREFIX } /share/benchmark/ $ { JQUERY_NAME } '' ) +set ( HIGHSTOCK_PATH `` $ { CMAKE_INSTALL_PREFIX } /share/benchmark/ $ { HIGHSTOCK_NAME } '' ) + +configure_file ( $ { PROJECT_SOURCE_DIR } /include/benchmark/filePath.h.in $ { PROJECT_BINARY_DIR } /include/benchmark/filePath.h.install @ ONLY )
diff -- git a/AUTHORS b/AUTHORS index 5a4b355..cb36aee 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -28,3 +28,4 @ @ Yusuke Suzuki < utatane.tea @ gmail.com > Dirac Research Zbigniew Skowron < zbychs @ gmail.com > Dominik Czarnota < dominik.b.czarnota @ gmail.com > +Björn Gaier < bjoerngaier @ web.de > diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2c72252..8feba51 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -121,6 +121,23 @ @ find_package ( Threads REQUIRED ) # Set up directories include_directories ( $ { PROJECT_SOURCE_DIR } /include ) + # Set up pathes to javascript +set ( JQUERY_NAME `` jquery-2.2.1.min.js '' ) +set ( HIGHSTOCK_NAME `` highstock.js '' ) +set ( HIGHSTOCK_MORE_NAME `` highcharts-more.js '' ) + +set ( JQUERY_PATH `` $ { PROJECT_SOURCE_DIR } /include/benchmark/ $ { JQUERY_NAME } '' ) +set ( HIGHSTOCK_PATH `` $ { PROJECT_SOURCE_DIR } /include/benchmark/ $ { HIGHSTOCK_NAME } '' ) +set ( HIGHSTOCK_MORE_PATH `` $ { PROJECT_SOURCE_DIR } /include/benchmark/ $ { HIGHSTOCK_MORE_NAME } '' ) + +configure_file ( $ { PROJECT_SOURCE_DIR } /include/benchmark/filePath.h.in $ { PROJECT_BINARY_DIR } /include/benchmark/filePath.h @ ONLY ) + +set ( JQUERY_PATH `` $ { CMAKE_INSTALL_PREFIX } /share/benchmark/ $ { JQUERY_NAME } '' ) +set ( HIGHSTOCK_PATH `` $ { CMAKE_INSTALL_PREFIX } /share/benchmark/
diff -- git a/AUTHORS b/AUTHORS index 5a4b355..cb36aee 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -28,3 +28,4 @ @ Yusuke Suzuki < utatane.tea @ gmail.com > Dirac Research Zbigniew Skowron < zbychs @ gmail.com > Dominik Czarnota < dominik.b.czarnota @ gmail.com > +Björn Gaier < bjoerngaier @ web.de > diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2c72252..4571abe 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -11,6 +11,7 @ @ endforeach ( ) option ( BENCHMARK_ENABLE_TESTING `` Enable testing of the benchmark library . '' ON ) option ( BENCHMARK_ENABLE_LTO `` Enable link time optimisation of the benchmark library . '' OFF ) +option ( BENCHMARK_DOWNLOAD_JS `` Enable download of Highchart and JQuery '' OFF ) # Make sure we can import out CMake functions list ( APPEND CMAKE_MODULE_PATH `` $ { CMAKE_CURRENT_SOURCE_DIR } /cmake '' ) @ @ -121,6 +122,45 @ @ find_package ( Threads REQUIRED ) # Set up directories include_directories ( $ { PROJECT_SOURCE_DIR } /include ) + # Set up pathes to javascript + +if ( BENCHMARK_DOWNLOAD_JS ) + set ( JQUERY_NAME `` jquery-2.2.1.min.js '' ) + set ( HIGHSTOCK_NAME `` highstock.js '' ) + set ( HIGHSTOCK_MORE_NAME `` highcharts-more.js '' ) + + file ( DOWNLOAD ``
diff -- git a/AUTHORS b/AUTHORS index 5a4b355..cb36aee 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -28,3 +28,4 @ @ Yusuke Suzuki < utatane.tea @ gmail.com > Dirac Research Zbigniew Skowron < zbychs @ gmail.com > Dominik Czarnota < dominik.b.czarnota @ gmail.com > +Björn Gaier < bjoerngaier @ web.de > diff -- git a/CMakeLists.txt b/CMakeLists.txt index 2c72252..4571abe 100644 -- - a/CMakeLists.txt +++ b/CMakeLists.txt @ @ -11,6 +11,7 @ @ endforeach ( ) option ( BENCHMARK_ENABLE_TESTING `` Enable testing of the benchmark library . '' ON ) option ( BENCHMARK_ENABLE_LTO `` Enable link time optimisation of the benchmark library . '' OFF ) +option ( BENCHMARK_DOWNLOAD_JS `` Enable download of Highchart and JQuery '' OFF ) # Make sure we can import out CMake functions list ( APPEND CMAKE_MODULE_PATH `` $ { CMAKE_CURRENT_SOURCE_DIR } /cmake '' ) @ @ -121,6 +122,45 @ @ find_package ( Threads REQUIRED ) # Set up directories include_directories ( $ { PROJECT_SOURCE_DIR } /include ) + # Set up pathes to javascript + +if ( BENCHMARK_DOWNLOAD_JS ) + set ( JQUERY_NAME `` jquery-2.2.1.min.js '' ) + set ( HIGHSTOCK_NAME `` highstock.js '' ) + set ( HIGHSTOCK_MORE_NAME `` highcharts-more.js '' ) + + file ( DOWNLOAD ``
diff -- git a/src/cycleclock.h b/src/cycleclock.h index ca26cca..726311e 100644 -- - a/src/cycleclock.h +++ b/src/cycleclock.h @ @ -45,6 +45,14 @ @ extern `` C '' uint64_t __rdtsc ( ) ; # include < sys/time.h > # endif + # ifdef BENCHMARK_OS_EMSCRIPTEN + # include < emscripten.h > + # endif + + # if defined ( __pnacl__ ) + # include < time.h > + # endif + namespace benchmark { // NOTE : only i386 and x86_64 have been well tested . // PPC , sparc , alpha , and ia64 are based on @ @ -65,6 +73,10 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { // counter pauses ; it does not continue counting , nor does it // reset to zero . return mach_absolute_time ( ) ; + # elif defined ( BENCHMARK_OS_EMSCRIPTEN ) + // this goes above x86-specific code because old versions of Emscripten + // define __x86_64__ , although they have nothing to do with it . + return static_cast < int64_t > ( emscripten_get_now ( ) * 1e+6 ) ; # elif defined ( __i386__ ) int64_t ret ; __asm__ volatile ( `` rdtsc '' : `` =A '' ( ret ) ) ;
diff -- git a/src/benchmark_register.cc b/src/benchmark_register.cc index cf78bbf..0753e5c 100644 -- - a/src/benchmark_register.cc +++ b/src/benchmark_register.cc @ @ -31,6 +31,7 @ @ # include < fstream > # include < iostream > # include < memory > + # include < sstream > # include < thread > # include `` check.h '' @ @ -162,8 +163,15 @ @ bool BenchmarkFamilies : :FindBenchmarks ( StringPrintF ( `` % s : '' , family- > arg_names_ [ arg_i ] .c_str ( ) ) ; } } - + + # if defined ( __ANDROID__ ) & & ( defined ( __GLIBCXX__ ) || defined ( __GLIBCPP__ ) ) + // workaround for Android , http : //stackoverflow.com/questions/22774009/android-ndk-stdto-string-support + std : :ostringstream ss ; + ss < < arg ; + instance.name += ss.str ( ) ; + # else instance.name += std : :to_string ( arg ) ; + # endif ++arg_i ; } diff -- git a/src/colorprint.cc b/src/colorprint.cc index 513376b..2dec4a8 100644 -- - a/src/colorprint.cc +++ b/src/colorprint.cc @ @ -89,7 +89,7 @ @ std : :string FormatString ( const char* msg , va_list args ) { std : :size_t size = 256 ; char local_buff [ 256 ] ; - auto ret = std
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 28baa58..754fb87 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -168,6 +168,9 @ @ class BenchmarkReporter ; void Initialize ( int* argc , char** argv ) ; +// Report to stdout all arguments in 'argv ' as unrecognized except the first . +void ReportUnrecognizedArguments ( int argc , char** argv ) ; + // Generate a list of benchmarks matching the specified -- benchmark_filter flag // and if -- benchmark_list_tests is specified return after printing the name // of each matching benchmark . Otherwise run each matching benchmark and @ @ -858,6 +861,10 @ @ class Fixture : public internal : :Benchmark { # define BENCHMARK_MAIN ( ) \ int main ( int argc , char** argv ) { \ : :benchmark : :Initialize ( & argc , argv ) ; \ + if ( argc > 1 ) { \ + : :benchmark : :ReportUnrecognizedArguments ( argc , argv ) ; \ + return 1 ; \ + } \ : :benchmark : :RunSpecifiedBenchmarks ( ) ; \ } diff -- git a/src/benchmark.cc b/src/benchmark.cc index 95f6a25..e829176 100644 -- - a/src/benchmark.cc +++ b/src/benchmark.cc @ @ -664,4 +664,10 @ @ void Initialize ( int* argc ,
diff -- git a/include/benchmark/benchmark.h b/include/benchmark/benchmark.h index b3b0a8e..fc448e6 100644 -- - a/include/benchmark/benchmark.h +++ b/include/benchmark/benchmark.h @ @ -11,11 +11,1199 @ @ // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . // See the License for the specific language governing permissions and // limitations under the License . + +// Support for registering benchmarks for functions . + +/* Example usage : +// Define a function that executes the code to be measured a +// specified number of times : +static void BM_StringCreation ( benchmark : :State & state ) { + while ( state.KeepRunning ( ) ) + std : :string empty_string ; + } + +// Register the function as a benchmark +BENCHMARK ( BM_StringCreation ) ; + +// Define another benchmark +static void BM_StringCopy ( benchmark : :State & state ) { + std : :string x = `` hello '' ; + while ( state.KeepRunning ( ) ) + std : :string copy ( x ) ; + } +BENCHMARK ( BM_StringCopy ) ; + +// Augment the main ( ) program to invoke benchmarks if specified +// via the -- benchmarks command line flag . E.g. , +// my_unittest -- benchmark_filter=all +// my_unittest
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..05ad376 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..90fd5c4 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 1e853e2..4755322 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -231,7 +231,13 @ @ BENCHMARK_UNUSED static int stream_init_anchor = InitializeStreams ( ) ; # ifndef BENCHMARK_HAS_NO_INLINE_ASSEMBLY template < class Tp > inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { + // Clang does n't like the 'X ' constraint on ` value ` and certain GCC versions + // do n't like the 'g ' constraint . Attempt to placate them both . + # if defined ( __clang__ ) asm volatile ( `` '' : : `` g '' ( value ) : `` memory '' ) ; + # else + asm volatile ( `` '' : : `` i , r , m '' ( value ) : `` memory '' ) ; + # endif } // Force the compiler to flush pending writes to global memory . Acts as an // effective read/write barrier diff -- git a/test/CMakeLists.txt b/test/CMakeLists.txt index d89135a..b55612b 100644 -- - a/test/CMakeLists.txt +++ b/test/CMakeLists.txt @ @ -1,6 +1,7 @ @ # Enable the tests find_package ( Threads REQUIRED ) +include ( CheckCXXCompilerFlag ) # NOTE : Some tests use ` < cassert > `
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..5ab7ece 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -21,6 +21,10 @ @ matrix : - compiler : gcc env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc addons : apt : sources : @ @ -44,6 +48,17 @ @ matrix :
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..5fa34c9 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,6 +23,18 @ @ matrix : - compiler : gcc addons : apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + addons : + apt : + packages : + - g++-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release BUILD_32_BITS=ON + - compiler : gcc +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index 664ca2a..f681078 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters +
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..713823c 100644 -- - a/README.md +++ b/README.md @ @ -393,6 +393,78 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 8c495cc..9dfc476 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/AUTHORS b/AUTHORS index 0e40922..535cb04 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -19,6 +19,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 5c1f439..90fd5c4 100644 -- - a/README.md +++ b/README.md @ @ -430,6 +430,61 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index e705d75..5929c66 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -236,6 +236,30 @ @ enum TimeUnit { kMillisecond } ; +inline const char* GetTimeUnitString ( TimeUnit unit ) { + switch ( unit ) { + case kMillisecond : + return `` ms '' ; + case kMicrosecond : + return `` us '' ; + case kNanosecond : + default : + return `` ns '' ; + } + } + +inline double GetTimeUnitMultiplier ( TimeUnit unit ) { + switch ( unit ) { + case kMillisecond : + return 1e3 ; + case kMicrosecond : + return 1e6 ; + case kNanosecond : + default : + return 1e9 ; + } + } + // BigO is passed to a benchmark in order to specify the asymptotic computational // complexity for the benchmark . In case oAuto is selected , complexity will be // calculated automatically to the best fit . diff -- git a/include/benchmark/reporter.h b/include/benchmark/reporter.h index ded01d2..6ade37b 100644 -- - a/include/benchmark/reporter.h +++ b/include/benchmark/reporter.h @ @ -24,8 +24,6 @ @ namespace benchmark { -typedef std : :pair < const char* , double > TimeUnitMultiplier ; - // Interface for custom
diff -- git a/README.md b/README.md index a0bcc61..9937e97 100644 -- - a/README.md +++ b/README.md @ @ -206,6 +206,34 @ @ BENCHMARK_CAPTURE ( BM_takes_args , int_string_test , 42 , std : :string ( `` abc '' ) ) ; Note that elements of ` ... args ` may refer to global variables . Users should avoid modifying global state inside of a benchmark . + # # Using RegisterBenchmark ( name , fn , args ... ) + +The ` RegisterBenchmark ( name , func , args ... ) ` function provides an alternative +way to create and register benchmarks . + ` RegisterBenchmark ( name , func , args ... ) ` creates , registers , and returns a +pointer to a new benchmark with the specified ` name ` that invokes + ` func ( st , args ... ) ` where ` st ` is a ` benchmark : :State ` object . + +Unlike the ` BENCHMARK ` registration macros , which can only be used at the global +scope , the ` RegisterBenchmark ` can be called anywhere . This allows for +benchmark tests to be registered programmatically . + +Additionally ` RegisterBenchmark ` allows any callable
diff -- git a/README.md b/README.md index a0bcc61..9937e97 100644 -- - a/README.md +++ b/README.md @ @ -206,6 +206,34 @ @ BENCHMARK_CAPTURE ( BM_takes_args , int_string_test , 42 , std : :string ( `` abc '' ) ) ; Note that elements of ` ... args ` may refer to global variables . Users should avoid modifying global state inside of a benchmark . + # # Using RegisterBenchmark ( name , fn , args ... ) + +The ` RegisterBenchmark ( name , func , args ... ) ` function provides an alternative +way to create and register benchmarks . + ` RegisterBenchmark ( name , func , args ... ) ` creates , registers , and returns a +pointer to a new benchmark with the specified ` name ` that invokes + ` func ( st , args ... ) ` where ` st ` is a ` benchmark : :State ` object . + +Unlike the ` BENCHMARK ` registration macros , which can only be used at the global +scope , the ` RegisterBenchmark ` can be called anywhere . This allows for +benchmark tests to be registered programmatically . + +Additionally ` RegisterBenchmark ` allows any callable
diff -- git a/src/cycleclock.h b/src/cycleclock.h index ca26cca..d3fa837 100644 -- - a/src/cycleclock.h +++ b/src/cycleclock.h @ @ -45,6 +45,10 @ @ extern `` C '' uint64_t __rdtsc ( ) ; # include < sys/time.h > # endif + # if defined ( __pnacl__ ) + # include < time.h > + # endif + namespace benchmark { // NOTE : only i386 and x86_64 have been well tested . // PPC , sparc , alpha , and ia64 are based on @ @ -132,6 +136,14 @ @ inline BENCHMARK_ALWAYS_INLINE int64_t Now ( ) { struct timeval tv ; gettimeofday ( & tv , nullptr ) ; return static_cast < int64_t > ( tv.tv_sec ) * 1000000 + tv.tv_usec ; + # elif defined ( __pnacl__ ) + // Portable Native Client compiles to architecture-agnostic bytecode , + // and does not provide any API to access cycle counter . + + // Initialize to always return if clock_gettime fails + struct timespec ts = { 0 , 0 } ; + clock_gettime ( CLOCK_MONOTONIC , & ts ) ; + return static_cast < int64_t > ( ts.tv_sec ) * 1000000000 + ts.tv_nsec ; # else // The soft failover to a generic
diff -- git a/tools/compare_bench.py b/tools/compare_bench.py index 8a7e799..d54baaa 100755 -- - a/tools/compare_bench.py +++ b/tools/compare_bench.py @ @ -59,7 +59,7 @ @ def main ( ) : json1 = gbench.util.run_or_load_benchmark ( test1 , benchmark_options ) json2 = gbench.util.run_or_load_benchmark ( test2 , benchmark_options ) output_lines = gbench.report.generate_difference_report ( json1 , json2 ) - print 'Comparing % s to % s ' % ( test1 , test2 ) + print ( 'Comparing % s to % s ' % ( test1 , test2 ) ) for ln in output_lines : print ( ln ) diff -- git a/tools/gbench/report.py b/tools/gbench/report.py index 6776d03..8f1b0fa 100644 -- - a/tools/gbench/report.py +++ b/tools/gbench/report.py @ @ -132,7 +132,7 @ @ class TestReportDifference ( unittest.TestCase ) : json1 , json2 = self.load_results ( ) output_lines_with_header = generate_difference_report ( json1 , json2 , use_color=False ) output_lines = output_lines_with_header [ 2 : ] - print `` \n '' .join ( output_lines_with_header ) + print ( `` \n '' .join ( output_lines_with_header ) ) self.assertEqual ( len ( output_lines ) , len ( expect_lines ) ) for i in xrange ( 0 , len ( output_lines ) ) : parts = [ x for x in output_lines [ i ] .split ( ' ' ) if
diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 58f81fd..9abb608 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -51,6 +51,7 @ @ Pierre Phaneuf < pphaneuf @ google.com > Radoslav Yovchev < radoslav.tm @ gmail.com > Ray Glover < ray.glover @ uk.ibm.com > Shuo Chen < chenshuo @ chenshuo.com > +Tom Madams < tom.ej.madams @ gmail.com > < tmadams @ google.com > Yixuan Qiu < yixuanq @ gmail.com > Yusuke Suzuki < utatane.tea @ gmail.com > Tobias Ulvgård < tobias.ulvgard @ dirac.se > diff -- git a/src/internal_macros.h b/src/internal_macros.h index 8dd9f87..9428874 100644 -- - a/src/internal_macros.h +++ b/src/internal_macros.h @ @ -45,6 +45,8 @ @ # define BENCHMARK_OS_NACL 1 # elif defined ( EMSCRIPTEN ) # define BENCHMARK_OS_EMSCRIPTEN 1 + # elif defined ( __rtems__ ) + # define BENCHMARK_OS_RTEMS 1 # endif # if ! __has_feature ( cxx_exceptions ) & & ! defined ( __cpp_exceptions ) \ diff -- git a/src/timers.cc b/src/timers.cc index 8d56e8a..817272d 100644 -- - a/src/timers.cc +++ b/src/timers.cc @ @ -158,6 +158,10 @ @ double ThreadCPUUsage ( ) { # elif defined ( BENCHMARK_OS_EMSCRIPTEN ) // Emscripten does n't support traditional threads return ProcessCPUUsage ( ) ; + # elif defined ( BENCHMARK_OS_RTEMS ) + // RTEMS does n't support CLOCK_THREAD_CPUTIME_ID . See
diff -- git a/include/benchmark/benchmark_api.h b/include/benchmark/benchmark_api.h index f38dc97..82c932d 100644 -- - a/include/benchmark/benchmark_api.h +++ b/include/benchmark/benchmark_api.h @ @ -155,6 +155,13 @ @ BENCHMARK ( BM_test ) - > Unit ( benchmark : :kMillisecond ) ; # include `` macros.h '' + # include < utility > // for std : :pair in UserCounters + # include < vector > + # include < string > + # ifdef BENCHMARK_INITLIST + # include < initializer_list > + # endif + namespace benchmark { class BenchmarkReporter ; @ @ -228,6 +235,115 @ @ inline BENCHMARK_ALWAYS_INLINE void DoNotOptimize ( Tp const & value ) { } # endif + + + # define BENCHMARK_COUNTER_FMT `` % 8lg '' + +struct Counter { + + std : :string name ; + std : :string format ; + uint32_t flags ; + double value ; + // < jppm > maybe we could add a description field ... + + enum { + kDefaults = 0x00 , + kIsRate = 0x01 < < 0 , + kAvgThreads = 0x01 < < 1 , + kHumanReadable = 0x01 < < 2 , + kItemsProcessed = kIsRate|kHumanReadable , + kBytesProcessed = kIsRate|kHumanReadable + } ; + + Counter ( std
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..6f9250c 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/.travis-libcxx-setup.sh b/.travis-libcxx-setup.sh index 1b6b585..b57b2c9 100644 -- - a/.travis-libcxx-setup.sh +++ b/.travis-libcxx-setup.sh @ @ -10,12 +10,19 @ @ git clone -- depth=1 https : //github.com/llvm-mirror/llvm.git llvm-source git clone -- depth=1 https : //github.com/llvm-mirror/libcxx.git llvm-source/projects/libcxx git clone -- depth=1 https : //github.com/llvm-mirror/libcxxabi.git llvm-source/projects/libcxxabi + # Setup libc++ options +if [ -z `` $ BUILD_32_BITS '' ] ; then + export BUILD_32_BITS=OFF +fi + # Build and install libc++ ( Use unstable ABI for better sanitizer coverage ) mkdir llvm-build & & cd llvm-build cmake -DCMAKE_C_COMPILER= $ { C_COMPILER } -DCMAKE_CXX_COMPILER= $ { COMPILER } \ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=/usr \ -DLIBCXX_ABI_UNSTABLE=ON \ -DLLVM_USE_SANITIZER= $ { LIBCXX_SANITIZER } \ + -DLIBCXX_BUILD_32_BITS= $ { BUILD_32_BITS } \ + -DLIBCXXABI_BUILD_32_BITS= $ { BUILD_32_BITS } \ ../llvm-source make cxx -j2 sudo make install-cxxabi install-cxx diff -- git a/.travis.yml b/.travis.yml index 19c68dd..d3b49bf 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -21,6 +21,18 @ @ matrix : - compiler : gcc env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Release - compiler : gcc + addons : + apt : + packages : + - gcc-multilib + env : COMPILER=g++ C_COMPILER=gcc BUILD_TYPE=Debug BUILD_32_BITS=ON + - compiler : gcc + addons : + apt : + packages : + - gcc-multilib + env
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index a0bcc61..6301da8 100644 -- - a/README.md +++ b/README.md @ @ -277,6 +277,8 @ @ static void BM_ManualTiming ( benchmark : :State & state ) { BENCHMARK ( BM_ManualTiming ) - > Range ( 1 , 1 < < 17 ) - > UseManualTime ( ) ;
diff -- git a/AUTHORS b/AUTHORS index 0f93e01..3ef2cf3 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -18,6 +18,7 @ @ Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Google Inc. Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/CONTRIBUTORS b/CONTRIBUTORS index 4bff126..5a26b23 100644 -- - a/CONTRIBUTORS +++ b/CONTRIBUTORS @ @ -34,6 +34,7 @ @ Eugene Zhuk < eugene.zhuk @ gmail.com > Evgeny Safronov < division494 @ gmail.com > Felix Homann < linuxaudio @ showlabor.de > Ismael Jimenez Martinez < ismael.jimenez.martinez @ gmail.com > +Joao Paulo Magalhaes < joaoppmagalhaes @ gmail.com > JianXiong Zhou < zhoujianxiong2 @ gmail.com > Jussi Knuuttila < jussi.knuuttila @ gmail.com > Kaito Udagawa < umireon @ gmail.com > diff -- git a/README.md b/README.md index 9df94a3..9f9ca91 100644 -- - a/README.md +++ b/README.md @ @ -421,6 +421,91 @ @ BENCHMARK_REGISTER_F ( MyFixture , BarTest ) - > Threads ( 2 ) ; /* BarTest is now registered */ `` ` + + # # User-defined counters + +You can add your
diff -- git a/src/complexity.cc b/src/complexity.cc index 97bf6e0..02fe3fe 100644 -- - a/src/complexity.cc +++ b/src/complexity.cc @ @ -26,6 +26,7 @ @ namespace benchmark { // Internal function to calculate the different scalability forms BigOFunc* FittingCurve ( BigO complexity ) { + static const double kLog2E = 1.44269504088896340736 ; switch ( complexity ) { case oN : return [ ] ( int64_t n ) - > double { return static_cast < double > ( n ) ; } ; @ @ -34,9 +35,11 @ @ BigOFunc* FittingCurve ( BigO complexity ) { case oNCubed : return [ ] ( int64_t n ) - > double { return std : :pow ( n , 3 ) ; } ; case oLogN : - return [ ] ( int64_t n ) { return log2 ( n ) ; } ; + /* Note : ca n't use log2 because Android 's GNU STL lacks it */ + return [ ] ( int64_t n ) { return kLog2E * log ( n ) ; } ; case oNLogN : - return [ ] ( int64_t n ) { return n * log2 ( n ) ; } ; + /* Note : ca n't use log2
diff -- git a/blob/blob_test.go b/blob/blob_test.go deleted file mode 100644 index 7e427d6..0000000 -- - a/blob/blob_test.go +++ /dev/null @ @ -1,217 +0,0 @ @ -// Copyright 2018 Google LLC -// -// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; -// you may not use this file except in compliance with the License . -// You may obtain a copy of the License at -// -// https : //www.apache.org/licenses/LICENSE-2.0 -// -// Unless required by applicable law or agreed to in writing , software -// distributed under the License is distributed on an `` AS IS '' BASIS , -// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . -// See the License for the specific language governing permissions and -// limitations under the License . - -package blob - -import ( - '' context '' - '' io/ioutil '' - '' path/filepath '' - '' testing '' - - '' github.com/google/go-cloud/blob/driver '' - ) - -func TestNewRangeReader ( t *testing.T ) { - t.Run ( `` EntireBlob '' , func ( t *testing.T ) { - const key = `` foo '' - spy : = new ( bucketSpy ) - b
diff -- git a/blob/blob_test.go b/blob/blob_test.go deleted file mode 100644 index 34201cf..0000000 -- - a/blob/blob_test.go +++ /dev/null @ @ -1,217 +0,0 @ @ -// Copyright 2018 The Go Cloud Authors -// -// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; -// you may not use this file except in compliance with the License . -// You may obtain a copy of the License at -// -// https : //www.apache.org/licenses/LICENSE-2.0 -// -// Unless required by applicable law or agreed to in writing , software -// distributed under the License is distributed on an `` AS IS '' BASIS , -// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . -// See the License for the specific language governing permissions and -// limitations under the License . - -package blob - -import ( - '' context '' - '' io/ioutil '' - '' path/filepath '' - '' testing '' - - '' github.com/google/go-cloud/blob/driver '' - ) - -func TestNewRangeReader ( t *testing.T ) { - t.Run ( `` EntireBlob '' , func ( t *testing.T ) { - const key = `` foo '' - spy : = new ( bucketSpy )
diff -- git a/internal/pubsub/acks_test.go b/internal/pubsub/acks_test.go index 2d6d1d6..1333007 100644 -- - a/internal/pubsub/acks_test.go +++ b/internal/pubsub/acks_test.go @ @ -49,6 +49,8 @ @ func ( s *ackingDriverSub ) Close ( ) error { func ( s *ackingDriverSub ) IsRetryable ( error ) bool { return false } +func ( s *ackingDriverSub ) As ( i interface { } ) bool { return false } + func TestAckTriggersDriverSendAcksForOneMessage ( t *testing.T ) { ctx : = context.Background ( ) var mu sync.Mutex diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index a67dc09..726161f 100644 -- - a/internal/pubsub/driver/driver.go +++ b/internal/pubsub/driver/driver.go @ @ -77,6 +77,13 @ @ type Topic interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil error returned from SendBatch . IsRetryable ( err error ) bool + + // As allows providers to expose provider-specific types . + // + // See + // https : //github.com/google/go-cloud/blob/master/internal/docs/design.md # as + // for more background . + As ( i interface { } ) bool } // Subscription receives published messages . @ @ -116,4 +123,11 @ @ type Subscription interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil
diff -- git a/internal/pubsub/acks_test.go b/internal/pubsub/acks_test.go index 2d6d1d6..1333007 100644 -- - a/internal/pubsub/acks_test.go +++ b/internal/pubsub/acks_test.go @ @ -49,6 +49,8 @ @ func ( s *ackingDriverSub ) Close ( ) error { func ( s *ackingDriverSub ) IsRetryable ( error ) bool { return false } +func ( s *ackingDriverSub ) As ( i interface { } ) bool { return false } + func TestAckTriggersDriverSendAcksForOneMessage ( t *testing.T ) { ctx : = context.Background ( ) var mu sync.Mutex diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index a67dc09..726161f 100644 -- - a/internal/pubsub/driver/driver.go +++ b/internal/pubsub/driver/driver.go @ @ -77,6 +77,13 @ @ type Topic interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil error returned from SendBatch . IsRetryable ( err error ) bool + + // As allows providers to expose provider-specific types . + // + // See + // https : //github.com/google/go-cloud/blob/master/internal/docs/design.md # as + // for more background . + As ( i interface { } ) bool } // Subscription receives published messages . @ @ -116,4 +123,11 @ @ type Subscription interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil
diff -- git a/internal/pubsub/acks_test.go b/internal/pubsub/acks_test.go index 2d6d1d6..1333007 100644 -- - a/internal/pubsub/acks_test.go +++ b/internal/pubsub/acks_test.go @ @ -49,6 +49,8 @ @ func ( s *ackingDriverSub ) Close ( ) error { func ( s *ackingDriverSub ) IsRetryable ( error ) bool { return false } +func ( s *ackingDriverSub ) As ( i interface { } ) bool { return false } + func TestAckTriggersDriverSendAcksForOneMessage ( t *testing.T ) { ctx : = context.Background ( ) var mu sync.Mutex diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index a67dc09..726161f 100644 -- - a/internal/pubsub/driver/driver.go +++ b/internal/pubsub/driver/driver.go @ @ -77,6 +77,13 @ @ type Topic interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil error returned from SendBatch . IsRetryable ( err error ) bool + + // As allows providers to expose provider-specific types . + // + // See + // https : //github.com/google/go-cloud/blob/master/internal/docs/design.md # as + // for more background . + As ( i interface { } ) bool } // Subscription receives published messages . @ @ -116,4 +123,11 @ @ type Subscription interface { // IsRetryable should report whether err can be retried . // err will always be a non-nil
diff -- git a/blob/blob.go b/blob/blob.go index 054756e..aa152be 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -172,11 +172,22 @ @ func ( w *Writer ) open ( p [ ] byte ) ( n int , err error ) { } // ListOptions sets options for listing objects . -// TODO ( Issue # 541 ) : Add Delimiter . type ListOptions struct { // Prefix indicates that only objects with a key starting with this prefix // should be returned . Prefix string + // Delimiter sets the delimiter used to define a hierarchical namespace , + // like a filesystem with `` directories '' . + // + // An empty delimiter means that the bucket is treated as a single flat + // namespace . + // + // A non-empty delimiter means that any result with the delimiter in its key + // after Prefix is stripped will be returned with ListObject.IsDir = true , + // ListObject.Key truncated after the delimiter , and zero values for fields + // other than Key . These results represent `` directories '' . Multiple results in + // a `` directory '' are returned as a single result .
diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 01945b8..68d75bd 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -67,16 +67,20 @ @ func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sq dialerName : = fmt.Sprintf ( `` github.com/google/go-cloud/mysql/gcpmysql/ % d '' , dialerNum ) mysql.RegisterDial ( dialerName , client.Dial ) - cfg : = & mysql.Config { - Net : dialerName , - Addr : params.ProjectID + `` : '' + params.Region + `` : '' + params.Instance , - User : params.User , - Passwd : params.Password , - DBName : params.Database , - } + cfg : = makeConfig ( dialerName , params ) return sql.OpenDB ( connector ( cfg.FormatDSN ( ) ) ) , nil } +func makeConfig ( dialerName string , params *Params ) *mysql.Config { + cfg : = mysql.NewConfig ( ) + cfg.Net = dialerName + cfg.Addr = params.ProjectID + `` : '' + params.Region + `` : '' + params.Instance + cfg.User = params.User + cfg.Passwd = params.Password + cfg.DBName = params.Database + return cfg + } + var dialerCounter struct { mu sync.Mutex n int diff -- git a/mysql/cloudmysql/cloudmysql_test.go b/mysql/cloudmysql/cloudmysql_test.go new file mode 100644 index 0000000..2925e99 -- - /dev/null +++
diff -- git a/blob/blob_test.go b/blob/blob_test.go deleted file mode 100644 index 34201cf..0000000 -- - a/blob/blob_test.go +++ /dev/null @ @ -1,217 +0,0 @ @ -// Copyright 2018 The Go Cloud Authors -// -// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; -// you may not use this file except in compliance with the License . -// You may obtain a copy of the License at -// -// https : //www.apache.org/licenses/LICENSE-2.0 -// -// Unless required by applicable law or agreed to in writing , software -// distributed under the License is distributed on an `` AS IS '' BASIS , -// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . -// See the License for the specific language governing permissions and -// limitations under the License . - -package blob - -import ( - '' context '' - '' io/ioutil '' - '' path/filepath '' - '' testing '' - - '' github.com/google/go-cloud/blob/driver '' - ) - -func TestNewRangeReader ( t *testing.T ) { - t.Run ( `` EntireBlob '' , func ( t *testing.T ) { - const key = `` foo '' - spy : = new ( bucketSpy )
diff -- git a/README.md b/README.md index 2c0c5da..3613f49 100644 -- - a/README.md +++ b/README.md @ @ -15,14 +15,6 @ @ blobReader , err : = bucket.NewReader ( context.Background ( ) , `` my-blob '' ) `` ` and being able to run that code on any cloud you want , avoiding all the ceremony of cloud-specific authorization , tracing , SDKs and all the other code required to make an application portable across cloud platforms . - - # # Project status -While in alpha , the API is subject to breaking changes so is not yet suitable for production . We encourage you to experiment with Go Cloud and make contributions to help evolve it to meet your needs ! - - [ travis ] : https : //travis-ci.com/google/go-cloud - [ godoc ] : http : //godoc.org/github.com/google/go-cloud - -The GitHub repository at [ google/go-cloud ] ( https : //github.com/google/go-cloud ) currently contains [ Google Cloud Platform ] ( http : //cloud.google.com ) and [ Amazon Web Services ] ( http : //aws.amazon.com ) implementations as examples to prove everything is working . If you create a repository that implements the Go Cloud interfaces for other cloud providers , let us
diff -- git a/README.md b/README.md index 2c0c5da..3613f49 100644 -- - a/README.md +++ b/README.md @ @ -15,14 +15,6 @ @ blobReader , err : = bucket.NewReader ( context.Background ( ) , `` my-blob '' ) `` ` and being able to run that code on any cloud you want , avoiding all the ceremony of cloud-specific authorization , tracing , SDKs and all the other code required to make an application portable across cloud platforms . - - # # Project status -While in alpha , the API is subject to breaking changes so is not yet suitable for production . We encourage you to experiment with Go Cloud and make contributions to help evolve it to meet your needs ! - - [ travis ] : https : //travis-ci.com/google/go-cloud - [ godoc ] : http : //godoc.org/github.com/google/go-cloud - -The GitHub repository at [ google/go-cloud ] ( https : //github.com/google/go-cloud ) currently contains [ Google Cloud Platform ] ( http : //cloud.google.com ) and [ Amazon Web Services ] ( http : //aws.amazon.com ) implementations as examples to prove everything is working . If you create a repository that implements the Go Cloud interfaces for other cloud providers , let us
diff -- git a/README.md b/README.md index 5fd8c64..3d3459c 100644 -- - a/README.md +++ b/README.md @ @ -15,14 +15,6 @ @ blobReader , err : = bucket.NewReader ( context.Background ( ) , `` my-blob '' ) `` ` and being able to run that code on any cloud you want , avoiding all the ceremony of cloud-specific authorization , tracing , SDKs and all the other code required to make an application portable across cloud platforms . - - # # Project status -While in alpha , the API is subject to breaking changes so is not yet suitable for production . We encourage you to experiment with Go Cloud and make contributions to help evolve it to meet your needs ! - - [ travis ] : https : //travis-ci.com/google/go-cloud - [ godoc ] : http : //godoc.org/github.com/google/go-cloud - -The GitHub repository at [ google/go-cloud ] ( https : //github.com/google/go-cloud ) currently contains [ Google Cloud Platform ] ( http : //cloud.google.com ) and [ Amazon Web Services ] ( http : //aws.amazon.com ) implementations as examples to prove everything is working . If you create a repository that implements the Go Cloud interfaces for other cloud providers , let us
diff -- git a/samples/guestbook/wire_gen.go b/samples/guestbook/wire_gen.go index 5e568a1..3fbc0af 100644 -- - a/samples/guestbook/wire_gen.go +++ b/samples/guestbook/wire_gen.go @ @ -126,7 +126,7 @ @ func setupGCP ( ctx context.Context , flags *cliFlags ) ( *application , func ( ) , error } v , cleanup : = appHealthChecks ( db ) monitoredresourceInterface : = monitoredresource.Autodetect ( ) - exporter , err : = sdserver.NewExporter ( projectID , tokenSource , monitoredresourceInterface ) + exporter , cleanup2 , err : = sdserver.NewExporter ( projectID , tokenSource , monitoredresourceInterface ) if err ! = nil { cleanup ( ) return nil , nil , err @ @ -143,23 +143,27 @ @ func setupGCP ( ctx context.Context , flags *cliFlags ) ( *application , func ( ) , error serverServer : = server.New ( options ) bucket , err : = gcpBucket ( ctx , flags , httpClient ) if err ! = nil { + cleanup2 ( ) cleanup ( ) return nil , nil , err } - runtimeConfigManagerClient , cleanup2 , err : = runtimeconfigurator.Dial ( ctx , tokenSource ) + runtimeConfigManagerClient , cleanup3 , err : = runtimeconfigurator.Dial ( ctx , tokenSource ) if err ! = nil { + cleanup2 ( ) cleanup (
diff -- git a/runtimevar/constantvar/constantvar.go b/runtimevar/constantvar/constantvar.go index b589654..c36fd55 100644 -- - a/runtimevar/constantvar/constantvar.go +++ b/runtimevar/constantvar/constantvar.go @ @ -18,7 +18,6 @ @ package constantvar import ( '' context '' - '' math '' '' time '' '' github.com/google/go-cloud/runtimevar '' @ @ -37,21 +36,30 @ @ func NewError ( err error ) *runtimevar.Variable { return runtimevar.New ( & watcher { err : err } ) } -// watcher implements driver.Watcher . +// watcher implements driver.Watcher and driver.State . type watcher struct { value interface { } err error t time.Time } -func ( w *watcher ) WatchVariable ( ctx context.Context , prevVersion interface { } , prevErr error ) ( *driver.Variable , interface { } , time.Duration , error ) { +func ( w *watcher ) Value ( ) ( interface { } , error ) { + return w.value , w.err + } + +func ( w *watcher ) UpdateTime ( ) time.Time { + return w.t + } + +func ( w *watcher ) WatchVariable ( ctx context.Context , prev driver.State ) ( driver.State , time.Duration ) { // The first time this is called , return the constant value . - if prevVersion == nil & & prevErr == nil {
diff -- git a/internal/contributebot/process.go b/internal/contributebot/process.go index 68348d5..5a59d95 100644 -- - a/internal/contributebot/process.go +++ b/internal/contributebot/process.go @ @ -32,7 +32,7 @ @ const ( ) var ( - issueTitleRegexp = regexp.MustCompile ( ` ^ [ a-z0-9./- ] + : . * $ ` ) + issueTitleRegexp = regexp.MustCompile ( ` ^ ( [ a-z0-9./- ] +| [ A-Z_ ] + ) : . * $ ` ) pullRequestTitleRegexp = issueTitleRegexp )
diff -- git a/mysql/rdsmysql/example_test.go b/mysql/rdsmysql/example_test.go index 04ffabe..4dd6048 100644 -- - a/mysql/rdsmysql/example_test.go +++ b/mysql/rdsmysql/example_test.go @ @ -28,7 +28,7 @ @ func Example ( ) { User : `` myrole '' , Password : `` swordfish '' , Database : `` test '' , - } , nil ) + } ) if err ! = nil { panic ( err ) } diff -- git a/mysql/rdsmysql/rdsmysql.go b/mysql/rdsmysql/rdsmysql.go index 23d690a..867c33f 100644 -- - a/mysql/rdsmysql/rdsmysql.go +++ b/mysql/rdsmysql/rdsmysql.go @ @ -33,7 +33,6 @ @ import ( // *Params and an HTTP client . var Set = wire.NewSet ( Open , - wire.Value ( ( *Options ) ( nil ) ) , rds.CertFetcherSet , ) @ @ -49,17 +48,16 @ @ type Params struct { Password string // Database is the MySQL database name to connect to . Database string - } -type Options struct { - // This is only a placeholder so far . + // TraceOpts contains options for OpenCensus . + TraceOpts [ ] ocsql.TraceOption } // Open opens an encrypted connection to an RDS MySQL database . // // The second return value is a Wire cleanup function that calls Close on the // database and ignores the error .
diff -- git a/CONTRIBUTING.md b/CONTRIBUTING.md index 7c4f4e5..082b1e9 100644 -- - a/CONTRIBUTING.md +++ b/CONTRIBUTING.md @ @ -1,28 +1,62 @ @ # How to Contribute -We 'd love to accept your patches and contributions to this project . There are -just a few small guidelines you need to follow . +We would love to accept your patches and contributions to this project . Here is how you can help . - # # Contributor License Agreement + # # Filing issues +Filing issues is an important way you can contribute to the Go X Cloud Project . We want your feedback on things like bugs , desired API changes , or just anything that is n't working for you . -Contributions to this project must be accompanied by a Contributor License + # # # Bugs +If your issue is a bug , open one [ here ] ( https : //github.com/google/go-x-cloud/issues/new ) . The easiest way to file an issue with all the right information is to run ` go bug ` . ` go bug ` will print out a handy template of questions and system information that will help us get to the root of the issue quicker .
diff -- git a/blob/blob_test.go b/blob/blob_test.go deleted file mode 100644 index 7e427d6..0000000 -- - a/blob/blob_test.go +++ /dev/null @ @ -1,217 +0,0 @ @ -// Copyright 2018 Google LLC -// -// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; -// you may not use this file except in compliance with the License . -// You may obtain a copy of the License at -// -// https : //www.apache.org/licenses/LICENSE-2.0 -// -// Unless required by applicable law or agreed to in writing , software -// distributed under the License is distributed on an `` AS IS '' BASIS , -// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . -// See the License for the specific language governing permissions and -// limitations under the License . - -package blob - -import ( - '' context '' - '' io/ioutil '' - '' path/filepath '' - '' testing '' - - '' github.com/google/go-cloud/blob/driver '' - ) - -func TestNewRangeReader ( t *testing.T ) { - t.Run ( `` EntireBlob '' , func ( t *testing.T ) { - const key = `` foo '' - spy : = new ( bucketSpy ) - b
diff -- git a/blob/blob_test.go b/blob/blob_test.go deleted file mode 100644 index 34201cf..0000000 -- - a/blob/blob_test.go +++ /dev/null @ @ -1,217 +0,0 @ @ -// Copyright 2018 The Go Cloud Authors -// -// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; -// you may not use this file except in compliance with the License . -// You may obtain a copy of the License at -// -// https : //www.apache.org/licenses/LICENSE-2.0 -// -// Unless required by applicable law or agreed to in writing , software -// distributed under the License is distributed on an `` AS IS '' BASIS , -// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . -// See the License for the specific language governing permissions and -// limitations under the License . - -package blob - -import ( - '' context '' - '' io/ioutil '' - '' path/filepath '' - '' testing '' - - '' github.com/google/go-cloud/blob/driver '' - ) - -func TestNewRangeReader ( t *testing.T ) { - t.Run ( `` EntireBlob '' , func ( t *testing.T ) { - const key = `` foo '' - spy : = new ( bucketSpy )
diff -- git a/internal/pubsub/gcppubsub/gcppubsub.go b/internal/pubsub/gcppubsub/gcppubsub.go new file mode 100644 index 0000000..39fa6f3 -- - /dev/null +++ b/internal/pubsub/gcppubsub/gcppubsub.go @ @ -0,0 +1,133 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package gcppubsub provides an implementation of pubsub that uses GCP +// PubSub . +package gcppubsub + +import ( + '' context '' + '' fmt '' + '' time '' + + raw `` cloud.google.com/go/pubsub/apiv1 '' + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + pb `` google.golang.org/genproto/googleapis/pubsub/v1 '' + ) + +type topic struct { + path string + client *raw.PublisherClient +
diff -- git a/internal/docs/pubsub/design.md b/internal/docs/pubsub/design.md index 7c768e4..3fad6e9 100644 -- - a/internal/docs/pubsub/design.md +++ b/internal/docs/pubsub/design.md @ @ -319,8 +319,19 @ @ type Topic interface { // Subscription receives published messages . type Subscription interface { - // ReceiveBatch returns a batch of messages that have queued up for the - // subscription on the server . + // ReceiveBatch should return a batch of messages that have queued up + // for the subscription on the server . + // + // If there is a transient failure , this method should not retry but + // should return a nil slice and an error . The concrete API will take + // care of retry logic . + // + // If the service returns no messages for some other reason , this + // method should return the empty slice of messages and not attempt to + // retry . + // + // ReceiveBatch is only called sequentially for individual + // Subscriptions . ReceiveBatch ( ctx context.Context ) ( [ ] *Message , error ) // SendAcks acknowledges the messages with the given ackIDs on the diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index 5418eae..d2931b4 100644 -- - a/internal/pubsub/driver/driver.go +++
diff -- git a/blob/blob.go b/blob/blob.go index 17f6d1c..41338ea 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -154,6 +154,82 @ @ func ( w *Writer ) open ( p [ ] byte ) ( n int , err error ) { return w.w.Write ( p ) } +// MaxPageSize is the maximum number of results to retrieve at a time via List . +const MaxPageSize = 1000 + +// ListOptions sets options for listing objects in the bucket . +type ListOptions struct { + // PageSize sets the maximum number of objects that will be returned in + // a single call . Must be > = 0 and < = MaxPageSize ; 0 defaults to + // MaxPageSize . + PageSize int + // PageToken should be filled in with the NextPageToken from a previous + // List call , to get the next page of results . + // Ignored when using ListIter . + PageToken string + // Prefix indicates that only results whose key starts with this prefix + // should be returned . + Prefix string + // TODO ( rvangent ) : Add Delimiter . + } + +// ListIterator is used to iterate over ListIter
diff -- git a/blob/blob.go b/blob/blob.go index fc4a7e3..d6c5cd1 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -154,6 +154,85 @ @ func ( w *Writer ) open ( p [ ] byte ) ( n int , err error ) { return w.w.Write ( p ) } +// MaxPageSize is the maximum number of results to retrieve at a time via ListPaged . +const MaxPageSize = 1000 + +// ListOptions sets options for listing objects . +// TODO ( rvangent ) : Add Delimiter . +type ListOptions struct { + // Prefix indicates that only objects with a key starting with this prefix + // should be returned . + Prefix string + + // PageSize sets the maximum number of objects that will be returned in + // a single call to ListPaged . For List , it sets the internal buffer size . + // Must be > = 0 and < = MaxPageSize ; 0 defaults to MaxPageSize . + PageSize int + // PageToken should be filled in with the NextPageToken from a previous + // ListPaged call , to get the next page of results . + // Ignored when using List . + PageToken string +
diff -- git a/blob/blob.go b/blob/blob.go index 3bacf3a..086400c 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -171,6 +171,85 @ @ func ( w *Writer ) open ( p [ ] byte ) ( n int , err error ) { return w.w.Write ( p ) } +// MaxPageSize is the maximum number of results to retrieve at a time via ListPaged . +const MaxPageSize = 1000 + +// ListOptions sets options for listing objects . +// TODO ( Issue # 541 ) : Add Delimiter . +type ListOptions struct { + // Prefix indicates that only objects with a key starting with this prefix + // should be returned . + Prefix string + + // PageSize sets the maximum number of objects that will be returned in + // a single call to ListPaged . For List , it sets the internal buffer size . + // Must be > = 0 and < = MaxPageSize ; 0 defaults to MaxPageSize . + PageSize int + // PageToken should be filled in with the NextPageToken from a previous + // ListPaged call , to get the next page of results . + // Ignored when using List . + PageToken
diff -- git a/go.mod b/go.mod index 920aa09..403c752 100644 -- - a/go.mod +++ b/go.mod @ @ -20,6 +20,7 @ @ require ( github.com/GoogleCloudPlatform/cloudsql-proxy v0.0.0-20180321230639-1e456b1c68cb github.com/aws/aws-sdk-go v1.13.20 github.com/aws/aws-xray-sdk-go v1.0.0-rc.5 // indirect + github.com/basvanbeek/ocsql v0.0.0-20180627133915-d946a62502e3 github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b github.com/davecgh/go-spew v1.1.0 // indirect github.com/dnaeon/go-vcr v0.0.0-20180814043457-aafff18a5cc2 diff -- git a/go.sum b/go.sum index 211f490..2564c2d 100644 -- - a/go.sum +++ b/go.sum @ @ -8,6 +8,8 @ @ github.com/aws/aws-sdk-go v1.13.20 h1:86wZR5yeY4bRb7lKN6blkLabklWplUdP/V1vBiY9jN github.com/aws/aws-sdk-go v1.13.20/go.mod h1 : ZRmQr0FajVIyZ4ZzBYKG5P3ZqPz9IHG41ZoMu1ADI3k= github.com/aws/aws-xray-sdk-go v1.0.0-rc.5 h1:7a0ES/UQniY+MWQ9TQd2rxzVbeTIFfX9lLGrM+UyNxI= github.com/aws/aws-xray-sdk-go v1.0.0-rc.5/go.mod h1 : XtMKdBQfpVut+tJEwI7+dJFRxxRdxHDyVNp2tHXRq04= +github.com/basvanbeek/ocsql v0.0.0-20180627133915-d946a62502e3 h1 : BPz0f5P+D3A8FqbQjvYC/X67GjJn6OzIxhyYgGzCspI= +github.com/basvanbeek/ocsql v0.0.0-20180627133915-d946a62502e3/go.mod h1:5xGI8UcldrK//AiyiYs6Qzyos4YKCml4mlUw6XuHWPE= github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b h1 : OMcrCcLeKVHcKiZJnQJir34igQ+f9Ks8pSJaENZT9f4= github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b/go.mod h1 : icwlHTP1AjScKRxD/s/Qinb7mpbcoUPpqaiBvrSS/QI= github.com/davecgh/go-spew v1.1.0 h1 : ZDRjVQ15GmhC3fiQ8ni8+OwkZQO4DARzQgrnXU1Liz8= diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 8af2614..4e4b6dd 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -24,6 +24,7 @ @ import ( '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/proxy '' + '' github.com/basvanbeek/ocsql '' '' github.com/go-sql-driver/mysql '' '' github.com/google/go-cloud/gcp '' '' github.com/google/go-cloud/wire '' @ @ -91,5 +92,5 @ @ func ( c connector ) Connect ( context.Context ) ( driver.Conn , error ) { } func ( c connector ) Driver ( ) driver.Driver { - return mysql.MySQLDriver { } + return ocsql.Wrap ( mysql.MySQLDriver { } , ocsql.WithAllTraceOptions ( ) ) } diff -- git a/mysql/rdsmysql/rdsmysql.go b/mysql/rdsmysql/rdsmysql.go index 6d0dc23..bf811bc 100644 -- - a/mysql/rdsmysql/rdsmysql.go +++
diff -- git a/blob/blob_test.go b/blob/blob_test.go deleted file mode 100644 index 34201cf..0000000 -- - a/blob/blob_test.go +++ /dev/null @ @ -1,217 +0,0 @ @ -// Copyright 2018 The Go Cloud Authors -// -// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; -// you may not use this file except in compliance with the License . -// You may obtain a copy of the License at -// -// https : //www.apache.org/licenses/LICENSE-2.0 -// -// Unless required by applicable law or agreed to in writing , software -// distributed under the License is distributed on an `` AS IS '' BASIS , -// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . -// See the License for the specific language governing permissions and -// limitations under the License . - -package blob - -import ( - '' context '' - '' io/ioutil '' - '' path/filepath '' - '' testing '' - - '' github.com/google/go-cloud/blob/driver '' - ) - -func TestNewRangeReader ( t *testing.T ) { - t.Run ( `` EntireBlob '' , func ( t *testing.T ) { - const key = `` foo '' - spy : = new ( bucketSpy )
diff -- git a/blob/blob_test.go b/blob/blob_test.go deleted file mode 100644 index 34201cf..0000000 -- - a/blob/blob_test.go +++ /dev/null @ @ -1,217 +0,0 @ @ -// Copyright 2018 The Go Cloud Authors -// -// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; -// you may not use this file except in compliance with the License . -// You may obtain a copy of the License at -// -// https : //www.apache.org/licenses/LICENSE-2.0 -// -// Unless required by applicable law or agreed to in writing , software -// distributed under the License is distributed on an `` AS IS '' BASIS , -// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . -// See the License for the specific language governing permissions and -// limitations under the License . - -package blob - -import ( - '' context '' - '' io/ioutil '' - '' path/filepath '' - '' testing '' - - '' github.com/google/go-cloud/blob/driver '' - ) - -func TestNewRangeReader ( t *testing.T ) { - t.Run ( `` EntireBlob '' , func ( t *testing.T ) { - const key = `` foo '' - spy : = new ( bucketSpy )
diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md index 3c1d0b3..53dbbb4 100644 -- - a/samples/guestbook/README.md +++ b/samples/guestbook/README.md @ @ -79,7 +79,7 @ @ terraform init # and desired zone . terraform apply -./deploy.sh +go run ./deploy/main.go `` ` The deploy script will display the URL of your running service . diff -- git a/samples/guestbook/gcp/deploy.sh b/samples/guestbook/gcp/deploy.sh deleted file mode 100755 index e4ac35c..0000000 -- - a/samples/guestbook/gcp/deploy.sh +++ /dev/null @ @ -1,83 +0,0 @ @ - # ! /bin/bash - # Copyright 2018 Google LLC - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - # you may not use this file except in compliance with the License . - # You may obtain a copy of the License at - # - # https : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software - # distributed under the License is distributed on an `` AS IS '' BASIS , - # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . - # See the License for the specific language governing permissions and - # limitations under the License . - - # deploy.sh
diff -- git a/go.mod b/go.mod index e7805bf..496f2fa 100644 -- - a/go.mod +++ b/go.mod @ @ -14,7 +14,7 @ @ module github.com/google/go-cloud -replace cloud.google.com/go = > cloud.google.com/go v0.0.0-20180608230132-da2b80561ef3 +replace cloud.google.com/go v0.25.0 = > cloud.google.com/go v0.0.0-20180608230132-da2b80561ef3 require ( cloud.google.com/go v0.25.0 diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md index 3c1d0b3..53dbbb4 100644 -- - a/samples/guestbook/README.md +++ b/samples/guestbook/README.md @ @ -79,7 +79,7 @ @ terraform init # and desired zone . terraform apply -./deploy.sh +go run ./deploy/main.go `` ` The deploy script will display the URL of your running service . diff -- git a/samples/guestbook/aws/main.tf b/samples/guestbook/aws/main.tf index 259b272..ff8d402 100644 -- - a/samples/guestbook/aws/main.tf +++ b/samples/guestbook/aws/main.tf @ @ -82,7 +82,7 @ @ resource `` aws_db_instance '' `` guestbook '' { provisioner `` local-exec '' { # TODO ( light ) : Reuse credentials from Terraform . - command = `` cat ' $ { path.module } '/../schema.sql ' $ { path.module } '/../roles.sql | AWS_DEFAULT_REGION= ' $ { var.region } ' ' $ { path.module } '/provision-db.sh ' $ { aws_db_instance.guestbook.address } ' ' $ { aws_security_group.guestbook.id } ' guestbook ' $ { random_string.db_password.result } ' '' + command = `` cat ' $ { path.module } '/../schema.sql ' $ { path.module } '/../roles.sql | AWS_DEFAULT_REGION= ' $ {
diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md index 3c1d0b3..91f646b 100644 -- - a/samples/guestbook/README.md +++ b/samples/guestbook/README.md @ @ -30,11 +30,11 @ @ go generate & & go build # # Running Locally You will need to run a local MySQL database server , set up a directory that -simulates a bucket , and create a local message of the day . ` localdb.sh ` is a -script that runs a temporary database using Docker : +simulates a bucket , and create a local message of the day . ` localdb/main.go ` is a +program that runs a temporary database using Docker : `` ` shell -./localdb.sh +go run localdb/main.go `` ` In another terminal , you can run : @ @ -79,7 +79,7 @ @ terraform init # and desired zone . terraform apply -./deploy.sh +go run deploy/main.go `` ` The deploy script will display the URL of your running service . diff -- git a/samples/guestbook/aws/main.tf b/samples/guestbook/aws/main.tf index 5962cf0..5545a90 100644 -- - a/samples/guestbook/aws/main.tf +++ b/samples/guestbook/aws/main.tf @ @ -82,7 +82,7 @ @ resource `` aws_db_instance '' `` guestbook '' { provisioner `` local-exec '' { # TODO ( light ) : Reuse credentials from Terraform . - command = `` cat ' $ {
diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md index 3c1d0b3..91f646b 100644 -- - a/samples/guestbook/README.md +++ b/samples/guestbook/README.md @ @ -30,11 +30,11 @ @ go generate & & go build # # Running Locally You will need to run a local MySQL database server , set up a directory that -simulates a bucket , and create a local message of the day . ` localdb.sh ` is a -script that runs a temporary database using Docker : +simulates a bucket , and create a local message of the day . ` localdb/main.go ` is a +program that runs a temporary database using Docker : `` ` shell -./localdb.sh +go run localdb/main.go `` ` In another terminal , you can run : @ @ -79,7 +79,7 @ @ terraform init # and desired zone . terraform apply -./deploy.sh +go run deploy/main.go `` ` The deploy script will display the URL of your running service . diff -- git a/samples/guestbook/aws/main.tf b/samples/guestbook/aws/main.tf index 5962cf0..5545a90 100644 -- - a/samples/guestbook/aws/main.tf +++ b/samples/guestbook/aws/main.tf @ @ -82,7 +82,7 @ @ resource `` aws_db_instance '' `` guestbook '' { provisioner `` local-exec '' { # TODO ( light ) : Reuse credentials from Terraform . - command = `` cat ' $ {
diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md index 3c1d0b3..91f646b 100644 -- - a/samples/guestbook/README.md +++ b/samples/guestbook/README.md @ @ -30,11 +30,11 @ @ go generate & & go build # # Running Locally You will need to run a local MySQL database server , set up a directory that -simulates a bucket , and create a local message of the day . ` localdb.sh ` is a -script that runs a temporary database using Docker : +simulates a bucket , and create a local message of the day . ` localdb/main.go ` is a +program that runs a temporary database using Docker : `` ` shell -./localdb.sh +go run localdb/main.go `` ` In another terminal , you can run : @ @ -79,7 +79,7 @ @ terraform init # and desired zone . terraform apply -./deploy.sh +go run deploy/main.go `` ` The deploy script will display the URL of your running service . diff -- git a/samples/guestbook/aws/main.tf b/samples/guestbook/aws/main.tf index 5962cf0..5545a90 100644 -- - a/samples/guestbook/aws/main.tf +++ b/samples/guestbook/aws/main.tf @ @ -82,7 +82,7 @ @ resource `` aws_db_instance '' `` guestbook '' { provisioner `` local-exec '' { # TODO ( light ) : Reuse credentials from Terraform . - command = `` cat ' $ {
diff -- git a/README.md b/README.md index fc17a14..3dff661 100644 -- - a/README.md +++ b/README.md @ @ -1,16 +1,39 @ @ - # Go Cloud - [ ! [ Build Status ] ( https : //travis-ci.com/google/go-cloud.svg ? branch=master ) ] [ travis ] [ ! [ godoc ] ( https : //godoc.org/github.com/google/go-cloud ? status.svg ) ] [ godoc ] -This repo is a design experiment for a library making it possible to write Go -programs across multiple cloud platforms . + # The Go X Cloud Project +_Write once , run any cloud ☁️_ + +The Go X Cloud Project is an initiative that will allow application developers to seamlessly deploy cloud applications on any combination of cloud providers . It does this by providing stable , idiomatic interfaces for common uses like storage , PubSub and databases . Think ` database/sql ` for cloud . + +A key part of the project is to also provide a code generator called Wire . Wire is invoked using ` go generate ` and creates human-readable code that only imports the cloud SDKs for providers you use . This allows Go X Cloud to grow to support any number of cloud providers , without
diff -- git a/README.md b/README.md index fc17a14..3dff661 100644 -- - a/README.md +++ b/README.md @ @ -1,16 +1,39 @ @ - # Go Cloud - [ ! [ Build Status ] ( https : //travis-ci.com/google/go-cloud.svg ? branch=master ) ] [ travis ] [ ! [ godoc ] ( https : //godoc.org/github.com/google/go-cloud ? status.svg ) ] [ godoc ] -This repo is a design experiment for a library making it possible to write Go -programs across multiple cloud platforms . + # The Go X Cloud Project +_Write once , run any cloud ☁️_ + +The Go X Cloud Project is an initiative that will allow application developers to seamlessly deploy cloud applications on any combination of cloud providers . It does this by providing stable , idiomatic interfaces for common uses like storage , PubSub and databases . Think ` database/sql ` for cloud . + +A key part of the project is to also provide a code generator called Wire . Wire is invoked using ` go generate ` and creates human-readable code that only imports the cloud SDKs for providers you use . This allows Go X Cloud to grow to support any number of cloud providers , without
diff -- git a/README.md b/README.md index b4e9670..2177a3f 100644 -- - a/README.md +++ b/README.md @ @ -1,24 +1,41 @ @ - # Go X Cloud - [ ! [ Build Status ] ( https : //travis-ci.com/google/go-cloud.svg ? branch=master ) ] [ travis ] [ ! [ godoc ] ( https : //godoc.org/github.com/google/go-cloud ? status.svg ) ] [ godoc ] -This repository is a design experiment to make it possible to write Go programs -across multiple cloud platforms . + # The Go X Cloud Project +_Write once , run any cloud ☁️_ - `` ` - $ go get -u github.com/google/go-cloud +The Go X Cloud Project is an initiative that will allow application developers to seamlessly deploy cloud applications on any combination of cloud providers . It does this by providing stable , idiomatic interfaces for common uses like storage , PubSub and databases . Think ` database/sql ` for cloud . + +A key part of the project is to also provide a code generator called Wire . Wire is invoked using ` go generate ` and creates human-readable code that only imports the cloud SDKs for providers you use . This allows Go X Cloud to grow to support
diff -- git a/internal/retry/retry.go b/internal/retry/retry.go new file mode 100644 index 0000000..9ab8cc5 -- - /dev/null +++ b/internal/retry/retry.go @ @ -0,0 +1,78 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package retry provides retry logic . +package retry + +import ( + '' context '' + '' fmt '' + '' time '' + + gax `` github.com/googleapis/gax-go '' + ) + +// Call calls the supplied function f repeatedly , using the isRetryable function and +// the provided backoff parameters to control the repetition . +// +// When f returns nil ,
diff -- git a/internal/docs/pubsub/design.md b/internal/docs/pubsub/design.md index 7c768e4..3fad6e9 100644 -- - a/internal/docs/pubsub/design.md +++ b/internal/docs/pubsub/design.md @ @ -319,8 +319,19 @ @ type Topic interface { // Subscription receives published messages . type Subscription interface { - // ReceiveBatch returns a batch of messages that have queued up for the - // subscription on the server . + // ReceiveBatch should return a batch of messages that have queued up + // for the subscription on the server . + // + // If there is a transient failure , this method should not retry but + // should return a nil slice and an error . The concrete API will take + // care of retry logic . + // + // If the service returns no messages for some other reason , this + // method should return the empty slice of messages and not attempt to + // retry . + // + // ReceiveBatch is only called sequentially for individual + // Subscriptions . ReceiveBatch ( ctx context.Context ) ( [ ] *Message , error ) // SendAcks acknowledges the messages with the given ackIDs on the diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index 5418eae..4ca255c 100644 -- - a/internal/pubsub/driver/driver.go +++
diff -- git a/blob/blob.go b/blob/blob.go index 17f6d1c..f350ff4 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -61,6 +61,12 @ @ func ( r *Reader ) Size ( ) int64 { return r.r.Attributes ( ) .Size } +// As converts i to provider-specific types . +// See Bucket.As for more details . +func ( r *Reader ) As ( i interface { } ) bool { + return r.r.As ( i ) + } + // Attributes contains attributes about a blob . type Attributes struct { // ContentType is the MIME type of the blob object . It will not be empty . @ @ -76,6 +82,17 @ @ type Attributes struct { ModTime time.Time // Size is the size of the object in bytes . Size int64 + + asFunc func ( interface { } ) bool + } + +// As converts i to provider-specific types . +// See Bucket.As for more details . +func ( a *Attributes ) As ( i interface { } ) bool { + if a.asFunc == nil { + return false + } + return a.asFunc ( i ) } // Writer implements io.WriteCloser to write to blob . It must be closed
diff -- git a/blob/blob.go b/blob/blob.go index fc4a7e3..3bacf3a 100644 -- - a/blob/blob.go +++ b/blob/blob.go @ @ -61,6 +61,12 @ @ func ( r *Reader ) Size ( ) int64 { return r.r.Attributes ( ) .Size } +// As converts i to provider-specific types . +// See Bucket.As for more details . +func ( r *Reader ) As ( i interface { } ) bool { + return r.r.As ( i ) + } + // Attributes contains attributes about a blob . type Attributes struct { // ContentType is the MIME type of the blob object . It will not be empty . @ @ -76,6 +82,17 @ @ type Attributes struct { ModTime time.Time // Size is the size of the object in bytes . Size int64 + + asFunc func ( interface { } ) bool + } + +// As converts i to provider-specific types . +// See Bucket.As for more details . +func ( a *Attributes ) As ( i interface { } ) bool { + if a.asFunc == nil { + return false + } + return a.asFunc ( i ) } // Writer implements io.WriteCloser to write to blob . It must be closed
diff -- git a/.travis.yml b/.travis.yml index c5a93e8..6b7d23a 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -25,4 +25,4 @ @ install : script : # TRAVIS_PULL_REQUEST is set to `` false '' for branch builds , and the PR number # for pull request builds . Branch builds should test everything . - - 'if [ [ `` $ TRAVIS_PULL_REQUEST '' ! = false ] ] ; then testing/checkpr.sh -short -race ; else vgo test -short -race ./ ... ; fi' + - 'if [ [ `` $ TRAVIS_PULL_REQUEST '' ! = false ] ] ; then internal/testing/checkpr.sh -short -race ; else vgo test -short -race ./ ... ; fi' diff -- git a/blob/s3blob/s3blob_test.go b/blob/s3blob/s3blob_test.go index 7aafeb2..58cde5c 100644 -- - a/blob/s3blob/s3blob_test.go +++ b/blob/s3blob/s3blob_test.go @ @ -27,7 +27,7 @ @ import ( '' github.com/aws/aws-sdk-go/service/s3/s3manager '' '' github.com/google/go-x-cloud/blob '' '' github.com/google/go-x-cloud/blob/s3blob '' - '' github.com/google/go-x-cloud/testing/setup '' + '' github.com/google/go-x-cloud/internal/testing/setup '' '' github.com/google/go-cmp/cmp '' ) diff -- git a/internal/testing/checkpr.sh b/internal/testing/checkpr.sh new file mode 100755 index 0000000..ab06b38 -- - /dev/null +++ b/internal/testing/checkpr.sh @ @ -0,0 +1,69 @ @ + # ! /usr/bin/env bash + # Copyright 2018 Google LLC + # + # Licensed under the Apache License , Version 2.0 ( the `` License
diff -- git a/blob/gcsblob/gcsblob_test.go b/blob/gcsblob/gcsblob_test.go index 1382dc3..62126f3 100644 -- - a/blob/gcsblob/gcsblob_test.go +++ b/blob/gcsblob/gcsblob_test.go @ @ -72,18 +72,17 @ @ func TestNewBucketNaming ( t *testing.T ) { } ctx : = context.Background ( ) - gcsC , done , err : = newGCSClient ( ctx , t.Logf , `` test-naming '' ) - if err ! = nil { - t.Fatal ( err ) - } - defer done ( ) - c , err : = storage.NewClient ( ctx , option.WithHTTPClient ( & gcsC.Client ) ) - if err ! = nil { - t.Fatal ( err ) - } - for _ , tc : = range tests { t.Run ( tc.name , func ( t *testing.T ) { + gcsC , done , err : = newGCSClient ( ctx , t ) + if err ! = nil { + t.Fatal ( err ) + } + defer done ( ) + c , err : = storage.NewClient ( ctx , option.WithHTTPClient ( & gcsC.Client ) ) + if err ! = nil { + t.Fatal ( err ) + } b : = c.Bucket ( fmt.Sprintf ( `` % s- % s '' , bucketPrefix , tc.bucketName
diff -- git a/internal/contributebot/DESIGN.md b/internal/contributebot/DESIGN.md new file mode 100644 index 0000000..e8162e2 -- - /dev/null +++ b/internal/contributebot/DESIGN.md @ @ -0,0 +1,248 @ @ + # Go Cloud Contribute Bot Design + +Author : [ @ zombiezen ] [ ] < br > +Date : 2018-08-01 < br > +Part of [ # 216 ] [ ] + + [ @ zombiezen ] : https : //github.com/zombiezen + [ # 216 ] : https : //github.com/google/go-cloud/issues/216 + + # # Objective + +As a maintainer of Go Cloud , there are a number of conventions about format of +issues , pull requests , and commits that keep the project tidy and easy to +navigate . However , new contributors ( and even seasoned contributors ) forget to +meet these conventions . It adds toil for maintainers of Go Cloud to correct +contributions to match these conventions . The objective is to eliminate +maintainer toil by notifying contributors of convention violations ( or even +correcting them automatically where possible ) . + + # # Overview + +To reduce maintainer toil , this document proposes a [ GitHub Application ] [ ] that +does various checks . The bot will check the following
diff -- git a/.gitignore b/.gitignore index 83ab8ee..b1f0c4b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -17,6 +17,7 @ @ /vendor/ # Populated config files +internal/contributebot/webhook/app.yaml tests/gcp/app/gcp-test.yaml # Cryptographic keys diff -- git a/internal/contributebot/README.md b/internal/contributebot/README.md new file mode 100644 index 0000000..091a0b3 -- - /dev/null +++ b/internal/contributebot/README.md @ @ -0,0 +1,5 @ @ + # Contribute Bot + +Contribute Bot is a small service ( written using Go Cloud ! ) that performs +automated checks on issues and pull requests to help keep contributions +organized and easy to triage for maintainers . diff -- git a/internal/contributebot/main.tf b/internal/contributebot/main.tf new file mode 100644 index 0000000..32b5c3f -- - /dev/null +++ b/internal/contributebot/main.tf @ @ -0,0 +1,53 @ @ + # Copyright 2018 Google LLC + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # https : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS ''
diff -- git a/.gitignore b/.gitignore index c6a398e..9c444cd 100644 -- - a/.gitignore +++ b/.gitignore @ @ -21,8 +21,9 @ @ vendor/ # Populated config files -internal/contributebot/webhook/app.yaml -tests/gcp/app/gcp-test.yaml +/internal/contributebot/k8s/*.yaml +/internal/contributebot/webhook/app.yaml +/tests/gcp/app/gcp-test.yaml # Cryptographic keys *.pem diff -- git a/internal/contributebot/Dockerfile b/internal/contributebot/Dockerfile new file mode 100644 index 0000000..39ec53f -- - /dev/null +++ b/internal/contributebot/Dockerfile @ @ -0,0 +1,29 @ @ + # Copyright 2018 The Go Cloud Authors + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # https : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + + # This Dockerfile expects to have the context of the whole repository . + + # Step
diff -- git a/internal/pubsub/mempubsub/mem.go b/internal/pubsub/mempubsub/mem.go index f76b34e..cc643e6 100644 -- - a/internal/pubsub/mempubsub/mem.go +++ b/internal/pubsub/mempubsub/mem.go @ @ -25,10 +25,27 @ @ import ( '' sync '' '' time '' + '' github.com/google/go-cloud/internal/pubsub '' '' github.com/google/go-cloud/internal/pubsub/driver '' ) +type Broker struct { + mu sync.Mutex + topics map [ string ] *topic + } + +func NewBroker ( topicNames [ ] string ) *Broker { + topics : = map [ string ] *topic { } + for _ , n : = range topicNames { + topics [ n ] = newTopic ( n ) + } + return & Broker { + topics : topics , + } + } + type topic struct { + name string mu sync.Mutex subs [ ] *subscription nextAckID int @ @ -37,8 +54,14 @ @ type topic struct { // OpenTopic establishes a new topic . // Open subscribers for the topic before publishing . -func OpenTopic ( ) driver.Topic { - return & topic { } +func OpenTopic ( ctx context.Context , b *Broker , name string ) *pubsub.Topic { + b.mu.Lock ( ) + defer b.mu.Unlock ( ) + return pubsub.NewTopic ( ctx , b.topics [ name ] ) + } +
diff -- git a/internal/pubsub/example_test.go b/internal/pubsub/example_test.go index 0c6d738..e722faa 100644 -- - a/internal/pubsub/example_test.go +++ b/internal/pubsub/example_test.go @ @ -28,11 +28,10 @ @ import ( func Example_sendReceive ( ) { // Open a topic and corresponding subscription . ctx : = context.Background ( ) - dt : = mempubsub.OpenTopic ( ) - ds : = mempubsub.OpenSubscription ( dt , time.Second ) - t : = pubsub.NewTopic ( dt ) + b : = mempubsub.NewBroker ( [ ] string { `` t '' } ) + t : = mempubsub.OpenTopic ( b , `` t '' ) defer t.Close ( ) - s : = pubsub.NewSubscription ( ds ) + s : = mempubsub.OpenSubscription ( b , `` t '' , time.Second ) defer s.Close ( ) // Send a message to the topic . @ @ -59,11 +58,10 @ @ func Example_sendReceive ( ) { func Example_sendReceiveMultipleMessages ( ) { // Open a topic and corresponding subscription . ctx : = context.Background ( ) - dt : = mempubsub.OpenTopic ( ) - ds : = mempubsub.OpenSubscription ( dt , time.Second ) - t : = pubsub.NewTopic ( dt ) + b : = mempubsub.NewBroker ( [ ] string { `` t '' } )
diff -- git a/internal/pubsub/example_test.go b/internal/pubsub/example_test.go index 0c6d738..d1f7511 100644 -- - a/internal/pubsub/example_test.go +++ b/internal/pubsub/example_test.go @ @ -28,11 +28,10 @ @ import ( func Example_sendReceive ( ) { // Open a topic and corresponding subscription . ctx : = context.Background ( ) - dt : = mempubsub.OpenTopic ( ) - ds : = mempubsub.OpenSubscription ( dt , time.Second ) - t : = pubsub.NewTopic ( dt ) + b : = mempubsub.NewBroker ( [ ] string { `` myTopic '' } ) + t : = mempubsub.OpenTopic ( b , `` myTopic '' ) defer t.Close ( ) - s : = pubsub.NewSubscription ( ds ) + s : = mempubsub.OpenSubscription ( b , `` myTopic '' , time.Second ) defer s.Close ( ) // Send a message to the topic . @ @ -59,11 +58,10 @ @ func Example_sendReceive ( ) { func Example_sendReceiveMultipleMessages ( ) { // Open a topic and corresponding subscription . ctx : = context.Background ( ) - dt : = mempubsub.OpenTopic ( ) - ds : = mempubsub.OpenSubscription ( dt , time.Second ) - t : = pubsub.NewTopic ( dt ) + b : = mempubsub.NewBroker ( [ ] string { `` myTopic '' } )
diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index 62cef0e..168a553 100644 -- - a/internal/pubsub/driver/driver.go +++ b/internal/pubsub/driver/driver.go @ @ -20,6 +20,16 @ @ import ( '' context '' ) +// Batcher should gather items into batches to be sent to the pubsub service . +type Batcher interface { + // Add should add an item to the batcher . + Add ( ctx context.Context , item interface { } ) error + + // Shutdown should wait for all active calls to Add to finish , then + // return . After Shutdown is called , all calls to Add should fail . + Shutdown ( ) + } + // AckID is the identifier of a message for purposes of acknowledgement . type AckID interface { } diff -- git a/internal/pubsub/pubsub.go b/internal/pubsub/pubsub.go index fcb8885..78125ac 100644 -- - a/internal/pubsub/pubsub.go +++ b/internal/pubsub/pubsub.go @ @ -17,12 +17,11 @ @ import ( '' context '' '' errors '' '' sync '' - '' time '' + '' github.com/google/go-cloud/internal/batcher '' '' github.com/google/go-cloud/internal/pubsub/driver '' '' github.com/google/go-cloud/internal/retry '' gax `` github.com/googleapis/gax-go '' - '' google.golang.org/api/support/bundler '' ) // Message contains data to be published . @ @ -41,13 +40,13 @ @ type Message struct { // sent again to the
diff -- git a/internal/pubsub/gcppubsub/gcppubsub.go b/internal/pubsub/gcppubsub/gcppubsub.go new file mode 100644 index 0000000..1c78054 -- - /dev/null +++ b/internal/pubsub/gcppubsub/gcppubsub.go @ @ -0,0 +1,111 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package gcppubsub provides an implementation of pubsub that uses GCP +// PubSub . +package gcppubsub + +import ( + '' context '' + '' fmt '' + + rawgcppubsub `` cloud.google.com/go/pubsub/apiv1 '' + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + pubsubpb `` google.golang.org/genproto/googleapis/pubsub/v1 '' + ) + +type topic struct { + path string + client *rawgcppubsub.PublisherClient + } + +func (
diff -- git a/internal/pubsub/gcppubsub/gcppubsub.go b/internal/pubsub/gcppubsub/gcppubsub.go new file mode 100644 index 0000000..39fa6f3 -- - /dev/null +++ b/internal/pubsub/gcppubsub/gcppubsub.go @ @ -0,0 +1,133 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package gcppubsub provides an implementation of pubsub that uses GCP +// PubSub . +package gcppubsub + +import ( + '' context '' + '' fmt '' + '' time '' + + raw `` cloud.google.com/go/pubsub/apiv1 '' + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + pb `` google.golang.org/genproto/googleapis/pubsub/v1 '' + ) + +type topic struct { + path string + client *raw.PublisherClient +
diff -- git a/internal/pubsub/gcppubsub/gcppubsub.go b/internal/pubsub/gcppubsub/gcppubsub.go new file mode 100644 index 0000000..39fa6f3 -- - /dev/null +++ b/internal/pubsub/gcppubsub/gcppubsub.go @ @ -0,0 +1,133 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package gcppubsub provides an implementation of pubsub that uses GCP +// PubSub . +package gcppubsub + +import ( + '' context '' + '' fmt '' + '' time '' + + raw `` cloud.google.com/go/pubsub/apiv1 '' + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + pb `` google.golang.org/genproto/googleapis/pubsub/v1 '' + ) + +type topic struct { + path string + client *raw.PublisherClient +
diff -- git a/internal/pubsub/gcppubsub/gcppubsub.go b/internal/pubsub/gcppubsub/gcppubsub.go new file mode 100644 index 0000000..fa7ab43 -- - /dev/null +++ b/internal/pubsub/gcppubsub/gcppubsub.go @ @ -0,0 +1,143 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package gcppubsub provides an implementation of pubsub that uses GCP +// PubSub . +package gcppubsub + +import ( + '' context '' + '' fmt '' + '' time '' + + raw `` cloud.google.com/go/pubsub/apiv1 '' + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + pb `` google.golang.org/genproto/googleapis/pubsub/v1 '' + ) + +type topic struct { + path string + client *raw.PublisherClient +
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 2019ddc..d41d9f3 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -53,12 +53,6 @ @ func RunConformanceTests ( t *testing.T , newHarness HarnessMaker ) { t.Run ( `` TestSendReceive '' , func ( t *testing.T ) { testSendReceive ( t , newHarness ) } ) - t.Run ( `` TestErrorOnSendToClosedTopic '' , func ( t *testing.T ) { - testErrorOnSendToClosedTopic ( t , newHarness ) - } ) - t.Run ( `` TestErrorOnReceiveFromClosedSubscription '' , func ( t *testing.T ) { - testErrorOnReceiveFromClosedSubscription ( t , newHarness ) - } ) t.Run ( `` TestCancelSendReceive '' , func ( t *testing.T ) { testCancelSendReceive ( t , newHarness ) } ) @ @ -108,47 +102,6 @ @ func testSendReceive ( t *testing.T , newHarness HarnessMaker ) { } } -func testErrorOnSendToClosedTopic ( t *testing.T , newHarness HarnessMaker ) { - // Set up . - ctx : = context.Background ( ) - h , err : = newHarness ( ctx , t ) - if err ! = nil { - t.Fatal ( err ) - } - defer h.Close ( ) - top , _ , cleanup , err : = makePair ( ctx ,
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 3292b80..dfedaf7 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -35,10 +35,18 @ @ type Harness interface { // MakeTopic makes a driver.Topic for testing . MakeTopic ( ctx context.Context ) ( driver.Topic , error ) + // MakeNonexistentTopic makes a driver.Topic referencing a topic that + // does not exist . + MakeNonexistentTopic ( ctx context.Context ) ( driver.Topic , error ) + // MakeSubscription makes a driver.Subscription subscribed to the given // driver.Topic . MakeSubscription ( ctx context.Context , t driver.Topic ) ( driver.Subscription , error ) + // MakeNonexistentSubscription makes a driver.Subscription referencing a + // subscription that does not exist . + MakeNonexistentSubscription ( ctx context.Context ) ( driver.Subscription , error ) + // Close closes resources used by the harness , but does not call Close // on the Topics and Subscriptions generated by the Harness . Close ( ) @ @ -62,6 +70,61 @ @ func RunConformanceTests ( t *testing.T , newHarness HarnessMaker ) { t.Run ( `` TestCancelSendReceive '' , func ( t *testing.T ) { testCancelSendReceive ( t , newHarness ) } ) + t.Run ( `` TestNonExistentTopicSucceedsOnOpenButFailsOnSend '' , func ( t *testing.T ) { +
diff -- git a/internal/pubsub/mempubsub/mem.go b/internal/pubsub/mempubsub/mem.go index 8ce73bd..8a578f4 100644 -- - a/internal/pubsub/mempubsub/mem.go +++ b/internal/pubsub/mempubsub/mem.go @ @ -29,6 +29,8 @ @ import ( '' github.com/google/go-cloud/internal/pubsub/driver '' ) +var errNotExist = errors.New ( `` mempubsub : topic does not exist '' ) + type Broker struct { mu sync.Mutex topics map [ string ] *topic @ @ -64,14 +66,14 @ @ func OpenTopic ( b *Broker , name string ) *pubsub.Topic { // SendBatch implements driver.Topic.SendBatch . // It is error if the topic is closed or has no subscriptions . func ( t *topic ) SendBatch ( ctx context.Context , ms [ ] *driver.Message ) error { + if err : = ctx.Err ( ) ; err ! = nil { + return err + } + if t == nil { + return errNotExist + } t.mu.Lock ( ) defer t.mu.Unlock ( ) - // Check for canceled before doing any work . - select { - case < -ctx.Done ( ) : - return ctx.Err ( ) - default : - } // Associate ack IDs with messages here . It would be a bit better if each subscription's // messages had their own ack IDs , so we could
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..5592081 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -37,3 +37,17 @ @ var Services = wire.NewSet ( gcp.NewHTTPClient , runtimeconfigurator.Set , sdserver.Set ) + +// GAE is a Wire provider set , similar to the GCP Wire provider +// set except that GAEServices is used instead of Services . +var GAE = wire.NewSet ( GAEServices , gcp.DefaultIdentity ) + +// GAEServices is a Wire provider set , similar to Services +// except that cloudmysql.OpenGAE is used instead of cloudmysql.Open . +var GAEServices = wire.NewSet ( + cloudmysql.CertSourceSet , + cloudmysql.OpenGAE , + gcp.DefaultTransport , + gcp.NewHTTPClient , + runtimeconfigurator.Set , + sdserver.Set ) diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..b4e0dad 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -67,7 +69,6 @ @ func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sq } dialerName : = fmt.Sprintf ( `` github.com/google/go-cloud/mysql/gcpmysql/ % d '' , dialerNum ) mysql.RegisterDial ( dialerName , client.Dial ) - cfg :
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..5592081 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -37,3 +37,17 @ @ var Services = wire.NewSet ( gcp.NewHTTPClient , runtimeconfigurator.Set , sdserver.Set ) + +// GAE is a Wire provider set , similar to the GCP Wire provider +// set except that GAEServices is used instead of Services . +var GAE = wire.NewSet ( GAEServices , gcp.DefaultIdentity ) + +// GAEServices is a Wire provider set , similar to Services +// except that cloudmysql.OpenGAE is used instead of cloudmysql.Open . +var GAEServices = wire.NewSet ( + cloudmysql.CertSourceSet , + cloudmysql.OpenGAE , + gcp.DefaultTransport , + gcp.NewHTTPClient , + runtimeconfigurator.Set , + sdserver.Set ) diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..b4e0dad 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -67,7 +69,6 @ @ func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sq } dialerName : = fmt.Sprintf ( `` github.com/google/go-cloud/mysql/gcpmysql/ % d '' , dialerNum ) mysql.RegisterDial ( dialerName , client.Dial ) - cfg :
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..5592081 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -37,3 +37,17 @ @ var Services = wire.NewSet ( gcp.NewHTTPClient , runtimeconfigurator.Set , sdserver.Set ) + +// GAE is a Wire provider set , similar to the GCP Wire provider +// set except that GAEServices is used instead of Services . +var GAE = wire.NewSet ( GAEServices , gcp.DefaultIdentity ) + +// GAEServices is a Wire provider set , similar to Services +// except that cloudmysql.OpenGAE is used instead of cloudmysql.Open . +var GAEServices = wire.NewSet ( + cloudmysql.CertSourceSet , + cloudmysql.OpenGAE , + gcp.DefaultTransport , + gcp.NewHTTPClient , + runtimeconfigurator.Set , + sdserver.Set ) diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..b4e0dad 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -67,7 +69,6 @ @ func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sq } dialerName : = fmt.Sprintf ( `` github.com/google/go-cloud/mysql/gcpmysql/ % d '' , dialerNum ) mysql.RegisterDial ( dialerName , client.Dial ) - cfg :
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..5592081 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -37,3 +37,17 @ @ var Services = wire.NewSet ( gcp.NewHTTPClient , runtimeconfigurator.Set , sdserver.Set ) + +// GAE is a Wire provider set , similar to the GCP Wire provider +// set except that GAEServices is used instead of Services . +var GAE = wire.NewSet ( GAEServices , gcp.DefaultIdentity ) + +// GAEServices is a Wire provider set , similar to Services +// except that cloudmysql.OpenGAE is used instead of cloudmysql.Open . +var GAEServices = wire.NewSet ( + cloudmysql.CertSourceSet , + cloudmysql.OpenGAE , + gcp.DefaultTransport , + gcp.NewHTTPClient , + runtimeconfigurator.Set , + sdserver.Set ) diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..b4e0dad 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -67,7 +69,6 @ @ func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sq } dialerName : = fmt.Sprintf ( `` github.com/google/go-cloud/mysql/gcpmysql/ % d '' , dialerNum ) mysql.RegisterDial ( dialerName , client.Dial ) - cfg :
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..35ee2c8 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -31,8 +31,21 @ @ var GCP = wire.NewSet ( Services , gcp.DefaultIdentity ) // Google Cloud Platform services in this repository , but does not include // credentials . Individual services may require additional configuration . var Services = wire.NewSet ( - cloudmysql.CertSourceSet , cloudmysql.Open , + sharedServices ) + +// GAE is a Wire provider set , similar to the GCP Wire provider +// set but intended for use with GAE ( Google App Engine ) . +var GAE = wire.NewSet ( GAEServices , gcp.DefaultIdentity ) + +// GAEServices is a Wire provider set , similar to Services +// except that cloudmysql.OpenGAE is used instead of cloudmysql.Open . +var GAEServices = wire.NewSet ( + cloudmysql.OpenGAE , + sharedServices ) + +var sharedServices = wire.NewSet ( + cloudmysql.CertSourceSet , gcp.DefaultTransport , gcp.NewHTTPClient , runtimeconfigurator.Set , diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..023c5fb 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -67,7
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..e306c0c 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -31,8 +31,8 @ @ var GCP = wire.NewSet ( Services , gcp.DefaultIdentity ) // Google Cloud Platform services in this repository , but does not include // credentials . Individual services may require additional configuration . var Services = wire.NewSet ( - cloudmysql.CertSourceSet , cloudmysql.Open , + cloudmysql.CertSourceSet , gcp.DefaultTransport , gcp.NewHTTPClient , runtimeconfigurator.Set , diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..247a872 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -57,6 +59,13 @ @ type Params struct { // Open opens a Cloud SQL database . func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sql.DB , error ) { + if os.Getenv ( `` GAE_ENV '' ) == `` standard '' { + return openGAE ( ctx , params ) + } + return open ( ctx , certSource , params ) + } + +func open ( ctx context.Context , certSource proxy.CertSource , params *Params
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..e306c0c 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -31,8 +31,8 @ @ var GCP = wire.NewSet ( Services , gcp.DefaultIdentity ) // Google Cloud Platform services in this repository , but does not include // credentials . Individual services may require additional configuration . var Services = wire.NewSet ( - cloudmysql.CertSourceSet , cloudmysql.Open , + cloudmysql.CertSourceSet , gcp.DefaultTransport , gcp.NewHTTPClient , runtimeconfigurator.Set , diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..247a872 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -57,6 +59,13 @ @ type Params struct { // Open opens a Cloud SQL database . func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sql.DB , error ) { + if os.Getenv ( `` GAE_ENV '' ) == `` standard '' { + return openGAE ( ctx , params ) + } + return open ( ctx , certSource , params ) + } + +func open ( ctx context.Context , certSource proxy.CertSource , params *Params
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..e306c0c 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -31,8 +31,8 @ @ var GCP = wire.NewSet ( Services , gcp.DefaultIdentity ) // Google Cloud Platform services in this repository , but does not include // credentials . Individual services may require additional configuration . var Services = wire.NewSet ( - cloudmysql.CertSourceSet , cloudmysql.Open , + cloudmysql.CertSourceSet , gcp.DefaultTransport , gcp.NewHTTPClient , runtimeconfigurator.Set , diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..7e3816c 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -56,7 +58,14 @ @ type Params struct { } // Open opens a Cloud SQL database . -func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sql.DB , error ) { +func Open ( ctx context.Context , certSource proxy.CertSource , params *Params , traceOpts ocsql.TraceOption ) ( *sql.DB , error ) { + if os.Getenv ( `` GAE_ENV '' ) == `` standard '' { + return openGAE ( ctx , params , traceOpts ) + }
diff -- git a/go.mod b/go.mod index 920aa09..403c752 100644 -- - a/go.mod +++ b/go.mod @ @ -20,6 +20,7 @ @ require ( github.com/GoogleCloudPlatform/cloudsql-proxy v0.0.0-20180321230639-1e456b1c68cb github.com/aws/aws-sdk-go v1.13.20 github.com/aws/aws-xray-sdk-go v1.0.0-rc.5 // indirect + github.com/basvanbeek/ocsql v0.0.0-20180627133915-d946a62502e3 github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b github.com/davecgh/go-spew v1.1.0 // indirect github.com/dnaeon/go-vcr v0.0.0-20180814043457-aafff18a5cc2 diff -- git a/go.sum b/go.sum index 211f490..2564c2d 100644 -- - a/go.sum +++ b/go.sum @ @ -8,6 +8,8 @ @ github.com/aws/aws-sdk-go v1.13.20 h1:86wZR5yeY4bRb7lKN6blkLabklWplUdP/V1vBiY9jN github.com/aws/aws-sdk-go v1.13.20/go.mod h1 : ZRmQr0FajVIyZ4ZzBYKG5P3ZqPz9IHG41ZoMu1ADI3k= github.com/aws/aws-xray-sdk-go v1.0.0-rc.5 h1:7a0ES/UQniY+MWQ9TQd2rxzVbeTIFfX9lLGrM+UyNxI= github.com/aws/aws-xray-sdk-go v1.0.0-rc.5/go.mod h1 : XtMKdBQfpVut+tJEwI7+dJFRxxRdxHDyVNp2tHXRq04= +github.com/basvanbeek/ocsql v0.0.0-20180627133915-d946a62502e3 h1 : BPz0f5P+D3A8FqbQjvYC/X67GjJn6OzIxhyYgGzCspI= +github.com/basvanbeek/ocsql v0.0.0-20180627133915-d946a62502e3/go.mod h1:5xGI8UcldrK//AiyiYs6Qzyos4YKCml4mlUw6XuHWPE= github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b h1 : OMcrCcLeKVHcKiZJnQJir34igQ+f9Ks8pSJaENZT9f4= github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b/go.mod h1 : icwlHTP1AjScKRxD/s/Qinb7mpbcoUPpqaiBvrSS/QI= github.com/davecgh/go-spew v1.1.0 h1 : ZDRjVQ15GmhC3fiQ8ni8+OwkZQO4DARzQgrnXU1Liz8= diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 8af2614..4e4b6dd 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -24,6 +24,7 @ @ import ( '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/proxy '' + '' github.com/basvanbeek/ocsql '' '' github.com/go-sql-driver/mysql '' '' github.com/google/go-cloud/gcp '' '' github.com/google/go-cloud/wire '' @ @ -91,5 +92,5 @ @ func ( c connector ) Connect ( context.Context ) ( driver.Conn , error ) { } func ( c connector ) Driver ( ) driver.Driver { - return mysql.MySQLDriver { } + return ocsql.Wrap ( mysql.MySQLDriver { } , ocsql.WithAllTraceOptions ( ) ) } diff -- git a/mysql/rdsmysql/rdsmysql.go b/mysql/rdsmysql/rdsmysql.go index 6d0dc23..bf811bc 100644 -- - a/mysql/rdsmysql/rdsmysql.go +++
diff -- git a/go.mod b/go.mod index 920aa09..403c752 100644 -- - a/go.mod +++ b/go.mod @ @ -20,6 +20,7 @ @ require ( github.com/GoogleCloudPlatform/cloudsql-proxy v0.0.0-20180321230639-1e456b1c68cb github.com/aws/aws-sdk-go v1.13.20 github.com/aws/aws-xray-sdk-go v1.0.0-rc.5 // indirect + github.com/basvanbeek/ocsql v0.0.0-20180627133915-d946a62502e3 github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b github.com/davecgh/go-spew v1.1.0 // indirect github.com/dnaeon/go-vcr v0.0.0-20180814043457-aafff18a5cc2 diff -- git a/go.sum b/go.sum index 211f490..2564c2d 100644 -- - a/go.sum +++ b/go.sum @ @ -8,6 +8,8 @ @ github.com/aws/aws-sdk-go v1.13.20 h1:86wZR5yeY4bRb7lKN6blkLabklWplUdP/V1vBiY9jN github.com/aws/aws-sdk-go v1.13.20/go.mod h1 : ZRmQr0FajVIyZ4ZzBYKG5P3ZqPz9IHG41ZoMu1ADI3k= github.com/aws/aws-xray-sdk-go v1.0.0-rc.5 h1:7a0ES/UQniY+MWQ9TQd2rxzVbeTIFfX9lLGrM+UyNxI= github.com/aws/aws-xray-sdk-go v1.0.0-rc.5/go.mod h1 : XtMKdBQfpVut+tJEwI7+dJFRxxRdxHDyVNp2tHXRq04= +github.com/basvanbeek/ocsql v0.0.0-20180627133915-d946a62502e3 h1 : BPz0f5P+D3A8FqbQjvYC/X67GjJn6OzIxhyYgGzCspI= +github.com/basvanbeek/ocsql v0.0.0-20180627133915-d946a62502e3/go.mod h1:5xGI8UcldrK//AiyiYs6Qzyos4YKCml4mlUw6XuHWPE= github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b h1 : OMcrCcLeKVHcKiZJnQJir34igQ+f9Ks8pSJaENZT9f4= github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b/go.mod h1 : icwlHTP1AjScKRxD/s/Qinb7mpbcoUPpqaiBvrSS/QI= github.com/davecgh/go-spew v1.1.0 h1 : ZDRjVQ15GmhC3fiQ8ni8+OwkZQO4DARzQgrnXU1Liz8= diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 8af2614..4e4b6dd 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -24,6 +24,7 @ @ import ( '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/proxy '' + '' github.com/basvanbeek/ocsql '' '' github.com/go-sql-driver/mysql '' '' github.com/google/go-cloud/gcp '' '' github.com/google/go-cloud/wire '' @ @ -91,5 +92,5 @ @ func ( c connector ) Connect ( context.Context ) ( driver.Conn , error ) { } func ( c connector ) Driver ( ) driver.Driver { - return mysql.MySQLDriver { } + return ocsql.Wrap ( mysql.MySQLDriver { } , ocsql.WithAllTraceOptions ( ) ) } diff -- git a/mysql/rdsmysql/rdsmysql.go b/mysql/rdsmysql/rdsmysql.go index 6d0dc23..bf811bc 100644 -- - a/mysql/rdsmysql/rdsmysql.go +++
diff -- git a/aws/awscloud/awscloud.go b/aws/awscloud/awscloud.go index 0949a58..023cd77 100644 -- - a/aws/awscloud/awscloud.go +++ b/aws/awscloud/awscloud.go @ @ -19,7 +19,7 @ @ import ( '' net/http '' '' github.com/google/go-cloud/aws '' - '' github.com/google/go-cloud/mysql/rdsmysql '' + '' github.com/google/go-cloud/aws/rds '' '' github.com/google/go-cloud/runtimevar/paramstore '' '' github.com/google/go-cloud/server/xrayserver '' '' github.com/google/go-cloud/wire '' @ @ -38,6 +38,6 @ @ var AWS = wire.NewSet ( // AWS set , does not include credentials . Individual services may require // additional configuration . var Services = wire.NewSet ( - rdsmysql.Set , + rds.CertFetcherSet , paramstore.NewClient , xrayserver.Set ) diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index af26319..d2605fa 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -17,7 +17,7 @ @ package gcpcloud import ( '' github.com/google/go-cloud/gcp '' - '' github.com/google/go-cloud/mysql/cloudmysql '' + '' github.com/google/go-cloud/gcp/cloudsql '' '' github.com/google/go-cloud/runtimevar/runtimeconfigurator '' '' github.com/google/go-cloud/server/sdserver '' '' github.com/google/go-cloud/wire '' @ @ -31,8 +31,7 @ @ var GCP = wire.NewSet ( Services , gcp.DefaultIdentity ) // Google Cloud Platform services in this repository , but does not include // credentials . Individual services may require additional configuration . var Services = wire.NewSet ( - cloudmysql.CertSourceSet , - cloudmysql.Open , + cloudsql.CertSourceSet , gcp.DefaultTransport , gcp.NewHTTPClient , runtimeconfigurator.Set , diff -- git a/samples/guestbook/inject_aws.go b/samples/guestbook/inject_aws.go index e9c4abc..0321d89 100644 -- - a/samples/guestbook/inject_aws.go +++
diff -- git a/postgres/cloudpostgres/cloudpostgres.go b/postgres/cloudpostgres/cloudpostgres.go index 466a2d9..6941ad2 100644 -- - a/postgres/cloudpostgres/cloudpostgres.go +++ b/postgres/cloudpostgres/cloudpostgres.go @ @ -26,6 +26,7 @ @ import ( '' net/url '' '' time '' + '' contrib.go.opencensus.io/integrations/ocsql '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/proxy '' '' github.com/lib/pq '' ) @ @ -50,6 +51,9 @ @ type Params struct { // Values sets additional parameters , as documented in // https : //www.postgresql.org/docs/current/libpq-connect.html # LIBPQ-PARAMKEYWORDS . Values url.Values + + // TraceOpts contains options for OpenCensus . + TraceOpts [ ] ocsql.TraceOption } // Open opens a Cloud SQL database . @ @ -84,36 +88,44 @ @ func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sq Port : 3307 , Certs : certSource , } , - instance : params.ProjectID + `` : '' + params.Region + `` : '' + params.Instance , - pqConn : u.String ( ) , + instance : params.ProjectID + `` : '' + params.Region + `` : '' + params.Instance , + pqConn : u.String ( ) , + traceOpts : append ( [ ] ocsql.TraceOption ( nil ) , params.TraceOpts ... ) , } ) , nil } type pqDriver struct { - client *proxy.Client - instance string + client
diff -- git a/pubsub/fakepubsub/example_test.go b/pubsub/fakepubsub/example_test.go new file mode 100644 index 0000000..c3c66bf -- - /dev/null +++ b/pubsub/fakepubsub/example_test.go @ @ -0,0 +1,47 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package fakepubsub_test + +import ( + '' context '' + '' fmt '' + '' log '' + '' time '' + + '' github.com/google/go-cloud/pubsub '' + '' github.com/google/go-cloud/pubsub/fakepubsub '' + ) + +func Example ( ) { + ctx : = context.Background ( ) + dt : = fakepubsub.CreateTopic ( ) + topic : = pubsub.NewTopic ( ctx , dt , nil )
diff -- git a/pubsub/fakepubsub/fake.go b/pubsub/fakepubsub/fake.go new file mode 100644 index 0000000..22f79be -- - /dev/null +++ b/pubsub/fakepubsub/fake.go @ @ -0,0 +1,206 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package fakepubsub provides an in-memory fake pubsub implementation . +// This should not be used for production : it is intended for local +// development . +// +// fakepubsub does not support any types for As . +package fakepubsub + +import ( + '' context '' + '' errors '' + '' sync '' + '' time '' + + '' github.com/google/go-cloud/pubsub/driver ''
diff -- git a/tests/gcp/app/app_test.go b/tests/gcp/app/app_test.go new file mode 100644 index 0000000..58069cd -- - /dev/null +++ b/tests/gcp/app/app_test.go @ @ -0,0 +1,119 @ @ +// Copyright 2018 Google LLC +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +package main_test + +import ( + '' context '' + '' flag '' + '' fmt '' + '' testing '' + + '' cloud.google.com/go/logging/logadmin '' + tracepb `` cloud.google.com/go/trace/apiv1 '' + '' github.com/google/go-cloud/tests/internal/testutil '' + '' google.golang.org/api/iterator '' + cloudtracepb `` google.golang.org/genproto/googleapis/devtools/cloudtrace/v1 '' + ) + +const ( + requestlogURL = `` /requestlog/ '' + traceURL = `` /trace/ '' + ) + +var (
diff -- git a/.gitignore b/.gitignore index 6dbf748..89a9b5e 100644 -- - a/.gitignore +++ b/.gitignore @ @ -18,3 +18,13 @ @ # Populated config files tests/gcp/app/gcp-test.yaml + + # Cryptographic keys +*.pem +*.json + + # Terraform Temporary Files +*.tfstate +*.tfstate.backup +.terraform/ +terraform.tfvars diff -- git a/go.mod b/go.mod index 51f8b6c..4fdc9d9 100644 -- - a/go.mod +++ b/go.mod @ @ -22,6 +22,8 @ @ require ( contrib.go.opencensus.io/exporter/stackdriver v0.0.0-20180421005815-665cf5131b71 github.com/GoogleCloudPlatform/cloudsql-proxy v0.0.0-20180321230639-1e456b1c68cb github.com/aws/aws-sdk-go v1.13.20 + github.com/aws/aws-sdk-go-v2 v0.0.0-20180526011417-ff1a530c3150 + github.com/aws/aws-xray-sdk-go v1.0.0-rc.5 github.com/census-ecosystem/opencensus-go-exporter-aws v0.0.0-20180411051634-41633bc1ff6b github.com/dnaeon/go-vcr v0.0.0-20180504081357-f8a7e8b9c630 github.com/fsnotify/fsnotify v1.4.7 diff -- git a/samples/guestbook/README.md b/samples/guestbook/README.md new file mode 100644 index 0000000..2f44772 -- - /dev/null +++ b/samples/guestbook/README.md @ @ -0,0 +1,120 @ @ + # Guestbook Sample + +Guestbook is a sample application that records visitors ' messages , displays a +cloud banner , and an administrative message . The main business logic is +written in a cloud-agnostic manner using MySQL , the generic blob API , and the +generic runtimevar API . All platform-specific code is set up by Wire . + + # # Prerequisites + +You will need to install the following software to run this sample : + +- [ Go ] ( https : //golang.org/doc/install ) and + [ vgo ] ( https : //go.googlesource.com/vgo )
diff -- git a/gcp/gcpcloud/gcpcloud.go b/gcp/gcpcloud/gcpcloud.go index bd0947d..f57977f 100644 -- - a/gcp/gcpcloud/gcpcloud.go +++ b/gcp/gcpcloud/gcpcloud.go @ @ -19,6 +19,7 @ @ import ( '' github.com/google/go-cloud/gcp '' '' github.com/google/go-cloud/goose '' '' github.com/google/go-cloud/mysql/cloudmysql '' + '' github.com/google/go-cloud/runtimevar/runtimeconfigurator '' '' github.com/google/go-cloud/server/sdserver '' ) @ @ -30,8 +31,9 @ @ var GCP = goose.NewSet ( Services , gcp.DefaultIdentity ) // Google Cloud Platform services in this repository , but does not include // credentials . Individual services may require additional configuration . var Services = goose.NewSet ( - gcp.DefaultTransport , - gcp.NewHTTPClient , cloudmysql.CertSourceSet , cloudmysql.Open , + gcp.DefaultTransport , + gcp.NewHTTPClient , + runtimeconfigurator.Set , sdserver.Set ) diff -- git a/runtimevar/runtimeconfigurator/example_test.go b/runtimevar/runtimeconfigurator/example_test.go index 8e1f3fb..2e43207 100644 -- - a/runtimevar/runtimeconfigurator/example_test.go +++ b/runtimevar/runtimeconfigurator/example_test.go @ @ -18,10 +18,28 @ @ import ( '' context '' '' log '' + '' github.com/google/go-cloud/gcp '' '' github.com/google/go-cloud/runtimevar '' '' github.com/google/go-cloud/runtimevar/runtimeconfigurator '' ) +func ExampleNewClient ( ) { + ctx : = context.Background ( ) + creds , err : = gcp.DefaultCredentials ( ctx ) + if err ! = nil { + log.Fatal ( err ) + } + stub , cleanup , err : = runtimeconfigurator.Dial ( ctx , creds.TokenSource ) + if err ! = nil { + log.Fatal (
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go new file mode 100644 index 0000000..1302324 -- - /dev/null +++ b/internal/pubsub/drivertest/drivertest.go @ @ -0,0 +1,192 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package drivertest provides a conformance test for implementations of +// driver . +package drivertest + +import ( + '' context '' + '' fmt '' + '' math/rand '' + '' testing '' + + '' github.com/google/go-cloud/internal/pubsub '' + ) + +// Harness descibes the functionality test harnesses must provide to run +// conformance tests . +type Harness interface { + // MakeTopicDriver
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go new file mode 100644 index 0000000..574f348 -- - /dev/null +++ b/internal/pubsub/drivertest/drivertest.go @ @ -0,0 +1,216 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package drivertest provides a conformance test for implementations of +// driver . +package drivertest + +import ( + '' bytes '' + '' context '' + '' fmt '' + '' math/rand '' + '' testing '' + + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + '' github.com/google/go-cmp/cmp '' + '' github.com/google/go-cmp/cmp/cmpopts '' + ) + +// Harness descibes the functionality test
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go new file mode 100644 index 0000000..574f348 -- - /dev/null +++ b/internal/pubsub/drivertest/drivertest.go @ @ -0,0 +1,216 @ @ +// Copyright 2018 The Go Cloud Authors +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// https : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +// Package drivertest provides a conformance test for implementations of +// driver . +package drivertest + +import ( + '' bytes '' + '' context '' + '' fmt '' + '' math/rand '' + '' testing '' + + '' github.com/google/go-cloud/internal/pubsub '' + '' github.com/google/go-cloud/internal/pubsub/driver '' + '' github.com/google/go-cmp/cmp '' + '' github.com/google/go-cmp/cmp/cmpopts '' + ) + +// Harness descibes the functionality test
diff -- git a/mysql/cloudmysql/cloudmysql.go b/mysql/cloudmysql/cloudmysql.go index 006128a..0cb6480 100644 -- - a/mysql/cloudmysql/cloudmysql.go +++ b/mysql/cloudmysql/cloudmysql.go @ @ -19,7 +19,9 @ @ import ( '' context '' '' database/sql '' '' database/sql/driver '' + '' errors '' '' fmt '' + '' os '' '' sync '' '' github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/certs '' @ @ -79,6 +81,26 @ @ func Open ( ctx context.Context , certSource proxy.CertSource , params *Params ) ( *sq return sql.OpenDB ( connector ( cfg.FormatDSN ( ) ) ) , nil } +// OpenGAE opens a Cloud SQL database on Google App Engine ( GAE ) using the +// environment variables $ DB_USER , $ DB_DATABASE , $ DB_INSTANCE , and +// $ DB_PASSWORD . +func OpenGAE ( ctx context.Context , certSource proxy.CertSource ) ( *sql.DB , error ) { + p : = & Params { } + if p.User = os.Getenv ( `` DB_USER '' ) ; p.User == `` '' { + return nil , errors.New ( `` opening db connection on GAE : $ DB_USER is undefined '' ) + } + if p.Database = os.Getenv ( `` DB_DATABASE '' ) ; p.Database == `` '' { + return nil , errors.New ( `` opening db connection on
diff -- git a/testing/replay/replay.go b/testing/replay/replay.go index a7ec1a9..212361f 100644 -- - a/testing/replay/replay.go +++ b/testing/replay/replay.go @ @ -87,6 +87,9 @ @ func NewAWSRecorder ( logf func ( string , ... interface { } ) , mode recorder.Mode , filen } ) return r , func ( ) { r.Stop ( ) + if mode ! = recorder.ModeRecording { + return + } if err : = fixAWSHeaders ( path ) ; err ! = nil { fmt.Println ( err ) }
diff -- git a/blob/s3blob/s3blob.go b/blob/s3blob/s3blob.go index ff50cdd..85be0ad 100644 -- - a/blob/s3blob/s3blob.go +++ b/blob/s3blob/s3blob.go @ @ -21,9 +21,7 @ @ import ( '' fmt '' '' io '' '' io/ioutil '' - '' regexp '' '' strings '' - '' unicode/utf8 '' '' github.com/google/go-cloud/blob '' '' github.com/google/go-cloud/blob/driver '' @ @ -38,9 +36,6 @ @ import ( // communicate to S3 . AWS config can be passed in through BucketOptions to // change the default configuration of the S3Bucket . func NewBucket ( ctx context.Context , sess client.ConfigProvider , bucketName string ) ( *blob.Bucket , error ) { - if err : = validateBucketChar ( bucketName ) ; err ! = nil { - return nil , err - } if sess == nil { return nil , errors.New ( `` sess must be provided to get bucket '' ) } @ @ -216,9 +211,6 @ @ func ( b *bucket ) newMetadataReader ( ctx context.Context , key string ) ( driver.Read // // The caller must call Close on the returned writer when done writing . func ( b *bucket ) NewWriter ( ctx context.Context , key string , opts *driver.WriterOptions ) ( driver.Writer , error ) { - if err
diff -- git a/runtimevar/runtimeconfigurator/runtimeconfigurator_test.go b/runtimevar/runtimeconfigurator/runtimeconfigurator_test.go index 2dbed6b..a0fdcaa 100644 -- - a/runtimevar/runtimeconfigurator/runtimeconfigurator_test.go +++ b/runtimevar/runtimeconfigurator/runtimeconfigurator_test.go @ @ -147,15 +147,11 @ @ func TestInitialStringWatch ( t *testing.T ) { } want : = `` facepalm : 🤦 '' - _ , err = createStringVariable ( ctx , client.client , rn , want ) + _ , done , err = createStringVariable ( ctx , client.client , rn , want ) if err ! = nil { t.Fatal ( err ) } - defer func ( ) { - if err : = deleteConfig ( ctx , client.client , rn ) ; err ! = nil { - t.Fatalf ( `` delete config failed , possible human cleanup required : % v '' , err ) - } - } ( ) + defer done ( ) variable , err : = client.NewVariable ( ctx , rn , runtimevar.StringDecoder , nil ) if err ! = nil { @ @ -193,15 +189,11 @ @ func TestInitialJSONWatch ( t *testing.T ) { } var jsonDataPtr *home want : = & home { `` Batman '' , `` Gotham '' } - _ , err = createByteVariable ( ctx , client.client , rn , [ ]
diff -- git a/runtimevar/runtimeconfigurator/runtimeconfigurator.go b/runtimevar/runtimeconfigurator/runtimeconfigurator.go index 2270f97..1bf05d3 100644 -- - a/runtimevar/runtimeconfigurator/runtimeconfigurator.go +++ b/runtimevar/runtimeconfigurator/runtimeconfigurator.go @ @ -46,9 +46,9 @ @ var Set = wire.NewSet ( const ( // endpoint is the address of the GCP Runtime Configurator API . endPoint = `` runtimeconfig.googleapis.com:443 '' - // defaultWaitTimeout is the default value for WatchOptions.WaitTime if not set . + // defaultWait is the default value for WatchOptions.WaitTime if not set . // Change the docstring for NewVariable if this time is modified . - defaultWaitTimeout = 10 * time.Minute + defaultWait = 30 * time.Second ) // Dial opens a gRPC connection to the Runtime Configurator API . @ @ -76,7 +76,7 @ @ func NewClient ( stub pb.RuntimeConfigManagerClient ) *Client { // NewVariable constructs a runtimevar.Variable object with this package as the driver // implementation . Provide a decoder to unmarshal updated configurations into similar // objects during the Watch call . -// If WaitTime is not set the poller will time out after 10 minutes . +// If WaitTime is not set the poller will check for updates to the variable every 30 seconds . func ( c *Client ) NewVariable ( ctx context.Context , name ResourceName , decoder *runtimevar.Decoder
diff -- git a/aws/awscloud/example_test.go b/aws/awscloud/example_test.go index 4f5c7e8..8cdfc51 100644 -- - a/aws/awscloud/example_test.go +++ b/aws/awscloud/example_test.go @ @ -57,7 +57,7 @ @ func Example ( ) { // https : //github.com/google/go-cloud/blob/master/wire/README.md # injectors // for more details . func setup ( ctx context.Context ) ( *server.Server , func ( ) , error ) { - panic ( wire.Build ( + wire.Build ( // The AWS set includes all the default wiring for AWS , including // for *server.Server . awscloud.AWS , @ @ -66,7 +66,8 @ @ func setup ( ctx context.Context ) ( *server.Server , func ( ) , error ) { // Health checks can be added to delay your server reporting healthy // to the load balancer before critical dependencies are available . wire.Value ( [ ] health.Checker ( nil ) ) , - ) ) + ) + return nil , nil , nil } // greet is an ordinary http.HandleFunc . diff -- git a/gcp/gcpcloud/example_test.go b/gcp/gcpcloud/example_test.go index 05a8eeb..f46132c 100644 -- - a/gcp/gcpcloud/example_test.go +++ b/gcp/gcpcloud/example_test.go @ @ -57,7 +57,7 @ @ func Example ( ) { // https : //github.com/google/go-cloud/blob/master/wire/README.md # injectors // for more details . func setup ( ctx context.Context ) ( *server.Server , func ( )
diff -- git a/runtimevar/driver/driver.go b/runtimevar/driver/driver.go index ad98513..fdab48f 100644 -- - a/runtimevar/driver/driver.go +++ b/runtimevar/driver/driver.go @ @ -39,20 +39,33 @ @ type Variable struct { // dictate the type of Variable.Value and a decoding function . The Watcher provider can use the // runtimevar.Decoder to facilitate the decoding logic . type Watcher interface { - // WatchVariable blocks until the variable changes , the Context 's Done channel closes or an - // error occurs . + // WatchVariable returns one of : // - // If the variable has changed , then WatchVariable must return a Variable object with the - // new value . + // 1 . A new value for the variable in v , along with a provider-specific + // version that will be passed to the next WatchVariable call . wait is + // ignored and err must be nil . + // 2 . A new error . v , version , and wait are ignored . + // 3 . A nil v and version and err , indicating that the value of the variable + // or the error returned has not changed . WatchVariable will not be called + // again for
diff -- git a/server/server.go b/server/server.go index a9c83a1..85335f8 100644 -- - a/server/server.go +++ b/server/server.go @ @ -51,7 +51,8 @ @ type Options struct { DefaultSamplingPolicy trace.Sampler } -// New creates a new server . New ( nil ) is the same as new ( Server ) . +// New creates a new server . New ( nil ) is the same as new ( Server ) . Note : A +// configured Requestlogger will not log HealthChecks . func New ( opts *Options ) *Server { srv : = new ( Server ) if opts ! = nil {
diff -- git a/internal/testing/replay/replay.go b/internal/testing/replay/replay.go index 0ac413d..18e7269 100644 -- - a/internal/testing/replay/replay.go +++ b/internal/testing/replay/replay.go @ @ -28,7 +28,6 @ @ import ( '' cloud.google.com/go/rpcreplay '' '' github.com/dnaeon/go-vcr/cassette '' '' github.com/dnaeon/go-vcr/recorder '' - '' github.com/golang/protobuf/proto '' '' google.golang.org/grpc '' ) @ @ -141,42 +140,32 @ @ func scrubRecording ( filepath string ) error { // NewGCPDialOptions return grpc.DialOptions that are to be appended to a GRPC dial request . // These options allow a recorder/replayer to intercept RPCs and save RPCs to the file at filename , // or read the RPCs from the file and return them . -func NewGCPDialOptions ( logf func ( string , ... interface { } ) , mode recorder.Mode , filename string , scrubber func ( func ( string , ... interface { } ) , string , proto.Message ) error ) ( opts [ ] grpc.DialOption , done func ( ) , err error ) { +func NewGCPDialOptions ( t *testing.T , mode recorder.Mode , filename string ) ( opts [ ] grpc.DialOption , done func ( ) ) { path : = filepath.Join ( `` testdata '' , filename ) - logf ( `` Golden file is at % v '' , path )
diff -- git a/internal/pubsub/driver/driver.go b/internal/pubsub/driver/driver.go index a55a572..2d8971f 100644 -- - a/internal/pubsub/driver/driver.go +++ b/internal/pubsub/driver/driver.go @ @ -75,7 +75,7 @ @ type Topic interface { // Subscription receives published messages . type Subscription interface { // ReceiveBatch should return a batch of messages that have queued up - // for the subscription on the server . + // for the subscription on the server , up to maxMessages . // // If there is a transient failure , this method should not retry but // should return a nil slice and an error . The concrete API will take @ @ -90,7 +90,7 @ @ type Subscription interface { // are no messages yet . // // ReceiveBatch should be safe for concurrent access from multiple goroutines . - ReceiveBatch ( ctx context.Context ) ( [ ] *Message , error ) + ReceiveBatch ( ctx context.Context , maxMessages int ) ( [ ] *Message , error ) // SendAcks should acknowledge the messages with the given ackIDs on // the server so that they will not be received again for this diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 08e0491..8c7d6d9 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -51,12 +51,6 @ @ func RunConformanceTests
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 2019ddc..3726b6a 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -17,10 +17,10 @ @ package drivertest import ( - '' bytes '' '' context '' '' fmt '' '' math/rand '' + '' sort '' '' testing '' '' github.com/google/go-cloud/internal/pubsub '' @ @ -53,12 +53,6 @ @ func RunConformanceTests ( t *testing.T , newHarness HarnessMaker ) { t.Run ( `` TestSendReceive '' , func ( t *testing.T ) { testSendReceive ( t , newHarness ) } ) - t.Run ( `` TestErrorOnSendToClosedTopic '' , func ( t *testing.T ) { - testErrorOnSendToClosedTopic ( t , newHarness ) - } ) - t.Run ( `` TestErrorOnReceiveFromClosedSubscription '' , func ( t *testing.T ) { - testErrorOnReceiveFromClosedSubscription ( t , newHarness ) - } ) t.Run ( `` TestCancelSendReceive '' , func ( t *testing.T ) { testCancelSendReceive ( t , newHarness ) } ) @ @ -80,6 +74,7 @ @ func testSendReceive ( t *testing.T , newHarness HarnessMaker ) { // Send to the topic . ms : = [ ] *pubsub.Message { } + ss : = [ ] string { } for i : = 0 ; i < 3 ; i++ { m
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 84cbee2..3726b6a 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -17,10 +17,10 @ @ package drivertest import ( - '' bytes '' '' context '' '' fmt '' '' math/rand '' + '' sort '' '' testing '' '' github.com/google/go-cloud/internal/pubsub '' @ @ -53,12 +53,6 @ @ func RunConformanceTests ( t *testing.T , newHarness HarnessMaker ) { t.Run ( `` TestSendReceive '' , func ( t *testing.T ) { testSendReceive ( t , newHarness ) } ) - t.Run ( `` TestErrorOnSendToClosedTopic '' , func ( t *testing.T ) { - testErrorOnSendToClosedTopic ( t , newHarness ) - } ) - t.Run ( `` TestErrorOnReceiveFromClosedSubscription '' , func ( t *testing.T ) { - testErrorOnReceiveFromClosedSubscription ( t , newHarness ) - } ) t.Run ( `` TestCancelSendReceive '' , func ( t *testing.T ) { testCancelSendReceive ( t , newHarness ) } ) @ @ -80,6 +74,7 @ @ func testSendReceive ( t *testing.T , newHarness HarnessMaker ) { // Send to the topic . ms : = [ ] *pubsub.Message { } + ss : = [ ] string { } for i : = 0 ; i < 3 ; i++ { m
diff -- git a/internal/pubsub/drivertest/drivertest.go b/internal/pubsub/drivertest/drivertest.go index 3292b80..dfedaf7 100644 -- - a/internal/pubsub/drivertest/drivertest.go +++ b/internal/pubsub/drivertest/drivertest.go @ @ -35,10 +35,18 @ @ type Harness interface { // MakeTopic makes a driver.Topic for testing . MakeTopic ( ctx context.Context ) ( driver.Topic , error ) + // MakeNonexistentTopic makes a driver.Topic referencing a topic that + // does not exist . + MakeNonexistentTopic ( ctx context.Context ) ( driver.Topic , error ) + // MakeSubscription makes a driver.Subscription subscribed to the given // driver.Topic . MakeSubscription ( ctx context.Context , t driver.Topic ) ( driver.Subscription , error ) + // MakeNonexistentSubscription makes a driver.Subscription referencing a + // subscription that does not exist . + MakeNonexistentSubscription ( ctx context.Context ) ( driver.Subscription , error ) + // Close closes resources used by the harness , but does not call Close // on the Topics and Subscriptions generated by the Harness . Close ( ) @ @ -62,6 +70,61 @ @ func RunConformanceTests ( t *testing.T , newHarness HarnessMaker ) { t.Run ( `` TestCancelSendReceive '' , func ( t *testing.T ) { testCancelSendReceive ( t , newHarness ) } ) + t.Run ( `` TestNonExistentTopicSucceedsOnOpenButFailsOnSend '' , func ( t *testing.T ) { +
diff -- git a/server/server.go b/server/server.go index a9c83a1..248a52a 100644 -- - a/server/server.go +++ b/server/server.go @ @ -79,6 +79,7 @ @ func ( srv *Server ) init ( ) { // ListenAndServe is a wrapper to use wherever http.ListenAndServe is used . // It wraps the passed-in http.Handler with a handler that handles tracing and // request logging . If the handler is nil , then http.DefaultServeMux will be used . +// A configured Requestlogger will log all requests except HealthChecks . func ( srv *Server ) ListenAndServe ( addr string , h http.Handler ) error { srv.init ( )
diff -- git a/AUTHORS b/AUTHORS index f521b6d..b31fb2a 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -69,6 +69,7 @ @ i2bskn < i2bskn @ gmail.com > Isao Jonas < isao.jonas @ gmail.com > isqua < isqua @ isqua.ru > Jameel Haffejee < RC1140 @ republiccommandos.co.za > +Jeremy Morris < jeremylevanmorris @ gmail.com > Jihoon Chung < j.c @ navercorp.com > Joe Tsai < joetsai @ digital-static.net > John Engelman < john.r.engelman @ gmail.com > diff -- git a/github/apps.go b/github/apps.go index ff33893..4c3e7c6 100644 -- - a/github/apps.go +++ b/github/apps.go @ @ -37,4 +37,4 @ @ func ( s *AppsService ) ListInstallations ( ctx context.Context , opt *ListOptions ) ( } return i , resp , nil - } + } \ No newline at end of file diff -- git a/github/apps_installation.go b/github/apps_installation.go index 6a27799..5aab26a 100644 -- - a/github/apps_installation.go +++ b/github/apps_installation.go @ @ -47,3 +47,49 @ @ func ( s *AppsService ) ListRepos ( ctx context.Context , opt *ListOptions ) ( [ ] *Repos return r.Repositories , resp , nil } + +// AddRepository adds a single repository to an installation . +// +// GitHub API docs : https : //developer.github.com/v3/apps/installations/ # add-repository-to-installation +func ( s *AppService ) AddRepository ( ctx context.Context , installationID
diff -- git a/AUTHORS b/AUTHORS index f521b6d..b31fb2a 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -69,6 +69,7 @ @ i2bskn < i2bskn @ gmail.com > Isao Jonas < isao.jonas @ gmail.com > isqua < isqua @ isqua.ru > Jameel Haffejee < RC1140 @ republiccommandos.co.za > +Jeremy Morris < jeremylevanmorris @ gmail.com > Jihoon Chung < j.c @ navercorp.com > Joe Tsai < joetsai @ digital-static.net > John Engelman < john.r.engelman @ gmail.com > diff -- git a/github/apps.go b/github/apps.go index ff33893..4c3e7c6 100644 -- - a/github/apps.go +++ b/github/apps.go @ @ -37,4 +37,4 @ @ func ( s *AppsService ) ListInstallations ( ctx context.Context , opt *ListOptions ) ( } return i , resp , nil - } + } \ No newline at end of file diff -- git a/github/apps_installation.go b/github/apps_installation.go index 6a27799..9489ee9 100644 -- - a/github/apps_installation.go +++ b/github/apps_installation.go @ @ -47,3 +47,38 @ @ func ( s *AppsService ) ListRepos ( ctx context.Context , opt *ListOptions ) ( [ ] *Repos return r.Repositories , resp , nil } + +// Add a single repository to an installation . +// +// GitHub API docs : https : //developer.github.com/v3/apps/installations/ # add-repository-to-installation +func ( s *AppService ) Add ( ctx context.Context , instID int
diff -- git a/AUTHORS b/AUTHORS index f521b6d..b31fb2a 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -69,6 +69,7 @ @ i2bskn < i2bskn @ gmail.com > Isao Jonas < isao.jonas @ gmail.com > isqua < isqua @ isqua.ru > Jameel Haffejee < RC1140 @ republiccommandos.co.za > +Jeremy Morris < jeremylevanmorris @ gmail.com > Jihoon Chung < j.c @ navercorp.com > Joe Tsai < joetsai @ digital-static.net > John Engelman < john.r.engelman @ gmail.com > diff -- git a/github/apps.go b/github/apps.go index ff33893..4c3e7c6 100644 -- - a/github/apps.go +++ b/github/apps.go @ @ -37,4 +37,4 @ @ func ( s *AppsService ) ListInstallations ( ctx context.Context , opt *ListOptions ) ( } return i , resp , nil - } + } \ No newline at end of file diff -- git a/github/apps_installation.go b/github/apps_installation.go index 6a27799..dcffe71 100644 -- - a/github/apps_installation.go +++ b/github/apps_installation.go @ @ -47,3 +47,38 @ @ func ( s *AppsService ) ListRepos ( ctx context.Context , opt *ListOptions ) ( [ ] *Repos return r.Repositories , resp , nil } + +// Add a single repository to an installation . +// +// GitHub API docs : https : //developer.github.com/v3/apps/installations/ # add-repository-to-installation +func ( s *AppService ) AddRepository ( ctx context.Context , instID int
diff -- git a/AUTHORS b/AUTHORS index c15c465..e97e992 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -77,6 +77,7 @ @ i2bskn < i2bskn @ gmail.com > Isao Jonas < isao.jonas @ gmail.com > isqua < isqua @ isqua.ru > Jameel Haffejee < RC1140 @ republiccommandos.co.za > +Jeremy Morris < jeremylevanmorris @ gmail.com > Jan Kosecki < jan.kosecki91 @ gmail.com > Jihoon Chung < j.c @ navercorp.com > Jimmi Dyson < jimmidyson @ gmail.com > diff -- git a/github/apps.go b/github/apps.go index ff33893..4c3e7c6 100644 -- - a/github/apps.go +++ b/github/apps.go @ @ -37,4 +37,4 @ @ func ( s *AppsService ) ListInstallations ( ctx context.Context , opt *ListOptions ) ( } return i , resp , nil - } + } \ No newline at end of file diff -- git a/github/apps_installation.go b/github/apps_installation.go index 6a27799..f7bcf4d 100644 -- - a/github/apps_installation.go +++ b/github/apps_installation.go @ @ -47,3 +47,38 @ @ func ( s *AppsService ) ListRepos ( ctx context.Context , opt *ListOptions ) ( [ ] *Repos return r.Repositories , resp , nil } + +// AddRepo adds a single repository to an installation . +// +// GitHub API docs : https : //developer.github.com/v3/apps/installations/ # add-repository-to-installation +func ( s *AppService ) AddRepo ( ctx context.Context , instID
diff -- git a/AUTHORS b/AUTHORS index c15c465..e97e992 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -77,6 +77,7 @ @ i2bskn < i2bskn @ gmail.com > Isao Jonas < isao.jonas @ gmail.com > isqua < isqua @ isqua.ru > Jameel Haffejee < RC1140 @ republiccommandos.co.za > +Jeremy Morris < jeremylevanmorris @ gmail.com > Jan Kosecki < jan.kosecki91 @ gmail.com > Jihoon Chung < j.c @ navercorp.com > Jimmi Dyson < jimmidyson @ gmail.com > diff -- git a/github/apps_installation.go b/github/apps_installation.go index 6a27799..aa14874 100644 -- - a/github/apps_installation.go +++ b/github/apps_installation.go @ @ -5,7 +5,10 @ @ package github -import `` context '' +import ( + '' context '' + '' fmt '' + ) // Installation represents a GitHub Apps installation . type Installation struct { @ @ -47,3 +50,38 @ @ func ( s *AppsService ) ListRepos ( ctx context.Context , opt *ListOptions ) ( [ ] *Repos return r.Repositories , resp , nil } + +// AddRepo adds a single repository to an installation . +// +// GitHub API docs : https : //developer.github.com/v3/apps/installations/ # add-repository-to-installation +func ( s *AppsService ) AddRepo ( ctx context.Context , instID , repoID int ) ( *Repository , *Response , error ) { + u :
diff -- git a/github/github.go b/github/github.go index 3a0727e..8c707be 100644 -- - a/github/github.go +++ b/github/github.go @ @ -108,6 +108,9 @ @ const ( // https : //developer.github.com/changes/2017-08-30-preview-nested-teams/ mediaTypeNestedTeamsPreview = `` application/vnd.github.hellcat-preview+json '' + + // https : //developer.github.com/changes/2017-11-09-repository-transfer-api-preview/ + mediaTypeRepositoryTransferPreview = `` application/vnd.github.nightshade-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/repos.go b/github/repos.go index 037ddfa..23cf8bb 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -1037,3 +1037,38 @ @ func ( s *RepositoriesService ) ReplaceAllTopics ( ctx context.Context , owner , repo return t.Names , resp , nil } + +// TransferRequest represents a request to transfer a repository . +type TransferRequest struct { + NewOwner string ` json : '' new_owner '' ` + TeamID [ ] int ` json : '' team_id , omitempty '' ` + } + +// Transfer transfers a repository from one account or organization to another . +// +// This method might return an *AcceptedError and a status code of +// 202 . This is because this is the status that GitHub returns to signify that +// it has now scheduled the transfer of the repository in a background task . +// A follow up request , after a delay
diff -- git a/github/apps_marketplace.go b/github/apps_marketplace.go index 089cdbf..3f35b91 100644 -- - a/github/apps_marketplace.go +++ b/github/apps_marketplace.go @ @ -74,9 +74,6 @ @ func ( s *MarketplaceService ) ListPlans ( ctx context.Context , opt *ListOptions ) ( [ return nil , nil , err } - // TODO : remove custom Accept header when this API fully launches . - req.Header.Set ( `` Accept '' , mediaTypeMarketplacePreview ) - var plans [ ] *MarketplacePlan resp , err : = s.client.Do ( ctx , req , & plans ) if err ! = nil { @ @ -101,9 +98,6 @ @ func ( s *MarketplaceService ) ListPlanAccountsForPlan ( ctx context.Context , planID return nil , nil , err } - // TODO : remove custom Accept header when this API fully launches . - req.Header.Set ( `` Accept '' , mediaTypeMarketplacePreview ) - var accounts [ ] *MarketplacePlanAccount resp , err : = s.client.Do ( ctx , req , & accounts ) if err ! = nil { @ @ -128,9 +122,6 @ @ func ( s *MarketplaceService ) ListPlanAccountsForAccount ( ctx context.Context , acc return nil , nil , err } - // TODO : remove custom Accept header when this API fully launches
diff -- git a/github/github.go b/github/github.go index 315e256..2e400e3 100644 -- - a/github/github.go +++ b/github/github.go @ @ -97,6 +97,9 @ @ const ( // https : //developer.github.com/changes/2017-02-09-community-health/ mediaTypeRepositoryCommunityHealthMetricsPreview = `` application/vnd.github.black-panther-preview+json '' + + // https : //developer.github.com/v3/codes_of_conduct/ + mediaTypeCodesOfConductPreview = `` application/vnd.github.scarlet-witch-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/misc.go b/github/misc.go index 42d0d30..ad3ac18 100644 -- - a/github/misc.go +++ b/github/misc.go @ @ -83,6 +83,61 @ @ func ( c *Client ) ListEmojis ( ctx context.Context ) ( map [ string ] string , *Response , return emoji , resp , nil } +// Conduct represents metric that contains name , key , url , body . +type Conduct struct { + Name *string ` json : '' name , omitempty '' ` + Key *string ` json : '' key , omitempty '' ` + URL *string ` json : '' url , omitempty '' ` + BODY *string ` json : '' body , omitempty '' ` + } + +func ( c *Conduct ) String ( ) string { + return Stringify ( c ) + } + +// ListCodesOfConduct returns all codes of conduct . +// +// https : //developer.github.com/v3/codes_of_conduct/ +func
diff -- git a/github/pulls.go b/github/pulls.go index 307562d..cf07110 100644 -- - a/github/pulls.go +++ b/github/pulls.go @ @ -41,6 +41,8 @ @ type PullRequest struct { HTMLURL *string ` json : '' html_url , omitempty '' ` IssueURL *string ` json : '' issue_url , omitempty '' ` StatusesURL *string ` json : '' statuses_url , omitempty '' ` + DiffURL *string ` json : '' diff_url , omitempty '' ` + PatchURL *string ` json : '' patch_url , omitempty '' ` Head *PullRequestBranch ` json : '' head , omitempty '' ` Base *PullRequestBranch ` json : '' base , omitempty '' ` diff -- git a/github/pulls_test.go b/github/pulls_test.go index d0e976b..a1c1765 100644 -- - a/github/pulls_test.go +++ b/github/pulls_test.go @ @ -98,6 +98,29 @ @ func TestPullRequestsService_Get_headAndBase ( t *testing.T ) { } } +func TestPullRequestService_Get_DiffURLAndPatchURL ( t *testing.T ) { + setup ( ) + defer teardown ( ) + + mux.HandleFunc ( `` /repos/o/r/pulls/1 '' , func ( w http.ResponseWriter , r *http.Request ) { + testMethod ( t , r , `` GET '' ) + fmt.Fprint ( w , ` { `` number '' :1 , + '' diff_url '' : `` https : //github.com/octocat/Hello-World/pull/1347.diff '' , + '' patch_url
diff -- git a/github/repos.go b/github/repos.go index 68accf7..08a26e2 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -566,6 +566,8 @ @ type PullRequestReviewsEnforcement struct { DismissStaleReviews bool ` json : '' dismiss_stale_reviews '' ` // RequireCodeOwnerReviews specifies if an approved review is required in pull requests including files with a designated code owner . RequireCodeOwnerReviews bool ` json : '' require_code_owner_reviews '' ` + // RequiredApprovingReviewCount specifies the number of approvals required before the pull request can be merged + RequiredApprovingReviewCount int ` json : '' required_approving_review_count '' ` } // PullRequestReviewsEnforcementRequest represents request to set the pull request review @ @ -578,6 +580,8 @ @ type PullRequestReviewsEnforcementRequest struct { DismissStaleReviews bool ` json : '' dismiss_stale_reviews '' ` // RequireCodeOwnerReviews specifies if an approved review is required in pull requests including files with a designated code owner . RequireCodeOwnerReviews bool ` json : '' require_code_owner_reviews '' ` + // RequiredApprovingReviewCount specifies the number of approvals required before the pull request can be merged + RequiredApprovingReviewCount int ` json : '' required_approving_review_count '' ` } // MarshalJSON implements the json.Marshaler interface . @ @ -588,10 +592,12 @ @ func ( req PullRequestReviewsEnforcementRequest ) MarshalJSON ( ) ( [ ] byte , error
diff -- git a/github/orgs_members.go b/github/orgs_members.go index 80454ad..77f6912 100644 -- - a/github/orgs_members.go +++ b/github/orgs_members.go @ @ -270,3 +270,29 @ @ func ( s *OrganizationsService ) RemoveOrgMembership ( user , org string ) ( *Response , return s.client.Do ( req , nil ) } + +// ListPendingOrgInvitations returns a list of pending invitations . +// +// GitHub API docs : https : //developer.github.com/v3/orgs/members/ # list-pending-organization-invitations +func ( s *OrganizationsService ) ListPendingOrgInvitations ( org int , opt *ListOptions ) ( [ ] *Invitation , *Response , error ) { + u : = fmt.Sprintf ( `` orgs/ % v/invitations '' , org ) + u , err : = addOptions ( u , opt ) + if err ! = nil { + return nil , nil , err + } + + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil { + return nil , nil , err + } + + // TODO : remove custom Accept header when this API fully launches . + req.Header.Set ( `` Accept '' , mediaTypeOrgMembershipPreview ) + + pendingInvitations : = new ( [ ] *Invitation ) + resp , err
diff -- git a/github/orgs_members_test.go b/github/orgs_members_test.go index ee1d2e6..704cf29 100644 -- - a/github/orgs_members_test.go +++ b/github/orgs_members_test.go @ @ -395,7 +395,11 @ @ func TestOrganizationsService_ListPendingOrgInvitations ( t *testing.T ) { } ) opt : = & ListOptions { Page : 1 } + < < < < < < < HEAD invitations , _ , err : = client.Organizations.ListPendingOrgInvitations ( context.Background ( ) , 1 , opt ) +======= + invitations , _ , err : = client.Organizations.ListPendingOrgInvitations ( 1 , opt ) + > > > > > > > 1bd4328a520dfc6d58f92e0f441f3f56718b725d if err ! = nil { t.Errorf ( `` Organizations.ListPendingOrgInvitations returned error : % v '' , err ) } diff -- git a/github/users_blocking.go b/github/users_blocking.go new file mode 100644 index 0000000..0a29530 -- - /dev/null +++ b/github/users_blocking.go @ @ -0,0 +1,79 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// ListBlockedUsers lists all the blocked users by the authenticated user +// +// GitHub API docs : https :
diff -- git a/github/github.go b/github/github.go index f3eadce..93df714 100644 -- - a/github/github.go +++ b/github/github.go @ @ -113,6 +113,9 @ @ const ( // https : //developer.github.com/changes/2017-12-19-graphql-node-id/ mediaTypeGraphQLNodeIDPreview = `` application/vnd.github.jean-grey-preview+json '' + + // https : //developer.github.com/changes/2018-01-25-organization-invitation-api-preview/ + mediaTypeOrganizationInvitationPreview = `` application/vnd.github.dazzler-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/orgs_members.go b/github/orgs_members.go index d0ea6a9..29deeb1 100644 -- - a/github/orgs_members.go +++ b/github/orgs_members.go @ @ -297,3 +297,44 @ @ func ( s *OrganizationsService ) ListPendingOrgInvitations ( ctx context.Context , or } return pendingInvitations , resp , nil } + +// CreateOrgInvitationOptions specifies the parameters to the OrganizationService.Invite +// method . +type CreateOrgInvitationOptions struct { + InviteeID *int ` json : '' invitee_id , omitempty '' ` + Email *string ` json : '' email , omitempty '' ` + // Specify role for new member . Can be one of : + // * admin - Organization owners with full administrative rights to the + // organization and complete access to all repositories and teams . + // * direct_member - Non-owner organization members with ability to see + // other members and join teams by invitation . + // * billing_manager - Non-owner organization members with
diff -- git a/github/git_refs.go b/github/git_refs.go index bd5df3f..2cf2b06 100644 -- - a/github/git_refs.go +++ b/github/git_refs.go @ @ -7,6 +7,8 @ @ package github import ( '' context '' + '' encoding/json '' + '' errors '' '' fmt '' '' strings '' ) @ @ -45,7 +47,10 @ @ type updateRefRequest struct { Force *bool ` json : '' force '' ` } -// GetRef fetches the Reference object for a given Git ref . +// GetRef fetches a single Reference object for a given Git ref . +// If there is no exact match , GetRef will return an error . +// +// Note : the GitHub API can return multiple matches , if you wish to use this functionality please use the GetRefs ( ) method . // // GitHub API docs : https : //developer.github.com/v3/git/refs/ # get-a-reference func ( s *GitService ) GetRef ( ctx context.Context , owner string , repo string , ref string ) ( *Reference , *Response , error ) { @ @ -58,13 +63,61 @ @ func ( s *GitService ) GetRef ( ctx context.Context , owner string , repo string , ref r : = new ( Reference ) resp , err : =
diff -- git a/github/orgs_outside_collaborators.go b/github/orgs_outside_collaborators.go index e34f865..85ffd05 100644 -- - a/github/orgs_outside_collaborators.go +++ b/github/orgs_outside_collaborators.go @ @ -48,3 +48,34 @ @ func ( s *OrganizationsService ) ListOutsideCollaborators ( ctx context.Context , org return members , resp , nil } + +// RemoveOutsideCollaborator removes a user from the list of outside collaborators ; +// consequently , removing them from all the organization 's repositories . +// +// GitHub API docs : https : //developer.github.com/v3/orgs/outside_collaborators/ # remove-outside-collaborator +func ( s *OrganizationsService ) RemoveOutsideCollaborator ( ctx context.Context , org string , user string ) ( *Response , error ) { + u : = fmt.Sprintf ( `` orgs/ % v/outside_collaborators/ % v '' , org , user ) + req , err : = s.client.NewRequest ( `` DELETE '' , u , nil ) + if err ! = nil { + return nil , err + } + + return s.client.Do ( ctx , req , nil ) + } + +// ConvertMemberToOutsideCollaborator reduces the permission level of a member of the +// organization to that of an outside collaborator . Therefore , they will only +// have access to the repositories that their current team membership allows . +// Responses for converting a
diff -- git a/github/github.go b/github/github.go index 8f9dde6..fd3f465 100644 -- - a/github/github.go +++ b/github/github.go @ @ -93,6 +93,9 @ @ const ( // https : //developer.github.com/changes/2016-11-28-preview-org-membership/ mediaTypeOrgMembershipPreview = `` application/vnd.github.korra-preview+json '' + + // https : //developer.github.com/changes/2017-01-05-commit-search-api/ + mediaTypeCommitSearchPreview = `` application/vnd.github.cloak-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/search.go b/github/search.go index 579a57d..6257c17 100644 -- - a/github/search.go +++ b/github/search.go @ @ -21,6 +21,7 @ @ type SearchService service type SearchOptions struct { // How to sort the search results . Possible values are : // - for repositories : stars , fork , updated + // - for commits : author-date , committer-date // - for code : indexed // - for issues : comments , created , updated // - for users : followers , repositories , joined @ @ -54,6 +55,37 @ @ func ( s *SearchService ) Repositories ( query string , opt *SearchOptions ) ( *Reposit return result , resp , err } +// CommitsSearchResult represents the result of a commits search . +type CommitsSearchResult struct { + Total *int ` json : '' total_count , omitempty '' ` + IncompleteResults *bool ` json : '' incomplete_results , omitempty
diff -- git a/github/github.go b/github/github.go index 6d4e777..a58dbfb 100644 -- - a/github/github.go +++ b/github/github.go @ @ -96,6 +96,9 @ @ const ( // https : //developer.github.com/changes/2017-01-05-commit-search-api/ mediaTypeCommitSearchPreview = `` application/vnd.github.cloak-preview+json '' + + // https : //developer.github.com/changes/2016-12-14-reviews-api/ + mediaTypePullRequestReviewsPreview = `` application/vnd.github.black-cat-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/pulls_reviews.go b/github/pulls_reviews.go index ae3cdd4..c025bf5 100644 -- - a/github/pulls_reviews.go +++ b/github/pulls_reviews.go @ @ -5,15 +5,210 @ @ package github -import `` time '' +import ( + '' fmt '' + '' time '' + ) // PullRequestReview represents a review of a pull request . type PullRequestReview struct { - ID *int ` json : '' id , omitempty '' ` - User *User ` json : '' user , omitempty '' ` - Body *string ` json : '' body , omitempty '' ` - SubmittedAt *time.Time ` json : '' submitted_at , omitempty '' ` + ID *int ` json : '' id , omitempty '' ` + User *User ` json : '' user , omitempty '' ` + Body *string ` json : '' body , omitempty '' ` + SubmittedAt *time.Time ` json : '' submitted_at , omitempty '' `
diff -- git a/github/github.go b/github/github.go index 6d4e777..a58dbfb 100644 -- - a/github/github.go +++ b/github/github.go @ @ -96,6 +96,9 @ @ const ( // https : //developer.github.com/changes/2017-01-05-commit-search-api/ mediaTypeCommitSearchPreview = `` application/vnd.github.cloak-preview+json '' + + // https : //developer.github.com/changes/2016-12-14-reviews-api/ + mediaTypePullRequestReviewsPreview = `` application/vnd.github.black-cat-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/pulls_reviews.go b/github/pulls_reviews.go index ae3cdd4..c025bf5 100644 -- - a/github/pulls_reviews.go +++ b/github/pulls_reviews.go @ @ -5,15 +5,210 @ @ package github -import `` time '' +import ( + '' fmt '' + '' time '' + ) // PullRequestReview represents a review of a pull request . type PullRequestReview struct { - ID *int ` json : '' id , omitempty '' ` - User *User ` json : '' user , omitempty '' ` - Body *string ` json : '' body , omitempty '' ` - SubmittedAt *time.Time ` json : '' submitted_at , omitempty '' ` + ID *int ` json : '' id , omitempty '' ` + User *User ` json : '' user , omitempty '' ` + Body *string ` json : '' body , omitempty '' ` + SubmittedAt *time.Time ` json : '' submitted_at , omitempty '' `
diff -- git a/github/apps_marketplace.go b/github/apps_marketplace.go new file mode 100644 index 0000000..86bed85 -- - /dev/null +++ b/github/apps_marketplace.go @ @ -0,0 +1,182 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// MarketplaceService handles communication with the marketplace related +// methods of the GitHub API . +// +// GitHub API docs : https : //developer.github.com/v3/apps/marketplace/ +type MarketplaceService struct { + client *Client + // Stubbed controls whether endpoints that return stubbed data are used + // instead of production endpoints . Stubbed data is fake data that 's useful + // for testing your GitHub Apps . Stubbed data is hard-coded and will not + // change based on actual subscriptions . + // + // GitHub API docs : https : //developer.github.com/v3/apps/marketplace/ + Stubbed bool + + ListOptions + } + +// MarketplacePlan represents a GitHub Apps Marketplace Listing Plan . +type MarketplacePlan struct { + URL *string ` json : '' url , omitempty '' `
diff -- git a/github/apps_marketplace.go b/github/apps_marketplace.go new file mode 100644 index 0000000..d3e689a -- - /dev/null +++ b/github/apps_marketplace.go @ @ -0,0 +1,180 @ @ +// Copyright 2017 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// MarketplaceService handles communication with the marketplace related +// methods of the GitHub API . +// +// GitHub API docs : https : //developer.github.com/v3/apps/marketplace/ +type MarketplaceService struct { + client *Client + // Stubbed controls whether endpoints that return stubbed data are used + // instead of production endpoints . Stubbed data is fake data that 's useful + // for testing your GitHub Apps . Stubbed data is hard-coded and will not + // change based on actual subscriptions . + // + // GitHub API docs : https : //developer.github.com/v3/apps/marketplace/ + Stubbed bool + } + +// MarketplacePlan represents a GitHub Apps Marketplace Listing Plan . +type MarketplacePlan struct { + URL *string ` json : '' url , omitempty '' ` + AccountsURL *string
diff -- git a/CONTRIBUTING.md b/CONTRIBUTING.md index 8da635a..68a23f0 100644 -- - a/CONTRIBUTING.md +++ b/CONTRIBUTING.md @ @ -55,7 +55,7 @ @ again . [ forking ] : https : //help.github.com/articles/fork-a-repo [ golint ] : https : //github.com/golang/lint - [ golint readme ] : https : //github.com/golang/lint/blob/master/README.md + [ golint readme ] : https : //github.com/golang/lint/blob/master/README [ gocov ] : https : //github.com/axw/gocov [ gocov-html ] : https : //github.com/matm/gocov-html [ well-formed commit messages ] : http : //tbaggery.com/2008/04/19/a-note-about-git-commit-messages.html diff -- git a/github/activity_events_test.go b/github/activity_events_test.go index 2b59d11..9234548 100644 -- - a/github/activity_events_test.go +++ b/github/activity_events_test.go @ @ -15,7 +15,7 @ @ import ( ) func TestActivityService_ListEvents ( t *testing.T ) { - setup ( ) + _ , mux , client , teardown : = setup ( ) defer teardown ( ) mux.HandleFunc ( `` /events '' , func ( w http.ResponseWriter , r *http.Request ) { @ @ -39,7 +39,7 @ @ func TestActivityService_ListEvents ( t *testing.T ) { } func TestActivityService_ListRepositoryEvents ( t *testing.T ) { - setup ( ) + _ , mux , client , teardown : = setup ( ) defer teardown ( ) mux.HandleFunc ( `` /repos/o/r/events '' , func ( w http.ResponseWriter , r *http.Request ) { @ @
diff -- git a/github/activity_events_test.go b/github/activity_events_test.go index 2b59d11..9234548 100644 -- - a/github/activity_events_test.go +++ b/github/activity_events_test.go @ @ -15,7 +15,7 @ @ import ( ) func TestActivityService_ListEvents ( t *testing.T ) { - setup ( ) + _ , mux , client , teardown : = setup ( ) defer teardown ( ) mux.HandleFunc ( `` /events '' , func ( w http.ResponseWriter , r *http.Request ) { @ @ -39,7 +39,7 @ @ func TestActivityService_ListEvents ( t *testing.T ) { } func TestActivityService_ListRepositoryEvents ( t *testing.T ) { - setup ( ) + _ , mux , client , teardown : = setup ( ) defer teardown ( ) mux.HandleFunc ( `` /repos/o/r/events '' , func ( w http.ResponseWriter , r *http.Request ) { @ @ -63,12 +63,15 @ @ func TestActivityService_ListRepositoryEvents ( t *testing.T ) { } func TestActivityService_ListRepositoryEvents_invalidOwner ( t *testing.T ) { + _ , _ , client , teardown : = setup ( ) + defer teardown ( ) + _ , _ , err : = client.Activity.ListRepositoryEvents ( context.Background ( ) , `` % '' , `` % '' , nil ) testURLParseError ( t , err ) } func TestActivityService_ListIssueEventsForRepository ( t *testing.T ) { -
diff -- git a/github/orgs_members.go b/github/orgs_members.go index 80454ad..77f6912 100644 -- - a/github/orgs_members.go +++ b/github/orgs_members.go @ @ -270,3 +270,29 @ @ func ( s *OrganizationsService ) RemoveOrgMembership ( user , org string ) ( *Response , return s.client.Do ( req , nil ) } + +// ListPendingOrgInvitations returns a list of pending invitations . +// +// GitHub API docs : https : //developer.github.com/v3/orgs/members/ # list-pending-organization-invitations +func ( s *OrganizationsService ) ListPendingOrgInvitations ( org int , opt *ListOptions ) ( [ ] *Invitation , *Response , error ) { + u : = fmt.Sprintf ( `` orgs/ % v/invitations '' , org ) + u , err : = addOptions ( u , opt ) + if err ! = nil { + return nil , nil , err + } + + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil { + return nil , nil , err + } + + // TODO : remove custom Accept header when this API fully launches . + req.Header.Set ( `` Accept '' , mediaTypeOrgMembershipPreview ) + + pendingInvitations : = new ( [ ] *Invitation ) + resp , err
diff -- git a/github/orgs_members_test.go b/github/orgs_members_test.go index ee1d2e6..704cf29 100644 -- - a/github/orgs_members_test.go +++ b/github/orgs_members_test.go @ @ -395,7 +395,11 @ @ func TestOrganizationsService_ListPendingOrgInvitations ( t *testing.T ) { } ) opt : = & ListOptions { Page : 1 } + < < < < < < < HEAD invitations , _ , err : = client.Organizations.ListPendingOrgInvitations ( context.Background ( ) , 1 , opt ) +======= + invitations , _ , err : = client.Organizations.ListPendingOrgInvitations ( 1 , opt ) + > > > > > > > 1bd4328a520dfc6d58f92e0f441f3f56718b725d if err ! = nil { t.Errorf ( `` Organizations.ListPendingOrgInvitations returned error : % v '' , err ) } diff -- git a/github/users_blocking.go b/github/users_blocking.go new file mode 100644 index 0000000..0a29530 -- - /dev/null +++ b/github/users_blocking.go @ @ -0,0 +1,79 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// ListBlockedUsers lists all the blocked users by the authenticated user +// +// GitHub API docs : https :
diff -- git a/github/github.go b/github/github.go index ba34310..8b2df80 100644 -- - a/github/github.go +++ b/github/github.go @ @ -97,6 +97,9 @ @ const ( // https : //developer.github.com/changes/2016-12-14-reviews-api/ mediaTypePullRequestReviewsPreview = `` application/vnd.github.black-cat-preview+json '' + + // https : //developer.github.com/changes/2017-02-28-user-blocking-apis-and-webhook/ + mediaTypeBlockUsersPreview = `` application/vnd.github.giant-sentry-fist-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/users_blocking.go b/github/users_blocking.go new file mode 100644 index 0000000..967ee5f -- - /dev/null +++ b/github/users_blocking.go @ @ -0,0 +1,91 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// ListBlockedUsers lists all the blocked users by the authenticated user . +// +// GitHub API docs : https : //developer.github.com/v3/users/blocking/ # list-blocked-users +func ( s *UsersService ) ListBlockedUsers ( ctx context.Context , opt *ListOptions ) ( [ ] *User , *Response , error ) { + u : = `` user/blocks '' + u , err : = addOptions ( u , opt ) + if err ! = nil { + return
diff -- git a/github/github.go b/github/github.go index ba34310..8b2df80 100644 -- - a/github/github.go +++ b/github/github.go @ @ -97,6 +97,9 @ @ const ( // https : //developer.github.com/changes/2016-12-14-reviews-api/ mediaTypePullRequestReviewsPreview = `` application/vnd.github.black-cat-preview+json '' + + // https : //developer.github.com/changes/2017-02-28-user-blocking-apis-and-webhook/ + mediaTypeBlockUsersPreview = `` application/vnd.github.giant-sentry-fist-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/users_blocking.go b/github/users_blocking.go new file mode 100644 index 0000000..3c570b9 -- - /dev/null +++ b/github/users_blocking.go @ @ -0,0 +1,91 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// ListBlockedUsers lists all the blocked users by the authenticated user . +// +// GitHub API docs : https : //developer.github.com/v3/users/blocking/ # list-blocked-users +func ( s *UsersService ) ListBlockedUsers ( ctx context.Context , opt *ListOptions ) ( [ ] *User , *Response , error ) { + u : = `` user/blocks '' + u , err : = addOptions ( u , opt ) + if err ! = nil { + return
diff -- git a/github/github.go b/github/github.go index a0c78aa..91a978c 100644 -- - a/github/github.go +++ b/github/github.go @ @ -51,9 +51,6 @ @ const ( // https : //developer.github.com/changes/2014-12-09-new-attributes-for-stars-api/ mediaTypeStarringPreview = `` application/vnd.github.v3.star+json '' - // https : //developer.github.com/changes/2015-11-11-protected-branches-api/ - mediaTypeProtectedBranchesPreview = `` application/vnd.github.loki-preview+json '' - // https : //help.github.com/enterprise/2.4/admin/guides/migrations/exporting-the-github-com-organization-s-repositories/ mediaTypeMigrationsPreview = `` application/vnd.github.wyandotte-preview+json '' @ @ -114,6 +111,9 @ @ const ( // https : //developer.github.com/changes/2018-01-25-organization-invitation-api-preview/ mediaTypeOrganizationInvitationPreview = `` application/vnd.github.dazzler-preview+json '' + // https : //developer.github.com/changes/2018-03-16-protected-branches-required-approving-reviews/ + mediaTypeRequiredApprovingReviewsPreview = `` application/vnd.github.luke-cage-preview+json '' + // https : //developer.github.com/changes/2018-02-22-label-description-search-preview/ mediaTypeLabelDescriptionSearchPreview = `` application/vnd.github.symmetra-preview+json '' diff -- git a/github/repos.go b/github/repos.go index aa9b6ac..aa874ed 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -565,6 +565,9 @ @ type PullRequestReviewsEnforcement struct { DismissStaleReviews bool ` json : '' dismiss_stale_reviews '' ` // RequireCodeOwnerReviews specifies if an approved review is required in pull requests including files with a designated code owner . RequireCodeOwnerReviews bool ` json : '' require_code_owner_reviews '' ` + // RequiredApprovingReviewCount specifies the number of approvals required before the pull request can be merged . + // Valid values are 1-6 . + RequiredApprovingReviewCount int ` json : '' required_approving_review_count '' ` } // PullRequestReviewsEnforcementRequest represents request to set the pull request review @ @ -579,6 +582,9 @
diff -- git a/github/gists.go b/github/gists.go index 15276ea..c54f225 100644 -- - a/github/gists.go +++ b/github/gists.go @ @ -30,6 +30,7 @ @ type Gist struct { GitPushURL *string ` json : '' git_push_url , omitempty '' ` CreatedAt *time.Time ` json : '' created_at , omitempty '' ` UpdatedAt *time.Time ` json : '' updated_at , omitempty '' ` + NodeID *string ` json : '' node_id , omitempty '' ` } func ( g Gist ) String ( ) string { @ @ -60,6 +61,7 @ @ type GistCommit struct { User *User ` json : '' user , omitempty '' ` ChangeStatus *CommitStats ` json : '' change_status , omitempty '' ` CommittedAt *Timestamp ` json : '' committed_at , omitempty '' ` + NodeID *string ` json : '' node_id , omitempty '' ` } func ( gc GistCommit ) String ( ) string { @ @ -73,6 +75,7 @ @ type GistFork struct { ID *string ` json : '' id , omitempty '' ` CreatedAt *Timestamp ` json : '' created_at , omitempty '' ` UpdatedAt *Timestamp ` json : '' updated_at , omitempty '' ` + NodeID *string ` json : '' node_id , omitempty '' `
diff -- git a/github/checks.go b/github/checks.go new file mode 100644 index 0000000..5b07eee -- - /dev/null +++ b/github/checks.go @ @ -0,0 +1,132 @ @ +// Copyright 2018 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + '' strings '' + '' time '' + ) + +// ChecksService provides access to the the Checks API in the +// GitHub API . +// +// GitHub API docs : https : //developer.github.com/v3/checks/ +type ChecksService service + +// CheckRun represents a GitHub check run on a repository associated with a GitHub app +type CheckRun struct { + ID *int64 ` json : '' id , omitempty '' ` + HeadSHA *string ` json : '' head_sha , omitempty '' ` + ExternalID *int64 ` json : '' external_id , omitempty '' ` + URL *string ` json : '' url , omitempty '' ` + HTMLURL *string ` json : '' html_url , omitempty '' ` + Status *string ` json : '' status , omitempty '' `
diff -- git a/github/timestamp_test.go b/github/timestamp_test.go index 997b43d..82a740c 100644 -- - a/github/timestamp_test.go +++ b/github/timestamp_test.go @ @ -13,9 +13,10 @ @ import ( ) const ( - emptyTimeStr = ` `` 0001-01-01T00:00:00Z '' ` - referenceTimeStr = ` `` 2006-01-02T15:04:05Z '' ` - referenceUnixTimeStr = ` 1136214245 ` + emptyTimeStr = ` `` 0001-01-01T00:00:00Z '' ` + referenceTimeStr = ` `` 2006-01-02T15:04:05Z '' ` + referenceTimeStrFractional = ` `` 2006-01-02T15:04:05.000Z '' ` // This format was returned by the Projects API before October 1 , 2017 . + referenceUnixTimeStr = ` 1136214245 ` ) var ( @ @ -58,6 +59,7 @ @ func TestTimestamp_Unmarshal ( t *testing.T ) { } { { `` Reference '' , referenceTimeStr , Timestamp { referenceTime } , false , true } , { `` ReferenceUnix '' , ` 1136214245 ` , Timestamp { referenceTime } , false , true } , + { `` ReferenceFractional '' , referenceTimeStrFractional , Timestamp { referenceTime } , false , true } , { `` Empty '' , emptyTimeStr , Timestamp { } , false , true } , { `` UnixStart '' , ` 0 ` , Timestamp { unixOrigin } , false , true } , { ``
diff -- git a/github/activity_notifications.go b/github/activity_notifications.go index b538a7b..5ae80ad 100644 -- - a/github/activity_notifications.go +++ b/github/activity_notifications.go @ @ -67,7 +67,7 @ @ func ( s *ActivityService ) ListNotifications ( opt *NotificationListOptions ) ( [ ] *No return nil , resp , err } - return notifications , resp , err + return notifications , resp , nil } // ListRepositoryNotifications lists all notifications in a given repository @ @ -92,7 +92,7 @ @ func ( s *ActivityService ) ListRepositoryNotifications ( owner , repo string , opt *N return nil , resp , err } - return notifications , resp , err + return notifications , resp , nil } type markReadOptions struct { @ @ -148,7 +148,7 @ @ func ( s *ActivityService ) GetThread ( id string ) ( *Notification , *Response , error ) return nil , resp , err } - return notification , resp , err + return notification , resp , nil } // MarkThreadRead marks the specified thread as read . @ @ -183,7 +183,7 @ @ func ( s *ActivityService ) GetThreadSubscription ( id string ) ( *Subscription , *Resp return nil , resp , err } - return sub , resp , err + return
diff -- git a/github/github-accessors.go b/github/github-accessors.go index d9939c2..9c8a6b2 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -3060,6 +3060,14 @ @ func ( i *Invitation ) GetTeamCount ( ) int { return *i.TeamCount } +// GetActiveLockReason returns the ActiveLockReason field if it 's non-nil , zero value otherwise . +func ( i *Issue ) GetActiveLockReason ( ) string { + if i == nil || i.ActiveLockReason == nil { + return `` '' + } + return *i.ActiveLockReason + } + // GetAssignee returns the Assignee field . func ( i *Issue ) GetAssignee ( ) *User { if i == nil { @ @ -3460,6 +3468,14 @ @ func ( i *IssueEvent ) GetLabel ( ) *Label { return i.Label } +// GetLockReason returns the LockReason field if it 's non-nil , zero value otherwise . +func ( i *IssueEvent ) GetLockReason ( ) string { + if i == nil || i.LockReason == nil { + return `` '' + } + return *i.LockReason + } + // GetMilestone returns the Milestone field . func ( i *IssueEvent ) GetMilestone ( ) *Milestone { if i == nil { @ @ -5972,6 +5988,14 @ @ func ( p *PublicEvent )
diff -- git a/github/messages.go b/github/messages.go index a7ec65f..d1808aa 100644 -- - a/github/messages.go +++ b/github/messages.go @ @ -33,6 +33,8 @ @ const ( signatureHeader = `` X-Hub-Signature '' // eventTypeHeader is the GitHub header key used to pass the event type . eventTypeHeader = `` X-Github-Event '' + // deliveryIDHeader is the GitHub header key used to pass the unique ID for the webhook event . + deliveryIDHeader = `` X-Github-Delivery '' ) var ( @ @ -163,6 +165,11 @ @ func WebHookType ( r *http.Request ) string { return r.Header.Get ( eventTypeHeader ) } +// DeliveryID returns the unique delivery ID of webhook request r. +func DeliveryID ( r *http.Request ) string { + return r.Header.Get ( deliveryIDHeader ) + } + // ParseWebHook parses the event payload . For recognized event types , a // value of the corresponding struct type will be returned ( as returned // by Event.ParsePayload ( ) ) . An error will be returned for unrecognized event diff -- git a/github/messages_test.go b/github/messages_test.go index 708e960..e6d7692 100644 -- - a/github/messages_test.go +++ b/github/messages_test.go @ @ -220,3 +220,17 @ @ func TestParseWebHook ( t *testing.T ) { } } } + +func TestDeliveryID ( t *testing.T ) { +
diff -- git a/github/github-accessors.go b/github/github-accessors.go index 10ee831..53c3b23 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -6180,6 +6180,78 @ @ func ( p *PreReceiveHook ) GetName ( ) string { return *p.Name } +// GetHRef returns the HRef field if it 's non-nil , zero value otherwise . +func ( p *PRLink ) GetHRef ( ) string { + if p == nil || p.HRef == nil { + return `` '' + } + return *p.HRef + } + +// GetComments returns the Comments field . +func ( p *PRLinks ) GetComments ( ) *PRLink { + if p == nil { + return nil + } + return p.Comments + } + +// GetCommits returns the Commits field . +func ( p *PRLinks ) GetCommits ( ) *PRLink { + if p == nil { + return nil + } + return p.Commits + } + +// GetHTML returns the HTML field . +func ( p *PRLinks ) GetHTML ( ) *PRLink { + if p == nil { + return nil + } + return p.HTML + } + +// GetIssue returns the Issue field . +func ( p *PRLinks ) GetIssue ( ) *PRLink { + if
diff -- git a/github/event_types.go b/github/event_types.go index da18f71..97472ce 100644 -- - a/github/event_types.go +++ b/github/event_types.go @ @ -172,14 +172,6 @ @ type IntegrationInstallationRepositoriesEvent struct { Sender *User ` json : '' sender , omitempty '' ` } -// Installation represents a GitHub integration installation . -type Installation struct { - ID *int ` json : '' id , omitempty '' ` - Account *User ` json : '' account , omitempty '' ` - AccessTokensURL *string ` json : '' access_tokens_url , omitempty '' ` - RepositoriesURL *string ` json : '' repositories_url , omitempty '' ` - } - // IssueCommentEvent is triggered when an issue comment is created on an issue // or pull request . // The Webhook event name is `` issue_comment '' . diff -- git a/github/github.go b/github/github.go index f04a011..3c3b985 100644 -- - a/github/github.go +++ b/github/github.go @ @ -90,6 +90,9 @ @ const ( // https : //developer.github.com/changes/2016-09-14-projects-api/ mediaTypeProjectsPreview = `` application/vnd.github.inertia-preview+json '' + + // https : //developer.github.com/v3/integrations/ + mediaTypeIntegrationPreview = `` application/vnd.github.machine-man-preview+json '' ) // A Client manages communication with the GitHub API . @ @ -120,6 +123,7 @ @ type Client struct { Gists *GistsService Git *GitService Gitignores *GitignoresService + Integrations *IntegrationsService Issues *IssuesService
diff -- git a/README.md b/README.md index 1a47292..333b4de 100644 -- - a/README.md +++ b/README.md @ @ -90,21 +90,7 @ @ For complete usage of go-github , see the full [ package docs ] [ ] . # # # Integration Tests # # # -You can run the integration tests from from the ` tests ` directory with : - - `` ` bash -GITHUB_AUTH_TOKEN= < your api token > go test ./ ... - `` ` - -You can create a token here : https : //github.com/settings/tokens - -These scopes are needed : - -* repo -* delete_repo -* user -* admin : public_key - +You can run integration tests from the ` tests ` directory . See the integration tests [ README ] ( tests/README.md ) . # # Roadmap # # This library is being initially developed for an internal application at diff -- git a/github/authorizations.go b/github/authorizations.go new file mode 100644 index 0000000..c5a2abc -- - /dev/null +++ b/github/authorizations.go @ @ -0,0 +1,312 @ @ +// Copyright 2014 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file .
diff -- git a/github/github.go b/github/github.go index 30b8390..62d9771 100644 -- - a/github/github.go +++ b/github/github.go @ @ -71,6 +71,7 @ @ type Client struct { Rate Rate // Services used for talking to different parts of the GitHub API . + OAuth *OAuthService Activity *ActivityService Gists *GistsService Git *GitService @ @ -133,6 +134,7 @ @ func NewClient ( httpClient *http.Client ) *Client { uploadURL , _ : = url.Parse ( uploadBaseURL ) c : = & Client { client : httpClient , BaseURL : baseURL , UserAgent : userAgent , UploadURL : uploadURL } + c.OAuth = & OAuthService { client : c } c.Activity = & ActivityService { client : c } c.Gists = & GistsService { client : c } c.Git = & GitService { client : c } @ @ -323,6 +325,7 @ @ func ( c *Client ) Do ( req *http.Request , v interface { } ) ( *Response , error ) { err = json.NewDecoder ( resp.Body ) .Decode ( v ) } } + return response , err } diff -- git a/github/oauth.go b/github/oauth.go new file mode 100644 index 0000000..349cec2 -- - /dev/null +++ b/github/oauth.go @ @ -0,0 +1,280 @ @ +// Copyright 2015 The
diff -- git a/github/github-accessors.go b/github/github-accessors.go index 4fed8e5..57817f0 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -2916,6 +2916,54 @ @ func ( n *NewPullRequest ) GetTitle ( ) string { return *n.Title } +// GetDescription returns the Description field if it 's non-nil , zero value otherwise . +func ( n *NewTeam ) GetDescription ( ) string { + if n == nil || n.Description == nil { + return `` '' + } + return *n.Description + } + +// GetID returns the ID field if it 's non-nil , zero value otherwise . +func ( n *NewTeam ) GetID ( ) int { + if n == nil || n.ID == nil { + return 0 + } + return *n.ID + } + +// GetName returns the Name field if it 's non-nil , zero value otherwise . +func ( n *NewTeam ) GetName ( ) string { + if n == nil || n.Name == nil { + return `` '' + } + return *n.Name + } + +// GetParentTeamID returns the ParentTeamID field if it 's non-nil , zero value otherwise . +func ( n *NewTeam ) GetParentTeamID ( ) string { + if n
diff -- git a/github/github.go b/github/github.go index 99ad8d0..6bc1c47 100644 -- - a/github/github.go +++ b/github/github.go @ @ -102,6 +102,9 @ @ const ( // https : //developer.github.com/changes/2017-07-26-team-review-request-thor-preview/ mediaTypeTeamReviewPreview = `` application/vnd.github.thor-preview+json '' + + // https : //developer.github.com/changes/2017-08-30-preview-nested-teams/ + mediaTypeNestedTeamsPreview = `` application/vnd.github.hellcat-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/orgs_teams.go b/github/orgs_teams.go index 684e2da..26dfa7a 100644 -- - a/github/orgs_teams.go +++ b/github/orgs_teams.go @ @ -8,6 +8,7 @ @ package github import ( '' context '' '' fmt '' + '' strings '' '' time '' ) @ @ -39,6 +40,7 @ @ type Team struct { Organization *Organization ` json : '' organization , omitempty '' ` MembersURL *string ` json : '' members_url , omitempty '' ` RepositoriesURL *string ` json : '' repositories_url , omitempty '' ` + Parent *Team ` json : '' parent , omitempty '' ` // LDAPDN is only available in GitHub Enterprise and when the team // membership is synchronized with LDAP . @ @ -79,6 +81,9 @ @ func ( s *OrganizationsService ) ListTeams ( ctx context.Context , org string , opt *L return nil , nil , err } + // TODO : remove custom Accept header
diff -- git a/github/github.go b/github/github.go index 0b58e73..8448982 100644 -- - a/github/github.go +++ b/github/github.go @ @ -84,6 +84,9 @ @ const ( // https : //developer.github.com/changes/2016-07-06-github-pages-preiew-api/ mediaTypePagesPreview = `` application/vnd.github.mister-fantastic-preview+json '' + + // https : //developer.github.com/v3/repos/traffic/ + mediaTypeTrafficPreview = `` application/vnd.github.spiderman-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/repos_traffic.go b/github/repos_traffic.go new file mode 100644 index 0000000..54072e3 -- - /dev/null +++ b/github/repos_traffic.go @ @ -0,0 +1,173 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' fmt '' + '' strconv '' + '' time '' + ) + +// Referrer represent a referrer information . +type Referrer struct { + Referrer *string ` json : '' referrer , omitempty '' ` + Count *int ` json : '' count , omitempty '' ` + Uniques *int ` json : '' uniques , omitempty '' ` + } + +// Path represent a referrer information . +type Path struct { + Path *string ` json : '' path ,
diff -- git a/github/github.go b/github/github.go index db06cfb..d777ae4 100644 -- - a/github/github.go +++ b/github/github.go @ @ -105,6 +105,9 @ @ const ( // https : //developer.github.com/changes/2017-08-30-preview-nested-teams/ mediaTypeNestedTeamsPreview = `` application/vnd.github.hellcat-preview+json '' + + // https : //developer.github.com/changes/2017-11-09-repository-transfer-api-preview/ + mediaTypeRepositoryTransferPreview = `` application/vnd.github.nightshade-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/repos.go b/github/repos.go index 037ddfa..6ce8bfd 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -1037,3 +1037,38 @ @ func ( s *RepositoriesService ) ReplaceAllTopics ( ctx context.Context , owner , repo return t.Names , resp , nil } + +// TransferRequest represents a request to transfer a repository . +type TransferRequest struct { + NewOwner string ` json : '' new_owner , omitempty '' ` + TeamID [ ] int ` json : '' team_id , omitempty '' ` + } + +// Transfer transfers a repository from one account or organization to another . +// +// This method might return an *AcceptedError and a status code of +// 202 . This is because this is the status that GitHub returns to signify that +// it has now scheduled the transfer of the repository in a background task . +// A follow up request , after
diff -- git a/github/activity_events.go b/github/activity_events.go index 6b35056..93006ef 100644 -- - a/github/activity_events.go +++ b/github/activity_events.go @ @ -56,6 +56,8 @ @ func ( e *Event ) ParsePayload ( ) ( payload interface { } , err error ) { payload = & IssuesEvent { } case `` LabelEvent '' : payload = & LabelEvent { } + case `` MarketplacePurchaseEvent '' : + payload = & MarketplacePurchaseEvent { } case `` MemberEvent '' : payload = & MemberEvent { } case `` MembershipEvent '' : diff -- git a/github/event_types.go b/github/event_types.go index c6b29b9..3e75dcf 100644 -- - a/github/event_types.go +++ b/github/event_types.go @ @ -268,6 +268,22 @ @ type LabelEvent struct { Installation *Installation ` json : '' installation , omitempty '' ` } +// MarketplacePurchaseEvent is triggered when a user purchases , cancels , or changes +// their GitHub Marketplace plan . +// Webhook event name `` marketplace_purchase '' . +// +// Github API docs : https : //developer.github.com/v3/activity/events/types/ # marketplacepurchaseevent +type MarketplacePurchaseEvent struct { + Action *string ` json : '' action , omitempty '' ` + + // The following fields are only populated by Webhook events . + EffectiveDate *Timestamp ` json : '' effective_date , omitempty '' ` + MarketplacePurchase *MarketplacePurchase
diff -- git a/github/orgs_teams.go b/github/orgs_teams.go index 6afcd1f..29ad4a8 100644 -- - a/github/orgs_teams.go +++ b/github/orgs_teams.go @ @ -50,13 +50,39 @ @ type Invitation struct { Login *string ` json : '' login , omitempty '' ` Email *string ` json : '' email , omitempty '' ` Role *string ` json : '' role , omitempty '' ` - CreatedAt *time.Time ` json : '' created_at , omitempty '' ` + CreatedAt time.Time ` json : '' created_at , omitempty '' ` + Inviter *Inviter ` json : '' inviter , omitempty '' ` } func ( i Invitation ) String ( ) string { return Stringify ( i ) } +// Inviter represents the entity introduced in team and org invitations +type Inviter struct { + Login *string ` json : '' login , omitempty '' ` + ID *int ` json : '' id , omitempty '' ` + Avatar_url *string ` json : '' avatar_url , omitempty '' ` + Gravatar_id *string ` json : '' gravatar_id , omitempty '' ` + Url *string ` json : '' url , omit_empty '' ` + Html_url *string ` json : '' html_url , omitempty '' ` + Followers_url *string `
diff -- git a/github/orgs_members.go b/github/orgs_members.go index 80454ad..957674c 100644 -- - a/github/orgs_members.go +++ b/github/orgs_members.go @ @ -270,3 +270,33 @ @ func ( s *OrganizationsService ) RemoveOrgMembership ( user , org string ) ( *Response , return s.client.Do ( req , nil ) } + +//ListPendingOrgInvitations returns a list of contains a role field which refers to the +//Organization Invitation role and will be one of the following values : +//direct_member , admin , billing_manager , hiring_manager , or reinstate . +//If the invitee is not a GitHub member , the login field in the return hash will be null . +// +// GitHub API docs : +// https : //developer.github.com/v3/orgs/members/ # list-pending-organization-invitations +func ( s *OrganizationsService ) ListPendingOrgInvitations ( org int , opt *ListOptions ) ( [ ] *Invitation , *Response , error ) { + u : = fmt.Sprintf ( `` orgs/ % v/invitations '' , org ) + u , err : = addOptions ( u , opt ) + if err ! = nil { + return nil , nil , err + } + + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil {
diff -- git a/github/github.go b/github/github.go index 6d4e777..a58dbfb 100644 -- - a/github/github.go +++ b/github/github.go @ @ -96,6 +96,9 @ @ const ( // https : //developer.github.com/changes/2017-01-05-commit-search-api/ mediaTypeCommitSearchPreview = `` application/vnd.github.cloak-preview+json '' + + // https : //developer.github.com/changes/2016-12-14-reviews-api/ + mediaTypePullRequestReviewsPreview = `` application/vnd.github.black-cat-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/pulls_reviews.go b/github/pulls_reviews.go index ae3cdd4..f6acf28 100644 -- - a/github/pulls_reviews.go +++ b/github/pulls_reviews.go @ @ -5,15 +5,166 @ @ package github -import `` time '' +import ( + '' fmt '' + '' time '' + ) // PullRequestReview represents a review of a pull request . type PullRequestReview struct { - ID *int ` json : '' id , omitempty '' ` - User *User ` json : '' user , omitempty '' ` - Body *string ` json : '' body , omitempty '' ` - SubmittedAt *time.Time ` json : '' submitted_at , omitempty '' ` + ID *int ` json : '' id , omitempty '' ` + User *User ` json : '' user , omitempty '' ` + Body *string ` json : '' body , omitempty '' ` + SubmittedAt *time.Time ` json : '' submitted_at , omitempty '' `
diff -- git a/github/repos_contents.go b/github/repos_contents.go index 0d0e4d9..fce8e7b 100644 -- - a/github/repos_contents.go +++ b/github/repos_contents.go @ @ -13,8 +13,10 @ @ import ( '' encoding/json '' '' errors '' '' fmt '' + '' io '' '' net/http '' '' net/url '' + '' path '' ) // RepositoryContent represents a file or directory in a github repository . @ @ -91,6 +93,38 @ @ func ( s *RepositoriesService ) GetReadme ( owner , repo string , opt *RepositoryConte return readme , resp , err } +// DownloadContents can be used to download files . It circumvents the normal +// GitHub API ( which has a file size limit ) and uses the ` download_url ` link +// provided by the API . That URL provides a direct link to the raw data +// associated with that version of the file and is not subject to the same +// limits as the GitHub API based requests . +// +// If path references a file or a symlink and the call succeeds , it +// returns an instance of io.ReadCloser that provides the contents of +// the file . Otherwise , it returns an error . +func ( s *RepositoriesService ) DownloadContents (
diff -- git a/github/event_types.go b/github/event_types.go index b641d42..1cb8bc1 100644 -- - a/github/event_types.go +++ b/github/event_types.go @ @ -490,12 +490,15 @ @ type PullRequestEvent struct { PullRequest *PullRequest ` json : '' pull_request , omitempty '' ` // The following fields are only populated by Webhook events . - Changes *EditChange ` json : '' changes , omitempty '' ` - RequestedReviewers [ ] *User ` json : '' requested_reviewers , omitempty '' ` // Populated in `` review_requested '' , `` review_request_removed '' event deliveries . - Repo *Repository ` json : '' repository , omitempty '' ` - Sender *User ` json : '' sender , omitempty '' ` - Installation *Installation ` json : '' installation , omitempty '' ` - Label *Label ` json : '' label , omitempty '' ` // Populated in `` labeled '' event deliveries . + Changes *EditChange ` json : '' changes , omitempty '' ` + // A request affecting multiple reviewers at once is split into multiple + // `` review_requested '' / '' review_request_removed '' event deliveries , each with + // a single , different RequestedReviewer + RequestedReviewer *User ` json : '' requested_reviewer , omitempty '' ` +
diff -- git a/github/github-accessors.go b/github/github-accessors.go index 2e9fcaf..3b970cf 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -3572,6 +3572,22 @ @ func ( l *Label ) GetColor ( ) string { return *l.Color } +// GetDefault returns the Default field if it 's non-nil , zero value otherwise . +func ( l *Label ) GetDefault ( ) bool { + if l == nil || l.Default == nil { + return false + } + return *l.Default + } + +// GetDescription returns the Description field if it 's non-nil , zero value otherwise . +func ( l *Label ) GetDescription ( ) string { + if l == nil || l.Description == nil { + return `` '' + } + return *l.Description + } + // GetID returns the ID field if it 's non-nil , zero value otherwise . func ( l *Label ) GetID ( ) int64 { if l == nil || l.ID == nil { @ @ -3652,6 +3668,78 @ @ func ( l *LabelEvent ) GetRepo ( ) *Repository { return l.Repo } +// GetColor returns the Color field if it 's non-nil , zero value otherwise . +func ( l *LabelResult ) GetColor (
diff -- git a/CONTRIBUTING.md b/CONTRIBUTING.md index 9e429bd..2216db7 100644 -- - a/CONTRIBUTING.md +++ b/CONTRIBUTING.md @ @ -74,4 +74,9 @ @ broken into separate service objects . These services map directly to how the [ GitHub API documentation ] [ ] is organized , so use that as your guide for where to put new methods . +Sub-service ( e.g . [ Repo Hooks ] [ ] ) implementations are split into separate files +based on the APIs they provide . These files are named service_api.go ( e.g . +repos_hooks.go ) to describe the API to service mappings . + [ GitHub API documentation ] : http : //developer.github.com/v3/ + [ Repo Hooks ] : http : //developer.github.com/v3/repos/hooks/ diff -- git a/github/activity.go b/github/activity.go index 491f9e7..a8456ae 100644 -- - a/github/activity.go +++ b/github/activity.go @ @ -5,12 +5,6 @ @ package github -import ( - '' fmt '' - '' net/url '' - '' strconv '' - ) - // ActivityService handles communication with the activity related // methods of the GitHub API . // @ @ -18,47 +12,3 @ @ import ( type ActivityService struct { client *Client } - -// ActivityListStarredOptions specifies the optional parameters to the -// ActivityService.ListStarred method . -type ActivityListStarredOptions
diff -- git a/github/github.go b/github/github.go index 301887f..20331e6 100644 -- - a/github/github.go +++ b/github/github.go @ @ -65,6 +65,8 @ @ const ( headerRateLimit = `` X-RateLimit-Limit '' headerRateRemaining = `` X-RateLimit-Remaining '' headerRateReset = `` X-RateLimit-Reset '' + + mimePreview = `` application/vnd.github.preview '' ) // A Client manages communication with the GitHub API . @ @ -96,6 +98,7 @ @ type Client struct { Users *UsersService Gists *GistsService Activity *ActivityService + Search *SearchService } // ListOptions specifies the optional parameters to various List methods that @ @ -124,6 +127,7 @ @ func NewClient ( httpClient *http.Client ) *Client { c.Users = & UsersService { client : c } c.Gists = & GistsService { client : c } c.Activity = & ActivityService { client : c } + c.Search = & SearchService { client : c } return c } diff -- git a/github/search.go b/github/search.go new file mode 100644 index 0000000..9fe01e9 -- - /dev/null +++ b/github/search.go @ @ -0,0 +1,137 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import
diff -- git a/github/github.go b/github/github.go index 0b58e73..ec59a5e 100644 -- - a/github/github.go +++ b/github/github.go @ @ -84,6 +84,9 @ @ const ( // https : //developer.github.com/changes/2016-07-06-github-pages-preiew-api/ mediaTypePagesPreview = `` application/vnd.github.mister-fantastic-preview+json '' + + // https : //developer.github.com/v3/repos/traffic/ + mediaTypeTrafficPreview = `` application/vnd.github.spiderman-preview '' ) // A Client manages communication with the GitHub API . diff -- git a/github/repo_traffic.go b/github/repo_traffic.go new file mode 100644 index 0000000..7f680cd -- - /dev/null +++ b/github/repo_traffic.go @ @ -0,0 +1,77 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import `` fmt '' + +// Referrer represent a referrer information +type Referrer struct { + Referrer *string ` json : '' referrer , omitempty '' ` + Count *int ` json : '' count , omitempty '' ` + Uniques *int ` json : '' uniques , omitempty '' ` + } + +// Path represent a referrer information +type Path struct { + Path *string ` json : '' path , omitempty '' ` + Title *string ` json : '' title , omitempty ''
diff -- git a/github/github.go b/github/github.go index 0b58e73..7cf6019 100644 -- - a/github/github.go +++ b/github/github.go @ @ -84,6 +84,9 @ @ const ( // https : //developer.github.com/changes/2016-07-06-github-pages-preiew-api/ mediaTypePagesPreview = `` application/vnd.github.mister-fantastic-preview+json '' + + // https : //developer.github.com/v3/repos/traffic/ + mediaTypeTrafficPreview = `` application/vnd.github.spiderman-preview+json '' ) // A Client manages communication with the GitHub API . @ @ -144,6 +147,12 @ @ type UploadOptions struct { Name string ` url : '' name , omitempty '' ` } +// TrafficBreakdownOptions specifies the parameters to methods that support breakdown per day or week . +// Can be one of : day , week . Default : day . +type TrafficBreakdownOptions struct { + Per string ` url : '' per , omitempty '' ` + } + // addOptions adds the parameters in opt as URL query parameters to s. opt // must be a struct whose fields may contain `` url '' tags . func addOptions ( s string , opt interface { } ) ( string , error ) { diff -- git a/github/repos_traffic.go b/github/repos_traffic.go new file mode 100644 index 0000000..0b2d79b -- - /dev/null +++ b/github/repos_traffic.go @ @ -0,0 +1,167 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved
diff -- git a/AUTHORS b/AUTHORS index f521b6d..b31fb2a 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -69,6 +69,7 @ @ i2bskn < i2bskn @ gmail.com > Isao Jonas < isao.jonas @ gmail.com > isqua < isqua @ isqua.ru > Jameel Haffejee < RC1140 @ republiccommandos.co.za > +Jeremy Morris < jeremylevanmorris @ gmail.com > Jihoon Chung < j.c @ navercorp.com > Joe Tsai < joetsai @ digital-static.net > John Engelman < john.r.engelman @ gmail.com > diff -- git a/github/apps.go b/github/apps.go index ff33893..4c3e7c6 100644 -- - a/github/apps.go +++ b/github/apps.go @ @ -37,4 +37,4 @ @ func ( s *AppsService ) ListInstallations ( ctx context.Context , opt *ListOptions ) ( } return i , resp , nil - } + } \ No newline at end of file diff -- git a/github/apps_installation.go b/github/apps_installation.go index 6a27799..2c8b054 100644 -- - a/github/apps_installation.go +++ b/github/apps_installation.go @ @ -47,3 +47,38 @ @ func ( s *AppsService ) ListRepos ( ctx context.Context , opt *ListOptions ) ( [ ] *Repos return r.Repositories , resp , nil } + +// Add a single repository to an installation . +// +// GitHub API docs : https : //developer.github.com/v3/apps/installations/ # add-repository-to-installation +func ( s *AppService ) AddRepository ( ctx context.Context , instID int
diff -- git a/AUTHORS b/AUTHORS index c15c465..e97e992 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -77,6 +77,7 @ @ i2bskn < i2bskn @ gmail.com > Isao Jonas < isao.jonas @ gmail.com > isqua < isqua @ isqua.ru > Jameel Haffejee < RC1140 @ republiccommandos.co.za > +Jeremy Morris < jeremylevanmorris @ gmail.com > Jan Kosecki < jan.kosecki91 @ gmail.com > Jihoon Chung < j.c @ navercorp.com > Jimmi Dyson < jimmidyson @ gmail.com > diff -- git a/github/apps.go b/github/apps.go index ff33893..4c3e7c6 100644 -- - a/github/apps.go +++ b/github/apps.go @ @ -37,4 +37,4 @ @ func ( s *AppsService ) ListInstallations ( ctx context.Context , opt *ListOptions ) ( } return i , resp , nil - } + } \ No newline at end of file diff -- git a/github/apps_installation.go b/github/apps_installation.go index 6a27799..fff5b42 100644 -- - a/github/apps_installation.go +++ b/github/apps_installation.go @ @ -5,7 +5,10 @ @ package github -import `` context '' +import ( + '' context '' + '' fmt '' + ) // Installation represents a GitHub Apps installation . type Installation struct { @ @ -47,3 +50,39 @ @ func ( s *AppsService ) ListRepos ( ctx context.Context , opt *ListOptions ) ( [ ] *Repos return r.Repositories , resp
diff -- git a/AUTHORS b/AUTHORS index c15c465..e97e992 100644 -- - a/AUTHORS +++ b/AUTHORS @ @ -77,6 +77,7 @ @ i2bskn < i2bskn @ gmail.com > Isao Jonas < isao.jonas @ gmail.com > isqua < isqua @ isqua.ru > Jameel Haffejee < RC1140 @ republiccommandos.co.za > +Jeremy Morris < jeremylevanmorris @ gmail.com > Jan Kosecki < jan.kosecki91 @ gmail.com > Jihoon Chung < j.c @ navercorp.com > Jimmi Dyson < jimmidyson @ gmail.com > diff -- git a/github/apps_installation.go b/github/apps_installation.go index 6a27799..aa14874 100644 -- - a/github/apps_installation.go +++ b/github/apps_installation.go @ @ -5,7 +5,10 @ @ package github -import `` context '' +import ( + '' context '' + '' fmt '' + ) // Installation represents a GitHub Apps installation . type Installation struct { @ @ -47,3 +50,38 @ @ func ( s *AppsService ) ListRepos ( ctx context.Context , opt *ListOptions ) ( [ ] *Repos return r.Repositories , resp , nil } + +// AddRepo adds a single repository to an installation . +// +// GitHub API docs : https : //developer.github.com/v3/apps/installations/ # add-repository-to-installation +func ( s *AppsService ) AddRepo ( ctx context.Context , instID , repoID int ) ( *Repository , *Response , error ) { + u :
diff -- git a/github/pulls.go b/github/pulls.go index 51c6ccb..c3dc2b7 100644 -- - a/github/pulls.go +++ b/github/pulls.go @ @ -189,12 +189,30 @ @ func ( s *PullRequestsService ) Create ( owner string , repo string , pull *NewPullReq return p , resp , err } +type pullRequestUpdate struct { + Title *string ` json : '' title , omitempty '' ` + Body *string ` json : '' body , omitempty '' ` + State *string ` json : '' state , omitempty '' ` + Base *string ` json : '' base , omitempty '' ` + } + // Edit a pull request . // // GitHub API docs : https : //developer.github.com/v3/pulls/ # update-a-pull-request func ( s *PullRequestsService ) Edit ( owner string , repo string , number int , pull *PullRequest ) ( *PullRequest , *Response , error ) { u : = fmt.Sprintf ( `` repos/ % v/ % v/pulls/ % d '' , owner , repo , number ) - req , err : = s.client.NewRequest ( `` PATCH '' , u , pull ) + + update : = new ( pullRequestUpdate ) + if pull ! = nil { + update.Title = pull.Title + update.Body =
diff -- git a/README.md b/README.md index e035fae..6414088 100644 -- - a/README.md +++ b/README.md @ @ -215,17 +215,6 @ @ For complete usage of go-github , see the full [ package docs ] [ ] . [ GraphQL API v4 ] : https : //developer.github.com/v4/ [ shurcooL/githubql ] : https : //github.com/shurcooL/githubql - # # # Google App Engine # # # - -Go on App Engine Classic ( which as of this writing uses Go 1.6 ) can not use -the ` `` context '' ` import and still relies on ` `` golang.org/x/net/context '' ` . -As a result , if you wish to continue to use ` go-github ` on App Engine Classic , -you will need to rewrite all the ` `` context '' ` imports using the following command : - - gofmt -w -r ' '' context '' - > `` golang.org/x/net/context '' ' *.go - -See ` with_appengine.go ` for more details . - # # # Integration Tests # # # You can run integration tests from the ` test ` directory . See the integration tests [ README ] ( test/README.md ) . diff -- git a/github/doc.go b/github/doc.go index 9f12400..96445d2 100644 --
diff -- git a/github/activity_events.go b/github/activity_events.go index a919b11..47f0c73 100644 -- - a/github/activity_events.go +++ b/github/activity_events.go @ @ -96,6 +96,8 @ @ func ( e *Event ) ParsePayload ( ) ( payload interface { } , err error ) { payload = & ReleaseEvent { } case `` RepositoryEvent '' : payload = & RepositoryEvent { } + case `` RepositoryVulnerabilityAlertEvent '' : + payload = & RepositoryVulnerabilityAlertEvent { } case `` StatusEvent '' : payload = & StatusEvent { } case `` TeamEvent '' : diff -- git a/github/event_types.go b/github/event_types.go index 9f49b34..1827ce5 100644 -- - a/github/event_types.go +++ b/github/event_types.go @ @ -710,6 +710,27 @ @ type RepositoryEvent struct { Installation *Installation ` json : '' installation , omitempty '' ` } +// RepositoryVulnerabilityAlertEvent is triggered when a security alert is created , dismissed , or resolved . +// +// GitHub API docs : https : //developer.github.com/v3/activity/events/types/ # repositoryvulnerabilityalertevent +type RepositoryVulnerabilityAlertEvent struct { + // Action is the action that was performed . This can be : `` create '' , `` dismiss '' , `` resolve '' + Action *string ` json : '' action , omitempty '' ` + + //The security alert of the vulnerable dependency . + Alert *struct {
diff -- git a/github/activity_events.go b/github/activity_events.go index a919b11..47f0c73 100644 -- - a/github/activity_events.go +++ b/github/activity_events.go @ @ -96,6 +96,8 @ @ func ( e *Event ) ParsePayload ( ) ( payload interface { } , err error ) { payload = & ReleaseEvent { } case `` RepositoryEvent '' : payload = & RepositoryEvent { } + case `` RepositoryVulnerabilityAlertEvent '' : + payload = & RepositoryVulnerabilityAlertEvent { } case `` StatusEvent '' : payload = & StatusEvent { } case `` TeamEvent '' : diff -- git a/github/event_types.go b/github/event_types.go index 9f49b34..1827ce5 100644 -- - a/github/event_types.go +++ b/github/event_types.go @ @ -710,6 +710,27 @ @ type RepositoryEvent struct { Installation *Installation ` json : '' installation , omitempty '' ` } +// RepositoryVulnerabilityAlertEvent is triggered when a security alert is created , dismissed , or resolved . +// +// GitHub API docs : https : //developer.github.com/v3/activity/events/types/ # repositoryvulnerabilityalertevent +type RepositoryVulnerabilityAlertEvent struct { + // Action is the action that was performed . This can be : `` create '' , `` dismiss '' , `` resolve '' + Action *string ` json : '' action , omitempty '' ` + + //The security alert of the vulnerable dependency . + Alert *struct {
diff -- git a/github/github-accessors.go b/github/github-accessors.go index bf39fee..6728069 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -500,84 +500,36 @ @ func ( c *CommitFile ) GetStatus ( ) string { return *c.Status } -// GetAuthorDate returns the AuthorDate field if it 's non-nil , zero value otherwise . -func ( c *CommitResult ) GetAuthorDate ( ) Timestamp { - if c == nil || c.AuthorDate == nil { - return Timestamp { } - } - return *c.AuthorDate - } - -// GetAuthorEmail returns the AuthorEmail field if it 's non-nil , zero value otherwise . -func ( c *CommitResult ) GetAuthorEmail ( ) string { - if c == nil || c.AuthorEmail == nil { - return `` '' - } - return *c.AuthorEmail - } - -// GetAuthorID returns the AuthorID field if it 's non-nil , zero value otherwise . -func ( c *CommitResult ) GetAuthorID ( ) int { - if c == nil || c.AuthorID == nil { - return 0 - } - return *c.AuthorID - } - -// GetAuthorName returns the AuthorName field if it 's non-nil , zero value otherwise . -func ( c *CommitResult ) GetAuthorName ( ) string { - if
diff -- git a/github/github-accessors.go b/github/github-accessors.go index daccf55..481161a 100644 -- - a/github/github-accessors.go +++ b/github/github-accessors.go @ @ -10204,6 +10204,22 @ @ func ( u *User ) GetURL ( ) string { return *u.URL } +// GetMessage returns the Message field if it 's non-nil , zero value otherwise . +func ( u *UserContext ) GetMessage ( ) string { + if u == nil || u.Message == nil { + return `` '' + } + return *u.Message + } + +// GetOcticon returns the Octicon field if it 's non-nil , zero value otherwise . +func ( u *UserContext ) GetOcticon ( ) string { + if u == nil || u.Octicon == nil { + return `` '' + } + return *u.Octicon + } + // GetEmail returns the Email field if it 's non-nil , zero value otherwise . func ( u *UserEmail ) GetEmail ( ) string { if u == nil || u.Email == nil { diff -- git a/github/github.go b/github/github.go index f5bb2ec..44dab36 100644 -- - a/github/github.go +++ b/github/github.go @ @ -113,6 +113,9 @ @ const ( // https : //developer.github.com/changes/2018-01-25-organization-invitation-api-preview/ mediaTypeOrganizationInvitationPreview = `` application/vnd.github.dazzler-preview+json '' + + // https : //developer.github.com/changes/2018-03-21-hovercard-api-preview/ + mediaTypeHovercardPreview = ``
diff -- git a/github/orgs_teams.go b/github/orgs_teams.go index 684e2da..cd31ea0 100644 -- - a/github/orgs_teams.go +++ b/github/orgs_teams.go @ @ -196,6 +196,9 @ @ func ( s *OrganizationsService ) ListTeamMembers ( ctx context.Context , team int , op // IsTeamMember checks if a user is a member of the specified team . // // GitHub API docs : https : //developer.github.com/v3/orgs/teams/ # get-team-member +// +// Deprecated : This API has been marked as deprecated in the Github API docs , +// OrganisationService.GetTeamMembership method should be used instead . func ( s *OrganizationsService ) IsTeamMember ( ctx context.Context , team int , user string ) ( bool , *Response , error ) { u : = fmt.Sprintf ( `` teams/ % v/members/ % v '' , team , user ) req , err : = s.client.NewRequest ( `` GET '' , u , nil )
diff -- git a/github/github.go b/github/github.go index e86a0eb..004e8b8 100644 -- - a/github/github.go +++ b/github/github.go @ @ -27,7 +27,7 @ @ import ( ) const ( - libraryVersion = `` 8 '' + libraryVersion = `` 9 '' defaultBaseURL = `` https : //api.github.com/ '' uploadBaseURL = `` https : //uploads.github.com/ '' userAgent = `` go-github/ '' + libraryVersion @ @ -99,6 +99,9 @ @ const ( // https : //developer.github.com/changes/2017-07-17-update-topics-on-repositories/ mediaTypeTopicsPreview = `` application/vnd.github.mercy-preview+json '' + + // https : //developer.github.com/changes/2017-07-26-team-review-request-thor-preview/ + mediaTypeTeamReviewPreview = `` application/vnd.github.thor-preview+json '' ) // A Client manages communication with the GitHub API . diff -- git a/github/pulls_reviewers.go b/github/pulls_reviewers.go index bd94a65..f44a072 100644 -- - a/github/pulls_reviewers.go +++ b/github/pulls_reviewers.go @ @ -10,21 +10,25 @ @ import ( '' fmt '' ) -// RequestReviewers creates a review request for the provided GitHub users for the specified pull request . +// RequestReviewers creates a review request for the provided GitHub users and teams for the specified pull request . // // GitHub API docs : https : //developer.github.com/v3/pulls/review_requests/ # create-a-review-request -func ( s *PullRequestsService ) RequestReviewers ( ctx context.Context , owner , repo string , number int , logins [ ] string ) ( *PullRequest , *Response , error ) {
diff -- git a/github/git_commits.go b/github/git_commits.go index a2b17fc..e391d66 100644 -- - a/github/git_commits.go +++ b/github/git_commits.go @ @ -68,8 +68,7 @ @ func ( s *GitService ) GetCommit ( ctx context.Context , owner string , repo string , s return nil , nil , err } - // TODO : remove custom Accept headers when APIs fully launch . - req.Header.Set ( `` Accept '' , mediaTypeGitSigningPreview ) + req.Header.Set ( `` Accept '' , mediaTypeV3 ) c : = new ( Commit ) resp , err : = s.client.Do ( ctx , req , c ) diff -- git a/github/git_commits_test.go b/github/git_commits_test.go index ff8827f..6f836fc 100644 -- - a/github/git_commits_test.go +++ b/github/git_commits_test.go @ @ -20,7 +20,7 @ @ func TestGitService_GetCommit ( t *testing.T ) { mux.HandleFunc ( `` /repos/o/r/git/commits/s '' , func ( w http.ResponseWriter , r *http.Request ) { testMethod ( t , r , `` GET '' ) - testHeader ( t , r , `` Accept '' , mediaTypeGitSigningPreview ) + testHeader ( t , r , `` Accept '' , mediaTypeV3 ) fmt.Fprint ( w , ` { `` sha '' : '' s '' , '' message '' : '' m '' , '' author '' : { `` name
diff -- git a/github/activity_events.go b/github/activity_events.go index 6bf38b4..bfe2e7f 100644 -- - a/github/activity_events.go +++ b/github/activity_events.go @ @ -53,6 +53,10 @ @ func ( e *Event ) Payload ( ) ( payload interface { } ) { payload = & IssueActivityEvent { } case `` IssueCommentEvent '' : payload = & IssueCommentEvent { } + case `` LabelEvent '' : + payload = & LabelEvent { } + case `` MilestoneEvent '' : + payload = & MilestoneEvent { } case `` IssuesEvent '' : payload = & IssuesEvent { } case `` MemberEvent '' : diff -- git a/github/event_types.go b/github/event_types.go index 16f89b0..81121f8 100644 -- - a/github/event_types.go +++ b/github/event_types.go @ @ -190,6 +190,39 @ @ type IssueCommentEvent struct { Sender *User ` json : '' sender , omitempty '' ` } +// LabelEvent is triggered when a repository 's label is created , edited , or deleted . +// The Webhook event name is `` label '' +// +// GitHub docs : https : //developer.github.com/v3/activity/events/types/ # labelevent +type LabelEvent struct { + // Action is the action that was performed . Possible values are : + // `` created '' , `` edited '' , `` deleted '' + Action *string ` json
diff -- git a/github/pulls_reviewers.go b/github/pulls_reviewers.go new file mode 100644 index 0000000..9e18d57 -- - /dev/null +++ b/github/pulls_reviewers.go @ @ -0,0 +1,84 @ @ +// Copyright 2017 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' context '' + '' fmt '' + ) + +// RequestReviewers creates a review request for the provided GitHub users for the specified pull request . +// +// GitHub API docs : https : //developer.github.com/v3/pulls/review_requests/ # create-a-review-request +func ( s *PullRequestsService ) RequestReviewers ( ctx context.Context , owner , repo string , number int , logins [ ] string ) ( *PullRequest , *Response , error ) { + u : = fmt.Sprintf ( `` repos/ % s/ % s/pulls/ % d/requested_reviewers '' , owner , repo , number ) + + reviewers : = struct { + Reviewers [ ] string ` json : '' reviewers , omitempty '' ` + } { + Reviewers : logins , + } + req , err : = s.client.NewRequest ( `` POST '' , u , &
diff -- git a/github/orgs_members.go b/github/orgs_members.go index 80454ad..77f6912 100644 -- - a/github/orgs_members.go +++ b/github/orgs_members.go @ @ -270,3 +270,29 @ @ func ( s *OrganizationsService ) RemoveOrgMembership ( user , org string ) ( *Response , return s.client.Do ( req , nil ) } + +// ListPendingOrgInvitations returns a list of pending invitations . +// +// GitHub API docs : https : //developer.github.com/v3/orgs/members/ # list-pending-organization-invitations +func ( s *OrganizationsService ) ListPendingOrgInvitations ( org int , opt *ListOptions ) ( [ ] *Invitation , *Response , error ) { + u : = fmt.Sprintf ( `` orgs/ % v/invitations '' , org ) + u , err : = addOptions ( u , opt ) + if err ! = nil { + return nil , nil , err + } + + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil { + return nil , nil , err + } + + // TODO : remove custom Accept header when this API fully launches . + req.Header.Set ( `` Accept '' , mediaTypeOrgMembershipPreview ) + + pendingInvitations : = new ( [ ] *Invitation ) + resp , err
diff -- git a/github/repos_collaborators.go b/github/repos_collaborators.go new file mode 100644 index 0000000..2972281 -- - /dev/null +++ b/github/repos_collaborators.go @ @ -0,0 +1,69 @ @ +// Copyright 2013 The go-github AUTHORS . All rights reserved . +// +// Use of this source code is governed by a BSD-style +// license that can be found in the LICENSE file . + +package github + +import ( + '' fmt '' + ) + +// ListCollaborators lists the Github users that have access to the repository . +// +// GitHub API docs : http : //developer.github.com/v3/repos/collaborators/ # list +func ( s *RepositoriesService ) ListCollaborators ( owner , repo string ) ( [ ] User , *Response , error ) { + u : = fmt.Sprintf ( `` repos/ % v/ % v/collaborators '' , owner , repo ) + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil { + return nil , nil , err + } + + users : = new ( [ ] User ) + resp , err : = s.client.Do ( req , users ) + return *users , resp , err + } + +// IsCollaborator
diff -- git a/github/repos.go b/github/repos.go index 2f3ead0..37c1280 100644 -- - a/github/repos.go +++ b/github/repos.go @ @ -210,6 +210,25 @ @ func ( s *RepositoriesService ) Get ( owner , repo string ) ( *Repository , *Response , e return repository , resp , err } +// GetByID fetches a repository by its numeric ID . +// +// Note : GetByID uses the undocumented GitHub API endpoint /repositories/ : id . +func ( s *RepositoriesService ) GetByID ( id int ) ( *Repository , *Response , error ) { + u : = fmt.Sprintf ( `` repositories/ % d '' , id ) + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil { + return nil , nil , err + } + + repository : = new ( Repository ) + resp , err : = s.client.Do ( req , repository ) + if err ! = nil { + return nil , resp , err + } + + return repository , resp , err + } + // Edit updates a repository . // // GitHub API docs : http : //developer.github.com/v3/repos/ # edit diff --
diff -- git a/github/github.go b/github/github.go index 54769bc..d83ee5b 100644 -- - a/github/github.go +++ b/github/github.go @ @ -207,11 +207,22 @ @ func addOptions ( s string , opt interface { } ) ( string , error ) { // authentication , provide an http.Client that will perform the authentication // for you ( such as that provided by the golang.org/x/oauth2 library ) . func NewClient ( httpClient *http.Client ) *Client { + return newClient ( httpClient , defaultBaseURL , uploadBaseURL ) + } + +// NewEnterpriseClient returns a new GitHub API client ( same as NewClient ) , except +// it allows injection of an enterprise URL . +func NewEnterpriseClient ( httpClient *http.Client , enterpriseUrl string ) *Client { + return newClient ( httpClient , enterpriseUrl , enterpriseUrl ) + } + +func newClient ( httpClient *http.Client , baseUrl string , uploadUrl string ) *Client { if httpClient == nil { httpClient = http.DefaultClient } - baseURL , _ : = url.Parse ( defaultBaseURL ) - uploadURL , _ : = url.Parse ( uploadBaseURL ) + + baseURL , _ : = url.Parse ( baseUrl ) + uploadURL , _ : = url.Parse ( uploadUrl ) c : = & Client {
diff -- git a/github/github.go b/github/github.go index 54769bc..d7d5271 100644 -- - a/github/github.go +++ b/github/github.go @ @ -235,6 +235,23 @ @ func NewClient ( httpClient *http.Client ) *Client { return c } +// NewEnterpriseClient returns a new GitHub API client ( same as NewClient ) , +// except it allows injection of custom base and upload urls . These urls might +// be the same , but for flexibility both can be set separately . +func NewEnterpriseClient ( httpClient *http.Client , baseURL string , uploadURL string ) *Client { + if ! strings.HasSuffix ( baseURL , `` / '' ) { + baseURL = baseURL + `` / '' + } + if ! strings.HasSuffix ( uploadURL , `` / '' ) { + uploadURL = uploadURL + `` / '' + } + + c : = NewClient ( httpClient ) + c.BaseURL , _ = url.Parse ( baseURL ) + c.UploadURL , _ = url.Parse ( uploadURL ) + return c + } + // NewRequest creates an API request . A relative URL can be provided in urlStr , // in which case it is resolved relative to the BaseURL of the Client . // Relative URLs should always
diff -- git a/github/github.go b/github/github.go index 54769bc..36765db 100644 -- - a/github/github.go +++ b/github/github.go @ @ -235,6 +235,37 @ @ func NewClient ( httpClient *http.Client ) *Client { return c } +// NewEnterpriseClient returns a new GitHub API client with provided +// base URL and upload URL ( often the same URL ) . +// If either URL does not have a trailing slash , one is added automatically . +// If a nil httpClient is provided , http.DefaultClient will be used . +// +// Note that NewEnterpriseClient is a convenience helper only ; +// its behavior is equivalent to using NewClient , followed by setting +// the BaseURL and UploadURL fields . +func NewEnterpriseClient ( baseEndpointStr , uploadEndpointStr string , httpClient *http.Client ) ( *Client , error ) { + baseEndpoint , err : = url.Parse ( baseEndpointStr ) + if err ! = nil { + return nil , err + } + if ! strings.HasSuffix ( baseEndpoint.Path , `` / '' ) { + baseEndpoint.Path += `` / '' + } + + uploadEndpoint , err : = url.Parse ( uploadEndpointStr ) + if err ! = nil { + return nil , err + } + if
diff -- git a/github/github.go b/github/github.go index 54769bc..ffc0ff1 100644 -- - a/github/github.go +++ b/github/github.go @ @ -235,6 +235,37 @ @ func NewClient ( httpClient *http.Client ) *Client { return c } +// NewEnterpriseClient returns a new GitHub API client with provided +// base URL and upload URL ( often the same URL ) . +// If either URL does not have a trailing slash , one is added automatically . +// If a nil httpClient is provided , http.DefaultClient will be used . +// +// Note that NewEnterpriseClient is a convenience helper only ; +// its behavior is equivalent to using NewClient , followed by setting +// the BaseURL and UploadURL fields . +func NewEnterpriseClient ( baseURL , uploadURL string , httpClient *http.Client ) ( *Client , error ) { + baseEndpoint , err : = url.Parse ( baseURL ) + if err ! = nil { + return nil , err + } + if ! strings.HasSuffix ( baseEndpoint.Path , `` / '' ) { + baseEndpoint.Path += `` / '' + } + + uploadEndpoint , err : = url.Parse ( uploadURL ) + if err ! = nil { + return nil , err + } + if
diff -- git a/github/orgs_members.go b/github/orgs_members.go index 80454ad..77f6912 100644 -- - a/github/orgs_members.go +++ b/github/orgs_members.go @ @ -270,3 +270,29 @ @ func ( s *OrganizationsService ) RemoveOrgMembership ( user , org string ) ( *Response , return s.client.Do ( req , nil ) } + +// ListPendingOrgInvitations returns a list of pending invitations . +// +// GitHub API docs : https : //developer.github.com/v3/orgs/members/ # list-pending-organization-invitations +func ( s *OrganizationsService ) ListPendingOrgInvitations ( org int , opt *ListOptions ) ( [ ] *Invitation , *Response , error ) { + u : = fmt.Sprintf ( `` orgs/ % v/invitations '' , org ) + u , err : = addOptions ( u , opt ) + if err ! = nil { + return nil , nil , err + } + + req , err : = s.client.NewRequest ( `` GET '' , u , nil ) + if err ! = nil { + return nil , nil , err + } + + // TODO : remove custom Accept header when this API fully launches . + req.Header.Set ( `` Accept '' , mediaTypeOrgMembershipPreview ) + + pendingInvitations : = new ( [ ] *Invitation ) + resp , err
diff -- git a/github/orgs_teams.go b/github/orgs_teams.go index 6afcd1f..29ad4a8 100644 -- - a/github/orgs_teams.go +++ b/github/orgs_teams.go @ @ -50,13 +50,39 @ @ type Invitation struct { Login *string ` json : '' login , omitempty '' ` Email *string ` json : '' email , omitempty '' ` Role *string ` json : '' role , omitempty '' ` - CreatedAt *time.Time ` json : '' created_at , omitempty '' ` + CreatedAt time.Time ` json : '' created_at , omitempty '' ` + Inviter *Inviter ` json : '' inviter , omitempty '' ` } func ( i Invitation ) String ( ) string { return Stringify ( i ) } +// Inviter represents the entity introduced in team and org invitations +type Inviter struct { + Login *string ` json : '' login , omitempty '' ` + ID *int ` json : '' id , omitempty '' ` + Avatar_url *string ` json : '' avatar_url , omitempty '' ` + Gravatar_id *string ` json : '' gravatar_id , omitempty '' ` + Url *string ` json : '' url , omit_empty '' ` + Html_url *string ` json : '' html_url , omitempty '' ` + Followers_url *string `
diff -- git a/github/activity_events.go b/github/activity_events.go index 4e64785..8ba7ca7 100644 -- - a/github/activity_events.go +++ b/github/activity_events.go @ @ -68,6 +68,12 @ @ func ( e *Event ) Payload ( ) ( payload interface { } ) { payload = & PageBuildEvent { } case `` PingEvent '' : payload = & PingEvent { } + case `` ProjectEvent '' : + payload = & ProjectEvent { } + case `` ProjectCardEvent '' : + payload = & ProjectCardEvent { } + case `` ProjectColumnEvent '' : + payload = & ProjectColumnEvent { } case `` PublicEvent '' : payload = & PublicEvent { } case `` PullRequestEvent '' : diff -- git a/github/event_types.go b/github/event_types.go index 7617a31..4fb5d95 100644 -- - a/github/event_types.go +++ b/github/event_types.go @ @ -141,6 +141,30 @ @ type EditChange struct { } ` json : '' body , omitempty '' ` } +// ProjectChange represents the changes when a project has been edited . +type ProjectChange struct { + Name *struct { + From *string ` json : '' from , omitempty '' ` + } ` json : '' name , omitempty '' ` + Body *struct { + From *string ` json : '' from , omitempty '' ` +
diff -- git a/github/activity_events.go b/github/activity_events.go index 4e64785..8ba7ca7 100644 -- - a/github/activity_events.go +++ b/github/activity_events.go @ @ -68,6 +68,12 @ @ func ( e *Event ) Payload ( ) ( payload interface { } ) { payload = & PageBuildEvent { } case `` PingEvent '' : payload = & PingEvent { } + case `` ProjectEvent '' : + payload = & ProjectEvent { } + case `` ProjectCardEvent '' : + payload = & ProjectCardEvent { } + case `` ProjectColumnEvent '' : + payload = & ProjectColumnEvent { } case `` PublicEvent '' : payload = & PublicEvent { } case `` PullRequestEvent '' : diff -- git a/github/event_types.go b/github/event_types.go index 7617a31..4fb5d95 100644 -- - a/github/event_types.go +++ b/github/event_types.go @ @ -141,6 +141,30 @ @ type EditChange struct { } ` json : '' body , omitempty '' ` } +// ProjectChange represents the changes when a project has been edited . +type ProjectChange struct { + Name *struct { + From *string ` json : '' from , omitempty '' ` + } ` json : '' name , omitempty '' ` + Body *struct { + From *string ` json : '' from , omitempty '' ` +
diff -- git a/assets/questions/incNumber.js b/assets/questions/incNumber.js new file mode 100644 index 0000000..89a0bb3 -- - /dev/null +++ b/assets/questions/incNumber.js @ @ -0,0 +1,165 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for incrementDecCodedNumber . + */ + + +/* eslint no-magic-numbers : [ `` error '' , + { `` ignore '' : [ 0 , 1 , 2 , 3 , 4 , 5 , 6 , 7 , 8 , 9 ] } ] */ + +globalData.questions [ 'incNumber ' ] = {
diff -- git a/assets/question_sets/strings.js b/assets/question_sets/strings.js index 197eda5..4071519 100644 -- - a/assets/question_sets/strings.js +++ b/assets/question_sets/strings.js @ @ -26,5 +26,5 @ @ globalData.questionSets [ 'strings ' ] = { // eslint-disable-line dot-notation `` I will provide you with feedback . '' ] .join ( `` ) ] , - questionIds : [ 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' ] + questionIds : [ 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' , 'sortItinerary ' ] } ; diff -- git a/assets/questions/sortItinerary.js b/assets/questions/sortItinerary.js new file mode 100644 index 0000000..2c91716 -- - /dev/null +++ b/assets/questions/sortItinerary.js @ @ -0,0 +1,131 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express
diff -- git a/assets/questions/sortItinerary.js b/assets/questions/sortItinerary.js new file mode 100644 index 0000000..16c17c5 -- - /dev/null +++ b/assets/questions/sortItinerary.js @ @ -0,0 +1,131 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Sort Scrambled Itinerary . + */ + +globalData.questions [ 'sortItinerary ' ] = { // eslint-disable-line dot-notation + title : 'Sort Scrambled Itinerary ' , + starterCode : { + python : + ` def sortItinerary ( tickets ) : + return `` '' + ` + } , + auxiliaryCode : {
diff -- git a/assets/questions/longestSub.js b/assets/questions/longestSub.js new file mode 100755 index 0000000..3e45a96 -- - /dev/null +++ b/assets/questions/longestSub.js @ @ -0,0 +1,103 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for longest substring with at most two distinct + * characters problem . + */ + +globalData.questions [ 'longestSubstring ' ] = { // eslint-disable-line dot-notation + title : 'Longest Substring With At Most Two Distinct Characters ' , + starterCode : { + python : + ` def longestSubstring ( str ) :
diff -- git a/assets/questions/longestSub.js b/assets/questions/longestSub.js new file mode 100755 index 0000000..3e45a96 -- - /dev/null +++ b/assets/questions/longestSub.js @ @ -0,0 +1,103 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for longest substring with at most two distinct + * characters problem . + */ + +globalData.questions [ 'longestSubstring ' ] = { // eslint-disable-line dot-notation + title : 'Longest Substring With At Most Two Distinct Characters ' , + starterCode : { + python : + ` def longestSubstring ( str ) :
diff -- git a/assets/questions/unknownAlphabet.js b/assets/questions/unknownAlphabet.js new file mode 100644 index 0000000..bc7458f -- - /dev/null +++ b/assets/questions/unknownAlphabet.js @ @ -0,0 +1,325 @ @ +// Copyright 2017 The TIE Author , s. All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Unknown Alphabet . + */ + +globalData.questions [ 'unknownAlphabet ' ] = { // eslint-disable-line dot-notation + title : 'Unknow Alphabet ' , + starterCode : { + python : + ` def findDictionary ( words ) : + return `` '' ` + } , + auxiliaryCode : { + python
diff -- git a/assets/questions/unknownAlphabet.js b/assets/questions/unknownAlphabet.js new file mode 100644 index 0000000..9a28b99 -- - /dev/null +++ b/assets/questions/unknownAlphabet.js @ @ -0,0 +1,325 @ @ +// Copyright 2017 The TIE Author , s. All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Unknown Alphabet . + */ + +globalData.questions [ 'unknownAlphabet ' ] = { // eslint-disable-line dot-notation + title : 'Unknown Alphabet ' , + starterCode : { + python : + ` def findAlphabet ( words ) : + return `` '' ` + } , + auxiliaryCode : { + python
diff -- git a/client/app.html b/client/app.html index 13bbe3e..ecf62f4 100644 -- - a/client/app.html +++ b/client/app.html @ @ -51,7 +51,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > - < script src= '' services/CodeStorageService.js '' > < /script > + < script src= '' services/LocalStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index d6ec364..1431138 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -61,7 +61,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < div > - < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage '' > + < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage track by $ index '' > < hr > < p ng-if= '' set.feedbackParagraphs ''
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..a890175 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -29,8 +29,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ng-repeat= '' questionId in questionIds track by $ index '' ng-click= '' navigateToQuestion ( $ index ) '' > < div class= '' tie-step-circle '' ng-class= '' { 'tie-step-active ' : currentQuestionIndex === $ index , 'tie-step-unlocked ' : questionsCompletionStatus [ $ index ] } '' > - < span class= '' tie-step-text '' , ng-show= '' ! questionsCompletionStatus [ $ index ] '' > { { $ index + 1 } } < /span > - < span class= '' tie-step-checkmark '' , ng-show= '' questionsCompletionStatus [ $ index ] '' > & # 10004 ; < /span > + < span class= '' tie-step-text '' > { { $ index + 1 } } < /span > < /div > < div ng-class= '' { 'tie-step-line ' : $ index < ( questionIds.length - 1 ) } '' > < /div > < /div > @ @ -146,6 +145,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { outline : 0 ; } .tie-coding-ui , .tie-question-ui
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..0f49ab3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index dd56227..aa064a4 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -77,5 +77,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/scripts/run_e2e_tests.sh b/scripts/run_e2e_tests.sh new file mode 100644 index 0000000..5f1aaee -- - /dev/null +++ b/scripts/run_e2e_tests.sh @ @ -0,0 +1,32 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + + # TODO ( feiluo ) : Need a way to control the log level to avoid thounsands of lines of log . + +set -e + +source $ ( dirname $ 0 ) /setup.sh || exit 1 + + # Install
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..c586ff7 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'testing/page-loading-spec.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data :
diff -- git a/client/components/CodeSnippetDirective.js b/client/components/CodeSnippetDirective.js index 961f332..363a1bd 100644 -- - a/client/components/CodeSnippetDirective.js +++ b/client/components/CodeSnippetDirective.js @ @ -30,6 +30,7 @ @ tie.directive ( 'codeSnippet ' , [ function ( ) { < style > .tie-code-snippet-line { line-height : 24px ; + word-wrap : break-word ; } < /style > ` ,
diff -- git a/client/question/services/code_evaluators/PythonCodeRunnerService.js b/client/question/services/code_evaluators/PythonCodeRunnerService.js index 8ca3f53..2e15258 100644 -- - a/client/question/services/code_evaluators/PythonCodeRunnerService.js +++ b/client/question/services/code_evaluators/PythonCodeRunnerService.js @ @ -218,9 +218,10 @ @ tie.factory ( 'PythonCodeRunnerService ' , [ if ( stdoutString.length === 0 ) { return [ ] ; } - // Stdout will sometimes have extra characters at the end . Cleaning up - // the stdout here to remove any extraneous output that comes after - // the last test case . + // If there are performance tests , stdoutString will have the stdout + // resulting from the performance tests at the end . Here , the stdout + // is cleaned up by removing any extraneous output that comes after + // the last correctness test case . var lastSeparatorIndex = stdoutString.lastIndexOf ( separator ) ; var cleanedStdoutString = stdoutString.slice ( 0 , lastSeparatorIndex ) ;
diff -- git a/assets/questions/findChar.js b/assets/questions/findChar.js new file mode 100644 index 0000000..6d0c275 -- - /dev/null +++ b/assets/questions/findChar.js @ @ -0,0 +1,130 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for finding the + * First Non-Repeating Character in a String . + */ + +globalData.questions [ 'findChar ' ] = { // eslint-disable-line dot-notation + title : 'Find the First Non-Repeating Character in a String ' , + starterCode : { + python : ` def findFirstNonRepeatingCharacter ( word ) : + return
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..504b954 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,49 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + + # Usage : + # + # Not meant for manual use + # Runs automatically before a git push command is executed + # Behaviour can be set up using `` bash scripts/setup_hooks.sh '' + +echo `` Running linter tests
diff -- git a/assets/tests/TaskSchemaValidationService.js b/assets/tests/TaskSchemaValidationService.js index e6451be..4ac815f 100644 -- - a/assets/tests/TaskSchemaValidationService.js +++ b/assets/tests/TaskSchemaValidationService.js @ @ -201,7 +201,7 @ @ tie.factory ( 'TaskSchemaValidationService ' , [ verifyPerformanceTestsHaveLinearExpectedPerformance : function ( task ) { var performanceTests = task.getPerformanceTests ( ) ; return performanceTests.every ( function ( test ) { - return ALLOWED_RUNTIMES.includes ( test.getExpectedPerformance ( ) ) ; + return ALLOWED_RUNTIMES.indexOf ( test.getExpectedPerformance ( ) ) ! == -1 ; } ) ; } , verifyPerformanceTestsHaveEvaluationFunctionName : function ( task ) { diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..3cd1dc5 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,57 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..9793840 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..eec7dae 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..c586ff7 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'testing/page-loading-spec.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data :
diff -- git a/.gitignore b/.gitignore index 30f930d..fdba19e 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ tools/* .DS_Store assets/.DS_Store karma_coverage_reports/* +assets/questions/*.js~ diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..ca7e190 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -477,10 +477,14 @ @ tie.directive ( 'learnerView ' , [ function ( ) { feedbackDiv.scrollTop = feedbackDiv.scrollHeight + additionalHeightForLoadingIndicator ; $ timeout ( function ( ) { + var tasksToCurrent = [ ] ; // Tasks from the first to current . + for ( var i = 0 ; i < = currentTaskIndex ; i++ ) { + tasksToCurrent = tasksToCurrent.concat ( tasks [ i ] ) ; + } SolutionHandlerService.processSolutionAsync ( - tasks [ currentTaskIndex ] , code , + tasksToCurrent , code , question.getAuxiliaryCode ( language ) , language - ) .then ( setFeedback ) ; + ) .then ( setFeedback ) ; } , DURATION_MSEC_WAIT_FOR_SCROLL ) ; } , 0 ) ; } ; diff -- git a/client/services/FeedbackGeneratorService.js b/client/services/FeedbackGeneratorService.js index 879cc34..ff59e48 100644 -- - a/client/services/FeedbackGeneratorService.js +++ b/client/services/FeedbackGeneratorService.js @ @ -161,7 +161,7 @ @ tie.factory ( 'FeedbackGeneratorService ' , [ } ; return { - getFeedback : function ( task , codeEvalResult , rawCodeLineIndexes ) { + getFeedback
diff -- git a/.gitignore b/.gitignore index 30f930d..a945bff 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ tools/* .DS_Store assets/.DS_Store karma_coverage_reports/* +*~ diff -- git a/client/app.js b/client/app.js index 2bd611c..4db253a 100644 -- - a/client/app.js +++ b/client/app.js @ @ -66,12 +66,24 @ @ tie.constant ( 'SYSTEM_CODE ' , { ] .join ( '\n ' ) } ) ; -// Name of the list in which correctness test results are stored . +// Name of the list in which correctness test results of all tasks are stored . tie.constant ( 'VARNAME_CORRECTNESS_TEST_RESULTS ' , 'correctness_test_results ' ) ; -// Name of the list in which buggy output test results are stored . +// Name of the list in which buggy output test results of all tasks are stored . tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; -// Name of the list in which performance test results are stored . +// Name of the list in which performance test results of all tasks are stored . tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; +// Name of the list in which +// correctness test results of one single task are stored . +tie.constant ( 'VARNAME_ONE_TASK_CORRECTNESS_TEST_RESULTS ' , + 'one_task_correctness_test_results '
diff -- git a/.gitignore b/.gitignore index ed5d31d..a945bff 100644 -- - a/.gitignore +++ b/.gitignore @ @ -4,4 +4,3 @ @ tools/* assets/.DS_Store karma_coverage_reports/* *~ - diff -- git a/client/app.js b/client/app.js index 6b870ce..786692d 100644 -- - a/client/app.js +++ b/client/app.js @ @ -66,12 +66,24 @ @ tie.constant ( 'SYSTEM_CODE ' , { ] .join ( '\n ' ) } ) ; -// Name of the list in which correctness test results are stored . +// Name of the list in which correctness test results of all tasks are stored . tie.constant ( 'VARNAME_CORRECTNESS_TEST_RESULTS ' , 'correctness_test_results ' ) ; -// Name of the list in which buggy output test results are stored . +// Name of the list in which buggy output test results of all tasks are stored . tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; -// Name of the list in which performance test results are stored . +// Name of the list in which performance test results of all tasks are stored . tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; +// Name of the list in which +// correctness test results of one single task are stored . +tie.constant ( 'VARNAME_TASK_CORRECTNESS_TEST_RESULTS ' , + 'task_correctness_test_results '
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..3cd1dc5 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,57 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + + # Usage : + # Not meant for manual use + # Runs automatically before a git push command is executed + # Behaviour can be set up using `` bash scripts/setup_hooks.sh '' + + # Ask user if push should
diff -- git a/assets/tests/TaskSchemaValidationService.js b/assets/tests/TaskSchemaValidationService.js index e6451be..4ac815f 100644 -- - a/assets/tests/TaskSchemaValidationService.js +++ b/assets/tests/TaskSchemaValidationService.js @ @ -201,7 +201,7 @ @ tie.factory ( 'TaskSchemaValidationService ' , [ verifyPerformanceTestsHaveLinearExpectedPerformance : function ( task ) { var performanceTests = task.getPerformanceTests ( ) ; return performanceTests.every ( function ( test ) { - return ALLOWED_RUNTIMES.includes ( test.getExpectedPerformance ( ) ) ; + return ALLOWED_RUNTIMES.indexOf ( test.getExpectedPerformance ( ) ) ! == -1 ; } ) ; } , verifyPerformanceTestsHaveEvaluationFunctionName : function ( task ) { diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..31b7a99 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,56 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS
diff -- git a/assets/tests/TaskSchemaValidationService.js b/assets/tests/TaskSchemaValidationService.js index e6451be..4ac815f 100644 -- - a/assets/tests/TaskSchemaValidationService.js +++ b/assets/tests/TaskSchemaValidationService.js @ @ -201,7 +201,7 @ @ tie.factory ( 'TaskSchemaValidationService ' , [ verifyPerformanceTestsHaveLinearExpectedPerformance : function ( task ) { var performanceTests = task.getPerformanceTests ( ) ; return performanceTests.every ( function ( test ) { - return ALLOWED_RUNTIMES.includes ( test.getExpectedPerformance ( ) ) ; + return ALLOWED_RUNTIMES.indexOf ( test.getExpectedPerformance ( ) ) ! == -1 ; } ) ; } , verifyPerformanceTestsHaveEvaluationFunctionName : function ( task ) { diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..31b7a99 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,56 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS
diff -- git a/assets/tests/QuestionSchemaValidationService.js b/assets/tests/QuestionSchemaValidationService.js index 3b0a0b8..175cb58 100644 -- - a/assets/tests/QuestionSchemaValidationService.js +++ b/assets/tests/QuestionSchemaValidationService.js @ @ -60,6 +60,23 @ @ tie.factory ( 'QuestionSchemaValidationService ' , [ angular.isArray ( question.getTasks ( ) ) & & question.getTasks ( ) .length > 0 ) ; } , + verifyAtLeastOneBuggyOutputTestExists : function ( question ) { + return question.getTasks ( ) .some ( function ( task ) { + return task.getBuggyOutputTests ( ) .length > 0 ; + } ) ; + } , + verifyAllBuggyOutputTestMessagesAreUnique : function ( question ) { + var messages = new Set ( ) ; + return question.getTasks ( ) .every ( function ( task ) { + return task.getBuggyOutputTests ( ) .every ( function ( test ) { + return test.getMessages ( ) .every ( function ( message ) { + var isUnique = ! ( message in messages ) ; + messages.add ( message ) ; + return isUnique ; + } ) ; + } ) ; + } ) ; + } , verifyStyleTestsAreArray : function ( question ) { return angular.isArray ( question.getStyleTests ( ) ) ; } , diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 156307b..3b953f4 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..a890175 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -29,8 +29,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ng-repeat= '' questionId in questionIds track by $ index '' ng-click= '' navigateToQuestion ( $ index ) '' > < div class= '' tie-step-circle '' ng-class= '' { 'tie-step-active ' : currentQuestionIndex === $ index , 'tie-step-unlocked ' : questionsCompletionStatus [ $ index ] } '' > - < span class= '' tie-step-text '' , ng-show= '' ! questionsCompletionStatus [ $ index ] '' > { { $ index + 1 } } < /span > - < span class= '' tie-step-checkmark '' , ng-show= '' questionsCompletionStatus [ $ index ] '' > & # 10004 ; < /span > + < span class= '' tie-step-text '' > { { $ index + 1 } } < /span > < /div > < div ng-class= '' { 'tie-step-line ' : $ index < ( questionIds.length - 1 ) } '' > < /div > < /div > @ @ -146,6 +145,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { outline : 0 ; } .tie-coding-ui , .tie-question-ui
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3058388 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -86,7 +86,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < div class= '' tie-question-ui '' > < div class= '' tie-question-window '' > - < h3 > Question { { currentQuestionIndex + 1 } } : { { title } } < /h3 > + < h3 class= '' tie-question-title '' > { { title } } < /h3 > < div class= '' tie-previous-instructions '' > < div ng-repeat= '' previousInstruction in previousInstructions track by $ index '' > < p ng-repeat= '' paragraph in previousInstruction track by $ index '' > { { paragraph } } < /p > @ @ -336,6 +336,9 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-step-unlocked { background-color : rgb ( 0 , 128 , 0 ) ; } + .tie-question-title { + color : rgb ( 66 , 133 , 244 ) ; + } < /style > ` , controller : [
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..7467bcd 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,15 +343,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller : [ ' $ scope ' , ' $ timeout ' , 'SolutionHandlerService ' , 'QuestionDataService ' , - 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , + 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , 'CodeStoreService ' , function ( $ scope , $ timeout , SolutionHandlerService , QuestionDataService , - LANGUAGE_PYTHON , FeedbackObjectFactory ) { + LANGUAGE_PYTHON , FeedbackObjectFactory , CodeStoreService ) { var DURATION_MSEC_WAIT_FOR_SCROLL = 20 ; var language = LANGUAGE_PYTHON ; // TODO ( sll ) : Generalize
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..9793840 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/client/domain/CorrectnessTestObjectFactory.js b/client/domain/CorrectnessTestObjectFactory.js index 587054d..35149e3 100644 -- - a/client/domain/CorrectnessTestObjectFactory.js +++ b/client/domain/CorrectnessTestObjectFactory.js @ @ -31,6 +31,22 @ @ tie.factory ( 'CorrectnessTestObjectFactory ' , [ } ; CorrectnessTest.prototype.matchesOutput = function ( output ) { + // If allowOutputs should be arrays and learner 's code returns an array + // Then the if statement will check if learner 's output matches + // any of arrays in the allowedOutputs + if ( this._allowedOutputs.length > 0 & & + this._allowedOutputs [ 0 ] instanceof Array & & + output instanceof Array ) { + // Stringify the arrays and then compare + var stringifiedOutput = JSON.stringify ( output ) ; + for ( var i = 0 , l = this._allowedOutputs.length ; i < l ; i++ ) { + if ( JSON.stringify ( this._allowedOutputs [ i ] ) === stringifiedOutput ) { + return true ; + } + } + // If output matches none allowedOutputs + return false ; + } return this._allowedOutputs.indexOf ( output ) ! == -1 ; } ;
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aa4c655..a935465 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -106,9 +106,6 @ @ tie.directive ( 'learnerView ' , [ function ( ) { font-family : Roboto , 'Helvetica Neue ' , 'Lucida Grande ' , sans-serif ; font-size : 15px ; } - .CodeMirror-scroll > .CodeMirror-gutters { - z-index : 1 ; - } .tie-arrow-highlighter { background-color : white ; border-radius : 100px ;
diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 -- - a/assets/questions/rle.js +++ b/assets/questions/rle.js @ @ -139,7 +139,7 @ @ globalData.questions [ 'rle ' ] = { // eslint-disable-line dot-notation 'In this question , you\ 'll implement the encode function . It takes a ' , 'string as input and returns an encoding of the string where long ' , 'runs of characters are replaced by < # characters > x < character > . For ' , - 'example , `` abcccccd '' could be encoded as `` ab5xc '' . ' + 'example , `` abcccccd '' could be encoded as `` ab5xcd '' . ' ] .join ( `` ) ] , prerequisiteSkills : [ 'Arrays ' , 'Strings ' , 'String Manipulation ' ] ,
diff -- git a/client/app.js b/client/app.js index 2bd611c..6b870ce 100644 -- - a/client/app.js +++ b/client/app.js @ @ -75,4 +75,8 @ @ tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; // Default auto save time in seconds . -tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; +var SECONDS_TO_MILLISECONDS = 1000 ; +tie.constant ( 'DEFAULT_AUTOSAVE_SECONDS ' , 5 ) ; +tie.constant ( 'SECONDS_TO_MILLISECONDS ' , SECONDS_TO_MILLISECONDS ) ; +// `` Saving code ... '' will last for 1 second and disappear . +tie.constant ( 'DISPLAY_AUTOSAVE_TEXT_SECONDS ' , 1 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 7569333..234592c 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -63,6 +63,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < div class= '' tie-coding-terminal '' > < ui-codemirror ui-codemirror-opts= '' codeMirrorOptions '' ng-model= '' code '' + ng-change= '' activateAutosaving ( ) '' class= '' tie-codemirror-container '' > < /ui-codemirror > < /div > < select class= '' tie-lang-select-menu '' name= '' lang-select-menu '' > @ @ -79,7 +80,7 @ @ tie.directive ( 'learnerView ' , [
diff -- git a/client/app.js b/client/app.js index 2bd611c..6b870ce 100644 -- - a/client/app.js +++ b/client/app.js @ @ -75,4 +75,8 @ @ tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; // Default auto save time in seconds . -tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; +var SECONDS_TO_MILLISECONDS = 1000 ; +tie.constant ( 'DEFAULT_AUTOSAVE_SECONDS ' , 5 ) ; +tie.constant ( 'SECONDS_TO_MILLISECONDS ' , SECONDS_TO_MILLISECONDS ) ; +// `` Saving code ... '' will last for 1 second and disappear . +tie.constant ( 'DISPLAY_AUTOSAVE_TEXT_SECONDS ' , 1 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 7569333..ea930e7 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -63,6 +63,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < div class= '' tie-coding-terminal '' > < ui-codemirror ui-codemirror-opts= '' codeMirrorOptions '' ng-model= '' code '' + ng-change= '' autosave ( ) '' class= '' tie-codemirror-container '' > < /ui-codemirror > < /div > < select class= '' tie-lang-select-menu '' name= '' lang-select-menu '' > @ @ -79,7 +80,7 @ @ tie.directive ( 'learnerView ' , [
diff -- git a/assets/questions/runLengthEncoding.js b/assets/questions/runLengthEncoding.js index 432a4de..9c7269d 100644 -- - a/assets/questions/runLengthEncoding.js +++ b/assets/questions/runLengthEncoding.js @ @ -240,6 +240,15 @ @ globalData.questions [ 'runLengthEncoding ' ] = { // eslint-disable-line dot-notati 'the original string back as a result . ' ] .join ( `` ) , type : 'text' + } , + { + content : [ + 'You may find that , in order to complete this task , you have to ' , + 'relax or compromise on some of the original constraints . As ' , + 'long as the input can be correctly encoded and then decoded , ' , + 'this is fine . ' + ] .join ( `` ) , + type : 'text' } ] , prerequisiteSkills : [ 'Arrays ' , 'Strings ' , 'String Manipulation ' ] , diff -- git a/client/app.js b/client/app.js index 6b870ce..90b689e 100644 -- - a/client/app.js +++ b/client/app.js @ @ -37,9 +37,10 @ @ tie.constant ( 'ALL_SUPPORTED_LANGUAGES ' , [ 'python ' ] ) ; // Class name for wrapping student code . Answer submissions are then run // using CLASS_NAME_STUDENT_CODE.function_name ( ) . tie.constant ( 'CLASS_NAME_STUDENT_CODE ' , 'StudentCode ' ) ; -// Class name for wrapping
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 41aa28d..647704a 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -126,12 +126,7 @ @ def createListOfUniqueStrings ( atom , size ) : ] .join ( `` ) ] } ] , - performanceTests : [ { - inputDataAtom : 'm ' , - transformationFunction : 'System.extendString ' , - expectedPerformance : 'constant ' , - evaluationFunction : 'abbreviate' - } ] + performanceTests : [ ] } , { instructions : [ [
diff -- git a/.DS_Store b/.DS_Store new file mode 100644 index 0000000..37762b3 Binary files /dev/null and b/.DS_Store differ diff -- git a/assets/.DS_Store b/assets/.DS_Store new file mode 100644 index 0000000..56a83de Binary files /dev/null and b/assets/.DS_Store differ diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 41aa28d..647704a 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -126,12 +126,7 @ @ def createListOfUniqueStrings ( atom , size ) : ] .join ( `` ) ] } ] , - performanceTests : [ { - inputDataAtom : 'm ' , - transformationFunction : 'System.extendString ' , - expectedPerformance : 'constant ' , - evaluationFunction : 'abbreviate' - } ] + performanceTests : [ ] } , { instructions : [ [
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..7467bcd 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,15 +343,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller : [ ' $ scope ' , ' $ timeout ' , 'SolutionHandlerService ' , 'QuestionDataService ' , - 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , + 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , 'CodeStoreService ' , function ( $ scope , $ timeout , SolutionHandlerService , QuestionDataService , - LANGUAGE_PYTHON , FeedbackObjectFactory ) { + LANGUAGE_PYTHON , FeedbackObjectFactory , CodeStoreService ) { var DURATION_MSEC_WAIT_FOR_SCROLL = 20 ; var language = LANGUAGE_PYTHON ; // TODO ( sll ) : Generalize
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..0f49ab3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..eec7dae 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index dd56227..aa064a4 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -77,5 +77,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 647704a..ad7f8bc 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -29,26 +29,31 @ @ def are_all_unique ( words ) : } , auxiliaryCode : { python : - ` def forgetLastLetter ( word ) : - result = `` % s % d '' % ( word [ 0 ] , len ( word ) - 2 ) if len ( word ) > 2 else word - return result + ` class AuxiliaryCode ( object ) : + @ classmethod + def forgetLastLetter ( cls , word ) : + result = `` % s % d '' % ( word [ 0 ] , len ( word ) - 2 ) if len ( word ) > 2 else word + return result -def useFirstAndLastLetterAndLengthToAbbreviate ( word ) : - if word : - return `` % s % d % s '' % ( word [ 0 ] , len ( word ) - 2 , word [ len ( word ) - 1 ] ) - return `` '' + @ classmethod + def useFirstAndLastLetterAndLengthToAbbreviate ( cls , word ) : + if word : + return `` % s %
diff -- git a/client/app.html b/client/app.html index 13bbe3e..ecf62f4 100644 -- - a/client/app.html +++ b/client/app.html @ @ -51,7 +51,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > - < script src= '' services/CodeStorageService.js '' > < /script > + < script src= '' services/LocalStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index d6ec364..c867c58 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -61,7 +61,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < div > - < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage '' > + < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage track by $ index '' > < hr > < p ng-if= '' set.feedbackParagraphs ''
diff -- git a/client/app.html b/client/app.html index 13bbe3e..ecf62f4 100644 -- - a/client/app.html +++ b/client/app.html @ @ -51,7 +51,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > - < script src= '' services/CodeStorageService.js '' > < /script > + < script src= '' services/LocalStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index d6ec364..c6d26c4 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -61,9 +61,9 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < div > - < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage '' > + < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage track by $ index '' > < hr > - < p ng-if= '' set.feedbackParagraphs
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index 65f9b1b..ca9835a 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -116,7 +116,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < div class= '' tie-code-auto-save '' ng-class= '' { 'night-mode ' : isInDarkMode } '' ng-show= '' autosaveTextIsDisplayed '' > Saving code ... < /div > - < button class= '' tie-run-button tie-button tie-blue protractor-test-run-code-btn '' + < button class= '' tie-run-button tie-button tie-button-blue protractor-test-run-code-btn '' ng-class= '' { 'active ' : ! nextButtonIsShown } '' ng-click= '' submitCode ( editorContents.code ) '' ng-disabled= '' nextButtonIsShown '' > @ @ -137,6 +137,19 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > + < modal show='modalIsDisplayed ' title= ' { { modalTitle } } ' description= ' { { modalDesc } } ' > + < p > + By using TIE , you agree to do so under the Google Terms of Service , + Google 's Privacy Policy . In addition , you understand and agree that by + using our tool , you may generate computer code . Metadata about the code , + such as how
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index 65f9b1b..6ab29bf 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -116,7 +116,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < div class= '' tie-code-auto-save '' ng-class= '' { 'night-mode ' : isInDarkMode } '' ng-show= '' autosaveTextIsDisplayed '' > Saving code ... < /div > - < button class= '' tie-run-button tie-button tie-blue protractor-test-run-code-btn '' + < button class= '' tie-run-button tie-button tie-button-blue protractor-test-run-code-btn '' ng-class= '' { 'active ' : ! nextButtonIsShown } '' ng-click= '' submitCode ( editorContents.code ) '' ng-disabled= '' nextButtonIsShown '' > @ @ -137,6 +137,8 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > + < privacy-modal show='privacyModalIsDisplayed ' is-client-version= '' ! SERVER_URL '' > + < /privacy-modal > < style > div.CodeMirror span.CodeMirror-matchingbracket { color : rgb ( 75 , 206 , 75 ) ; @ @ -170,14 +172,22 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-button : hover { border : 1px solid # e4e4e4 ; } - .tie-button.tie-blue { + .tie-button-blue { background-color : rgb ( 66 , 133 , 244 ) ; color
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index 65f9b1b..0120d3c 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -116,7 +116,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < div class= '' tie-code-auto-save '' ng-class= '' { 'night-mode ' : isInDarkMode } '' ng-show= '' autosaveTextIsDisplayed '' > Saving code ... < /div > - < button class= '' tie-run-button tie-button tie-blue protractor-test-run-code-btn '' + < button class= '' tie-run-button tie-button tie-button-blue protractor-test-run-code-btn '' ng-class= '' { 'active ' : ! nextButtonIsShown } '' ng-click= '' submitCode ( editorContents.code ) '' ng-disabled= '' nextButtonIsShown '' > @ @ -137,6 +137,8 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > + < privacy-modal show='privacyModalIsDisplayed ' is-client-version= '' ! SERVER_URL '' > + < /privacy-modal > < style > div.CodeMirror span.CodeMirror-matchingbracket { color : rgb ( 75 , 206 , 75 ) ; @ @ -170,14 +172,22 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-button : hover { border : 1px solid # e4e4e4 ; } - .tie-button.tie-blue { + .tie-button-blue { background-color : rgb ( 66 , 133 , 244 ) ; color
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index 65f9b1b..95c9fc3 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -116,7 +116,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < div class= '' tie-code-auto-save '' ng-class= '' { 'night-mode ' : isInDarkMode } '' ng-show= '' autosaveTextIsDisplayed '' > Saving code ... < /div > - < button class= '' tie-run-button tie-button tie-blue protractor-test-run-code-btn '' + < button class= '' tie-run-button tie-button tie-button-blue protractor-test-run-code-btn '' ng-class= '' { 'active ' : ! nextButtonIsShown } '' ng-click= '' submitCode ( editorContents.code ) '' ng-disabled= '' nextButtonIsShown '' > @ @ -137,6 +137,8 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > + < privacy-modal is-displayed= '' privacyModalIsDisplayed '' > + < /privacy-modal > < style > div.CodeMirror span.CodeMirror-matchingbracket { color : rgb ( 75 , 206 , 75 ) ; @ @ -170,14 +172,22 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-button : hover { border : 1px solid # e4e4e4 ; } - .tie-button.tie-blue { + .tie-button-blue { background-color : rgb ( 66 , 133 , 244 ) ; color : # ffffff
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 5fd15c8..2d4539a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -141,6 +141,16 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > + < a href= '' # '' ng-click= '' showExampleModal ( ) '' > Show Example Modal < /a > + < /div > + < /div > + < div class= '' tie-modal '' ng-show= '' modalIsDisplayed '' ng-click= '' closeModal ( ) '' > + < div class= '' tie-modal-content '' ng-click= '' $ event.stopPropagation ( ) ; '' > + < h1 class= '' tie-modal-title '' > { { modalTitle } } < /h1 > + < p class= '' tie-modal-description '' > { { modalDescription } } < /p > + < button class= '' tie-button tie-blue tie-modal-button '' ng-click= '' closeModal ( ) '' > + < span > OK < /span > + < /button > < /div > < /div > < style > @ @ -317,6 +327,38 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-lang-terminal { display : inline ; } + .tie-modal { + background-color : rgb (
diff -- git a/client/app.html b/client/app.html index 19a9e1d..e1be809 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' components/CodeSnippetDirective.js '' > < /script > < script src= '' components/LearnerViewDirective.js '' > < /script > < script src= '' components/SyntaxErrorSnippetDirective.js '' > < /script > + < script src= '' components/ModalDirective.js '' > < /script > < script src= '' domain/BuggyOutputTestObjectFactory.js '' > < /script > < script src= '' domain/CodeEvalResultObjectFactory.js '' > < /script > < script src= '' domain/CodeSubmissionObjectFactory.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 5fd15c8..9f62f46 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -143,9 +143,10 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > + < modal > < /modal > < style > html { - height : 100 % ; + height : 100 % ; min-height : 622px ; min-width : 1331px ; } @ @ -317,6 +318,38 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-lang-terminal { display : inline ; } + .tie-modal { + background-color : rgb ( 0 , 0 , 0 ) ; +
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index 581ed90..f9e9806 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -55,11 +55,6 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /monospace-display-modal > < /div > < div ng-hide= '' MonospaceDisplayModalService.isDisplayed ( ) '' > - < button class= '' tie-code-reset tie-button protractor-test-reset-feedback-button '' - ng-click= '' resetFeedback ( ) '' - title= '' Click to clear all feedback '' > - Reset Feedback - < /button > < select class= '' tie-select-menu protractor-test-theme-select '' ng-change= '' changeTheme ( currentThemeName ) '' ng-model= '' currentThemeName '' @ @ -95,8 +90,8 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < div class= '' tie-stdout '' > { { stdout } } < /div > < /div > < /div > - < button class= '' tie-code-reset tie-button protractor-test-reset-code-button '' name= '' code-reset '' ng-click= '' resetCode ( ) '' title= '' Click to clear your code '' > - Reset Code + < button class= '' tie-code-reset tie-button protractor-test-reset-code-button '' name= '' code-reset '' ng-click= '' resetCode ( ) '' title= '' Click to clear your code and start over '' > + Start Over < /button >
diff -- git a/assets/questions/bomberman.js b/assets/questions/bomberman.js index 8a0ab5a..f042b42 100644 -- - a/assets/questions/bomberman.js +++ b/assets/questions/bomberman.js @ @ -96,25 +96,32 @ @ globalData.questions [ 'bomberman ' ] = { // eslint-disable-line dot-notation mainFunctionName : 'bomb ' , correctnessTests : [ { input : [ ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ ] , [ ] , [ ] ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` x '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 2 ] + allowedOutputs : [ 2 ] , + tag : 'single row boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 3 ] + allowedOutputs : [ 3 ] , + tag : 'single row boards' } , { input : [
diff -- git a/assets/questions/bomberman.js b/assets/questions/bomberman.js index 5c23e53..fd2e4f8 100644 -- - a/assets/questions/bomberman.js +++ b/assets/questions/bomberman.js @ @ -96,25 +96,32 @ @ globalData.questions [ 'bomberman ' ] = { // eslint-disable-line dot-notation mainFunctionName : 'bomb ' , correctnessTests : [ { input : [ ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ ] , [ ] , [ ] ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` x '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 2 ] + allowedOutputs : [ 2 ] , + tag : 'single row boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 3 ] + allowedOutputs : [ 3 ] , + tag : 'single row boards' } , { input : [
diff -- git a/assets/questions/bomberman.js b/assets/questions/bomberman.js index 5c23e53..fd2e4f8 100644 -- - a/assets/questions/bomberman.js +++ b/assets/questions/bomberman.js @ @ -96,25 +96,32 @ @ globalData.questions [ 'bomberman ' ] = { // eslint-disable-line dot-notation mainFunctionName : 'bomb ' , correctnessTests : [ { input : [ ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ ] , [ ] , [ ] ] , - allowedOutputs : [ 0 ] + allowedOutputs : [ 0 ] , + tag : 'empty boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` x '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 2 ] + allowedOutputs : [ 2 ] , + tag : 'single row boards' } , { input : [ [ `` e '' , `` '' , `` e '' , `` '' , `` '' , `` e '' ] ] , - allowedOutputs : [ 3 ] + allowedOutputs : [ 3 ] , + tag : 'single row boards' } , { input : [
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index 32333a3..3abe608 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -884,10 +884,11 @ @ tie.directive ( 'learnerView ' , [ function ( ) { } } else { var feedbackParagraphs = feedback.getParagraphs ( ) ; + var errorLineNumber = feedback.getErrorLineNumber ( ) ; for ( var i = 0 ; i < feedbackParagraphs.length ; i++ ) { clearAllHighlights ( ) ; - if ( feedbackParagraphs [ i ] .isErrorParagraph ( ) ) { - highlightLine ( feedbackParagraphs [ i ] .getErrorLineNumber ( ) ) ; + if ( errorLineNumber ! == null ) { + highlightLine ( errorLineNumber ) ; break ; } } diff -- git a/client/question/domain/FeedbackObjectFactory.js b/client/question/domain/FeedbackObjectFactory.js index 32bd394..9e4eb74 100644 -- - a/client/question/domain/FeedbackObjectFactory.js +++ b/client/question/domain/FeedbackObjectFactory.js @ @ -61,6 +61,14 @ @ tie.factory ( 'FeedbackObjectFactory ' , [ * @ private */ this._feedbackCategory = feedbackCategory ; + + /** + * Line number that correlates to error that triggered . + * + * @ type { integer } + * @ private + */ + this._errorLineNumber = null ; } ; // Instance methods . @ @ -178,6 +186,24 @ @ tie.factory ( 'FeedbackObjectFactory ' , [ } ; /** + * A
diff -- git a/client/question/domain/PrereqCheckErrorObjectFactory.js b/client/question/domain/PrereqCheckErrorObjectFactory.js new file mode 100644 index 0000000..74d3889 -- - /dev/null +++ b/client/question/domain/PrereqCheckErrorObjectFactory.js @ @ -0,0 +1,104 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Factory for creating a PrereqCheckError of a student 's TIE + * session . + */ + +tie.factory ( 'PrereqCheckErrorObjectFactory ' , [ + function ( ) { + /** + * PrereqCheckError objects are used to store information related to Prereq + errors . + */ + + /** + * Constructor for PrereqCheckError .
diff -- git a/.gitignore b/.gitignore index 30f930d..a945bff 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,3 +3,4 @ @ tools/* .DS_Store assets/.DS_Store karma_coverage_reports/* +*~ diff -- git a/client/app.js b/client/app.js index 2bd611c..4db253a 100644 -- - a/client/app.js +++ b/client/app.js @ @ -66,12 +66,24 @ @ tie.constant ( 'SYSTEM_CODE ' , { ] .join ( '\n ' ) } ) ; -// Name of the list in which correctness test results are stored . +// Name of the list in which correctness test results of all tasks are stored . tie.constant ( 'VARNAME_CORRECTNESS_TEST_RESULTS ' , 'correctness_test_results ' ) ; -// Name of the list in which buggy output test results are stored . +// Name of the list in which buggy output test results of all tasks are stored . tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; -// Name of the list in which performance test results are stored . +// Name of the list in which performance test results of all tasks are stored . tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; +// Name of the list in which +// correctness test results of one single task are stored . +tie.constant ( 'VARNAME_ONE_TASK_CORRECTNESS_TEST_RESULTS ' , + 'one_task_correctness_test_results '
diff -- git a/client/question/domain/ErrorTracebackObjectFactory.js b/client/question/domain/ErrorTracebackObjectFactory.js index 3efb74c..59f985c 100644 -- - a/client/question/domain/ErrorTracebackObjectFactory.js +++ b/client/question/domain/ErrorTracebackObjectFactory.js @ @ -28,6 +28,13 @ @ tie.factory ( 'ErrorTracebackObjectFactory ' , [ var LINE_DELIMITER_PYTHON = ' , line ' ; /** + * A generic server error message . + */ + + var SERVER_ERROR_MESSAGE = ( + 'A server error occurred . Please refresh the page . ' ) ; + + /** * Constructor for ErrorTraceback * * @ param { string } errorMessage string describing the error @ @ -61,11 +68,15 @ @ tie.factory ( 'ErrorTracebackObjectFactory ' , [ * Returns the line number in the first error traceback coordinates . This * generally means the line in the student code where the error is coming * from . + * If no TracebackCoordinates are available , this will return null . * * @ returns { ErrorTraceback } * @ private */ ErrorTraceback.prototype._getFirstTracebackLine = function ( ) { + if ( ! this._tracebackCoordinates ) { + return null ; + } return this._tracebackCoordinates [ 0 ] .getLineNumber ( ) ; } ; @ @ -75,7 +86,9 @ @ tie.factory ( 'ErrorTracebackObjectFactory ' , [ * @ returns { string } */ ErrorTraceback.prototype.getErrorString =
diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 1640761..35dcdb0 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -126,8 +126,9 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation 'For this question , you\ 'll implement the reverseWords function . ' , 'This function takes a string of words and reverses the individual ' , 'words , but it does not change the ordering of the words within the ' , - 'sentence . All the original whitespace/punctuation should be ' , - 'preserved . Here\ 's an example : ' + 'sentence . A word is defined to consist of contiguous letters , and ' , + 'all other characters in the string ( such as whitespace and ' , + 'punctuation ) should be preserved . Here\ 's an example : ' ] .join ( `` ) , type : 'text' } , { @ @ -303,8 +304,10 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation ignoredTestSuiteIds : [ ] , messages : [ [ - `` Try reading the question again , and looking at the sample `` , - `` input/output -- it 's asking for something different . '' + ``
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..ff0618c -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,9 @ @ + # ! /bin/sh + +echo `` Running hook from new directory '' +echo `` Running linter tests '' +sh scripts/run_linter.sh +echo `` Running karma tests '' +sh scripts/run_karma_tests.sh + +exit 0
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..1d05d34 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -148,6 +148,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-coding-ui , .tie-question-ui { display : inline-block ; margin : 8px ; + white-space : normal ; } @ -webkit-keyframes tie-dot { from { -webkit-transform : translate ( 0px , 0px ) ; } @ @ -177,6 +178,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-question-ui-inner { padding-left : 32px ; padding-right : 32px ; + white-space : nowrap ; } .tie-question-ui-outer { display : table ;
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index d8ec165..aa4c655 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -444,7 +444,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { indentUnit : 4 , lineNumbers : true , mode : LANGUAGE_PYTHON , - smartIndent : false , + smartIndent : true , tabSize : 4 } ;
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..7467bcd 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,15 +343,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller : [ ' $ scope ' , ' $ timeout ' , 'SolutionHandlerService ' , 'QuestionDataService ' , - 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , + 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , 'CodeStoreService ' , function ( $ scope , $ timeout , SolutionHandlerService , QuestionDataService , - LANGUAGE_PYTHON , FeedbackObjectFactory ) { + LANGUAGE_PYTHON , FeedbackObjectFactory , CodeStoreService ) { var DURATION_MSEC_WAIT_FOR_SCROLL = 20 ; var language = LANGUAGE_PYTHON ; // TODO ( sll ) : Generalize
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..eec7dae 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..eec7dae 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..a4825f6 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'tests/*.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data :
diff -- git a/client/domain/CorrectnessTestObjectFactory.js b/client/domain/CorrectnessTestObjectFactory.js index 587054d..0263797 100644 -- - a/client/domain/CorrectnessTestObjectFactory.js +++ b/client/domain/CorrectnessTestObjectFactory.js @ @ -31,6 +31,20 @ @ tie.factory ( 'CorrectnessTestObjectFactory ' , [ } ; CorrectnessTest.prototype.matchesOutput = function ( output ) { + // If allowOutputs should be arrays and learner 's code returns an array + if ( this._allowedOutputs.length > 0 & & + this._allowedOutputs [ 0 ] instanceof Array & & + output instanceof Array ) { + // Stringify the arrays and then compare + var stringifiedOutput = JSON.stringify ( output ) ; + for ( var i = 0 , l = this._allowedOutputs.length ; i < l ; i++ ) { + if ( JSON.stringify ( this._allowedOutputs [ i ] ) === stringifiedOutput ) { + return true ; + } + } + // If output matches none allowedOutputs + return false ; + } return this._allowedOutputs.indexOf ( output ) ! == -1 ; } ;
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index d8ec165..e5cd917 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -444,8 +444,8 @ @ tie.directive ( 'learnerView ' , [ function ( ) { indentUnit : 4 , lineNumbers : true , mode : LANGUAGE_PYTHON , - smartIndent : false , - tabSize : 4 + smartIndent : true , + tabSize : 4 , } ; $ scope.showNextTask = function ( ) {
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..a890175 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -29,8 +29,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ng-repeat= '' questionId in questionIds track by $ index '' ng-click= '' navigateToQuestion ( $ index ) '' > < div class= '' tie-step-circle '' ng-class= '' { 'tie-step-active ' : currentQuestionIndex === $ index , 'tie-step-unlocked ' : questionsCompletionStatus [ $ index ] } '' > - < span class= '' tie-step-text '' , ng-show= '' ! questionsCompletionStatus [ $ index ] '' > { { $ index + 1 } } < /span > - < span class= '' tie-step-checkmark '' , ng-show= '' questionsCompletionStatus [ $ index ] '' > & # 10004 ; < /span > + < span class= '' tie-step-text '' > { { $ index + 1 } } < /span > < /div > < div ng-class= '' { 'tie-step-line ' : $ index < ( questionIds.length - 1 ) } '' > < /div > < /div > @ @ -146,6 +145,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { outline : 0 ; } .tie-coding-ui , .tie-question-ui
diff -- git a/client/question/components/SpeechBalloonDirectives.js b/client/question/components/SpeechBalloonDirectives.js index dbb5a9c..9ab6af6 100644 -- - a/client/question/components/SpeechBalloonDirectives.js +++ b/client/question/components/SpeechBalloonDirectives.js @ @ -16,29 +16,32 @ @ * @ fileoverview Directives for displaying speech balloons . */ -tie.directive ( 'tieSpeechBalloonContainer ' , [ ' $ timeout ' , function ( $ timeout ) { - return { - restrict : 'E ' , - scope : { } , - link : function ( scope , element ) { - var speechBalloonContainerElement = element [ 0 ] ; - var speechBalloonContainer = - angular.element ( speechBalloonContainerElement ) ; - speechBalloonContainer.addClass ( 'tie-speech-balloon-container ' ) ; - speechBalloonContainerElement.style.opacity = '0 ' ; - speechBalloonContainerElement.style.transition = 'unset ' ; - speechBalloonContainerElement.style.display = 'none ' ; - $ timeout ( function ( ) { - speechBalloonContainerElement.style.display = 'block ' ; - speechBalloonContainerElement.style.marginTop = - '- ' + speechBalloonContainerElement.offsetHeight.toString ( ) + 'px ' ; +tie.directive ( 'tieSpeechBalloonContainer ' , [ ' $ timeout ' , 'DELAY_STYLE_REMOVAL ' , + function ( $ timeout , DELAY_STYLE_REMOVAL ) { + return { + restrict : 'E ' , + scope : { } , + link : function ( scope , element ) { + var speechBalloonContainerElement = element [ 0 ] ;
diff -- git a/client/app.html b/client/app.html index 13bbe3e..ecf62f4 100644 -- - a/client/app.html +++ b/client/app.html @ @ -51,7 +51,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > - < script src= '' services/CodeStorageService.js '' > < /script > + < script src= '' services/LocalStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index d6ec364..1431138 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -61,7 +61,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < div > - < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage '' > + < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage track by $ index '' > < hr > < p ng-if= '' set.feedbackParagraphs ''
diff -- git a/client/app.html b/client/app.html index 13bbe3e..ecf62f4 100644 -- - a/client/app.html +++ b/client/app.html @ @ -51,7 +51,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > - < script src= '' services/CodeStorageService.js '' > < /script > + < script src= '' services/LocalStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index d6ec364..a5d4161 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -61,7 +61,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < div > - < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage '' > + < div class= '' tie-feedback '' ng-class= '' { 'tie-most-recent-feedback ' : $ last } '' ng-repeat= '' set in feedbackStorage track by $ index '' > < hr > < p ng-if= '' set.feedbackParagraphs ''
diff -- git a/client/app.html b/client/app.html index 28bd173..8b18ede 100644 -- - a/client/app.html +++ b/client/app.html @ @ -4,6 +4,9 @ @ < meta charset= '' UTF-8 '' > < meta name= '' viewport '' content= '' width=device-width , initial-scale=1.0 , user-scalable=yes '' > < link rel= '' stylesheet '' href= '' ../third_party/codemirror-5.19.0/lib/codemirror.css '' > + < link rel= '' stylesheet '' href= '' ../third_party/jquery-ui-1.12.1.custom/jquery-ui.min.css '' > + < script src= '' ../third_party/jquery-3.2.1.min.js '' > < /script > + < script src= '' ../third_party/jquery-ui-1.12.1.custom/jquery-ui.min.js '' > < /script > < script src= '' ../third_party/angular-1.6.1/angular.min.js '' > < /script > < script src= '' ../third_party/codemirror-5.19.0/lib/codemirror.js '' > < /script > < script src= '' ../third_party/codemirror-5.19.0/mode/python/python.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index b7eb876..fc2969b 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -37,6 +37,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < div class= '' tie-coding-ui '' > + < div class= '' tie-feedback-window-wrapper '' > < div class= '' tie-feedback-window '' > < div class= '' tie-feedback '' > < p ng-repeat= '' paragraph in feedbackParagraphs track by $ index '' @ @ -57,12 +58,15 @ @ tie.directive (
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..02ececd -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,20 @ @ + # ! /bin/bash + +echo `` Running linter tests '' +lines= $ ( sh scripts/run_linter.sh | wc -l ) +if [ $ lines -eq 1 ] ; then + echo `` Linter tests passed '' +else + read -p `` Linter tests failed . Do you want to continue anyway ? ( y/n ) '' option + case $ option in + [ Yy ] * ) break ; ; + [ Nn ] * ) exit 1 ; ; + * ) echo `` Please enter y or n. '' ; ; + esac +fi + +echo `` Running karma tests '' + # TODO + # sh scripts/run_karma_tests.sh + +exit 0 diff -- git a/scripts/setup_hooks.sh b/scripts/setup_hooks.sh new file mode 100644 index 0000000..03033af -- - /dev/null +++ b/scripts/setup_hooks.sh @ @ -0,0 +1,3 @ @ + # ! /bin/sh + +git config core.hooksPath `` ./hooks ''
diff -- git a/assets/tests/QuestionSchemaValidationService.js b/assets/tests/QuestionSchemaValidationService.js index 3b0a0b8..0d0f9da 100644 -- - a/assets/tests/QuestionSchemaValidationService.js +++ b/assets/tests/QuestionSchemaValidationService.js @ @ -60,6 +60,11 @ @ tie.factory ( 'QuestionSchemaValidationService ' , [ angular.isArray ( question.getTasks ( ) ) & & question.getTasks ( ) .length > 0 ) ; } , + verifyAtLeastOneBuggyOutputTestExists : function ( question ) { + return question.getTasks ( ) .some ( function ( task ) { + return task.getBuggyOutputTests ( ) .length > 0 ; + } ) ; + } , verifyStyleTestsAreArray : function ( question ) { return angular.isArray ( question.getStyleTests ( ) ) ; } , diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 156307b..e226acc 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -23,7 +23,7 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { var questions = [ ] ; // Hardcoded number of functions in QuestionSchemaValidationService . // Update if you add new question schema tests . - var EXPECTED_VERIFIER_FUNCTION_COUNT = 11 ; + var EXPECTED_VERIFIER_FUNCTION_COUNT = 12 ; // Should contain all question IDs . // TODO ( eyurko ) : Figure out a way to dynamically check to make sure // that all question IDs are specified . @ @ -47,6 +47,18 @ @ describe ( 'QuestionSchemaValidationService
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..0f49ab3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..eec7dae 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..94f9594 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,16 +343,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } ,
diff -- git a/client/question/services/FeedbackGeneratorService.js b/client/question/services/FeedbackGeneratorService.js index eb03f7a..f7a831f 100644 -- - a/client/question/services/FeedbackGeneratorService.js +++ b/client/question/services/FeedbackGeneratorService.js @ @ -298,6 +298,9 @ @ tie.factory ( 'FeedbackGeneratorService ' , [ // Provide a new hint if the student gets stuck on the same bug despite // having modified their code , since in that case we do n't want to give // the same message twice in a row . + // NOTE ( sll ) : This does n't work correctly anymore with the interposition + // of the new `` you have n't changed your code '' feedback -- but that might + // actually be OK , and even preferable . Needs discussion . if ( codeHasChanged & & messages [ previousHintIndex ] === previousMessage ) { newHintIndex++ ; } @ @ -590,7 +593,8 @ @ tie.factory ( 'FeedbackGeneratorService ' , [ * @ returns { Feedback } * @ private */ - var _getMainFeedback = function ( tasks , codeEvalResult , rawCodeLineIndexes ) { + var _getMainFeedback = function ( // eslint-disable-line complexity + tasks , codeEvalResult , rawCodeLineIndexes , previousFeedbackDetails ) { var errorString = codeEvalResult.getErrorString ( ) ; if ( errorString ) { // We want to catch and
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index ea930e7..a5658b0 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -41,8 +41,8 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < div class= '' tie-feedback-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > < div class= '' tie-feedback '' > < p ng-repeat= '' paragraph in feedbackParagraphs track by $ index '' - class= '' tie-feedback-paragraph '' - ng-class= '' { 'tie-feedback-paragraph-code ' : paragraph.isCodeParagraph ( ) } '' > + class= '' tie-feedback-paragraph '' + ng-class= '' { 'tie-feedback-paragraph-code ' : paragraph.isCodeParagraph ( ) } '' > < span ng-if= '' $ first '' > { { feedbackTimestamp } } < /span > < span ng-if= '' paragraph.isTextParagraph ( ) '' > { { paragraph.getContent ( ) } } @ @ -52,6 +52,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /span > < /p > < /div > + < div class= '' tie-feedback-syntax-error '' > + < a href class= '' tie-feedback-syntax-error-link '' , + ng-click= '' toggleSyntaxErrorHint ( ) '' , + ng-show= '' syntaxErrorFound '' > + { { isSyntaxErrorShown ? 'Hide error details ' : 'Display error
diff -- git a/assets/tests/QuestionSchemaValidationService.js b/assets/tests/QuestionSchemaValidationService.js index 3b0a0b8..0d0f9da 100644 -- - a/assets/tests/QuestionSchemaValidationService.js +++ b/assets/tests/QuestionSchemaValidationService.js @ @ -60,6 +60,11 @ @ tie.factory ( 'QuestionSchemaValidationService ' , [ angular.isArray ( question.getTasks ( ) ) & & question.getTasks ( ) .length > 0 ) ; } , + verifyAtLeastOneBuggyOutputTestExists : function ( question ) { + return question.getTasks ( ) .some ( function ( task ) { + return task.getBuggyOutputTests ( ) .length > 0 ; + } ) ; + } , verifyStyleTestsAreArray : function ( question ) { return angular.isArray ( question.getStyleTests ( ) ) ; } , diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 156307b..0d79d0e 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -23,7 +23,7 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { var questions = [ ] ; // Hardcoded number of functions in QuestionSchemaValidationService . // Update if you add new question schema tests . - var EXPECTED_VERIFIER_FUNCTION_COUNT = 11 ; + var EXPECTED_VERIFIER_FUNCTION_COUNT = 12 ; // Should contain all question IDs . // TODO ( eyurko ) : Figure out a way to dynamically check to make sure // that all question IDs are specified . @ @ -47,6 +47,16 @ @ describe ( 'QuestionSchemaValidationService
diff -- git a/assets/tests/TaskSchemaValidationServiceSpec.js b/assets/tests/TaskSchemaValidationServiceSpec.js index 82ff31c..08d5b4f 100644 -- - a/assets/tests/TaskSchemaValidationServiceSpec.js +++ b/assets/tests/TaskSchemaValidationServiceSpec.js @ @ -25,9 +25,7 @ @ describe ( 'TaskSchemaValidationService ' , function ( ) { // Update if you add new task schema tests . var EXPECTED_VERIFIER_FUNCTION_COUNT = 24 ; // Should contain all question IDs . - // TODO ( eyurko ) : Figure out a way to dynamically check to make sure - // that all question IDs are specified . - var QUESTION_IDS = [ 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' ] ; + var QUESTION_IDS = Object.keys ( globalData.questions ) ; beforeEach ( module ( 'tie ' ) ) ; beforeEach ( inject ( function ( $ injector ) { diff -- git a/client/app.js b/client/app.js index bffda0d..6e824a3 100644 -- - a/client/app.js +++ b/client/app.js @ @ -18,6 +18,8 @ @ window.globalData = { // Question data will be stored here , keyed by question ID . + // Questions are instantiated in assets/questions , and they add themselves + // to this dictionary when they 're instantiated . questions : { } , // Question set data will be stored here , keyed by question set ID . questionSets
diff -- git a/assets/tests/TaskSchemaValidationServiceSpec.js b/assets/tests/TaskSchemaValidationServiceSpec.js index 82ff31c..08d5b4f 100644 -- - a/assets/tests/TaskSchemaValidationServiceSpec.js +++ b/assets/tests/TaskSchemaValidationServiceSpec.js @ @ -25,9 +25,7 @ @ describe ( 'TaskSchemaValidationService ' , function ( ) { // Update if you add new task schema tests . var EXPECTED_VERIFIER_FUNCTION_COUNT = 24 ; // Should contain all question IDs . - // TODO ( eyurko ) : Figure out a way to dynamically check to make sure - // that all question IDs are specified . - var QUESTION_IDS = [ 'reverseWords ' , 'parens ' , 'i18n ' , 'rle ' ] ; + var QUESTION_IDS = Object.keys ( globalData.questions ) ; beforeEach ( module ( 'tie ' ) ) ; beforeEach ( inject ( function ( $ injector ) {
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..a4825f6 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'tests/*.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data :
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..3cd1dc5 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,57 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + + # Usage : + # Not meant for manual use + # Runs automatically before a git push command is executed + # Behaviour can be set up using `` bash scripts/setup_hooks.sh '' + + # Ask user if push should
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..4c8934f 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..9793840 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..eec7dae 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..f9cf6ed 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,16 +343,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..99fd9ee 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,16 +343,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/client/services/SolutionHandlerService.js b/client/services/SolutionHandlerService.js index 3a074d2..2779b24 100644 -- - a/client/services/SolutionHandlerService.js +++ b/client/services/SolutionHandlerService.js @ @ -49,9 +49,9 @ @ tie.factory ( 'SolutionHandlerService ' , [ studentCode.trim ( ) ) ; CodePreprocessorDispatcherService.preprocess ( language , codeSubmission , auxiliaryCode , - task.getMainFunctionName ( ) , task.getOutputFunctionName ( ) , - task.getCorrectnessTests ( ) , task.getBuggyOutputTests ( ) , - task.getPerformanceTests ( ) ) ; + task.getInputFunctionName ( ) , task.getMainFunctionName ( ) , + task.getOutputFunctionName ( ) , task.getCorrectnessTests ( ) , + task.getBuggyOutputTests ( ) , task.getPerformanceTests ( ) ) ; return CodeRunnerDispatcherService.runCodeAsync ( language , codeSubmission.getPreprocessedCode ( ) diff -- git a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js index 26947f2..c81d167 100644 -- - a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js +++ b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js @ @ -22,12 +22,12 @ @ tie.factory ( 'CodePreprocessorDispatcherService ' , [ function ( PythonCodePreprocessorService , LANGUAGE_PYTHON ) { return { preprocess : function ( - language , codeSubmission , auxiliaryCode , mainFunctionName , + language , codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests ) { if ( language === LANGUAGE_PYTHON ) { return PythonCodePreprocessorService.preprocess ( - codeSubmission , auxiliaryCode , mainFunctionName , outputFunctionName , + codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..7b450f6 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,15 +340,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller : [ ' $ scope ' , ' $ timeout ' , 'SolutionHandlerService ' , 'QuestionDataService ' , - 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , + 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , 'CodeStoreService ' , function ( $ scope , $ timeout , SolutionHandlerService , QuestionDataService , - LANGUAGE_PYTHON , FeedbackObjectFactory ) { + LANGUAGE_PYTHON , FeedbackObjectFactory , CodeStoreService ) { var DURATION_MSEC_WAIT_FOR_SCROLL = 20 ; var language = LANGUAGE_PYTHON ; // TODO ( sll ) : Generalize
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..0f49ab3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..2908b57 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..eec7dae 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..eec7dae 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 -- - a/assets/questions/rle.js +++ b/assets/questions/rle.js @ @ -139,7 +139,7 @ @ globalData.questions [ 'rle ' ] = { // eslint-disable-line dot-notation 'In this question , you\ 'll implement the encode function . It takes a ' , 'string as input and returns an encoding of the string where long ' , 'runs of characters are replaced by < # characters > x < character > . For ' , - 'example , `` abcccccd '' could be encoded as `` ab5xc '' . ' + 'example , `` abcccccd '' could be encoded as `` ab5xcd '' . ' ] .join ( `` ) ] , prerequisiteSkills : [ 'Arrays ' , 'Strings ' , 'String Manipulation ' ] , diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- -
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 2eb93bc..fa8231e 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -67,6 +67,10 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < select class= '' tie-lang-select-menu '' name= '' lang-select-menu '' > < option value= '' Python '' selected > Python < /option > < /select > + < button class= '' tie-code-reset '' name= '' code-reset '' + ng-click= '' resetCode ( ) '' > + Reset Code + < /button > < button class= '' tie-run-button '' ng-class= '' { 'active ' : ! nextButtonIsShown } '' ng-click= '' submitCode ( code ) '' @ @ -116,6 +120,11 @ @ tie.directive ( 'learnerView ' , [ function ( ) { top : calc ( 50 % - 25px ) ; width : 50px ; } + .tie-code-reset { + float : left ; + margin-top : 10px ; + margin-left : 10px ; + } .tie-coding-terminal .CodeMirror { /* Overwriting codemirror defaults */ height : 100 % ; @ @ -502,6 +511,12 @ @ tie.directive ( 'learnerView ' , [ function ( ) { $ scope.questionIds [ $ scope.currentQuestionIndex ] , code , language ) ; } ; + $
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..ff0618c -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,9 @ @ + # ! /bin/sh + +echo `` Running hook from new directory '' +echo `` Running linter tests '' +sh scripts/run_linter.sh +echo `` Running karma tests '' +sh scripts/run_karma_tests.sh + +exit 0
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..a7afb0f -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,16 @ @ + # ! /bin/bash + +echo `` Running linter tests '' +lines= $ ( sh scripts/run_linter.sh | wc -l ) +if [ $ lines -eq 1 ] ; then + echo `` Linter tests passed '' +else + echo `` Linter tests failed '' + exit 1 +fi + +echo `` Running karma tests '' + # TODO + # sh scripts/run_karma_tests.sh + +exit 0 diff -- git a/scripts/setup_hooks.sh b/scripts/setup_hooks.sh new file mode 100644 index 0000000..03033af -- - /dev/null +++ b/scripts/setup_hooks.sh @ @ -0,0 +1,3 @ @ + # ! /bin/sh + +git config core.hooksPath `` ./hooks ''
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..bc0a398 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,23 @ @ + # ! /bin/bash + +echo `` Running linter tests '' +lines= $ ( sh scripts/run_linter.sh | wc -l ) +if [ $ lines -eq 1 ] ; then + echo `` Linter tests passed '' +else + # Assign standard input to keyboard + exec < /dev/tty + + read -p `` Linter tests failed . Do you want to continue anyway ? ( y/n ) '' yn + case $ yn in + [ Yy ] * ) ; ; + [ Nn ] * ) echo `` Not pushing changes '' ; exit 1 ; ; + * ) echo `` Invalid input '' ; ; + esac +fi + +echo `` Running karma tests '' + # TODO + # sh scripts/run_karma_tests.sh + +exit 0 diff -- git a/scripts/setup_hooks.sh b/scripts/setup_hooks.sh new file mode 100644 index 0000000..03033af -- - /dev/null +++ b/scripts/setup_hooks.sh @ @ -0,0 +1,3 @ @ + # ! /bin/sh + +git config core.hooksPath `` ./hooks ''
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..91058ac 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -148,6 +148,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-coding-ui , .tie-question-ui { display : inline-block ; margin : 8px ; + white-space : normal ; } @ -webkit-keyframes tie-dot { from { -webkit-transform : translate ( 0px , 0px ) ; } @ @ -177,6 +178,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-question-ui-inner { padding-left : 32px ; padding-right : 32px ; + white-space : nowrap ; } .tie-question-ui-outer { display : table ; @ @ -491,4 +493,4 @ @ tie.directive ( 'learnerView ' , [ function ( ) { } ] } ; - } ] ) ; + } ] ) ; \ No newline at end of file
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..fd210bc 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -86,7 +86,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < div class= '' tie-question-ui '' > < div class= '' tie-question-window '' > - < h3 > Question { { currentQuestionIndex + 1 } } : { { title } } < /h3 > + < h3 class= '' tie-question-title '' > { { title } } < /h3 > < div class= '' tie-previous-instructions '' > < div ng-repeat= '' previousInstruction in previousInstructions track by $ index '' > < p ng-repeat= '' paragraph in previousInstruction track by $ index '' > { { paragraph } } < /p > @ @ -258,6 +258,9 @ @ tie.directive ( 'learnerView ' , [ function ( ) { .tie-previous-instructions { opacity : 0.5 ; } + .tie-question-title { + color : rgb ( 66 , 133 , 244 ) ; + } .tie-question-ui { vertical-align : top ; }
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..7467bcd 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,15 +343,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller : [ ' $ scope ' , ' $ timeout ' , 'SolutionHandlerService ' , 'QuestionDataService ' , - 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , + 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , 'CodeStoreService ' , function ( $ scope , $ timeout , SolutionHandlerService , QuestionDataService , - LANGUAGE_PYTHON , FeedbackObjectFactory ) { + LANGUAGE_PYTHON , FeedbackObjectFactory , CodeStoreService ) { var DURATION_MSEC_WAIT_FOR_SCROLL = 20 ; var language = LANGUAGE_PYTHON ; // TODO ( sll ) : Generalize
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..4c8934f 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..fef862d -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'testing/page-loading-spec.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data : text/html , < html > < /html > as resetUrl , but + // location.replace from the data : to the file : protocol is not allowed + // ( we 'll get ‘ not allowed local resource ’ error ) , so we replace resetUrl with one + // with the file : protocol ( this particular one will open system 's root folder ) + browser.resetUrl = 'file : // ' ; + } + } ;
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..a4825f6 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'tests/*.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data :
diff -- git a/client/domain/CorrectnessTestObjectFactory.js b/client/domain/CorrectnessTestObjectFactory.js index 587054d..0263797 100644 -- - a/client/domain/CorrectnessTestObjectFactory.js +++ b/client/domain/CorrectnessTestObjectFactory.js @ @ -31,6 +31,20 @ @ tie.factory ( 'CorrectnessTestObjectFactory ' , [ } ; CorrectnessTest.prototype.matchesOutput = function ( output ) { + // If allowOutputs should be arrays and learner 's code returns an array + if ( this._allowedOutputs.length > 0 & & + this._allowedOutputs [ 0 ] instanceof Array & & + output instanceof Array ) { + // Stringify the arrays and then compare + var stringifiedOutput = JSON.stringify ( output ) ; + for ( var i = 0 , l = this._allowedOutputs.length ; i < l ; i++ ) { + if ( JSON.stringify ( this._allowedOutputs [ i ] ) === stringifiedOutput ) { + return true ; + } + } + // If output matches none allowedOutputs + return false ; + } return this._allowedOutputs.indexOf ( output ) ! == -1 ; } ;
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a3f2495..4dfe080 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -45,6 +45,12 @ @ tie.directive ( 'learnerView ' , [ function ( ) { { { paragraph.getContent ( ) } } < /p > < /div > + < div class= '' tie-dot-container '' + ng-class= '' { 'tie-dot-hidden ' : hideDotDiv } '' > + < div class= '' tie-dot tie-dot-1 '' > < /div > + < div class= '' tie-dot tie-dot-2 '' > < /div > + < div class= '' tie-dot tie-dot-3 '' > < /div > + < /div > < /div > < div class= '' tie-coding-window '' > < div class= '' tie-lang-terminal '' > @ @ -66,6 +72,7 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < div class= '' tie-next-curtain-container '' ng-if= '' nextButtonIsShown '' > < div class= '' tie-next-curtain '' > < /div > + < div class= '' tie-arrow-highlighter '' > < /div > < div ng-click= '' showNextPrompt ( ) '' class= '' tie-next-arrow '' > < span class= '' tie-next-button-text '' > Next < /span > < /div > @ @ -98,6 +105,16 @ @ tie.directive (
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 52ed949..ebe4c51 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -344,6 +344,16 @ @ tie.directive ( 'learnerView ' , [ function ( ) { $ scope.codeMirrorOptions = { autofocus : true , + extraKeys : { + Tab : function ( cm ) { + var spaces = Array ( cm.getOption ( 'indentUnit ' ) + 1 ) .join ( ' ' ) ; + cm.replaceSelection ( spaces ) ; + // Move the cursor to the end of the selection . + var endSelectionPos = cm.getDoc ( ) .getCursor ( 'head ' ) ; + cm.getDoc ( ) .setCursor ( endSelectionPos ) ; + } + } , + indentUnit : 4 , lineNumbers : true , mode : LANGUAGE_PYTHON , smartIndent : false ,
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..c2acd67 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,61 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + + # Usage : + # Not meant for manual use + # Runs automatically before a git push command is executed + # Behaviour can be set up using `` bash scripts/setup_hooks.sh '' + + # Ask user if push should
diff -- git a/assets/tests/TaskSchemaValidationService.js b/assets/tests/TaskSchemaValidationService.js index e6451be..4ac815f 100644 -- - a/assets/tests/TaskSchemaValidationService.js +++ b/assets/tests/TaskSchemaValidationService.js @ @ -201,7 +201,7 @ @ tie.factory ( 'TaskSchemaValidationService ' , [ verifyPerformanceTestsHaveLinearExpectedPerformance : function ( task ) { var performanceTests = task.getPerformanceTests ( ) ; return performanceTests.every ( function ( test ) { - return ALLOWED_RUNTIMES.includes ( test.getExpectedPerformance ( ) ) ; + return ALLOWED_RUNTIMES.indexOf ( test.getExpectedPerformance ( ) ) ! == -1 ; } ) ; } , verifyPerformanceTestsHaveEvaluationFunctionName : function ( task ) { diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..31b7a99 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,56 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..7b450f6 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,15 +340,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller : [ ' $ scope ' , ' $ timeout ' , 'SolutionHandlerService ' , 'QuestionDataService ' , - 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , + 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , 'CodeStoreService ' , function ( $ scope , $ timeout , SolutionHandlerService , QuestionDataService , - LANGUAGE_PYTHON , FeedbackObjectFactory ) { + LANGUAGE_PYTHON , FeedbackObjectFactory , CodeStoreService ) { var DURATION_MSEC_WAIT_FOR_SCROLL = 20 ; var language = LANGUAGE_PYTHON ; // TODO ( sll ) : Generalize
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..0f49ab3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..9793840 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..ee7c6b7 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in seconds . +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` ,
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index 0d79d0e..c2e5166 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -79,5 +79,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..c586ff7 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'testing/page-loading-spec.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data :
diff -- git a/client/services/SolutionHandlerService.js b/client/services/SolutionHandlerService.js index 3a074d2..2779b24 100644 -- - a/client/services/SolutionHandlerService.js +++ b/client/services/SolutionHandlerService.js @ @ -49,9 +49,9 @ @ tie.factory ( 'SolutionHandlerService ' , [ studentCode.trim ( ) ) ; CodePreprocessorDispatcherService.preprocess ( language , codeSubmission , auxiliaryCode , - task.getMainFunctionName ( ) , task.getOutputFunctionName ( ) , - task.getCorrectnessTests ( ) , task.getBuggyOutputTests ( ) , - task.getPerformanceTests ( ) ) ; + task.getInputFunctionName ( ) , task.getMainFunctionName ( ) , + task.getOutputFunctionName ( ) , task.getCorrectnessTests ( ) , + task.getBuggyOutputTests ( ) , task.getPerformanceTests ( ) ) ; return CodeRunnerDispatcherService.runCodeAsync ( language , codeSubmission.getPreprocessedCode ( ) diff -- git a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js index 26947f2..c81d167 100644 -- - a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js +++ b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js @ @ -22,12 +22,12 @ @ tie.factory ( 'CodePreprocessorDispatcherService ' , [ function ( PythonCodePreprocessorService , LANGUAGE_PYTHON ) { return { preprocess : function ( - language , codeSubmission , auxiliaryCode , mainFunctionName , + language , codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests ) { if ( language === LANGUAGE_PYTHON ) { return PythonCodePreprocessorService.preprocess ( - codeSubmission , auxiliaryCode , mainFunctionName , outputFunctionName , + codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests
diff -- git a/client/services/SolutionHandlerService.js b/client/services/SolutionHandlerService.js index 3a074d2..83731ad 100644 -- - a/client/services/SolutionHandlerService.js +++ b/client/services/SolutionHandlerService.js @ @ -49,9 +49,9 @ @ tie.factory ( 'SolutionHandlerService ' , [ studentCode.trim ( ) ) ; CodePreprocessorDispatcherService.preprocess ( language , codeSubmission , auxiliaryCode , - task.getMainFunctionName ( ) , task.getOutputFunctionName ( ) , - task.getCorrectnessTests ( ) , task.getBuggyOutputTests ( ) , - task.getPerformanceTests ( ) ) ; + task.getInputFunctionName ( ) , task.getMainFunctionName ( ) , + task.getOutputFunctionName ( ) , task.getCorrectnessTests ( ) , + task.getBuggyOutputTests ( ) , task.getPerformanceTests ( ) ) ; return CodeRunnerDispatcherService.runCodeAsync ( language , codeSubmission.getPreprocessedCode ( ) diff -- git a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js index 26947f2..c81d167 100644 -- - a/client/services/code_preprocessors/CodePreprocessorDispatcherService.js +++ b/client/services/code_preprocessors/CodePreprocessorDispatcherService.js @ @ -22,12 +22,12 @ @ tie.factory ( 'CodePreprocessorDispatcherService ' , [ function ( PythonCodePreprocessorService , LANGUAGE_PYTHON ) { return { preprocess : function ( - language , codeSubmission , auxiliaryCode , mainFunctionName , + language , codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests ) { if ( language === LANGUAGE_PYTHON ) { return PythonCodePreprocessorService.preprocess ( - codeSubmission , auxiliaryCode , mainFunctionName , outputFunctionName , + codeSubmission , auxiliaryCode , inputFunctionName , mainFunctionName , outputFunctionName , correctnessTests , buggyOutputTests , performanceTests
diff -- git a/assets/question_sets/all.js b/assets/question_sets/all.js index cde91f6..8ad43a6 100644 -- - a/assets/question_sets/all.js +++ b/assets/question_sets/all.js @ @ -31,6 +31,7 @ @ globalData.questionSets [ 'all ' ] = { // eslint-disable-line dot-notation 'checkBalancedParentheses ' , 'findAlphabet ' , 'findBestMeetupLocation ' , + 'findClosestValueBst ' , 'findFirstNonRepeatingCharacter ' , 'findMostCommonCharacter ' , 'getStrobogrammaticNumbers ' , diff -- git a/assets/question_sets/other.js b/assets/question_sets/other.js index 849a705..c2fff3f 100644 -- - a/assets/question_sets/other.js +++ b/assets/question_sets/other.js @ @ -33,6 +33,7 @ @ globalData.questionSets [ 'other ' ] = { // eslint-disable-line dot-notation 'bomberman ' , 'findAlphabet ' , 'findBestMeetupLocation ' , + 'findClosestValueBst ' , 'findFirstNonRepeatingCharacter ' , 'getStrobogrammaticNumbers ' , 'incrementDecimalCodedNumber ' , diff -- git a/assets/questions/bstClosestValue.js b/assets/questions/bstClosestValue.js new file mode 100644 index 0000000..478e63f -- - /dev/null +++ b/assets/questions/bstClosestValue.js @ @ -0,0 +1,210 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License
diff -- git a/assets/questions/findAlphabet.js b/assets/questions/findAlphabet.js index df95f7e..d63d175 100644 -- - a/assets/questions/findAlphabet.js +++ b/assets/questions/findAlphabet.js @ @ -228,9 +228,9 @ @ globalData.questions [ 'findAlphabet ' ] = { // eslint-disable-line dot-notation } , { content : [ - 'For the test case that has no solution , just return `` '' . If ' , - 'multiple letters have the same frequency , return them in ' , - 'alphabetical order . ' + 'If the test case has no solution , return `` '' . If there is not ' , + 'information to order multiple characters , return them in ' , + 'standard alphabetical order . ' ] .join ( `` ) , type : 'text' } ,
diff -- git a/assets/questions/findAlphabet.js b/assets/questions/findAlphabet.js index df95f7e..af8e580 100644 -- - a/assets/questions/findAlphabet.js +++ b/assets/questions/findAlphabet.js @ @ -228,9 +228,9 @ @ globalData.questions [ 'findAlphabet ' ] = { // eslint-disable-line dot-notation } , { content : [ - 'For the test case that has no solution , just return `` '' . If ' , - 'multiple letters have the same frequency , return them in ' , - 'alphabetical order . ' + 'If the test case has no solution , return `` '' . If there is not ' , + 'enough information to order multiple characters , return them in ' , + 'standard alphabetical order . ' ] .join ( `` ) , type : 'text' } ,
diff -- git a/assets/questions/palindrome.js b/assets/questions/palindrome.js new file mode 100644 index 0000000..8207d92 -- - /dev/null +++ b/assets/questions/palindrome.js @ @ -0,0 +1,166 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Balanced Palindrome . + */ + +globalData.questions [ 'palindrome ' ] = { // eslint-disable-line dot-notation + title : 'Balanced Palindrome ' , + starterCode : { + python : + ` def isPalindrome ( s ) : + return False + ` + } , + auxiliaryCode : { + python :
diff -- git a/assets/questions/bestMeetupLocation.js b/assets/questions/bestMeetupLocation.js new file mode 100644 index 0000000..2446a3c -- - /dev/null +++ b/assets/questions/bestMeetupLocation.js @ @ -0,0 +1,135 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Best Meeting Location for N People in + * a Manhattan-like City . + */ + +globalData.questions [ 'bestMeetupLocation ' ] = { // eslint-disable-line dot-notation + title : 'Best Meeting Location for N People in a Manhattan-like City ' , + starterCode : { + python : + ` def bestMeetupLocation (
diff -- git a/hooks/pre-push b/hooks/pre-push new file mode 100755 index 0000000..7174846 -- - /dev/null +++ b/hooks/pre-push @ @ -0,0 +1,61 @ @ + # ! /usr/bin/env bash + + # Copyright 2017 The TIE Authors . All Rights Reserved . + # + # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + # you may not use this file except in compliance with the License . + # You may obtain a copy of the License at + # + # http : //www.apache.org/licenses/LICENSE-2.0 + # + # Unless required by applicable law or agreed to in writing , software + # distributed under the License is distributed on an `` AS-IS '' BASIS , + # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + # See the License for the specific language governing permissions and + # limitations under the License . + + # Usage : + # + # Not meant for manual use + # Runs automatically before a git push command is executed + # Behaviour can be set up using `` bash scripts/setup_hooks.sh '' + + # Ask user if
diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStoreService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 117365d..7467bcd 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -343,15 +343,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller : [ ' $ scope ' , ' $ timeout ' , 'SolutionHandlerService ' , 'QuestionDataService ' , - 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , + 'LANGUAGE_PYTHON ' , 'FeedbackObjectFactory ' , 'CodeStoreService ' , function ( $ scope , $ timeout , SolutionHandlerService , QuestionDataService , - LANGUAGE_PYTHON , FeedbackObjectFactory ) { + LANGUAGE_PYTHON , FeedbackObjectFactory , CodeStoreService ) { var DURATION_MSEC_WAIT_FOR_SCROLL = 20 ; var language = LANGUAGE_PYTHON ; // TODO ( sll ) : Generalize
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..9793840 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..9793840 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aea0eed..eec7dae 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -339,16 +339,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/client/app.html b/client/app.html index 748a503..77f5aaf 100644 -- - a/client/app.html +++ b/client/app.html @ @ -37,6 +37,7 @ @ < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > diff -- git a/client/app.js b/client/app.js index bffda0d..9a941c8 100644 -- - a/client/app.js +++ b/client/app.js @ @ -72,3 +72,5 @ @ tie.constant ( 'VARNAME_BUGGY_OUTPUT_TEST_RESULTS ' , 'buggy_output_test_results ' ) ; tie.constant ( 'VARNAME_PERFORMANCE_TEST_RESULTS ' , 'performance_test_results ' ) ; // Name of the variable in which a copy of the most recent input is stored . tie.constant ( 'VARNAME_MOST_RECENT_INPUT ' , 'most_recent_input ' ) ; +// Default auto save time in ms +tie.constant ( 'DEFAULT_AUTO_SAVE_SECONDS ' , 3 ) ; diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 31c5059..3ff6b5a 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -340,16 +340,15 @ @ tie.directive ( 'learnerView ' , [ function ( ) { ` , controller
diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 -- - a/assets/questions/rle.js +++ b/assets/questions/rle.js @ @ -139,7 +139,7 @ @ globalData.questions [ 'rle ' ] = { // eslint-disable-line dot-notation 'In this question , you\ 'll implement the encode function . It takes a ' , 'string as input and returns an encoding of the string where long ' , 'runs of characters are replaced by < # characters > x < character > . For ' , - 'example , `` abcccccd '' could be encoded as `` ab5xc '' . ' + 'example , `` abcccccd '' could be encoded as `` ab5xcd '' . ' ] .join ( `` ) ] , prerequisiteSkills : [ 'Arrays ' , 'Strings ' , 'String Manipulation ' ] , diff -- git a/client/app.html b/client/app.html index 748a503..7d7d7d9 100644 -- -
diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length of the middle of the string > < last character > ' , + 'but only if it shortens the input . ' , 'For example , `` internationalization '' should be abbreviated as `` i18n '' . ' ] .join ( `` ) ] , diff -- git a/assets/questions/reverseWords.js b/assets/questions/reverseWords.js index 25c961d..a2e45ec 100644 -- - a/assets/questions/reverseWords.js +++ b/assets/questions/reverseWords.js @ @ -20,7 +20,7 @ @ globalData.questions [ 'reverseWords ' ] = { // eslint-disable-line dot-notation title : 'Reverse Words ' , starterCode : { python : - ` def reverseWords ( word ) : + ` def reverseWords ( str ) : return `` '' ` } , diff -- git a/assets/questions/rle.js b/assets/questions/rle.js index 13a1dc4..45070a5 100644 --
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def are_all_unique ( words ) : [ 'First , implement the abbreviate function . It takes a string as input ' , 'and returns an abbreviation of the string of the form ' , - ' < first character > < length of the middle of the string > < last character > . ' , + ' < first character > < length
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..968f1b6 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { @ @ -120,6 +122,7 @ @ `` no-shadow-restricted-names '' : `` error '' , `` no-tabs '' : `` error '' , `` no-throw-literal '' : `` error '' , + `` no-trailing-spaces '' : `` error '' , `` no-undef-init '' : `` error '' , `` no-unmodified-loop-condition '' : `` error '' , `` no-unneeded-ternary '' : `` error '' , diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/assets/questions/i18n.js b/assets/questions/i18n.js index 896863a..df12ceb 100644 -- - a/assets/questions/i18n.js +++ b/assets/questions/i18n.js @ @ -55,7 +55,8 @ @ def
diff -- git a/assets/tests/QuestionSchemaValidationServiceSpec.js b/assets/tests/QuestionSchemaValidationServiceSpec.js index dd56227..aa064a4 100644 -- - a/assets/tests/QuestionSchemaValidationServiceSpec.js +++ b/assets/tests/QuestionSchemaValidationServiceSpec.js @ @ -77,5 +77,12 @ @ describe ( 'QuestionSchemaValidationService ' , function ( ) { ] .join ( `` ) ) ; } ) ; } ) ; + + it ( 'should check if a question id contains only chars and digits ' , function ( ) { + QUESTION_IDS.forEach ( function ( questionId , index ) { + expect ( /^\w+ $ /.test ( QUESTION_IDS [ index ] ) ) .toBe ( true ) ; + } ) ; + } ) ; } ) ; } ) ; + diff -- git a/client/app.html b/client/app.html index 748a503..91e3d0f 100644 -- - a/client/app.html +++ b/client/app.html @ @ -33,6 +33,7 @ @ < script src= '' domain/TaskObjectFactory.js '' > < /script > < script src= '' domain/TracebackCoordinatesObjectFactory.js '' > < /script > < script src= '' domain/TranscriptObjectFactory.js '' > < /script > + < script src= '' services/CodeStorageService.js '' > < /script > < script src= '' services/FeedbackGeneratorService.js '' > < /script > < script src= '' services/QuestionDataService.js '' > < /script > < script src= '' services/SolutionHandlerService.js '' > < /script > diff -- git a/client/app.js b/client/app.js
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..a4825f6 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'tests/*.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data :
diff -- git a/.eslintrc.json b/.eslintrc.json index 3ac1903..e0032fd 100644 -- - a/.eslintrc.json +++ b/.eslintrc.json @ @ -3,7 +3,9 @ @ `` env '' : { `` browser '' : true , `` es6 '' : true , - `` jasmine '' : true + `` jasmine '' : true , + `` protractor '' : true , + `` node '' : true } , `` extends '' : `` eslint : recommended '' , `` globals '' : { diff -- git a/.travis.yml b/.travis.yml index 2c2d93b..8ba16ed 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -23,4 +23,5 @ @ install : true script : - bash scripts/run_karma_tests.sh -- single-run - bash scripts/run_linter.sh +- bash scripts/run_e2e_tests.sh sudo : required diff -- git a/protractor.conf.js b/protractor.conf.js new file mode 100644 index 0000000..a4825f6 -- - /dev/null +++ b/protractor.conf.js @ @ -0,0 +1,17 @ @ +// Protractor configuration for TIE . + +exports.config = { + framework : 'jasmine ' , + capabilities : { + browserName : 'chrome' + } , + specs : [ 'tests/*.js ' ] , + baseUrl : 'file : // ' + __dirname , + onPrepare : function ( ) { + // By default , Protractor use data :
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index a935465..aea0eed 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -59,10 +59,9 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < div class= '' tie-coding-window '' > < div class= '' tie-lang-terminal '' > < div class= '' tie-coding-terminal '' > - < ui-codemirror ui-codemirror= '' codeMirrorOptions '' + < ui-codemirror ui-codemirror-opts= '' codeMirrorOptions '' ng-model= '' code '' - class= '' tie-codemirror-container '' > - < /ui-codemirror > + class= '' tie-codemirror-container '' > < /ui-codemirror > < /div > < select class= '' tie-lang-select-menu '' name= '' lang-select-menu '' > < option value= '' Python '' selected > Python < /option >
diff -- git a/assets/questions/findMostCommonCharacter.js b/assets/questions/findMostCommonCharacter.js index eece874..5b6b1ea 100644 -- - a/assets/questions/findMostCommonCharacter.js +++ b/assets/questions/findMostCommonCharacter.js @ @ -92,7 +92,7 @ @ class AuxiliaryCode ( object ) : allowedOutputs : [ 's ' ] , tag : 'strings with many spaces' } , { - input : 'a b c d e f f ' , + input : 'a b c d e f f ' , allowedOutputs : [ 'f ' ] , tag : 'strings with many spaces' } ] , diff -- git a/client/domain/ReinforcementObjectFactory.js b/client/domain/ReinforcementObjectFactory.js index 91d8026..d2895af 100644 -- - a/client/domain/ReinforcementObjectFactory.js +++ b/client/domain/ReinforcementObjectFactory.js @ @ -64,6 +64,17 @ @ tie.factory ( 'ReinforcementObjectFactory ' , [ this._pastFailedCases = { } ; } ; + /** + * Helper function that replaces spaces in string so that it will preserve + * any extra , consecutive space characters in Reinforcement bullet . + * + * @ param { string } stringifiedInput + * @ returns { string } + */ + var formatInput = function ( stringifiedInput ) { + return stringifiedInput.replace ( / /g , '\u00A0 ' ) ; + } ; + // Instance methods . /** * This function creates an array of ReinforcementBullet objects @ @
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 005313b..40c86dc 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -37,22 +37,45 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > - < div class= '' tie-coding-ui '' > - < div class= '' tie-feedback-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > - < div class= '' tie-feedback '' > - < p ng-repeat= '' paragraph in feedbackParagraphs track by $ index '' - class= '' tie-feedback-paragraph '' - ng-class= '' { 'tie-feedback-paragraph-code ' : paragraph.isCodeParagraph ( ) } '' > - < span ng-if= '' $ first '' > { { feedbackTimestamp } } < /span > - < span ng-if= '' paragraph.isTextParagraph ( ) '' > + < div class= '' tie-question-ui '' > + < div class= '' tie-question-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > + < div class= '' tie-greetings '' > + < p ng-repeat= '' paragraph in greetingParagraphs track by $ index '' > { { paragraph.getContent ( ) } } - < /span > - < span ng-if= '' paragraph.isCodeParagraph ( ) '' > - < code-snippet
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 005313b..ab494c3 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -37,22 +37,44 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > - < div class= '' tie-coding-ui '' > - < div class= '' tie-feedback-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > - < div class= '' tie-feedback '' > - < p ng-repeat= '' paragraph in feedbackParagraphs track by $ index '' - class= '' tie-feedback-paragraph '' - ng-class= '' { 'tie-feedback-paragraph-code ' : paragraph.isCodeParagraph ( ) } '' > - < span ng-if= '' $ first '' > { { feedbackTimestamp } } < /span > - < span ng-if= '' paragraph.isTextParagraph ( ) '' > + < div class= '' tie-question-ui '' > + < div class= '' tie-question-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > + < div class= '' tie-greetings '' > + < p ng-repeat= '' paragraph in greetingParagraphs track by $ index '' > { { paragraph.getContent ( ) } } - < /span > - < span ng-if= '' paragraph.isCodeParagraph ( ) '' > - < code-snippet
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 036cf69..cd25226 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -37,38 +37,77 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /div > < /div > < /div > - < div class= '' tie-coding-ui '' > - < div class= '' tie-feedback-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > - < div class= '' tie-feedback '' > - < p ng-repeat= '' paragraph in feedbackParagraphs track by $ index '' - class= '' tie-feedback-paragraph '' - ng-class= '' { 'tie-feedback-paragraph-code ' : paragraph.isCodeParagraph ( ) } '' > - < span ng-if= '' $ first '' > { { feedbackTimestamp } } < /span > - < span ng-if= '' paragraph.isTextParagraph ( ) '' > + < div class= '' tie-question-ui '' > + < div class= '' tie-question-window '' ng-class= '' { 'night-mode ' : isInDarkMode } '' > + < div class= '' tie-greetings '' > + < p ng-repeat= '' paragraph in greetingParagraphs track by $ index '' > { { paragraph.getContent ( ) } } - < /span > - < span ng-if= '' paragraph.isCodeParagraph ( ) '' > - < code-snippet
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index aebb5af..0abdd44 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -72,15 +72,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < span ng-if= '' paragraph.isCodeParagraph ( ) '' > < code-snippet content= '' paragraph.getContent ( ) '' > test < /code-snippet > < /span > + < span ng-if= '' paragraph.isSyntaxErrorParagraph ( ) '' > + < a href class= '' tie-feedback-syntax-error-link '' + ng-click= '' toggleSyntaxErrorHint ( paragraph ) '' > + { { paragraph.syntaxErrorIsShown ? 'Hide error details ' : 'Display error details ' } } + < /a > + < span class= '' tie-feedback-error-string '' ng-show= '' paragraph.syntaxErrorIsShown '' > + { { paragraph.getContent ( ) } } + < /span > + < /span > < /p > < /div > - < a href class= '' tie-feedback-syntax-error-link '' ng-if= '' syntaxErrorString '' - ng-click= '' toggleSyntaxErrorHint ( ) '' > - { { isSyntaxErrorShown ? 'Hide error details ' : 'Display error details ' } } - < /a > - < span class= '' tie-feedback-error-string '' , ng-show= '' isSyntaxErrorShown '' > - { { syntaxErrorString } } - < /span > < div
diff -- git a/client/app.html b/client/app.html index 11e0f3a..f78b688 100644 -- - a/client/app.html +++ b/client/app.html @ @ -30,6 +30,7 @ @ < script src= '' domain/FeedbackObjectFactory.js '' > < /script > < script src= '' domain/FeedbackParagraphObjectFactory.js '' > < /script > < script src= '' domain/PerformanceTestObjectFactory.js '' > < /script > + < script src= '' domain/PreRequisiteCheckResultObjectFactory.js '' > < /script > < script src= '' domain/QuestionObjectFactory.js '' > < /script > < script src= '' domain/QuestionSetObjectFactory.js '' > < /script > < script src= '' domain/SnapshotObjectFactory.js '' > < /script > @ @ -43,7 +44,9 @ @ < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > + < script src= '' services/code_evaluators/PreRequisiteCheckDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > + < script src= '' services/code_evaluators/PythonPreRequisiteCheckService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > < script src= '' services/code_preprocessors/PythonCodePreprocessorService.js '' > < /script > < /head > diff -- git a/client/app.js b/client/app.js index 2bd611c..2789294 100644 -- - a/client/app.js +++ b/client/app.js @ @ -33,6 +33,9 @ @
diff -- git a/client/app.html b/client/app.html index 11e0f3a..19ed11e 100644 -- - a/client/app.html +++ b/client/app.html @ @ -30,6 +30,7 @ @ < script src= '' domain/FeedbackObjectFactory.js '' > < /script > < script src= '' domain/FeedbackParagraphObjectFactory.js '' > < /script > < script src= '' domain/PerformanceTestObjectFactory.js '' > < /script > + < script src= '' domain/PreRequisiteEvalResultObjectFactory.js '' > < /script > < script src= '' domain/QuestionObjectFactory.js '' > < /script > < script src= '' domain/QuestionSetObjectFactory.js '' > < /script > < script src= '' domain/SnapshotObjectFactory.js '' > < /script > @ @ -43,7 +44,9 @ @ < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > + < script src= '' services/code_evaluators/PreRequisiteCheckDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > + < script src= '' services/code_evaluators/PythonPreRequisiteCheckService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > < script src= '' services/code_preprocessors/PythonCodePreprocessorService.js '' > < /script > < /head > diff -- git a/client/app.js b/client/app.js index 2bd611c..d98a5f1 100644 -- - a/client/app.js +++ b/client/app.js @ @ -33,6 +33,9 @ @
diff -- git a/client/app.html b/client/app.html index d45841d..4c29dfa 100644 -- - a/client/app.html +++ b/client/app.html @ @ -32,6 +32,7 @ @ < script src= '' components/LearnerViewDirective.js '' > < /script > < script src= '' domain/BuggyOutputTestObjectFactory.js '' > < /script > < script src= '' domain/CodeEvalResultObjectFactory.js '' > < /script > + < script src= '' domain/CodePrereqCheckResultObjectFactory.js '' > < /script > < script src= '' domain/CodeSubmissionObjectFactory.js '' > < /script > < script src= '' domain/CorrectnessTestObjectFactory.js '' > < /script > < script src= '' domain/ErrorTracebackObjectFactory.js '' > < /script > @ @ -51,7 +52,9 @ @ < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > + < script src= '' services/code_evaluators/PrereqCheckDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > + < script src= '' services/code_evaluators/PythonPrereqCheckService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > < script src= '' services/code_preprocessors/PythonCodePreprocessorService.js '' > < /script > < /head > diff -- git a/client/app.js b/client/app.js index 6b870ce..fab1f73 100644 -- - a/client/app.js +++ b/client/app.js @ @ -33,6 +33,8 @ @
diff -- git a/client/app.html b/client/app.html index d45841d..4c29dfa 100644 -- - a/client/app.html +++ b/client/app.html @ @ -32,6 +32,7 @ @ < script src= '' components/LearnerViewDirective.js '' > < /script > < script src= '' domain/BuggyOutputTestObjectFactory.js '' > < /script > < script src= '' domain/CodeEvalResultObjectFactory.js '' > < /script > + < script src= '' domain/CodePrereqCheckResultObjectFactory.js '' > < /script > < script src= '' domain/CodeSubmissionObjectFactory.js '' > < /script > < script src= '' domain/CorrectnessTestObjectFactory.js '' > < /script > < script src= '' domain/ErrorTracebackObjectFactory.js '' > < /script > @ @ -51,7 +52,9 @ @ < script src= '' services/SolutionHandlerService.js '' > < /script > < script src= '' services/TranscriptService.js '' > < /script > < script src= '' services/code_evaluators/CodeRunnerDispatcherService.js '' > < /script > + < script src= '' services/code_evaluators/PrereqCheckDispatcherService.js '' > < /script > < script src= '' services/code_evaluators/PythonCodeRunnerService.js '' > < /script > + < script src= '' services/code_evaluators/PythonPrereqCheckService.js '' > < /script > < script src= '' services/code_preprocessors/CodePreprocessorDispatcherService.js '' > < /script > < script src= '' services/code_preprocessors/PythonCodePreprocessorService.js '' > < /script > < /head > diff -- git a/client/app.js b/client/app.js index 6b870ce..fab1f73 100644 -- - a/client/app.js +++ b/client/app.js @ @ -33,6 +33,8 @ @
diff -- git a/assets/questions/increment.js b/assets/questions/increment.js new file mode 100644 index 0000000..6ab74b5 -- - /dev/null +++ b/assets/questions/increment.js @ @ -0,0 +1,115 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . +// See the License for the specific language governing permissions and +// limitations under the License . + +/** + * @ fileoverview Question data for Reverse Words . + */ + +globalData.questions [ 'increment ' ] = { // eslint-disable-line dot-notation + title : 'Increment a decimal-coded number ' , + starterCode : { + python : + ` def increment ( s ) : + return '0' + ` + } , + auxiliaryCode : { +
diff -- git a/client/components/LearnerViewDirective.js b/client/components/LearnerViewDirective.js index 864def2..54a1e29 100644 -- - a/client/components/LearnerViewDirective.js +++ b/client/components/LearnerViewDirective.js @ @ -52,17 +52,17 @ @ tie.directive ( 'learnerView ' , [ function ( ) { < /span > < /p > < /div > - < div class= '' tie-feedback-syntax-error '' > - < a href class= '' tie-feedback-syntax-error-link '' , - ng-click= '' toggleSyntaxErrorHint ( ) '' , - ng-show= '' syntaxErrorFound '' > - { { isSyntaxErrorShown ? 'Hide error details ' : 'Display error details ' } } - < /a > - < /div > + + < a href class= '' tie-feedback-syntax-error-link '' ng-if= '' syntaxErrorString '' + ng-click= '' toggleSyntaxErrorHint ( ) '' > + { { isSyntaxErrorShown ? 'Hide error details ' : 'Display error details ' } } + < /a > < br > - < span class = `` tie-feedback-error-string '' , ng-show= '' isSyntaxErrorShown '' > + < span class= '' tie-feedback-syntax-error-string '' ng-if= '' syntaxErrorString '' + ng-show= '' isSyntaxErrorShown '' > { { syntaxErrorString } } < /span > + < div class= '' tie-dot-container '' ng-if= '' loadingIndicatorIsShown '' > < div class= '' tie-dot tie-dot-1 '' ng-class= '' { 'night-mode '
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index f4d017c..8abe266 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -59,6 +59,10 @ @ tie.directive ( 'learnerView ' , [ function ( ) { on-state-change= '' scrollToBottomOfFeedbackWindow ( ) '' > < /syntax-error-snippet > < /span > + < span ng-if= '' paragraph.isOutputParagraph ( ) '' > + < output-snippet content= '' paragraph.getContent ( ) '' > + < /output-snippet > + < /span > < /p > < /div > < div class= '' tie-reinforcement '' > diff -- git a/client/question/domain/FeedbackObjectFactory.js b/client/question/domain/FeedbackObjectFactory.js index cd13516..72cea92 100644 -- - a/client/question/domain/FeedbackObjectFactory.js +++ b/client/question/domain/FeedbackObjectFactory.js @ @ -139,6 +139,17 @ @ tie.factory ( 'FeedbackObjectFactory ' , [ } ; /** + * Appends a FeedbackParagraph of type output to the _paragraphs + * Array + * + * @ param { string } text String of code to be inserted as code output + */ + Feedback.prototype.appendOutputParagraph = function ( text ) { + this._paragraphs.push ( + FeedbackParagraphObjectFactory.createOutputParagraph ( text ) ) ; + } ; + + /** * Clears all FeedbackParagraph objects from the _paragraphs property . */ Feedback.prototype.clear = function ( ) { diff -- git a/client/question/domain/FeedbackParagraphObjectFactory.js b/client/question/domain/FeedbackParagraphObjectFactory.js index 14b1136..79392d0 100644 -- - a/client/question/domain/FeedbackParagraphObjectFactory.js +++ b/client/question/domain/FeedbackParagraphObjectFactory.js
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index f4d017c..8abe266 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -59,6 +59,10 @ @ tie.directive ( 'learnerView ' , [ function ( ) { on-state-change= '' scrollToBottomOfFeedbackWindow ( ) '' > < /syntax-error-snippet > < /span > + < span ng-if= '' paragraph.isOutputParagraph ( ) '' > + < output-snippet content= '' paragraph.getContent ( ) '' > + < /output-snippet > + < /span > < /p > < /div > < div class= '' tie-reinforcement '' > diff -- git a/client/question/components/OutputSnippetDirective.js b/client/question/components/OutputSnippetDirective.js new file mode 100755 index 0000000..1f00fb5 -- - /dev/null +++ b/client/question/components/OutputSnippetDirective.js @ @ -0,0 +1,108 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index f4d017c..8abe266 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -59,6 +59,10 @ @ tie.directive ( 'learnerView ' , [ function ( ) { on-state-change= '' scrollToBottomOfFeedbackWindow ( ) '' > < /syntax-error-snippet > < /span > + < span ng-if= '' paragraph.isOutputParagraph ( ) '' > + < output-snippet content= '' paragraph.getContent ( ) '' > + < /output-snippet > + < /span > < /p > < /div > < div class= '' tie-reinforcement '' > diff -- git a/client/question/components/OutputSnippetDirective.js b/client/question/components/OutputSnippetDirective.js new file mode 100755 index 0000000..1f00fb5 -- - /dev/null +++ b/client/question/components/OutputSnippetDirective.js @ @ -0,0 +1,108 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index f4d017c..8abe266 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -59,6 +59,10 @ @ tie.directive ( 'learnerView ' , [ function ( ) { on-state-change= '' scrollToBottomOfFeedbackWindow ( ) '' > < /syntax-error-snippet > < /span > + < span ng-if= '' paragraph.isOutputParagraph ( ) '' > + < output-snippet content= '' paragraph.getContent ( ) '' > + < /output-snippet > + < /span > < /p > < /div > < div class= '' tie-reinforcement '' > diff -- git a/client/question/components/OutputSnippetDirective.js b/client/question/components/OutputSnippetDirective.js new file mode 100755 index 0000000..ac3f4a3 -- - /dev/null +++ b/client/question/components/OutputSnippetDirective.js @ @ -0,0 +1,108 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index f4d017c..8abe266 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -59,6 +59,10 @ @ tie.directive ( 'learnerView ' , [ function ( ) { on-state-change= '' scrollToBottomOfFeedbackWindow ( ) '' > < /syntax-error-snippet > < /span > + < span ng-if= '' paragraph.isOutputParagraph ( ) '' > + < output-snippet content= '' paragraph.getContent ( ) '' > + < /output-snippet > + < /span > < /p > < /div > < div class= '' tie-reinforcement '' > diff -- git a/client/question/components/OutputSnippetDirective.js b/client/question/components/OutputSnippetDirective.js new file mode 100755 index 0000000..ac3f4a3 -- - /dev/null +++ b/client/question/components/OutputSnippetDirective.js @ @ -0,0 +1,108 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either
diff -- git a/client/question/components/LearnerViewDirective.js b/client/question/components/LearnerViewDirective.js index f4d017c..8abe266 100644 -- - a/client/question/components/LearnerViewDirective.js +++ b/client/question/components/LearnerViewDirective.js @ @ -59,6 +59,10 @ @ tie.directive ( 'learnerView ' , [ function ( ) { on-state-change= '' scrollToBottomOfFeedbackWindow ( ) '' > < /syntax-error-snippet > < /span > + < span ng-if= '' paragraph.isOutputParagraph ( ) '' > + < output-snippet content= '' paragraph.getContent ( ) '' > + < /output-snippet > + < /span > < /p > < /div > < div class= '' tie-reinforcement '' > diff -- git a/client/question/components/OutputSnippetDirective.js b/client/question/components/OutputSnippetDirective.js new file mode 100755 index 0000000..ac3f4a3 -- - /dev/null +++ b/client/question/components/OutputSnippetDirective.js @ @ -0,0 +1,108 @ @ +// Copyright 2017 The TIE Authors . All Rights Reserved . +// +// Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; +// you may not use this file except in compliance with the License . +// You may obtain a copy of the License at +// +// http : //www.apache.org/licenses/LICENSE-2.0 +// +// Unless required by applicable law or agreed to in writing , software +// distributed under the License is distributed on an `` AS-IS '' BASIS , +// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either
