diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/parse/Options.java b/lib/android/app/src/main/java/com/reactnativenavigation/parse/Options.java index d5c8546..c576f7a 100644 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/parse/Options.java +++ b/lib/android/app/src/main/java/com/reactnativenavigation/parse/Options.java @ @ -4,8 +4,11 @ @ import android.support.annotation.CheckResult ; import android.support.annotation.NonNull ; import com.reactnativenavigation.parse.params.Bool ; +import com.reactnativenavigation.parse.params.Color ; import com.reactnativenavigation.parse.params.NullBool ; +import com.reactnativenavigation.parse.params.NullColor ; import com.reactnativenavigation.parse.parsers.BoolParser ; +import com.reactnativenavigation.parse.parsers.ColorParser ; import com.reactnativenavigation.utils.TypefaceLoader ; import org.json.JSONObject ; @ @ -33,6 +36,7 @ @ public class Options { result.sideMenuRootOptions = SideMenuRootOptions.parse ( json.optJSONObject ( `` sideMenu '' ) ) ; result.animationsOptions = AnimationsOptions.parse ( json.optJSONObject ( `` animations '' ) ) ; result.animated = BoolParser.parse ( json , `` animated '' ) ; + result.screenBackgroundColor = ColorParser.parse ( json , `` screenBackgroundColor '' ) ; return result.withDefaultOptions ( defaultOptions ) ; } @ @ -48,6 +52,7 @ @ public class Options { @ NonNull public AnimationsOptions animationsOptions = new AnimationsOptions ( ) ; @ NonNull public SideMenuRootOptions sideMenuRootOptions = new SideMenuRootOptions ( ) ; @ NonNull public Bool animated = new NullBool ( ) ; + @ NonNull public Color screenBackgroundColor = new NullColor ( ) ; void setTopTabIndex ( int i ) { topTabOptions.tabIndex = i ; @ @ -67,6 +72,7 @ @ public class Options { result.sideMenuRootOptions.mergeWith ( sideMenuRootOptions ) ; result.animationsOptions.mergeWith ( animationsOptions ) ; result.animated [ Android ] [ V2 ] screenBackgroundColor is not implemented __EoT__ # # # Issue Description Using `` screenBackgroundColor '' in a Modal does n't change the color of the screen on Android , it does on iOS # # # Steps to Reproduce / Code Snippets / Screenshots Add the following to a Modal screen `` ` screenBackgroundColor : `` # 32CD32 '' , topBar : { // ... } `` ` This is my proposed implementation : https : //github.com/wix/react-native-navigation/pull/3006 -- - # # # Environment * React Native Navigation version : V2 * React Native version :0.53.3 * Platform ( s ) ( iOS , Android , or both ? ) : Android * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : Emulator
diff -- git a/ios/RCCViewController.m b/ios/RCCViewController.m index 1ada92d..20a116e 100755 -- - a/ios/RCCViewController.m +++ b/ios/RCCViewController.m @ @ -585,12 +585,11 @ @ const NSInteger TRANSPARENT_NAVBAR_TAG = 78264803 ; //Bug fix : in case there is a interactivePopGestureRecognizer , it prevents react-native from getting touch events on the left screen area that the gesture handles //overriding the delegate of the gesture prevents this from happening while keeping the gesture intact ( another option was to disable it completely by demand ) - self.originalInteractivePopGestureDelegate = nil ; if ( self.navigationController.viewControllers.count > 1 ) { if ( self.navigationController ! = nil & & self.navigationController.interactivePopGestureRecognizer ! = nil ) { id < UIGestureRecognizerDelegate > interactivePopGestureRecognizer = self.navigationController.interactivePopGestureRecognizer.delegate ; - if ( interactivePopGestureRecognizer ! = nil ) + if ( interactivePopGestureRecognizer ! = nil & & interactivePopGestureRecognizer ! = self ) { self.originalInteractivePopGestureDelegate = interactivePopGestureRecognizer ; self.navigationController.interactivePopGestureRecognizer.delegate = self ; IOS back gesture not working __EoT__ After i updated RNN to 2.0.0-experimental.256 , swipe gesture to pop screen on IOS is not working anymore . I tried to add `` disabledBackGesture : false , '' ( wich should be default to false anyway ) but no luck . Any suggestion ? -- - # # # Environment * React Native Navigation version : 2.0.0-experimental.256 * React Native version : 0.43.0-rc.4 * Platform : IOS ( both simulator/device and debug/release )
diff -- git a/README.md b/README.md index a7e8387..01647a8 100644 -- - a/README.md +++ b/README.md @ @ -66,10 +66,10 @ @ v2 is written in Test Driven Development . We have a test for every feature inclu | showModal | ✅ | ✅| | dismissModal | ✅ | ✅| | showOverlay | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | WIP @ cool04ek | -| dismissOverlay | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | +| dismissOverlay | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | WIP @ cool04ek | | customTransition | ✅ | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | | Screen Visibility | ✅ |✅| -| async commands ( await push ) | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | +| async commands ( await push ) | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | WIP @ cool04ek | # # # Navigation Options diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/parse/LayoutFactory.java b/lib/android/app/src/main/java/com/reactnativenavigation/parse/LayoutFactory.java index 6ab71ff..15c3734 100644 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/parse/LayoutFactory.java +++ b/lib/android/app/src/main/java/com/reactnativenavigation/parse/LayoutFactory.java @ @ -89,7 +89,7 @ @ public class LayoutFactory { private ViewController createContainerStack ( LayoutNode node ) { StackController stackController = new StackController ( activity , node.id ) ; for ( all commands return promise __EoT__
diff -- git a/android/app/src/main/java/com/reactnativenavigation/react/ResourceDrawableUriHelper.java b/android/app/src/main/java/com/reactnativenavigation/react/ResourceDrawableUriHelper.java new file mode 100644 index 0000000..3ce381b -- - /dev/null +++ b/android/app/src/main/java/com/reactnativenavigation/react/ResourceDrawableUriHelper.java @ @ -0,0 +1,26 @ @ +package com.reactnativenavigation.react ; // Copyright 2004-present Facebook . All Rights Reserved . + +import android.net.Uri ; + +import com.reactnativenavigation.NavigationApplication ; + +/** + * Taken from com.facebook.react.views.imagehelper.ImageSource + * Can be deleted in react-native ^0.29 + */ + +public class ResourceDrawableUriHelper { + public static Uri computeUri ( String mSource ) { + try { + Uri uri = Uri.parse ( mSource ) ; + // Verify scheme is set , so that relative uri ( used by static resources ) are not handled . + return uri.getScheme ( ) == null ? computeLocalUri ( mSource ) : uri ; + } catch ( Exception e ) { + return computeLocalUri ( mSource ) ; + } + } + + private static Uri computeLocalUri ( String mSource ) { + return ResourceDrawableIdHelper.instance.getResourceDrawableUri ( NavigationApplication.instance , mSource ) ; + } + } diff -- git a/android/app/src/main/java/com/reactnativenavigation/views/collapsingToolbar/CollapsingTopBarBackground.java b/android/app/src/main/java/com/reactnativenavigation/views/collapsingToolbar/CollapsingTopBarBackground.java index 89abf3a..e936901 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/views/collapsingToolbar/CollapsingTopBarBackground.java +++ b/android/app/src/main/java/com/reactnativenavigation/views/collapsingToolbar/CollapsingTopBarBackground.java @ @ -6,6 +6,7 @ @ import android.widget.ImageView ; import com.facebook.drawee.view.SimpleDraweeView ; import com.reactnativenavigation.params.CollapsingTopBarParams ; +import com.reactnativenavigation.react.ResourceDrawableUriHelper ; import com.reactnativenavigation.utils.ViewUtils ; import Bug loading collapsingToolBarImage from local resource in android release mode __EoT__ < ! -- Please post questions in Stack Overflow under the react-native-navigation tag https : //stackoverflow.com/questions/tagged/react-native-navigation -- > # # # Issue Description collapsingToolBarImage does n't work in Android release mode for local resources . PR for fix at # 2626 # # # Steps to Reproduce / Code Snippets / Screenshots # # # # Steps to reproduce In order to reproduce it , just compile https : //github.com/wix/react-native-navigation/tree/master/example in android in release mode , and go to the collapsable tab bar example . # # # # Code snippet `` ` static navigatorStyle = { drawUnderTabBar : true , navBarButtonColor : ' # ffffff ' , navBarTextColor : ' # ffffff ' , collapsingToolBarImage : require ( '../../../img/gyro_header.jpg ' ) , collapsingToolBarCollapsedColor : ' # 0f2362 ' , navBarBackgroundColor : ' # eeeeee' } ; `` ` -- - # # # # Screenshots *Before fix* ! [ Before fix ] ( https : //i.imgur.com/YYnzgBR.png ) *After fix* ! [ After fix ] ( https : //i.imgur.com/zgXRQXN.png ) # # # Environment * React Native Navigation version : 1.1.365 * React Native version : 0.51.0 * Platform
diff -- git a/android/app/src/main/AndroidManifest.xml b/android/app/src/main/AndroidManifest.xml index 4a8f6dc..a50effc 100644 -- - a/android/app/src/main/AndroidManifest.xml +++ b/android/app/src/main/AndroidManifest.xml @ @ -2,11 +2,14 @ @ package= '' com.reactnativenavigation '' > < application > - < activity android : name= '' com.reactnativenavigation.activities.TabActivity '' / > + < activity android : name= '' com.reactnativenavigation.activities.TabActivity '' + android : configChanges= '' keyboardHidden|orientation|screenSize '' / > < activity android : name= '' com.reactnativenavigation.activities.BottomTabActivity '' - android : label= '' '' / > + android : label= '' '' + android : configChanges= '' keyboardHidden|orientation|screenSize '' / > < activity android : name= '' com.reactnativenavigation.activities.SingleScreenActivity '' - android : label= '' '' / > + android : label= '' '' + android : configChanges= '' keyboardHidden|orientation|screenSize '' / > < /application > < /manifest > diff -- git a/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java b/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java index 51a0d2a..1b1d284 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java +++ b/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java @ @ -226,7 +226,6 @ @ public abstract class BaseReactActivity extends AppCompatActivity implements Def } } - @ CallSuper public void push ( Screen screen ) { StyleHelper.updateStyles ( mToolbar , screen ) ; if ( mToolbar ! = null ) { @ @ -239,7 +238,6 @ @ public abstract class BaseReactActivity extends AppCompatActivity implements Def } } - @ CallSuper public Screen Support orientation changes __EoT__ Fixing crashes on device rotation . # 97
diff -- git a/lib/ios/RNNCommandsHandler.m b/lib/ios/RNNCommandsHandler.m index f6036d6..f35022e 100644 -- - a/lib/ios/RNNCommandsHandler.m +++ b/lib/ios/RNNCommandsHandler.m @ @ -5,11 +5,14 @ @ # import `` RNNNavigationOptions.h '' # import `` RNNRootViewController.h '' # import `` RNNSplitViewController.h '' + # import `` RNNElementFinder.h '' # import `` React/RCTUIManager.h '' + static NSString* const setRoot = @ '' setRoot '' ; static NSString* const setStackRoot = @ '' setStackRoot '' ; static NSString* const push = @ '' push '' ; +static NSString* const preview = @ '' preview '' ; static NSString* const pop = @ '' pop '' ; static NSString* const popTo = @ '' popTo '' ; static NSString* const popToRoot = @ '' popToRoot '' ; @ @ -93,11 +96,32 @ @ static NSString* const setDefaultOptions = @ '' setDefaultOptions '' ; - ( void ) push : ( NSString* ) componentId layout : ( NSDictionary* ) layout completion : ( RNNTransitionCompletionBlock ) completion rejection : ( RCTPromiseRejectBlock ) rejection { [ self assertReady ] ; - [ _eventEmitter sendOnNavigationCommand : push params : @ { @ '' componentId '' : componentId } ] ; - UIViewController < RNNRootViewProtocol > *newVc = [ _controllerFactory createLayoutAndSaveToStore : layout ] ; - [ v2 ] 3D Touch Peek/Pop Support __EoT__ Is this planned for v2 as well ?
diff -- git a/docs/README.md b/docs/README.md index 9fc9f20..b8527bc 100644 -- - a/docs/README.md +++ b/docs/README.md @ @ -61,7 +61,7 @ @ v2 is written in Test Driven Development . We have a test for every feature inclu | sideMenu | ✅ | ✅ | | tabs | ✅ | ✅ | | External Component | ✅ | ✅ | -| splitView | [ Contribute ] ( /docs/WorkingLocally.md ) | [ Contribute ] ( /docs/WorkingLocally.md ) | +| splitView | ✅ | [ Contribute ] ( /docs/WorkingLocally.md ) | # # # Screen API @ @ -79,6 +79,7 @ @ v2 is written in Test Driven Development . We have a test for every feature inclu | customTransition |✅|✅| | Screen Visibility | ✅ |✅| | async commands ( await push ) | ✅ |✅ | +| preview | ✅ | : x : | # # # Navigation Options @ @ -212,4 +213,4 @ @ Note : v1 properties with names beginning with 'navBar ' are replaced in v2 with | switchToTab | ✅ | ✅ |✅| | topBar react component | ✅ |✅|✅| |Shared Element Transition| : x : |✅| [ Contribute ] ( /docs/WorkingLocally.md ) | -| splitViewScreen | : [ v2 ] 3D Touch Peek/Pop Support __EoT__ Is this planned for v2 as well ?
diff -- git a/lib/ios/RNNBackButtonOptions.m b/lib/ios/RNNBackButtonOptions.m index 1d805ad..63722d2 100644 -- - a/lib/ios/RNNBackButtonOptions.m +++ b/lib/ios/RNNBackButtonOptions.m @ @ -4,25 +4,29 @ @ @ implementation RNNBackButtonOptions - ( void ) applyOn : ( UIViewController * ) viewController { - if ( self.showTitle & & ! [ self.showTitle boolValue ] ) { - self.title = @ '' '' ; - } - + UIBarButtonItem *backItem = [ [ UIBarButtonItem alloc ] init ] ; + if ( self.icon ) { UIImage *image = self.tintedIcon ; [ viewController.navigationController.navigationBar setBackIndicatorImage : [ UIImage new ] ] ; [ viewController.navigationController.navigationBar setBackIndicatorTransitionMaskImage : [ UIImage new ] ] ; - UIBarButtonItem *backItem = [ [ UIBarButtonItem alloc ] initWithImage : image style : UIBarButtonItemStylePlain target : nil action : nil ] ; - [ self setBackItem : backItem onViewController : viewController ] ; - } else if ( self.title ) { - UIBarButtonItem *backItem = [ [ UIBarButtonItem alloc ] initWithTitle : self.title - style : UIBarButtonItemStylePlain - target : nil - action : nil ] ; - - [ self setBackItem : backItem onViewController : viewController ] ; + backItem.image = image ; + } + + if ( self.color ) { + [ backItem setTintColor : [ [ V2 ] [ iOS ] topBar.backButton.color broken after 2.0.2583 or 2.0.2584 __EoT__ # # # Issue Description topBar.backButton.color on iOS ( PR # 3999 ) is n't working after 2.0.2583 or 2.0.2584 . Ca n't confirm the exact version , since 2.0.2583 does not work for me . EDIT : I was previously saying that the fix for # 4079 was causing this , but it may not be the case as I 'm experiencing the issue even on 2.0.2584 -- - # # # Environment * React Native Navigation version : 0.56 * React Native version : 2.0.2586 * Platform ( s ) ( iOS , Android , or both ? ) : iOS
diff -- git a/lib/ios/Bool.h b/lib/ios/Bool.h new file mode 100644 index 0000000..569f975 -- - /dev/null +++ b/lib/ios/Bool.h @ @ -0,0 +1,11 @ @ + # import `` Param.h '' + + @ interface Bool : Param + +- ( BOOL ) get ; + +- ( NSNumber * ) getValue ; + +- ( BOOL ) getWithDefaultValue : ( BOOL ) value ; + + @ end diff -- git a/lib/ios/Bool.m b/lib/ios/Bool.m new file mode 100644 index 0000000..6187469 -- - /dev/null +++ b/lib/ios/Bool.m @ @ -0,0 +1,27 @ @ + # import `` Bool.h '' + + @ interface Bool ( ) + + @ property ( nonatomic , retain ) NSNumber* value ; + + @ end + + @ implementation Bool + +- ( BOOL ) get { + return [ self.value boolValue ] ; + } + +- ( NSNumber * ) getValue { + return self.value ; + } + +- ( BOOL ) getWithDefaultValue : ( BOOL ) defaultValue { + if ( self.value ) { + return [ self.value boolValue ] ; + } else { + return defaultValue ; + } + } + + @ end diff -- git a/lib/ios/BoolParser.h b/lib/ios/BoolParser.h new file [ V2 ] sideMenu options not available/do n't work __EoT__ https : //github.com/wix/react-native-navigation/pull/4105 broke a few ` sideMenu ` options . It looks like ` shouldStretchDrawer ` and ` animationVelocity ` have been elevated to ` sideMenuOptions ` ( both left and right get the same value ) , not ` sideMenuSideOptions ` ( left or right controlled ) . Is this the new method for settings these ? ` animationType ` is available but does not seem wired in . -- - # # # Environment * React Native Navigation version : 2.0.2583 * React Native version : 0.57.3 * Platform ( s ) ( iOS , Android , or both ? ) : iOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : All
diff -- git a/.gitignore b/.gitignore index 9d27656..37f13b2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -210,5 +210,20 @ @ npm-debug.log # BUCK buck-out/ \.buckd/ + + # IDE files android/app/libs android/keystores/debug.keystore +AndroidE2E/.project +AndroidE2E/app/.project +lib/android/.project +playground/android/.project +AndroidE2E/app/.classpath +AndroidE2E/app/.settings/ +AndroidE2E/app/bin/ +lib/android/.settings/ +lib/android/app/.settings/ +playground/android/.settings/ +playground/android/app/.settings/ +AndroidE2E/.settings/ + diff -- git a/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/OverlayTest.java b/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/OverlayTest.java index 5072262..627470f 100644 -- - a/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/OverlayTest.java +++ b/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/OverlayTest.java @ @ -12,9 +12,8 @ @ public class OverlayTest extends BaseTest { public void testOverlayAlertAppear ( ) throws Exception { elementByText ( `` PUSH OPTIONS SCREEN '' ) .click ( ) ; elementByText ( `` SHOW ALERT '' ) .click ( ) ; - assertExists ( By.text ( `` test ! `` ) ) ; + assertExists ( By.text ( `` Test view '' ) ) ; elementByText ( `` OK '' ) .click ( ) ; assertExists ( By.text ( `` Static Title '' ) ) ; - } } diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/parse/ButtonOptions.java b/lib/android/app/src/main/java/com/reactnativenavigation/parse/ButtonOptions.java new file mode 100644 index 0000000..6844374 -- - /dev/null +++ b/lib/android/app/src/main/java/com/reactnativenavigation/parse/ButtonOptions.java @ @ -0,0 +1,35 @ @ +package com.reactnativenavigation.parse ; + + +import org.json.JSONObject ; + +public class ButtonOptions { + + public static ButtonOptions parse ( JSONObject json ) { + ButtonOptions options = new ButtonOptions showOverlay __EoT__
diff -- git a/lib/ios/RNNNavigationOptions.m b/lib/ios/RNNNavigationOptions.m index db03bfc..2f54f4f 100644 -- - a/lib/ios/RNNNavigationOptions.m +++ b/lib/ios/RNNNavigationOptions.m @ @ -44,7 +44,7 @ @ const NSInteger TOP_BAR_TRANSPARENT_TAG = 78264803 ; - ( void ) applyOn : ( UIViewController* ) viewController { if ( self.topBar ) { - if ( self.topBar.backgroundColor ) { + if ( self.topBar.backgroundColor ) { UIColor* backgroundColor = [ RCTConvert UIColor : self.topBar.backgroundColor ] ; viewController.navigationController.navigationBar.barTintColor = backgroundColor ; } else { @ @ -165,6 +165,10 @ @ const NSInteger TOP_BAR_TRANSPARENT_TAG = 78264803 ; .shadowImage = nil ; } } + + if ( self.topBar.testID ) { + viewController.navigationController.navigationBar.accessibilityIdentifier = self.topBar.testID ; + } } if ( self.popGesture ) { @ @ -191,6 +195,10 @ @ const NSInteger TOP_BAR_TRANSPARENT_TAG = 78264803 ; if ( self.bottomTabs.hidden ) { [ ( ( RNNTabBarController * ) viewController.tabBarController ) setTabBarHidden : [ self.bottomTabs.hidden boolValue ] animated : [ self.bottomTabs.animateHide boolValue ] ] ; } + + if ( self.bottomTabs.testID ) { + viewController.tabBarController.tabBar.accessibilityIdentifier = self.bottomTabs.testID ; + } } if ( self.statusBarBlur ) { diff -- git a/lib/ios/RNNTabBarOptions.h b/lib/ios/RNNTabBarOptions.h index a2dfb4a..9009720 100644 -- - a/lib/ios/RNNTabBarOptions.h +++ b/lib/ios/RNNTabBarOptions.h @ @ -8,6 +8,7 @ @ extern const NSInteger BLUR_TOPBAR_TAG ; @ property ( nonatomic , strong ) NSNumber* support testId on navigation elements __EoT__ see https : //github.com/wix/detox/issues/12 # issuecomment-291499294
diff -- git a/lib/android/app/build.gradle b/lib/android/app/build.gradle index 417a34d..85b6f09 100644 -- - a/lib/android/app/build.gradle +++ b/lib/android/app/build.gradle @ @ -57,6 +57,9 @ @ android { reactNative56 { dimension `` RNN.reactNativeVersion '' } + reactNative57 { + dimension `` RNN.reactNativeVersion '' + } } } diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java b/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java deleted file mode 100644 index 02cd1dc..0000000 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java +++ /dev/null @ @ -1,108 +0,0 @ @ -package com.reactnativenavigation.react ; - -import android.app.Application ; -import android.support.annotation.NonNull ; -import android.support.annotation.Nullable ; - -import com.facebook.infer.annotation.Assertions ; -import com.facebook.react.ReactInstanceManager ; -import com.facebook.react.ReactInstanceManagerBuilder ; -import com.facebook.react.ReactNativeHost ; -import com.facebook.react.ReactPackage ; -import com.facebook.react.common.LifecycleState ; -import com.facebook.react.devsupport.interfaces.DevBundleDownloadListener ; -import com.facebook.react.shell.MainReactPackage ; -import com.reactnativenavigation.NavigationApplication ; - -import java.util.ArrayList ; -import java.util.List ; - -/** - * Default implementation of { @ link ReactNativeHost } that includes { @ link NavigationPackage } - * and user-defined additional packages . - */ -public class NavigationReactNativeHost extends ReactNativeHost implements BundleDownloadListenerProvider { - - private final boolean isDebug ; - private final List < ReactPackage > additionalReactPackages ; - private @ Nullable NavigationDevBundleDownloadListener bundleListener ; - private final DevBundleDownloadListener bundleListenerMediator = new DevBundleDownloadListenerAdapter ( ) { - @ Override - public void onSuccess ( ) { - if ( bundleListener ! = null ) { - [ V2 ] Hide bottomTabs on Android breaks with ScrollView __EoT__ # # # Issue Description I 've got a bottomTabs navigation and I navigate to a screen with ` ScrollView ` where I want to hide those . Based on the documentation , I am hiding them when pushing the new screen as such : `` ` Navigation.push ( this.props.componentId , { component : { name : 'example.Example2 ' , options : { topBar : { title : { text : 'Example screen' } } , bottomTabs : { visible : false , } } } } ) ; `` ` The bottomTabs seem to hide , but the content sizes are not re-calculated to fit the dimensions ( ? ! ) so it leaves nasty empty space the size of the bottomTabs after it . # # # Steps to Reproduce / Code Snippets / Screenshots Apply bottomTabs navigation and try to navigate to a screen where you hide those tabs on Android . ! [ bottomtabs android ] ( https : //user-images.githubusercontent.com/6010279/46335687-ef47f380-c630-11e8-9e97-dd1fdbecc400.gif ) -- - # # # Environment * React Native Navigation version : 2.0.2569 ( Using ` https : //github.com/abdullah-sr/react-native-navigation # build ` based on
diff -- git a/lib/android/app/build.gradle b/lib/android/app/build.gradle index 417a34d..85b6f09 100644 -- - a/lib/android/app/build.gradle +++ b/lib/android/app/build.gradle @ @ -57,6 +57,9 @ @ android { reactNative56 { dimension `` RNN.reactNativeVersion '' } + reactNative57 { + dimension `` RNN.reactNativeVersion '' + } } } diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java b/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java deleted file mode 100644 index 02cd1dc..0000000 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java +++ /dev/null @ @ -1,108 +0,0 @ @ -package com.reactnativenavigation.react ; - -import android.app.Application ; -import android.support.annotation.NonNull ; -import android.support.annotation.Nullable ; - -import com.facebook.infer.annotation.Assertions ; -import com.facebook.react.ReactInstanceManager ; -import com.facebook.react.ReactInstanceManagerBuilder ; -import com.facebook.react.ReactNativeHost ; -import com.facebook.react.ReactPackage ; -import com.facebook.react.common.LifecycleState ; -import com.facebook.react.devsupport.interfaces.DevBundleDownloadListener ; -import com.facebook.react.shell.MainReactPackage ; -import com.reactnativenavigation.NavigationApplication ; - -import java.util.ArrayList ; -import java.util.List ; - -/** - * Default implementation of { @ link ReactNativeHost } that includes { @ link NavigationPackage } - * and user-defined additional packages . - */ -public class NavigationReactNativeHost extends ReactNativeHost implements BundleDownloadListenerProvider { - - private final boolean isDebug ; - private final List < ReactPackage > additionalReactPackages ; - private @ Nullable NavigationDevBundleDownloadListener bundleListener ; - private final DevBundleDownloadListener bundleListenerMediator = new DevBundleDownloadListenerAdapter ( ) { - @ Override - public void onSuccess ( ) { - if ( bundleListener ! = null ) { - [ V2 ] Hide bottomTabs on Android breaks with ScrollView __EoT__ # # # Issue Description I 've got a bottomTabs navigation and I navigate to a screen with ` ScrollView ` where I want to hide those . Based on the documentation , I am hiding them when pushing the new screen as such : `` ` Navigation.push ( this.props.componentId , { component : { name : 'example.Example2 ' , options : { topBar : { title : { text : 'Example screen' } } , bottomTabs : { visible : false , } } } } ) ; `` ` The bottomTabs seem to hide , but the content sizes are not re-calculated to fit the dimensions ( ? ! ) so it leaves nasty empty space the size of the bottomTabs after it . # # # Steps to Reproduce / Code Snippets / Screenshots Apply bottomTabs navigation and try to navigate to a screen where you hide those tabs on Android . ! [ bottomtabs android ] ( https : //user-images.githubusercontent.com/6010279/46335687-ef47f380-c630-11e8-9e97-dd1fdbecc400.gif ) -- - # # # Environment * React Native Navigation version : 2.0.2569 ( Using ` https : //github.com/abdullah-sr/react-native-navigation # build ` based on
diff -- git a/src/deprecated/platformSpecificDeprecated.android.js b/src/deprecated/platformSpecificDeprecated.android.js index 69fe30f..2703c7d 100644 -- - a/src/deprecated/platformSpecificDeprecated.android.js +++ b/src/deprecated/platformSpecificDeprecated.android.js @ @ -593,7 +593,7 @ @ function addNavigationStyleParams ( screen ) { screen.navigatorStyle = Object.assign ( { } , Screen.navigatorStyle , screen.navigatorStyle ) ; } -function showSnackbar ( params ) { +function showSnackbar ( navigator , params ) { const adapted = _.cloneDeep ( params ) ; if ( adapted.backgroundColor ) { adapted.backgroundColor = processColor ( adapted.backgroundColor ) ; Android findings/bugs __EoT__ Hello , I 've collated a list of bugs/issues I 've encountered ( will continue to update ) as I 've been using this lib . Been chatting to @ guyca on Discord about some of these - nothing huge or breaking apart from the first one , more of a snag list . - [ ] Debugger does n't work correctly ( https : //github.com/wix/react-native-navigation/issues/963 ) . - [ ] Right button text ripple effect is a circle over the center of the text ( [ gif ] ( https : //giphy.com/gifs/3og0ICVARae0zaxyWQ ) ) - [ x ] Using multiple FAB actions causes cut off ( [ image ] ( https : //cloud.githubusercontent.com/assets/842078/25268868/3a302274-2672-11e7-975c-ece98f81d5b6.png ) ) ( https : //github.com/wix/react-native-navigation/commit/c3c4a044a65ae807f04b212f3fc05472dfd9774a ) - [ x ] Calling ` showSnackbar ` from Screen API ( this.props ) shows text as ` null ` ( # 989 ) - [ ] Snackbar is not documented - [ ] ` collapsingToolBarExpendedColor ` : `` expended '' should be `` expanded '' ( few cases of this misspelt word ) - [ ] Calling ` toggleTabs ` to hide the tabs does n't increase view height , so you 're left with
diff -- git a/package.json b/package.json index b504f50..f0fa5f2 100644 -- - a/package.json +++ b/package.json @ @ -1,6 +1,6 @ @ { `` name '' : `` react-native-navigation '' , - `` version '' : `` 1.1.406 '' , + `` version '' : `` 1.1.407 '' , `` description '' : `` React Native Navigation - truly native navigation for iOS and Android '' , `` license '' : `` MIT '' , `` nativePackage '' : true , diff -- git a/src/deprecated/platformSpecificDeprecated.android.js b/src/deprecated/platformSpecificDeprecated.android.js index 9d2192d..7021262 100644 -- - a/src/deprecated/platformSpecificDeprecated.android.js +++ b/src/deprecated/platformSpecificDeprecated.android.js @ @ -592,23 +592,28 @ @ function addNavigatorButtons ( screen , sideMenuParams ) { // Get image uri from image id const rightButtons = getRightButtons ( screen ) ; + let clonedRightButtons ; if ( rightButtons ) { - rightButtons.forEach ( function ( button ) { - button.enabled = ! button.disabled ; + clonedRightButtons = rightButtons.map ( function ( button ) { + const clonedButton = { ... button } ; + + clonedButton.enabled = ! button.disabled ; if ( button.icon ) { const icon = resolveAssetSource ( button.icon ) ; if ( icon ) { - button.icon = icon.uri ; + clonedButton.icon = icon.uri ; } } if rightButtons on Android attempt to set key `` enabled '' on an immutable/frozen object __EoT__ # # # Issue Description Attempting to set ` rightButtons ` on the ` navigatorButtons ` object of the ` screen ` object within , at least , a ` startSingleScreenApp ` call on Android ( 6.0.1+ ) results in the following error : `` ` You attempted to set the key ` enabled ` with the value ` true ` on an object that is meant to be immutable and has been frozen . `` ` # # # Steps to Reproduce / Code Snippets / Screenshots `` ` js const navigatorStyle = Navigation.startSingleScreenApp ( { screen : { screen : 'com.example.MyScreen ' , navigatorStyle : { statusBarColor : ' # 831d19 ' , navigationBarColor : ' # 339999 ' , navBarBackgroundColor : ' # 339999 ' , navBarTextColor : ' # ffffff ' , navBarButtonColor : ' # ffffff ' , statusBarTextColorScheme : 'light ' , navBarHidden : false , tabBarButtonColor : 'red ' , tabBarSelectedButtonColor : 'red ' , tabBarBackgroundColor : 'red' } , navigatorButtons : { rightButtons : [ { id : 'sideMenu' } ] } } , drawer : {
diff -- git a/example/src/app.js b/example/src/app.js index 0888370..027d78a 100644 -- - a/example/src/app.js +++ b/example/src/app.js @ @ -1,29 +1,31 @ @ import { Navigation } from 'react-native-navigation ' ; -import './screens/FirstTabScreen ' ; -import './screens/SecondTabScreen ' ; -import './screens/ThirdTabScreen ' ; -import './screens/SideMenu ' ; +//import and call the default function from each module +//The default function of a module should register all the pushable screens +import register1 from './module_1 ' ; +import register2 from './module_2 ' ; +register1 ( ) ; +register2 ( ) ; Navigation.startTabBasedApp ( { tabs : [ { label : 'One ' , - screen : 'example.FirstTabScreen ' , + screen : 'module_1.FirstTabScreen ' , icon : require ( '../img/one.png ' ) , selectedIcon : require ( '../img/one_selected.png ' ) , title : 'Screen One' } , { label : 'Two ' , - screen : 'example.SecondTabScreen ' , + screen : 'module_2.SecondTabScreen ' , icon : require ( '../img/two.png ' ) , selectedIcon : require ( '../img/two_selected.png ' ) , title : 'Screen Two' } , { label : 'Three ' , - screen : 'example.ThirdTabScreen ' , + screen : 'module_2.ThirdTabScreen ' , icon : require ( '../img/three.png ' ) , selectedIcon : require ( Navigation.showModal and showLightBox crash on release when the screen has scrollView or flatlist in it . __EoT__ # # # Issue Description Navigation.showModal and showLightBox crash on release when the screen have scrollView or flatlist in it . # # # Steps to Reproduce / Code Snippets / Screenshots i use mobx and mobx-react to manage states , i do n't think it 's related . when I try to showModal this screen from a pushed screen , if I use scrollView , the app crash . it works fine in debug but crash in release , i found this error on logcat Calling JS function after bridge has been destroyed ` @ observer export default class PlaceSearch extends React.Component { render ( ) { return ( < View style= { { flex : 1 , backgroundColor : 'white ' } } > // < ScrollView style= { { flex : 1 } } > if you put this screen will crash < Text > this is a Text < /Text > < Text > this is a Text < /Text > < Text > this is a Text < /Text > < Text > this is a Text <
diff -- git a/example/src/components/Row.js b/example/src/components/Row.js index 4857870..ed7dacd 100644 -- - a/example/src/components/Row.js +++ b/example/src/components/Row.js @ @ -2,27 +2,32 @ @ import React from 'react ' ; import PropTypes from 'prop-types ' ; import { StyleSheet , View , Text , TouchableHighlight , Platform } from 'react-native ' ; -function Row ( { title , onPress , platform , testID } ) { - if ( platform & & platform ! == Platform.OS ) { - return < View / > ; - } +class Row extends React.Component { + render ( ) { + const { title , onPress , onPressIn , platform , testID } = this.props ; + if ( platform & & platform ! == Platform.OS ) { + return < View / > ; + } - return ( - < TouchableHighlight - onPress= { onPress } - testID= { testID } - underlayColor= { 'rgba ( 0 , 0 , 0 , 0.054 ) ' } - > - < View style= { styles.row } > - < Text style= { styles.text } > { title } < /Text > - < /View > - < /TouchableHighlight > - ) ; + return ( + < [ Feature request ] iOS 11 Style Navbar Titles __EoT__ # # # Issue Description Almost every iOS 11 app has this new style for navigation titles : ! [ ios11 nav title ] ( https : //user-images.githubusercontent.com/7143583/28991088-f617b5e4-7940-11e7-92ca-ca14ba6b4d5d.gif ) It would be great to support this natively with react-native-navigation since it seems to be the new UI standard for iOS . It should n't be too difficult to accomplish either because I believe iOS has a simple API to enable it : https : //developer.apple.com/documentation/uikit/uinavigationbar/2908999-preferslargetitles
diff -- git a/docs/screen-api.md b/docs/screen-api.md index c015df0..ca648ae 100644 -- - a/docs/screen-api.md +++ b/docs/screen-api.md @ @ -17,7 +17,16 @ @ this.props.navigator.push ( { backButtonTitle : undefined , // override the back button title ( optional ) backButtonHidden : false , // hide the back button altogether ( optional ) navigatorStyle : { } , // override the navigator style for the pushed screen ( optional ) - navigatorButtons : { } // override the nav buttons for the pushed screen ( optional ) + navigatorButtons : { } , // override the nav buttons for the pushed screen ( optional ) + previewView : undefined , // react ref or node id ( optional ) + previewHeight : undefined , // set preview height , defaults to full height ( optional ) + previewCommit : true , // weither to commit to push preview controller to the navigation stack ( optional ) + previewActions : [ { + id : `` , // action id ( required ) + title : `` , // action title ( required ) + style : undefined , // 'selected ' or 'destructive ' ( optional ) + actions : [ ] , // List [ Feature request ] iOS 11 Style Navbar Titles __EoT__ # # # Issue Description Almost every iOS 11 app has this new style for navigation titles : ! [ ios11 nav title ] ( https : //user-images.githubusercontent.com/7143583/28991088-f617b5e4-7940-11e7-92ca-ca14ba6b4d5d.gif ) It would be great to support this natively with react-native-navigation since it seems to be the new UI standard for iOS . It should n't be too difficult to accomplish either because I believe iOS has a simple API to enable it : https : //developer.apple.com/documentation/uikit/uinavigationbar/2908999-preferslargetitles
diff -- git a/docs/screen-api.md b/docs/screen-api.md index c015df0..f4e7ac8 100644 -- - a/docs/screen-api.md +++ b/docs/screen-api.md @ @ -17,7 +17,17 @ @ this.props.navigator.push ( { backButtonTitle : undefined , // override the back button title ( optional ) backButtonHidden : false , // hide the back button altogether ( optional ) navigatorStyle : { } , // override the navigator style for the pushed screen ( optional ) - navigatorButtons : { } // override the nav buttons for the pushed screen ( optional ) + navigatorButtons : { } , // override the nav buttons for the pushed screen ( optional ) + // enable peek and pop - commited screen will have ` isPreview ` prop set as true . + previewView : undefined , // react ref or node id ( optional ) + previewHeight : undefined , // set preview height , defaults to full height ( optional ) + previewCommit : true , // commit to push preview controller to the navigation stack ( optional ) + previewActions : [ { // action presses can be detected with the ` PreviewActionPress ` event on the commited screen . + id : `` , // action id ( required [ Feature request ] iOS 11 Style Navbar Titles __EoT__ # # # Issue Description Almost every iOS 11 app has this new style for navigation titles : ! [ ios11 nav title ] ( https : //user-images.githubusercontent.com/7143583/28991088-f617b5e4-7940-11e7-92ca-ca14ba6b4d5d.gif ) It would be great to support this natively with react-native-navigation since it seems to be the new UI standard for iOS . It should n't be too difficult to accomplish either because I believe iOS has a simple API to enable it : https : //developer.apple.com/documentation/uikit/uinavigationbar/2908999-preferslargetitles
diff -- git a/ios/RCCViewController.m b/ios/RCCViewController.m index 456db94..145be55 100755 -- - a/ios/RCCViewController.m +++ b/ios/RCCViewController.m @ @ -644,12 +644,6 @ @ const NSInteger TRANSPARENT_NAVBAR_TAG = 78264803 ; self.navigationItem.titleView.clipsToBounds = YES ; } } - - if ( [ self.navigationController.navigationBar respondsToSelector : @ selector ( setPrefersLargeTitles : ) ] ) { - NSNumber *prefersLargeTitles = self.navigatorStyle [ @ '' prefersLargeTitles '' ] ; - BOOL prefersLargeTitlesBool = prefersLargeTitles ? [ prefersLargeTitles boolValue ] : NO ; - self.navigationController.navigationBar.prefersLargeTitles = prefersLargeTitlesBool ; - } } [ Feature request ] iOS 11 Style Navbar Titles __EoT__ # # # Issue Description Almost every iOS 11 app has this new style for navigation titles : ! [ ios11 nav title ] ( https : //user-images.githubusercontent.com/7143583/28991088-f617b5e4-7940-11e7-92ca-ca14ba6b4d5d.gif ) It would be great to support this natively with react-native-navigation since it seems to be the new UI standard for iOS . It should n't be too difficult to accomplish either because I believe iOS has a simple API to enable it : https : //developer.apple.com/documentation/uikit/uinavigationbar/2908999-preferslargetitles
diff -- git a/src/Navigation.js b/src/Navigation.js index 636b197..cf64201 100644 -- - a/src/Navigation.js +++ b/src/Navigation.js @ @ -10,9 +10,9 @ @ function registerScreen ( screenID , generator ) { AppRegistry.registerComponent ( screenID , generator ) ; } -function registerComponent ( screenID , generator , store = undefined , Provider = undefined ) { +function registerComponent ( screenID , generator , store = undefined , Provider = undefined , client= undefined ) { if ( store & & Provider ) { - return _registerComponentRedux ( screenID , generator , store , Provider ) ; + return _registerComponentRedux ( screenID , generator , store , Provider , client ) ; } else { return _registerComponentNoRedux ( screenID , generator ) ; } @ @ -35,7 +35,7 @ @ function _registerComponentNoRedux ( screenID , generator ) { return generatorWrapper ; } -function _registerComponentRedux ( screenID , generator , store , Provider ) { +function _registerComponentRedux ( screenID , generator , store , Provider , client ) { const generatorWrapper = function ( ) { const InternalComponent = generator ( ) ; return class extends Screen { @ @ -43,7 +43,7 @ @ function _registerComponentRedux ( screenID , generator , store , Provider ) { static How to use with Apollo client and other-like libraries __EoT__ Apollo client and other-like libraries needs wrap root component : `` ` < ApolloProvider client= { client } > < MyRootComponent / > < /ApolloProvider > `` ` Is there a working example ?
diff -- git a/docs/screen-api.md b/docs/screen-api.md index 47645e9..fb135fe 100644 -- - a/docs/screen-api.md +++ b/docs/screen-api.md @ @ -10,6 +10,7 @ @ Push a new screen into this screen 's navigation stack . this.props.navigator.push ( { screen : 'example.ScreenThree ' , // unique ID registered with Navigation.registerScreen title : undefined , // navigation bar title of the pushed screen ( optional ) + subtitle : undefined , // navigation bar subtitle of the pushed screen ( optional ) titleImage : require ( '../../img/my_image.png ' ) , // iOS only . navigation bar title image instead of the title text of the pushed screen ( optional ) passProps : { } , // Object that will be passed as props to the pushed screen ( optional ) animated : true , // does the push have transition animation or does it happen immediately ( optional ) @ @ -369,4 +370,4 @ @ https : //developer.apple.com/library/content/documentation/UserExperience/Concept You can define actions and listen for interactions on the pushed screen with the ` PreviewActionPress ` event . -Previewed screens will have the prop ` isPreview ` that can be used to render different things when the screen is in the `` Peek '' state and will then Using largeTitle produces two titles __EoT__ # # # Issue Description I am using the newly introduced ( # 2593 ) option ` largeTitle ` to get the Large Title Bar . Now i get two titles in the title bar the big one ( correct ) the old small one ( not correct ) . # # # Steps to Reproduce / Code Snippets / Screenshots This is how i use the new option . `` ` const appStyle = { largeTitle : true } ; // this will start our app Navigation.startTabBasedApp ( { tabs : tabs , appStyle : appStyle } ) ; `` ` Here a screenshot of how it looks in my app : < img width= '' 405 '' alt= '' bildschirmfoto 2018-01-31 um 21 06 36 '' src= '' https : //user-images.githubusercontent.com/3503166/35645647-c1bf80b4-06cc-11e8-8533-9b5866881193.png '' > -- - # # # Environment * React Native Navigation version : 1.1.362 * React Native version : 0.52.2 * Platform ( s ) ( iOS , Android , or both ? ) : iOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : Simulator iOS11 Debug
diff -- git a/ios/RCCNavigationController.m b/ios/RCCNavigationController.m index 116c650..8c15f7a 100755 -- - a/ios/RCCNavigationController.m +++ b/ios/RCCNavigationController.m @ @ -255,33 +255,50 @ @ NSString const *CALLBACK_ASSOCIATED_ID = @ '' RCCNavigationController.CALLBACK_ASSO // resetTo if ( [ performAction isEqualToString : @ '' resetTo '' ] ) { + NSArray < UIViewController * > *viewControllers ; + NSString *component = actionParams [ @ '' component '' ] ; - if ( ! component ) return ; - - NSMutableDictionary *passProps = [ actionParams [ @ '' passProps '' ] mutableCopy ] ; - passProps [ @ '' commandType '' ] = @ '' resetTo '' ; - NSDictionary *navigatorStyle = actionParams [ @ '' style '' ] ; - - RCCViewController *viewController = [ [ RCCViewController alloc ] initWithComponent : component passProps : passProps navigatorStyle : navigatorStyle globalProps : nil bridge : bridge ] ; - viewController.controllerId = passProps [ @ '' screenInstanceID '' ] ; - - viewController.navigationItem.hidesBackButton = YES ; - - [ self processTitleView : viewController - props : actionParams - style : navigatorStyle ] ; - NSArray *leftButtons = actionParams [ @ '' leftButtons '' ] ; - if ( leftButtons ) - { - [ self setButtons : leftButtons viewController : viewController Using largeTitle produces two titles __EoT__ # # # Issue Description I am using the newly introduced ( # 2593 ) option ` largeTitle ` to get the Large Title Bar . Now i get two titles in the title bar the big one ( correct ) the old small one ( not correct ) . # # # Steps to Reproduce / Code Snippets / Screenshots This is how i use the new option . `` ` const appStyle = { largeTitle : true } ; // this will start our app Navigation.startTabBasedApp ( { tabs : tabs , appStyle : appStyle } ) ; `` ` Here a screenshot of how it looks in my app : < img width= '' 405 '' alt= '' bildschirmfoto 2018-01-31 um 21 06 36 '' src= '' https : //user-images.githubusercontent.com/3503166/35645647-c1bf80b4-06cc-11e8-8533-9b5866881193.png '' > -- - # # # Environment * React Native Navigation version : 1.1.362 * React Native version : 0.52.2 * Platform ( s ) ( iOS , Android , or both ? ) : iOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : Simulator iOS11 Debug
diff -- git a/ios/RCCCustomTitleView.h b/ios/RCCCustomTitleView.h index 6086373..a6dd54b 100644 -- - a/ios/RCCCustomTitleView.h +++ b/ios/RCCCustomTitleView.h @ @ -11,5 +11,5 @ @ @ interface RCCCustomTitleView : UIView - ( instancetype ) initWithFrame : ( CGRect ) frame subView : ( UIView* ) subView alignment : ( NSString* ) alignment ; -- ( void ) viewWillTransitionToSize : ( CGSize ) size withTransitionCoordinator : ( id < UIViewControllerTransitionCoordinator > ) coordinator ; + @ end diff -- git a/ios/RCCCustomTitleView.m b/ios/RCCCustomTitleView.m index 189375a..663060b 100644 -- - a/ios/RCCCustomTitleView.m +++ b/ios/RCCCustomTitleView.m @ @ -11,14 +11,12 @ @ @ interface RCCCustomTitleView ( ) @ property ( nonatomic , strong ) UIView *subView ; @ property ( nonatomic , strong ) NSString *subViewAlign ; - @ property float initialWidth ; @ end @ implementation RCCCustomTitleView - ( instancetype ) initWithFrame : ( CGRect ) frame subView : ( UIView* ) subView alignment : ( NSString* ) alignment { - _initialWidth = frame.size.width ; self = [ super initWithFrame : frame ] ; if ( self ) { @ @ -54,56 +52,4 @ @ } } -- ( void ) setFrame : ( CGRect ) frame { - - float referenceWidth = [ self statusBarWidth ] ; - if ( referenceWidth Nav Bar Button Font Size Reverts On Press __EoT__ When I set the font size on a text only nav bar button , the font size would revert back to the default when I click on it . Here is the code that I am using to set the button : ` this.props.navigator.setButtons ( { rightButtons : [ { title : 'NEXT ' , buttonColor : 'white ' , buttonFontSize : 12 } ] } ) ; ` -- - # # # Environment * React Native Navigation version : `` ^1.3.4 '' * React Native version : `` 0.50.1 '' * Platform ( s ) ( iOS , Android , or both ? ) : IOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : IPhone 6 Simulator
diff -- git a/example/src/screens/types/CustomTopBar.js b/example/src/screens/types/CustomTopBar.js index da3e1c1..0e12374 100644 -- - a/example/src/screens/types/CustomTopBar.js +++ b/example/src/screens/types/CustomTopBar.js @ @ -18,8 +18,8 @ @ export default class CustomTopBar extends Component { render ( ) { return ( < View style= { styles.container } > - < TouchableOpacity stye= { styles.button } onPress= { ( ) = > Alert.alert ( this.props.title , 'Thanks for that : ) ' ) } > - < Text style= { styles.text } > Press Me < /Text > + < TouchableOpacity style= { styles.button } onPress= { ( ) = > Alert.alert ( this.props.title , 'Hello custom btn : ) ' ) } > + < Text style= { styles.text } > Custom < /Text > < /TouchableOpacity > < /View > ) ; @ @ -30,15 +30,16 @ @ const styles = StyleSheet.create ( { container : { flex : 1 , justifyContent : 'center ' , - alignItems : 'center' + alignItems : 'center ' , + // backgroundColor : 'yellow' } , button : { alignSelf : 'center ' , - backgroundColor : 'green' + // backgroundColor : 'green' } , text : { alignSelf : 'center ' , - color : Platform.OS === 'ios ' ? Custom Navigation Bar is not centralized __EoT__ # # # Issue Description Custom nav bar is not centralised when there is a right navigation icon . The whole custom navigation is pushed left # # # Steps to Reproduce / Code Snippets / Screenshots - add a custom Nav Bar - add an navigation right icon the whole custom navigation area is pushed to the left ANY HELP ? -- - # # # Environment * React Native Navigation version : 1.1.79 * React Native version : 0.44 * Platform ( s ) ( iOS , Android , or both ? ) : iOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : ALL
diff -- git a/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java b/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java index 946be93..f35e3a5 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java +++ b/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java @ @ -39,6 +39,7 @ @ import com.reactnativenavigation.react.ReactGateway ; import com.reactnativenavigation.screens.NavigationType ; import com.reactnativenavigation.screens.Screen ; import com.reactnativenavigation.utils.OrientationHelper ; +import com.reactnativenavigation.utils.ReflectionUtils ; import com.reactnativenavigation.views.SideMenu.Side ; import java.util.List ; @ @ -455,6 +456,11 @ @ public class NavigationActivity extends AppCompatActivity implements DefaultHard public void run ( ) { layout.destroy ( ) ; modalController.destroy ( ) ; + + Object devSupportManager = ReflectionUtils.getDeclaredField ( getReactGateway ( ) .getReactInstanceManager ( ) , `` mDevSupportManager '' ) ; + if ( ReflectionUtils.getDeclaredField ( devSupportManager , `` mRedBoxDialog '' ) ! = null ) { // RN > = 0.52 + ReflectionUtils.setField ( devSupportManager , `` mRedBoxDialog '' , null ) ; + } } } ) ; } diff -- git a/android/app/src/main/java/com/reactnativenavigation/react/JsDevReloadListenerReplacer.java b/android/app/src/main/java/com/reactnativenavigation/react/JsDevReloadListenerReplacer.java index 70e7abd..1f3ae44 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/react/JsDevReloadListenerReplacer.java +++ b/android/app/src/main/java/com/reactnativenavigation/react/JsDevReloadListenerReplacer.java @ @ -1,10 +1,12 @ @ package com.reactnativenavigation.react ; import com.facebook.react.ReactInstanceManager ; -import com.facebook.react.bridge.JavaJSExecutor ; -import com.facebook.react.devsupport.ReactInstanceDevCommandsHandler ; import com.reactnativenavigation.utils.ReflectionUtils ; +import java.lang.reflect.InvocationHandler ; +import java.lang.reflect.Method ; +import java.lang.reflect.Proxy ; + class JsDevReloadListenerReplacer { private final ReactInstanceManager reactInstanceManager ; private final Listener listener ; @ @ -19,49 +21,54 @ @ class JsDevReloadListenerReplacer { } void replace ( ) { - ReactInstanceDevCommandsHandler Custom Navigation Bar is not centralized __EoT__ # # # Issue Description Custom nav bar is not centralised when there is a right navigation icon . The whole custom navigation is pushed left # # # Steps to Reproduce / Code Snippets / Screenshots - add a custom Nav Bar - add an navigation right icon the whole custom navigation area is pushed to the left ANY HELP ? -- - # # # Environment * React Native Navigation version : 1.1.79 * React Native version : 0.44 * Platform ( s ) ( iOS , Android , or both ? ) : iOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : ALL
diff -- git a/docs/screen-api.md b/docs/screen-api.md index 47645e9..fb135fe 100644 -- - a/docs/screen-api.md +++ b/docs/screen-api.md @ @ -10,6 +10,7 @ @ Push a new screen into this screen 's navigation stack . this.props.navigator.push ( { screen : 'example.ScreenThree ' , // unique ID registered with Navigation.registerScreen title : undefined , // navigation bar title of the pushed screen ( optional ) + subtitle : undefined , // navigation bar subtitle of the pushed screen ( optional ) titleImage : require ( '../../img/my_image.png ' ) , // iOS only . navigation bar title image instead of the title text of the pushed screen ( optional ) passProps : { } , // Object that will be passed as props to the pushed screen ( optional ) animated : true , // does the push have transition animation or does it happen immediately ( optional ) @ @ -369,4 +370,4 @ @ https : //developer.apple.com/library/content/documentation/UserExperience/Concept You can define actions and listen for interactions on the pushed screen with the ` PreviewActionPress ` event . -Previewed screens will have the prop ` isPreview ` that can be used to render different things when the screen is in the `` Peek '' state and will then Custom Navigation Bar is not centralized __EoT__ # # # Issue Description Custom nav bar is not centralised when there is a right navigation icon . The whole custom navigation is pushed left # # # Steps to Reproduce / Code Snippets / Screenshots - add a custom Nav Bar - add an navigation right icon the whole custom navigation area is pushed to the left ANY HELP ? -- - # # # Environment * React Native Navigation version : 1.1.79 * React Native version : 0.44 * Platform ( s ) ( iOS , Android , or both ? ) : iOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : ALL
diff -- git a/lib/ios/RNNBridgeModule.m b/lib/ios/RNNBridgeModule.m index 53ddad2..316f163 100644 -- - a/lib/ios/RNNBridgeModule.m +++ b/lib/ios/RNNBridgeModule.m @ @ -76,7 +76,7 @ @ RCT_EXPORT_METHOD ( showModal : ( NSString* ) commandId layout : ( NSDictionary* ) layout re RCT_EXPORT_METHOD ( dismissModal : ( NSString* ) commandId componentId : ( NSString* ) componentId mergeOptions : ( NSDictionary* ) options resolver : ( RCTPromiseResolveBlock ) resolve rejecter : ( RCTPromiseRejectBlock ) reject ) { [ _commandsHandler dismissModal : componentId mergeOptions : options completion : ^ { resolve ( componentId ) ; - } ] ; + } rejection : reject ] ; } RCT_EXPORT_METHOD ( dismissAllModals : ( NSString* ) commandId mergeOptions : ( NSDictionary* ) options resolver : ( RCTPromiseResolveBlock ) resolve rejecter : ( RCTPromiseRejectBlock ) reject ) { diff -- git a/lib/ios/RNNCommandsHandler.h b/lib/ios/RNNCommandsHandler.h index c065ba3..7f144c3 100644 -- - a/lib/ios/RNNCommandsHandler.h +++ b/lib/ios/RNNCommandsHandler.h @ @ -26,7 +26,7 @ @ - ( void ) showModal : ( NSDictionary* ) layout completion : ( RNNTransitionWithComponentIdCompletionBlock ) completion ; -- ( void ) dismissModal : ( NSString* ) componentId mergeOptions : ( NSDictionary* ) options completion : ( RNNTransitionCompletionBlock ) completion ; +- ( void ) dismissModal : ( NSString* ) componentId mergeOptions : ( NSDictionary* ) options [ V2 ] Problems with push+dismissModal and showModal+pop __EoT__ # # # Issue Description If you do a ` pop ` for a modal screen or ` dismissModal ` for a pushed-screen , then problems start . # # # Steps to Reproduce / Code Snippets / Screenshots 1 . ` push ` new screen . Then call ` dismissModal ` . Result : My screens|Crash|Crash ( Drawer opened ) : -- -- -- -- -- -- -- -- -- -- -- -- - : | : -- -- -- -- -- -- -- -- -- -- -- -- - : | : -- -- -- -- -- -- -- -- -- -- -- -- - : ! [ img_0017 ] ( https : //user-images.githubusercontent.com/32956521/45018515-bcb3d680-b043-11e8-95b2-cb98a3532063.PNG ) | ! [ img_0018 ] ( https : //user-images.githubusercontent.com/32956521/45018292-2c759180-b043-11e8-933b-da4bd70b97ac.PNG ) | ! [ img_0019 ] ( https : //user-images.githubusercontent.com/32956521/45018298-313a4580-b043-11e8-9b0b-384b34faf4c9.PNG ) 2 . ` showModal ` new screen . Then call ` pop ` . Then call ` dismissModal ` . Result : nothing happens ! -- - # # # Environment * Checked with 3 versions of RNNv2 : ` 2.0.2459 ` , ` 2.0.2500 ` , ` 2.0.2519 ` * React Native version
diff -- git a/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java b/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java index 946be93..f35e3a5 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java +++ b/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java @ @ -39,6 +39,7 @ @ import com.reactnativenavigation.react.ReactGateway ; import com.reactnativenavigation.screens.NavigationType ; import com.reactnativenavigation.screens.Screen ; import com.reactnativenavigation.utils.OrientationHelper ; +import com.reactnativenavigation.utils.ReflectionUtils ; import com.reactnativenavigation.views.SideMenu.Side ; import java.util.List ; @ @ -455,6 +456,11 @ @ public class NavigationActivity extends AppCompatActivity implements DefaultHard public void run ( ) { layout.destroy ( ) ; modalController.destroy ( ) ; + + Object devSupportManager = ReflectionUtils.getDeclaredField ( getReactGateway ( ) .getReactInstanceManager ( ) , `` mDevSupportManager '' ) ; + if ( ReflectionUtils.getDeclaredField ( devSupportManager , `` mRedBoxDialog '' ) ! = null ) { // RN > = 0.52 + ReflectionUtils.setField ( devSupportManager , `` mRedBoxDialog '' , null ) ; + } } } ) ; } diff -- git a/android/app/src/main/java/com/reactnativenavigation/react/JsDevReloadListenerReplacer.java b/android/app/src/main/java/com/reactnativenavigation/react/JsDevReloadListenerReplacer.java index 70e7abd..1f3ae44 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/react/JsDevReloadListenerReplacer.java +++ b/android/app/src/main/java/com/reactnativenavigation/react/JsDevReloadListenerReplacer.java @ @ -1,10 +1,12 @ @ package com.reactnativenavigation.react ; import com.facebook.react.ReactInstanceManager ; -import com.facebook.react.bridge.JavaJSExecutor ; -import com.facebook.react.devsupport.ReactInstanceDevCommandsHandler ; import com.reactnativenavigation.utils.ReflectionUtils ; +import java.lang.reflect.InvocationHandler ; +import java.lang.reflect.Method ; +import java.lang.reflect.Proxy ; + class JsDevReloadListenerReplacer { private final ReactInstanceManager reactInstanceManager ; private final Listener listener ; @ @ -19,49 +21,54 @ @ class JsDevReloadListenerReplacer { } void replace ( ) { - ReactInstanceDevCommandsHandler Build Fails in React-Native Version 0.52.0 __EoT__ # # # I am trying to install this library in my project . However , the build is failing , I followed all the install steps but the errors just dont go away . I think this library might not be compatible with version 52 of react-native . I might be wrong though . I will share my build.gradle files . **app/build.gradle** `` ` android { compileSdkVersion 26 buildToolsVersion `` 26.0.3 '' defaultConfig { applicationId `` com.kaaddevelopers.pitchit '' minSdkVersion 16 targetSdkVersion 26 versionCode 1 versionName `` 1.0 '' multiDexEnabled true ndk { abiFilters `` armeabi-v7a '' , `` x86 '' } } dexOptions { jumboMode = true incremental true javaMaxHeapSize `` 4g '' } splits { abi { reset ( ) enable enableSeparateBuildPerCPUArchitecture universalApk false // If true , also generate a universal APK include `` armeabi-v7a '' , `` x86 '' } } buildTypes { release { minifyEnabled enableProguardInReleaseBuilds proguardFiles getDefaultProguardFile ( `` proguard-android.txt '' ) , `` proguard-rules.pro '' } } // applicationVariants are e.g . debug , release applicationVariants.all { variant - > variant.outputs.each { output - > // For each separate APK per architecture , set a unique
diff -- git a/android/app/src/main/java/com/reactnativenavigation/react/JsDevReloadListenerReplacer.java b/android/app/src/main/java/com/reactnativenavigation/react/JsDevReloadListenerReplacer.java index 70e7abd..838926d 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/react/JsDevReloadListenerReplacer.java +++ b/android/app/src/main/java/com/reactnativenavigation/react/JsDevReloadListenerReplacer.java @ @ -1,8 +1,10 @ @ package com.reactnativenavigation.react ; +import android.app.Activity ; + import com.facebook.react.ReactInstanceManager ; import com.facebook.react.bridge.JavaJSExecutor ; -import com.facebook.react.devsupport.ReactInstanceDevCommandsHandler ; +import com.facebook.react.devsupport.ReactInstanceManagerDevHelper ; import com.reactnativenavigation.utils.ReflectionUtils ; class JsDevReloadListenerReplacer { @ @ -19,7 +21,7 @ @ class JsDevReloadListenerReplacer { } void replace ( ) { - ReactInstanceDevCommandsHandler originalHandler = getOriginalHandler ( ) ; + ReactInstanceManagerDevHelper originalHandler = getOriginalHandler ( ) ; DevCommandsHandlerProxy proxy = new DevCommandsHandlerProxy ( originalHandler , listener ) ; replaceInReactInstanceManager ( proxy ) ; replaceInDevSupportManager ( proxy ) ; @ @ -30,19 +32,19 @ @ class JsDevReloadListenerReplacer { ReflectionUtils.setField ( devSupportManager , `` mReactInstanceCommandsHandler '' , proxy ) ; } - private ReactInstanceDevCommandsHandler getOriginalHandler ( ) { - return ( ReactInstanceDevCommandsHandler ) ReflectionUtils.getDeclaredField ( reactInstanceManager , `` mDevInterface '' ) ; + private ReactInstanceManagerDevHelper getOriginalHandler ( ) { + return ( ReactInstanceManagerDevHelper ) ReflectionUtils.getDeclaredField ( reactInstanceManager , `` mDevInterface '' ) ; } private void replaceInReactInstanceManager ( DevCommandsHandlerProxy proxy ) { ReflectionUtils.setField ( reactInstanceManager , `` mDevInterface '' , proxy ) ; } - private static class DevCommandsHandlerProxy implements ReactInstanceDevCommandsHandler { - private ReactInstanceDevCommandsHandler originalReactHandler ; + private static class DevCommandsHandlerProxy implements ReactInstanceManagerDevHelper Build Fails in React-Native Version 0.52.0 __EoT__ # # # I am trying to install this library in my project . However , the build is failing , I followed all the install steps but the errors just dont go away . I think this library might not be compatible with version 52 of react-native . I might be wrong though . I will share my build.gradle files . **app/build.gradle** `` ` android { compileSdkVersion 26 buildToolsVersion `` 26.0.3 '' defaultConfig { applicationId `` com.kaaddevelopers.pitchit '' minSdkVersion 16 targetSdkVersion 26 versionCode 1 versionName `` 1.0 '' multiDexEnabled true ndk { abiFilters `` armeabi-v7a '' , `` x86 '' } } dexOptions { jumboMode = true incremental true javaMaxHeapSize `` 4g '' } splits { abi { reset ( ) enable enableSeparateBuildPerCPUArchitecture universalApk false // If true , also generate a universal APK include `` armeabi-v7a '' , `` x86 '' } } buildTypes { release { minifyEnabled enableProguardInReleaseBuilds proguardFiles getDefaultProguardFile ( `` proguard-android.txt '' ) , `` proguard-rules.pro '' } } // applicationVariants are e.g . debug , release applicationVariants.all { variant - > variant.outputs.each { output - > // For each separate APK per architecture , set a unique
diff -- git a/e2e/ScreenStyle.test.js b/e2e/ScreenStyle.test.js index 2c15545..f2d7a74 100644 -- - a/e2e/ScreenStyle.test.js +++ b/e2e/ScreenStyle.test.js @ @ -118,4 +118,9 @ @ describe ( 'screen style ' , ( ) = > { await elementById ( testIDs.POP_BUTTON ) .tap ( ) ; await expect ( elementById ( testIDs.TOP_BAR_ELEMENT ) ) .toBeVisible ( ) ; } ) ; + + it ( 'supports user-provided id ' , async ( ) = > { + await elementById ( testIDs.PROVIDED_ID ) .tap ( ) ; + await expect ( elementByLabel ( 'User provided id ' ) ) .toBeVisible ( ) ; + } ) ; } ) ; diff -- git a/lib/src/commands/LayoutTreeCrawler.test.ts b/lib/src/commands/LayoutTreeCrawler.test.ts index 3691d9f..0f7b7d7 100644 -- - a/lib/src/commands/LayoutTreeCrawler.test.ts +++ b/lib/src/commands/LayoutTreeCrawler.test.ts @ @ -19,6 +19,12 @ @ describe ( 'LayoutTreeCrawler ' , ( ) = > { expect ( node.children [ 0 ] .id ) .toEqual ( 'BottomTabs+UNIQUE_ID ' ) ; } ) ; + it ( 'does not generate unique id when already provided ' , ( ) = > { + const node = { id : 'user defined id ' , type : LayoutType.Stack } ; + uut.crawl ( node ) ; + expect ( node.id ) .toEqual ( 'user defined id ' Allow user supplied refs ( id ) __EoT__ * Rename ` nodeId ` to ` ref ` * ` setOptionsByRef ` * use ` ref ` ( previously ` nodeId ` ) as ` componentId ` Motivation : apply options which are not bound to components
diff -- git a/ios/RCCViewController.m b/ios/RCCViewController.m index e81638d..a96a859 100755 -- - a/ios/RCCViewController.m +++ b/ios/RCCViewController.m @ @ -239,6 +239,13 @ @ const NSInteger TRANSPARENT_NAVBAR_TAG = 78264803 ; viewController.view.backgroundColor = color ; } + NSString *screenBackgroundImageName = self.navigatorStyle [ @ '' screenBackgroundImageName '' ] ; + if ( screenBackgroundImageName ) { + + UIImage *image = [ UIImage imageNamed : screenBackgroundImageName ] ; + [ viewController.view setBackgroundColor : [ UIColor colorWithPatternImage : image ] ] ; + } + NSString *navBarBackgroundColor = self.navigatorStyle [ @ '' navBarBackgroundColor '' ] ; if ( navBarBackgroundColor ) { How to apply gradient color on nagivation bar __EoT__ Hi , Is there a way to implement linear gradient color for navigation bar and screen background ? I found a related thread on this link https : //github.com/wix/react-native-navigation/pull/861 . So could we use something like below { navigatorStyle : { navBarBackgroundColorGradient : [ # startColor , # endColor ] screenBackgroundColorGradient : [ # startColor , # endColor ] } }
diff -- git a/ios/RCCViewController.m b/ios/RCCViewController.m index e81638d..a96a859 100755 -- - a/ios/RCCViewController.m +++ b/ios/RCCViewController.m @ @ -239,6 +239,13 @ @ const NSInteger TRANSPARENT_NAVBAR_TAG = 78264803 ; viewController.view.backgroundColor = color ; } + NSString *screenBackgroundImageName = self.navigatorStyle [ @ '' screenBackgroundImageName '' ] ; + if ( screenBackgroundImageName ) { + + UIImage *image = [ UIImage imageNamed : screenBackgroundImageName ] ; + [ viewController.view setBackgroundColor : [ UIColor colorWithPatternImage : image ] ] ; + } + NSString *navBarBackgroundColor = self.navigatorStyle [ @ '' navBarBackgroundColor '' ] ; if ( navBarBackgroundColor ) { How to apply gradient color on nagivation bar __EoT__ Hi , Is there a way to implement linear gradient color for navigation bar and screen background ? I found a related thread on this link https : //github.com/wix/react-native-navigation/pull/861 . So could we use something like below { navigatorStyle : { navBarBackgroundColorGradient : [ # startColor , # endColor ] screenBackgroundColorGradient : [ # startColor , # endColor ] } }
diff -- git a/src/deprecated/platformSpecificDeprecated.android.js b/src/deprecated/platformSpecificDeprecated.android.js index a46b5a4..731d1d1 100644 -- - a/src/deprecated/platformSpecificDeprecated.android.js +++ b/src/deprecated/platformSpecificDeprecated.android.js @ @ -387,7 +387,7 @ @ function addNavigatorButtons ( screen , sideMenuParams ) { } let leftButton = getLeftButton ( screen ) ; - if ( sideMenuParams & & ! leftButton ) { + if ( sideMenuParams & & ! sideMenuParams.dontCreateSideMenuNavButton & & ! leftButton ) { leftButton = createSideMenuButton ( ) ; } if ( leftButton ) { How to hide the hamburger icon from the nav bar ? __EoT__ Hey there , I 've enabled a side menu ( drawer ) by the following code : `` ` javascript Navigation.startSingleScreenApp ( { screen : { screen : ScheneKeys.WELCOME , title : 'Welcome ' , navigatorStyle : FixedStyles.NavBarStyleDark , navigatorButtons : { leftButtons : [ ] , rightButtons : [ ] , } , } , drawer : { left : { screen : ScheneKeys.SIDE_MENU , } , disableOpenGesture : true , // on false can the drawer be opened with a swipe instead of button } , animationType : 'slide-down ' , // optional , add transition animation to root change : 'none ' , 'slide-down ' , 'fade' } ) ; `` ` All works well , but there are cases on which I do n't want a hamburger icon in the nav bar . ( Because I do n't need the drawer at all for those screens ) . For instance I do n't want it on the welcome screen , but I do want it on later screens . ( I use ` resetTo ` and replace the root screen with something else )
diff -- git a/lib/android/app/build.gradle b/lib/android/app/build.gradle index 8252b66..8ef0f36 100644 -- - a/lib/android/app/build.gradle +++ b/lib/android/app/build.gradle @ @ -30,6 +30,7 @ @ android { } testLogging { events `` passed '' , `` skipped '' , `` failed '' , `` standardOut '' , `` standardError '' + showStandardStreams true } afterSuite { desc , result - > if ( ! desc.parent ) { // will match the outermost suite @ @ -70,5 +71,5 @ @ dependencies { testImplementation 'org.robolectric : robolectric:3.5.1' testImplementation 'org.assertj : assertj-core:3.8.0' testImplementation 'com.squareup.assertj : assertj-android:1.1.1' - testImplementation 'org.mockito : mockito-core:2.12.0' + testImplementation 'org.mockito : mockito-core:2.13.0' } diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/anim/StackAnimator.java b/lib/android/app/src/main/java/com/reactnativenavigation/anim/StackAnimator.java index 6083fb1..125e2b2 100644 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/anim/StackAnimator.java +++ b/lib/android/app/src/main/java/com/reactnativenavigation/anim/StackAnimator.java @ @ -12,7 +12,6 @ @ import android.view.ViewGroup ; import android.view.WindowManager ; import android.view.animation.AccelerateInterpolator ; import android.view.animation.DecelerateInterpolator ; -import android.widget.LinearLayout ; import com.reactnativenavigation.views.TopBar ; @ @ -109,30 +108,22 @ @ public class StackAnimator { private float getWindowHeight ( Context context ) { DisplayMetrics metrics = new DisplayMetrics ( ) ; WindowManager windowManager = ( WindowManager ) context.getSystemService ( Context.WINDOW_SERVICE ) ; - windowManager.getDefaultDisplay ( ) .getMetrics ( metrics ) ; + if ( windowManager ! = null ) { + windowManager.getDefaultDisplay ( ) .getMetrics ( metrics ) ; + ReactRootView height should not be affected when animating TopBar __EoT__ When toggling TopBar , do n't change content view height . Instead , the user should take care of positioning himself so that blank spaces wo n't be visible when animating TopBar .
diff -- git a/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/BaseTest.java b/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/BaseTest.java index 8f78883..adaed42 100644 -- - a/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/BaseTest.java +++ b/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/BaseTest.java @ @ -15,94 +15,100 @ @ import static org.assertj.core.api.Java6Assertions . * ; @ RunWith ( AndroidJUnit4.class ) public abstract class BaseTest { - static final String PACKAGE_NAME = `` com.reactnativenavigation.playground '' ; - private static final long TIMEOUT = 60000 ; - - @ Before - public void beforeEach ( ) throws Exception { - device ( ) .wakeUp ( ) ; - device ( ) .setOrientationNatural ( ) ; - launchTheApp ( ) ; - assertMainShown ( ) ; - } - - @ After - public void afterEach ( ) throws Exception { - device ( ) .executeShellCommand ( `` am force-stop `` + PACKAGE_NAME ) ; - device ( ) .executeShellCommand ( `` am kill `` + PACKAGE_NAME ) ; - } - - public UiDevice device ( ) { - return UiDevice.getInstance ( getInstrumentation ( ) ) ; - } - - public void launchTheApp ( ) throws Exception { - device ( ) .executeShellCommand ( `` am start -n `` + PACKAGE_NAME + `` /.MainActivity '' ) ; - device ( ) .waitForIdle ( ) ; - acceptOverlayPermissionIfNeeded ( ) ; - ReactRootView height should not be affected when animating TopBar __EoT__ When toggling TopBar , do n't change content view height . Instead , the user should take care of positioning himself so that blank spaces wo n't be visible when animating TopBar .
diff -- git a/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/BaseTest.java b/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/BaseTest.java index 8f78883..adaed42 100644 -- - a/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/BaseTest.java +++ b/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/BaseTest.java @ @ -15,94 +15,100 @ @ import static org.assertj.core.api.Java6Assertions . * ; @ RunWith ( AndroidJUnit4.class ) public abstract class BaseTest { - static final String PACKAGE_NAME = `` com.reactnativenavigation.playground '' ; - private static final long TIMEOUT = 60000 ; - - @ Before - public void beforeEach ( ) throws Exception { - device ( ) .wakeUp ( ) ; - device ( ) .setOrientationNatural ( ) ; - launchTheApp ( ) ; - assertMainShown ( ) ; - } - - @ After - public void afterEach ( ) throws Exception { - device ( ) .executeShellCommand ( `` am force-stop `` + PACKAGE_NAME ) ; - device ( ) .executeShellCommand ( `` am kill `` + PACKAGE_NAME ) ; - } - - public UiDevice device ( ) { - return UiDevice.getInstance ( getInstrumentation ( ) ) ; - } - - public void launchTheApp ( ) throws Exception { - device ( ) .executeShellCommand ( `` am start -n `` + PACKAGE_NAME + `` /.MainActivity '' ) ; - device ( ) .waitForIdle ( ) ; - acceptOverlayPermissionIfNeeded ( ) ; - ReactRootView height should not be affected when animating TopBar __EoT__ When toggling TopBar , do n't change content view height . Instead , the user should take care of positioning himself so that blank spaces wo n't be visible when animating TopBar .
diff -- git a/lib/android/app/build.gradle b/lib/android/app/build.gradle index a4214e1..ebe905a 100644 -- - a/lib/android/app/build.gradle +++ b/lib/android/app/build.gradle @ @ -61,6 +61,8 @ @ dependencies { implementation 'com.android.support : appcompat-v7:25.4.0' implementation 'com.android.support : support-v4:25.4.0' implementation 'com.aurelhubert : ahbottomnavigation:2.1.0' + implementation 'com.github.clans : fab:1.6.4' + // node_modules //noinspection GradleDynamicVersion diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/anim/FabAnimator.java b/lib/android/app/src/main/java/com/reactnativenavigation/anim/FabAnimator.java new file mode 100644 index 0000000..5e0153b -- - /dev/null +++ b/lib/android/app/src/main/java/com/reactnativenavigation/anim/FabAnimator.java @ @ -0,0 +1,8 @ @ +package com.reactnativenavigation.anim ; + + +public interface FabAnimator { + void show ( ) ; + void hide ( ) ; + + } diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/anim/FabCollapseBehaviour.java b/lib/android/app/src/main/java/com/reactnativenavigation/anim/FabCollapseBehaviour.java new file mode 100644 index 0000000..383be77 -- - /dev/null +++ b/lib/android/app/src/main/java/com/reactnativenavigation/anim/FabCollapseBehaviour.java @ @ -0,0 +1,43 @ @ +package com.reactnativenavigation.anim ; + + +import com.reactnativenavigation.interfaces.ScrollEventListener ; + +public class FabCollapseBehaviour implements ScrollEventListener.OnScrollListener , ScrollEventListener.OnDragListener { + + private FabAnimator fabAnimator ; + private ScrollEventListener scrollEventListener ; + + public FabCollapseBehaviour ( FabAnimator fabAnimator ) { + this.fabAnimator = fabAnimator ; + } + + public void enableCollapse ( ScrollEventListener scrollEventListener ) { + this.scrollEventListener = scrollEventListener ; + this.scrollEventListener.register ( null , this , this ) ; + } + + public void disableCollapse ( ) { + scrollEventListener.unregister ( ) ; + } + + @ android fab __EoT__ https : //github.com/Clans/FloatingActionButton - [ x ] background color ( collapsed and expended ) - [ x ] Icon ( collapsed and expended ) - [ x ] Icon color ( collapsed and expended ) - [ x ] Actions - [ x ] Gravity - [ x ] Hide on scroll
diff -- git a/lib/android/app/build.gradle b/lib/android/app/build.gradle index a4214e1..ebe905a 100644 -- - a/lib/android/app/build.gradle +++ b/lib/android/app/build.gradle @ @ -61,6 +61,8 @ @ dependencies { implementation 'com.android.support : appcompat-v7:25.4.0' implementation 'com.android.support : support-v4:25.4.0' implementation 'com.aurelhubert : ahbottomnavigation:2.1.0' + implementation 'com.github.clans : fab:1.6.4' + // node_modules //noinspection GradleDynamicVersion diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/anim/FabAnimator.java b/lib/android/app/src/main/java/com/reactnativenavigation/anim/FabAnimator.java new file mode 100644 index 0000000..5e0153b -- - /dev/null +++ b/lib/android/app/src/main/java/com/reactnativenavigation/anim/FabAnimator.java @ @ -0,0 +1,8 @ @ +package com.reactnativenavigation.anim ; + + +public interface FabAnimator { + void show ( ) ; + void hide ( ) ; + + } diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/anim/FabCollapseBehaviour.java b/lib/android/app/src/main/java/com/reactnativenavigation/anim/FabCollapseBehaviour.java new file mode 100644 index 0000000..eed1b20 -- - /dev/null +++ b/lib/android/app/src/main/java/com/reactnativenavigation/anim/FabCollapseBehaviour.java @ @ -0,0 +1,47 @ @ +package com.reactnativenavigation.anim ; + + +import android.support.annotation.NonNull ; + +import com.reactnativenavigation.interfaces.ScrollEventListener ; + +public class FabCollapseBehaviour implements ScrollEventListener.OnScrollListener , ScrollEventListener.OnDragListener { + + private FabAnimator fabAnimator ; + private ScrollEventListener scrollEventListener ; + + public FabCollapseBehaviour ( FabAnimator fabAnimator ) { + this.fabAnimator = fabAnimator ; + } + + public void enableCollapse ( @ NonNull ScrollEventListener scrollEventListener ) { + this.scrollEventListener = scrollEventListener ; + this.scrollEventListener.register ( null , this , this ) ; + } + + public void disableCollapse ( ) { + if ( scrollEventListener android fab __EoT__ https : //github.com/Clans/FloatingActionButton - [ x ] background color ( collapsed and expended ) - [ x ] Icon ( collapsed and expended ) - [ x ] Icon color ( collapsed and expended ) - [ x ] Actions - [ x ] Gravity - [ x ] Hide on scroll
diff -- git a/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java b/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java index 8840656..2f4f672 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java +++ b/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java @ @ -43,6 +43,11 @ @ import javax.annotation.Nullable ; */ public abstract class BaseReactActivity extends AppCompatActivity implements DefaultHardwareBackBtnHandler { + protected static final String KEY_ANIMATED = `` animated '' ; + protected static final String KEY_BADGE = `` badge '' ; + protected static final String KEY_HIDDEN = `` hidden '' ; + protected static final String KEY_TAB_INDEX = `` tabIndex '' ; + protected static final String KEY_TITLE = `` title '' ; private static final String TAG = `` BaseReactActivity '' ; private static final String REDBOX_PERMISSION_MESSAGE = `` Overlay permissions needs to be granted in order for react native apps to run in dev mode '' ; @ @ -191,10 +196,17 @ @ public abstract class BaseReactActivity extends AppCompatActivity implements Def } public void updateStyles ( ) { + updateStyles ( null ) ; + } + + public void updateStyles ( Screen otherScreen ) { + Screen screen = ( otherScreen == null ) ? getCurrentScreen ( ) : otherScreen ; try { - mToolbar.update ( getCurrentScreen ( ) ) ; - setNavigationStyle ( getCurrentScreen ( ) ) ; - mToolbar.setupToolbarButtonsAsync ( getCurrentScreen Build issue with example but not example-redux __EoT__ Thanks for sharing this project ! The IOS stuff I 've been able to play with is awesome . If I clone the project and do a npm install and react-native run-android in the example folder I get the following error . The example-redux folder works fine though . Is anyone able to run the example on android from the master branch ? The build.gradle files are a little different between the two examples . And it looks like the missing pieces would be related to my error below . But even when I even them up it 's still not pulling in the lib . This does n't seem super complicated to track down . But before I start ripping apart the build stuff I wanted to ask to make sure I was n't missing something obvious . Thanks . `` ` /Users/jon/github/rn-examples/react-native-navigation/example/android/app/src/main/java/com/example/MainActivity.java:4 : error : can not find symbol import com.reactnativenavigation.activities.RctActivity ; ^ symbol : class RctActivity location : package com.reactnativenavigation.activities /Users/jon/github/rn-examples/react-native-navigation/example/android/app/src/main/java/com/example/MainActivity.java:6 : error : can not find symbol public class MainActivity extends RctActivity { ^ symbol : class RctActivity /Users/jon/github/rn-examples/react-native-navigation/example/android/app/src/main/java/com/example/MainActivity.java:8 : error : method does not override or implement
diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/presentation/SideMenuPresenter.java b/lib/android/app/src/main/java/com/reactnativenavigation/presentation/SideMenuPresenter.java index fd70f1e..22f4ce4 100644 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/presentation/SideMenuPresenter.java +++ b/lib/android/app/src/main/java/com/reactnativenavigation/presentation/SideMenuPresenter.java @ @ -13,7 +13,32 @ @ public class SideMenuPresenter { this.sideMenu = sideMenu ; } + /** + * Called when initializing the sideMenu DrawerLayout . + * + * @ param options Side menu options + */ + public void applyInitialOptions ( SideMenuRootOptions options ) { + if ( options.left.enabled.isFalse ( ) ) { + sideMenu.setDrawerLockMode ( DrawerLayout.LOCK_MODE_LOCKED_CLOSED , Gravity.LEFT ) ; + } + else if ( options.left.enabled.isTrue ( ) ) { + sideMenu.setDrawerLockMode ( DrawerLayout.LOCK_MODE_UNLOCKED , Gravity.LEFT ) ; + } + + if ( options.right.enabled.isFalse ( ) ) { + sideMenu.setDrawerLockMode ( DrawerLayout.LOCK_MODE_LOCKED_CLOSED , Gravity.RIGHT ) ; + } + else if ( options.right.enabled.isTrue ( ) ) { + sideMenu.setDrawerLockMode ( DrawerLayout.LOCK_MODE_UNLOCKED , Gravity.RIGHT ) ; + } + } + public void present ( SideMenuRootOptions options ) { + // TODO : Not sure why we call these options when we show the DrawerLayout rather than when initializing it . + // TODO : ( i.e . ` setDrawerLockMode ( ) ` is supposed to be called when the DrawerLayout is initialized . + applyInitialOptions ( options ) ; + if ( V2 - Disable side menu ( including using swipe gesture ) for a given component on Android __EoT__ If you have something similar to the code below , it will not disable the side menu if you use the swipe gesture . `` ` Navigation.setRoot ( { root : { sideMenu : { left : { component : { name : SIDEMENU , } , visible : false , enabled : false , } , center : { stack : { id : root , children : [ { component : { name : SWIPE , options : { sideMenu : { left : { component : { name : SIDEMENU , } , visible : false , enabled : false , < -- -- -- This should disable the side menu for the given component but it does not } } } , } , } , ] , } , } , } , } , } ) ; `` ` -- - # # # Environment * React Native Navigation version : ` 2.0.2582 ` * React Native version : ` 0.57.0 ` * Platform ( s ) ( iOS , Android , or both ? )
diff -- git a/e2e/ScreenStyle.test.js b/e2e/ScreenStyle.test.js index d23aa2c..9a51bef 100644 -- - a/e2e/ScreenStyle.test.js +++ b/e2e/ScreenStyle.test.js @ @ -24,4 +24,23 @ @ describe ( 'screen style ' , ( ) = > { await elementByLabel ( 'Dynamic Options ' ) .tap ( ) ; await expect ( element ( by.label ( 'Options Screen ' ) ) ) .toBeVisible ( ) ; } ) ; + + it ( 'hides Tab Bar when pressing on Hide Top Bar and shows it when pressing on Show Top Bar ' , async ( ) = > { + await elementByLabel ( 'Push Options Screen ' ) .tap ( ) ; + await elementByLabel ( 'Hide Top Bar ' ) .tap ( ) ; + await expect ( element ( by.type ( 'UINavigationBar ' ) ) ) .toBeNotVisible ( ) ; + await elementByLabel ( 'Show Top Bar ' ) .tap ( ) ; + await expect ( element ( by.type ( 'UINavigationBar ' ) ) ) .toBeVisible ( ) ; + } ) ; + + it ( 'hides topBar onScroll down and shows it on scroll up ' , async ( ) = > { + await elementByLabel ( 'Push Options Screen ' ) .tap topBarHideOnScroll is flaky in iOS v2 __EoT__ The Navigation Bar hides on scroll down but does not always show itself on scroll up . Related pull request : # 1637
diff -- git a/ios/RCCNavigationController.m b/ios/RCCNavigationController.m index 503157e..6b9c18a 100755 -- - a/ios/RCCNavigationController.m +++ b/ios/RCCNavigationController.m @ @ -88,6 +88,7 @ @ NSString const *CALLBACK_ASSOCIATED_ID = @ '' RCCNavigationController.CALLBACK_ASSO [ mergedStyle removeObjectForKey : @ '' statusBarHideWithNavBar '' ] ; [ mergedStyle removeObjectForKey : @ '' autoAdjustScrollViewInsets '' ] ; [ mergedStyle removeObjectForKey : @ '' statusBarTextColorSchemeSingleScreen '' ] ; + [ mergedStyle removeObjectForKey : @ '' disabledBackGesture '' ] ; [ mergedStyle addEntriesFromDictionary : navigatorStyle ] ; navigatorStyle = mergedStyle ; diff -- git a/ios/RCCViewController.m b/ios/RCCViewController.m index a96a859..93b02a9 100755 -- - a/ios/RCCViewController.m +++ b/ios/RCCViewController.m @ @ -22,6 +22,7 @ @ const NSInteger TRANSPARENT_NAVBAR_TAG = 78264803 ; @ property ( nonatomic ) BOOL _statusBarHideWithNavBar ; @ property ( nonatomic ) BOOL _statusBarHidden ; @ property ( nonatomic ) BOOL _statusBarTextColorSchemeLight ; + @ property ( nonatomic ) BOOL _disableBackGesture ; @ property ( nonatomic , strong ) NSDictionary *originalNavBarImages ; @ property ( nonatomic , strong ) UIImageView *navBarHairlineImageView ; @ property ( nonatomic , weak ) id < UIGestureRecognizerDelegate > originalInteractivePopGestureDelegate ; @ @ -30,611 +31,618 @ @ const NSInteger TRANSPARENT_NAVBAR_TAG = 78264803 ; @ implementation RCCViewController - ( UIImageView * ) navBarHairlineImageView { - if ( ! _navBarHairlineImageView ) { - _navBarHairlineImageView Tab style tabBarSelectedButtonColor is not working on icon image from react-native-vector-icons ? __EoT__ # # # Issue Description ! [ image ] ( https : //cloud.githubusercontent.com/assets/1255011/20957222/6793f932-bc89-11e6-84d2-bbf08d022552.png ) The tabBarSelectedButtonColor only valid for tab label . As you can see , the label color of current tab is changed , but not the icon . The tab icon image is generated by FontAwesome.getImageSource , and it must supply to color param to this function . # # # Code **generate icon images** `` ` javascript /** * 在球场 * zaiqiuchang.com */ import FontAwesome from 'react-native-vector-icons/FontAwesome ' ; import { COLOR } from './config ' ; const icons = { 'tabbar-nearby ' : [ 'map-marker ' , 24 , COLOR.textEmpha , FontAwesome ] , 'tabbar-atcourt ' : [ 'plus-square ' , 24 , COLOR.textEmpha , FontAwesome ] , 'tabbar-me ' : [ 'user ' , 24 , COLOR.textEmpha , FontAwesome ] , } let iconImages = { } ; export function loadIconImages ( ) { return new Promise ( ( resolve , reject ) = > { const iconNames = Object.keys ( icons ) ; Promise.all ( iconNames.map ( iconName = > { let [ name , size , color , vendor
diff -- git a/lib/android/app/build.gradle b/lib/android/app/build.gradle index 417a34d..85b6f09 100644 -- - a/lib/android/app/build.gradle +++ b/lib/android/app/build.gradle @ @ -57,6 +57,9 @ @ android { reactNative56 { dimension `` RNN.reactNativeVersion '' } + reactNative57 { + dimension `` RNN.reactNativeVersion '' + } } } diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java b/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java deleted file mode 100644 index 02cd1dc..0000000 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java +++ /dev/null @ @ -1,108 +0,0 @ @ -package com.reactnativenavigation.react ; - -import android.app.Application ; -import android.support.annotation.NonNull ; -import android.support.annotation.Nullable ; - -import com.facebook.infer.annotation.Assertions ; -import com.facebook.react.ReactInstanceManager ; -import com.facebook.react.ReactInstanceManagerBuilder ; -import com.facebook.react.ReactNativeHost ; -import com.facebook.react.ReactPackage ; -import com.facebook.react.common.LifecycleState ; -import com.facebook.react.devsupport.interfaces.DevBundleDownloadListener ; -import com.facebook.react.shell.MainReactPackage ; -import com.reactnativenavigation.NavigationApplication ; - -import java.util.ArrayList ; -import java.util.List ; - -/** - * Default implementation of { @ link ReactNativeHost } that includes { @ link NavigationPackage } - * and user-defined additional packages . - */ -public class NavigationReactNativeHost extends ReactNativeHost implements BundleDownloadListenerProvider { - - private final boolean isDebug ; - private final List < ReactPackage > additionalReactPackages ; - private @ Nullable NavigationDevBundleDownloadListener bundleListener ; - private final DevBundleDownloadListener bundleListenerMediator = new DevBundleDownloadListenerAdapter ( ) { - @ Override - public void onSuccess ( ) { - if ( bundleListener ! = null ) { - [ android ] react-native 0.57 compatibility __EoT__ https : //github.com/facebook/react-native/commit/506f92083806e91a90d9a213bcdd05ab3b2ba888 UIImplementationProvider has been removed so I had to do the following to get Android to work in React Native 57 . `` ` diff -- - a/node_modules/react-native-navigation/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java +++ b/node_modules/react-native-navigation/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java @ @ -83,7 +83,7 @ @ public class NavigationReactNativeHost extends ReactNativeHost implements Bundle .setUseDeveloperSupport ( getUseDeveloperSupport ( ) ) .setRedBoxHandler ( getRedBoxHandler ( ) ) .setJavaScriptExecutorFactory ( getJavaScriptExecutorFactory ( ) ) - .setUIImplementationProvider ( getUIImplementationProvider ( ) ) + // .setUIImplementationProvider ( getUIImplementationProvider ( ) ) .setInitialLifecycleState ( LifecycleState.BEFORE_CREATE ) .setDevBundleDownloadListener ( getDevBundleDownloadListener ( ) ) ; -- - a/node_modules/react-native-navigation/lib/android/app/src/reactNative56/java/com/reactnativenavigation/react/SyncUiImplementation.java +++ b/node_modules/react-native-navigation/lib/android/app/src/reactNative56/java/com/reactnativenavigation/react/SyncUiImplementation.java @ @ -7,7 +7,7 @ @ import com.facebook.react.bridge.ReadableArray ; import com.facebook.react.bridge.ReadableMap ; import com.facebook.react.uimanager.ThemedReactContext ; import com.facebook.react.uimanager.UIImplementation ; -import com.facebook.react.uimanager.UIImplementationProvider ; +// import com.facebook.react.uimanager.UIImplementationProvider ; import com.facebook.react.uimanager.UIManagerModule ; import com.facebook.react.uimanager.ViewManager ; import com.facebook.react.uimanager.common.MeasureSpecProvider ; @ @ -20,17 +20,17 @ @ import java.util.List ; public class SyncUiImplementation extends UIImplementation { private static final Object lock = new Object ( ) ; - public static class Provider extends UIImplementationProvider { - @ Override - public UIImplementation createUIImplementation ( ReactApplicationContext reactContext , List < ViewManager > viewManagerList , EventDispatcher eventDispatcher , int minTimeLeftInFrameForNonBatchedOperationMs ) { - return new SyncUiImplementation ( reactContext ,
diff -- git a/android/app/src/main/java/com/reactnativenavigation/views/RctView.java b/android/app/src/main/java/com/reactnativenavigation/views/RctView.java index fbc1a3b..15d7a37 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/views/RctView.java +++ b/android/app/src/main/java/com/reactnativenavigation/views/RctView.java @ @ -71,11 +71,10 @ @ public class RctView extends FrameLayout { } /** - * Must be called before view is removed from screen inorder to ensure onDetachedFromScreen is properly - * executed and componentWillUnmount is called + * Must be called before view is removed from screen inorder to ensure ReactRootView is unmounted . */ public void onRemoveFromScreen ( ) { - ReflectionUtils.setField ( mReactRootView , `` mAttachScheduled '' , false ) ; + ReflectionUtils.invoke ( mReactRootView , `` unmountReactApplication '' ) ; } /** [ Android ] Reload JS will cause all previous navigated pages render __EoT__ Hi , all . I asked this in a separate issue ( https : //github.com/wix/react-native-navigation/issues/74 ) but I think I better ask separately . This is easily reproducible in example-redux . Simply run the example with console tracing in all render functions : Android - Navigate through few pages , then reload JS and you will see all previous navigated pages render function gets called . iOS - Navigate through few pages , then reload JS and everything works just fine . Only the entry page render function is called . I am suspecting this has to do with how Android and iOS reload JS bundle . My temp workaround now is to restart the app when debugging but obviously this is not a long term option . Maybe I shall ask this with React Native team but I guess I 'll check with you guys first . Thanks .
diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/views/titlebar/TitleBar.java b/lib/android/app/src/main/java/com/reactnativenavigation/views/titlebar/TitleBar.java index e1947b1..1cacd13 100644 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/views/titlebar/TitleBar.java +++ b/lib/android/app/src/main/java/com/reactnativenavigation/views/titlebar/TitleBar.java @ @ -108,6 +108,8 @ @ public class TitleBar extends Toolbar { view.post ( ( ) - > { if ( alignment == Alignment.Center ) { view.setX ( ( getWidth ( ) - view.getWidth ( ) ) / 2 ) ; + } else if ( leftButtonController ! = null ) { + view.setX ( getContentInsetStartWithNavigation ( ) ) ; } else { view.setX ( UiUtils.dpToPx ( getContext ( ) , 16 ) ) ; } Left Buttons overlapped by NavBar Title __EoT__ # # # Left Buttons overlapped by NavBar Title Currently , the left buttons for the TopBar/NavBar cover the title . # # # Steps to Reproduce / Code Snippets / Screenshots ! [ device-2018-05-01-101746 ] ( https : //user-images.githubusercontent.com/1957315/39476250-47ede160-4d29-11e8-83e4-748669cf55ea.png ) Passed in options : `` ` js topBar : { title : { color : ' # FFFFFF ' , text : 'Events ' , } , background : { color : ' # 313E61 ' , } , leftButtons : [ { id : 'EventsScreenNavBarButtons.Settings ' , disableIconTint : true , buttonColor : ' # FFFFFF ' , icon : require ( ' @ images/gear.png ' ) , } , ] , } , `` ` -- - # # # Environment * React Native Navigation version : 2.0.2274 * React Native version : 0.52.2 * Platform ( s ) ( iOS , Android , or both ? ) : Android * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : Both , Android 8.1 , Both
diff -- git a/example/src/app.js b/example/src/app.js index 0888370..027d78a 100644 -- - a/example/src/app.js +++ b/example/src/app.js @ @ -1,29 +1,31 @ @ import { Navigation } from 'react-native-navigation ' ; -import './screens/FirstTabScreen ' ; -import './screens/SecondTabScreen ' ; -import './screens/ThirdTabScreen ' ; -import './screens/SideMenu ' ; +//import and call the default function from each module +//The default function of a module should register all the pushable screens +import register1 from './module_1 ' ; +import register2 from './module_2 ' ; +register1 ( ) ; +register2 ( ) ; Navigation.startTabBasedApp ( { tabs : [ { label : 'One ' , - screen : 'example.FirstTabScreen ' , + screen : 'module_1.FirstTabScreen ' , icon : require ( '../img/one.png ' ) , selectedIcon : require ( '../img/one_selected.png ' ) , title : 'Screen One' } , { label : 'Two ' , - screen : 'example.SecondTabScreen ' , + screen : 'module_2.SecondTabScreen ' , icon : require ( '../img/two.png ' ) , selectedIcon : require ( '../img/two_selected.png ' ) , title : 'Screen Two' } , { label : 'Three ' , - screen : 'example.ThirdTabScreen ' , + screen : 'module_2.ThirdTabScreen ' , icon : require ( '../img/three.png ' ) , selectedIcon : require ( Can not build project if installed with npm2 __EoT__ To reproduce : - Clone the repository - Navigate to ` example ` - ` npm install ` using npm 2.x - ` react-native run-ios ` Build fails with error : ` Can not find RCCManager.h. ` Doing the same with npm 3.x works .
diff -- git a/docs/top-level-api.md b/docs/top-level-api.md index d007b88..253b9f4 100644 -- - a/docs/top-level-api.md +++ b/docs/top-level-api.md @ @ -44,7 +44,8 @ @ Navigation.startTabBasedApp ( { title : 'Screen One ' , // title of the screen as appears in the nav bar ( optional ) titleImage : require ( '../img/titleImage.png ' ) , // iOS only . navigation bar title image instead of the title text of the pushed screen ( optional ) navigatorStyle : { } , // override the navigator style for the tab screen , see `` Styling the navigator '' below ( optional ) , - navigatorButtons : { } // override the nav buttons for the tab screen , see `` Adding buttons to the navigator '' below ( optional ) + navigatorButtons : { } , // override the nav buttons for the tab screen , see `` Adding buttons to the navigator '' below ( optional ) + modal : false // Prevent tab selection and send a 'modalTabSelected ' navigator event instead ( optional , iOS only ) } , { label : 'Two ' , diff -- git a/ios/RCCTabBarController.m b/ios/RCCTabBarController.m index 7f5568b..7e290ca 100755 -- - a/ios/RCCTabBarController.m +++ b/ios/RCCTabBarController.m @ @ -14,6 +14,12 @ @ Can not build project if installed with npm2 __EoT__ To reproduce : - Clone the repository - Navigate to ` example ` - ` npm install ` using npm 2.x - ` react-native run-ios ` Build fails with error : ` Can not find RCCManager.h. ` Doing the same with npm 3.x works .
diff -- git a/docs/installation-ios.md b/docs/installation-ios.md index 3b7c9fc..26aa24c 100644 -- - a/docs/installation-ios.md +++ b/docs/installation-ios.md @ @ -15,8 +15,10 @ @ 4 . In Xcode , in Project Navigator ( left pane ) , click on your project ( top ) , then click on your *project* row ( on the `` project and targets list '' ) and select the ` Build Settings ` tab ( right pane ) . In the ` Header Search Paths ` section add ` $ ( SRCROOT ) /../node_modules/react-native-navigation/ios ` . Make sure on the right to mark this new path ` recursive ` ( [ screenshots ] ( https : //facebook.github.io/react-native/docs/linking-libraries-ios.html # step-3 ) ) 5 . In Xcode , you will need to edit this file : ` AppDelegate.m ` . -This function : - `` `` `` `` -- ( BOOL ) application : ( UIApplication * ) application didFinishLaunchingWithOptions : ( NSDictionary * ) launchOptions { ... } - `` `` `` `` -is the main entry point for your app . Its content must be replaced with the content of this [ reference ] ( https : //github.com/wix/react-native-navigation/blob/master/example/ios/example/AppDelegate.m ) + + This function : + `` `` `` `` + [ iOS ] navBarTextColor does n't change when setting it dynamically __EoT__ # # # Issue Description navBarTextColor does n't change when setting it dynamically on iOS . It worked in previous versions but in latest versions , it does not . Also , it works on Android . # # # Steps to Reproduce / Code Snippets / Screenshots Inside the component class : `` ` static navigatorStyle = { navBarTextColor : ' # 000000 ' , } ; `` ` Dynamically changing : `` ` this.props.navigator.setStyle ( { navBarTextColor : ' # FFFFFF' } ) ; `` ` Tried to put it in ` constructor ` , ` componentWillReceiveProps ` and ` render ` it does n't work anywhere . I need it in ` componentWillReceiveProps ` . ( also tried with ` nextProps ` ) -- - # # # Environment * React Native Navigation version : 1.1.398 * React Native version : 0.54 * Platform : iOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : Simulator , iPhone X , 11.2 , debug
diff -- git a/lib/android/app/build.gradle b/lib/android/app/build.gradle index 417a34d..85b6f09 100644 -- - a/lib/android/app/build.gradle +++ b/lib/android/app/build.gradle @ @ -57,6 +57,9 @ @ android { reactNative56 { dimension `` RNN.reactNativeVersion '' } + reactNative57 { + dimension `` RNN.reactNativeVersion '' + } } } diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java b/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java deleted file mode 100644 index 02cd1dc..0000000 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactNativeHost.java +++ /dev/null @ @ -1,108 +0,0 @ @ -package com.reactnativenavigation.react ; - -import android.app.Application ; -import android.support.annotation.NonNull ; -import android.support.annotation.Nullable ; - -import com.facebook.infer.annotation.Assertions ; -import com.facebook.react.ReactInstanceManager ; -import com.facebook.react.ReactInstanceManagerBuilder ; -import com.facebook.react.ReactNativeHost ; -import com.facebook.react.ReactPackage ; -import com.facebook.react.common.LifecycleState ; -import com.facebook.react.devsupport.interfaces.DevBundleDownloadListener ; -import com.facebook.react.shell.MainReactPackage ; -import com.reactnativenavigation.NavigationApplication ; - -import java.util.ArrayList ; -import java.util.List ; - -/** - * Default implementation of { @ link ReactNativeHost } that includes { @ link NavigationPackage } - * and user-defined additional packages . - */ -public class NavigationReactNativeHost extends ReactNativeHost implements BundleDownloadListenerProvider { - - private final boolean isDebug ; - private final List < ReactPackage > additionalReactPackages ; - private @ Nullable NavigationDevBundleDownloadListener bundleListener ; - private final DevBundleDownloadListener bundleListenerMediator = new DevBundleDownloadListenerAdapter ( ) { - @ Override - public void onSuccess ( ) { - if ( bundleListener ! = null ) { - [ V2 ] RNN and React Native version __EoT__ < ! -- Please post questions in Stack Overflow under the react-native-navigation tag https : //stackoverflow.com/questions/tagged/react-native-navigation -- > # # # Issue Description In the documentation ( android/app/build.gradle ) , android { ... defaultConfig { applicationId `` com.yourproject '' minSdkVersion rootProject.ext.minSdkVersion targetSdkVersion rootProject.ext.targetSdkVersion missingDimensionStrategy `` RNN.reactNativeVersion '' , `` reactNative56 '' // < == for rn0.57 what should i add here ? versionCode 1 versionName `` 1.0 '' ... } ... } # # # Environment * React Native Navigation version : `` ^2.0.2553 '' * React Native version : 16.5.0 * Platform ( s ) ( iOS , Android , or both ? ) : android * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : device
diff -- git a/example/src/screens/CustomNavBar.js b/example/src/screens/CustomNavBar.js new file mode 100644 index 0000000..1a2e699 -- - /dev/null +++ b/example/src/screens/CustomNavBar.js @ @ -0,0 +1,48 @ @ +import React , { Component } from 'react ' ; +import { + StyleSheet , + View , + TouchableOpacity , + Text , + Image + } from 'react-native ' ; + + +export default class CustomNavBar extends Component { + + constructor ( props ) { + super ( props ) ; + this.state = { + } ; + } + + render ( ) { + return ( + < View style= { styles.container } > + < TouchableOpacity onPress= { ( ) = > alert ( 'pressed ' ) } > + < Image source= { require ( './../../img/colors.png ' ) } / > + < /TouchableOpacity > + + < /View > + ) ; + } + } + +const styles = StyleSheet.create ( { + container : { + flex : 1 , + justifyContent : 'center ' , + alignItems : 'center ' , + backgroundColor : 'transparent' + } , + button : { + textAlign : 'center ' , + fontSize : 18 , + marginBottom : Hide labels in the nav bar ? __EoT__ Is there a way to hide the labels in the nav bar , similar to how Facebook and Instagram do ? I can set them to an empty string , but there are 2 problems : 1 . When I set the title in one of the screens in that tab bar , it then sets the label 2 . The spacing is off . The spot where the labels are supposed to be still seems to be there , pushing the icons up a little bit .
diff -- git a/example/src/screens/CustomNavBar.js b/example/src/screens/CustomNavBar.js new file mode 100644 index 0000000..efd80a1 -- - /dev/null +++ b/example/src/screens/CustomNavBar.js @ @ -0,0 +1,49 @ @ +import React , { Component } from 'react ' ; +import { + StyleSheet , + View , + TouchableOpacity , + Text , + Image + } from 'react-native ' ; + + +export default class CustomNavBar extends Component { + + constructor ( props ) { + super ( props ) ; + this.state = { + } ; + } + + render ( ) { + return ( + < View style= { styles.container } > + < TouchableOpacity stye= { styles.button } onPress= { ( ) = > alert ( 'Thanks for that : ) ' ) } > + < Text style= { { color : 'red ' , textAlign : 'center ' } } > Hi Custom < /Text > + < Text style= { { textAlign : 'center ' } } > Press Me < /Text > + < /TouchableOpacity > + + < /View > + ) ; + } + } + +const styles = StyleSheet.create ( { + container : { + flex : 1 , + Hide labels in the nav bar ? __EoT__ Is there a way to hide the labels in the nav bar , similar to how Facebook and Instagram do ? I can set them to an empty string , but there are 2 problems : 1 . When I set the title in one of the screens in that tab bar , it then sets the label 2 . The spacing is off . The spot where the labels are supposed to be still seems to be there , pushing the icons up a little bit .
diff -- git a/android/app/src/main/java/com/reactnativenavigation/params/StyleParams.java b/android/app/src/main/java/com/reactnativenavigation/params/StyleParams.java index 8a905b4..8da9a4c 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/params/StyleParams.java +++ b/android/app/src/main/java/com/reactnativenavigation/params/StyleParams.java @ @ -123,6 +123,7 @ @ public class StyleParams { public int titleBarHeight ; public boolean backButtonHidden ; public Font titleBarButtonFontFamily ; + public int titleBarTopPadding ; public Color topTabTextColor ; public Font topTabTextFontFamily ; diff -- git a/android/app/src/main/java/com/reactnativenavigation/params/parsers/StyleParamsParser.java b/android/app/src/main/java/com/reactnativenavigation/params/parsers/StyleParamsParser.java index 1e052ec..afa4519 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/params/parsers/StyleParamsParser.java +++ b/android/app/src/main/java/com/reactnativenavigation/params/parsers/StyleParamsParser.java @ @ -69,6 +69,7 @ @ public class StyleParamsParser { result.titleBarHeight = getInt ( `` titleBarHeight '' , getDefaultTitleBarHeight ( ) ) ; result.backButtonHidden = getBoolean ( `` backButtonHidden '' , getDefaultBackButtonHidden ( ) ) ; result.topTabsHidden = getBoolean ( `` topTabsHidden '' , getDefaultTopTabsHidden ( ) ) ; + result.titleBarTopPadding = getInt ( `` titleBarTopPadding '' , getTitleBarTopPadding ( ) ) ; result.topTabTextColor = getColor ( `` topTabTextColor '' , getDefaultTopTabTextColor ( ) ) ; result.topTabTextFontFamily = getFont ( `` topTabTextFontFamily '' , getDefaultTopTabTextFontFamily ( ) ) ; @ @ -328,6 +329,10 @ @ public class StyleParamsParser { return AppStyle.appStyle == null ? -1 : AppStyle.appStyle.titleBarHeight ; } + private int getTitleBarTopPadding ( ) { + return AppStyle.appStyle == null ? 0 : AppStyle.appStyle.titleBarTopPadding ; + } + private boolean getBoolean ( String key , boolean defaultValue ) Android drawer behind status bar __EoT__ The effect , better described in [ this ] ( https : //stackoverflow.com/questions/26913770/make-navigation-drawer-draw-behind-status-bar ) SO question , can not be achieved using React Native Navigation . It would be nice to have a translucent status bar option , that plays nicely with the navBar . On a side note , do you have any quick workaround for this ?
diff -- git a/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactGateway.java b/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactGateway.java index 2cf4785..6ddef18 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactGateway.java +++ b/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactGateway.java @ @ -98,7 +98,7 @ @ public class NavigationReactGateway implements ReactGateway { } @ Override - protected boolean getUseDeveloperSupport ( ) { + public boolean getUseDeveloperSupport ( ) { return NavigationApplication.instance.isDebug ( ) ; } diff -- git a/ios/Helpers/RCCTitleViewHelper.m b/ios/Helpers/RCCTitleViewHelper.m index 2eb70ed..e70af2b 100644 -- - a/ios/Helpers/RCCTitleViewHelper.m +++ b/ios/Helpers/RCCTitleViewHelper.m @ @ -7,13 +7,14 @ @ // # import `` RCCTitleViewHelper.h '' - # import `` RCTConvert.h '' - # import `` RCTHelpers.h '' - - @ implementation RCCTitleView - - @ end + # if __has_include ( < React/RCTConvert.h > ) + # import < React/RCTConvert.h > + # elif __has_include ( `` RCTConvert.h '' ) + # import `` RCTConvert.h '' + # elif __has_include ( `` React/RCTConvert.h '' ) + # import `` React/RCTConvert.h '' // Required when used as a Pod in a Swift project + # endif @ interface RCCTitleViewHelper ( ) diff -- git a/ios/Helpers/RCTHelpers.h b/ios/Helpers/RCTHelpers.h index a44f4b7..bbefe71 100644 -- - a/ios/Helpers/RCTHelpers.h +++ b/ios/Helpers/RCTHelpers.h @ @ -7,7 +7,7 @ @ // # import < Foundation/Foundation.h > - # import `` RCTRootView.h '' + # import < React/RCTRootView.h > @ interface RCTHelpers : NSObject RN > 0.40 Duplicate interface definition for class RCTBridge __EoT__ # # # Issue Description Build error when using ` react-native-navigation ` with ` react-native > = 0.40 ` - Init new app - Follow steps to install ` react-native-navigation ` - Build Side note . First noted when upgrading from ` RN 0.37.0 ` to ` RN 0.41.2 ` -- - # # # Environment * React Native Navigation version : ` next ` * React Native version : ` 0.41.2 ` * Platform ( s ) ( iOS , Android , or both ? ) : ` iOS ` * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : ` OS 10.2 ` **Follow up** There is already a pull request in place ( https : //github.com/wix/react-native-navigation/pull/652 ) , but as per @ DanielZlotin comment , this wo n't be merged in any time soon .
diff -- git a/ios/RCCNavigationController.h b/ios/RCCNavigationController.h index 84bf77f..607b5c9 100755 -- - a/ios/RCCNavigationController.h +++ b/ios/RCCNavigationController.h @ @ -1,8 +1,11 @ @ # import < UIKit/UIKit.h > # import < React/RCTBridge.h > + # import < React/RCTRootView.h > @ interface RCCNavigationController : UINavigationController < UINavigationControllerDelegate > + @ property ( strong , nonatomic ) RCTRootView *overlayView ; + - ( instancetype ) initWithProps : ( NSDictionary * ) props children : ( NSArray * ) children globalProps : ( NSDictionary* ) globalProps bridge : ( RCTBridge * ) bridge ; - ( void ) performAction : ( NSString* ) performAction actionParams : ( NSDictionary* ) actionParams bridge : ( RCTBridge * ) bridge ; diff -- git a/ios/RCCNavigationController.m b/ios/RCCNavigationController.m index bbf0e53..8b4b2fc 100755 -- - a/ios/RCCNavigationController.m +++ b/ios/RCCNavigationController.m @ @ -67,10 +67,49 @ @ NSString const *CALLBACK_ASSOCIATED_ID = @ '' RCCNavigationController.CALLBACK_ASSO [ self setRotation : props ] ; - + + NSString *overlayView = [ props valueForKeyPath : @ '' overlay.view '' ] ; + if ( overlayView ) { + // Pass navigation props + NSMutableDictionary *mutablePassPropsOverlay = [ passProps mutableCopy ] ; + NSDictionary *overlayProps = [ props valueForKeyPath : @ '' overlay.passProps '' ] ; + if ( overlayProps ) { [ V2 ] - Support drawing custom elements outside navigation stack __EoT__ # # # Issue Description I mentioned this in Discord , but did n't get a thumbs up or down from the Wix team , so I figured I 'd solidify it with an issue on here . Some devs at my company are considering becoming a core contributor to V2 , but we have some common client requests that do n't really work 100 % with the current navigation paradigm . The issue - We want to draw custom components outside of the navigation stack such as a custom menu overlay or other other external components . Many JS based implementations support drawing elements outside of the navigation stack to solve for this . # # # Steps to Reproduce / Code Snippets / Screenshots A solution ( with the current V1 syntax ) could look something like this : `` ` export default class App extends Component { constructor ( props ) { super ( props ) ; // ... _registerComponents ( ) .then ( ( ) = > { Navigation.startSingleScreenApp ( { screen : { screen : 'Home ' , title : 'Home ' ,
diff -- git a/ios/RCCViewController.m b/ios/RCCViewController.m index 5b3bdf7..2d56090 100755 -- - a/ios/RCCViewController.m +++ b/ios/RCCViewController.m @ @ -288,10 +288,24 @ @ const NSInteger TRANSPARENT_NAVBAR_TAG = 78264803 ; } ] ; } +// fix iOS11 safeArea - https : //github.com/facebook/react-native/issues/15681 +// rnn issue - https : //github.com/wix/react-native-navigation/issues/1858 +- ( void ) _traverseAndFixScrollViewSafeArea : ( UIView * ) view { + # ifdef __IPHONE_11_0 + if ( [ view isKindOfClass : UIScrollView.class ] ) { + [ ( ( UIScrollView* ) view ) setContentInsetAdjustmentBehavior : UIScrollViewContentInsetAdjustmentNever ] ; + } + + [ view.subviews enumerateObjectsUsingBlock : ^ ( __kindof UIView * _Nonnull obj , NSUInteger idx , BOOL * _Nonnull stop ) { + [ self _traverseAndFixScrollViewSafeArea : obj ] ; + } ] ; + # endif + + } + - ( void ) viewDidAppear : ( BOOL ) animated { [ super viewDidAppear : animated ] ; - [ self sendGlobalScreenEvent : @ '' didAppear '' endTimestampString : [ self getTimestampString ] shouldReset : YES ] ; [ self sendScreenChangedEvent : @ '' didAppear '' ] ; @ @ -300,6 +314,7 @ @ const NSInteger TRANSPARENT_NAVBAR_TAG = 78264803 ; - ( void ) viewWillAppear : ( BOOL ) animated { [ navBarHidden changes top of ScrollViews to -20 on iOS11 __EoT__ # # # Issue Description When ` navBarHidden : true ` is set on a screen the ScrollViews are broken and start with an initial value of -20 and can also scroll further up . When switching to another screen and going back the issue is solved , it just happens on the first render of a screen . # # # Steps to Reproduce / Code Snippets / Screenshots Set ` navBarHidden : true ` and log the scrollPosition of a ScrollView , I can setup a demo repo , if that helps . -- - # # # Environment * React Native Navigation version : 1.1.235 * React Native version : 0.47.2 * Platform ( s ) ( iOS , Android , or both ? ) : iOS11 * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : Device ( production ) , simulator ( debug )
diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/anim/StackAnimator.java b/lib/android/app/src/main/java/com/reactnativenavigation/anim/StackAnimator.java index d03fe0a..3bcceb7 100644 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/anim/StackAnimator.java +++ b/lib/android/app/src/main/java/com/reactnativenavigation/anim/StackAnimator.java @ @ -1,57 +1,109 @ @ package com.reactnativenavigation.anim ; -import android.content.Context ; -import android.content.res.TypedArray ; -import android.support.annotation.Nullable ; +import android.animation.Animator ; +import android.animation.AnimatorSet ; +import android.animation.ObjectAnimator ; +import android.app.Activity ; +import android.util.DisplayMetrics ; import android.view.View ; -import android.view.animation.Animation ; -import android.view.animation.AnimationUtils ; +import android.view.animation.AccelerateInterpolator ; +import android.view.animation.DecelerateInterpolator ; @ SuppressWarnings ( `` ResourceType '' ) public class StackAnimator { - private static int androidOpenEnterAnimResId ; - private static int androidOpenExitAnimResId ; - private static int androidCloseEnterAnimResId ; - private static int androidCloseExitAnimResId ; - private final Context context ; - - public StackAnimator ( Context context ) { - this.context = context ; - loadResIfNeeded ( context ) ; + public interface StackAnimationListener { + void onAnimationEnd ( ) ; } - private void loadResIfNeeded ( Context context ) { - if ( androidOpenEnterAnimResId > 0 ) return ; + private static final int DURATION = 300 ; + private static final int START_DELAY = 100 ; + private static final DecelerateInterpolator DECELERATE_INTERPOLATOR = new DecelerateInterpolator ( ) ; + private static final AccelerateInterpolator ACCELERATE_INTERPOLATOR = new AccelerateInterpolator ( ) ; + private float translationY ; - Merge options issue __EoT__ # # # Issue Description When we set new option for current screen and provide only this option , during merge all current options are replaced with default values of the new ones . # # # Steps to Reproduce / Code Snippets / Screenshots 1 . Create screen with bunch of options 2 . Create some button , that changes only one of them 3 . Hit it Result - all other options fade Expected result - only desirable option changes
diff -- git a/README.md b/README.md index c62f3fc..8d27f27 100644 -- - a/README.md +++ b/README.md @ @ -75,7 +75,7 @ @ Note : v1 properties with names beginning with 'navBar ' are replaced in v2 with | topBarTextFontFamily | ✅ | ✅ | ✅ | Wix | | topBarBackgroundColor | ✅ | ✅ | ✅ | Wix| | topBarButtonColor | ✅ | ✅ | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | Wix| -| topBarHidden | ✅ | ✅ | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | Wix| +| topBarHidden | ✅ | ✅ | ✅ | Wix| | topBarHideOnScroll | ✅ | ✅ | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | Wix| | topBarTranslucent | ✅ | ✅ | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | Wix| | topBarTransparent | ✅ | WIP @ bogobogo | [ Contribute ] ( /docs/docs/CONTRIBUTING.md ) | diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/anim/StackAnimator.java b/lib/android/app/src/main/java/com/reactnativenavigation/anim/StackAnimator.java index d03fe0a..18f16e8 100644 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/anim/StackAnimator.java +++ b/lib/android/app/src/main/java/com/reactnativenavigation/anim/StackAnimator.java @ @ -1,57 +1,220 @ @ package com.reactnativenavigation.anim ; +import android.animation.Animator ; +import android.animation.AnimatorSet ; +import android.animation.ObjectAnimator ; +import android.animation.ValueAnimator ; +import android.app.Activity ; import android.content.Context ; -import android.content.res.TypedArray ; import android.support.annotation.Nullable ; +import android.util.DisplayMetrics ; +import android.util.Log ; import android.view.View ; -import android.view.animation.Animation ; -import Merge options issue __EoT__ # # # Issue Description When we set new option for current screen and provide only this option , during merge all current options are replaced with default values of the new ones . # # # Steps to Reproduce / Code Snippets / Screenshots 1 . Create screen with bunch of options 2 . Create some button , that changes only one of them 3 . Hit it Result - all other options fade Expected result - only desirable option changes
diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/viewcontrollers/BottomTabsController.java b/lib/android/app/src/main/java/com/reactnativenavigation/viewcontrollers/BottomTabsController.java index 1cde90e..2e3574e 100644 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/viewcontrollers/BottomTabsController.java +++ b/lib/android/app/src/main/java/com/reactnativenavigation/viewcontrollers/BottomTabsController.java @ @ -5,6 +5,8 @ @ import android.graphics.drawable.Drawable ; import android.support.annotation.IntRange ; import android.support.annotation.NonNull ; import android.view.ViewGroup ; +import android.widget.FrameLayout ; +import android.widget.LinearLayout ; import android.widget.RelativeLayout ; import com.aurelhubert.ahbottomnavigation.AHBottomNavigation ; @ @ -25,29 +27,35 @ @ import java.util.List ; import static android.view.ViewGroup.LayoutParams.MATCH_PARENT ; import static android.view.ViewGroup.LayoutParams.WRAP_CONTENT ; import static android.widget.RelativeLayout.ABOVE ; -import static android.widget.RelativeLayout.ALIGN_PARENT_BOTTOM ; public class BottomTabsController extends ParentController implements AHBottomNavigation.OnTabSelectedListener , NavigationOptionsListener { - private BottomTabs bottomTabs ; - private List < ViewController > tabs = new ArrayList < > ( ) ; + private FrameLayout tabContentContainer ; + private BottomTabs bottomTabs ; + private List < ViewController > tabs = new ArrayList < > ( ) ; private ImageLoader imageLoader ; public BottomTabsController ( final Activity activity , ImageLoader imageLoader , final String id , Options initialOptions ) { - super ( activity , id , initialOptions ) ; + super ( activity , id , initialOptions ) ; this.imageLoader = imageLoader ; } - @ NonNull - @ Override - protected ViewGroup createView ( ) { - RelativeLayout root = new RelativeLayout ( getActivity ( ) ) ; - bottomTabs = new BottomTabs [ V2 ] [ Android ] IndexOutOfBoundsException __EoT__ # # # Issue Description When creating a bottom tabs navigation with no default tab selected , the app crashes with exception . Looking a the logs it seems like the default passed is '-1' # # # Steps to Reproduce / Code Snippets / Screenshots index.js : `` ` js Navigation.registerComponent ( A.navigationId , ( ) = > AScene ) ; Navigation.registerComponent ( B.navigationId , ( ) = > BScene ) ; `` ` AScene , BScene `` ` js static get options ( ) : NavigationOptions { return { topBar : { ... . } , bottomTab : { title : `` A '' , icon : iconA , } } ; } `` ` This is the actual stacktrace : `` ` java.lang.ArrayIndexOutOfBoundsException : length=12 ; index=-1 at java.util.ArrayList.get ( ArrayList.java:310 ) at com.reactnativenavigation.viewcontrollers.bottomtabs.BottomTabsController.getCurrentView ( BottomTabsController.java:158 ) at com.reactnativenavigation.viewcontrollers.bottomtabs.BottomTabsController.selectTabAtIndex ( BottomTabsController.java:153 ) at com.reactnativenavigation.viewcontrollers.bottomtabs.BottomTabsController.onTabSelected ( BottomTabsController.java:95 ) at com.aurelhubert.ahbottomnavigation.AHBottomNavigation.updateSmallItems ( AHBottomNavigation.java:763 ) at com.aurelhubert.ahbottomnavigation.AHBottomNavigation.setCurrentItem ( AHBottomNavigation.java:1209 ) at com.aurelhubert.ahbottomnavigation.AHBottomNavigation.setCurrentItem ( AHBottomNavigation.java:1190 ) at com.reactnativenavigation.views.BottomTabs.setCurrentItem ( BottomTabs.java:31 ) at com.reactnativenavigation.presentation.BottomTabsOptionsPresenter.applyBottomTabsOptions ( BottomTabsOptionsPresenter.java:41 ) at com.reactnativenavigation.presentation.BottomTabsOptionsPresenter.present ( BottomTabsOptionsPresenter.java:23 ) at com.reactnativenavigation.viewcontrollers.bottomtabs.BottomTabsController.applyOptions ( BottomTabsController.java:55 ) at com.reactnativenavigation.viewcontrollers.ViewController.onViewAppeared ( ViewController.java:150 ) at com.reactnativenavigation.viewcontrollers.ViewController.onGlobalLayout
diff -- git a/lib/ios/RNNAnimationOptions.m b/lib/ios/RNNAnimationOptions.m index 1f42104..6c6cb94 100644 -- - a/lib/ios/RNNAnimationOptions.m +++ b/lib/ios/RNNAnimationOptions.m @ @ -7,10 +7,6 @ @ @ implementation RNNAnimationOptions - ( instancetype ) initWithDict : ( NSDictionary * ) dict { - if ( ! dict [ @ '' animations '' ] ) { - return nil ; - } - return [ super initWithDict : dict ] ; } diff -- git a/lib/ios/RNNAnimator.m b/lib/ios/RNNAnimator.m index 76a636b..ee94560 100644 -- - a/lib/ios/RNNAnimator.m +++ b/lib/ios/RNNAnimator.m @ @ -12,7 +12,7 @ @ - ( instancetype ) initWithTransitionOptions : ( RNNAnimationOptions * ) transitionOptions { self = [ super init ] ; - if ( transitionOptions ) { + if ( transitionOptions.animations ) { [ self setupTransition : transitionOptions ] ; } else { return nil ; @ @ -47,11 +47,7 @ @ - ( void ) animateTransitions : ( NSArray* ) transitions { for ( RNNTransition* transition in transitions ) { - [ UIView animateWithDuration : transition.options.duration delay : transition.options.startDelay usingSpringWithDamping : transition.options.springDamping initialSpringVelocity : transition.options.springVelocity options : UIViewAnimationOptionCurveEaseOut animations : ^ { - [ transition setAnimatedViewFinalProperties ] ; - } completion : ^ ( BOOL finished ) { - - } ] ; + [ transition animate ] ; [ v2 ] passProps for topBar buttons not working __EoT__ # # # Issue Description I am trying to add a component for one of the ` leftButtons ` in the ` topBar ` but it wo n't pass the props needed for the component . I only get this : componentId rootTag # # # Steps to Reproduce / Code Snippets / Screenshots `` ` topBar : { title : 'Main ' , textColor : 'white ' , textFontSize : 16 , backgroundColor : 'black ' , leftButtons : [ { component : 'navigation.Icon ' , passProps : { name : 'menu ' , size : 24 , color : 'white' } , title : 'action ' , id : 'bebeb' } ] } `` ` -- - # # # Environment * React Native Navigation version : 2.0.2124 * React Native version : 0.53.0 * Platform ( s ) ( iOS , Android , or both ? ) : iOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : Simulator
diff -- git a/ios/Helpers/RCCTitleViewHelper.m b/ios/Helpers/RCCTitleViewHelper.m index 4309166..1ea7bbf 100644 -- - a/ios/Helpers/RCCTitleViewHelper.m +++ b/ios/Helpers/RCCTitleViewHelper.m @ @ -156,7 +156,8 @ @ navigationController : ( UINavigationController* ) navigationController CGRect labelframe = subtitleLabel.frame ; labelframe.size = labelSize ; subtitleLabel.frame = labelframe ; - + [ subtitleLabel sizeToFit ] ; + [ self.titleView addSubview : subtitleLabel ] ; return subtitleLabel ; The title get 's truncated/trimmed for some reason . __EoT__ Hey there.. Any idea why the nav bar title is truncated/trimmed on some screens but not others ? Here I got the word ` Client ` ( 6 characters ) . If I type ` Clien ` ( 5 character it shows ) but if it 's 6 characters it get 's trimmed ( shows ` ... ` at the end ) . On other screens I had success using 15 character words with no problem at all . < img width= '' 616 '' alt= '' screen shot 2017-02-14 at 21 54 10 '' src= '' https : //cloud.githubusercontent.com/assets/3070948/22946775/1a30ad12-f301-11e6-8f5d-b4f6e9015a36.png '' > Also if I add a space before the word ` Client ` or if I type a second word like ` Client Name ` the problem goes away and I get the full title.. Any ideas ? thanks
diff -- git a/controllers/index.js b/controllers/index.js index 2e1cb11..49f8fd4 100755 -- - a/controllers/index.js +++ b/controllers/index.js @ @ -170,6 +170,10 @ @ var Controllers = { } RCCManager.NavigationControllerIOS ( id , `` setTitle '' , params ) ; } , + setStyle : function ( params ) { + _processProperties ( params ) ; + RCCManager.NavigationControllerIOS ( id , `` setStyle '' , params ) ; + } , resetTo : function ( params ) { var unsubscribes = [ ] ; if ( params [ 'style ' ] ) { diff -- git a/ios/Helpers/RCTHelpers.h b/ios/Helpers/RCTHelpers.h index 6f8602c..6965a54 100644 -- - a/ios/Helpers/RCTHelpers.h +++ b/ios/Helpers/RCTHelpers.h @ @ -11,4 +11,6 @ @ @ interface RCTHelpers : NSObject + ( BOOL ) removeYellowBox : ( RCTRootView* ) reactRootView ; ++ ( NSMutableDictionary * ) textAttributesFromDictionary : ( NSDictionary * ) dictionary withPrefix : ( NSString * ) prefix ; ++ ( NSMutableDictionary * ) textAttributesFromDictionary : ( NSDictionary * ) dictionary withPrefix : ( NSString * ) prefix baseFontSize : ( CGFloat ) size ; @ end diff -- git a/ios/Helpers/RCTHelpers.m b/ios/Helpers/RCTHelpers.m index 7bb4b49..62025a3 100644 -- - a/ios/Helpers/RCTHelpers.m +++ b/ios/Helpers/RCTHelpers.m @ @ -9,6 +9,7 @ @ # import `` RCTHelpers.h '' # import `` RCTView.h '' Change the Navigation Style/Color at Runtime __EoT__ Is it possible to change the color of the navigation bar at runtime ? Even if it requires some changes to the Objective-C code ( iOS ) does anyone know if this would be possible to add such a method to the API ? Something like Navigation.setStyle ( { ... } ) ; instead of it being applied with a screen push or static on the screen . Related : https : //github.com/wix/react-native-navigation/issues/519 https : //github.com/wix/react-native-navigation/issues/466 **Update : ** This was functionality was recently added @ simonmitchell 🥇 PR : https : //github.com/wix/react-native-navigation/pull/307 Here is how to use the new functionality : `` ` this.props.navigator.setStyle ( { ... navigationStyles.opaque , navBarTransparent : true , navBarTranslucent : false , extendedLayoutIncludesOpaqueBars : true } ) ; `` `
diff -- git a/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java b/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java index 6840904..a44d206 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java +++ b/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java @ @ -127,7 +127,7 @ @ public class NavigationActivity extends AppCompatActivity implements DefaultHard @ Override public void onActivityResult ( int requestCode , int resultCode , Intent data ) { - NavigationApplication.instance.getReactGateway ( ) .onActivityResult ( requestCode , resultCode , data ) ; + NavigationApplication.instance.getReactGateway ( ) .onActivityResult ( this , requestCode , resultCode , data ) ; } @ Override diff -- git a/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactGateway.java b/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactGateway.java index 58d5eec..5640e0e 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactGateway.java +++ b/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactGateway.java @ @ -69,8 +69,8 @ @ public class NavigationReactGateway implements ReactGateway { getReactInstanceManager ( ) .onHostResume ( activity , defaultHardwareBackBtnHandler ) ; } - public void onActivityResult ( int requestCode , int resultCode , Intent data ) { - getReactInstanceManager ( ) .onActivityResult ( requestCode , resultCode , data ) ; + public void onActivityResult ( Activity activity , int requestCode , int resultCode , Intent data ) { + getReactInstanceManager ( ) .onActivityResult ( activity , requestCode , resultCode , data ) ; } public ReactNativeHost getReactNativeHost ( ) { diff -- git a/android/app/src/main/java/com/reactnativenavigation/react/ReactGateway.java b/android/app/src/main/java/com/reactnativenavigation/react/ReactGateway.java index c076b84..b48daa7 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/react/ReactGateway.java +++ b/android/app/src/main/java/com/reactnativenavigation/react/ReactGateway.java @ @ -28,5 +28,5 @ @ public interface ReactGateway { Change the Navigation Style/Color at Runtime __EoT__ Is it possible to change the color of the navigation bar at runtime ? Even if it requires some changes to the Objective-C code ( iOS ) does anyone know if this would be possible to add such a method to the API ? Something like Navigation.setStyle ( { ... } ) ; instead of it being applied with a screen push or static on the screen . Related : https : //github.com/wix/react-native-navigation/issues/519 https : //github.com/wix/react-native-navigation/issues/466 **Update : ** This was functionality was recently added @ simonmitchell 🥇 PR : https : //github.com/wix/react-native-navigation/pull/307 Here is how to use the new functionality : `` ` this.props.navigator.setStyle ( { ... navigationStyles.opaque , navBarTransparent : true , navBarTranslucent : false , extendedLayoutIncludesOpaqueBars : true } ) ; `` `
diff -- git a/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java b/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java index 7068d30..0c8e8a7 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java +++ b/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java @ @ -43,6 +43,7 @ @ import javax.annotation.Nullable ; */ public abstract class BaseReactActivity extends AppCompatActivity implements DefaultHardwareBackBtnHandler { + protected static final String KEY_TITLE = `` title '' ; private static final String TAG = `` BaseReactActivity '' ; private static final String REDBOX_PERMISSION_MESSAGE = `` Overlay permissions needs to be granted in order for react native apps to run in dev mode '' ; @ @ -175,6 +176,7 @ @ public abstract class BaseReactActivity extends AppCompatActivity implements Def public void setNavigationStyle ( Screen screen ) { if ( mToolbar ! = null ) { mToolbar.setStyle ( screen ) ; + mToolbar.update ( screen ) ; } StyleHelper.setWindowStyle ( getWindow ( ) , this , screen ) ; @ @ -219,13 +221,10 @ @ public abstract class BaseReactActivity extends AppCompatActivity implements Def @ CallSuper public void push ( Screen screen ) { setNavigationStyle ( screen ) ; - if ( mToolbar ! = null ) { - mToolbar.update ( screen ) ; - - if ( getCurrentNavigatorId ( ) .equals ( screen.navigatorId ) & & - getScreenStackSize ( ) > = 1 ) { - mToolbar.showBackButton [ Android ] - drawer , navigatorStyle , NavigatorEvent not working __EoT__ Hi , I am testing Example project on Android . Drawer ( Sidemenu ) : navicon_menu.png icon not show NavigatorStyle : allway show gray background color NavigatorEvent not working ! [ screen shot 2016-06-22 at 12 36 11 am ] ( https : //cloud.githubusercontent.com/assets/19372005/16239919/60e02fea-3811-11e6-8a26-504ff602ae4f.png )
diff -- git a/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java b/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java index 7068d30..ceeb7f5 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java +++ b/android/app/src/main/java/com/reactnativenavigation/activities/BaseReactActivity.java @ @ -43,6 +43,11 @ @ import javax.annotation.Nullable ; */ public abstract class BaseReactActivity extends AppCompatActivity implements DefaultHardwareBackBtnHandler { + protected static final String KEY_ANIMATED = `` animated '' ; + protected static final String KEY_BADGE = `` badge '' ; + protected static final String KEY_HIDDEN = `` hidden '' ; + protected static final String KEY_TAB_INDEX = `` tabIndex '' ; + protected static final String KEY_TITLE = `` title '' ; private static final String TAG = `` BaseReactActivity '' ; private static final String REDBOX_PERMISSION_MESSAGE = `` Overlay permissions needs to be granted in order for react native apps to run in dev mode '' ; @ @ -175,6 +180,7 @ @ public abstract class BaseReactActivity extends AppCompatActivity implements Def public void setNavigationStyle ( Screen screen ) { if ( mToolbar ! = null ) { mToolbar.setStyle ( screen ) ; + mToolbar.update ( screen ) ; } StyleHelper.setWindowStyle ( getWindow ( ) , this , screen ) ; @ @ -219,13 +225,10 @ @ public abstract class BaseReactActivity extends AppCompatActivity implements Def @ CallSuper public void push ( Screen screen ) { [ Android ] - drawer , navigatorStyle , NavigatorEvent not working __EoT__ Hi , I am testing Example project on Android . Drawer ( Sidemenu ) : navicon_menu.png icon not show NavigatorStyle : allway show gray background color NavigatorEvent not working ! [ screen shot 2016-06-22 at 12 36 11 am ] ( https : //cloud.githubusercontent.com/assets/19372005/16239919/60e02fea-3811-11e6-8a26-504ff602ae4f.png )
diff -- git a/lib/ios/RNNBottomTabOptions.m b/lib/ios/RNNBottomTabOptions.m index 502cf64..2ec8fdf 100644 -- - a/lib/ios/RNNBottomTabOptions.m +++ b/lib/ios/RNNBottomTabOptions.m @ @ -13,8 +13,9 @ @ } - ( void ) applyOn : ( UIViewController * ) viewController { + UIViewController* topViewController = [ self getTabControllerFirstChild : viewController ] ; if ( self.text || self.icon || self.selectedIcon ) { - UITabBarItem* tabItem = viewController.tabBarItem ; + UITabBarItem* tabItem = topViewController.tabBarItem ; tabItem.selectedImage = [ self getSelectedIconImage ] ; tabItem.image = [ self getIconImage ] ; @ @ -38,7 +39,7 @ @ [ self appendTitleAttributes : tabItem ] ; - [ viewController setTabBarItem : tabItem ] ; + [ topViewController setTabBarItem : tabItem ] ; } if ( self.badge ) { @ @ -46,10 +47,7 @ @ if ( self.badge ! = nil & & ! [ self.badge isEqual : [ NSNull null ] ] ) { badge = [ RCTConvert NSString : self.badge ] ; } - UITabBarItem *tabBarItem = viewController.tabBarItem ; - if ( viewController.navigationController ) { - tabBarItem = viewController.navigationController.tabBarItem ; - } + UITabBarItem *tabBarItem = topViewController.tabBarItem ; tabBarItem.badgeValue = badge ; if ( self.badgeColor ) { tabBarItem.badgeColor = [ RCTConvert UIColor : self.badgeColor ] ; @ @ -61,7 +59,7 @ @ } if [ V2 ] [ iOS ] Sidemenu layout inside bottomTabs layout weird behaviour __EoT__ # # # Issue Description Sidemenu layout inside bottomTabs layout bugs out on iOS . The icon disappears and a black bar appears under as if it is miscalculating the bottomTabs height . Works perfectly on Android . I also noticed that merging options for the sidemenu layout on iOS fails . So trying to open/close the sidemenu with a button using the sidemenu 's components ID fails . # # # Steps to Reproduce / Code Snippets / Screenshots Notice how the icon dissapears and there is a black bar ? Layout looks like : `` ` js root : { bottomTabs : { children : [ { // Tab 1 - Homescreen stack : { children : [ { component : { name : 'baseNet.HomeTab ' , } , } , ] , options : { bottomTab : { text : 'Home ' , icon : loadedIconSource [ 'fa-home ' ] , } , } , } , } , { // Tab 2 - Email < -- -- THIS ONE GIVES PROBLEMS sideMenu : { id : 'baseNet.EmailSideMenu ' , left : {
diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/NavigationActivity.java b/lib/android/app/src/main/java/com/reactnativenavigation/NavigationActivity.java index f71085d..d7bd9ac 100644 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/NavigationActivity.java +++ b/lib/android/app/src/main/java/com/reactnativenavigation/NavigationActivity.java @ @ -1,27 +1,26 @ @ package com.reactnativenavigation ; import android.annotation.TargetApi ; -import android.support.annotation.NonNull ; - import android.content.Intent ; -import android.os.Bundle ; import android.os.Build ; +import android.os.Bundle ; +import android.support.annotation.NonNull ; import android.support.annotation.Nullable ; import android.support.v7.app.AppCompatActivity ; import android.view.KeyEvent ; import android.view.View ; import com.facebook.react.modules.core.DefaultHardwareBackBtnHandler ; +import com.facebook.react.modules.core.PermissionAwareActivity ; +import com.facebook.react.modules.core.PermissionListener ; import com.reactnativenavigation.presentation.OverlayManager ; +import com.reactnativenavigation.react.JsDevReloadHandler ; import com.reactnativenavigation.react.ReactGateway ; import com.reactnativenavigation.utils.CommandListenerAdapter ; import com.reactnativenavigation.viewcontrollers.ChildControllersRegistry ; import com.reactnativenavigation.viewcontrollers.Navigator ; -import com.facebook.react.modules.core.PermissionAwareActivity ; -import com.facebook.react.modules.core.PermissionListener ; - -public class NavigationActivity extends AppCompatActivity implements DefaultHardwareBackBtnHandler , PermissionAwareActivity { +public class NavigationActivity extends AppCompatActivity implements DefaultHardwareBackBtnHandler , PermissionAwareActivity , JsDevReloadHandler.ReloadListener { @ Nullable private PermissionListener mPermissionListener ; @ @ -32,7 +31,6 @ @ public class NavigationActivity extends AppCompatActivity implements DefaultHard super.onCreate ( savedInstanceState ) ; navigator = new Navigator ( this , new ChildControllersRegistry ( ) , new OverlayManager ( ) ) ; getReactGateway ( ) .onActivityCreated ( this ) ; - getReactGateway ( ) .addReloadListener ( navigator ) ; navigator.getView ( ) .setSystemUiVisibility ( View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN ) ; setContentView ( navigator.getView ( ) ) ; } @ @ -53,7 +51,6 @ @ public class NavigationActivity extends AppCompatActivity implements DefaultHard Duplicated render of componentDidMount and the render method __EoT__ # # # Issue Description Whether in a single screen app or a tabbased one , when you for example log something in componentDidMount or the render method , it logs twice . # # # Steps to Reproduce / Code Snippets / Screenshots < img width= '' 384 '' alt= '' screen shot 2018-07-02 at 12 14 36 am '' src= '' https : //user-images.githubusercontent.com/29271309/42138083-ffd3ac68-7d8c-11e8-917a-bc844041d0cd.png '' > < img width= '' 931 '' alt= '' screen shot 2018-07-02 at 12 16 04 am '' src= '' https : //user-images.githubusercontent.com/29271309/42138105-4546a44e-7d8d-11e8-9660-a2d1f18ac453.png '' > Note that I 'm using one file for each of my tab pages . so it logs 4 times 👎 `` ` Navigation.setRoot ( { root : { bottomTabs : { children : [ { stack : { children : [ { component : { name : 'Sign ' , } } ] , options : { bottomTab : { title : 'Tab 1 ' , icon : require ( './assets/images/my-offers.png ' ) , testID : 'FIRST_TAB_BAR_BUTTON' } } } } , { component : { name : 'Sign ' , passProps : { text : 'This is tab
diff -- git a/.gitignore b/.gitignore index 9d27656..37f13b2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -210,5 +210,20 @ @ npm-debug.log # BUCK buck-out/ \.buckd/ + + # IDE files android/app/libs android/keystores/debug.keystore +AndroidE2E/.project +AndroidE2E/app/.project +lib/android/.project +playground/android/.project +AndroidE2E/app/.classpath +AndroidE2E/app/.settings/ +AndroidE2E/app/bin/ +lib/android/.settings/ +lib/android/app/.settings/ +playground/android/.settings/ +playground/android/app/.settings/ +AndroidE2E/.settings/ + diff -- git a/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/OverlayTest.java b/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/OverlayTest.java index 5072262..627470f 100644 -- - a/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/OverlayTest.java +++ b/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/OverlayTest.java @ @ -12,9 +12,8 @ @ public class OverlayTest extends BaseTest { public void testOverlayAlertAppear ( ) throws Exception { elementByText ( `` PUSH OPTIONS SCREEN '' ) .click ( ) ; elementByText ( `` SHOW ALERT '' ) .click ( ) ; - assertExists ( By.text ( `` test ! `` ) ) ; + assertExists ( By.text ( `` Test view '' ) ) ; elementByText ( `` OK '' ) .click ( ) ; assertExists ( By.text ( `` Static Title '' ) ) ; - } } diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/parse/ButtonOptions.java b/lib/android/app/src/main/java/com/reactnativenavigation/parse/ButtonOptions.java new file mode 100644 index 0000000..6844374 -- - /dev/null +++ b/lib/android/app/src/main/java/com/reactnativenavigation/parse/ButtonOptions.java @ @ -0,0 +1,35 @ @ +package com.reactnativenavigation.parse ; + + +import org.json.JSONObject ; + +public class ButtonOptions { + + public static ButtonOptions parse ( JSONObject json ) { + ButtonOptions options = new ButtonOptions Issue with showing several alerts in a row __EoT__ # # # Issue Description Showing second alert closes previous one # # # Steps to Reproduce / Code Snippets / Screenshots If you run code like this , both alert will be shown , one under another . `` ` alert ( `` Alert 1 '' ) ; alert ( `` Alert 2 '' ) ; `` ` If you run code like this , second after showing second alert , previous one disappears `` ` alert ( 'Alert 1 ' ) ; setTimeout ( ( ) = > { alert ( 'Alert 2 ' ) ; } , SOME_DELAY ) ; `` ` -- - # # # Environment * React Native Navigation version : v2 * React Native version : 0.44.0 * Platform ( s ) ( iOS , Android , or both ? ) : Android * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : Emulator , API 26
diff -- git a/.gitignore b/.gitignore index 9d27656..37f13b2 100644 -- - a/.gitignore +++ b/.gitignore @ @ -210,5 +210,20 @ @ npm-debug.log # BUCK buck-out/ \.buckd/ + + # IDE files android/app/libs android/keystores/debug.keystore +AndroidE2E/.project +AndroidE2E/app/.project +lib/android/.project +playground/android/.project +AndroidE2E/app/.classpath +AndroidE2E/app/.settings/ +AndroidE2E/app/bin/ +lib/android/.settings/ +lib/android/app/.settings/ +playground/android/.settings/ +playground/android/app/.settings/ +AndroidE2E/.settings/ + diff -- git a/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/OverlayTest.java b/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/OverlayTest.java index 5072262..cbac9ec 100644 -- - a/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/OverlayTest.java +++ b/AndroidE2E/app/src/androidTest/java/com/reactnativenavigation/e2e/androide2e/OverlayTest.java @ @ -11,10 +11,16 @ @ public class OverlayTest extends BaseTest { @ Test public void testOverlayAlertAppear ( ) throws Exception { elementByText ( `` PUSH OPTIONS SCREEN '' ) .click ( ) ; - elementByText ( `` SHOW ALERT '' ) .click ( ) ; - assertExists ( By.text ( `` test ! `` ) ) ; + elementByText ( `` SHOW CUSTOM ALERT '' ) .click ( ) ; + assertExists ( By.text ( `` Test view '' ) ) ; elementByText ( `` OK '' ) .click ( ) ; assertExists ( By.text ( `` Static Title '' ) ) ; + } + @ Test + public void testSnackbarAppear ( ) throws Exception { + elementByText ( `` PUSH OPTIONS SCREEN '' ) .click ( ) ; + elementByText ( `` SHOW SNACKBAR '' ) .click ( ) ; Issue with showing several alerts in a row __EoT__ # # # Issue Description Showing second alert closes previous one # # # Steps to Reproduce / Code Snippets / Screenshots If you run code like this , both alert will be shown , one under another . `` ` alert ( `` Alert 1 '' ) ; alert ( `` Alert 2 '' ) ; `` ` If you run code like this , second after showing second alert , previous one disappears `` ` alert ( 'Alert 1 ' ) ; setTimeout ( ( ) = > { alert ( 'Alert 2 ' ) ; } , SOME_DELAY ) ; `` ` -- - # # # Environment * React Native Navigation version : v2 * React Native version : 0.44.0 * Platform ( s ) ( iOS , Android , or both ? ) : Android * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : Emulator , API 26
diff -- git a/docs/top-level-api.md b/docs/top-level-api.md index 22c04bf..6994780 100644 -- - a/docs/top-level-api.md +++ b/docs/top-level-api.md @ @ -39,7 +39,8 @ @ Navigation.startTabBasedApp ( { title : 'Screen One ' , // title of the screen as appears in the nav bar ( optional ) titleImage : require ( '../img/titleImage.png ' ) , // iOS only . navigation bar title image instead of the title text of the pushed screen ( optional ) navigatorStyle : { } , // override the navigator style for the tab screen , see `` Styling the navigator '' below ( optional ) , - navigatorButtons : { } // override the nav buttons for the tab screen , see `` Adding buttons to the navigator '' below ( optional ) + navigatorButtons : { } , // override the nav buttons for the tab screen , see `` Adding buttons to the navigator '' below ( optional ) + modal : false // prevent tab selection and send a 'modalTabSelected ' navigator event instead ( optional ) } , { label : 'Two ' , diff -- git a/ios/RCCTabBarController.m b/ios/RCCTabBarController.m index cd9c749..b3c7bca 100755 -- - a/ios/RCCTabBarController.m +++ b/ios/RCCTabBarController.m @ @ -14,6 +14,12 @ @ @ end + Open a modal from tab bar __EoT__ https : //stackoverflow.com/questions/48857262/open-modal-from-tab-bar **Issue Description** I have 3 tabs and I want to open a modal when the user presses on the second tab at the moment it just navigates to the screen . There was another issue raised for this but was closed without any solution . https : //github.com/wix/react-native-navigation/issues/55 I really like this library and do n't want to switch because of this issue so any help would be greatly appreciated . Thanks
diff -- git a/docs/top-level-api.md b/docs/top-level-api.md index d007b88..253b9f4 100644 -- - a/docs/top-level-api.md +++ b/docs/top-level-api.md @ @ -44,7 +44,8 @ @ Navigation.startTabBasedApp ( { title : 'Screen One ' , // title of the screen as appears in the nav bar ( optional ) titleImage : require ( '../img/titleImage.png ' ) , // iOS only . navigation bar title image instead of the title text of the pushed screen ( optional ) navigatorStyle : { } , // override the navigator style for the tab screen , see `` Styling the navigator '' below ( optional ) , - navigatorButtons : { } // override the nav buttons for the tab screen , see `` Adding buttons to the navigator '' below ( optional ) + navigatorButtons : { } , // override the nav buttons for the tab screen , see `` Adding buttons to the navigator '' below ( optional ) + modal : false // Prevent tab selection and send a 'modalTabSelected ' navigator event instead ( optional , iOS only ) } , { label : 'Two ' , diff -- git a/ios/RCCTabBarController.m b/ios/RCCTabBarController.m index 7f5568b..7e290ca 100755 -- - a/ios/RCCTabBarController.m +++ b/ios/RCCTabBarController.m @ @ -14,6 +14,12 @ @ Open a modal from tab bar __EoT__ https : //stackoverflow.com/questions/48857262/open-modal-from-tab-bar **Issue Description** I have 3 tabs and I want to open a modal when the user presses on the second tab at the moment it just navigates to the screen . There was another issue raised for this but was closed without any solution . https : //github.com/wix/react-native-navigation/issues/55 I really like this library and do n't want to switch because of this issue so any help would be greatly appreciated . Thanks
diff -- git a/docs/top-level-api.md b/docs/top-level-api.md index 4c91e2d..6786e8c 100644 -- - a/docs/top-level-api.md +++ b/docs/top-level-api.md @ @ -44,7 +44,8 @ @ Navigation.startTabBasedApp ( { title : 'Screen One ' , // title of the screen as appears in the nav bar ( optional ) titleImage : require ( '../img/titleImage.png ' ) , // iOS only . navigation bar title image instead of the title text of the pushed screen ( optional ) navigatorStyle : { } , // override the navigator style for the tab screen , see `` Styling the navigator '' below ( optional ) , - navigatorButtons : { } // override the nav buttons for the tab screen , see `` Adding buttons to the navigator '' below ( optional ) + navigatorButtons : { } , // override the nav buttons for the tab screen , see `` Adding buttons to the navigator '' below ( optional ) + modal : false // Prevent tab selection and send a 'modalTabSelected ' navigator event instead ( optional , iOS only ) } , { label : 'Two ' , diff -- git a/ios/RCCTabBarController.m b/ios/RCCTabBarController.m index 6c5fa9d..42227e3 100755 -- - a/ios/RCCTabBarController.m +++ b/ios/RCCTabBarController.m @ @ -14,6 +14,12 @ @ Open a modal from tab bar __EoT__ https : //stackoverflow.com/questions/48857262/open-modal-from-tab-bar **Issue Description** I have 3 tabs and I want to open a modal when the user presses on the second tab at the moment it just navigates to the screen . There was another issue raised for this but was closed without any solution . https : //github.com/wix/react-native-navigation/issues/55 I really like this library and do n't want to switch because of this issue so any help would be greatly appreciated . Thanks
diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/utils/ImageLoader.java b/lib/android/app/src/main/java/com/reactnativenavigation/utils/ImageLoader.java index 881a9e9..1740762 100644 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/utils/ImageLoader.java +++ b/lib/android/app/src/main/java/com/reactnativenavigation/utils/ImageLoader.java @ @ -63,7 +63,7 @ @ public class ImageLoader { } private Drawable loadFile ( String uri ) { - Bitmap bitmap = BitmapFactory.decodeFile ( uri ) ; + Bitmap bitmap = BitmapFactory.decodeFile ( Uri.parse ( uri ) .getPath ( ) ) ; return new BitmapDrawable ( NavigationApplication.instance.getResources ( ) , bitmap ) ; } Bottom Nav Icons disappear when getting a CodePush ( Android ) __EoT__ # # # Issue Description When using RNN in conjunction with CodePush causes the app 's Bottom Navigation icons to show as blank space after the app receives a code push . # # # Steps to Reproduce / Code Snippets / Screenshots - Implement Bottom Bar Navigation using Wix V2 - Add Microsoft CodePush . - Launch app - Background - Foreground app Result Icons disappear and the following log shows in logcat : `` ` BitmapFactory : Unable to decode stream : java.io.FileNotFoundException : file : /data/user/0/APP_NAME/files/CodePush/CODE_PUSH_HASH/bundle/drawable-xxhdpi/NAV_IMAGE.png ( No such file or directory ) `` ` Expected : Updated/Existing icons should still be visible . The reason for this error is the attempt to load image using uri as string instead of the path -- - # # # Environment * React Native Navigation version : V2 * React Native version : 0.53.3 * Platform ( s ) ( iOS , Android , or both ? ) : Android * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : Both Emulator and real device / Release Only # # # Proposed Fix :
diff -- git a/android/app/src/main/java/com/reactnativenavigation/params/StyleParams.java b/android/app/src/main/java/com/reactnativenavigation/params/StyleParams.java index fcc100f..d041355 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/params/StyleParams.java +++ b/android/app/src/main/java/com/reactnativenavigation/params/StyleParams.java @ @ -135,6 +135,9 @ @ public class StyleParams { public Color navigationBarColor ; + public boolean disableIconTint ; + public boolean disableSelectedIconTint ; + public boolean hasTopBarCustomComponent ( ) { return ! TextUtils.isEmpty ( topBarReactView ) ; } diff -- git a/android/app/src/main/java/com/reactnativenavigation/params/parsers/StyleParamsParser.java b/android/app/src/main/java/com/reactnativenavigation/params/parsers/StyleParamsParser.java index 4b5eaa0..d44908a 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/params/parsers/StyleParamsParser.java +++ b/android/app/src/main/java/com/reactnativenavigation/params/parsers/StyleParamsParser.java @ @ -96,6 +96,9 @ @ public class StyleParamsParser { result.bottomTabFontFamily = getFont ( `` bottomTabFontFamily '' , getDefaultBottomTabsFontFamily ( ) ) ; + result.disableIconTint = getBoolean ( `` disableIconTint '' , getDefaultDisableIconTint ( ) ) ; + result.disableSelectedIconTint = getBoolean ( `` disableSelectedIconTint '' , getDefaultDisableSelectedIconTint ( ) ) ; + return result ; } @ @ -289,6 +292,14 @ @ public class StyleParamsParser { return AppStyle.appStyle == null ? -1 : AppStyle.appStyle.titleBarHeight ; } + private boolean getDefaultDisableIconTint ( ) { + return AppStyle.appStyle ! = null & & AppStyle.appStyle.disableIconTint ; + } + + private boolean getDefaultDisableSelectedIconTint ( ) { + return AppStyle.appStyle ! = null & & AppStyle.appStyle.disableSelectedIconTint ; + } + private boolean getBoolean ( String key , boolean defaultValue ) { return params.containsKey ( key ) ? params.getBoolean ( How to disable TabBar button color ? Want to use the original color of the icon image . __EoT__ # # # Issue Description Need to use images for TabBar buttons like these . Normal ! [ timeline ] ( https : //user-images.githubusercontent.com/23102875/29449199-c844acc2-8434-11e7-9869-9a817f2a6271.png ) Selected ! [ timeline_rv ] ( https : //user-images.githubusercontent.com/23102875/29449217-d7e9d6e8-8434-11e7-9e3c-495f21ef6805.png ) and the background color of the TabBar needs to be a certain one . Therefore , I used tabsStyle like this . tabsStyle : { tabBarBackgroundColor : ' # AB013E ' , } , Then , the result shows like this . ! [ image ] ( https : //user-images.githubusercontent.com/23102875/29449328-34d56624-8435-11e7-8af6-2afdb4c29564.png ) It seems that the default button color is blue and it overwrite the color of the original image . And I when I set a specific color , like 'white ' , then it still overwrite the color of the original image , like this . ! [ image ] ( https : //user-images.githubusercontent.com/23102875/29449463-d67cebd2-8435-11e7-9965-09b198c7bcfa.png ) I tried not to use tabsStyle , but it that case , I ca n't set the background color of the tab and the default color of the button , 'blue ' , still overwrites the image , like this
diff -- git a/android/app/build.gradle b/android/app/build.gradle index 51f8df9..8df491e 100644 -- - a/android/app/build.gradle +++ b/android/app/build.gradle @ @ -54,7 +54,6 @ @ dependencies { compile `` com.facebook.react : react-native : + '' // third party - compile `` com.aurelhubert : ahbottomnavigation:2.0.6 '' compile 'com.balysv.materialmenu : material-menu-toolbar:1.5.4' // tests diff -- git a/android/app/src/main/java/com/aurelhubert/ahbottomnavigation/AHBottomNavigation.java b/android/app/src/main/java/com/aurelhubert/ahbottomnavigation/AHBottomNavigation.java new file mode 100644 index 0000000..5ce971f -- - /dev/null +++ b/android/app/src/main/java/com/aurelhubert/ahbottomnavigation/AHBottomNavigation.java @ @ -0,0 +1,1582 @ @ +package com.aurelhubert.ahbottomnavigation ; + +import android.animation.Animator ; +import android.annotation.SuppressLint ; +import android.annotation.TargetApi ; +import android.content.Context ; +import android.content.res.Resources ; +import android.content.res.TypedArray ; +import android.graphics.Color ; +import android.graphics.Typeface ; +import android.graphics.drawable.Drawable ; +import android.os.Build ; +import android.os.Bundle ; +import android.os.Parcelable ; +import android.support.annotation.ColorInt ; +import android.support.annotation.ColorRes ; +import android.support.annotation.DrawableRes ; +import android.support.design.widget.CoordinatorLayout ; +import android.support.design.widget.FloatingActionButton ; +import android.support.v4.content.ContextCompat ; +import android.support.v4.view.ViewCompat ; +import android.support.v4.view.animation.LinearOutSlowInInterpolator ; +import android.util.AttributeSet ; +import android.util.DisplayMetrics ; +import android.util.Log ; +import android.util.TypedValue ; +import android.view.Display ; +import android.view.Gravity ; +import android.view.LayoutInflater ; +import android.view.View ; +import android.view.ViewAnimationUtils ; +import android.view.ViewGroup ; +import android.view.WindowManager ; +import android.view.animation.AccelerateInterpolator ; +import android.view.animation.OvershootInterpolator ; +import android.widget.FrameLayout ; +import android.widget.ImageView ; +import android.widget.LinearLayout ; +import android.widget.TextView ; + +import com.aurelhubert.ahbottomnavigation.notification.AHNotification ; +import com.aurelhubert.ahbottomnavigation.notification.AHNotificationHelper ; +import com.reactnativenavigation.R ; + +import java.util.ArrayList ; +import java.util.List ; +import How to disable TabBar button color ? Want to use the original color of the icon image . __EoT__ # # # Issue Description Need to use images for TabBar buttons like these . Normal ! [ timeline ] ( https : //user-images.githubusercontent.com/23102875/29449199-c844acc2-8434-11e7-9869-9a817f2a6271.png ) Selected ! [ timeline_rv ] ( https : //user-images.githubusercontent.com/23102875/29449217-d7e9d6e8-8434-11e7-9e3c-495f21ef6805.png ) and the background color of the TabBar needs to be a certain one . Therefore , I used tabsStyle like this . tabsStyle : { tabBarBackgroundColor : ' # AB013E ' , } , Then , the result shows like this . ! [ image ] ( https : //user-images.githubusercontent.com/23102875/29449328-34d56624-8435-11e7-8af6-2afdb4c29564.png ) It seems that the default button color is blue and it overwrite the color of the original image . And I when I set a specific color , like 'white ' , then it still overwrite the color of the original image , like this . ! [ image ] ( https : //user-images.githubusercontent.com/23102875/29449463-d67cebd2-8435-11e7-9965-09b198c7bcfa.png ) I tried not to use tabsStyle , but it that case , I ca n't set the background color of the tab and the default color of the button , 'blue ' , still overwrites the image , like this
diff -- git a/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java b/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java index 6840904..a44d206 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java +++ b/android/app/src/main/java/com/reactnativenavigation/controllers/NavigationActivity.java @ @ -127,7 +127,7 @ @ public class NavigationActivity extends AppCompatActivity implements DefaultHard @ Override public void onActivityResult ( int requestCode , int resultCode , Intent data ) { - NavigationApplication.instance.getReactGateway ( ) .onActivityResult ( requestCode , resultCode , data ) ; + NavigationApplication.instance.getReactGateway ( ) .onActivityResult ( this , requestCode , resultCode , data ) ; } @ Override diff -- git a/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactGateway.java b/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactGateway.java index 58d5eec..5640e0e 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactGateway.java +++ b/android/app/src/main/java/com/reactnativenavigation/react/NavigationReactGateway.java @ @ -69,8 +69,8 @ @ public class NavigationReactGateway implements ReactGateway { getReactInstanceManager ( ) .onHostResume ( activity , defaultHardwareBackBtnHandler ) ; } - public void onActivityResult ( int requestCode , int resultCode , Intent data ) { - getReactInstanceManager ( ) .onActivityResult ( requestCode , resultCode , data ) ; + public void onActivityResult ( Activity activity , int requestCode , int resultCode , Intent data ) { + getReactInstanceManager ( ) .onActivityResult ( activity , requestCode , resultCode , data ) ; } public ReactNativeHost getReactNativeHost ( ) { diff -- git a/android/app/src/main/java/com/reactnativenavigation/react/ReactGateway.java b/android/app/src/main/java/com/reactnativenavigation/react/ReactGateway.java index c076b84..b48daa7 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/react/ReactGateway.java +++ b/android/app/src/main/java/com/reactnativenavigation/react/ReactGateway.java @ @ -28,5 +28,5 @ @ public interface ReactGateway { Background visible during transition __EoT__ # # # Issue Description When pushing a new screen onto the navigation stack that transitions from a navigation bar with a solid background colour to one with a transparent nav bar , a black background is visible where the original navigation bar was , as seen here halfway through the animation : < img width= '' 424 '' alt= '' screen shot 2017-01-31 at 17 13 58 '' src= '' https : //cloud.githubusercontent.com/assets/4320942/22476156/3c0108c0-e7d9-11e6-90f1-acf5f4fdf707.png '' > Here 's the navigator styles I 'm using : The first screen : `` ` static navigatorStyle = { navBarBackgroundColor : ' # fcfcfc ' , navBarTextColor : ' # 333 ' , navBarButtonColor : ' # 333 ' , statusBarTextColorScheme : 'dark ' , navBarHideOnScroll : false , navBarNoBorder : false , drawUnderNavBar : false , navBarTranslucent : false , statusBarHideWithNavBar : true } `` ` The screen being pushed : `` ` static navigatorStyle = { navBarTextColor : ' # 333 ' , navBarButtonColor : ' # 333 ' , statusBarHidden : false , navBarNoBorder : true , drawUnderNavBar : true , navBarTransparent : true , navBarTranslucent : true } `` ` If I set the first
diff -- git a/ios/Helpers/RCCTitleViewHelper.h b/ios/Helpers/RCCTitleViewHelper.h index c7eff60..251919b 100644 -- - a/ios/Helpers/RCCTitleViewHelper.h +++ b/ios/Helpers/RCCTitleViewHelper.h @ @ -9,6 +9,14 @ @ # import < Foundation/Foundation.h > # import < UIKit/UIKit.h > + @ interface RCCTitleView : UIView + + @ property ( nonatomic , strong ) UILabel *titleLabel ; + + @ property ( nonatomic , strong ) UILabel *subtitleLabel ; + + @ end + @ interface RCCTitleViewHelper : NSObject diff -- git a/ios/Helpers/RCCTitleViewHelper.m b/ios/Helpers/RCCTitleViewHelper.m index 5d4f15d..2eb70ed 100644 -- - a/ios/Helpers/RCCTitleViewHelper.m +++ b/ios/Helpers/RCCTitleViewHelper.m @ @ -8,6 +8,12 @ @ # import `` RCCTitleViewHelper.h '' # import `` RCTConvert.h '' + # import `` RCTHelpers.h '' + + @ implementation RCCTitleView + + + @ end @ interface RCCTitleViewHelper ( ) @ @ -18,7 +24,7 @ @ @ property ( nonatomic , strong ) NSString *subtitle ; @ property ( nonatomic , strong ) id titleImageData ; - @ property ( nonatomic , strong ) UIView *titleView ; + @ property ( nonatomic , strong ) RCCTitleView *titleView ; @ end @ @ -50,15 +56,11 @ @ navigationController : ( UINavigationController* ) navigationController CGRect navigationBarBounds = self.navigationController.navigationBar.bounds ; - UILabel *titleLabel ; - UILabel *subtitleLabel ; - - self.titleView = [ [ Background visible during transition __EoT__ # # # Issue Description When pushing a new screen onto the navigation stack that transitions from a navigation bar with a solid background colour to one with a transparent nav bar , a black background is visible where the original navigation bar was , as seen here halfway through the animation : < img width= '' 424 '' alt= '' screen shot 2017-01-31 at 17 13 58 '' src= '' https : //cloud.githubusercontent.com/assets/4320942/22476156/3c0108c0-e7d9-11e6-90f1-acf5f4fdf707.png '' > Here 's the navigator styles I 'm using : The first screen : `` ` static navigatorStyle = { navBarBackgroundColor : ' # fcfcfc ' , navBarTextColor : ' # 333 ' , navBarButtonColor : ' # 333 ' , statusBarTextColorScheme : 'dark ' , navBarHideOnScroll : false , navBarNoBorder : false , drawUnderNavBar : false , navBarTranslucent : false , statusBarHideWithNavBar : true } `` ` The screen being pushed : `` ` static navigatorStyle = { navBarTextColor : ' # 333 ' , navBarButtonColor : ' # 333 ' , statusBarHidden : false , navBarNoBorder : true , drawUnderNavBar : true , navBarTransparent : true , navBarTranslucent : true } `` ` If I set the first
diff -- git a/ios/RCCNavigationController.m b/ios/RCCNavigationController.m index dda6688..2ed9ece 100755 -- - a/ios/RCCNavigationController.m +++ b/ios/RCCNavigationController.m @ @ -408,11 +408,13 @ @ NSString const *CALLBACK_ASSOCIATED_ID = @ '' RCCNavigationController.CALLBACK_ASSO if ( [ side isEqualToString : @ '' left '' ] ) { + viewController.navigationItem.leftBarButtonItems = @ [ ] ; // make sure to clear all old items . [ viewController.navigationItem setLeftBarButtonItems : barButtonItems animated : animated ] ; } if ( [ side isEqualToString : @ '' right '' ] ) { + viewController.navigationItem.rightBarButtonItems = @ [ ] ; // make sure to clear all old items . [ viewController.navigationItem setRightBarButtonItems : barButtonItems animated : animated ] ; } } [ iOS ] [ Bug ] - Navigation bar overlapping icons with popped screen . __EoT__ # # # Issue Description Hi guys , I found a bug . I have 3 screens : screen A is list of items , tap on an item show screen B then tap on item on screen B to show screen C. Screen B has back icon on left and plus icon on right . Screen C has custom back icon on left and filter icon on right . From screen C , I execute pop gesture to go back B and continue to A . Then from A I tap on item to go to screen B . The navigation bar at B will show both icons that displayed on screen C ( please see the below screenshot ) . Notice : at screen C , if I tap on Back icon instead of execute pop gesture , this issue is not happened . ! [ navibar-issue ] ( https : //user-images.githubusercontent.com/3895199/30244994-8dd66562-95f5-11e7-9f62-9b2dcaf89372.png ) -- - # # # Environment * React Native Navigation version : 1.1.213 * React Native version : 0.48.1 * Platform ( s ) ( iOS , Android ,
diff -- git a/lib/ios/RNNSideMenu/MMDrawerController/MMDrawerController.m b/lib/ios/RNNSideMenu/MMDrawerController/MMDrawerController.m index e236fc0..1202702 100755 -- - a/lib/ios/RNNSideMenu/MMDrawerController/MMDrawerController.m +++ b/lib/ios/RNNSideMenu/MMDrawerController/MMDrawerController.m @ @ -1478,9 +1478,6 @ @ static inline CGFloat originXForDrawerOriginAndTargetOriginOffset ( CGFloat origin if ( [ self isPointContainedWithinNavigationRect : point ] ) { possibleOpenGestureModes |= MMOpenDrawerGestureModePanningNavigationBar ; } - if ( [ self isPointContainedWithinCenterViewContentRect : point ] ) { - possibleOpenGestureModes |= MMOpenDrawerGestureModePanningCenterView ; - } if ( [ self isPointContainedWithinLeftBezelRect : point ] & & self.leftDrawerViewController ) { possibleOpenGestureModes |= MMOpenDrawerGestureModeBezelPanningCenterView ; [ v2 ] Are e2e tests passing ? __EoT__ < ! -- Please post questions in Stack Overflow under the react-native-navigation tag https : //stackoverflow.com/questions/tagged/react-native-navigation -- > # # # Issue Description About 9 days ago , I opened pull request # 3578 and I noticed that the CI system was reporting that checks were failing . I did n't know how my code changes could have caused those , and so I checked out the official v2 branch and am running e2e tests on it . I am getting failures . Is this a known issue ? Here is the failure on android : `` ` FAIL e2e/ScreenStack.test.js ( 1789.068s ) screen stack ✓ push and pop screen ( 130022ms ) ✓ : android : push and pop screen without animation ( 44958ms ) ✓ pop screen deep in the stack ( 194973ms ) ✓ pop to specific id ( 279782ms ) ✓ pop to root ( 299956ms ) ✓ switch to tab ( 120145ms ) ✓ switch to tab by cotnainerId ( 84999ms ) ✓ push stack with multiple children ( 235206ms ) ✓ push external component with options ( 50192ms ) ✓ push into a stack from
diff -- git a/lib/ios/RNNSideMenu/MMDrawerController/MMDrawerController.m b/lib/ios/RNNSideMenu/MMDrawerController/MMDrawerController.m index e236fc0..1202702 100755 -- - a/lib/ios/RNNSideMenu/MMDrawerController/MMDrawerController.m +++ b/lib/ios/RNNSideMenu/MMDrawerController/MMDrawerController.m @ @ -1478,9 +1478,6 @ @ static inline CGFloat originXForDrawerOriginAndTargetOriginOffset ( CGFloat origin if ( [ self isPointContainedWithinNavigationRect : point ] ) { possibleOpenGestureModes |= MMOpenDrawerGestureModePanningNavigationBar ; } - if ( [ self isPointContainedWithinCenterViewContentRect : point ] ) { - possibleOpenGestureModes |= MMOpenDrawerGestureModePanningCenterView ; - } if ( [ self isPointContainedWithinLeftBezelRect : point ] & & self.leftDrawerViewController ) { possibleOpenGestureModes |= MMOpenDrawerGestureModeBezelPanningCenterView ; [ v2 ] Are e2e tests passing ? __EoT__ < ! -- Please post questions in Stack Overflow under the react-native-navigation tag https : //stackoverflow.com/questions/tagged/react-native-navigation -- > # # # Issue Description About 9 days ago , I opened pull request # 3578 and I noticed that the CI system was reporting that checks were failing . I did n't know how my code changes could have caused those , and so I checked out the official v2 branch and am running e2e tests on it . I am getting failures . Is this a known issue ? Here is the failure on android : `` ` FAIL e2e/ScreenStack.test.js ( 1789.068s ) screen stack ✓ push and pop screen ( 130022ms ) ✓ : android : push and pop screen without animation ( 44958ms ) ✓ pop screen deep in the stack ( 194973ms ) ✓ pop to specific id ( 279782ms ) ✓ pop to root ( 299956ms ) ✓ switch to tab ( 120145ms ) ✓ switch to tab by cotnainerId ( 84999ms ) ✓ push stack with multiple children ( 235206ms ) ✓ push external component with options ( 50192ms ) ✓ push into a stack from
diff -- git a/android/app/src/main/java/com/reactnativenavigation/NavigationApplication.java b/android/app/src/main/java/com/reactnativenavigation/NavigationApplication.java index d833699..d73643f 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/NavigationApplication.java +++ b/android/app/src/main/java/com/reactnativenavigation/NavigationApplication.java @ @ -8,7 +8,7 @ @ import com.facebook.react.ReactApplication ; import com.facebook.react.ReactNativeHost ; import com.facebook.react.ReactPackage ; import com.facebook.react.bridge.ReactContext ; -import com.facebook.react.bridge.WritableMap ; +import com.reactnativenavigation.bridge.EventEmitter ; import com.reactnativenavigation.controllers.ActivityCallbacks ; import com.reactnativenavigation.react.NavigationReactGateway ; import com.reactnativenavigation.react.ReactGateway ; @ @ -20,6 +20,7 @ @ public abstract class NavigationApplication extends Application implements React public static NavigationApplication instance ; private NavigationReactGateway reactGateway ; + private EventEmitter eventEmitter ; private Handler handler ; private ActivityCallbacks activityCallbacks ; @ @ -29,6 +30,7 @ @ public abstract class NavigationApplication extends Application implements React instance = this ; handler = new Handler ( getMainLooper ( ) ) ; reactGateway = new NavigationReactGateway ( ) ; + eventEmitter = new EventEmitter ( reactGateway ) ; activityCallbacks = new ActivityCallbacks ( ) ; } @ @ -69,6 +71,10 @ @ public abstract class NavigationApplication extends Application implements React return reactGateway.getReactNativeHost ( ) ; } + public EventEmitter getEventEmitter ( ) { + return eventEmitter ; + } + /** * @ see ReactNativeHost # getJSMainModuleName ( ) */ @ @ -97,33 +103,4 @ @ public abstract class NavigationApplication extends Application implements React @ Nullable public abstract List < ReactPackage > Search Field in Navigation Bar - iOS Support , Documentation __EoT__ I noticed there is Android support for a search view as a Navigation Button , expanding to a text field on selection . ( Found via Pull # 432 ) It needs an iOS implementation , as well as documentation on how to implement . From my own experimentation , it appears the only necessary action is to set the Navigation Button id to ` searchView ` , and it requires an icon - title does n't work . EG - `` ` static navigatorButtons = { rightButtons : [ { icon : require ( `` ../../assets/searchIcon.png '' ) , id : 'searchView ' , } ] } `` ` And then search events are emitted as Navigator events , EG - `` ` this.props.navigator.setOnNavigatorEvent ( event = > { if ( event.id === `` searchQueryChange '' ) { console.log ( `` search query : `` + event.query ) ; } } ) ; `` ` I 'm going to work on an iOS equivalent to match
diff -- git a/lib/ios/RNNLayoutOptions.h b/lib/ios/RNNLayoutOptions.h index ba77671..4a1ab7e 100644 -- - a/lib/ios/RNNLayoutOptions.h +++ b/lib/ios/RNNLayoutOptions.h @ @ -2,7 +2,7 @ @ @ interface RNNLayoutOptions : RNNOptions - @ property ( nonatomic , strong ) NSNumber* screenBackgroundColor ; + @ property ( nonatomic , strong ) NSNumber* backgroundColor ; @ property ( nonatomic , strong ) id orientation ; - ( UIInterfaceOrientationMask ) supportedOrientations ; diff -- git a/lib/ios/RNNLayoutOptions.m b/lib/ios/RNNLayoutOptions.m index 4336749..fc79d3f 100644 -- - a/lib/ios/RNNLayoutOptions.m +++ b/lib/ios/RNNLayoutOptions.m @ @ -4,8 +4,8 @ @ @ implementation RNNLayoutOptions - ( void ) applyOn : ( UIViewController * ) viewController { - if ( self.screenBackgroundColor ) { - UIColor* screenColor = [ RCTConvert UIColor : self.screenBackgroundColor ] ; + if ( self.backgroundColor ) { + UIColor* screenColor = [ RCTConvert UIColor : self.backgroundColor ] ; viewController.view.backgroundColor = screenColor ; } } @ @ -32,7 +32,7 @ @ } } } - + return supportedOrientationsMask ; } diff -- git a/lib/ios/ReactNativeNavigationTests/RNNRootViewControllerTest.m b/lib/ios/ReactNativeNavigationTests/RNNRootViewControllerTest.m index 8a42913..7b9651a 100644 -- - a/lib/ios/ReactNativeNavigationTests/RNNRootViewControllerTest.m +++ b/lib/ios/ReactNativeNavigationTests/RNNRootViewControllerTest.m @ @ -51,21 +51,21 @ @ __unused RNNNavigationController* nav = [ [ RNNNavigationController alloc ] initWithRootViewController : self.uut ] ; [ self.uut viewWillAppear : false ] ; UIColor* expectedColor = [ UIColor colorWithRed:1 green:0 blue:0 alpha:1 [ V2 ] Default background color does n't work as specified in the documentation __EoT__ # # # Issue Description When configuring a default background ( ` Navigation.setDefaultOptions ` ) color as specified in the documentation , nothing happens . `` ` { layout : { backgroundColor : 'red' } } `` ` Reference : https : //wix.github.io/react-native-navigation/v2/ # /docs/styling ? id=common-options It turns out it works when adding , instead : `` ` { screenBackgroundColor : 'red' } `` ` Setting the color using ` Navigation.setDefaultOptions ` only works on Android . But it works on iOS when defining this property per screen . * React Native Navigation version : 2.0.2305 * React Native version : 0.54.4 * Platform ( s ) ( iOS , Android , or both ? ) : Both * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : iOS 10 , 11 - Android API 25
diff -- git a/android/app/src/main/java/com/reactnativenavigation/layouts/BottomTabsLayout.java b/android/app/src/main/java/com/reactnativenavigation/layouts/BottomTabsLayout.java index 6c7be21..1a3e38a 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/layouts/BottomTabsLayout.java +++ b/android/app/src/main/java/com/reactnativenavigation/layouts/BottomTabsLayout.java @ @ -229,6 +229,8 @ @ public class BottomTabsLayout extends BaseLayout implements AHBottomNavigation.O for ( int i = 0 ; i < bottomTabs.getItemsCount ( ) ; i++ ) { screenStacks [ i ] .updateScreenStyle ( screenInstanceId , styleParams ) ; } + + bottomTabs.updateTabStyle ( styleParams ) ; } @ Override diff -- git a/android/app/src/main/java/com/reactnativenavigation/views/BottomTabs.java b/android/app/src/main/java/com/reactnativenavigation/views/BottomTabs.java index 7ca224e..a0e28d5 100644 -- - a/android/app/src/main/java/com/reactnativenavigation/views/BottomTabs.java +++ b/android/app/src/main/java/com/reactnativenavigation/views/BottomTabs.java @ @ -2,6 +2,7 @ @ package com.reactnativenavigation.views ; import android.content.Context ; import android.graphics.Color ; +import android.os.Bundle ; import android.text.TextUtils ; import com.aurelhubert.ahbottomnavigation.AHBottomNavigation ; @ @ -10,6 +11,7 @ @ import com.reactnativenavigation.animation.VisibilityAnimator ; import com.reactnativenavigation.params.AppStyle ; import com.reactnativenavigation.params.ScreenParams ; import com.reactnativenavigation.params.StyleParams ; +import com.reactnativenavigation.params.parsers.StyleParamsParser ; import com.reactnativenavigation.utils.ViewUtils ; import com.reactnativenavigation.views.utils.Constants ; @ @ -24,7 +26,7 @ @ public class BottomTabs extends AHBottomNavigation { setForceTint ( true ) ; setId ( ViewUtils.generateViewId ( ) ) ; createVisibilityAnimator ( ) ; - setStyle ( ) ; + setStyle ( AppStyle.appStyle ) ; setFontFamily ( ) ; } @ @ -38,20 +40,13 @ @ public class BottomTabs extends AHBottomNavigation { setTitlesDisplayState ( ) ; } + public void updateTabStyle ( Bundle styleParams ) { + StyleParams Style the BottomTabs/TabBar at runtime __EoT__ Is there a way to change the tabbar style after the app being initialized ? # # # Steps to Reproduce / Code Snippets / Screenshots - Navigation.startTabBasedApp - Use tabsStyle to set some dark colors - Change app theme from dark to light - How to change the tab bar style now ? -- - # # # Environment * React Native Navigation version : 2.0.0-experimental.141 * React Native version : 0.37.0 * Platform ( s ) ( iOS , Android , or both ? ) : iOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : iPhone 6 Simulator iOS 10
diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/react/EventEmitter.java b/lib/android/app/src/main/java/com/reactnativenavigation/react/EventEmitter.java index 6eac3cd..e430a3b 100644 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/react/EventEmitter.java +++ b/lib/android/app/src/main/java/com/reactnativenavigation/react/EventEmitter.java @ @ -8,16 +8,19 @ @ import com.facebook.react.modules.core.DeviceEventManagerModule ; import static com.facebook.react.modules.core.DeviceEventManagerModule.RCTDeviceEventEmitter ; public class EventEmitter { - private static final String onAppLaunched = `` RNN.appLaunched '' ; - private static final String componentDidAppear = `` RNN.componentDidAppear '' ; - private static final String componentDidDisappear = `` RNN.componentDidDisappear '' ; - private static final String nativeEvent = `` RNN.nativeEvent '' ; - private static final String commandCompleted = `` RNN.commandCompleted '' ; - private static final String buttonPressedEvent = `` buttonPressed '' ; + private static final String onAppLaunched = `` RNN.AppLaunched '' ; + private static final String componentLifecycle = `` RNN.ComponentLifecycle '' ; + private static final String nativeEvent = `` RNN.NativeEvent '' ; + private static final String commandCompleted = `` RNN.CommandCompleted '' ; + private static final String componentLifecycleDidMount = `` ComponentDidMount '' ; + private static final String componentLifecycleDidAppear = `` ComponentDidAppear '' ; + private static final String componentLifecycleDidDisappear = `` ComponentDidDisappear '' ; + private static final String componentLifecycleWillUnmount = `` ComponentWillUnmount '' ; + private static final String buttonPressedEvent = `` buttonPressed '' ; - private final RCTDeviceEventEmitter emitter Plan for redux support in v2 ? ( HOC support ) __EoT__ I 'm looking to switch from v1 to v2 , but the first thing I noticed was that when registering containers , you can no longer pass in the store and Provider . Is this in the roadmap ?
diff -- git a/lib/android/app/src/main/java/com/reactnativenavigation/react/EventEmitter.java b/lib/android/app/src/main/java/com/reactnativenavigation/react/EventEmitter.java index 6eac3cd..1cdc828 100644 -- - a/lib/android/app/src/main/java/com/reactnativenavigation/react/EventEmitter.java +++ b/lib/android/app/src/main/java/com/reactnativenavigation/react/EventEmitter.java @ @ -8,16 +8,20 @ @ import com.facebook.react.modules.core.DeviceEventManagerModule ; import static com.facebook.react.modules.core.DeviceEventManagerModule.RCTDeviceEventEmitter ; public class EventEmitter { - private static final String onAppLaunched = `` RNN.appLaunched '' ; - private static final String componentDidAppear = `` RNN.componentDidAppear '' ; - private static final String componentDidDisappear = `` RNN.componentDidDisappear '' ; - private static final String nativeEvent = `` RNN.nativeEvent '' ; - private static final String commandCompleted = `` RNN.commandCompleted '' ; - private static final String buttonPressedEvent = `` buttonPressed '' ; + private static final String onAppLaunched = `` RNN.AppLaunched '' ; + private static final String componentLifecycle = `` RNN.ComponentLifecycle '' ; + private static final String nativeEvent = `` RNN.NativeEvent '' ; + private static final String commandCompleted = `` RNN.CommandCompleted '' ; - private final RCTDeviceEventEmitter emitter ; + private static final String componentLifecycleDidMount = `` ComponentDidMount '' ; + private static final String componentLifecycleDidAppear = `` ComponentDidAppear '' ; + private static final String componentLifecycleDidDisappear = `` ComponentDidDisappear '' ; + private static final String componentLifecycleWillUnmount = `` ComponentWillUnmount '' ; + private static final String buttonPressedEvent = `` buttonPressed '' Plan for redux support in v2 ? ( HOC support ) __EoT__ I 'm looking to switch from v1 to v2 , but the first thing I noticed was that when registering containers , you can no longer pass in the store and Provider . Is this in the roadmap ?
diff -- git a/docs/api/Commands.md b/docs/api/Commands.md index bdb0019..0c3386d 100644 -- - a/docs/api/Commands.md +++ b/docs/api/Commands.md @ @ -4,7 +4,7 @ @ ` setRoot ( simpleApi : any ) : any ` - [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L13 ) + [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L15 ) -- - @ @ -12,7 +12,7 @ @ ` setDefaultOptions ( options : any ) : void ` - [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L23 ) + [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L38 ) -- - @ @ -20,7 +20,7 @ @ ` mergeOptions ( componentId : any , options : any ) : void ` - [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L31 ) + [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L46 ) -- - @ @ -28,7 +28,7 @ @ ` showModal ( simpleApi : any ) : any ` - [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L39 ) + [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L54 ) -- - @ @ -36,7 +36,7 @ @ ` dismissModal ( componentId : any ) : any ` - [ source ] ( https : Plan for redux support in v2 ? ( HOC support ) __EoT__ I 'm looking to switch from v1 to v2 , but the first thing I noticed was that when registering containers , you can no longer pass in the store and Provider . Is this in the roadmap ?
diff -- git a/docs/api/Commands.md b/docs/api/Commands.md index bdb0019..0c3386d 100644 -- - a/docs/api/Commands.md +++ b/docs/api/Commands.md @ @ -4,7 +4,7 @ @ ` setRoot ( simpleApi : any ) : any ` - [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L13 ) + [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L15 ) -- - @ @ -12,7 +12,7 @ @ ` setDefaultOptions ( options : any ) : void ` - [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L23 ) + [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L38 ) -- - @ @ -20,7 +20,7 @ @ ` mergeOptions ( componentId : any , options : any ) : void ` - [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L31 ) + [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L46 ) -- - @ @ -28,7 +28,7 @ @ ` showModal ( simpleApi : any ) : any ` - [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L39 ) + [ source ] ( https : //github.com/wix/react-native-navigation/blob/v2/lib/src/commands/Commands.ts # L54 ) -- - @ @ -36,7 +36,7 @ @ ` dismissModal ( componentId : any ) : any ` - [ source ] ( https : Plan for redux support in v2 ? ( HOC support ) __EoT__ I 'm looking to switch from v1 to v2 , but the first thing I noticed was that when registering containers , you can no longer pass in the store and Provider . Is this in the roadmap ?
diff -- git a/lib/ios/RNNEventEmitter.m b/lib/ios/RNNEventEmitter.m index fdb1404..e39fef4 100644 -- - a/lib/ios/RNNEventEmitter.m +++ b/lib/ios/RNNEventEmitter.m @ @ -1,6 +1,9 @ @ # import `` RNNEventEmitter.h '' - @ implementation RNNEventEmitter + @ implementation RNNEventEmitter { + NSInteger _appLaunchedListenerCount ; + BOOL _appLaunchedEventDeferred ; + } RCT_EXPORT_MODULE ( ) ; @ @ -16,7 +19,11 @ @ static NSString* const onNavigationButtonPressed = @ '' RNN.navigationButtonPressed # pragma mark public - ( void ) sendOnAppLaunched { - [ self send : onAppLaunched body : nil ] ; + if ( _appLaunchedListenerCount > 0 ) { + [ self send : onAppLaunched body : nil ] ; + } else { + _appLaunchedEventDeferred = TRUE ; + } } - ( void ) sendContainerDidAppear : ( NSString * ) containerId { @ @ -31,6 +38,17 @ @ static NSString* const onNavigationButtonPressed = @ '' RNN.navigationButtonPressed [ self send : onNavigationButtonPressed body : @ { @ '' containerId '' : containerId , @ '' buttonId '' : buttonId } ] ; } +- ( void ) addListener : ( NSString * ) eventName { + [ super addListener : eventName ] ; + if ( [ eventName isEqualToString : onAppLaunched ] ) { + _appLaunchedListenerCount++ ; + [ v2 ] Sending ` RNN.appLaunched ` with no listeners registered . __EoT__ # # # Issue Description When building a basic sample project for iOS , following the project in the ` playground ` folder , the app throws the following warning ` Sending 'RNN.appLaunched ' with no listeners registered. ` # # # Steps to Reproduce / Code Snippets / Screenshots * ` git clone git @ github.com : kasperkronborg/test-navigation.git ` * ` yarn install ` * ` react-native run-ios ` In the github project I have added some log statements to the iOS Library , that gives the indication of a race condition . It seems that ` RNN.appLaunched ` are called to early , when there has still not been any listeners attached through ` Navigation.events ( ) .onAppLaunched ( ) ` . -- - # # # Environment * React Native Navigation version : 2.0.54 * React Native version : 0.45.1 * Platform ( s ) ( iOS , Android , or both ? ) : iOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : Simulator , iOS 10 , Debug
diff -- git a/docs/docs/Installing.md b/docs/docs/Installing.md index e8c12d1..5e9250b 100644 -- - a/docs/docs/Installing.md +++ b/docs/docs/Installing.md @ @ -43,6 +43,14 @ @ @ end `` ` +3a . If , in Xcode , you see the following error message in ` AppDelegate.m ` next to ` # import `` RCTBundleURLProvider.h '' : + `` ` + ! 'RCTBundleURLProvider.h ' file not found + `` ` +This is because the ` React ` scheme is missing from your project . You can verify this by opening the ` Product ` menu and the ` Scheme ` submenu . + +To make the ` React ` scheme available to your project , run ` npm install -g react-native-git-upgrade ` followed by ` react-native-git-upgrade ` . Once this is done , you can click back to the menu in Xcode : ` Product - > Scheme - > Manage Schemes ` , then click '+ ' to add a new scheme . From the ` Target ` menu , select `` React '' , and click the checkbox to make the scheme ` shared ` . This should make the error disappear . + # # Android > Make sure your Android Studio installation is updated [ v2 ] Bottom tabs visibility problem __EoT__ # # # Issue Description We have an app with bottom tabs . We want to navigate to another screen with hiding the bottom tabs . It 's working but causes a UI bug when we go back , appears a white area ( exact same height as bottom tabs ) . You can see below . # # # Steps to Reproduce / Code Snippets / Screenshots Let 's assume first screen is HomeScreen ( with bottom tabs ) and second screen is CommentsScreen . Just pass `` ` { bottomTabs : { visible : false , animated : true } } `` ` to CommentsScreen to hide bottom tabs . ! [ 2018-07-12 18 21 09 ] ( https : //user-images.githubusercontent.com/22980987/42643030-da25ac42-8600-11e8-98f4-ecdb5e477a00.gif ) ! [ 2018-07-12 18 21 57 ] ( https : //user-images.githubusercontent.com/22980987/42643032-da4f9a0c-8600-11e8-97b2-3ab440b76137.gif ) -- - # # # Environment * React Native Navigation version : v2 latest * React Native version : 0.55.4 * Platform ( s ) ( iOS , Android , or both ? ) : iOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : All
diff -- git a/ios/RCCDrawerController/MMDrawerController/MMDrawerController.m b/ios/RCCDrawerController/MMDrawerController/MMDrawerController.m index b193a38..340c045 100755 -- - a/ios/RCCDrawerController/MMDrawerController/MMDrawerController.m +++ b/ios/RCCDrawerController/MMDrawerController/MMDrawerController.m @ @ -1178,11 +1178,11 @ @ static NSString *MMDrawerOpenSideKey = @ '' MMDrawerOpenSide '' ; # pragma mark - iOS 7 Status Bar Helpers - ( UIViewController* ) childViewControllerForStatusBarStyle { - return [ self childViewControllerForSide : self.openSide ] ; + return [ self childViewControllerForSide : MMDrawerSideNone ] ; } - ( UIViewController* ) childViewControllerForStatusBarHidden { - return [ self childViewControllerForSide : self.openSide ] ; + return [ self childViewControllerForSide : MMDrawerSideNone ] ; } - ( void ) setNeedsStatusBarAppearanceUpdateIfSupported { [ ios ] [ v1 ] Global Events and Screen Events do not work after iPhoneX patch __EoT__ # # # Issue Description Global Events and Screen Events do not work after iPhoneX patch # # # Steps to Reproduce / Code Snippets / Screenshots Install latest ( 1.1.473 ) and register global events and and none of the events are generated . `` ` new ScreenVisibilityListener ( { willAppear : ( { screen } ) = > { logger.log ( ` Displaying screen $ { screen } ` ) ; } , didAppear : ( screen , startTime , endTime , commandType } ) = > { console.log ( 'screenVisibility ' , ` Screen $ { screen } displayed ` ) ; } , willDisappear : ( ) = > { // { screen , startTime , endTime , commandType } ) = > { /logger.log ( ` Screen will disappear $ { screen } ` ) ; } , didDisappear : ( { screen } ) = > { /logger.log ( ` Screen disappeared $ { screen } ` ) ; } } ) .register ( ) ; `` ` The problem is associated in RCCViewController.m at the
diff -- git a/lib/ios/Bool.h b/lib/ios/Bool.h new file mode 100644 index 0000000..569f975 -- - /dev/null +++ b/lib/ios/Bool.h @ @ -0,0 +1,11 @ @ + # import `` Param.h '' + + @ interface Bool : Param + +- ( BOOL ) get ; + +- ( NSNumber * ) getValue ; + +- ( BOOL ) getWithDefaultValue : ( BOOL ) value ; + + @ end diff -- git a/lib/ios/Bool.m b/lib/ios/Bool.m new file mode 100644 index 0000000..6187469 -- - /dev/null +++ b/lib/ios/Bool.m @ @ -0,0 +1,27 @ @ + # import `` Bool.h '' + + @ interface Bool ( ) + + @ property ( nonatomic , retain ) NSNumber* value ; + + @ end + + @ implementation Bool + +- ( BOOL ) get { + return [ self.value boolValue ] ; + } + +- ( NSNumber * ) getValue { + return self.value ; + } + +- ( BOOL ) getWithDefaultValue : ( BOOL ) defaultValue { + if ( self.value ) { + return [ self.value boolValue ] ; + } else { + return defaultValue ; + } + } + + @ end diff -- git a/lib/ios/BoolParser.h b/lib/ios/BoolParser.h new file [ V2 ] topBar component buttons cause Xcode runtime crash __EoT__ # 4105 broke components as ` topBar ` buttons . I am trying to apply a component as the only item in the ` leftButtons ` array and the app crashes ( Xcode crash ) . Icon buttons work fine . -- - # # # Environment * React Native Navigation version : 2.0.2583 * React Native version : 0.57.3 * Platform ( s ) ( iOS , Android , or both ? ) : iOS * Device info ( Simulator/Device ? OS version ? Debug/Release ? ) : All
diff -- git a/ios/RCCDrawerController/RCCDrawerController.m b/ios/RCCDrawerController/RCCDrawerController.m index 64eb03f..f27bd91 100755 -- - a/ios/RCCDrawerController/RCCDrawerController.m +++ b/ios/RCCDrawerController/RCCDrawerController.m @ @ -4,6 +4,7 @ @ # import `` RCCDrawerHelper.h '' # import < React/RCTConvert.h > # import `` RCCManagerModule.h '' + # import `` UIViewController+Rotation.h '' # define RCCDRAWERCONTROLLER_ANIMATION_DURATION 0.33f @ @ -12,7 +13,9 @ @ @ synthesize drawerStyle = _drawerStyle ; - +- ( UIInterfaceOrientationMask ) supportedInterfaceOrientations { + return [ self supportedControllerOrientations ] ; + } - ( instancetype ) initWithProps : ( NSDictionary * ) props children : ( NSArray * ) children globalProps : ( NSDictionary* ) globalProps bridge : ( RCTBridge * ) bridge { @ @ -66,6 +69,9 @ @ self.view.backgroundColor = [ UIColor clearColor ] ; + [ self setRotation : props ] ; + + if ( ! self ) return nil ; return self ; } diff -- git a/ios/RCCDrawerController/RCCTheSideBarManagerViewController.m b/ios/RCCDrawerController/RCCTheSideBarManagerViewController.m index 85ac61a..abace3e 100755 -- - a/ios/RCCDrawerController/RCCTheSideBarManagerViewController.m +++ b/ios/RCCDrawerController/RCCTheSideBarManagerViewController.m @ @ -10,7 +10,7 @ @ # import `` RCCViewController.h '' # import `` RCCDrawerHelper.h '' # import < React/RCTConvert.h > - + # import `` UIViewController+Rotation.h '' @ interface RCCTheSideBarManagerViewController ( ) < TheSidebarControllerDelegate > @ @ -39,6 +39,12 @ @ return _overlayButton ; } + +- Feature needed : enable single screen supporting orientation . __EoT__ # # # Issue Description Right now , Android can turn on portraitOnlyMode to make the whole app not supporting orientation , iOS not implemented yet . Both are not supporting turn on or off orientation for single screen . This feature is useful for apps that has a video player screen , which only need the player screen can be rotated .
diff -- git a/balking/src/test/java/com/iluwatar/balking/WashingMachineTest.java b/balking/src/test/java/com/iluwatar/balking/WashingMachineTest.java index 9a13b8b..53a9991 100644 -- - a/balking/src/test/java/com/iluwatar/balking/WashingMachineTest.java +++ b/balking/src/test/java/com/iluwatar/balking/WashingMachineTest.java @ @ -22,31 +22,36 @ @ */ package com.iluwatar.balking ; -import org.junit.jupiter.api.Disabled ; -import org.junit.jupiter.api.Test ; +import static org.junit.jupiter.api.Assertions.assertEquals ; import java.util.concurrent.ExecutorService ; import java.util.concurrent.Executors ; import java.util.concurrent.TimeUnit ; -import static org.junit.jupiter.api.Assertions.assertEquals ; +import org.junit.jupiter.api.Test ; /** * Tests for { @ link WashingMachine } */ public class WashingMachineTest { - private volatile WashingMachineState machineStateGlobal ; + private WashingMachineState machineStateGlobal ; - @ Disabled @ Test public void wash ( ) throws Exception { WashingMachine washingMachine = new WashingMachine ( ) ; ExecutorService executorService = Executors.newFixedThreadPool ( 2 ) ; - executorService.execute ( washingMachine : :wash ) ; executorService.execute ( ( ) - > { washingMachine.wash ( ) ; - machineStateGlobal = washingMachine.getWashingMachineState ( ) ; + if ( machineStateGlobal == null ) { + machineStateGlobal = washingMachine.getWashingMachineState ( ) ; + } + } ) ; + executorService.execute ( ( ) - > { + washingMachine.wash ( ) ; + if ( machineStateGlobal == null ) { + machineStateGlobal = washingMachine.getWashingMachineState ( ) ; + } } ) ; executorService.shutdown ( ) ; try { Intermittent failure in Balking pattern __EoT__ See Travis log https : //api.travis-ci.org/v3/job/329176022/log.txt
diff -- git a/balking/src/test/java/com/iluwatar/balking/WashingMachineTest.java b/balking/src/test/java/com/iluwatar/balking/WashingMachineTest.java index 9a13b8b..4389d2e 100644 -- - a/balking/src/test/java/com/iluwatar/balking/WashingMachineTest.java +++ b/balking/src/test/java/com/iluwatar/balking/WashingMachineTest.java @ @ -22,14 +22,13 @ @ */ package com.iluwatar.balking ; -import org.junit.jupiter.api.Disabled ; -import org.junit.jupiter.api.Test ; +import static org.junit.jupiter.api.Assertions.assertEquals ; import java.util.concurrent.ExecutorService ; import java.util.concurrent.Executors ; import java.util.concurrent.TimeUnit ; -import static org.junit.jupiter.api.Assertions.assertEquals ; +import org.junit.jupiter.api.Test ; /** * Tests for { @ link WashingMachine } @ @ -38,12 +37,14 @ @ public class WashingMachineTest { private volatile WashingMachineState machineStateGlobal ; - @ Disabled @ Test public void wash ( ) throws Exception { WashingMachine washingMachine = new WashingMachine ( ) ; ExecutorService executorService = Executors.newFixedThreadPool ( 2 ) ; - executorService.execute ( washingMachine : :wash ) ; + executorService.execute ( ( ) - > { + washingMachine.wash ( ) ; + machineStateGlobal = washingMachine.getWashingMachineState ( ) ; + } ) ; executorService.execute ( ( ) - > { washingMachine.wash ( ) ; machineStateGlobal = washingMachine.getWashingMachineState ( ) ; Intermittent failure in Balking pattern __EoT__ See Travis log https : //api.travis-ci.org/v3/job/329176022/log.txt
diff -- git a/.gitignore b/.gitignore index fd0bb78..fa067f6 100644 -- - a/.gitignore +++ b/.gitignore @ @ -1,20 +1,3 @ @ -target -.metadata -.settings -.classpath -.project -*.class - # Package Files # -*.jar -*.war -*.ear -.idea -*.iml -*.swp -datanucleus.log -/bin/ -/bin/ -/bin/ -*.log -data-mapper/src/main/resources/log4j.xml -event-sourcing/Journal.json +_site +.sass-cache +*.orig diff -- git a/.gitmodules b/.gitmodules new file mode 100644 index 0000000..1afc421 -- - /dev/null +++ b/.gitmodules @ @ -0,0 +1,8 @ @ + [ submodule `` patterns '' ] + path = patterns + url = https : //github.com/iluwatar/java-design-patterns.git + branch = master + [ submodule `` programming-principles '' ] + path = programming-principles + url = https : //github.com/webpro/programming-principles.git + branch = gh-pages diff -- git a/.travis.yml b/.travis.yml index 85f53bc..49eecc1 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -1,39 +1,23 @ @ -language : java -jdk : -- oraclejdk8 - env : global : - - GH_REF : github.com/iluwatar/java-design-patterns.git - - secure : LxTDuNS/rBWIvKkaEqr79ImZAe48mCdoYCF41coxNXgNoippo4GIBArknqtv+XvdkiuRZ1yGyj6pn8GU33c/yn+krddTUkVCwTbVatbalW5jhQjDbHYym/JcxaK9ZS/3JTeGcWrBgiPqHEEDhCf26vPZsXoMSeVCEORVKTp1BSg= - - secure : `` eoWlW9GyTJY04P8K3pxayXwU9/hmptQg/LfirispQkV9YvmziCfSzXnatnBhNfud98sCzY8BScXnb+OWLTnjLKpId4rtEqb0aJ40Jc32cUKzgzFAUn7cNcDAbUIfyPAGVqyQqfj/11wYSADwWMMOPlW97ExUtoyiH2WenXuRHso= '' - -before_install : -- export DISPLAY=:99.0 -- sh -e /etc/init.d/xvfb start + - NOKOGIRI_USE_SYSTEM_LIBRARIES=true # speeds up installation of html-proofer + - secure : `` Iu8YTpzVbRWjPfYJdV95FyHREmdIDjvhhEOh0Pr47UMNYqQfM9+Ag+jibe/cmOHV99zqYbxiGX+pfEUCaVMaza4urXdh4XedOO8NPefa5MP8LLqk9px3UmplaAZ02o015UTu+8OliRAQ8uy9qQhufIx09oHqznTGN4868SAAdI4= '' + - secure : `` nxGfq7fI7V4FA8CzuPilfaO59xdeyqmxDnjAzwpMtiidxg/zucKf03EahdnCAzr8f4llixBDacttL4dX5Oz0JgfSH5ekFAivUctmpGmy+o1KKPzeTzx9WlwNGx3ycA8Sa1vOzUAOOP0WanFoWC/aEEbzk+M1F+dOrtlwJgLdCcA= '' - # default install command is just `` Queue-Based Load Leveling pattern __EoT__ https : //msdn.microsoft.com/en-us/library/dn589783.aspx
diff -- git a/event-queue/src/main/java/com/iluwatar/event/queue/App.java b/event-queue/src/main/java/com/iluwatar/event/queue/App.java index ea107d6..8154d66 100644 -- - a/event-queue/src/main/java/com/iluwatar/event/queue/App.java +++ b/event-queue/src/main/java/com/iluwatar/event/queue/App.java @ @ -29,31 +29,42 @ @ import java.io.InputStreamReader ; import javax.sound.sampled.UnsupportedAudioFileException ; +import org.slf4j.Logger ; +import org.slf4j.LoggerFactory ; + /** - * Event or message queues provide an asynchronous communications protocol , meaning that the sender - * and receiver of the message do not need to interact with the message queue at the same time . - * Events or messages placed onto the queue are stored until the recipient retrieves them . Event - * or message queues have implicit or explicit limits on the size of data that may be transmitted - * in a single message and the number of messages that may remain outstanding on the queue . - * A queue stores a series of notifications or requests in first-in , first-out order . - * Sending a notification enqueues the request and returns . The request processor then processes - * items from the queue at a later time . + * Event or message queues provide an asynchronous communications protocol , meaning that the sender and receiver of the + * message do not need to interact with the SonarQube reports bugs __EoT__ The project is automatically scanned with SonarQube . The static code analysis reports several blocker and critical level issues that should be fixed . https : //sonarcloud.io/project/issues ? id=com.iluwatar % 3Ajava-design-patterns & resolved=false & severities=BLOCKER % 2CCRITICAL & types=BUG
diff -- git a/pom.xml b/pom.xml index 3c86ed5..fbca861 100644 -- - a/pom.xml +++ b/pom.xml @ @ -46,6 +46,7 @ @ < module > state < /module > < module > strategy < /module > < module > template-method < /module > + < module > twin < /module > < module > visitor < /module > < module > double-checked-locking < /module > < module > servant < /module > diff -- git a/twin/.gitignore b/twin/.gitignore new file mode 100644 index 0000000..b83d222 -- - /dev/null +++ b/twin/.gitignore @ @ -0,0 +1 @ @ +/target/ diff -- git a/twin/etc/twin.png b/twin/etc/twin.png new file mode 100644 index 0000000..7240925 Binary files /dev/null and b/twin/etc/twin.png differ diff -- git a/twin/etc/twin.ucls b/twin/etc/twin.ucls new file mode 100644 index 0000000..6948dbf -- - /dev/null +++ b/twin/etc/twin.ucls @ @ -0,0 +1,79 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < class-diagram version= '' 1.1.8 '' icons= '' true '' automaticImage= '' PNG '' always-add-relationships= '' false '' generalizations= '' true '' + realizations= '' true '' associations= '' true '' dependencies= '' false '' nesting-relationships= '' true '' > + < class id= '' 1 '' language= '' java '' name= '' com.iluwatar.twin.BallThread Twin design pattern __EoT__ http : //www.ssw.uni-linz.ac.at/Research/Papers/Moe99/Paper.pdf
diff -- git a/efficient_cache/README.md b/efficient_cache/README.md new file mode 100644 index 0000000..73821ad -- - /dev/null +++ b/efficient_cache/README.md @ @ -0,0 +1,37 @ @ + + # # Intent +Efficient cache result is a high-performance framework for saving cached results.It tries to solve the performance +problems of some algorithms in high concurrency situations . + ! [ UML ] ( etc/eifficient_cache.jpg ) + + # # Explanation +It almost does not lock to complete the results cache and get the results.In the case of concurrency , +when need a result , the result is taken immediately if it has already been calculated . + + # # Applicability +- You frequently calculate a value +- You want to safely save the results under concurrency conditions +- You do not want to lock when saving results + + # # Tutorials +First you should new a entity class of CacheResult . + `` `` java +//java 1.8 +CacheResult < Long , Long > cacheResult = BlockHardlyCacheResult. < Long , Long > createNeedComputeFunction ( key - > key += 1 ) ; + `` `` + `` `` java +//java 1.7 +CacheResult < Long , Long > cacheResult = BlockHardlyCacheResult. < Long , Long a new design pattern : efficient-cache __EoT__ I have an idea for building an efficient cache design to solve the problem of needing to calculate the same situation frequently in some scenarios . I 'm working on it . I am annotating now , the function has been achieved.I hope I can get your approval .
diff -- git a/NOTICE b/NOTICE index 39897e8..7f6b7fa 100644 -- - a/NOTICE +++ b/NOTICE @ @ -75,3 +75,12 @ @ freely , subject to the following restrictions : 3 . This notice may not be removed or altered from any source distribution . + + -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- +NOTICES FOR C++ Big Integer Library + -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- + +I , Matt McCutchen , the sole author of the original Big Integer +Library , waive my copyright to it , placing it in the public domain . +The library comes with absolutely no warranty . + diff -- git a/cpp/SConscript b/cpp/SConscript index 54baddb..ab563c4 100644 -- - a/cpp/SConscript +++ b/cpp/SConscript @ @ -27,7 +27,7 @ @ else : cxxflags.append ( '-Wall -Wextra -Werror ' ) # -Werror else Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it __EoT__ Test Name : Monkey Test 24____________ Version : _1__________ Severity ( Fatal , Serious , Minor ) : _Minor____________ Type : ( Coding Error , Design Issue , Suggestion , Documentation ) : _Coding Error__________ Summary : _Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it___________________ Able to be reproduced ? ( Yes/No ) : _Yes________ What is the problem and how can it be reproduced ? **See Monkey output file____________________________________________________** **run Monkey with seed 1431365035477_______________________________________** -- - Suggestions ( optional ) : -- - -- - -- - Reported By : **Drew Carlstedt______________** Date : _5/13/2015_______ ~~~~~~~~~~~~~~~~~~~~~ DEVELOPMENT TEAM ONLY ~~~~~~~~~~~~~~~~~~~~~ Functional Area : ____________________________ Assigned To : ____________________ Comments : ___________________________________________________________________________ -- - Status ( Open/Closed ) : _____________________ Priority ( 1-5 ) : __________________ Resolution ( Pending , Fixed , Irreproducible , Reassigned , As Intended , Unfixable , Withdrawn , Requesting More Information , Disagree with Suggestion ) : ___________________________ Resolved By : _______________________ Date :
diff -- git a/src/org/thoughtcrime/securesms/sms/MessageSender.java b/src/org/thoughtcrime/securesms/sms/MessageSender.java index 2660a8a..97a854a 100644 -- - a/src/org/thoughtcrime/securesms/sms/MessageSender.java +++ b/src/org/thoughtcrime/securesms/sms/MessageSender.java @ @ -286,6 +286,10 @ @ public class MessageSender { return false ; } + if ( TextSecurePreferences.isMultiDevice ( context ) ) { + return false ; + } + return Util.isOwnNumber ( context , recipients.getPrimaryRecipient ( ) .getNumber ( ) ) ; } Self-sent messages are duplicated __EoT__ I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- - # # # Bug description When sending a message to one 's own account , it appears twice , using twice as much screen space . I know I sent it and I know I got it , showing it once is enough . # # # Steps to reproduce - make a contact for yourself with your number if you do n't already have one - write a message to your contact **Actual result : ** The message I sent appears twice . **Expected result : ** The message I sent should appear as sent or as received , but not both , which is redundant . # # # Screenshots ! [ stop repeating everything ] ( https : //cloud.githubusercontent.com/assets/643789/19829648/62908150-9de7-11e6-9cb3-5943a04598fc.png ) # # # Device info **Device : ** Huawei P8 Lite **Android version : ** 6.0 **Signal version : ** 3.20.4
diff -- git a/src/org/thoughtcrime/redphone/RedPhoneService.java b/src/org/thoughtcrime/redphone/RedPhoneService.java index a94798e..0757d02 100644 -- - a/src/org/thoughtcrime/redphone/RedPhoneService.java +++ b/src/org/thoughtcrime/redphone/RedPhoneService.java @ @ -293,14 +293,17 @ @ public class RedPhoneService extends Service implements CallStateListener , CallS AudioManager audioManager = ServiceUtil.getAudioManager ( this ) ; AudioUtils.resetConfiguration ( this ) ; - audioManager.requestAudioFocus ( null , AudioManager.STREAM_VOICE_CALL , - AudioManager.AUDIOFOCUS_GAIN_TRANSIENT ) ; + Log.d ( TAG , `` request STREAM_VOICE_CALL audio focus '' ) ; + audioManager.requestAudioFocus ( null , AudioManager.STREAM_VOICE_CALL , AudioManager.AUDIOFOCUS_GAIN ) ; } private void shutdownAudio ( ) { - AudioManager am = ( AudioManager ) getSystemService ( AUDIO_SERVICE ) ; + Log.d ( TAG , `` reset audio mode and abandon focus '' ) ; + AudioUtils.resetConfiguration ( this ) ; + AudioManager am = ServiceUtil.getAudioManager ( this ) ; am.setMode ( AudioManager.MODE_NORMAL ) ; am.abandonAudioFocus ( null ) ; + am.stopBluetoothSco ( ) ; } public int getState ( ) { diff -- git a/src/org/thoughtcrime/redphone/audio/CallAudioManager.java b/src/org/thoughtcrime/redphone/audio/CallAudioManager.java index 34a5c8b..cf32051 100644 -- - a/src/org/thoughtcrime/redphone/audio/CallAudioManager.java +++ b/src/org/thoughtcrime/redphone/audio/CallAudioManager.java @ @ -45,6 +45,7 @ @ public class CallAudioManager { public void start ( @ NonNull Context context ) throws AudioException { if ( Build.VERSION.SDK_INT > = 11 ) { + Log.d ( TAG , `` set MODE_IN_COMMUNICATION audio mode '' Low sound in call ( Signal 3.5.2+ ) __EoT__ Hey , I still have the problem of the closed issue # 4244 . The workaround of enabling/disabling speakers still does the trick . Device info : Samsung I9300 , CM Lolipop 5.1.1 , Signal 3.5.2 Debug log : https : //gist.github.com/anonymous/b09ff201c845cddd5da1 In the log , I phoned a friend , confirmed that I could barely hear him , then did the workaround . Then I confirmed I could hear him well and stopped the call .
diff -- git a/res/layout/conversation_item_received.xml b/res/layout/conversation_item_received.xml index 385bcbb..e866915 100644 -- - a/res/layout/conversation_item_received.xml +++ b/res/layout/conversation_item_received.xml @ @ -123,7 +123,7 @ @ android : contentDescription= '' @ string/conversation_item__secure_message_description '' android : visibility= '' gone '' android : alpha= '' .65 '' - android : tint= '' ? conversation_item_received_text_secondary_color '' + android : tint= '' red_400 '' android : tintMode= '' multiply '' tools : visibility= '' visible '' / > [ Feature Request ] Ability to delete safety numbers __EoT__ When another signal user has a temporary phone , or decides to delete signal , there is no option to purge keys for that user and return to Insecure SMS as default . It would be great if there was a remove keys , or reset user function in the menu to clean their key from your device .
diff -- git a/res/values/arrays.xml b/res/values/arrays.xml index a10f39b..91cbd41 100644 -- - a/res/values/arrays.xml +++ b/res/values/arrays.xml @ @ -269,6 +269,8 @ @ < item > 43200 < /item > < item > 86400 < /item > < item > 604800 < /item > + < item > 1814400 < /item > + < item > 7257600 < /item > < /integer-array > < array name= '' scribble_colors '' > disappearing messages with 1 Month __EoT__ Disappearing Messages are great . But sometimes information is relevant for more than a Week but should still disappear after a while . It would be great to also have the possibility to configure disappearing messages to stay 1 Month
diff -- git a/.gitignore b/.gitignore index ccf7cd1..ae3bf7b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,4 +3,4 @ @ project.properties .project .settings bin/ -gen/ +gen/ \ No newline at end of file diff -- git a/assets/DDC_Uchen.ttf b/assets/DDC_Uchen.ttf new file mode 100644 index 0000000..b4707dc Binary files /dev/null and b/assets/DDC_Uchen.ttf differ diff -- git a/assets/monlambodyig.ttf b/assets/monlambodyig.ttf new file mode 100644 index 0000000..3f51f30 Binary files /dev/null and b/assets/monlambodyig.ttf differ diff -- git a/build.xml b/build.xml new file mode 100644 index 0000000..2569595 -- - /dev/null +++ b/build.xml @ @ -0,0 +1,85 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < project name= '' TextSecure '' default= '' help '' > + + < ! -- The local.properties file is created and updated by the 'android ' tool . + It contains the path to the SDK . It should *NOT* be checked into + Version Control Systems . -- > + < property file= '' local.properties '' / > + + < ! -- The ant.properties file can be created by you . It is only edited by the + 'android ' tool to add properties to it . + This is the place to change Heap corruption ( and crash ) when image should be displayed in message list __EoT__ When viewing a conversation history with a user , and an image is visible in the listing ( or more accurately , when there should be an image visible ) then heap corruption occurs . Sony Xperia Z running PABX 's Android 4.4 build with GApps , ( build 3.2 ) . Example errors ( each from a different crash ) 11-08 22:31:24.878 : A/libc ( 13885 ) : Fatal signal 11 ( SIGSEGV ) at 0x75282000 ( code=1 ) , thread 13903 ( pool-1-thread-1 ) 11-08 22:39:48.720 : A/libc ( 20017 ) : Fatal signal 11 ( SIGSEGV ) at 0x737d5000 ( code=1 ) , thread 20048 ( pool-1-thread-1 ) 11-08 22:41:58.737 : A/libc ( 20544 ) : heap corruption detected by dlmalloc 11-08 22:41:58.737 : A/libc ( 20544 ) : Fatal signal 6 ( SIGABRT ) at 0x00005040 ( code=-6 ) , thread 20636 ( AsyncTask # 5 ) 11-08 22:41:58.737 : A/libc ( 20544 ) : Fatal signal 11 ( SIGSEGV ) at 0x7ede9000 ( code=1 ) , thread 20561 ( pool-1-thread-1 ) More complete content from LogCat : 11-08 22:41:58.597 :
diff -- git a/res/values-ru/strings.xml b/res/values-ru/strings.xml new file mode 100644 index 0000000..a0f3efb -- - /dev/null +++ b/res/values-ru/strings.xml @ @ -0,0 +1,6 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < resources > + < string name= '' app_name '' > TextSecure < /string > + < string name= '' yes '' > Да < /string > + < string name= '' no '' > Нет < /string > + < /resources > Heap corruption ( and crash ) when image should be displayed in message list __EoT__ When viewing a conversation history with a user , and an image is visible in the listing ( or more accurately , when there should be an image visible ) then heap corruption occurs . Sony Xperia Z running PABX 's Android 4.4 build with GApps , ( build 3.2 ) . Example errors ( each from a different crash ) 11-08 22:31:24.878 : A/libc ( 13885 ) : Fatal signal 11 ( SIGSEGV ) at 0x75282000 ( code=1 ) , thread 13903 ( pool-1-thread-1 ) 11-08 22:39:48.720 : A/libc ( 20017 ) : Fatal signal 11 ( SIGSEGV ) at 0x737d5000 ( code=1 ) , thread 20048 ( pool-1-thread-1 ) 11-08 22:41:58.737 : A/libc ( 20544 ) : heap corruption detected by dlmalloc 11-08 22:41:58.737 : A/libc ( 20544 ) : Fatal signal 6 ( SIGABRT ) at 0x00005040 ( code=-6 ) , thread 20636 ( AsyncTask # 5 ) 11-08 22:41:58.737 : A/libc ( 20544 ) : Fatal signal 11 ( SIGSEGV ) at 0x7ede9000 ( code=1 ) , thread 20561 ( pool-1-thread-1 ) More complete content from LogCat : 11-08 22:41:58.597 :
diff -- git a/res/values-nb-rNO/strings.xml b/res/values-nb-rNO/strings.xml new file mode 100644 index 0000000..99e89a4 -- - /dev/null +++ b/res/values-nb-rNO/strings.xml @ @ -0,0 +1,335 @ @ + < ? xml version='1.0 ' encoding='UTF-8 ' ? > + < resources > + < string name= '' app_name '' > TextSecure < /string > + < string name= '' yes '' > Ja < /string > + < string name= '' no '' > Nei < /string > + < ! -- ApplicationExportManager -- > + < string name= '' import_database_and_settings_title '' > Importer database og instillinger ? < /string > + < string name= '' import_database_and_settings_message '' > Importer TextSecure meldingsdatabase , nøkler og innstillinger fra SD-kort ? \n\nADVARSEL : Dette vil overskrive eksisterende meldinger , nøkler og innstillinger ! < /string > + < string name= '' importing_database_and_keys '' > Importerer database og nøkler < /string > + < string name= '' importing_your_sms_database_keys_and_settings '' > Importerer meldingsdatabasen din , nøkler og instillinger ... < /string > + < string name= '' export_database_question '' > Eksporter database ? < /string > + < string name= '' export_textsecure_database_keys_and_settings_prompt '' > Eksporter TextSecure meldingsdatabase , nøkler og instillinger til SD-kort ? < /string > + < string RedPhone wake lock __EoT__ Tonight , my battery was drained by Signal : ! [ screenshot_20151107-105052 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015169/aec483b2-8553-11e5-92d5-9568f778d9bc.png ) ! [ screenshot_20151107-105104 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015165/93fb8184-8553-11e5-9ea0-ee4ec3506311.png ) ! [ screenshot_20151107-105137 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015166/93fc98bc-8553-11e5-9fd4-6c46a73df59b.png ) Here 's the output for ` adb shell dumpsys batterystats org.thoughtcrime.securesms ` : ` Discharge step durations : # 0 : +2m9s405ms to 5 ( screen-on , power-save-off , device-idle-off ) # 1 : +1m24s531ms to 6 ( screen-on , power-save-off , device-idle-off ) # 2 : +3m6s473ms to 7 ( power-save-off , device-idle-off ) # 3 : +2m39s164ms to 8 ( power-save-off , device-idle-off ) # 4 : +3m14s315ms to 9 ( screen-off , power-save-off , device-idle-off ) # 5 : +2m53s732ms to 10 ( screen-off , power-save-off , device-idle-off ) # 6 : +3m3s139ms to 11 ( power-save-off , device-idle-off ) # 7 : +1h13m28s252ms to 12 ( power-save-off ) # 8 : +4m18s750ms to 13 ( screen-off , power-save-off , device-idle-off ) # 9 : +8m23s863ms to 14 ( screen-off , power-save-off , device-idle-off ) # 10 : +7m46s850ms to 15 ( screen-off , power-save-off , device-idle-off ) # 11 : +5m59s900ms to 16 ( screen-off ,
diff -- git a/src/org/thoughtcrime/securesms/service/SmsListener.java b/src/org/thoughtcrime/securesms/service/SmsListener.java index 194ba36..35358b8 100644 -- - a/src/org/thoughtcrime/securesms/service/SmsListener.java +++ b/src/org/thoughtcrime/securesms/service/SmsListener.java @ @ -75,6 +75,9 @ @ public class SmsListener extends BroadcastReceiver { if ( isExemption ( message , messageBody ) ) return false ; + + if ( message.getMessageClass ( ) == SmsMessage.MessageClass.CLASS_0 ) + return false ; if ( PreferenceManager.getDefaultSharedPreferences ( context ) .getBoolean ( `` pref_all_sms '' , true ) ) return true ; RedPhone wake lock __EoT__ Tonight , my battery was drained by Signal : ! [ screenshot_20151107-105052 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015169/aec483b2-8553-11e5-92d5-9568f778d9bc.png ) ! [ screenshot_20151107-105104 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015165/93fb8184-8553-11e5-9ea0-ee4ec3506311.png ) ! [ screenshot_20151107-105137 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015166/93fc98bc-8553-11e5-9fd4-6c46a73df59b.png ) Here 's the output for ` adb shell dumpsys batterystats org.thoughtcrime.securesms ` : ` Discharge step durations : # 0 : +2m9s405ms to 5 ( screen-on , power-save-off , device-idle-off ) # 1 : +1m24s531ms to 6 ( screen-on , power-save-off , device-idle-off ) # 2 : +3m6s473ms to 7 ( power-save-off , device-idle-off ) # 3 : +2m39s164ms to 8 ( power-save-off , device-idle-off ) # 4 : +3m14s315ms to 9 ( screen-off , power-save-off , device-idle-off ) # 5 : +2m53s732ms to 10 ( screen-off , power-save-off , device-idle-off ) # 6 : +3m3s139ms to 11 ( power-save-off , device-idle-off ) # 7 : +1h13m28s252ms to 12 ( power-save-off ) # 8 : +4m18s750ms to 13 ( screen-off , power-save-off , device-idle-off ) # 9 : +8m23s863ms to 14 ( screen-off , power-save-off , device-idle-off ) # 10 : +7m46s850ms to 15 ( screen-off , power-save-off , device-idle-off ) # 11 : +5m59s900ms to 16 ( screen-off ,
diff -- git a/src/org/thoughtcrime/securesms/service/SmsListener.java b/src/org/thoughtcrime/securesms/service/SmsListener.java index 194ba36..582e872 100644 -- - a/src/org/thoughtcrime/securesms/service/SmsListener.java +++ b/src/org/thoughtcrime/securesms/service/SmsListener.java @ @ -31,6 +31,11 @ @ public class SmsListener extends BroadcastReceiver { private static final String SMS_RECEIVED_ACTION = `` android.provider.Telephony.SMS_RECEIVED '' ; private boolean isExemption ( SmsMessage message , String messageBody ) { + + // ignore CLASS0 ( `` flash '' ) messages + if ( message.getMessageClass ( ) == SmsMessage.MessageClass.CLASS_0 ) + return false ; + // ignore OTP messages from Sparebank1 ( Norwegian bank ) if ( messageBody.startsWith ( `` Sparebank1 : //otp ? '' ) ) { return ( true ) ; RedPhone wake lock __EoT__ Tonight , my battery was drained by Signal : ! [ screenshot_20151107-105052 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015169/aec483b2-8553-11e5-92d5-9568f778d9bc.png ) ! [ screenshot_20151107-105104 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015165/93fb8184-8553-11e5-9ea0-ee4ec3506311.png ) ! [ screenshot_20151107-105137 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015166/93fc98bc-8553-11e5-9fd4-6c46a73df59b.png ) Here 's the output for ` adb shell dumpsys batterystats org.thoughtcrime.securesms ` : ` Discharge step durations : # 0 : +2m9s405ms to 5 ( screen-on , power-save-off , device-idle-off ) # 1 : +1m24s531ms to 6 ( screen-on , power-save-off , device-idle-off ) # 2 : +3m6s473ms to 7 ( power-save-off , device-idle-off ) # 3 : +2m39s164ms to 8 ( power-save-off , device-idle-off ) # 4 : +3m14s315ms to 9 ( screen-off , power-save-off , device-idle-off ) # 5 : +2m53s732ms to 10 ( screen-off , power-save-off , device-idle-off ) # 6 : +3m3s139ms to 11 ( power-save-off , device-idle-off ) # 7 : +1h13m28s252ms to 12 ( power-save-off ) # 8 : +4m18s750ms to 13 ( screen-off , power-save-off , device-idle-off ) # 9 : +8m23s863ms to 14 ( screen-off , power-save-off , device-idle-off ) # 10 : +7m46s850ms to 15 ( screen-off , power-save-off , device-idle-off ) # 11 : +5m59s900ms to 16 ( screen-off ,
diff -- git a/res/values-nb-rNO/arrays.xml b/res/values-nb-rNO/arrays.xml new file mode 100644 index 0000000..f6402d0 -- - /dev/null +++ b/res/values-nb-rNO/arrays.xml @ @ -0,0 +1,42 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < resources > + + < string-array name= '' minutes_hours '' > + < item > minutter < /item > + < item > timer < /item > + < /string-array > + + < string-array name= '' pref_led_color_entries '' > + < item > Grønn < /item > + < item > Rød < /item > + < item > Blå < /item > + < item > Oransje < /item > + < item > Cyan < /item > + < item > Magenta < /item > + < /string-array > + + + < string-array name= '' pref_led_color_values '' translatable= '' false '' > + < item > green < /item > + < item > red < /item > + < item > blue < /item > + < item > yellow < /item > + < item > cyan < /item > + < item > magenta < /item > + < /string-array > + + < string-array RedPhone wake lock __EoT__ Tonight , my battery was drained by Signal : ! [ screenshot_20151107-105052 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015169/aec483b2-8553-11e5-92d5-9568f778d9bc.png ) ! [ screenshot_20151107-105104 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015165/93fb8184-8553-11e5-9ea0-ee4ec3506311.png ) ! [ screenshot_20151107-105137 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015166/93fc98bc-8553-11e5-9fd4-6c46a73df59b.png ) Here 's the output for ` adb shell dumpsys batterystats org.thoughtcrime.securesms ` : ` Discharge step durations : # 0 : +2m9s405ms to 5 ( screen-on , power-save-off , device-idle-off ) # 1 : +1m24s531ms to 6 ( screen-on , power-save-off , device-idle-off ) # 2 : +3m6s473ms to 7 ( power-save-off , device-idle-off ) # 3 : +2m39s164ms to 8 ( power-save-off , device-idle-off ) # 4 : +3m14s315ms to 9 ( screen-off , power-save-off , device-idle-off ) # 5 : +2m53s732ms to 10 ( screen-off , power-save-off , device-idle-off ) # 6 : +3m3s139ms to 11 ( power-save-off , device-idle-off ) # 7 : +1h13m28s252ms to 12 ( power-save-off ) # 8 : +4m18s750ms to 13 ( screen-off , power-save-off , device-idle-off ) # 9 : +8m23s863ms to 14 ( screen-off , power-save-off , device-idle-off ) # 10 : +7m46s850ms to 15 ( screen-off , power-save-off , device-idle-off ) # 11 : +5m59s900ms to 16 ( screen-off ,
diff -- git a/res/values/strings.xml b/res/values/strings.xml index a4461de..773d8f3 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -73,6 +73,8 @ @ < ! -- ConversationFragment -- > < string name= '' ConversationFragment_message_details '' > Message details < /string > < string name= '' ConversationFragment_sender_s_transport_s_sent_received_s '' > Sender : % 1 $ s\nTransport : % 2 $ s\nSent/Received : % 3 $ s < /string > + < string name= '' ConversationFragment_delete_message_dialogtitle '' > Confirm Message Delete < /string > + < string name= '' ConversationFragment_are_you_sure_you_want_to_permanently_delete_this_message '' > Are you sure that you want to permanently delete this message ? < /string > < ! -- ConversationListAdapter -- > < string name= '' ConversationListAdapter_encrypted_message_enter_passphrase '' > '' Encrypted message , enter passphrase ... `` < /string > @ @ -117,6 +119,9 @ @ < ! -- ReviewIdentitiesActivity -- > < string name= '' ReviewIdentitiesActivity_unable_to_view_corrupted_identity_key_exclamation '' > Unable to view corrupted identity key ! < /string > + < string name= '' ReviewIdentitiesActivity_delete_identity_dialogtitle '' > Delete identity ? < /string > + < string name= '' ReviewIdentitiesActivity_delete_identity_are_you_sure_you_want_to_delete_this_identity_key '' > Are you sure that you wish to permanently delete this identity key ? < /string > + < string name= '' ReviewIdentitiesActivity_invalid_identity '' > Invalid RedPhone wake lock __EoT__ Tonight , my battery was drained by Signal : ! [ screenshot_20151107-105052 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015169/aec483b2-8553-11e5-92d5-9568f778d9bc.png ) ! [ screenshot_20151107-105104 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015165/93fb8184-8553-11e5-9ea0-ee4ec3506311.png ) ! [ screenshot_20151107-105137 ] ( https : //cloud.githubusercontent.com/assets/4339033/11015166/93fc98bc-8553-11e5-9fd4-6c46a73df59b.png ) Here 's the output for ` adb shell dumpsys batterystats org.thoughtcrime.securesms ` : ` Discharge step durations : # 0 : +2m9s405ms to 5 ( screen-on , power-save-off , device-idle-off ) # 1 : +1m24s531ms to 6 ( screen-on , power-save-off , device-idle-off ) # 2 : +3m6s473ms to 7 ( power-save-off , device-idle-off ) # 3 : +2m39s164ms to 8 ( power-save-off , device-idle-off ) # 4 : +3m14s315ms to 9 ( screen-off , power-save-off , device-idle-off ) # 5 : +2m53s732ms to 10 ( screen-off , power-save-off , device-idle-off ) # 6 : +3m3s139ms to 11 ( power-save-off , device-idle-off ) # 7 : +1h13m28s252ms to 12 ( power-save-off ) # 8 : +4m18s750ms to 13 ( screen-off , power-save-off , device-idle-off ) # 9 : +8m23s863ms to 14 ( screen-off , power-save-off , device-idle-off ) # 10 : +7m46s850ms to 15 ( screen-off , power-save-off , device-idle-off ) # 11 : +5m59s900ms to 16 ( screen-off ,
diff -- git a/res/layout/webrtc_call_screen.xml b/res/layout/webrtc_call_screen.xml index 6c78a9f..bf0a1ee 100644 -- - a/res/layout/webrtc_call_screen.xml +++ b/res/layout/webrtc_call_screen.xml @ @ -158,7 +158,7 @ @ < /LinearLayout > < ! -- Elapsed time indication for a call in progress . -- > - < TextView android : id= '' @ +id/elapsedTime '' + < Chronometer android : id= '' @ +id/elapsedTime '' android : layout_alignParentRight= '' true '' android : layout_centerVertical= '' true '' android : layout_width= '' wrap_content '' @ @ -166,6 +166,7 @ @ android : textAppearance= '' ? android : attr/textAppearanceMedium '' android : textColor= '' # FFFFFF '' android : singleLine= '' true '' + android : visibility= '' invisible '' / > < /RelativeLayout > diff -- git a/src/org/thoughtcrime/securesms/components/webrtc/WebRtcCallScreen.java b/src/org/thoughtcrime/securesms/components/webrtc/WebRtcCallScreen.java index 7db63b4..13650aa 100644 -- - a/src/org/thoughtcrime/securesms/components/webrtc/WebRtcCallScreen.java +++ b/src/org/thoughtcrime/securesms/components/webrtc/WebRtcCallScreen.java @ @ -18,6 +18,10 @ @ package org.thoughtcrime.securesms.components.webrtc ; import android.content.Context ; +import android.os.Bundle ; +import android.os.Handler ; +import android.os.ResultReceiver ; +import android.os.SystemClock ; import android.support.annotation.NonNull ; import android.support.annotation.Nullable ; import android.support.design.widget.FloatingActionButton ; @ @ -31,6 +35,7 @ @ import android.view.LayoutInflater ; import android.view.View ; import android.view.ViewGroup ; import android.widget.Button ; +import android.widget.Chronometer ; import android.widget.FrameLayout ; import android.widget.ImageView ; import android.widget.RelativeLayout ; @ @ -69,7 +74,7 @ @ public class WebRtcCallScreen extends Call 's elapsed time is not shown __EoT__ - [ X ] I have searched open and closed issues for duplicates - [ X ] I am submitting a bug report for existing functionality that does not work as intended - [ X ] I have read https : //github.com/signalapp/Signal-Android/wiki/Submitting-useful-bug-reports - [ X ] This is n't a feature request or a discussion topic -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description The Call Screen 's elapsedTime widget is not being used therefore there 's no call duration shown to the user . # # # Steps to reproduce - do the call - once connected , the call elapsed time should be shown **Actual result : ** nothing is being shown **Expected result : ** call elapsed time should be visible during the whole call
diff -- git a/res/layout/webrtc_call_screen.xml b/res/layout/webrtc_call_screen.xml index 6c78a9f..bf0a1ee 100644 -- - a/res/layout/webrtc_call_screen.xml +++ b/res/layout/webrtc_call_screen.xml @ @ -158,7 +158,7 @ @ < /LinearLayout > < ! -- Elapsed time indication for a call in progress . -- > - < TextView android : id= '' @ +id/elapsedTime '' + < Chronometer android : id= '' @ +id/elapsedTime '' android : layout_alignParentRight= '' true '' android : layout_centerVertical= '' true '' android : layout_width= '' wrap_content '' @ @ -166,6 +166,7 @ @ android : textAppearance= '' ? android : attr/textAppearanceMedium '' android : textColor= '' # FFFFFF '' android : singleLine= '' true '' + android : visibility= '' invisible '' / > < /RelativeLayout > diff -- git a/src/org/thoughtcrime/securesms/components/webrtc/WebRtcCallScreen.java b/src/org/thoughtcrime/securesms/components/webrtc/WebRtcCallScreen.java index 7db63b4..4dfa2b8 100644 -- - a/src/org/thoughtcrime/securesms/components/webrtc/WebRtcCallScreen.java +++ b/src/org/thoughtcrime/securesms/components/webrtc/WebRtcCallScreen.java @ @ -18,6 +18,10 @ @ package org.thoughtcrime.securesms.components.webrtc ; import android.content.Context ; +import android.os.Bundle ; +import android.os.Handler ; +import android.os.ResultReceiver ; +import android.os.SystemClock ; import android.support.annotation.NonNull ; import android.support.annotation.Nullable ; import android.support.design.widget.FloatingActionButton ; @ @ -31,6 +35,7 @ @ import android.view.LayoutInflater ; import android.view.View ; import android.view.ViewGroup ; import android.widget.Button ; +import android.widget.Chronometer ; import android.widget.FrameLayout ; import android.widget.ImageView ; import android.widget.RelativeLayout ; @ @ -69,7 +74,7 @ @ public class WebRtcCallScreen extends Call 's elapsed time is not shown __EoT__ - [ X ] I have searched open and closed issues for duplicates - [ X ] I am submitting a bug report for existing functionality that does not work as intended - [ X ] I have read https : //github.com/signalapp/Signal-Android/wiki/Submitting-useful-bug-reports - [ X ] This is n't a feature request or a discussion topic -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description The Call Screen 's elapsedTime widget is not being used therefore there 's no call duration shown to the user . # # # Steps to reproduce - do the call - once connected , the call elapsed time should be shown **Actual result : ** nothing is being shown **Expected result : ** call elapsed time should be visible during the whole call
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index df8f7b6..ea8201d 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -11,7 +11,7 @ @ android : label= '' Access to TextSecure Secrets '' android : protectionLevel= '' signature '' / > - < ! -- < uses-feature android : name= '' android.hardware.camera '' android : required= '' false '' / > -- > + < uses-feature android : name= '' android.hardware.camera '' android : required= '' false '' / > < uses-permission android : name= '' org.thoughtcrime.securesms.ACCESS_SECRETS '' / > < uses-permission android : name= '' android.permission.READ_PROFILE '' / > < uses-permission android : name= '' android.permission.WRITE_PROFILE '' / > @ @ -34,47 +34,47 @ @ < uses-permission android : name= '' android.permission.WRITE_EXTERNAL_STORAGE '' / > < uses-permission android : name= '' android.permission.READ_CALL_LOG '' / > < uses-permission android : name= '' android.permission.GET_ACCOUNTS '' / > - < ! -- < uses-permission android : name= '' android.permission.CAMERA '' / > -- > + < uses-permission android : name= '' android.permission.CAMERA '' / > < uses-permission android : name= '' com.google.android.c2dm.permission.RECEIVE '' / > - < ! -- & lt ; ! & ndash ; For sending location tiles in the future & ndash ; & Change icon for Take photo __EoT__ In the attachment dialog _Take photo_ and _Contact info_ use the same icon . The camera icon used in quick camera would suit _Take photo_ better . ! [ reinhold attachment ] ( https : //cloud.githubusercontent.com/assets/174176/8915245/8e2eebda-34ac-11e5-8286-7703cee6a5c2.png ) TS 2.23.3
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 85e316e..ddaf212 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -226,6 +226,14 @ @ < /intent-filter > < /activity > + < activity android : name= '' .RecipientPreferenceActivity '' + android : theme= '' @ style/TextSecure.LightNoActionBar '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + + < activity android : name= '' .BlockedContactsActivity '' + android : theme= '' @ style/TextSecure.LightTheme '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + < activity android : name= '' com.soundcloud.android.crop.CropImageActivity '' / > < service android : enabled= '' true '' android : name= '' .service.ApplicationMigrationService '' / > diff -- git a/res/drawable-hdpi/ic_block_grey600_18dp.png b/res/drawable-hdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..02982bf Binary files /dev/null and b/res/drawable-hdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_block_white_18dp.png b/res/drawable-hdpi/ic_block_white_18dp.png new file mode 100644 index 0000000..71b0a08 Binary files /dev/null and b/res/drawable-hdpi/ic_block_white_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_grey600_18dp.png b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png new file mode 100644 index 0000000..6cf04dc Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_white_18dp.png b/res/drawable-hdpi/ic_volume_off_white_18dp.png new file mode 100644 index 0000000..a227897 Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_white_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_grey600_18dp.png b/res/drawable-mdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..ddf39b3 Binary files /dev/null and b/res/drawable-mdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_white_18dp.png b/res/drawable-mdpi/ic_block_white_18dp.png new file mode 100644 index Feature Request - Block Texts __EoT__ It would be a nice feature to be able to block texts . This could be because someone is sending you spam SMS or maybe you have a person who is bothering you . I think you should be able to instruct the program to reject texts from certain numbers .
diff -- git a/src/org/thoughtcrime/redphone/audio/OutgoingRinger.java b/src/org/thoughtcrime/redphone/audio/OutgoingRinger.java index 85931c8..08e3b68 100644 -- - a/src/org/thoughtcrime/redphone/audio/OutgoingRinger.java +++ b/src/org/thoughtcrime/redphone/audio/OutgoingRinger.java @ @ -39,15 +39,10 @ @ public class OutgoingRinger implements MediaPlayer.OnCompletionListener , MediaPl private MediaPlayer mediaPlayer ; private int currentSoundID ; - private boolean loopEnabled ; private Context context ; public OutgoingRinger ( Context context ) { this.context = context ; - - loopEnabled = true ; - currentSoundID = -1 ; - } public void playSonar ( ) { @ @ -74,23 +69,22 @ @ public class OutgoingRinger implements MediaPlayer.OnCompletionListener , MediaPl start ( R.raw.redphone_busy ) ; } - private void setSound ( int soundID ) { - currentSoundID = soundID ; - loopEnabled = true ; + private void start ( int soundID ) { + start ( soundID , true ) ; } - private void start ( int soundID ) { + private void start ( int soundID , boolean loop ) { if ( soundID == currentSoundID ) return ; - setSound ( soundID ) ; - start ( ) ; - } - private void start ( ) { - if ( mediaPlayer ! = null ) mediaPlayer.release ( ) ; + if ( mediaPlayer ! = null ) mediaPlayer.release ( OutgoingRinger NPE on network failure __EoT__ < ! -- mark with x between the [ ] -- > I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports # # # Bug description Got this crash today during the Redphone relay outage : `` ` D/RedPhoneService ( 18728 ) : java.lang.NullPointerException D/RedPhoneService ( 18728 ) : at org.thoughtcrime.redphone.audio.OutgoingRinger.onPrepared ( OutgoingRinger.java:147 ) D/RedPhoneService ( 18728 ) : at android.media.MediaPlayer $ EventHandler.handleMessage ( MediaPlayer.java:1992 ) D/RedPhoneService ( 18728 ) : at android.os.Handler.dispatchMessage ( Handler.java:99 ) D/RedPhoneService ( 18728 ) : at android.os.Looper.loop ( Looper.java:153 ) D/RedPhoneService ( 18728 ) : at android.app.ActivityThread.main ( ActivityThread.java:5299 ) `` ` Happens [ here ] ( https : //github.com/WhisperSystems/Signal-Android/blob/fa22fb755084b3c2d8064811d6be79ee0b617eac/src/org/thoughtcrime/redphone/audio/OutgoingRinger.java # L147 ) , not sure how that 's possible ? Might be something for redphone wizard @ cascheberg # # # Steps to reproduce - try to place a Signal call during the relay outage ( setting phone to airplane mode somehow is n't enough , so I ca n't reproduce : / ) - get a `` network failed '' message - crash # # # Device info **Android version : ** 4.2.2
diff -- git a/src/org/thoughtcrime/securesms/push/SignalServiceNetworkAccess.java b/src/org/thoughtcrime/securesms/push/SignalServiceNetworkAccess.java index 3f0def0..aed80a1 100644 -- - a/src/org/thoughtcrime/securesms/push/SignalServiceNetworkAccess.java +++ b/src/org/thoughtcrime/securesms/push/SignalServiceNetworkAccess.java @ @ -30,7 +30,7 @ @ public class SignalServiceNetworkAccess { put ( `` +20 '' , new SignalServiceUrl [ ] { new SignalServiceUrl ( `` https : //www.google.com.eg '' , APPSPOT_REFLECTOR_HOST , googleTrustStore ) , - baseAndroid } ) ; + baseAndroid } ) ; put ( `` +971 '' , new SignalServiceUrl [ ] { new SignalServiceUrl ( `` https : //www.google.ae '' , APPSPOT_REFLECTOR_HOST , @ @ -40,12 +40,13 @ @ public class SignalServiceNetworkAccess { put ( `` +53 '' , new SignalServiceUrl [ ] { new SignalServiceUrl ( `` https : //www.google.com.om '' , APPSPOT_REFLECTOR_HOST , googleTrustStore ) , - baseAndroid , baseGoogle } ) ; + baseAndroid , baseGoogle } ) ; put ( `` +968 '' , new SignalServiceUrl [ ] { new SignalServiceUrl ( `` https : //www.google.com.cu '' , APPSPOT_REFLECTOR_HOST , googleTrustStore ) , baseAndroid , baseGoogle } ) ; + put ( `` +98 '' , new SignalServiceUrl [ ] { baseAndroid , baseGoogle } ) ; } } ; this.uncensoredConfiguration = new SignalServiceUrl [ ] { Add Iran to censored countries list __EoT__ Here is the log that I ca n't connect to textsecure-service.whispersystems.org https : //gist.github.com/anonymous/fea6d946aea279e0a748ef4094d575af Thank you so much .
diff -- git a/res/xml/preferences_advanced.xml b/res/xml/preferences_advanced.xml index e463d69..715e4f2 100644 -- - a/res/xml/preferences_advanced.xml +++ b/res/xml/preferences_advanced.xml @ @ -3,7 +3,7 @ @ < PreferenceScreen xmlns : android= '' http : //schemas.android.com/apk/res/android '' > < org.thoughtcrime.securesms.components.SwitchPreferenceCompat android : defaultValue= '' false '' - android : key= '' pref_toggle_push_messaging '' + android : key= '' pref_toggle_messaging '' android : title= '' @ string/preferences__signal_messages_and_calls '' android : summary= '' @ string/preferences__free_private_messages_and_calls '' / > diff -- git a/src/org/thoughtcrime/securesms/ApplicationPreferencesActivity.java b/src/org/thoughtcrime/securesms/ApplicationPreferencesActivity.java index 8cb41ce..b993fd0 100644 -- - a/src/org/thoughtcrime/securesms/ApplicationPreferencesActivity.java +++ b/src/org/thoughtcrime/securesms/ApplicationPreferencesActivity.java @ @ -167,7 +167,7 @ @ public class ApplicationPreferencesActivity extends PassphraseRequiredActionBarA private void setCategoryVisibility ( ) { Preference devicePreference = this.findPreference ( PREFERENCE_CATEGORY_DEVICES ) ; - if ( devicePreference ! = null & & ! TextSecurePreferences.isPushRegistered ( getActivity ( ) ) ) { + if ( devicePreference ! = null & & ! TextSecurePreferences.isRegistered ( getActivity ( ) ) ) { getPreferenceScreen ( ) .removePreference ( devicePreference ) ; } } diff -- git a/src/org/thoughtcrime/securesms/ConversationActivity.java b/src/org/thoughtcrime/securesms/ConversationActivity.java index a89d3b1..2f2e6e6 100644 -- - a/src/org/thoughtcrime/securesms/ConversationActivity.java +++ b/src/org/thoughtcrime/securesms/ConversationActivity.java @ @ -927,7 +927,7 @ @ public class ConversationActivity extends PassphraseRequiredActionBarActivity protected void updateInviteReminder ( boolean seenInvite ) { Log.w ( TAG , `` updateInviteReminder ( `` + seenInvite+ '' ) '' ) ; - Please make Signal work with microG out of the box __EoT__ I have an android smartphone without Google Play services . The reason for that is that I do n't trust Google to not add NSA backdoors if asked or possibly snoop around my data in other intrusive ways , and while I 'm aware Android also has a rather spotty security track record and might contain backdoors directly , at least it provides a reasonable possibility for external code reviews to discover such issues . This tweet made me look into the open-source microG to run Signal : https : //twitter.com/whispersystems/status/783817903120318465 ( as per the rationale given above , I 'm somewhat ok with additional open-source components on my phone and not very happy about more closed-source components ) However , even with microG installed , I 'm getting the popup `` Google Play Services - Signal relies on google Play Services , which is not supported by your device . Contact the manufacturer for assistance '' . I would assume this is because I do n't have spoofing enabled , which allows microG to seamlessly replace the google services transparently for any installed apps . https : //github.com/microg/android_packages_apps_GmsCore/wiki/Signature-Spoofing
diff -- git a/src/org/thoughtcrime/securesms/database/ThreadDatabase.java b/src/org/thoughtcrime/securesms/database/ThreadDatabase.java index 7ef2845..5f197bf 100644 -- - a/src/org/thoughtcrime/securesms/database/ThreadDatabase.java +++ b/src/org/thoughtcrime/securesms/database/ThreadDatabase.java @ @ -132,6 +132,9 @ @ public class ThreadDatabase extends Database { public void updateSnippet ( long threadId , String snippet , long type ) { ContentValues contentValues = new ContentValues ( 3 ) ; + long date = System.currentTimeMillis ( ) ; + + contentValues.put ( DATE , date - date % 1000 ) ; contentValues.put ( SNIPPET , snippet ) ; contentValues.put ( SNIPPET_TYPE , type ) ; SQLiteDatabase db = databaseHelper.getWritableDatabase ( ) ; drafts should be marked and moved to top of list __EoT__ the message drafts should be automatically moved to the top of the message-list and be marked somehow , i.e . get another color or a text `` Draft ''
diff -- git a/build.gradle b/build.gradle index 76f6c00..3efcb90 100644 -- - a/build.gradle +++ b/build.gradle @ @ -36,6 +36,7 @ @ dependencies { compile 'com.astuetz : pagerslidingtabstrip:1.0.1' compile 'org.w3c : smil:1.0.0' compile 'org.apache.httpcomponents : httpclient-android:4.3.5' + compile 'org.whispersystems : libpastelog:1.0.2' androidTestCompile 'com.squareup : fest-android:1.0.8' androidTestCompile 'com.google.dexmaker : dexmaker:1.1' @ @ -54,6 +55,7 @ @ dependencyVerification { 'com.astuetz : pagerslidingtabstrip : f1641396732c7132a7abb837e482e5ee2b0ebb8d10813fc52bbaec2c15c184c2 ' , 'org.w3c : smil:085dc40f2bb249651578bfa07499fd08b16ad0886dbe2c4078586a408da62f9b ' , 'org.apache.httpcomponents : httpclient-android:6f56466a9bd0d42934b90bfbfe9977a8b654c058bf44a12bdc2877c4e1f033f1 ' , + 'org.whispersystems : libpastelog:9798b3c93a91082c2c68542ce5b5c182e18556aebdcb7c8cebbd89eb48ac4047 ' , 'com.android.support : support-annotations:1aa96ef0cc4a445bfc2f93ccf762305bc57fa107b12afe9d11f3863ae8a11036 ' , 'com.google.protobuf : protobuf-java : e0c1c64575c005601725e7c6a02cebf9e1285e888f756b2a1d73ffa8d725cc74 ' , 'com.madgag : sc-light-jdk15on:931f39d351429fb96c2f749e7ecb1a256a8ebbf5edca7995c9cc085b94d1841d ' , diff -- git a/res/layout/log_submit_activity.xml b/res/layout/log_submit_activity.xml index 7c0cf5d..bea73d8 100644 -- - a/res/layout/log_submit_activity.xml +++ b/res/layout/log_submit_activity.xml @ @ -1,51 +1,11 @ @ < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > < LinearLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' + android : id= '' @ +id/fragment_container '' android : orientation= '' vertical '' android : layout_width= '' match_parent '' android : layout_height= '' match_parent '' > - < TextView android : id= '' @ +id/log_submit_confirmation '' - android : layout_width= '' fill_parent '' - android : layout_height= '' wrap_content '' - android : textSize= '' 18sp '' - android : textStyle= '' bold Privacy : Remove Phone Numbers from Debug Log __EoT__ Please remove or make phone Numbers unrecognizable in the Debug Logs
diff -- git a/src/org/thoughtcrime/securesms/ConversationItem.java b/src/org/thoughtcrime/securesms/ConversationItem.java index 56da3ee..95ede6b 100644 -- - a/src/org/thoughtcrime/securesms/ConversationItem.java +++ b/src/org/thoughtcrime/securesms/ConversationItem.java @ @ -403,7 +403,9 @ @ public class ConversationItem extends LinearLayout { public void onClick ( final View v , final Slide slide ) { if ( ! batchSelected.isEmpty ( ) ) { selectionClickListener.onItemClick ( null , ConversationItem.this , -1 , -1 ) ; - } else if ( MediaPreviewActivity.isContentTypeSupported ( slide.getContentType ( ) ) ) { + } else if ( MediaPreviewActivity.isContentTypeSupported ( slide.getContentType ( ) ) & & + slide.getThumbnailUri ( ) ! = null ) + { Intent intent = new Intent ( context , MediaPreviewActivity.class ) ; intent.addFlags ( Intent.FLAG_GRANT_READ_URI_PERMISSION ) ; intent.setDataAndType ( slide.getUri ( ) , slide.getContentType ( ) ) ; @ @ -411,7 +413,7 @ @ public class ConversationItem extends LinearLayout { intent.putExtra ( MediaPreviewActivity.DATE_EXTRA , messageRecord.getDateReceived ( ) ) ; context.startActivity ( intent ) ; - } else { + } else if ( slide.getThumbnailUri ( ) ! = null ) { AlertDialogWrapper.Builder builder = new AlertDialogWrapper.Builder ( context ) ; builder.setTitle ( R.string.ConversationItem_view_secure_media_question ) ; builder.setIconAttribute ( R.attr.dialog_alert_icon ) ; media preview of attachment being downloaded __EoT__ it 's possible to open the media preview activity when tapping on an attachment that is in the process of downloading ( ie you 're receiving it and only see the download icon ) . in this case you just see an empty ( all black ) media preview and upon tapping the save icon `` error saving to storage '' . super picky , but should be easy enough to prevent this from happening and I think it should be done . reproducible on master and f1137927d4a9441f0dced4840d714f1ad95266d9 .
diff -- git a/res/layout/import_fragment.xml b/res/layout/import_fragment.xml index 0867b3b..50135a6 100644 -- - a/res/layout/import_fragment.xml +++ b/res/layout/import_fragment.xml @ @ -80,7 +80,7 @ @ < TextView android : layout_width= '' match_parent '' android : layout_height= '' wrap_content '' style= '' @ style/Registration.Description '' - android : text= '' @ string/import_fragment__import_encrypted_backup '' / > + android : text= '' @ string/import_fragment__restore_encrypted_backup '' / > < TextView android : layout_width= '' match_parent '' android : layout_height= '' wrap_content '' diff -- git a/res/menu/text_secure_normal.xml b/res/menu/text_secure_normal.xml index f1b51c2..a30d703 100644 -- - a/res/menu/text_secure_normal.xml +++ b/res/menu/text_secure_normal.xml @ @ -16,7 +16,7 @ @ < item android : title= '' @ string/arrays__import_export '' android : id= '' @ +id/menu_import_export '' / > - < item android : title= '' @ string/arrays__my_identity_key '' + < item android : title= '' @ string/arrays__your_identity_key '' android : id= '' @ +id/menu_my_identity '' / > < item android : title= '' @ string/text_secure_normal__menu_settings '' diff -- git a/res/values/strings.xml b/res/values/strings.xml index 7905261..0164369 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -140,7 +140,7 @ @ < item quantity= '' other '' > This will permanently delete all % 1 $ d selected messages. < /item > < /plurals > < string name= '' ConversationFragment_save_to_sd_card '' > Save to storage Show who has Signal and who has n't in the list of text messages __EoT__ Hello . I wish there was a way of telling who has Signal and who has n't immediately by looking at the contact 's name on the `` front page '' of Signal . It would only take a tiny lock next to their name . As it is right now , there is no way of teling if a user has Signal or not , unless you click their name . It 's not a big deal , I know . But if the long term goal of Signal is to compete with WhatsApp I would say this feature is a necessity . Sorry for a dizzy post , I 've had the flu for quite some time now .
diff -- git a/res/layout/transport_selection.xml b/res/layout/transport_selection.xml deleted file mode 100644 index d532f27..0000000 -- - a/res/layout/transport_selection.xml +++ /dev/null @ @ -1,12 +0,0 @ @ - < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > - - < LinearLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' - android : orientation= '' vertical '' - android : layout_width= '' wrap_content '' - android : layout_height= '' wrap_content '' - android : background= '' ? conversation_transport_popup_background '' - android : elevation= '' 2dp '' > - < ListView android : id= '' @ +id/transport_selection_list '' - android : layout_width= '' wrap_content '' - android : layout_height= '' wrap_content '' / > - < /LinearLayout > diff -- git a/src/org/thoughtcrime/securesms/TransportOptionsPopup.java b/src/org/thoughtcrime/securesms/TransportOptionsPopup.java index f813d77..c0c7adb 100644 -- - a/src/org/thoughtcrime/securesms/TransportOptionsPopup.java +++ b/src/org/thoughtcrime/securesms/TransportOptionsPopup.java @ @ -1,124 +1,40 @ @ package org.thoughtcrime.securesms ; -import android.animation.Animator ; -import android.animation.Animator.AnimatorListener ; -import android.annotation.TargetApi ; import android.content.Context ; -import android.graphics.drawable.BitmapDrawable ; -import android.os.Build.VERSION ; -import android.os.Build.VERSION_CODES ; import android.support.annotation.NonNull ; -import android.view.LayoutInflater ; +import android.support.v7.widget.ListPopupWindow ; import android.view.View ; -import android.view.ViewAnimationUtils ; -import android.view.ViewTreeObserver.OnGlobalLayoutListener ; -import android.view.WindowManager ; import android.widget.AdapterView ; import android.widget.ListView ; -import android.widget.PopupWindow ; import java.util.LinkedList ; import java.util.List ; -public class TransportOptionsPopup implements ListView.OnItemClickListener { NPE : switching to SMS when message length is > 144 ( i.e . SMS message counter toggled ) __EoT__ A crash mentioned by @ merkste in # 3571 1 ) Type a string that has at least 145 characters¹ on the compose field An example string ( 158 chars ) : `` ` '' Bless the Maker and His water , '' Kynes murmured . `` Bless the coming and going of Him . May His passage cleanse the world . May He keep the world for His people . '' `` ` 2 ) Long-press the send arrow and change to SMS mode 3 ) TS crashes https : //gist.github.com/anonymous/0ee1496d68fdd4fc58ff `` ` E/AndroidRuntime ( 5058 ) : FATAL EXCEPTION : main E/AndroidRuntime ( 5058 ) : Process : org.thoughtcrime.securesms , PID : 5058 E/AndroidRuntime ( 5058 ) : java.lang.NullPointerException : Attempt to invoke virtual method 'android.view.ViewTreeObserver android.view.View.getViewTreeObserver ( ) ' on a null object reference E/AndroidRuntime ( 5058 ) : at org.thoughtcrime.securesms.TransportOptionsPopup $ 2.onGlobalLayout ( TransportOptionsPopup.java:89 ) E/AndroidRuntime ( 5058 ) : at android.view.ViewTreeObserver.dispatchOnGlobalLayout ( ViewTreeObserver.java:912 ) E/AndroidRuntime ( 5058 ) : at android.view.ViewRootImpl.performTraversals ( ViewRootImpl.java:1881 ) E/AndroidRuntime ( 5058 ) : at android.view.ViewRootImpl.doTraversal ( ViewRootImpl.java:1061 ) E/AndroidRuntime
diff -- git a/artwork/logo-512.png b/artwork/logo-512.png index 9ff2982..282f477 100644 Binary files a/artwork/logo-512.png and b/artwork/logo-512.png differ diff -- git a/res/drawable-hdpi-v11/icon_notification.png b/res/drawable-hdpi-v11/icon_notification.png index aa31bf5..025ce4d 100644 Binary files a/res/drawable-hdpi-v11/icon_notification.png and b/res/drawable-hdpi-v11/icon_notification.png differ diff -- git a/res/drawable-hdpi-v9/icon_notification.png b/res/drawable-hdpi-v9/icon_notification.png index ffa5235..f0f52a2 100644 Binary files a/res/drawable-hdpi-v9/icon_notification.png and b/res/drawable-hdpi-v9/icon_notification.png differ diff -- git a/res/drawable-hdpi/actionbar_icon_holo_dark.png b/res/drawable-hdpi/actionbar_icon_holo_dark.png index c2efbf0..8985c30 100644 Binary files a/res/drawable-hdpi/actionbar_icon_holo_dark.png and b/res/drawable-hdpi/actionbar_icon_holo_dark.png differ Pixel Launcher round icon ( and make Android icon consistent with desktop and iOS ) __EoT__ < ! -- This is a bug report template . By following the instructions below and filling out the sections with your information , you will help the developers to get all the necessary data to fix your issue . You can also preview your report before submitting it . You may remove sections that are n't relevant to your particular case . Before we begin , please note that this tracker is only for issues , not questions or comments . If you are looking for support , please see our support center instead : http : //support.whispersystems.org/ or email support @ whispersystems.org Let 's begin with a checklist : replace the empty checkboxes [ ] below with checked ones [ x ] accordingly -- > I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description The new Pixel Launcher on Google 's Pixel and Pixel
diff -- git a/artwork/logo-512-pixel-launcher.png b/artwork/logo-512-pixel-launcher.png new file mode 100644 index 0000000..d11c685 Binary files /dev/null and b/artwork/logo-512-pixel-launcher.png differ diff -- git a/artwork/logo-512.png b/artwork/logo-512.png index 9ff2982..282f477 100644 Binary files a/artwork/logo-512.png and b/artwork/logo-512.png differ diff -- git a/res/drawable-hdpi-v11/icon_notification.png b/res/drawable-hdpi-v11/icon_notification.png index aa31bf5..025ce4d 100644 Binary files a/res/drawable-hdpi-v11/icon_notification.png and b/res/drawable-hdpi-v11/icon_notification.png differ diff -- git a/res/drawable-hdpi-v9/icon_notification.png b/res/drawable-hdpi-v9/icon_notification.png index ffa5235..f0f52a2 100644 Binary files a/res/drawable-hdpi-v9/icon_notification.png and b/res/drawable-hdpi-v9/icon_notification.png differ diff -- git a/res/drawable-hdpi/actionbar_icon_holo_dark.png b/res/drawable-hdpi/actionbar_icon_holo_dark.png index c2efbf0..8985c30 100644 Binary files a/res/drawable-hdpi/actionbar_icon_holo_dark.png and b/res/drawable-hdpi/actionbar_icon_holo_dark.png differ diff -- git a/res/drawable-hdpi/lockscreen_watermark_dark.png b/res/drawable-hdpi/lockscreen_watermark_dark.png index 84537ce..974973e 100644 Binary files a/res/drawable-hdpi/lockscreen_watermark_dark.png and b/res/drawable-hdpi/lockscreen_watermark_dark.png differ diff -- git a/res/drawable-hdpi/lockscreen_watermark_light.png b/res/drawable-hdpi/lockscreen_watermark_light.png index 7cbf49a..f4c7970 100644 Binary files a/res/drawable-hdpi/lockscreen_watermark_light.png and b/res/drawable-hdpi/lockscreen_watermark_light.png differ diff -- git a/res/drawable-mdpi-v9 b/res/drawable-mdpi-v9 new file mode 100644 index 0000000..8b13789 -- - /dev/null +++ b/res/drawable-mdpi-v9 @ @ -0,0 +1 @ @ + diff -- git a/res/drawable-mdpi-v9/icon_notification.png b/res/drawable-mdpi-v9/icon_notification.png deleted file mode 100644 index 6153b25..0000000 Binary files a/res/drawable-mdpi-v9/icon_notification.png and /dev/null differ diff -- git a/res/drawable-mdpi/actionbar_icon_holo_dark.png b/res/drawable-mdpi/actionbar_icon_holo_dark.png index 73ae590..8ca171f 100644 Binary files a/res/drawable-mdpi/actionbar_icon_holo_dark.png and b/res/drawable-mdpi/actionbar_icon_holo_dark.png differ diff -- git a/res/drawable-mdpi/lockscreen_watermark_dark.png b/res/drawable-mdpi/lockscreen_watermark_dark.png index 88772f0..778efed 100644 Binary files a/res/drawable-mdpi/lockscreen_watermark_dark.png and b/res/drawable-mdpi/lockscreen_watermark_dark.png differ diff -- git a/res/drawable-mdpi/lockscreen_watermark_light.png b/res/drawable-mdpi/lockscreen_watermark_light.png index 9e7b501..f25c1e0 100644 Binary files a/res/drawable-mdpi/lockscreen_watermark_light.png and b/res/drawable-mdpi/lockscreen_watermark_light.png differ Pixel Launcher round icon ( and make Android icon consistent with desktop and iOS ) __EoT__ < ! -- This is a bug report template . By following the instructions below and filling out the sections with your information , you will help the developers to get all the necessary data to fix your issue . You can also preview your report before submitting it . You may remove sections that are n't relevant to your particular case . Before we begin , please note that this tracker is only for issues , not questions or comments . If you are looking for support , please see our support center instead : http : //support.whispersystems.org/ or email support @ whispersystems.org Let 's begin with a checklist : replace the empty checkboxes [ ] below with checked ones [ x ] accordingly -- > I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description The new Pixel Launcher on Google 's Pixel and Pixel
diff -- git a/artwork/logo-512-pixel-launcher.png b/artwork/logo-512-pixel-launcher.png new file mode 100644 index 0000000..d11c685 Binary files /dev/null and b/artwork/logo-512-pixel-launcher.png differ diff -- git a/artwork/logo-512.png b/artwork/logo-512.png index 9ff2982..282f477 100644 Binary files a/artwork/logo-512.png and b/artwork/logo-512.png differ diff -- git a/res/drawable-hdpi-v11/icon_notification.png b/res/drawable-hdpi-v11/icon_notification.png index aa31bf5..025ce4d 100644 Binary files a/res/drawable-hdpi-v11/icon_notification.png and b/res/drawable-hdpi-v11/icon_notification.png differ diff -- git a/res/drawable-hdpi-v9/icon_notification.png b/res/drawable-hdpi-v9/icon_notification.png index ffa5235..f0f52a2 100644 Binary files a/res/drawable-hdpi-v9/icon_notification.png and b/res/drawable-hdpi-v9/icon_notification.png differ diff -- git a/res/drawable-hdpi/actionbar_icon_holo_dark.png b/res/drawable-hdpi/actionbar_icon_holo_dark.png index c2efbf0..8985c30 100644 Binary files a/res/drawable-hdpi/actionbar_icon_holo_dark.png and b/res/drawable-hdpi/actionbar_icon_holo_dark.png differ diff -- git a/res/drawable-hdpi/lockscreen_watermark_dark.png b/res/drawable-hdpi/lockscreen_watermark_dark.png index 84537ce..974973e 100644 Binary files a/res/drawable-hdpi/lockscreen_watermark_dark.png and b/res/drawable-hdpi/lockscreen_watermark_dark.png differ diff -- git a/res/drawable-hdpi/lockscreen_watermark_light.png b/res/drawable-hdpi/lockscreen_watermark_light.png index 7cbf49a..f4c7970 100644 Binary files a/res/drawable-hdpi/lockscreen_watermark_light.png and b/res/drawable-hdpi/lockscreen_watermark_light.png differ diff -- git a/res/drawable-mdpi-v11/icon_notification.png b/res/drawable-mdpi-v11/icon_notification.png index 01f9abd..47a1f32 100644 Binary files a/res/drawable-mdpi-v11/icon_notification.png and b/res/drawable-mdpi-v11/icon_notification.png differ diff -- git a/res/drawable-mdpi-v9/icon_notification.png b/res/drawable-mdpi-v9/icon_notification.png index 6153b25..1f550ea 100644 Binary files a/res/drawable-mdpi-v9/icon_notification.png and b/res/drawable-mdpi-v9/icon_notification.png differ diff -- git a/res/drawable-mdpi/actionbar_icon_holo_dark.png b/res/drawable-mdpi/actionbar_icon_holo_dark.png index 73ae590..8ca171f 100644 Binary files a/res/drawable-mdpi/actionbar_icon_holo_dark.png and b/res/drawable-mdpi/actionbar_icon_holo_dark.png differ diff -- git a/res/drawable-mdpi/lockscreen_watermark_dark.png b/res/drawable-mdpi/lockscreen_watermark_dark.png index 88772f0..778efed 100644 Binary files a/res/drawable-mdpi/lockscreen_watermark_dark.png and b/res/drawable-mdpi/lockscreen_watermark_dark.png differ diff -- git a/res/drawable-mdpi/lockscreen_watermark_light.png b/res/drawable-mdpi/lockscreen_watermark_light.png index 9e7b501..f25c1e0 100644 Binary files a/res/drawable-mdpi/lockscreen_watermark_light.png and b/res/drawable-mdpi/lockscreen_watermark_light.png differ diff -- git a/res/drawable-xxhdpi/actionbar_icon_holo_dark.png b/res/drawable-xxhdpi/actionbar_icon_holo_dark.png index 7b5e31d..656e6c4 100644 Binary files a/res/drawable-xxhdpi/actionbar_icon_holo_dark.png and b/res/drawable-xxhdpi/actionbar_icon_holo_dark.png differ Pixel Launcher round icon ( and make Android icon consistent with desktop and iOS ) __EoT__ < ! -- This is a bug report template . By following the instructions below and filling out the sections with your information , you will help the developers to get all the necessary data to fix your issue . You can also preview your report before submitting it . You may remove sections that are n't relevant to your particular case . Before we begin , please note that this tracker is only for issues , not questions or comments . If you are looking for support , please see our support center instead : http : //support.whispersystems.org/ or email support @ whispersystems.org Let 's begin with a checklist : replace the empty checkboxes [ ] below with checked ones [ x ] accordingly -- > I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description The new Pixel Launcher on Google 's Pixel and Pixel
diff -- git a/res/drawable-hdpi-v11/icon_notification.png b/res/drawable-hdpi-v11/icon_notification.png index aa31bf5..025ce4d 100644 Binary files a/res/drawable-hdpi-v11/icon_notification.png and b/res/drawable-hdpi-v11/icon_notification.png differ diff -- git a/res/drawable-hdpi-v9/icon_notification.png b/res/drawable-hdpi-v9/icon_notification.png index ffa5235..f0f52a2 100644 Binary files a/res/drawable-hdpi-v9/icon_notification.png and b/res/drawable-hdpi-v9/icon_notification.png differ diff -- git a/res/drawable-hdpi/actionbar_icon_holo_dark.png b/res/drawable-hdpi/actionbar_icon_holo_dark.png index c2efbf0..a75443f 100644 Binary files a/res/drawable-hdpi/actionbar_icon_holo_dark.png and b/res/drawable-hdpi/actionbar_icon_holo_dark.png differ diff -- git a/res/drawable-hdpi/actionbar_icon_holo_light.png b/res/drawable-hdpi/actionbar_icon_holo_light.png new file mode 100644 index 0000000..4977ce2 Binary files /dev/null and b/res/drawable-hdpi/actionbar_icon_holo_light.png differ diff -- git a/res/drawable-hdpi/ic_signal_grey_24dp.png b/res/drawable-hdpi/ic_signal_grey_24dp.png index e01390d..0389fad 100644 Binary files a/res/drawable-hdpi/ic_signal_grey_24dp.png and b/res/drawable-hdpi/ic_signal_grey_24dp.png differ diff -- git a/res/drawable-hdpi/ic_signal_white_48dp.png b/res/drawable-hdpi/ic_signal_white_48dp.png index 28ede6b..d418114 100644 Binary files a/res/drawable-hdpi/ic_signal_white_48dp.png and b/res/drawable-hdpi/ic_signal_white_48dp.png differ diff -- git a/res/drawable-hdpi/icon.png b/res/drawable-hdpi/icon.png index aba1dee..551f8df 100644 Binary files a/res/drawable-hdpi/icon.png and b/res/drawable-hdpi/icon.png differ diff -- git a/res/drawable-hdpi/icon_circle.png b/res/drawable-hdpi/icon_circle.png new file mode 100644 index 0000000..a467775 Binary files /dev/null and b/res/drawable-hdpi/icon_circle.png differ diff -- git a/res/drawable-hdpi/icon_dialog.png b/res/drawable-hdpi/icon_dialog.png index 0ed7d03..6cd58fc 100644 Binary files a/res/drawable-hdpi/icon_dialog.png and b/res/drawable-hdpi/icon_dialog.png differ diff -- git a/res/drawable-hdpi/lockscreen_watermark_dark.png b/res/drawable-hdpi/lockscreen_watermark_dark.png index 84537ce..974973e 100644 Binary files a/res/drawable-hdpi/lockscreen_watermark_dark.png and b/res/drawable-hdpi/lockscreen_watermark_dark.png differ diff -- git a/res/drawable-hdpi/lockscreen_watermark_light.png b/res/drawable-hdpi/lockscreen_watermark_light.png index 7cbf49a..f4c7970 100644 Binary files a/res/drawable-hdpi/lockscreen_watermark_light.png and b/res/drawable-hdpi/lockscreen_watermark_light.png differ diff -- git a/res/drawable-mdpi-v11/icon_notification.png b/res/drawable-mdpi-v11/icon_notification.png index 01f9abd..47a1f32 100644 Binary files a/res/drawable-mdpi-v11/icon_notification.png and b/res/drawable-mdpi-v11/icon_notification.png differ diff -- git a/res/drawable-mdpi-v9/icon_notification.png b/res/drawable-mdpi-v9/icon_notification.png index 6153b25..1f550ea 100644 Binary files a/res/drawable-mdpi-v9/icon_notification.png and b/res/drawable-mdpi-v9/icon_notification.png differ diff -- git a/res/drawable-mdpi/actionbar_icon_holo_dark.png b/res/drawable-mdpi/actionbar_icon_holo_dark.png index 73ae590..f2148b4 100644 Binary files a/res/drawable-mdpi/actionbar_icon_holo_dark.png and Pixel Launcher round icon ( and make Android icon consistent with desktop and iOS ) __EoT__ < ! -- This is a bug report template . By following the instructions below and filling out the sections with your information , you will help the developers to get all the necessary data to fix your issue . You can also preview your report before submitting it . You may remove sections that are n't relevant to your particular case . Before we begin , please note that this tracker is only for issues , not questions or comments . If you are looking for support , please see our support center instead : http : //support.whispersystems.org/ or email support @ whispersystems.org Let 's begin with a checklist : replace the empty checkboxes [ ] below with checked ones [ x ] accordingly -- > I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description The new Pixel Launcher on Google 's Pixel and Pixel
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 7e30f6e..aff1242 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -194,6 +194,8 @ @ android : resource= '' @ drawable/icon '' / > < meta-data android : name= '' com.sec.minimode.icon.landscape.normal '' android : resource= '' @ drawable/icon '' / > + < meta-data android : name= '' android.app.shortcuts '' + android : resource= '' @ xml/shortcuts '' / > < /activity-alias > diff -- git a/res/drawable/ic_shortcut_new_conversation.xml b/res/drawable/ic_shortcut_new_conversation.xml new file mode 100644 index 0000000..e8f42ee -- - /dev/null +++ b/res/drawable/ic_shortcut_new_conversation.xml @ @ -0,0 +1,16 @ @ + < vector xmlns : android= '' http : //schemas.android.com/apk/res/android '' + android : width= '' 48dp '' + android : height= '' 48dp '' + android : viewportWidth= '' 48.0 '' + android : viewportHeight= '' 48.0 '' > + < path + android : pathData= '' M24,24m-22,0a22,22 0,1 1,44 0a22,22 0,1 1 , -44 0 '' + android : strokeColor= '' # 00000000 '' + android : fillColor= '' # F5F5F5 '' + android : strokeWidth= '' 1 '' / > + < path + android : pathData= '' M15,29.25L15,33L18.75,33L29.81,21.94L26.06,18.19L15,29.25L15,29.25ZM32.71,19.04C33.1,18.65 33.1,18.02 32.71,17.63L30.37,15.29C29.98,14.9 29.35,14.9 28.96,15.29L27.13,17.12L30.88,20.87L32.71,19.04L32.71,19.04Z '' + android : strokeColor= '' # 00000000 '' + android : fillColor= '' # Feature Request : App Shortcuts __EoT__ I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Feature Request Support for app shortucts in Android 7.1 and above . Here is the relevant documentation : [ App Shortcuts ] ( https : //developer.android.com/guide/topics/ui/shortcuts.html )
diff -- git a/src/org/thoughtcrime/securesms/service/SmsSender.java b/src/org/thoughtcrime/securesms/service/SmsSender.java index 8d7b328..5b1bc18 100644 -- - a/src/org/thoughtcrime/securesms/service/SmsSender.java +++ b/src/org/thoughtcrime/securesms/service/SmsSender.java @ @ -81,6 +81,7 @ @ public class SmsSender { while ( reader ! = null & & ( record = reader.getNext ( ) ) ! = null ) { try { + messageId = record.getId ( ) ; database.markAsSending ( record.getId ( ) ) ; transport.deliver ( record ) ; @ @ -88,13 +89,13 @ @ public class SmsSender { Log.w ( `` SmsSender '' , e ) ; IncomingIdentityUpdateMessage identityUpdateMessage = IncomingIdentityUpdateMessage.createFor ( e.getE164Number ( ) , e.getIdentityKey ( ) ) ; DatabaseFactory.getEncryptingSmsDatabase ( context ) .insertMessageInbox ( masterSecret , identityUpdateMessage ) ; - DatabaseFactory.getSmsDatabase ( context ) .markAsSentFailed ( messageId ) ; + DatabaseFactory.getSmsDatabase ( context ) .markAsSentFailed ( record.getId ( ) ) ; } catch ( UndeliverableMessageException ude ) { Log.w ( `` SmsSender '' , ude ) ; - DatabaseFactory.getSmsDatabase ( context ) .markAsSentFailed ( messageId ) ; + DatabaseFactory.getSmsDatabase ( context ) .markAsSentFailed ( record.getId ( ) ) ; } catch ( RetryLaterException rle ) { Log.w ( `` SmsSender '' , rle ) ; - DatabaseFactory.getSmsDatabase ( context ) .markAsOutbox ( messageId ) ; + DatabaseFactory.getSmsDatabase ( context ) .markAsOutbox PUSH messages sent without data connection are never sent at all __EoT__ When I send a push message while not having a data connection ( e.g . by manually disabling data and wifi ) and sms fallback disabled , these messages are displayed with a light blue background ( light theme ) as if the message is about to be sent . No error is displayed and the message is not detected as failed-to-send . When data connection returns , the messages are still displayed in the same state , without the option to resend them . Is that a bug or a feature ? ; ) The message details state that the message is to be sent via SMS . The only option is to manually copy and paste the text and send it again when the data connection returns .
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 2b27877..2c7d9bb 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -34,6 +34,10 @ @ < uses-permission android : name= '' android.permission.READ_CALL_LOG '' / > < uses-permission android : name= '' android.permission.GET_ACCOUNTS '' / > < uses-permission android : name= '' android.permission.WAKE_LOCK '' / > + < uses-permission android : name= '' android.permission.READ_SYNC_SETTINGS '' / > + < uses-permission android : name= '' android.permission.WRITE_SYNC_SETTINGS '' / > + < uses-permission android : name= '' android.permission.AUTHENTICATE_ACCOUNTS '' / > + < uses-permission android : name= '' com.google.android.c2dm.permission.RECEIVE '' / > < permission android : name= '' org.thoughtcrime.securesms.permission.C2D_MESSAGE '' @ @ -207,6 +211,26 @ @ < /intent-filter > < /service > + < service + android : name= '' org.thoughtcrime.securesms.util.DirectorySyncAuthenticatorService '' > + < intent-filter > + < action android : name= '' android.accounts.AccountAuthenticator '' / > + < /intent-filter > + < meta-data + android : name= '' android.accounts.AccountAuthenticator '' + android : resource= '' @ xml/authenticator '' / > + < /service > + + < service + android : name= '' org.thoughtcrime.securesms.util.DirectorySyncService '' + android : exported= '' true '' + android : process= '' : sync '' > + < intent-filter > + < Allow to set and sync Contact Pictures __EoT__ Allow users to set their own contact picture and sync it to other TextSecure users . In contrast to WhatsApp , provide those pictures to the system contact list to be used in any app , including but not limited to TextSecure . Is this possible using a SyncAdapter ( # 890 ) coupled with a ContentProvider ?
diff -- git a/src/org/thoughtcrime/securesms/util/MediaUtil.java b/src/org/thoughtcrime/securesms/util/MediaUtil.java index 0b1cf13..f8d7383 100644 -- - a/src/org/thoughtcrime/securesms/util/MediaUtil.java +++ b/src/org/thoughtcrime/securesms/util/MediaUtil.java @ @ -73,6 +73,10 @ @ public class MediaUtil { return PersistentBlobProvider.getMimeType ( context , uri ) ; } + if ( PartAuthority.isLocalUri ( uri ) ) { + return PartAuthority.getAttachmentContentType ( context , uri ) ; + } + String type = context.getContentResolver ( ) .getType ( uri ) ; if ( type == null ) { final String extension = MimeTypeMap.getFileExtensionFromUrl ( uri.toString ( ) ) ; Video losing file extension when forwarded from one chat to another __EoT__ Steps to reproduce - Share a mp4 video with a contact - Long press to select the video and tap the forward icon at the top - Paste into another chat **Actual result : ** The video will be unplayable in the desktop client because the file extension goes missing ( reportedly also in the ios client ) . ! [ capture1 ] ( https : //user-images.githubusercontent.com/1303537/39889036-010b21ac-5497-11e8-8a11-895b1dc2eda9.png ) Filename before forwarding : signal-2018-05-10-191631.mp4 Filename after forwarding : signal-2018-05-10-191916.- **Expected result : ** The video should retain the file extension and be playable in the client . # # # Device info **Device : ** Sony Xperia XZ2 Compact **Android version : ** 8.0.0 **Signal version : ** 4.19.3
diff -- git a/src/org/thoughtcrime/securesms/database/AttachmentDatabase.java b/src/org/thoughtcrime/securesms/database/AttachmentDatabase.java index 6230d5c..e7f0914 100644 -- - a/src/org/thoughtcrime/securesms/database/AttachmentDatabase.java +++ b/src/org/thoughtcrime/securesms/database/AttachmentDatabase.java @ @ -668,7 +668,7 @ @ public class AttachmentDatabase extends Database { } if ( ! hasThumbnail & & dataInfo ! = null ) { - if ( MediaUtil.hasVideoThumbnail ( attachment.getDataUri ( ) ) ) { + if ( MediaUtil.hasVideoThumbnail ( context , attachment.getDataUri ( ) ) ) { Bitmap bitmap = MediaUtil.getVideoThumbnail ( context , attachment.getDataUri ( ) ) ; if ( bitmap ! = null ) { diff -- git a/src/org/thoughtcrime/securesms/mms/DecryptableStreamLocalUriFetcher.java b/src/org/thoughtcrime/securesms/mms/DecryptableStreamLocalUriFetcher.java index faa131b..3d9eac6 100644 -- - a/src/org/thoughtcrime/securesms/mms/DecryptableStreamLocalUriFetcher.java +++ b/src/org/thoughtcrime/securesms/mms/DecryptableStreamLocalUriFetcher.java @ @ -30,7 +30,7 @ @ class DecryptableStreamLocalUriFetcher extends StreamLocalUriFetcher { @ Override protected InputStream loadResource ( Uri uri , ContentResolver contentResolver ) throws FileNotFoundException { - if ( MediaUtil.hasVideoThumbnail ( uri ) ) { + if ( MediaUtil.hasVideoThumbnail ( context , uri ) ) { Bitmap thumbnail = MediaUtil.getVideoThumbnail ( context , uri ) ; if ( thumbnail ! = null ) { diff -- git a/src/org/thoughtcrime/securesms/mms/VideoSlide.java b/src/org/thoughtcrime/securesms/mms/VideoSlide.java index 84750dd..c3ee288 100644 -- - a/src/org/thoughtcrime/securesms/mms/VideoSlide.java +++ b/src/org/thoughtcrime/securesms/mms/VideoSlide.java @ @ -30,7 +30,7 @ @ import org.thoughtcrime.securesms.util.ResUtil ; public class VideoSlide extends Slide { public VideoSlide ( Context context , Uri uri , long dataSize ) { Video losing file extension when forwarded from one chat to another __EoT__ Steps to reproduce - Share a mp4 video with a contact - Long press to select the video and tap the forward icon at the top - Paste into another chat **Actual result : ** The video will be unplayable in the desktop client because the file extension goes missing ( reportedly also in the ios client ) . ! [ capture1 ] ( https : //user-images.githubusercontent.com/1303537/39889036-010b21ac-5497-11e8-8a11-895b1dc2eda9.png ) Filename before forwarding : signal-2018-05-10-191631.mp4 Filename after forwarding : signal-2018-05-10-191916.- **Expected result : ** The video should retain the file extension and be playable in the client . # # # Device info **Device : ** Sony Xperia XZ2 Compact **Android version : ** 8.0.0 **Signal version : ** 4.19.3
diff -- git a/res/layout/contact_selection_list_fragment.xml b/res/layout/contact_selection_list_fragment.xml index 3d695bb..5b7b0bc 100644 -- - a/res/layout/contact_selection_list_fragment.xml +++ b/res/layout/contact_selection_list_fragment.xml @ @ -1,5 +1,6 @ @ < FrameLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' + xmlns : app= '' http : //schemas.android.com/apk/res-auto '' android : layout_width= '' match_parent '' android : layout_height= '' match_parent '' android : orientation= '' vertical '' > @ @ -31,6 +32,7 @ @ android : id= '' @ +id/fast_scroller '' android : layout_width= '' wrap_content '' android : layout_height= '' match_parent '' + app : textSize= '' 48sp '' android : visibility= '' gone '' android : layout_gravity= '' end '' / > diff -- git a/res/layout/conversation_fragment.xml b/res/layout/conversation_fragment.xml index 68e2f6f..8524ca5 100644 -- - a/res/layout/conversation_fragment.xml +++ b/res/layout/conversation_fragment.xml @ @ -42,11 +42,11 @ @ android : visibility= '' gone '' android : layout_width= '' wrap_content '' android : layout_height= '' wrap_content '' - android : layout_marginEnd= '' 10dp '' - android : layout_marginRight= '' 10dp '' + android : layout_marginStart= '' 10dp '' + android : layout_marginLeft= '' 10dp '' android : layout_marginBottom= '' 20dp '' android : padding= '' 5dp '' - android : layout_gravity= '' bottom|end '' + android : layout_gravity= '' bottom|start '' android : background= '' @ drawable/circle_tintable Calendrical fast scrolling for conversation view __EoT__ < ! -- This is a bug report template . By following the instructions below and filling out the sections with your information , you will help the developers to get all the necessary data to fix your issue . You can also preview your report before submitting it . You may remove sections that are n't relevant to your particular case . Before we begin , please note that this tracker is only for issues , not questions or comments . If you are looking for support , please see our support center instead : https : //support.whispersystems.org/ or email support @ whispersystems.org Let 's begin with a checklist : replace the empty checkboxes [ ] below with checked ones [ x ] accordingly -- > I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description With the introduction of ( sticky ) date headers , it would make sense to add fast scrolling to
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 745e24f..0eb0631 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -37,7 +37,7 @ @ android : protectionLevel= '' signature '' / > < uses-permission android : name= '' org.thoughtcrime.securesms.permission.C2D_MESSAGE '' / > - < application android : name= '' org.thoughtcrime.securesms.ApplicationListener '' + < application android : name= '' .ApplicationContext '' android : icon= '' @ drawable/icon '' android : label= '' @ string/app_name '' android : theme= '' @ style/TextSecure.LightTheme '' > diff -- git a/build.gradle b/build.gradle index 701f031..da52cea 100644 -- - a/build.gradle +++ b/build.gradle @ @ -25,8 +25,9 @ @ dependencies { compile 'com.actionbarsherlock : actionbarsherlock:4.4.0 @ aar' compile 'com.android.support : support-v4:19.1.0' compile 'se.emilsjolander : stickylistheaders:2.2.0' - compile 'com.google.android.gms : play-services:5.0.77' compile 'com.astuetz : pagerslidingtabstrip:1.0.1' + compile `` com.google.android.gms : play-services:5.0.77 '' + compile 'com.path : android-priority-jobqueue:1.1.2' androidTestCompile 'com.squareup : fest-android:1.0.8' @ @ -39,10 +40,11 @ @ dependencyVerification { 'com.android.support : support-v4:3f40fa7b3a4ead01ce15dce9453b061646e7fe2e7c51cb75ca01ee1e77037f3f ' , 'se.emilsjolander : stickylistheaders:89146b46c96fea0e40200474a2625cda10fe94891e4128f53cdb42375091b9b6 ' , 'com.astuetz : pagerslidingtabstrip : f1641396732c7132a7abb837e482e5ee2b0ebb8d10813fc52bbaec2c15c184c2 ' , - 'com.google.protobuf : protobuf-java : ad9769a22989e688a46af4d3accc348cc501ced22118033230542bc916e33f0b ' , 'com.madgag : sc-light-jdk15on:931f39d351429fb96c2f749e7ecb1a256a8ebbf5edca7995c9cc085b94d1841d ' , 'com.googlecode.libphonenumber : libphonenumber : eba17eae81dd622ea89a00a3a8c025b2f25d342e0d9644c5b62e16f15687c3ab ' , 'org.whispersystems : gson:08f4f7498455d1539c9233e5aac18e9b1805815ef29221572996508eb512fe51 ' , + 'com.google.protobuf : protobuf-java : e0c1c64575c005601725e7c6a02cebf9e1285e888f756b2a1d73ffa8d725cc74 ' , + 'com.path : android-priority-jobqueue : Bad encrypted messages with latest v3 master __EoT__ After upgrading my VM I was able to send messages , but did n't receive for a few minutes . After those few minutes all messages were received , but as bad encrypted . ( Even delivery receipts were shown as bad encrypted messages ? ! ) Had to manually end the session to make it work . Self texting is not working . I was able to end the secure session , but then all new key messages are shown as corrupt . https : //gist.github.com/anonymous/edbb008e29162aec10de _destination ending on xxx34 are self texting_ As the log is quite long I guess the v3 build starts at about line 500
diff -- git a/res/layout/message_details_footer.xml b/res/layout/message_details_footer.xml new file mode 100644 index 0000000..19099bc -- - /dev/null +++ b/res/layout/message_details_footer.xml @ @ -0,0 +1,30 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + + < LinearLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' + xmlns : tools= '' http : //schemas.android.com/tools '' + android : layout_width= '' match_parent '' + android : layout_height= '' wrap_content '' + android : gravity= '' right '' + android : orientation= '' horizontal '' + android : paddingTop= '' 5dp '' + android : paddingLeft= '' 10dp '' + android : paddingRight= '' 10dp '' + android : paddingBottom= '' 10dp '' + android : clipToPadding= '' false '' > + + < Button android : id= '' @ +id/resend_all_button '' + android : layout_width= '' wrap_content '' + android : layout_height= '' 38sp '' + style= '' @ style/InfoButton '' + android : paddingLeft= '' 10dp '' + android : paddingRight= '' 10dp '' + android : paddingTop= '' 5dp '' + android : paddingBottom= '' 5dp '' + android : drawablePadding= '' 2dp '' + android : layout_gravity= '' center_vertical '' + android : drawableLeft= '' @ Incorrect behavior of message resend dialog __EoT__ Scenario : I am member of a group and a message did not get through ( e.g. , because I have a bad network connection ) . I then am presented with a message stating that I should tap for further details . After tapping I see a message detail dialog together with a list of all group members and separate `` send again '' buttons for every member . Problem : Whenever I tap on one of those buttons the message is not only resent to this specific member but to the whole group . To get rid of all buttons I would need to tap them all , thereby causing the message to be sent multiple times to every person . I see that there might be cases in which some members have got the message while others have not . In that case it would be good if the button would only cause a resend to this specific account . Often , it will be the case that none of the members got the message because the network issue is on the sender side . In that case , a
diff -- git a/res/layout/message_details_footer.xml b/res/layout/message_details_footer.xml new file mode 100644 index 0000000..914abcd -- - /dev/null +++ b/res/layout/message_details_footer.xml @ @ -0,0 +1,30 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + + < LinearLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' + xmlns : tools= '' http : //schemas.android.com/tools '' + android : layout_width= '' match_parent '' + android : layout_height= '' wrap_content '' + android : gravity= '' right '' + android : orientation= '' horizontal '' + android : paddingTop= '' 5dp '' + android : paddingLeft= '' 10dp '' + android : paddingRight= '' 10dp '' + android : paddingBottom= '' 10dp '' + android : clipToPadding= '' false '' > + + < Button android : id= '' @ +id/resend_all_button '' + android : layout_width= '' wrap_content '' + android : layout_height= '' 38sp '' + style= '' @ style/InfoButton '' + android : paddingLeft= '' 10dp '' + android : paddingRight= '' 10dp '' + android : paddingTop= '' 5dp '' + android : paddingBottom= '' 5dp '' + android : drawablePadding= '' 2dp '' + android : layout_gravity= '' center_vertical '' + android : drawableLeft= '' @ Incorrect behavior of message resend dialog __EoT__ Scenario : I am member of a group and a message did not get through ( e.g. , because I have a bad network connection ) . I then am presented with a message stating that I should tap for further details . After tapping I see a message detail dialog together with a list of all group members and separate `` send again '' buttons for every member . Problem : Whenever I tap on one of those buttons the message is not only resent to this specific member but to the whole group . To get rid of all buttons I would need to tap them all , thereby causing the message to be sent multiple times to every person . I see that there might be cases in which some members have got the message while others have not . In that case it would be good if the button would only cause a resend to this specific account . Often , it will be the case that none of the members got the message because the network issue is on the sender side . In that case , a
diff -- git a/src/org/thoughtcrime/securesms/ConversationAdapter.java b/src/org/thoughtcrime/securesms/ConversationAdapter.java index 47fca05..e24c1a4 100644 -- - a/src/org/thoughtcrime/securesms/ConversationAdapter.java +++ b/src/org/thoughtcrime/securesms/ConversationAdapter.java @ @ -18,11 +18,14 @ @ package org.thoughtcrime.securesms ; import android.content.Context ; import android.database.Cursor ; +import android.os.Build ; import android.os.Handler ; +import android.util.Log ; import android.view.LayoutInflater ; import android.view.View ; import android.view.ViewGroup ; import android.widget.AbsListView ; +import android.widget.ArrayAdapter ; import android.widget.CursorAdapter ; import org.thoughtcrime.securesms.util.GroupUtil ; @ @ -36,7 +39,9 @ @ import org.thoughtcrime.securesms.util.LRUCache ; import org.whispersystems.textsecure.push.PushMessageProtos.PushMessageContent.GroupContext ; import java.lang.ref.SoftReference ; +import java.util.ArrayList ; import java.util.Collections ; +import java.util.List ; import java.util.Map ; /** @ @ -44,15 +49,10 @ @ import java.util.Map ; * used by ComposeMessageActivity to display a conversation * thread in a ListActivity . * - * @ author Moxie Marlinspike + * @ author Moxie Marlinspike , Lukas Barth * */ -public class ConversationAdapter extends CursorAdapter implements AbsListView.RecyclerListener { - - private static final int MAX_CACHE_SIZE = 40 ; - private final Map < String , SoftReference < MessageRecord > > messageRecordCache = - Collections.synchronizedMap ( new LRUCache < String , SoftReference < MessageRecord > > ( MAX_CACHE_SIZE ) ) ; - +public class ConversationAdapter extends ArrayAdapter < MessageRecord > implements AbsListView.RecyclerListener { public static final int MESSAGE_TYPE_OUTGOING = 0 ; public static final async loading of ConversationList items __EoT__ There 's a lot of choppiness in scrolling because we load the content as the scrolling happens , and much of the activity is on the UI thread . We should throw that work on a separate thread and use a library like https : //github.com/lucasr/smoothie to populate the list items when the data is ready .
diff -- git a/res/layout/message_details_footer.xml b/res/layout/message_details_footer.xml new file mode 100644 index 0000000..19099bc -- - /dev/null +++ b/res/layout/message_details_footer.xml @ @ -0,0 +1,30 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + + < LinearLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' + xmlns : tools= '' http : //schemas.android.com/tools '' + android : layout_width= '' match_parent '' + android : layout_height= '' wrap_content '' + android : gravity= '' right '' + android : orientation= '' horizontal '' + android : paddingTop= '' 5dp '' + android : paddingLeft= '' 10dp '' + android : paddingRight= '' 10dp '' + android : paddingBottom= '' 10dp '' + android : clipToPadding= '' false '' > + + < Button android : id= '' @ +id/resend_all_button '' + android : layout_width= '' wrap_content '' + android : layout_height= '' 38sp '' + style= '' @ style/InfoButton '' + android : paddingLeft= '' 10dp '' + android : paddingRight= '' 10dp '' + android : paddingTop= '' 5dp '' + android : paddingBottom= '' 5dp '' + android : drawablePadding= '' 2dp '' + android : layout_gravity= '' center_vertical '' + android : drawableLeft= '' @ Message reports Failed to send for all group members , but is received by all group members __EoT__ < ! -- This is a bug report template . By following the instructions below and filling out the sections with your information , you will help the developers to get all the necessary data to fix your issue . You can also preview your report before submitting it . You may remove sections that are n't relevant to your particular case . Before we begin , please note that this tracker is only for issues , not questions or comments . If you are looking for support , please see our support center instead : http : //support.whispersystems.org/ or email support @ whispersystems.org Let 's begin with a checklist : replace the empty checkboxes [ ] below with checked ones [ x ] accordingly -- > I have : - [ X ] searched open and closed issues for duplicates - [ X ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description When sending messages in a group chat sometimes
diff -- git a/res/values/strings.xml b/res/values/strings.xml index 6fefb19..6bcbcb6 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -938,17 +938,17 @ @ < string name= '' preferences__change_your_passphrase '' > Change your passphrase < /string > < string name= '' preferences__enable_passphrase '' > Enable passphrase < /string > < string name= '' preferences__passphrase_summary '' > Passphrase % s < /string > - < string name= '' preferences__enable_lock_screen_for_messages '' > Enable lock screen for messages < /string > + < string name= '' preferences__lock_signal_and_message_notifications_with_a_passphrase '' > Lock Signal and message notifications with a passphrase < /string > < string name= '' preferences__screen_security '' > Screen security < /string > < string name= '' preferences__screen_security_summary '' > Screen security % s < /string > < string name= '' preferences__disable_screen_security_to_allow_screen_shots '' > Block screenshots in the recents list and inside the app < /string > - < string name= '' preferences__forget_passphrase_from_memory_after_some_interval '' > Forget passphrase from memory after some interval < /string > - < string name= '' preferences__timeout_passphrase '' > Timeout passphrase < /string > - < string name= '' preferences__pref_timeout_interval_dialogtitle '' > Select passphrase timeout < /string > - < string name= '' preferences__pref_timeout_interval_title '' > Timeout interval < /string > - < string name= RTL support appears to be incomplete __EoT__ Hi , So I just received an update of Signal with complete translation to Hebrew , and it 's WONDERFUL . Thank you for having such a great localization process - not all apps are so smooth . However , since Hebrew is written right-to-left , as are Arabic , Persian and a few other languages , it requires a bit of extra work to make it properly functional in RTL . For example , in the Settings menu all the items are aligned to the left , and they should be aligned to the right . I 'm not an Android developer , but as far as I know , since Android 4 or so , most of this can be done by enabling auto-support for RTL somewhere in the app 's build definitions ( I 'm sorry if my language here is imprecise ) .
diff -- git a/res/values/strings.xml b/res/values/strings.xml index 94b9bd3..a4813b2 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -23,6 +23,11 @ @ < string name= '' ApplicationPreferencesActivity_disable '' > Disable < /string > < string name= '' ApplicationPreferencesActivity_unregistering '' > Unregistering ... < /string > < string name= '' ApplicationPreferencesActivity_unregistering_for_data_based_communication '' > Unregistering for data based communication < /string > + < string name= '' ApplicationPreferencesActivity_disable_push_messages '' > Disable push messages ? < /string > + < string name= '' ApplicationPreferencesActivity_this_will_disable_push_messages '' > + This will disable push messages by unregistering you from the server . + You will need to re-register your phone number to use push messages again in the future . + < /string > < string name= '' ApplicationPreferencesActivity_error_connecting_to_server '' > Error connecting to server ! < /string > < string name= '' ApplicationPreferencesActivity_you_are_not_registered_with_the_push_service '' > You are not registered with the push service ... < /string > < string name= '' ApplicationPreferencesActivity_updating_directory '' > Updating directory < /string > diff -- git a/src/org/thoughtcrime/securesms/ApplicationPreferencesActivity.java b/src/org/thoughtcrime/securesms/ApplicationPreferencesActivity.java index 0091adb..13d4761 100644 -- - a/src/org/thoughtcrime/securesms/ApplicationPreferencesActivity.java +++ b/src/org/thoughtcrime/securesms/ApplicationPreferencesActivity.java @ @ -323,11 +323,13 @ @ public class ApplicationPreferencesActivity extends PassphraseRequiredSherlockPr private static final int SUCCESS = 0 ; private static final int NETWORK_ERROR = 1 Display warning before unsubscribing from push __EoT__ To unsubscribe from push you only have to untick `` push messages '' . No info or warning is shown , that you will have to go through the whole registering process again . Maybe a message like `` Are you sure ? You 'll have to re-register to enable push again '' should be shown ?
diff -- git a/src/org/thoughtcrime/securesms/ConversationTitleView.java b/src/org/thoughtcrime/securesms/ConversationTitleView.java index 7b6536b..6410ece 100644 -- - a/src/org/thoughtcrime/securesms/ConversationTitleView.java +++ b/src/org/thoughtcrime/securesms/ConversationTitleView.java @ @ -67,7 +67,10 @ @ public class ConversationTitleView extends LinearLayout { this.subtitle.setVisibility ( View.GONE ) ; } else { this.title.setText ( recipient.getName ( ) ) ; - this.subtitle.setText ( recipient.getNumber ( ) ) ; + if ( recipient.getCustomLabel ( ) ! = null ) + this.subtitle.setText ( recipient.getCustomLabel ( ) ) ; + else + this.subtitle.setText ( recipient.getNumber ( ) ) ; this.subtitle.setVisibility ( View.VISIBLE ) ; } } else { diff -- git a/src/org/thoughtcrime/securesms/recipients/Recipient.java b/src/org/thoughtcrime/securesms/recipients/Recipient.java index 01eac8e..65f5598 100644 -- - a/src/org/thoughtcrime/securesms/recipients/Recipient.java +++ b/src/org/thoughtcrime/securesms/recipients/Recipient.java @ @ -46,6 +46,7 @ @ public class Recipient { private @ NonNull String number ; private @ Nullable String name ; + private @ Nullable String customLabel ; private boolean stale ; private boolean resolving ; @ @ -70,6 +71,7 @ @ public class Recipient { this.contactUri = stale.contactUri ; this.contactPhoto = stale.contactPhoto ; this.color = stale.color ; + this.customLabel = stale.customLabel ; } future.addListener ( new FutureTaskListener < RecipientDetails > ( ) { @ @ -82,6 +84,7 @ @ public class Recipient { Recipient.this.contactUri = result.contactUri ; Recipient.this.contactPhoto = result.avatar ; Recipient.this.color = result.color ; + Recipient.this.customLabel = result.customLabel ; [ Feature Request ] Add Contact 's custom string to Signal app __EoT__ My contacts are organized by client , and the phone numbers listed as 'so & so 's cell ' . Is it possible to add the 'custom ' string under the Name of the Contact in Signal ? That way I can easily tell who I 'm chatting with . I do n't know a better way to organize lots of numbers with Google . It 's been rather clunky usually , but this way I can quickly find people .
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index c8e0a62..d8acede 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -87,7 +87,7 @ @ < activity android : name= '' .PromptMmsActivity '' android : label= '' Configure MMS Settings '' - android : windowSoftInputMode= '' stateUnchanged '' + android : windowSoftInputMode= '' stateUnchanged '' android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > < activity android : name= '' .MmsPreferencesActivity '' @ @ -176,11 +176,11 @ @ android : label= '' @ string/AndroidManifest__manage_identity_keys '' android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > - < activity android : name= '' .ReceiveKeyActivity '' + < activity android : name= '' .ReceiveKeyActivity '' android : label= '' @ string/AndroidManifest__complete_key_exchange '' android : theme= '' @ style/TextSecure.Light.Dialog '' android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > - + < activity android : name= '' .ApplicationPreferencesActivity '' android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > @ @ -207,6 +207,9 @ @ android : clearTaskOnLaunch= '' true '' android : finishOnTaskLaunch= '' true '' / > + < activity android : name= '' org.thoughtcrime.securesms.AboutActivity '' + android : label= '' @ string/preferences__about '' / > + < service android : enabled= '' true '' android : name= '' .service.ApplicationMigrationService '' / > Add an 'About ' menu item __EoT__ ... with the current version number and a link to https : //whispersystems.org/ # encrypted_texts .
diff -- git a/src/org/thoughtcrime/securesms/service/PushReceiver.java b/src/org/thoughtcrime/securesms/service/PushReceiver.java index 87eb9ee..d7bb08e 100644 -- - a/src/org/thoughtcrime/securesms/service/PushReceiver.java +++ b/src/org/thoughtcrime/securesms/service/PushReceiver.java @ @ -112,7 +112,8 @ @ public class PushReceiver { } try { - Recipient recipient = RecipientFactory.getRecipientsFromString ( context , message.getSource ( ) , false ) .getPrimaryRecipient ( ) ; + Recipients recipients = RecipientFactory.getRecipientsFromString ( context , message.getSource ( ) , false ) ; + Recipient recipient = recipients.getPrimaryRecipient ( ) ; RecipientDevice recipientDevice = new RecipientDevice ( recipient.getRecipientId ( ) , message.getSourceDevice ( ) ) ; KeyExchangeProcessorV2 processor = new KeyExchangeProcessorV2 ( context , masterSecret , recipientDevice ) ; PreKeyWhisperMessage preKeyExchange = new PreKeyWhisperMessage ( message.getBody ( ) ) ; @ @ -126,8 +127,10 @ @ public class PushReceiver { String encoded = Base64.encodeBytes ( message.getBody ( ) ) ; IncomingTextMessage textMessage = new IncomingTextMessage ( message , encoded , null ) ; IncomingPreKeyBundleMessage bundleMessage = new IncomingPreKeyBundleMessage ( textMessage , encoded ) ; + long threadId = DatabaseFactory.getThreadDatabase ( context ) .getThreadIdFor ( recipients ) ; DatabaseFactory.getEncryptingSmsDatabase ( context ) .insertMessageInbox ( masterSecret , bundleMessage ) ; + MessageNotifier.updateNotification ( context , masterSecret , threadId ) ; } } catch ( InvalidKeyException e ) { Log.w ( `` PushReceiver '' , e ) [ Bug ? ] Key changed events do not generate a notification __EoT__ I encountered this with a friend of mine who reflashed his phone and subsequently reregistered . I had an ongoing chat ( using his old key ) with him and noticed today that he had sent me a message yesterday and I had to accept the new key . But I did n't get notified about the new message in the notification bar I would expect Textsecure to generate notifications for all events including the key changed event , since this may lead to unnoticed messages , depending on usage pattern of course . If this behaviour is intentional , it would be great to know the rationale behind this . Anyways I want to thank you for your amazing work ! Steps to reproduce : 1 . User A and User B both register with Textsecure 2 . Both Users exchange a couple of messages 3 . User B reregisters with Textsecure changing his key 4 . User B send User A a Message 5 . No notification is shown on User A 's device Expected behaviour : User A should be notified of the incoming
diff -- git a/res/values/strings.xml b/res/values/strings.xml index 9b27012..f4dc93d 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -131,8 +131,8 @ @ < string name= '' ConversationActivity_this_device_does_not_appear_to_support_dial_actions '' > This device does not appear to support dial actions. < /string > < string name= '' ConversationActivity_leave_group '' > Leave group ? < /string > < string name= '' ConversationActivity_are_you_sure_you_want_to_leave_this_group '' > Are you sure you want to leave this group ? < /string > - < string name= '' ConversationActivity_transport_insecure_sms '' > Insecure SMS < /string > - < string name= '' ConversationActivity_transport_insecure_mms '' > Insecure MMS < /string > + < string name= '' ConversationActivity_transport_unsecured_sms '' > Unsecured SMS < /string > + < string name= '' ConversationActivity_transport_unsecured_mms '' > Unsecured MMS < /string > < string name= '' ConversationActivity_transport_signal '' > Signal < /string > < string name= '' ConversationActivity_lets_switch_to_signal '' > Let\ 's switch to Signal % 1 $ s < /string > < string name= '' ConversationActivity_lets_use_this_to_chat '' > Let\ 's use this to chat : % 1 $ s < /string > @ @ -661,9 +661,12 @ @ < string name= '' conversation_title_view__conversation_muted '' > Conversation muted < /string > < ! -- conversation_activity -- > - < Compose hint and send button text mismatch __EoT__ I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports # # # Bug description The compose hint and send button text do n't match in landscape after changing transport mode . # # # Steps to reproduce 1 . Open a Signal conversation 2 . Turn device landscape 3 . Change transport mode to SMS 4 . Notice that the compose hint correctly changes to denote that the transport was changed to SMS 5 . Tap compose box 6 . Notice that the compose hint and send button text do n't match : ! [ screenshot_2016-02-27-16-12-06 ] ( https : //cloud.githubusercontent.com/assets/174176/13373345/7dabc952-dd6e-11e5-913c-bdf4198231ef.png ) 7 . Dismiss the keyboard 8 . Change transport mode back to Signal 9 . Notice that the compose hint correctly changes to denote that the transport was changed back to Signal 10 . Tap compose box 11 . Notice that the compose hint and send button text do n't match : ! [ screenshot_2016-02-27-16-12-27 ] ( https : //cloud.githubusercontent.com/assets/174176/13373347/854b7054-dd6e-11e5-9c66-9d70221229c5.png ) # # # Device info # # # # # Tested on - Huawei U8800 ,
diff -- git a/androidTest/org/thoughtcrime/securesms/database/CanonicalAddressDatabaseTest.java b/androidTest/org/thoughtcrime/securesms/database/CanonicalAddressDatabaseTest.java new file mode 100644 index 0000000..c6d2cf7 -- - /dev/null +++ b/androidTest/org/thoughtcrime/securesms/database/CanonicalAddressDatabaseTest.java @ @ -0,0 +1,39 @ @ +package org.thoughtcrime.securesms.database ; + +import android.content.Context ; +import android.content.SharedPreferences ; +import android.test.InstrumentationTestCase ; +import android.test.mock.MockContext ; + +import static org.fest.assertions.api.Assertions . * ; +import static org.mockito.Mockito . * ; + +public class CanonicalAddressDatabaseTest extends InstrumentationTestCase { + private static final String LOCAL_NUMBER = `` +15555555555 '' ; + private Context mockContext ; + private SharedPreferences mockSharedPreferences ; + + public void testCanonicalizeAddressNumeric ( ) throws Exception { + assertThat ( CanonicalAddressDatabase.canonicalizeAddress ( mockContext , `` 555 5555 '' ) ) .isEqualTo ( LOCAL_NUMBER ) ; + } + + public void testCanonicalAddressEmail ( ) throws Exception { + assertThat ( CanonicalAddressDatabase.canonicalizeAddress ( mockContext , `` email @ domain.com '' ) ) . isEqualTo ( `` email @ domain.com '' ) ; + } + + public void testCanonicalAddressAlpha ( ) throws Exception { + assertThat ( CanonicalAddressDatabase.canonicalizeAddress ( mockContext , `` T-Mobile '' ) ) .isEqualTo ( `` T-Mobile '' ) ; + } + + @ Override + public void setUp ( ) throws Exception { + super.setUp ( ) ; + // https : //code.google.com/p/dexmaker/issues/detail ? Phone Number at Top Keeps Bad Data String Forever __EoT__ This is so bizarre I did n't know how to explain it properly in the title . Right now I have this text in the phone number field at the top of a thread in textsecure : '' +1510xxxxxxx - Sms and and generally use the '' ( The xxxxxxx are actually 7 digits I just omitted them to preserve his privacy ) This text should NOT be in a field meant for a telephone number ! How did this happen ? Well , I got a text from someone that went through my google voice number and was telling me they had a new number so I tried to copy just the number google puts there at the beginning of the text but It copied the whole text . I went into their address book entry and cleared their old number field to replace with the new data . When I pasted I noticed there was a bunch of text after the number so I cleared it all except the number then saved . I 'm not sure if i saved the text by accident then edited it again
diff -- git a/androidTest/org/thoughtcrime/securesms/database/CanonicalAddressDatabaseTest.java b/androidTest/org/thoughtcrime/securesms/database/CanonicalAddressDatabaseTest.java new file mode 100644 index 0000000..c6d2cf7 -- - /dev/null +++ b/androidTest/org/thoughtcrime/securesms/database/CanonicalAddressDatabaseTest.java @ @ -0,0 +1,39 @ @ +package org.thoughtcrime.securesms.database ; + +import android.content.Context ; +import android.content.SharedPreferences ; +import android.test.InstrumentationTestCase ; +import android.test.mock.MockContext ; + +import static org.fest.assertions.api.Assertions . * ; +import static org.mockito.Mockito . * ; + +public class CanonicalAddressDatabaseTest extends InstrumentationTestCase { + private static final String LOCAL_NUMBER = `` +15555555555 '' ; + private Context mockContext ; + private SharedPreferences mockSharedPreferences ; + + public void testCanonicalizeAddressNumeric ( ) throws Exception { + assertThat ( CanonicalAddressDatabase.canonicalizeAddress ( mockContext , `` 555 5555 '' ) ) .isEqualTo ( LOCAL_NUMBER ) ; + } + + public void testCanonicalAddressEmail ( ) throws Exception { + assertThat ( CanonicalAddressDatabase.canonicalizeAddress ( mockContext , `` email @ domain.com '' ) ) . isEqualTo ( `` email @ domain.com '' ) ; + } + + public void testCanonicalAddressAlpha ( ) throws Exception { + assertThat ( CanonicalAddressDatabase.canonicalizeAddress ( mockContext , `` T-Mobile '' ) ) .isEqualTo ( `` T-Mobile '' ) ; + } + + @ Override + public void setUp ( ) throws Exception { + super.setUp ( ) ; + // https : //code.google.com/p/dexmaker/issues/detail ? Phone Number at Top Keeps Bad Data String Forever __EoT__ This is so bizarre I did n't know how to explain it properly in the title . Right now I have this text in the phone number field at the top of a thread in textsecure : '' +1510xxxxxxx - Sms and and generally use the '' ( The xxxxxxx are actually 7 digits I just omitted them to preserve his privacy ) This text should NOT be in a field meant for a telephone number ! How did this happen ? Well , I got a text from someone that went through my google voice number and was telling me they had a new number so I tried to copy just the number google puts there at the beginning of the text but It copied the whole text . I went into their address book entry and cleared their old number field to replace with the new data . When I pasted I noticed there was a bunch of text after the number so I cleared it all except the number then saved . I 'm not sure if i saved the text by accident then edited it again
diff -- git a/androidTest/org/thoughtcrime/securesms/database/CanonicalAddressDatabaseTest.java b/androidTest/org/thoughtcrime/securesms/database/CanonicalAddressDatabaseTest.java new file mode 100644 index 0000000..7b0faf6 -- - /dev/null +++ b/androidTest/org/thoughtcrime/securesms/database/CanonicalAddressDatabaseTest.java @ @ -0,0 +1,27 @ @ +package org.thoughtcrime.securesms.database ; + +import android.content.Context ; +import android.content.SharedPreferences ; +import android.test.InstrumentationTestCase ; +import android.test.mock.MockContext ; + +import static org.fest.assertions.api.Assertions . * ; +import static org.mockito.Mockito . * ; + +public class CanonicalAddressDatabaseTest extends InstrumentationTestCase { + private static final String LOCAL_NUMBER = `` +15555555555 '' ; + private Context mockContext ; + private SharedPreferences mockSharedPreferences ; + + @ Override + public void setUp ( ) throws Exception { + super.setUp ( ) ; + // https : //code.google.com/p/dexmaker/issues/detail ? id=2 + System.setProperty ( `` dexmaker.dexcache '' , getInstrumentation ( ) .getTargetContext ( ) .getCacheDir ( ) .toString ( ) ) ; + + mockContext = mock ( MockContext.class ) ; + mockSharedPreferences = mock ( SharedPreferences.class ) ; + when ( mockContext.getSharedPreferences ( anyString ( ) , anyInt ( ) ) ) .thenReturn ( mockSharedPreferences ) ; + when ( mockSharedPreferences.getString ( eq ( `` pref_local_number '' ) , anyString ( ) ) ) .thenReturn ( LOCAL_NUMBER ) ; + } + } diff -- git a/androidTest/org/thoughtcrime/securesms/util/PhoneNumberFormatterTest.java b/androidTest/org/thoughtcrime/securesms/util/PhoneNumberFormatterTest.java new file mode 100644 index 0000000..664576a -- - Phone Number at Top Keeps Bad Data String Forever __EoT__ This is so bizarre I did n't know how to explain it properly in the title . Right now I have this text in the phone number field at the top of a thread in textsecure : '' +1510xxxxxxx - Sms and and generally use the '' ( The xxxxxxx are actually 7 digits I just omitted them to preserve his privacy ) This text should NOT be in a field meant for a telephone number ! How did this happen ? Well , I got a text from someone that went through my google voice number and was telling me they had a new number so I tried to copy just the number google puts there at the beginning of the text but It copied the whole text . I went into their address book entry and cleared their old number field to replace with the new data . When I pasted I noticed there was a bunch of text after the number so I cleared it all except the number then saved . I 'm not sure if i saved the text by accident then edited it again
diff -- git a/src/org/thoughtcrime/securesms/components/ComposeText.java b/src/org/thoughtcrime/securesms/components/ComposeText.java index 4ef7db5..df96e17 100644 -- - a/src/org/thoughtcrime/securesms/components/ComposeText.java +++ b/src/org/thoughtcrime/securesms/components/ComposeText.java @ @ -13,6 +13,7 @ @ import android.text.TextUtils.TruncateAt ; import android.text.style.RelativeSizeSpan ; import android.util.AttributeSet ; import android.view.inputmethod.EditorInfo ; +import android.view.inputmethod.InputConnection ; import org.thoughtcrime.securesms.R ; import org.thoughtcrime.securesms.TransportOption ; @ @ -92,7 +93,6 @ @ public class ComposeText extends EmojiEditText { } public void setTransport ( TransportOption transport ) { - final boolean enterSends = TextSecurePreferences.isEnterSendsEnabled ( getContext ( ) ) ; final boolean useSystemEmoji = TextSecurePreferences.isSystemEmojiPreferred ( getContext ( ) ) ; int imeOptions = ( getImeOptions ( ) & ~EditorInfo.IME_MASK_ACTION ) | EditorInfo.IME_ACTION_SEND ; @ @ -105,14 +105,6 @ @ public class ComposeText extends EmojiEditText { inputType = ( inputType & ~InputType.TYPE_MASK_VARIATION ) | InputType.TYPE_TEXT_VARIATION_SHORT_MESSAGE ; } - inputType = ! isLandscape ( ) & & enterSends - ? inputType & ~InputType.TYPE_TEXT_FLAG_MULTI_LINE - : inputType | InputType.TYPE_TEXT_FLAG_MULTI_LINE ; - - imeOptions = enterSends - ? imeOptions & ~EditorInfo.IME_FLAG_NO_ENTER_ACTION - : imeOptions | EditorInfo.IME_FLAG_NO_ENTER_ACTION ; - setInputType ( inputType ) ; setImeOptions ( imeOptions ) ; setHint ( transport.getComposeHint ( ) , @ @ -120,4 +112,13 @ @ public class ComposeText extends EmojiEditText { ? getContext ( ) .getString ( R.string.conversation_activity__from_sim_name , transport.getSimName ( ) .get ( ) Text does not wrap when `` Enter is send '' is enabled __EoT__ < ! -- Please note this is a bug tracker , not a support forum . If you need support , please use http : //support.whispersystems.org/ or email support @ whispersystems.org Delete any sections that are n't relevant . -- > < ! -- mark with x between the [ ] -- > I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports # # # Steps to reproduce - Enable `` Enter key sends '' in Settings > Advanced - Type a long message - Text does not wrap From a UX perspective , these two things have nothing to do with each other , text could still wrap even if the input field does not allow `` multiline '' text , otherwise it becomes quite difficult to send long messages and the user has to break it into smaller ones , which might be annoying . **Signal version : ** 3.11 This is _not_ a duplicate of # 4219 .
diff -- git a/src/org/thoughtcrime/securesms/database/PlaintextBackupExporter.java b/src/org/thoughtcrime/securesms/database/PlaintextBackupExporter.java index 453dab4..44ea81d 100644 -- - a/src/org/thoughtcrime/securesms/database/PlaintextBackupExporter.java +++ b/src/org/thoughtcrime/securesms/database/PlaintextBackupExporter.java @ @ -12,10 +12,14 @ @ import java.io.IOException ; public class PlaintextBackupExporter { + private static final String FILENAME = `` TextSecurePlaintextBackup.xml '' ; + private static final String FOLDERNAME = `` TextSecure '' ; + public static void exportPlaintextToSd ( Context context , MasterSecret masterSecret ) throws NoExternalStorageException , IOException { verifyExternalStorageForPlaintextExport ( ) ; + moveOldPlaintextExportToDirectory ( ) ; exportPlaintext ( context , masterSecret ) ; } @ @ -26,15 +30,29 @ @ public class PlaintextBackupExporter { private static String getPlaintextExportDirectoryPath ( ) { File sdDirectory = Environment.getExternalStorageDirectory ( ) ; - return sdDirectory.getAbsolutePath ( ) + File.separator + `` TextSecurePlaintextBackup.xml '' ; + return getOldPlaintextExportDirectoryPath ( ) + FOLDERNAME + File.separator ; + } + + private static String getOldPlaintextExportDirectoryPath ( ) { + File sdDirectory = Environment.getExternalStorageDirectory ( ) ; + return sdDirectory.getAbsolutePath ( ) + File.separator ; + } + + private static void moveOldPlaintextExportToDirectory ( ) { + File oldBackup = new File ( getOldPlaintextExportDirectoryPath ( ) + FILENAME ) ; + + if ( oldBackup.isFile ( ) ) { + File newBackup = new File ( getPlaintextExportDirectoryPath ( ) + Export backups to a sub-folder . __EoT__ Right now on my phone TextSecure exports the backup to the main folder on my sdcard . It would be nice if it was exported to a sub-folder , something like /sdcard/TextSecure/backup.xml or even have a setting to allow users to select the folder . The reason behind this request is that most `` backup '' apps do n't allow backing up a single file . Such apps as BtSync or the open source competitor to BtSync called SyncThing . They act kinda as dropbox but you host the servers and folders they backup to . I update my rom somewhat frequently and like to save my text messages .
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 1e47235..146151e 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -541,8 +541,6 @ @ < receiver android : name= '' .service.ExpirationListener '' / > - < receiver android : name= '' .jobmanager.requirements.BackoffReceiver '' / > - < provider android : name= '' .providers.PartProvider '' android : grantUriPermissions= '' true '' android : exported= '' false '' diff -- git a/build.gradle b/build.gradle index b1b9194..a2eee85 100644 -- - a/build.gradle +++ b/build.gradle @ @ -57,18 +57,21 @ @ repositories { } dependencies { - compile 'com.android.support : appcompat-v7:27.0.2' - compile 'com.android.support : recyclerview-v7:27.0.2' - compile 'com.android.support : design:27.0.2' - compile 'com.android.support : support-v13:27.0.2' - compile 'com.android.support : cardview-v7:27.0.2' - compile 'com.android.support : preference-v7:27.0.2' - compile 'com.android.support : preference-v14:27.0.2' - compile 'com.android.support : gridlayout-v7:27.0.2' - compile 'com.android.support : multidex:1.0.2' - compile 'com.android.support : exifinterface:27.0.2' + def supportVersion = '28.0.0' + + compile `` com.android.support : appcompat-v7 : $ supportVersion '' + compile `` com.android.support : recyclerview-v7 : $ supportVersion '' + compile `` com.android.support : design : $ supportVersion '' + compile `` com.android.support : support-v13 : $ supportVersion '' + compile `` com.android.support : cardview-v7 : $ supportVersion '' + compile `` com.android.support : preference-v7 : $ supportVersion Need to increase the API level in the build documentation __EoT__ Google have sent this message to all developer . This is a reminder that starting November 1 , 2018 , updates to apps and games on Google Play will be required to target Android Oreo ( API level 26 ) or higher . After this date , the Play Console will prevent you from submitting new APKs with a targetSdkVersion less than 26 . I have checked the build documentation and i see the targetSdkVersion is still on 25 . I tried to increase it to 26 and the app was working perfectly with all android versions except 8.0 and up .
diff -- git a/res/values/strings.xml b/res/values/strings.xml index 0999db8..e87b552 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -435,6 +435,8 @ @ < string name= '' preferences__pref_led_blink_title '' > LED Blink Pattern < /string > < string name= '' preferences__change_notification_blink_pattern '' > Change notification LED blink pattern < /string > < string name= '' preferences__pref_led_blink_dialogtitle '' > Select LED Blink Pattern < /string > + < string name= '' preferences__led_pattern_custom_title '' > Set Custom LED Pattern < /string > + < string name= '' preferences__led_pattern_set '' > Custom LED blink pattern set ! < /string > < string name= '' preferences__select_led_color '' > Select LED Color < /string > < string name= '' preferences__sound '' > Sound < /string > < string name= '' preferences__vibrate '' > Vibrate < /string > diff -- git a/src/org/thoughtcrime/securesms/database/DatabaseFactory.java b/src/org/thoughtcrime/securesms/database/DatabaseFactory.java index f55d188..3ab329a 100644 -- - a/src/org/thoughtcrime/securesms/database/DatabaseFactory.java +++ b/src/org/thoughtcrime/securesms/database/DatabaseFactory.java @ @ -16,11 +16,14 @ @ */ package org.thoughtcrime.securesms.database ; +import android.content.ContentValues ; import android.content.Context ; +import android.content.SharedPreferences ; import android.database.Cursor ; import android.database.sqlite.SQLiteDatabase ; import android.database.sqlite.SQLiteDatabase.CursorFactory ; import android.database.sqlite.SQLiteOpenHelper ; +import android.preference.PreferenceManager ; import android.util.Log ; import org.thoughtcrime.securesms.DatabaseUpgradeActivity ; @ @ -51,7 +54,8 @ @ public class DatabaseFactory { private static final int INTRODUCED_MMS_BODY_VERSION = 7 ; private Adding per-contact notification preferences __EoT__ I 'm working to add functionality to TextSecure to allow customization of notifications ( ringtone , vibrate pattern , led color ) on a per-contact basis . I 've got two questions : 1 ) Is this a feature that you 'd be interested in including in mainline TextSecure , and 2 ) If so , would it be better to let android store the per-contact preferences in the usual preferences location or would it be better to add them to the IdentityDatabase ? Thanks !
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index a5f52bb..3832807 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -158,6 +158,13 @ @ < activity android : name= '' .RegistrationProgressActivity '' android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + < activity + android : name= '' .ConfigNotificationActivity '' + android : configChanges= '' keyboardHidden|orientation|screenSize '' + android : label= '' @ string/preferences__contacts_title '' + android : launchMode= '' singleTop '' > + < /activity > + < service android : enabled= '' true '' android : name= '' .service.ApplicationMigrationService '' / > < service android : enabled= '' true '' android : name= '' .service.KeyCachingService '' / > @ @ -220,6 +227,8 @ @ < provider android : name= '' .providers.PartProvider '' android : authorities= '' org.thoughtcrime.provider.securesms '' / > + < provider android : name= '' .providers.NotificationProvider '' + android : authorities= '' org.thoughtcrime.notificationprovider.securesms '' / > < uses-library android : name= '' android.test.runner '' / > < /application > diff -- git a/res/layout/vibrate_pattern_dialog.xml b/res/layout/vibrate_pattern_dialog.xml new file mode 100644 index 0000000..59ce52a -- - /dev/null +++ b/res/layout/vibrate_pattern_dialog.xml @ @ -0,0 +1,43 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < LinearLayout xmlns : android= Adding per-contact notification preferences __EoT__ I 'm working to add functionality to TextSecure to allow customization of notifications ( ringtone , vibrate pattern , led color ) on a per-contact basis . I 've got two questions : 1 ) Is this a feature that you 'd be interested in including in mainline TextSecure , and 2 ) If so , would it be better to let android store the per-contact preferences in the usual preferences location or would it be better to add them to the IdentityDatabase ? Thanks !
diff -- git a/src/org/thoughtcrime/securesms/ConversationActivity.java b/src/org/thoughtcrime/securesms/ConversationActivity.java index 4b6a6c3..d73f4d4 100644 -- - a/src/org/thoughtcrime/securesms/ConversationActivity.java +++ b/src/org/thoughtcrime/securesms/ConversationActivity.java @ @ -73,9 +73,9 @ @ import org.thoughtcrime.securesms.database.ThreadDatabase ; import org.thoughtcrime.securesms.mms.AttachmentManager ; import org.thoughtcrime.securesms.mms.AttachmentTypeSelectorAdapter ; import org.thoughtcrime.securesms.mms.MediaTooLargeException ; -import org.thoughtcrime.securesms.mms.MmsSendHelper ; import org.thoughtcrime.securesms.mms.OutgoingGroupMediaMessage ; import org.thoughtcrime.securesms.mms.OutgoingMediaMessage ; +import org.thoughtcrime.securesms.mms.OutgoingMmsConnection ; import org.thoughtcrime.securesms.mms.OutgoingSecureMediaMessage ; import org.thoughtcrime.securesms.mms.Slide ; import org.thoughtcrime.securesms.mms.SlideDeck ; @ @ -736,7 +736,7 @ @ public class ConversationActivity extends PassphraseRequiredSherlockFragmentActi new AsyncTask < Void , Void , Boolean > ( ) { @ Override protected Boolean doInBackground ( Void ... params ) { - return MmsSendHelper.hasNecessaryApnDetails ( ConversationActivity.this ) ; + return OutgoingMmsConnection.isConnectionPossible ( ConversationActivity.this ) ; } @ Override diff -- git a/src/org/thoughtcrime/securesms/MmsPreferencesActivity.java b/src/org/thoughtcrime/securesms/MmsPreferencesActivity.java index 47ff8bc..d6f5c9b 100644 -- - a/src/org/thoughtcrime/securesms/MmsPreferencesActivity.java +++ b/src/org/thoughtcrime/securesms/MmsPreferencesActivity.java @ @ -20,11 +20,11 @ @ import android.content.Intent ; import android.os.Bundle ; import android.preference.EditTextPreference ; import android.preference.Preference ; -import android.preference.PreferenceManager ; import android.widget.Toast ; import com.actionbarsherlock.view.MenuItem ; -import org.thoughtcrime.securesms.mms.MmsDownloadHelper ; + +import org.thoughtcrime.securesms.mms.IncomingMmsConnection ; import org.thoughtcrime.securesms.service.SendReceiveService ; import org.thoughtcrime.securesms.util.DynamicLanguage ; import org.thoughtcrime.securesms.util.DynamicTheme ; @ @ -86,7 +86,7 @ @ public class MmsPreferencesActivity extends PassphraseRequiredSherlockPreference } private void initializePreferences ( ) { - if ( ! MmsDownloadHelper.isMmsConnectionParametersAvailable ( this , null ) ) { + if ( ! IncomingMmsConnection.isConnectionPossible ( this , null ) ) MMSCs using proxies not working __EoT__ I do n't like MMS : / CM11 Trying to send with wifi enabled : `` ` -- -- -- -- - beginning of /dev/log/main W/ConversationActivity ( 18575 ) : onActivityResult called : 7 , -1 , null W/BitmapUtil ( 18575 ) : rough scale 2448x3264 = > 2448x3264 W/BitmapUtil ( 18575 ) : fine scale 2448x3264 = > 960.0x1280.0 W/ImageSlide ( 18575 ) : Got soft reference : null W/Slide ( 18575 ) : Loading Part URI : file : ///storage/sdcard0/DCIM/ts_1410424378919.jpg W/Slide ( 18575 ) : Loading Part URI : file : ///storage/sdcard0/DCIM/ts_1410424378919.jpg W/BitmapUtil ( 18575 ) : rough scale 2448x3264 = > 612x816 W/BitmapUtil ( 18575 ) : fine scale 612x816 = > 195.75x261.0 W/Session ( 18575 ) : Checking session ... W/Session ( 18575 ) : Checking session ... W/MmsCommunication ( 18575 ) : Getting MMSC params for apn null W/MmsCommunication ( 18575 ) : Android wo n't let us query the APN database . W/KeyCachingService ( 18575 ) : Incrementing activity count ... W/TelephonyUtil ( 18575 ) : Choosing MCC+MNC info from TelephonyManager.getSimOperator ( ) W/ApnDatabase ( 18575 ) : Querying table for MCC+MNC 26202 without APN name W/ApnDatabase (
diff -- git a/.gitignore b/.gitignore index ccf7cd1..ae3bf7b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,4 +3,4 @ @ project.properties .project .settings bin/ -gen/ +gen/ \ No newline at end of file diff -- git a/assets/DDC_Uchen.ttf b/assets/DDC_Uchen.ttf new file mode 100644 index 0000000..b4707dc Binary files /dev/null and b/assets/DDC_Uchen.ttf differ diff -- git a/assets/monlambodyig.ttf b/assets/monlambodyig.ttf new file mode 100644 index 0000000..3f51f30 Binary files /dev/null and b/assets/monlambodyig.ttf differ diff -- git a/res/layout/auto_initiate_activity.xml b/res/layout/auto_initiate_activity.xml index 6a3e71e..c07be0d 100644 -- - a/res/layout/auto_initiate_activity.xml +++ b/res/layout/auto_initiate_activity.xml @ @ -5,24 +5,24 @ @ android : orientation= '' vertical '' android : padding= '' 10px '' > - < TextView android : id= '' @ +id/description_text '' + < org.thoughtcrime.securesms.lang.BhoTextView android : id= '' @ +id/description_text '' android : layout_width= '' fill_parent '' android : layout_height= '' wrap_content '' android : layout_marginBottom= '' 5px '' - android : text= '' You have received a message from someone who supports TextSecure encrypted sessions . Would you like to initiate a key exchange so you can communicate securely ? `` / > + android : text= '' @ string/you_have_received_a_message_from_someone_who_supports_textsecure '' / > < LinearLayout android : layout_width= '' fill_parent '' android : layout_height= '' wrap_content '' android : layout_marginTop= '' 10px Ca n't connect to textsecure push-service __EoT__ Hey , i tried to registrate @ WhisperPush after i used TextSecure but i cant register to WhisperPush , becuase after i recieve the SMS verification I get an error `` TextSecure cant connect to Push-Service '' , whats the prboblem Heres the log : 09-13 12:53:09.257 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.PreferenceActivity } from pid 16342 09-13 12:53:09.347 I/ActivityManager ( 624 ) : Start proc org.whispersystems.whisperpush for activity org.whispersystems.whisperpush/.ui.PreferenceActivity : pid=16435 uid=10058 gids= { 50058 , 3003 } 09-13 12:53:10.358 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.RegistrationActivity } from pid 16435 09-13 12:53:16.294 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.RegistrationProgressActivity ( has extras ) } from pid 16435 09-13 12:53:25.253 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.RegistrationActivity } from pid 16435 09-13 12:54:46.676 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.RegistrationProgressActivity ( has extras ) } from pid 16435 09-13 12:54:57.136 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.RegistrationActivity } from pid 16435 09-13 12:55:01.290 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.RegistrationProgressActivity ( has extras ) } from pid 16435 09-13 12:55:15.474 I/ActivityManager ( 624 ) : START u0
diff -- git a/.gitignore b/.gitignore index ccf7cd1..ae3bf7b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,4 +3,4 @ @ project.properties .project .settings bin/ -gen/ +gen/ \ No newline at end of file diff -- git a/assets/DDC_Uchen.ttf b/assets/DDC_Uchen.ttf new file mode 100644 index 0000000..b4707dc Binary files /dev/null and b/assets/DDC_Uchen.ttf differ diff -- git a/assets/monlambodyig.ttf b/assets/monlambodyig.ttf new file mode 100644 index 0000000..3f51f30 Binary files /dev/null and b/assets/monlambodyig.ttf differ diff -- git a/build.xml b/build.xml new file mode 100644 index 0000000..2569595 -- - /dev/null +++ b/build.xml @ @ -0,0 +1,85 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < project name= '' TextSecure '' default= '' help '' > + + < ! -- The local.properties file is created and updated by the 'android ' tool . + It contains the path to the SDK . It should *NOT* be checked into + Version Control Systems . -- > + < property file= '' local.properties '' / > + + < ! -- The ant.properties file can be created by you . It is only edited by the + 'android ' tool to add properties to it . + This is the place to change Ca n't connect to textsecure push-service __EoT__ Hey , i tried to registrate @ WhisperPush after i used TextSecure but i cant register to WhisperPush , becuase after i recieve the SMS verification I get an error `` TextSecure cant connect to Push-Service '' , whats the prboblem Heres the log : 09-13 12:53:09.257 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.PreferenceActivity } from pid 16342 09-13 12:53:09.347 I/ActivityManager ( 624 ) : Start proc org.whispersystems.whisperpush for activity org.whispersystems.whisperpush/.ui.PreferenceActivity : pid=16435 uid=10058 gids= { 50058 , 3003 } 09-13 12:53:10.358 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.RegistrationActivity } from pid 16435 09-13 12:53:16.294 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.RegistrationProgressActivity ( has extras ) } from pid 16435 09-13 12:53:25.253 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.RegistrationActivity } from pid 16435 09-13 12:54:46.676 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.RegistrationProgressActivity ( has extras ) } from pid 16435 09-13 12:54:57.136 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.RegistrationActivity } from pid 16435 09-13 12:55:01.290 I/ActivityManager ( 624 ) : START u0 { cmp=org.whispersystems.whisperpush/.ui.RegistrationProgressActivity ( has extras ) } from pid 16435 09-13 12:55:15.474 I/ActivityManager ( 624 ) : START u0
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index b469c83..edbe93b 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -216,6 +216,7 @ @ < service android : enabled= '' true '' android : name= '' .service.KeyCachingService '' / > < service android : enabled= '' true '' android : name= '' .service.RegistrationService '' / > < service android : enabled= '' true '' android : name= '' .service.DirectoryRefreshService '' / > + < service android : enabled= '' true '' android : name= '' org.thoughtcrime.securesms.websocket.PushService '' / > < service android : name= '' .service.QuickResponseService '' android : permission= '' android.permission.SEND_RESPOND_VIA_MESSAGE '' @ @ -230,6 +231,14 @ @ < /intent-filter > < /service > + < receiver android : name= '' org.thoughtcrime.securesms.websocket.NetworkReceiver '' android : enabled= '' true '' > + < intent-filter > + < action android : name= '' android.net.conn.CONNECTIVITY_CHANGE '' / > + < action android : name= '' android.intent.action.BOOT_COMPLETED '' / > + < action android : name= '' android.intent.action.ACTION_EXTERNAL_APPLICATIONS_AVAILABLE '' / > + < /intent-filter > + < /receiver > + < ! -- < receiver android : name= '' .service.BootListener '' -- > < ! -- android : enabled= '' true '' -- > diff -- git a/NOTICE Please kill GAPPS dependancy __EoT__ My phone is gapps free and for good reason as we all know by now . Google is useful for some things except on my phone . How come redphone has no dependancy on gapps , yet textsecure does ?
diff -- git a/src/org/thoughtcrime/securesms/mms/AttachmentManager.java b/src/org/thoughtcrime/securesms/mms/AttachmentManager.java index 559bb41..b80aa94 100644 -- - a/src/org/thoughtcrime/securesms/mms/AttachmentManager.java +++ b/src/org/thoughtcrime/securesms/mms/AttachmentManager.java @ @ -20,6 +20,7 @ @ import android.app.Activity ; import android.content.Context ; import android.content.Intent ; import android.net.Uri ; +import android.os.Build ; import android.view.View ; import android.widget.Button ; import android.widget.ImageView ; @ @ -94,7 +95,14 @ @ public class AttachmentManager { } private static void selectMediaType ( Activity activity , String type , int requestCode ) { - Intent intent = new Intent ( Intent.ACTION_GET_CONTENT ) ; + final Intent intent ; + + if ( Build.VERSION.SDK_INT > = Build.VERSION_CODES.KITKAT ) { + intent = new Intent ( Intent.ACTION_OPEN_DOCUMENT ) ; + } else { + intent = new Intent ( Intent.ACTION_GET_CONTENT ) ; + } + intent.setType ( type ) ; activity.startActivityForResult ( intent , requestCode ) ; } Force close when pressing back after adding attachment __EoT__ To reproduce : - Start TextSecure - Go into first conversation - Click menu ( ` ... ` ) - ` Add attachment ` - > ` Picture ` - Click first picture - Do not send picture , press back button - You are now in the conversation list and a Toast appears saying ` Saved draft ` - Press the first contact again - ` Unfortunately , TextSecure has stopped ` Tested on Moto X , Android 4.4.2 . Can you reproduce ?
diff -- git a/src/org/thoughtcrime/securesms/service/SmsSender.java b/src/org/thoughtcrime/securesms/service/SmsSender.java index 8d7b328..6916bd0 100644 -- - a/src/org/thoughtcrime/securesms/service/SmsSender.java +++ b/src/org/thoughtcrime/securesms/service/SmsSender.java @ @ -88,13 +88,13 @ @ public class SmsSender { Log.w ( `` SmsSender '' , e ) ; IncomingIdentityUpdateMessage identityUpdateMessage = IncomingIdentityUpdateMessage.createFor ( e.getE164Number ( ) , e.getIdentityKey ( ) ) ; DatabaseFactory.getEncryptingSmsDatabase ( context ) .insertMessageInbox ( masterSecret , identityUpdateMessage ) ; - DatabaseFactory.getSmsDatabase ( context ) .markAsSentFailed ( messageId ) ; + DatabaseFactory.getSmsDatabase ( context ) .markAsSentFailed ( record.getId ( ) ) ; } catch ( UndeliverableMessageException ude ) { Log.w ( `` SmsSender '' , ude ) ; - DatabaseFactory.getSmsDatabase ( context ) .markAsSentFailed ( messageId ) ; + DatabaseFactory.getSmsDatabase ( context ) .markAsSentFailed ( record.getId ( ) ) ; } catch ( RetryLaterException rle ) { Log.w ( `` SmsSender '' , rle ) ; - DatabaseFactory.getSmsDatabase ( context ) .markAsOutbox ( messageId ) ; + DatabaseFactory.getSmsDatabase ( context ) .markAsOutbox ( record.getId ( ) ) ; if ( systemStateListener.isConnected ( ) ) scheduleQuickRetryAlarm ( ) ; else systemStateListener.registerForConnectivityChange ( ) ; } Message is not resent when offline and SMS fallback disabled __EoT__ When sending a message while not connected to the internet but having SMS fallback disabled , TextSecure shows `` sending.. '' all the time , without resent once internet is available again .
diff -- git a/res/values/strings.xml b/res/values/strings.xml index 4437785..64e3af7 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -460,7 +460,9 @ @ < string name= '' MessageNotifier_media_message '' > Media message < /string > < ! -- QuickResponseService -- > - < string name= '' QuickResponseService_sorry_quick_response_is_not_yet_supported_by_textsecure '' > Sorry , Quick Response is not yet supported by TextSecure ! < /string > + < string name= '' QuickResponseService_quick_response_unavailable_when_TextSecure_is_locked '' > Quick response unavailable when TextSecure is locked ! < /string > + < string name= '' QuickResponseService_problem_sending_message '' > Problem sending message ! < /string > + < ! -- change_passphrase_activity -- > < string name= '' change_passphrase_activity__old_passphrase '' > OLD PASSPHRASE : < /string > diff -- git a/src/org/thoughtcrime/securesms/service/MasterSecretIntentService.java b/src/org/thoughtcrime/securesms/service/MasterSecretIntentService.java new file mode 100644 index 0000000..d4e696a -- - /dev/null +++ b/src/org/thoughtcrime/securesms/service/MasterSecretIntentService.java @ @ -0,0 +1,21 @ @ +package org.thoughtcrime.securesms.service ; + +import android.app.IntentService ; +import android.content.Intent ; +import android.support.annotation.Nullable ; + +import org.thoughtcrime.securesms.crypto.MasterSecret ; + +public abstract class MasterSecretIntentService extends IntentService { + + public MasterSecretIntentService ( String name ) { + super ( name ) ; + } + + @ Override + protected final void onHandleIntent ( Intent intent ) { + onHandleIntent ( intent , KeyCachingService.getMasterSecret ( this ) Quick response has problems with country code __EoT__ If the country code begins with + the number is not decoded correctly . It does not decode % 2B correctly to + .
diff -- git a/src/org/thoughtcrime/securesms/util/Rfc5724Uri.java b/src/org/thoughtcrime/securesms/util/Rfc5724Uri.java index deba6b6..ee9e0c0 100644 -- - a/src/org/thoughtcrime/securesms/util/Rfc5724Uri.java +++ b/src/org/thoughtcrime/securesms/util/Rfc5724Uri.java @ @ -47,7 +47,7 @ @ public class Rfc5724Uri { String [ ] parts = uri.split ( `` \\ ? `` ) [ 0 ] .split ( `` : '' , 2 ) ; if ( parts.length < 2 || parts [ 1 ] .isEmpty ( ) ) throw new URISyntaxException ( uri , `` invalid path '' ) ; - else return parts [ 1 ] ; + else return URLDecoder.decode ( parts [ 1 ] ) ; } private Map < String , String > parseQueryParams ( ) throws URISyntaxException { Quick response has problems with country code __EoT__ If the country code begins with + the number is not decoded correctly . It does not decode % 2B correctly to + .
diff -- git a/src/org/thoughtcrime/securesms/ApplicationPreferencesActivity.java b/src/org/thoughtcrime/securesms/ApplicationPreferencesActivity.java index 810ed4b..8cb41ce 100644 -- - a/src/org/thoughtcrime/securesms/ApplicationPreferencesActivity.java +++ b/src/org/thoughtcrime/securesms/ApplicationPreferencesActivity.java @ @ -149,6 +149,7 @ @ public class ApplicationPreferencesActivity extends PassphraseRequiredActionBarA super.onResume ( ) ; ( ( ApplicationPreferencesActivity ) getActivity ( ) ) .getSupportActionBar ( ) .setTitle ( R.string.text_secure_normal__menu_settings ) ; setCategorySummaries ( ) ; + setCategoryVisibility ( ) ; } private void setCategorySummaries ( ) { @ @ -164,6 +165,13 @ @ public class ApplicationPreferencesActivity extends PassphraseRequiredActionBarA .setSummary ( ChatsPreferenceFragment.getSummary ( getActivity ( ) ) ) ; } + private void setCategoryVisibility ( ) { + Preference devicePreference = this.findPreference ( PREFERENCE_CATEGORY_DEVICES ) ; + if ( devicePreference ! = null & & ! TextSecurePreferences.isPushRegistered ( getActivity ( ) ) ) { + getPreferenceScreen ( ) .removePreference ( devicePreference ) ; + } + } + private class CategoryClickListener implements Preference.OnPreferenceClickListener { private MasterSecret masterSecret ; private String category ; Disable devices preference when not signal registered __EoT__ - if you are not or no more signal registered and - if you enter the devices activity , a message saying `` Network connection failed '' ( also see https : //github.com/WhisperSystems/Signal-Desktop/issues/499 ) - you can dismiss that by tapping the soft key 'back' - then you can add a device via scan and by that register/pseudo-link the desktop - and by that you have a desktop only signal registration ( and maybe some other oddnesseses )
diff -- git a/src/org/thoughtcrime/securesms/database/model/MessageRecord.java b/src/org/thoughtcrime/securesms/database/model/MessageRecord.java index 608e143..95be275 100644 -- - a/src/org/thoughtcrime/securesms/database/model/MessageRecord.java +++ b/src/org/thoughtcrime/securesms/database/model/MessageRecord.java @ @ -119,8 +119,10 @ @ public abstract class MessageRecord extends DisplayRecord { } public long getTimestamp ( ) { - if ( isPush ( ) ) return getDateSent ( ) ; - else return getDateReceived ( ) ; + if ( isPush ( ) & & getDateSent ( ) < getDateReceived ( ) ) { + return getDateSent ( ) ; + } + return getDateReceived ( ) ; } public boolean isForcedSms ( ) { messages marked as sent sometimes tomorrow __EoT__ I have : - [ X ] searched open and closed issues for duplicates - [ X ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- - # # # Bug description - opened Signal today - chatted with a friend of mine - discovered that each and every message he has sent me since yesterday is marked as received on the right day , but as sent on the next day . # # # Screenshot [ https : //drive.google.com/file/d/0B9aaqi6krwjpRXNqVDhaT3FYS3c/view ? usp=drivesdk ] ( https : //drive.google.com/file/d/0B9aaqi6krwjpRXNqVDhaT3FYS3c/view ? usp=drivesdk ) # # # Device info **Device : ** Acer Z520 **Android version : ** 4.4.2 **Signal version : ** 3.17.0 # # # Link to debug log https : //gist.github.com/bae2ab1a6e8a3218d6426f8bb9e0a2ea Latest messages should be close to the end of this log
diff -- git a/src/org/thoughtcrime/securesms/jobs/PushGroupSendJob.java b/src/org/thoughtcrime/securesms/jobs/PushGroupSendJob.java index 49d65da..6e3325b 100644 -- - a/src/org/thoughtcrime/securesms/jobs/PushGroupSendJob.java +++ b/src/org/thoughtcrime/securesms/jobs/PushGroupSendJob.java @ @ -19,7 +19,6 @ @ import org.thoughtcrime.securesms.recipients.Recipient ; import org.thoughtcrime.securesms.recipients.RecipientFactory ; import org.thoughtcrime.securesms.recipients.RecipientFormattingException ; import org.thoughtcrime.securesms.recipients.Recipients ; -import org.thoughtcrime.securesms.service.ExpiringMessageManager ; import org.thoughtcrime.securesms.transport.UndeliverableMessageException ; import org.thoughtcrime.securesms.util.GroupUtil ; import org.whispersystems.jobqueue.JobParameters ; @ @ -90,7 +89,7 @ @ public class PushGroupSendJob extends PushSendJob implements InjectableType { database.markAsSent ( messageId ) ; markAttachmentsUploaded ( messageId , message.getAttachments ( ) ) ; - if ( message.getExpiresIn ( ) > 0 ) { + if ( message.getExpiresIn ( ) > 0 & & ! message.isExpirationUpdate ( ) ) { database.markExpireStarted ( messageId ) ; ApplicationContext.getInstance ( context ) .getExpiringMessageManager ( ) Disappearing message notification disappears in group thread but not in contact thread __EoT__ I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports # # # Bug description When you change the disappearing message timer , a notification appears , but whether that notification hangs around depends on whether you 're in a group vs. contact thread . # # # Steps to reproduce # # # # Given I 'm in a group thread - When I enable the ( unreleased ) disappearing messages feature - And set the timer to 5 seconds - Then I see the `` You set disappearing message time to 5 seconds . '' - In five seconds that info message is deleted . # # # # Given I 'm in a contact thread - When I enable the ( unreleased ) disappearing messages feature - And set the timer to 5 seconds - Then I see the `` You set disappearing message time to 5 seconds . '' - The info message never gets deleted . **Actual result : ** Contact thread `` You set disappearing message time '' info
diff -- git a/build.gradle b/build.gradle index c251f61..5b4ffb1 100644 -- - a/build.gradle +++ b/build.gradle @ @ -72,10 +72,14 @ @ dependencies { compile 'org.whispersystems : jobmanager:1.0.2' compile 'org.whispersystems : libpastelog:1.0.7' compile 'com.amulyakhare : com.amulyakhare.textdrawable:1.0.1' - compile 'org.whispersystems : signal-service-android:2.1.1' + compile 'org.whispersystems : signal-service-android:2.2.0' compile 'com.h6ah4i.android.compat : mulsellistprefcompat:1.0.0' compile 'com.google.zxing : core:3.2.1' + compile ( 'cn.carbswang.android : NumberPickerView:1.0.9 ' ) { + exclude group : 'com.android.support ' , module : 'appcompat-v7' + } + testCompile 'junit : junit:4.12' testCompile 'org.assertj : assertj-core:1.7.1' testCompile 'org.mockito : mockito-core:1.9.5' @ @ -97,57 +101,58 @ @ dependencies { dependencyVerification { verify = [ - 'me.leolin : ShortcutBadger:3142d017234bfa0cdd69ccded7cc5ea63f13b97574803c8c616c9bbeaad33ad9 ' , - 'se.emilsjolander : stickylistheaders : a08ca948aa6b220f09d82f16bbbac395f6b78897e9eeac6a9f0b0ba755928eeb ' , - 'com.google.android.gms : play-services-gcm:757ecd2c837ac81c98f4cc7dc783e7454c6d0506f6cc66b10417126b675248c9 ' , - 'com.google.android.gms : play-services-maps : c58a9d98a98889fb0b27f78100f2d9341ed7722db24ccf832df62b6e8ce1b42e ' , - 'com.google.android.gms : play-services-location:8226f778aa86bd15b9143f62425262cc53d64021990f62eb1aaec108d4e25f35 ' , - 'com.jpardogo.materialtabstrip : library : c6ef812fba4f74be7dc4a905faa4c2908cba261a94c13d4f96d5e67e4aad4aaa ' , - 'org.w3c : smil:085dc40f2bb249651578bfa07499fd08b16ad0886dbe2c4078586a408da62f9b ' , - 'org.apache.httpcomponents : httpclient-android:6f56466a9bd0d42934b90bfbfe9977a8b654c058bf44a12bdc2877c4e1f033f1 ' , - 'com.github.chrisbanes.photoview : library:8b5344e206f125e7ba9d684008f36c4992d03853c57e5814125f88496126e3cc ' , - 'com.github.bumptech.glide : glide:76ef123957b5fbaebb05fcbe6606dd58c3bc3fcdadb257f99811d0ac9ea9b88b ' , - 'com.makeramen : roundedimageview:1f5a1865796b308c6cdd114acc6e78408b110f0a62fc63553278fbeacd489cd1 ' , - 'com.pnikosis : materialish-progress : d71d80e00717a096784482aee21001a9d299fec3833e4ebd87739ed36cf77c54 ' , - 'de.greenrobot : eventbus:61d743a748156a372024d083de763b9e91ac2dcb3f6a1cbc74995c7ddab6e968 ' , - 'pl.tajchert : waitingdots:2835d49e0787dbcb606c5a60021ced66578503b1e9fddcd7a5ef0cd5f095ba2c ' , - 'com.soundcloud.android : android-crop : ffd4b973cf6e97f7d64118a0dc088df50e9066fd5634fe6911dd0c0c5d346177 ' , - 'com.android.support Disappearing message notification disappears in group thread but not in contact thread __EoT__ I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports # # # Bug description When you change the disappearing message timer , a notification appears , but whether that notification hangs around depends on whether you 're in a group vs. contact thread . # # # Steps to reproduce # # # # Given I 'm in a group thread - When I enable the ( unreleased ) disappearing messages feature - And set the timer to 5 seconds - Then I see the `` You set disappearing message time to 5 seconds . '' - In five seconds that info message is deleted . # # # # Given I 'm in a contact thread - When I enable the ( unreleased ) disappearing messages feature - And set the timer to 5 seconds - Then I see the `` You set disappearing message time to 5 seconds . '' - The info message never gets deleted . **Actual result : ** Contact thread `` You set disappearing message time '' info
diff -- git a/res/layout/auto_initiate_activity.xml b/res/layout/auto_initiate_activity.xml index 6a3e71e..da9c0fc 100644 -- - a/res/layout/auto_initiate_activity.xml +++ b/res/layout/auto_initiate_activity.xml @ @ -9,7 +9,7 @ @ android : layout_width= '' fill_parent '' android : layout_height= '' wrap_content '' android : layout_marginBottom= '' 5px '' - android : text= '' You have received a message from someone who supports TextSecure encrypted sessions . Would you like to initiate a key exchange so you can communicate securely ? `` / > + android : text= '' @ string/you_have_received_a_message_from_someone_who_supports_textsecure '' / > < LinearLayout android : layout_width= '' fill_parent '' android : layout_height= '' wrap_content '' @ @ -19,7 +19,7 @ @ < Button android : id= '' @ +id/initiate_button '' android : layout_width= '' wrap_content '' android : layout_height= '' wrap_content '' - android : text= '' Initiate Exchange '' + android : text= '' @ string/initiate_exchange '' android : gravity= '' center '' / > < Button android : id= '' @ +id/cancel_button '' diff -- git a/res/layout/change_passphrase_activity.xml b/res/layout/change_passphrase_activity.xml index 639b18d..90de2ad 100644 -- - a/res/layout/change_passphrase_activity.xml +++ b/res/layout/change_passphrase_activity.xml @ @ -20,7 +20,7 @ @ < TableRow > < TextView - android : text= '' New passphrase : '' + android : text= '' @ string/new_passphrase_ '' android : textSize= TS 2.7.1 incompatible with Android 2.3.5 ? __EoT__ TS 2.5.3 running on Android 2.3.5 ca n't be updated to latest 2.7.1 from Play Store . Even if apk is downloaded from another phone ( CM 11 ) , it does n't install . Until 2.5.3 the update process worked fine . Other apps , even bigger in size do install . Bellow is log while updating via PlayStore . D/Finsky ( 4601 ) : [ 1 ] InstallerImpl.requestInstall : Request install of org.thoughtcrime.securesms v=101 for single_install D/Finsky ( 4601 ) : [ 1 ] InstallerImpl.kick : Installer kick - starting org.thoughtcrime.securesms D/Database ( 4601 ) : dbopen ( ) : path = /data/data/com.android.vending/databases/localappstate.db , mode : wal , disk free size : 635 M , handle : 0xb162a0 I/keystore ( 1271 ) : uid : 1000 action : e - > 7 state : 3 - > 3 retry : 4 D/Database ( 4601 ) : dbclose ( ) : path = /data/data/com.android.vending/databases/localappstate.db , handle = 0xb162a0 D/ActivityManager ( 1377 ) : destroyActivityLocked , r=HistoryRecord { 40aaa580 com.android.vending/com.google.android.finsky.activities.AppsPermissionsActivity } V/ActivityManager ( 1377 ) : destroyActivityLocked , dalvik.system.VMStack.getThreadStackTrace ( Native Method ) V/ActivityManager ( 1377 ) : destroyActivityLocked , java.lang.Thread.getStackTrace (
diff -- git a/.gitignore b/.gitignore index ccf7cd1..ae3bf7b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,4 +3,4 @ @ project.properties .project .settings bin/ -gen/ +gen/ \ No newline at end of file diff -- git a/assets/DDC_Uchen.ttf b/assets/DDC_Uchen.ttf new file mode 100644 index 0000000..b4707dc Binary files /dev/null and b/assets/DDC_Uchen.ttf differ diff -- git a/assets/monlambodyig.ttf b/assets/monlambodyig.ttf new file mode 100644 index 0000000..3f51f30 Binary files /dev/null and b/assets/monlambodyig.ttf differ diff -- git a/res/layout/auto_initiate_activity.xml b/res/layout/auto_initiate_activity.xml index 6a3e71e..c07be0d 100644 -- - a/res/layout/auto_initiate_activity.xml +++ b/res/layout/auto_initiate_activity.xml @ @ -5,24 +5,24 @ @ android : orientation= '' vertical '' android : padding= '' 10px '' > - < TextView android : id= '' @ +id/description_text '' + < org.thoughtcrime.securesms.lang.BhoTextView android : id= '' @ +id/description_text '' android : layout_width= '' fill_parent '' android : layout_height= '' wrap_content '' android : layout_marginBottom= '' 5px '' - android : text= '' You have received a message from someone who supports TextSecure encrypted sessions . Would you like to initiate a key exchange so you can communicate securely ? `` / > + android : text= '' @ string/you_have_received_a_message_from_someone_who_supports_textsecure '' / > < LinearLayout android : layout_width= '' fill_parent '' android : layout_height= '' wrap_content '' android : layout_marginTop= '' 10px TS 2.7.1 incompatible with Android 2.3.5 ? __EoT__ TS 2.5.3 running on Android 2.3.5 ca n't be updated to latest 2.7.1 from Play Store . Even if apk is downloaded from another phone ( CM 11 ) , it does n't install . Until 2.5.3 the update process worked fine . Other apps , even bigger in size do install . Bellow is log while updating via PlayStore . D/Finsky ( 4601 ) : [ 1 ] InstallerImpl.requestInstall : Request install of org.thoughtcrime.securesms v=101 for single_install D/Finsky ( 4601 ) : [ 1 ] InstallerImpl.kick : Installer kick - starting org.thoughtcrime.securesms D/Database ( 4601 ) : dbopen ( ) : path = /data/data/com.android.vending/databases/localappstate.db , mode : wal , disk free size : 635 M , handle : 0xb162a0 I/keystore ( 1271 ) : uid : 1000 action : e - > 7 state : 3 - > 3 retry : 4 D/Database ( 4601 ) : dbclose ( ) : path = /data/data/com.android.vending/databases/localappstate.db , handle = 0xb162a0 D/ActivityManager ( 1377 ) : destroyActivityLocked , r=HistoryRecord { 40aaa580 com.android.vending/com.google.android.finsky.activities.AppsPermissionsActivity } V/ActivityManager ( 1377 ) : destroyActivityLocked , dalvik.system.VMStack.getThreadStackTrace ( Native Method ) V/ActivityManager ( 1377 ) : destroyActivityLocked , java.lang.Thread.getStackTrace (
diff -- git a/.gitignore b/.gitignore index ccf7cd1..ae3bf7b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,4 +3,4 @ @ project.properties .project .settings bin/ -gen/ +gen/ \ No newline at end of file diff -- git a/assets/DDC_Uchen.ttf b/assets/DDC_Uchen.ttf new file mode 100644 index 0000000..b4707dc Binary files /dev/null and b/assets/DDC_Uchen.ttf differ diff -- git a/assets/monlambodyig.ttf b/assets/monlambodyig.ttf new file mode 100644 index 0000000..3f51f30 Binary files /dev/null and b/assets/monlambodyig.ttf differ diff -- git a/build.xml b/build.xml new file mode 100644 index 0000000..2569595 -- - /dev/null +++ b/build.xml @ @ -0,0 +1,85 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < project name= '' TextSecure '' default= '' help '' > + + < ! -- The local.properties file is created and updated by the 'android ' tool . + It contains the path to the SDK . It should *NOT* be checked into + Version Control Systems . -- > + < property file= '' local.properties '' / > + + < ! -- The ant.properties file can be created by you . It is only edited by the + 'android ' tool to add properties to it . + This is the place to change TS 2.7.1 incompatible with Android 2.3.5 ? __EoT__ TS 2.5.3 running on Android 2.3.5 ca n't be updated to latest 2.7.1 from Play Store . Even if apk is downloaded from another phone ( CM 11 ) , it does n't install . Until 2.5.3 the update process worked fine . Other apps , even bigger in size do install . Bellow is log while updating via PlayStore . D/Finsky ( 4601 ) : [ 1 ] InstallerImpl.requestInstall : Request install of org.thoughtcrime.securesms v=101 for single_install D/Finsky ( 4601 ) : [ 1 ] InstallerImpl.kick : Installer kick - starting org.thoughtcrime.securesms D/Database ( 4601 ) : dbopen ( ) : path = /data/data/com.android.vending/databases/localappstate.db , mode : wal , disk free size : 635 M , handle : 0xb162a0 I/keystore ( 1271 ) : uid : 1000 action : e - > 7 state : 3 - > 3 retry : 4 D/Database ( 4601 ) : dbclose ( ) : path = /data/data/com.android.vending/databases/localappstate.db , handle = 0xb162a0 D/ActivityManager ( 1377 ) : destroyActivityLocked , r=HistoryRecord { 40aaa580 com.android.vending/com.google.android.finsky.activities.AppsPermissionsActivity } V/ActivityManager ( 1377 ) : destroyActivityLocked , dalvik.system.VMStack.getThreadStackTrace ( Native Method ) V/ActivityManager ( 1377 ) : destroyActivityLocked , java.lang.Thread.getStackTrace (
diff -- git a/res/menu/media_overview_context.xml b/res/menu/media_overview_context.xml index 4c3c26f..f1111c5 100644 -- - a/res/menu/media_overview_context.xml +++ b/res/menu/media_overview_context.xml @ @ -1,5 +1,10 @ @ < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > < menu xmlns : android= '' http : //schemas.android.com/apk/res/android '' xmlns : app= '' http : //schemas.android.com/apk/res-auto '' > + < item android : id= '' @ +id/save '' + android : title= '' @ string/save '' + android : icon= '' @ drawable/ic_save_white_24dp '' + app : showAsAction= '' always '' / > + < item android : id= '' @ +id/delete '' android : title= '' @ string/delete '' android : icon= '' @ drawable/ic_delete_white_24dp '' diff -- git a/res/values/strings.xml b/res/values/strings.xml index c73b9a5..471ddda 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -5,6 +5,7 @ @ < string name= '' no '' > No < /string > < string name= '' delete '' > Delete < /string > < string name= '' please_wait '' > Please wait ... < /string > + < string name= '' save '' > Save < /string > < ! -- AbstractNotificationBuilder -- > < string name= '' AbstractNotificationBuilder_new_message '' > New message < /string > @ @ -386,6 +387,7 @ @ Save all media to filesystem __EoT__ - [ x ] I have searched open and closed issues for duplicates ( # 3975 shows the successful implementation ) - [ x ] I am submitting a bug report for existing functionality that does not work as intended - [ x ] I have read https : //github.com/signalapp/Signal-Android/wiki/Submitting-useful-bug-reports - [ x ] This is n't a feature request or a discussion topic -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description The `` save all media '' button disappeared on my device . My device 's screen just broke half-way and I need to switch to a new device . I do not have space on the new device to move 3 gb ( sic ! ) of signal data . I want to save all media from my existing conversations and move them from my ( old ) phone to my computer . This used to work fine and disappeared in a recent update . I relied on features not suddenly disappearing . I am a little scared , do I really now need to
diff -- git a/src/org/thoughtcrime/securesms/ViewLocalIdentityActivity.java b/src/org/thoughtcrime/securesms/ViewLocalIdentityActivity.java index 3573c7f..1caaa40 100644 -- - a/src/org/thoughtcrime/securesms/ViewLocalIdentityActivity.java +++ b/src/org/thoughtcrime/securesms/ViewLocalIdentityActivity.java @ @ -45,8 +45,7 @ @ public class ViewLocalIdentityActivity extends ViewIdentityActivity { this.masterSecret = getIntent ( ) .getParcelableExtra ( `` master_secret '' ) ; getIntent ( ) .putExtra ( `` identity_key '' , IdentityKeyUtil.getIdentityKey ( this , Curve.DJB_TYPE ) ) ; - getIntent ( ) .putExtra ( `` title '' , getString ( R.string.ApplicationPreferencesActivity_my ) + `` `` + - getString ( R.string.ViewIdentityActivity_identity_fingerprint ) ) ; + getIntent ( ) .putExtra ( `` title '' , getString ( R.string.ViewIdentityActivity_my_identity_fingerprint ) ) ; super.onCreate ( bundle ) ; } Typo in German translation : `` Meine Fingerabdruck '' __EoT__ The translation of `` My Fingerprint '' is mistakenly translated as `` Meine Fingerabdruck '' . It should be `` Mein Fingerabdruck ''
diff -- git a/src/org/thoughtcrime/securesms/service/SmsSender.java b/src/org/thoughtcrime/securesms/service/SmsSender.java index 8d7b328..6916bd0 100644 -- - a/src/org/thoughtcrime/securesms/service/SmsSender.java +++ b/src/org/thoughtcrime/securesms/service/SmsSender.java @ @ -88,13 +88,13 @ @ public class SmsSender { Log.w ( `` SmsSender '' , e ) ; IncomingIdentityUpdateMessage identityUpdateMessage = IncomingIdentityUpdateMessage.createFor ( e.getE164Number ( ) , e.getIdentityKey ( ) ) ; DatabaseFactory.getEncryptingSmsDatabase ( context ) .insertMessageInbox ( masterSecret , identityUpdateMessage ) ; - DatabaseFactory.getSmsDatabase ( context ) .markAsSentFailed ( messageId ) ; + DatabaseFactory.getSmsDatabase ( context ) .markAsSentFailed ( record.getId ( ) ) ; } catch ( UndeliverableMessageException ude ) { Log.w ( `` SmsSender '' , ude ) ; - DatabaseFactory.getSmsDatabase ( context ) .markAsSentFailed ( messageId ) ; + DatabaseFactory.getSmsDatabase ( context ) .markAsSentFailed ( record.getId ( ) ) ; } catch ( RetryLaterException rle ) { Log.w ( `` SmsSender '' , rle ) ; - DatabaseFactory.getSmsDatabase ( context ) .markAsOutbox ( messageId ) ; + DatabaseFactory.getSmsDatabase ( context ) .markAsOutbox ( record.getId ( ) ) ; if ( systemStateListener.isConnected ( ) ) scheduleQuickRetryAlarm ( ) ; else systemStateListener.registerForConnectivityChange ( ) ; } Sending simple SMS reproducibly fails __EoT__ Sending a simple SMS ( just text ) to a certain contact fails reproducibly . I can successfully send push messages to this contact and SMS to other contacts . One thing to notice is that the contact regarding this issue is the only one I have who is also using TextSecure and we once had an established key exchange ( which I disabled before producing the logfile below ) . Strangely she can successfully send me SMS . Here is the log file : `` ` -- -- -- -- - beginning of /dev/log/main W/DirectoryRefreshListener ( 5780 ) : Scheduling for : 1394051833012 W/PartProvider ( 5780 ) : Got master secret : null W/KeyCachingService ( 5780 ) : KCS Is Being Destroyed ! I/dalvikvm ( 5780 ) : Could not find method android.provider.Telephony $ Sms.getDefaultSmsPackage , referenced from method org.thoughtcrime.securesms.util.Util.isDefaultSmsProvider W/dalvikvm ( 5780 ) : VFY : unable to resolve static method 969 : Landroid/provider/Telephony $ Sms ; .getDefaultSmsPackage ( Landroid/content/Context ; ) Ljava/lang/String ; D/dalvikvm ( 5780 ) : VFY : replacing opcode 0x71 at 0x000a W/MmsSmsDatabase ( 5780 ) : Executing query : SELECT _id , body , read , type
diff -- git a/src/org/thoughtcrime/securesms/ConversationActivity.java b/src/org/thoughtcrime/securesms/ConversationActivity.java index 5f60da2..c43bf10 100644 -- - a/src/org/thoughtcrime/securesms/ConversationActivity.java +++ b/src/org/thoughtcrime/securesms/ConversationActivity.java @ @ -1392,7 +1392,9 @ @ public class ConversationActivity extends PassphraseRequiredActionBarActivity @ Override public void onImageCapture ( @ NonNull final byte [ ] imageBytes ) { - setMedia ( PersistentBlobProvider.getInstance ( this ) .create ( masterSecret , imageBytes ) , MediaType.IMAGE ) ; + setMedia ( PersistentBlobProvider.getInstance ( this ) + .create ( masterSecret , imageBytes , ContentType.IMAGE_JPEG ) , + MediaType.IMAGE ) ; quickAttachmentDrawer.hide ( false ) ; } diff -- git a/src/org/thoughtcrime/securesms/ShareActivity.java b/src/org/thoughtcrime/securesms/ShareActivity.java index 367c15c..0195942 100644 -- - a/src/org/thoughtcrime/securesms/ShareActivity.java +++ b/src/org/thoughtcrime/securesms/ShareActivity.java @ @ -23,6 +23,7 @ @ import android.net.Uri ; import android.os.AsyncTask ; import android.os.Bundle ; import android.support.annotation.NonNull ; +import android.support.annotation.Nullable ; import android.util.Log ; import android.view.Menu ; import android.view.MenuInflater ; @ @ -59,6 +60,7 @ @ public class ShareActivity extends PassphraseRequiredActionBarActivity private ViewGroup fragmentContainer ; private View progressWheel ; private Uri resolvedExtra ; + private String mimeType ; private boolean isPassingAlongMedia ; @ Override @ @ -110,6 +112,7 @ @ public class ShareActivity extends PassphraseRequiredActionBarActivity isPassingAlongMedia = false ; Uri streamExtra = getIntent ( ) .getParcelableExtra ( Intent.EXTRA_STREAM ) ; + mimeType = getMimeType ( streamExtra ) ; if ( streamExtra ! = null Wrong file suffix on saving videos __EoT__ I just received a video within a group chat in Signal 3.4.0 . When I save that video , it is saved to sdcard\Movies\textsecure-2015-11-14-131819.attach To make it play in other apps I have to open a file manager and rename the video to textsecure-2015-11-14-131819.mp4 I would expect Signal to directly save the file as textsecure-2015-11-14-131819.mp4
diff -- git a/res/layout/verify_identity_activity.xml b/res/layout/verify_identity_activity.xml index 1c20f7e..b81516e 100644 -- - a/res/layout/verify_identity_activity.xml +++ b/res/layout/verify_identity_activity.xml @ @ -18,6 +18,13 @ @ android : padding= '' 7dip '' / > < TextView + android : layout_width= '' fill_parent '' + android : layout_height= '' wrap_content '' + android : textAppearance= '' ? android : attr/textAppearanceLarge '' + android : paddingLeft= '' 7dip '' + android : id= '' @ +id/friend_verified '' / > + + < TextView android : layout_width= '' fill_parent '' android : layout_height= '' wrap_content '' android : textAppearance= '' ? android : attr/textAppearanceLarge '' diff -- git a/res/layout/view_identity_activity.xml b/res/layout/view_identity_activity.xml index 1bc52c3..b1f3dbc 100644 -- - a/res/layout/view_identity_activity.xml +++ b/res/layout/view_identity_activity.xml @ @ -19,5 +19,12 @ @ android : text= '' '' android : padding= '' 7dip '' / > + < TextView + android : layout_width= '' fill_parent '' + android : layout_height= '' wrap_content '' + android : textAppearance= '' ? android : attr/textAppearanceLarge '' + android : padding= '' 7dip '' + android : id= '' @ +id/identity_verified '' / > + < /LinearLayout > < /ScrollView > diff -- git a/res/menu/key_scanning.xml b/res/menu/key_scanning.xml index 7c36bc3..7a08e7c 100644 -- - a/res/menu/key_scanning.xml +++ b/res/menu/key_scanning.xml @ @ -13,6 +13,8 @ @ < item android Introduce Threat model __EoT__ It would be good to know what attacks/threats were already considered in the current design and how they should be prevented . Additionally it would make sense to add those which were left out or are not considered at the moment . Maybe this could be done in the context of a wiki page . # Threat related Issues # # Uncategorized - # 934 MasterSecret implements Parcelable , secure ? - # 1299 Improve privacy of contact discovery - # 1725 Creating of group leaks name and included numbers to participants before any message is sent - # 3080 Everyone who has my phone number can figure out that I use textsecure - # 4300 different certificates served to my home internet connection vs. cell data ( fits in more categories ) - # 5100 SSL Certificate Problem - # 5618 Protection against Retroscope - # 5724 Hyperlink previews # # # Being forced to do something : - # 175 Quick way to wipe message database - # 1512 Secondary Password to Erase All Messages # # [ Traffic Analysis ] ( http : //en.wikipedia.org/wiki/Padding_ % 28cryptography % 29 # Traffic_analysis ) : -
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 196c742..29240ae 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -99,7 +99,7 @ @ < meta-data android : name= '' com.google.android.geo.API_KEY '' - android : value= '' AIzaSyCSx9xea86GwDKGznCAULE9Y5a8b-TfN9U '' / > + android : value= '' AIzaSyAlVlRzrjMy3naDSVCyS0CxZZ59wRF4CcE '' / > < meta-data android : name= '' com.google.android.gms.version '' android : value= '' @ integer/google_play_services_version '' / > diff -- git a/res/layout/verify_identity_activity.xml b/res/layout/verify_identity_activity.xml index 78146b7..d6e09c8 100644 -- - a/res/layout/verify_identity_activity.xml +++ b/res/layout/verify_identity_activity.xml @ @ -45,5 +45,12 @ @ android : fontFamily= '' monospace '' android : text= '' '' / > + < ToggleButton + android : layout_width= '' wrap_content '' + android : layout_height= '' wrap_content '' + android : id= '' @ +id/identities_verified '' + android : textOn= '' @ string/VerifyIdentityActivity_verified_exclamation '' + android : textOff= '' @ string/VerifyIdentityActivity_not_verified_exclamation '' / > + < /LinearLayout > - < /ScrollView > \ No newline at end of file + < /ScrollView > diff -- git a/src/org/thoughtcrime/securesms/VerifyIdentityActivity.java b/src/org/thoughtcrime/securesms/VerifyIdentityActivity.java index 7bc3fe2..33d2e45 100644 -- - a/src/org/thoughtcrime/securesms/VerifyIdentityActivity.java +++ b/src/org/thoughtcrime/securesms/VerifyIdentityActivity.java @ @ -21,19 +21,26 @ @ import android.os.Bundle ; import android.support.annotation.NonNull ; import android.support.annotation.Nullable ; import android.widget.TextView ; +import android.widget.ToggleButton ; +import android.widget.CompoundButton ; import android.widget.Toast ; import org.thoughtcrime.securesms.crypto.IdentityKeyParcelable ; import Safety number verification status should be stored and presented in UI __EoT__ Feature request : if I 've verified safety numbers with a contact of mine by scanning QR codes in person , then the fact that we have both verified each other should be presented somewhere in the UI ( as a checkmark or something ? ) until their safety numbers change . There presently seems to be no other way to know that you 've already verified with somebody except by memory .
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index eb8ea0d..004d578 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -99,7 +99,7 @ @ < meta-data android : name= '' com.google.android.geo.API_KEY '' - android : value= '' AIzaSyCSx9xea86GwDKGznCAULE9Y5a8b-TfN9U '' / > + android : value= '' AIzaSyAlVlRzrjMy3naDSVCyS0CxZZ59wRF4CcE '' / > < meta-data android : name= '' com.google.android.gms.version '' android : value= '' @ integer/google_play_services_version '' / > diff -- git a/res/xml/preferences_sms_mms.xml b/res/xml/preferences_sms_mms.xml index 69249f3..da356b1 100644 -- - a/res/xml/preferences_sms_mms.xml +++ b/res/xml/preferences_sms_mms.xml @ @ -18,7 +18,7 @ @ android : summary= '' @ string/ApplicationPreferencesActivity_touch_to_make_signal_your_default_sms_app '' / > < org.thoughtcrime.securesms.components.SwitchPreferenceCompat - android : defaultValue= '' false '' + android : defaultValue= '' true '' android : key= '' pref_delivery_report_sms '' android : summary= '' @ string/preferences__request_a_delivery_report_for_each_sms_message_you_send '' android : title= '' @ string/preferences__sms_delivery_reports '' / > diff -- git a/src/org/thoughtcrime/securesms/ConversationActivity.java b/src/org/thoughtcrime/securesms/ConversationActivity.java index 3bb9dcb..6886489 100644 -- - a/src/org/thoughtcrime/securesms/ConversationActivity.java +++ b/src/org/thoughtcrime/securesms/ConversationActivity.java @ @ -24,6 +24,7 @ @ import android.content.Intent ; import android.content.IntentFilter ; import android.content.res.Configuration ; import android.content.res.TypedArray ; +import android.database.Cursor ; import android.graphics.Color ; import android.graphics.PorterDuff ; import android.graphics.PorterDuff.Mode ; @ @ -82,8 +83,6 @ @ import org.thoughtcrime.securesms.components.emoji.EmojiDrawer ; import org.thoughtcrime.securesms.components.location.SignalPlace ; import org.thoughtcrime.securesms.components.reminder.InviteReminder ; import org.thoughtcrime.securesms.components.reminder.ReminderView ; -import org.thoughtcrime.securesms.contacts.ContactAccessor ; -import org.thoughtcrime.securesms.contacts.ContactAccessor.ContactData ; import org.thoughtcrime.securesms.crypto.MasterCipher ; import org.thoughtcrime.securesms.crypto.MasterSecret Safety number verification status should be stored and presented in UI __EoT__ Feature request : if I 've verified safety numbers with a contact of mine by scanning QR codes in person , then the fact that we have both verified each other should be presented somewhere in the UI ( as a checkmark or something ? ) until their safety numbers change . There presently seems to be no other way to know that you 've already verified with somebody except by memory .
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 850def0..3e8d808 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -100,7 +100,7 @ @ < meta-data android : name= '' com.google.android.geo.API_KEY '' - android : value= '' AIzaSyCSx9xea86GwDKGznCAULE9Y5a8b-TfN9U '' / > + android : value= '' AIzaSyAlVlRzrjMy3naDSVCyS0CxZZ59wRF4CcE '' / > < meta-data android : name= '' com.google.android.gms.version '' android : value= '' @ integer/google_play_services_version '' / > diff -- git a/res/xml/preferences_sms_mms.xml b/res/xml/preferences_sms_mms.xml index 69249f3..da356b1 100644 -- - a/res/xml/preferences_sms_mms.xml +++ b/res/xml/preferences_sms_mms.xml @ @ -18,7 +18,7 @ @ android : summary= '' @ string/ApplicationPreferencesActivity_touch_to_make_signal_your_default_sms_app '' / > < org.thoughtcrime.securesms.components.SwitchPreferenceCompat - android : defaultValue= '' false '' + android : defaultValue= '' true '' android : key= '' pref_delivery_report_sms '' android : summary= '' @ string/preferences__request_a_delivery_report_for_each_sms_message_you_send '' android : title= '' @ string/preferences__sms_delivery_reports '' / > diff -- git a/res/xml/recipient_preferences.xml b/res/xml/recipient_preferences.xml index b706c1e..08c265d 100644 -- - a/res/xml/recipient_preferences.xml +++ b/res/xml/recipient_preferences.xml @ @ -46,4 +46,4 @ @ android : persistent= '' false '' / > - < /PreferenceScreen > \ No newline at end of file + < /PreferenceScreen > diff -- git a/src/org/thoughtcrime/securesms/ConversationActivity.java b/src/org/thoughtcrime/securesms/ConversationActivity.java index 26ec29b..d2dc4cb 100644 -- - a/src/org/thoughtcrime/securesms/ConversationActivity.java +++ b/src/org/thoughtcrime/securesms/ConversationActivity.java @ @ -25,6 +25,7 @ @ import android.content.Intent ; import android.content.IntentFilter ; import android.content.res.Configuration ; import android.content.res.TypedArray Safety number verification status should be stored and presented in UI __EoT__ Feature request : if I 've verified safety numbers with a contact of mine by scanning QR codes in person , then the fact that we have both verified each other should be presented somewhere in the UI ( as a checkmark or something ? ) until their safety numbers change . There presently seems to be no other way to know that you 've already verified with somebody except by memory .
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index f2d9103..58c1bc6 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -11,6 +11,10 @ @ android : label= '' Access to TextSecure Secrets '' android : protectionLevel= '' signature '' / > + < permission android : name= '' org.thoughtcrime.securesms.ACCESS_PUSHCONTACTS '' + android : label= '' Access to the Push Contacts '' + android : protectionLevel= '' signature '' / > + < uses-permission android : name= '' org.thoughtcrime.securesms.ACCESS_SECRETS '' / > < uses-permission android : name= '' android.permission.READ_PROFILE '' / > < uses-permission android : name= '' android.permission.WRITE_PROFILE '' / > @ @ -282,6 +286,12 @ @ android : grantUriPermissions= '' true '' android : authorities= '' org.thoughtcrime.provider.securesms '' / > + + < provider android : name= '' org.thoughtcrime.securesms.contacts.PushContactProvider '' + android : permission= '' org.thoughtcrime.securesms.ACCESS_PUSHCONTACTS '' + android : authorities= '' org.thoughtcrime.provider.pushcontact '' + android : exported= '' false '' / > + < receiver android : name= '' .service.RegistrationNotifier '' android : exported= '' false '' > < intent-filter > diff -- git a/src/org/thoughtcrime/securesms/SingleContactSelectionActivity.java b/src/org/thoughtcrime/securesms/SingleContactSelectionActivity.java index 9ffdd29..e23a653 100644 -- - a/src/org/thoughtcrime/securesms/SingleContactSelectionActivity.java +++ b/src/org/thoughtcrime/securesms/SingleContactSelectionActivity.java @ @ -83,6 +83,7 @ @ public class SingleContactSelectionActivity extends PassphraseRequiredSherlockFr final SingleRecipientPanel recipientsPanel = ( SingleRecipientPanel ) findViewById Only push msg , no SMS fallback : why list non-TextSecure contacts ? __EoT__ When using TextSecure v2.0.1 with only push messages enabled ( no SMS fallback ) creating a new thread by clicking on the '+ ' sign , all contacts are displayed . Confirmed TextSecure contacts are displayed in a bold font . Non-TextSecure contacts are displayed with a regular font . As we do not have the SMS fallback enabled why does TextSecure even bother displaying non-TextSecure users . This is confusing . Please do not display non-TextSecure users if SMS fallback has been disabled . When SMS fallback has been enabled , please consider making the distinction between TextSecure and non-TextSecure user more distinctive . Bold vs Regular font is not distinctive enough . Use different background color for instance .
diff -- git a/src/org/thoughtcrime/securesms/components/emoji/EmojiSpan.java b/src/org/thoughtcrime/securesms/components/emoji/EmojiSpan.java index a3e79cd..82fa28f 100644 -- - a/src/org/thoughtcrime/securesms/components/emoji/EmojiSpan.java +++ b/src/org/thoughtcrime/securesms/components/emoji/EmojiSpan.java @ @ -1,5 +1,6 @ @ package org.thoughtcrime.securesms.components.emoji ; +import android.graphics.Paint ; import android.graphics.Paint.FontMetricsInt ; import android.graphics.drawable.Drawable ; import android.support.annotation.NonNull ; @ @ -15,4 +16,10 @ @ public class EmojiSpan extends AnimatingImageSpan { : tv.getResources ( ) .getDimensionPixelSize ( R.dimen.conversation_item_body_text_size ) ; getDrawable ( ) .setBounds ( 0 , 0 , size , size ) ; } + + @ Override public int getSize ( Paint paint , CharSequence text , int start , int end , + FontMetricsInt fm ) + { + return getDrawable ( ) .getBounds ( ) .right ; + } } Emojis still not centered __EoT__ Hello , this is a follow-up issue to : https : //github.com/WhisperSystems/TextSecure/issues/3317 I know that this should have been fixed by @ mcginty via https : //github.com/WhisperSystems/TextSecure/commit/9b2aabfdc8ece6c1002176ae75abe98229a46054 and yes , it 's much better now ( thanks for that ) , but it 's still not solved . You can easily reproduce it by doing the following steps for example : 1 . Have an empty message input box 2 . Insert an Emoji into the message input box via the TextSecure Emoji drawer 3 . Hit the space key on the keyboard to insert a space after the Emoji 4 . Now you should see that the Emoji has suddenly moved it 's position a bit down 5 . Press backspace on the keyboard to remove the space again 6 . Now you should see that the Emoji is centered again Could you please fix it ? Regards
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 16103cb..b9c2a57 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -45,6 +45,9 @ @ < meta-data android : name= '' com.google.android.gms.version '' android : value= '' @ integer/google_play_services_version '' / > + < meta-data android : name= '' org.thoughtcrime.securesms.mms.TextSecureGlideModule '' + android : value= '' GlideModule '' / > + < activity android : name= '' .RegistrationProblemsActivity '' android : theme= '' @ style/TextSecure.Light.Dialog '' android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > diff -- git a/build.gradle b/build.gradle index 35230b7..765f1a4 100644 -- - a/build.gradle +++ b/build.gradle @ @ -38,6 +38,7 @ @ dependencies { compile 'org.w3c : smil:1.0.0' compile 'org.apache.httpcomponents : httpclient-android:4.3.5' compile 'com.github.chrisbanes.photoview : library:1.2.3' + compile 'com.github.bumptech.glide : glide:3.5.2' compile 'com.makeramen : roundedimageview:1.5.0' compile ( 'com.afollestad : material-dialogs:0.6.4.7 ' ) { exclude module : 'appcompat-v7' @ @ -88,6 +89,7 @ @ dependencyVerification { 'org.w3c : smil:085dc40f2bb249651578bfa07499fd08b16ad0886dbe2c4078586a408da62f9b ' , 'org.apache.httpcomponents : httpclient-android:6f56466a9bd0d42934b90bfbfe9977a8b654c058bf44a12bdc2877c4e1f033f1 ' , 'com.github.chrisbanes.photoview : library:8b5344e206f125e7ba9d684008f36c4992d03853c57e5814125f88496126e3cc ' , + 'com.github.bumptech.glide : glide:16936352b96aa604b030f2d2263fb0cc656933e6cdda0bf6ac681282d1f7f196 ' , 'com.makeramen : roundedimageview:7dda2e78c406760e5c356ccce59b0df46b5b171cf18abb891998594405021548 ' , 'com.afollestad : material-dialogs:6ed57c1c479219f8ae929c310fc171dbfcbcee8326a6dcd50a91959d69eccdf0 ' , 'com.soundcloud.android : android-crop : ffd4b973cf6e97f7d64118a0dc088df50e9066fd5634fe6911dd0c0c5d346177 ' , @ @ -167,6 +169,7 @ @ android { 'proguard-square-okio.pro ' , 'proguard-spongycastle.pro ' , 'proguard-rounded-image-view.pro ' , + 'proguard-glide.pro ' , 'proguard.cfg' CrashBrowser : OOM 2.7.0-B1 ( emoji ) __EoT__ `` ` java.lang.RuntimeException : Unable to start activity ComponentInfo { org.thoughtcrime.securesms/org.thoughtcrime.securesms.ConversationActivity } : android.view.InflateException : Binary XML file line # 125 : Error inflating class < unknown > at android.app.ActivityThread.performLaunchActivity ( ActivityThread.java:2325 ) at android.app.ActivityThread.handleLaunchActivity ( ActivityThread.java:2387 ) at android.app.ActivityThread.access $ 800 ( ActivityThread.java:151 ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1303 ) at android.os.Handler.dispatchMessage ( Handler.java:102 ) at android.os.Looper.loop ( Looper.java:135 ) at android.app.ActivityThread.main ( ActivityThread.java:5254 ) at java.lang.reflect.Method.invoke ( Native Method ) at java.lang.reflect.Method.invoke ( Method.java:372 ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:903 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:698 ) Caused by : android.view.InflateException : Binary XML file line # 125 : Error inflating class < unknown > at android.view.LayoutInflater.createView ( LayoutInflater.java:633 ) at android.view.LayoutInflater.createViewFromTag ( LayoutInflater.java:743 ) at android.view.LayoutInflater.rInflate ( LayoutInflater.java:806 ) at android.view.LayoutInflater.inflate ( LayoutInflater.java:504 ) at android.view.LayoutInflater.inflate ( LayoutInflater.java:414 ) at android.view.LayoutInflater.inflate ( LayoutInflater.java:365 ) at android.support.v7.app.ActionBarActivityDelegateBase.setContentView ( ActionBarActivityDelegateBase.java:228 ) at android.support.v7.app.ActionBarActivity.setContentView ( ActionBarActivity.java:102 ) at org.thoughtcrime.securesms.ConversationActivity.onCreate ( ConversationActivity.java:171 ) at android.app.Activity.performCreate ( Activity.java:5990 ) at android.app.Instrumentation.callActivityOnCreate ( Instrumentation.java:1106 ) at android.app.ActivityThread.performLaunchActivity ( ActivityThread.java:2278 ) ... 10 more Caused by : java.lang.reflect.InvocationTargetException at java.lang.reflect.Constructor.newInstance ( Native Method ) at java.lang.reflect.Constructor.newInstance ( Constructor.java:288 ) at android.view.LayoutInflater.createView ( LayoutInflater.java:607 ) ...
diff -- git a/res/values/strings.xml b/res/values/strings.xml index f01fbfe..ae8b690 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -229,6 +229,14 @ @ < ! -- DateUtils -- > < string name= '' DateUtils_now '' > Now < /string > < string name= '' DateUtils_minutes_ago '' > % d min < /string > + < plurals name= '' DateUtils_minutes_ago_unabbreviated '' > + < item quantity= '' one '' > % d minute ago < /item > + < item quantity= '' other '' > % d minutes ago < /item > + < /plurals > + < plurals name= '' hours_ago_unabbreviated '' > + < item quantity= '' one '' > % d hour ago < /item > + < item quantity= '' other '' > % d hours ago < /item > + < /plurals > < ! -- DeviceListActivity -- > < string name= '' DeviceListActivity_unlink_s '' > Unlink \ ' % s\ ' ? < /string > diff -- git a/src/org/thoughtcrime/securesms/MediaPreviewActivity.java b/src/org/thoughtcrime/securesms/MediaPreviewActivity.java index 8d6831f..181d10e 100644 -- - a/src/org/thoughtcrime/securesms/MediaPreviewActivity.java +++ b/src/org/thoughtcrime/securesms/MediaPreviewActivity.java @ @ -94,9 +94,7 @ @ public class MediaPreviewActivity extends PassphraseRequiredActionBarActivity im private void initializeActionBar ( ) { final CharSequence relativeTimeSpan ; if ( date > 0 ) { - relativeTimeSpan Time/date not translated in image view __EoT__ 2.19.0 _Edit : see third comment for a proper bug report._ ! [ phil thomas katt enterprise room ] ( https : //cloud.githubusercontent.com/assets/174176/8272598/879f4cfe-1852-11e5-9218-54a47715bf88.png )
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index c6467b7..e4720d3 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -5,7 +5,7 @ @ android : versionCode= '' 58 '' android : versionName= '' 1.0.2 '' > - < uses-sdk android : minSdkVersion= '' 8 '' android : targetSdkVersion= '' 17 '' / > + < uses-sdk android : minSdkVersion= '' 8 '' android : targetSdkVersion= '' 19 '' / > < permission android : name= '' org.thoughtcrime.securesms.ACCESS_SECRETS '' android : label= '' Access to TextSecure Secrets '' @ @ -60,6 +60,8 @ @ < category android : name= '' android.intent.category.DEFAULT '' / > < data android : scheme= '' sms '' / > < data android : scheme= '' smsto '' / > + < data android : scheme= '' mms '' / > + < data android : scheme= '' mmsto '' / > < /intent-filter > < intent-filter > @ @ -193,6 +195,9 @ @ < action android : name= '' android.provider.Telephony.SMS_RECEIVED '' / > < /intent-filter > < intent-filter > + < action android : name= '' android.provider.Telephony.SMS_DELIVER '' / > + < /intent-filter > + < intent-filter > < action android : name= '' org.thoughtcrime.securesms.services.MESSAGE_SENT '' / > < /intent-filter KitKat update : messages going to hangouts __EoT__ When I first installed the app , I had issues with messages going to the stock messaging app despite TextSecure being set as default . That issue stopped when I disabled the stock messaging app . Now with the KitKat update , messages are going to Hangouts instead of TextSecure . I really do n't want to have to disable Hangouts because I use hangouts . I see in the play store , this is a known issue . Has anyone come up with a workaround for it yet ?
diff -- git a/build.gradle b/build.gradle index a60afe8..6cdf3a7 100644 -- - a/build.gradle +++ b/build.gradle @ @ -228,7 +228,8 @ @ android { 'proguard-shortcutbadger.pro ' , 'proguard-retrofit.pro ' , 'proguard.cfg' - testProguardFiles 'proguard-automation.pro' + testProguardFiles 'proguard-automation.pro ' , + 'proguard.cfg' } release { minifyEnabled true diff -- git a/proguard-automation.pro b/proguard-automation.pro index 9932571..43561f7 100644 -- - a/proguard-automation.pro +++ b/proguard-automation.pro @ @ -9,3 +9,5 @ @ -dontwarn org.hamcrest . ** -dontwarn org.mockito . ** -dontwarn com.squareup . ** + +-dontobfuscate \ No newline at end of file diff -- git a/src/org/thoughtcrime/securesms/database/AttachmentDatabase.java b/src/org/thoughtcrime/securesms/database/AttachmentDatabase.java index b78abc6..8fb986f 100644 -- - a/src/org/thoughtcrime/securesms/database/AttachmentDatabase.java +++ b/src/org/thoughtcrime/securesms/database/AttachmentDatabase.java @ @ -357,7 +357,7 @ @ public class AttachmentDatabase extends Database { } @ VisibleForTesting - @ Nullable InputStream getDataStream ( MasterSecret masterSecret , AttachmentId attachmentId , String dataType ) + protected @ Nullable InputStream getDataStream ( MasterSecret masterSecret , AttachmentId attachmentId , String dataType ) { File dataFile = getAttachmentDataFile ( attachmentId , dataType ) ; @ @ -491,7 +491,7 @ @ public class AttachmentDatabase extends Database { @ VisibleForTesting - void updateAttachmentThumbnail ( MasterSecret masterSecret , AttachmentId attachmentId , InputStream in , float aspectRatio ) + protected void updateAttachmentThumbnail ( MasterSecret masterSecret , AttachmentId attachmentId , InputStream in , float aspectRatio ) Fix the tests in org.thoughtcrime.securesms.database.AttachmentDatabaseTest.java __EoT__ Now that the tests are back , let 's fix the tests in AttachmentDatabaseTest.java .
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 85e316e..ddaf212 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -226,6 +226,14 @ @ < /intent-filter > < /activity > + < activity android : name= '' .RecipientPreferenceActivity '' + android : theme= '' @ style/TextSecure.LightNoActionBar '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + + < activity android : name= '' .BlockedContactsActivity '' + android : theme= '' @ style/TextSecure.LightTheme '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + < activity android : name= '' com.soundcloud.android.crop.CropImageActivity '' / > < service android : enabled= '' true '' android : name= '' .service.ApplicationMigrationService '' / > diff -- git a/res/drawable-hdpi/ic_block_grey600_18dp.png b/res/drawable-hdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..02982bf Binary files /dev/null and b/res/drawable-hdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_block_white_18dp.png b/res/drawable-hdpi/ic_block_white_18dp.png new file mode 100644 index 0000000..71b0a08 Binary files /dev/null and b/res/drawable-hdpi/ic_block_white_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_grey600_18dp.png b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png new file mode 100644 index 0000000..6cf04dc Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_white_18dp.png b/res/drawable-hdpi/ic_volume_off_white_18dp.png new file mode 100644 index 0000000..a227897 Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_white_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_grey600_18dp.png b/res/drawable-mdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..ddf39b3 Binary files /dev/null and b/res/drawable-mdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_white_18dp.png b/res/drawable-mdpi/ic_block_white_18dp.png new file mode 100644 index Feature : Blocking __EoT__ Blocking by user-specified phone number , via something like an email filter rule where the messages from the number are deleted upon receipt and no notification is given .
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index b469c83..d30799b 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -196,6 +196,9 @ @ android : label= '' @ string/AndroidManifest__media_preview '' android : windowSoftInputMode= '' stateHidden '' android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + + < activity android : name= '' .RecipientNotificationSettingsActivity '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > < activity android : name= '' .DummyActivity '' android : theme= '' @ android : style/Theme.NoDisplay '' diff -- git a/build.gradle b/build.gradle index b6cbf4a..42c4f38 100644 -- - a/build.gradle +++ b/build.gradle @ @ -44,6 +44,10 @ @ dependencies { } compile 'com.squareup.dagger : dagger:1.2.2' provided 'com.squareup.dagger : dagger-compiler:1.2.2' + + compile ( `` com.doomonafireball.betterpickers : library:1.5.2 '' ) { + exclude group : 'com.android.support ' , module : 'support-v4' + } androidTestCompile 'com.squareup : fest-android:1.0.8' androidTestCompile 'com.google.dexmaker : dexmaker:1.1' diff -- git a/res/layout/conversation_fragment.xml b/res/layout/conversation_fragment.xml index 033c9ae..718a751 100644 -- - a/res/layout/conversation_fragment.xml +++ b/res/layout/conversation_fragment.xml @ @ -5,6 +5,12 @ @ android : layout_height= '' match_parent '' android : orientation= '' vertical '' > + < FrameLayout + android : layout_width= '' wrap_content '' + android : layout_height= '' wrap_content '' + android : id= '' @ +id/reminderHolder '' > + < /FrameLayout > + Feature : Blocking __EoT__ Blocking by user-specified phone number , via something like an email filter rule where the messages from the number are deleted upon receipt and no notification is given .
diff -- git a/src/org/thoughtcrime/securesms/database/model/MessageRecord.java b/src/org/thoughtcrime/securesms/database/model/MessageRecord.java index 112e646..c73b7c8 100644 -- - a/src/org/thoughtcrime/securesms/database/model/MessageRecord.java +++ b/src/org/thoughtcrime/securesms/database/model/MessageRecord.java @ @ -16,7 +16,11 @ @ */ package org.thoughtcrime.securesms.database.model ; +import android.content.ContentResolver ; import android.content.Context ; +import android.database.Cursor ; +import android.net.Uri ; +import android.provider.ContactsContract ; import android.text.Spannable ; import android.text.SpannableString ; import android.text.style.RelativeSizeSpan ; @ @ -30,8 +34,12 @ @ import org.thoughtcrime.securesms.database.documents.IdentityKeyMismatch ; import org.thoughtcrime.securesms.recipients.Recipient ; import org.thoughtcrime.securesms.recipients.Recipients ; import org.thoughtcrime.securesms.util.GroupUtil ; +import org.whispersystems.libaxolotl.logging.Log ; +import java.util.ArrayList ; import java.util.List ; +import java.util.regex.Matcher ; +import java.util.regex.Pattern ; /** * The base class for message record models that are displayed in @ @ -119,7 +127,20 @ @ public abstract class MessageRecord extends DisplayRecord { return new SpannableString ( getBody ( ) .getBody ( ) .substring ( 0 , MAX_DISPLAY_LENGTH ) ) ; } - return new SpannableString ( getBody ( ) .getBody ( ) ) ; + + ArrayList < KnownPhoneNumbers > knownPhoneNumbersArrayList= checkForPhoneNumber ( getBody ( ) .getBody ( ) ) ; + String message=getBody ( ) .getBody ( ) ; + + if ( knownPhoneNumbersArrayList.size ( ) > 0 ) { + int offset=0 ; + for ( KnownPhoneNumbers knownN : knownPhoneNumbersArrayList ) { + message= ( message.substring ( 0 , knownN.getEnd ( ) +offset ) [ Feature ] Convert known phone numbers in text body into contact names __EoT__ Splitting this out from @ brwolfgang 's # 2582 request for clickable phone numbers . > It also would be nice if TS would identify the number in text body using my local contacts list and instead of showing the unrecognizable sequence of numbers it showed a ( clickable ) contact name . > > A SMS example : Você recebeu ligações de : 04111123451234 16:59hs > A processed SMS example : Você recebeu ligações de : : Dad 16:59hs ~~Blocked on # 2582.~~
diff -- git a/res/values/strings.xml b/res/values/strings.xml index eada056..ab25c4b 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -854,6 +854,7 @ @ < string name= '' preferences__support_wifi_calling '' > \'WiFi Calling\ ' compatibility mode < /string > < string name= '' preferences__enable_if_your_device_supports_sms_mms_delivery_over_wifi '' > Enable if your device uses SMS/MMS delivery over WiFi ( only enable when \'WiFi Calling\ ' is enabled on your device ) < /string > < string name= '' preferences_app_protection__blocked_contacts '' > Blocked contacts < /string > + < string name= '' preferences__devices '' > Devices < /string > < ! -- **************************************** -- > < ! -- menus -- > diff -- git a/res/xml/preferences.xml b/res/xml/preferences.xml index 79ba260..a91aaea 100644 -- - a/res/xml/preferences.xml +++ b/res/xml/preferences.xml @ @ -22,7 +22,7 @ @ android : icon= '' ? pref_ic_storage '' / > < ! -- < Preference android : key= '' preference_category_devices '' -- > - < ! -- android : title= '' Devices '' -- > + < ! -- android : title= '' @ string/preferences__devices '' -- > < ! -- android : icon= '' ? pref_ic_devices '' > -- > < ! -- < /Preference > -- > Devices image wrong dimensions __EoT__ The 'devices ' image in the preferences activity does not fit the dimensions of the other images . The ones I checked are 12 pixels off ( up and down ) . Another perfect thing to fix for @ agrajaghh : wave :
diff -- git a/assets/DDC_Uchen.ttf b/assets/DDC_Uchen.ttf new file mode 100644 index 0000000..b4707dc Binary files /dev/null and b/assets/DDC_Uchen.ttf differ diff -- git a/assets/monlambodyig.ttf b/assets/monlambodyig.ttf new file mode 100644 index 0000000..3f51f30 Binary files /dev/null and b/assets/monlambodyig.ttf differ diff -- git a/res/layout/auto_initiate_activity.xml b/res/layout/auto_initiate_activity.xml index 6a3e71e..c07be0d 100644 -- - a/res/layout/auto_initiate_activity.xml +++ b/res/layout/auto_initiate_activity.xml @ @ -5,24 +5,24 @ @ android : orientation= '' vertical '' android : padding= '' 10px '' > - < TextView android : id= '' @ +id/description_text '' + < org.thoughtcrime.securesms.lang.BhoTextView android : id= '' @ +id/description_text '' android : layout_width= '' fill_parent '' android : layout_height= '' wrap_content '' android : layout_marginBottom= '' 5px '' - android : text= '' You have received a message from someone who supports TextSecure encrypted sessions . Would you like to initiate a key exchange so you can communicate securely ? `` / > + android : text= '' @ string/you_have_received_a_message_from_someone_who_supports_textsecure '' / > < LinearLayout android : layout_width= '' fill_parent '' android : layout_height= '' wrap_content '' android : layout_marginTop= '' 10px '' android : orientation= '' horizontal '' > - < Button android : id= '' @ +id/initiate_button '' + < org.thoughtcrime.securesms.lang.BhoButton android : id= '' @ +id/initiate_button '' android : layout_width= '' [ KitKat ] Attempt to retreive MMS causes TextSecure to crash __EoT__ If you open a thread containing an MMS that is yet to be retrieved from the carrier ( T-Mobile USA , in my case ) , TextSecure crashes . Stack trace using Nexus 5 on KitKat : `` ` E/DatabaseUtils ( 989 ) : Writing exception to parcel E/DatabaseUtils ( 989 ) : java.lang.SecurityException : No permission to write APN settings : Neither user 10102 nor current process has android.permission.WRITE_APN_SETTINGS . E/DatabaseUtils ( 989 ) : at android.app.ContextImpl.enforce ( ContextImpl.java:1685 ) E/DatabaseUtils ( 989 ) : at android.app.ContextImpl.enforceCallingOrSelfPermission ( ContextImpl.java:1714 ) E/DatabaseUtils ( 989 ) : at com.android.providers.telephony.TelephonyProvider.checkPermission ( TelephonyProvider.java:735 ) E/DatabaseUtils ( 989 ) : at com.android.providers.telephony.TelephonyProvider.query ( TelephonyProvider.java:462 ) E/DatabaseUtils ( 989 ) : at android.content.ContentProvider.query ( ContentProvider.java:855 ) E/DatabaseUtils ( 989 ) : at android.content.ContentProvider $ Transport.query ( ContentProvider.java:200 ) E/DatabaseUtils ( 989 ) : at android.content.ContentProviderNative.onTransact ( ContentProviderNative.java:112 ) E/DatabaseUtils ( 989 ) : at android.os.Binder.execTransact ( Binder.java:404 ) E/DatabaseUtils ( 989 ) : at dalvik.system.NativeStart.run ( Native Method ) W/MmsCommunication ( 13159 ) : java.lang.SecurityException : No permission to write APN settings : Neither user 10102 nor current process has android.permission.WRITE_APN_SETTINGS . W/MmsCommunication
diff -- git a/.gitignore b/.gitignore index ccf7cd1..ae3bf7b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,4 +3,4 @ @ project.properties .project .settings bin/ -gen/ +gen/ \ No newline at end of file diff -- git a/assets/DDC_Uchen.ttf b/assets/DDC_Uchen.ttf new file mode 100644 index 0000000..b4707dc Binary files /dev/null and b/assets/DDC_Uchen.ttf differ diff -- git a/assets/monlambodyig.ttf b/assets/monlambodyig.ttf new file mode 100644 index 0000000..3f51f30 Binary files /dev/null and b/assets/monlambodyig.ttf differ diff -- git a/build.xml b/build.xml new file mode 100644 index 0000000..2569595 -- - /dev/null +++ b/build.xml @ @ -0,0 +1,85 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < project name= '' TextSecure '' default= '' help '' > + + < ! -- The local.properties file is created and updated by the 'android ' tool . + It contains the path to the SDK . It should *NOT* be checked into + Version Control Systems . -- > + < property file= '' local.properties '' / > + + < ! -- The ant.properties file can be created by you . It is only edited by the + 'android ' tool to add properties to it . + This is the place to change [ KitKat ] Attempt to retreive MMS causes TextSecure to crash __EoT__ If you open a thread containing an MMS that is yet to be retrieved from the carrier ( T-Mobile USA , in my case ) , TextSecure crashes . Stack trace using Nexus 5 on KitKat : `` ` E/DatabaseUtils ( 989 ) : Writing exception to parcel E/DatabaseUtils ( 989 ) : java.lang.SecurityException : No permission to write APN settings : Neither user 10102 nor current process has android.permission.WRITE_APN_SETTINGS . E/DatabaseUtils ( 989 ) : at android.app.ContextImpl.enforce ( ContextImpl.java:1685 ) E/DatabaseUtils ( 989 ) : at android.app.ContextImpl.enforceCallingOrSelfPermission ( ContextImpl.java:1714 ) E/DatabaseUtils ( 989 ) : at com.android.providers.telephony.TelephonyProvider.checkPermission ( TelephonyProvider.java:735 ) E/DatabaseUtils ( 989 ) : at com.android.providers.telephony.TelephonyProvider.query ( TelephonyProvider.java:462 ) E/DatabaseUtils ( 989 ) : at android.content.ContentProvider.query ( ContentProvider.java:855 ) E/DatabaseUtils ( 989 ) : at android.content.ContentProvider $ Transport.query ( ContentProvider.java:200 ) E/DatabaseUtils ( 989 ) : at android.content.ContentProviderNative.onTransact ( ContentProviderNative.java:112 ) E/DatabaseUtils ( 989 ) : at android.os.Binder.execTransact ( Binder.java:404 ) E/DatabaseUtils ( 989 ) : at dalvik.system.NativeStart.run ( Native Method ) W/MmsCommunication ( 13159 ) : java.lang.SecurityException : No permission to write APN settings : Neither user 10102 nor current process has android.permission.WRITE_APN_SETTINGS . W/MmsCommunication
diff -- git a/.gitignore b/.gitignore index ccf7cd1..ae3bf7b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,4 +3,4 @ @ project.properties .project .settings bin/ -gen/ +gen/ \ No newline at end of file diff -- git a/assets/DDC_Uchen.ttf b/assets/DDC_Uchen.ttf new file mode 100644 index 0000000..b4707dc Binary files /dev/null and b/assets/DDC_Uchen.ttf differ diff -- git a/assets/monlambodyig.ttf b/assets/monlambodyig.ttf new file mode 100644 index 0000000..3f51f30 Binary files /dev/null and b/assets/monlambodyig.ttf differ diff -- git a/build.xml b/build.xml new file mode 100644 index 0000000..2569595 -- - /dev/null +++ b/build.xml @ @ -0,0 +1,85 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < project name= '' TextSecure '' default= '' help '' > + + < ! -- The local.properties file is created and updated by the 'android ' tool . + It contains the path to the SDK . It should *NOT* be checked into + Version Control Systems . -- > + < property file= '' local.properties '' / > + + < ! -- The ant.properties file can be created by you . It is only edited by the + 'android ' tool to add properties to it . + This is the place to change [ KitKat ] Attempt to retreive MMS causes TextSecure to crash __EoT__ If you open a thread containing an MMS that is yet to be retrieved from the carrier ( T-Mobile USA , in my case ) , TextSecure crashes . Stack trace using Nexus 5 on KitKat : `` ` E/DatabaseUtils ( 989 ) : Writing exception to parcel E/DatabaseUtils ( 989 ) : java.lang.SecurityException : No permission to write APN settings : Neither user 10102 nor current process has android.permission.WRITE_APN_SETTINGS . E/DatabaseUtils ( 989 ) : at android.app.ContextImpl.enforce ( ContextImpl.java:1685 ) E/DatabaseUtils ( 989 ) : at android.app.ContextImpl.enforceCallingOrSelfPermission ( ContextImpl.java:1714 ) E/DatabaseUtils ( 989 ) : at com.android.providers.telephony.TelephonyProvider.checkPermission ( TelephonyProvider.java:735 ) E/DatabaseUtils ( 989 ) : at com.android.providers.telephony.TelephonyProvider.query ( TelephonyProvider.java:462 ) E/DatabaseUtils ( 989 ) : at android.content.ContentProvider.query ( ContentProvider.java:855 ) E/DatabaseUtils ( 989 ) : at android.content.ContentProvider $ Transport.query ( ContentProvider.java:200 ) E/DatabaseUtils ( 989 ) : at android.content.ContentProviderNative.onTransact ( ContentProviderNative.java:112 ) E/DatabaseUtils ( 989 ) : at android.os.Binder.execTransact ( Binder.java:404 ) E/DatabaseUtils ( 989 ) : at dalvik.system.NativeStart.run ( Native Method ) W/MmsCommunication ( 13159 ) : java.lang.SecurityException : No permission to write APN settings : Neither user 10102 nor current process has android.permission.WRITE_APN_SETTINGS . W/MmsCommunication
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 938fc1a..1c086ce 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -173,6 +173,16 @ @ < /activity-alias > + < activity android : name= '' .ConversationListArchiveActivity '' + android : label= '' Conversations archive '' + android : launchMode= '' singleTask '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' + android : parentActivityName= '' .ConversationListActivity '' > + < meta-data + android : name= '' android.support.PARENT_ACTIVITY '' + android : value= '' org.thoughtcrime.securesms.ConversationListActivity '' / > + < /activity > + < activity android : name= '' .ConversationActivity '' android : windowSoftInputMode= '' stateUnchanged '' android : launchMode= '' singleTask '' diff -- git a/res/drawable-hdpi/ic_archive_white_24dp.png b/res/drawable-hdpi/ic_archive_white_24dp.png new file mode 100644 index 0000000..bb72e89 Binary files /dev/null and b/res/drawable-hdpi/ic_archive_white_24dp.png differ diff -- git a/res/drawable-hdpi/ic_unarchive_white_36dp.png b/res/drawable-hdpi/ic_unarchive_white_36dp.png new file mode 100644 index 0000000..3c6ea89 Binary files /dev/null and b/res/drawable-hdpi/ic_unarchive_white_36dp.png differ diff -- git a/res/drawable-mdpi/ic_archive_white_24dp.png b/res/drawable-mdpi/ic_archive_white_24dp.png new file mode 100644 index 0000000..f6aa3f9 Binary files /dev/null and b/res/drawable-mdpi/ic_archive_white_24dp.png differ diff -- git a/res/drawable-mdpi/ic_unarchive_white_36dp.png b/res/drawable-mdpi/ic_unarchive_white_36dp.png new file mode 100644 index 0000000..18730f1 Binary files /dev/null and b/res/drawable-mdpi/ic_unarchive_white_36dp.png differ diff -- git a/res/drawable-v21/conversation_list_item_background.xml b/res/drawable-v21/conversation_list_item_background.xml deleted file mode 100644 index 6428791..0000000 -- - a/res/drawable-v21/conversation_list_item_background.xml +++ /dev/null @ @ -1,10 +0,0 @ @ - < ? xml version= swipe to delete messages __EoT__ Need a feature to delete messages by swiping
diff -- git a/README.md b/README.md index 0b78fd9..7cd731c 100644 -- - a/README.md +++ b/README.md @ @ -45,7 +45,7 @ @ whispersystems @ lists.riseup.net https : //lists.riseup.net/www/info/whispersystems # # Contributing Funds - [ ! [ Donate ] ( https : //www.coinbase.com/assets/buttons/donation_large-5e1b50d6490970e32b80023f3070b1d77afc621b9e64ac996596a67a4671967b.png ) ] ( https : //www.coinbase.com/checkouts/51dac699e660a4d773216b5ad94d6a0b ) + [ ! [ Donate ] ( https : //cloud.githubusercontent.com/assets/3121306/11278543/d46e03d0-8eeb-11e5-9691-0da1bf643192.png ) ] ( https : //www.coinbase.com/checkouts/51dac699e660a4d773216b5ad94d6a0b ) You can add funds to BitHub to directly help further development efforts . Donate button image not loading __EoT__ In README.md appears donate button is broken .
diff -- git a/src/org/thoughtcrime/securesms/sms/MessageSender.java b/src/org/thoughtcrime/securesms/sms/MessageSender.java index 2660a8a..97a854a 100644 -- - a/src/org/thoughtcrime/securesms/sms/MessageSender.java +++ b/src/org/thoughtcrime/securesms/sms/MessageSender.java @ @ -286,6 +286,10 @ @ public class MessageSender { return false ; } + if ( TextSecurePreferences.isMultiDevice ( context ) ) { + return false ; + } + return Util.isOwnNumber ( context , recipients.getPrimaryRecipient ( ) .getNumber ( ) ) ; } [ Feature Request ] Add ability to directly pull internal storage files to signal database . __EoT__ For additional security of private content on storage , I think it would be great to have an option to directly pull internal storage contents to signal database .
diff -- git a/build.gradle b/build.gradle index c251f61..5b4ffb1 100644 -- - a/build.gradle +++ b/build.gradle @ @ -72,10 +72,14 @ @ dependencies { compile 'org.whispersystems : jobmanager:1.0.2' compile 'org.whispersystems : libpastelog:1.0.7' compile 'com.amulyakhare : com.amulyakhare.textdrawable:1.0.1' - compile 'org.whispersystems : signal-service-android:2.1.1' + compile 'org.whispersystems : signal-service-android:2.2.0' compile 'com.h6ah4i.android.compat : mulsellistprefcompat:1.0.0' compile 'com.google.zxing : core:3.2.1' + compile ( 'cn.carbswang.android : NumberPickerView:1.0.9 ' ) { + exclude group : 'com.android.support ' , module : 'appcompat-v7' + } + testCompile 'junit : junit:4.12' testCompile 'org.assertj : assertj-core:1.7.1' testCompile 'org.mockito : mockito-core:1.9.5' @ @ -97,57 +101,58 @ @ dependencies { dependencyVerification { verify = [ - 'me.leolin : ShortcutBadger:3142d017234bfa0cdd69ccded7cc5ea63f13b97574803c8c616c9bbeaad33ad9 ' , - 'se.emilsjolander : stickylistheaders : a08ca948aa6b220f09d82f16bbbac395f6b78897e9eeac6a9f0b0ba755928eeb ' , - 'com.google.android.gms : play-services-gcm:757ecd2c837ac81c98f4cc7dc783e7454c6d0506f6cc66b10417126b675248c9 ' , - 'com.google.android.gms : play-services-maps : c58a9d98a98889fb0b27f78100f2d9341ed7722db24ccf832df62b6e8ce1b42e ' , - 'com.google.android.gms : play-services-location:8226f778aa86bd15b9143f62425262cc53d64021990f62eb1aaec108d4e25f35 ' , - 'com.jpardogo.materialtabstrip : library : c6ef812fba4f74be7dc4a905faa4c2908cba261a94c13d4f96d5e67e4aad4aaa ' , - 'org.w3c : smil:085dc40f2bb249651578bfa07499fd08b16ad0886dbe2c4078586a408da62f9b ' , - 'org.apache.httpcomponents : httpclient-android:6f56466a9bd0d42934b90bfbfe9977a8b654c058bf44a12bdc2877c4e1f033f1 ' , - 'com.github.chrisbanes.photoview : library:8b5344e206f125e7ba9d684008f36c4992d03853c57e5814125f88496126e3cc ' , - 'com.github.bumptech.glide : glide:76ef123957b5fbaebb05fcbe6606dd58c3bc3fcdadb257f99811d0ac9ea9b88b ' , - 'com.makeramen : roundedimageview:1f5a1865796b308c6cdd114acc6e78408b110f0a62fc63553278fbeacd489cd1 ' , - 'com.pnikosis : materialish-progress : d71d80e00717a096784482aee21001a9d299fec3833e4ebd87739ed36cf77c54 ' , - 'de.greenrobot : eventbus:61d743a748156a372024d083de763b9e91ac2dcb3f6a1cbc74995c7ddab6e968 ' , - 'pl.tajchert : waitingdots:2835d49e0787dbcb606c5a60021ced66578503b1e9fddcd7a5ef0cd5f095ba2c ' , - 'com.soundcloud.android : android-crop : ffd4b973cf6e97f7d64118a0dc088df50e9066fd5634fe6911dd0c0c5d346177 ' , - 'com.android.support disappearing messages does not cover call logs __EoT__ I have : - [ X ] searched open and closed issues for duplicates - [ X ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description The awesome `` disappearing messages '' feature does not cover call notifications ( ` MessageRecord_called_s ` and ` MessageRecord_s_called_you ` ) . IMHO they should disappear the same way other messages do . For one , these kinds of metadata records can be sensitive information , too . And from a user perspective , `` messages '' should cover *all* message types . # # # Steps to reproduce - set `` disappearing messages '' to any value - make or receive call - wait until time for disappearing messages has passed **Actual result : ** call notification does not disappear **Expected result : ** call notification disappears # # # Device info **Device : ** any **Android version : ** 7.1.2 **Signal version : ** 4.8.1
diff -- git a/res/drawable-xxxhdpi-v11/icon_notification.png b/res/drawable-xxxhdpi-v11/icon_notification.png index cd51da7..5099428 100644 Binary files a/res/drawable-xxxhdpi-v11/icon_notification.png and b/res/drawable-xxxhdpi-v11/icon_notification.png differ Notifications showing old signal icon __EoT__ I 've noticed that for a couple versions now , the signal notification icon is showing the old one with a hole in the top of the circle . Verizon Note 5 , Stock 5.1.1 , dark theme .
diff -- git a/androidTest/org/thoughtcrime/securesms/database/CanonicalAddressDatabaseTest.java b/androidTest/org/thoughtcrime/securesms/database/CanonicalAddressDatabaseTest.java new file mode 100644 index 0000000..c6d2cf7 -- - /dev/null +++ b/androidTest/org/thoughtcrime/securesms/database/CanonicalAddressDatabaseTest.java @ @ -0,0 +1,39 @ @ +package org.thoughtcrime.securesms.database ; + +import android.content.Context ; +import android.content.SharedPreferences ; +import android.test.InstrumentationTestCase ; +import android.test.mock.MockContext ; + +import static org.fest.assertions.api.Assertions . * ; +import static org.mockito.Mockito . * ; + +public class CanonicalAddressDatabaseTest extends InstrumentationTestCase { + private static final String LOCAL_NUMBER = `` +15555555555 '' ; + private Context mockContext ; + private SharedPreferences mockSharedPreferences ; + + public void testCanonicalizeAddressNumeric ( ) throws Exception { + assertThat ( CanonicalAddressDatabase.canonicalizeAddress ( mockContext , `` 555 5555 '' ) ) .isEqualTo ( LOCAL_NUMBER ) ; + } + + public void testCanonicalAddressEmail ( ) throws Exception { + assertThat ( CanonicalAddressDatabase.canonicalizeAddress ( mockContext , `` email @ domain.com '' ) ) . isEqualTo ( `` email @ domain.com '' ) ; + } + + public void testCanonicalAddressAlpha ( ) throws Exception { + assertThat ( CanonicalAddressDatabase.canonicalizeAddress ( mockContext , `` T-Mobile '' ) ) .isEqualTo ( `` T-Mobile '' ) ; + } + + @ Override + public void setUp ( ) throws Exception { + super.setUp ( ) ; + // https : //code.google.com/p/dexmaker/issues/detail ? Changing Phone Number does n't work __EoT__ A friend and I try to chat via TextSecure . I am located in Germany , he is located in England . Because he is from Germany originally , he still had my German number without the international prefix in his phone book . Now , when I wrote him , he could not answer me . Then , he changed my phone number in his address book to include the international prefix and he hit `` Update Directory '' . Still , we can not chat since TextSecure tries to use the number without the prefix . I think two things are amiss here : First , when I send him a message , TextSecure should be able to answer regardless of the number he has in his phone book . I.e. , TextSecure should see that the message came from a phone number +49 ... and answer to that number ( potentially telling him that this is not the number associated with my contact , i.e . someone could be trying to spoof him ) . Second , of course TextSecure should notice the change in telephone numbers and update the
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 85e316e..ddaf212 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -226,6 +226,14 @ @ < /intent-filter > < /activity > + < activity android : name= '' .RecipientPreferenceActivity '' + android : theme= '' @ style/TextSecure.LightNoActionBar '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + + < activity android : name= '' .BlockedContactsActivity '' + android : theme= '' @ style/TextSecure.LightTheme '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + < activity android : name= '' com.soundcloud.android.crop.CropImageActivity '' / > < service android : enabled= '' true '' android : name= '' .service.ApplicationMigrationService '' / > diff -- git a/res/drawable-hdpi/ic_block_grey600_18dp.png b/res/drawable-hdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..02982bf Binary files /dev/null and b/res/drawable-hdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_block_white_18dp.png b/res/drawable-hdpi/ic_block_white_18dp.png new file mode 100644 index 0000000..71b0a08 Binary files /dev/null and b/res/drawable-hdpi/ic_block_white_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_grey600_18dp.png b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png new file mode 100644 index 0000000..6cf04dc Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_white_18dp.png b/res/drawable-hdpi/ic_volume_off_white_18dp.png new file mode 100644 index 0000000..a227897 Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_white_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_grey600_18dp.png b/res/drawable-mdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..ddf39b3 Binary files /dev/null and b/res/drawable-mdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_white_18dp.png b/res/drawable-mdpi/ic_block_white_18dp.png new file mode 100644 index different notification settings for group chats __EoT__ It would be very nice to be able to change the notification settings for goups independently from other ( personal ) chats , as group chats might have a lower priority for the user .
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 85e316e..ddaf212 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -226,6 +226,14 @ @ < /intent-filter > < /activity > + < activity android : name= '' .RecipientPreferenceActivity '' + android : theme= '' @ style/TextSecure.LightNoActionBar '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + + < activity android : name= '' .BlockedContactsActivity '' + android : theme= '' @ style/TextSecure.LightTheme '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + < activity android : name= '' com.soundcloud.android.crop.CropImageActivity '' / > < service android : enabled= '' true '' android : name= '' .service.ApplicationMigrationService '' / > diff -- git a/res/drawable-hdpi/ic_block_grey600_18dp.png b/res/drawable-hdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..02982bf Binary files /dev/null and b/res/drawable-hdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_block_white_18dp.png b/res/drawable-hdpi/ic_block_white_18dp.png new file mode 100644 index 0000000..71b0a08 Binary files /dev/null and b/res/drawable-hdpi/ic_block_white_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_grey600_18dp.png b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png new file mode 100644 index 0000000..6cf04dc Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_white_18dp.png b/res/drawable-hdpi/ic_volume_off_white_18dp.png new file mode 100644 index 0000000..a227897 Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_white_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_grey600_18dp.png b/res/drawable-mdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..ddf39b3 Binary files /dev/null and b/res/drawable-mdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_white_18dp.png b/res/drawable-mdpi/ic_block_white_18dp.png new file mode 100644 index different notification settings for group chats __EoT__ It would be very nice to be able to change the notification settings for goups independently from other ( personal ) chats , as group chats might have a lower priority for the user .
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 85e316e..ddaf212 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -226,6 +226,14 @ @ < /intent-filter > < /activity > + < activity android : name= '' .RecipientPreferenceActivity '' + android : theme= '' @ style/TextSecure.LightNoActionBar '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + + < activity android : name= '' .BlockedContactsActivity '' + android : theme= '' @ style/TextSecure.LightTheme '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + < activity android : name= '' com.soundcloud.android.crop.CropImageActivity '' / > < service android : enabled= '' true '' android : name= '' .service.ApplicationMigrationService '' / > diff -- git a/res/drawable-hdpi/ic_block_grey600_18dp.png b/res/drawable-hdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..02982bf Binary files /dev/null and b/res/drawable-hdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_block_white_18dp.png b/res/drawable-hdpi/ic_block_white_18dp.png new file mode 100644 index 0000000..71b0a08 Binary files /dev/null and b/res/drawable-hdpi/ic_block_white_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_grey600_18dp.png b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png new file mode 100644 index 0000000..6cf04dc Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_white_18dp.png b/res/drawable-hdpi/ic_volume_off_white_18dp.png new file mode 100644 index 0000000..a227897 Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_white_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_grey600_18dp.png b/res/drawable-mdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..ddf39b3 Binary files /dev/null and b/res/drawable-mdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_white_18dp.png b/res/drawable-mdpi/ic_block_white_18dp.png new file mode 100644 index different notification settings for group chats __EoT__ It would be very nice to be able to change the notification settings for goups independently from other ( personal ) chats , as group chats might have a lower priority for the user .
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 85e316e..ddaf212 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -226,6 +226,14 @ @ < /intent-filter > < /activity > + < activity android : name= '' .RecipientPreferenceActivity '' + android : theme= '' @ style/TextSecure.LightNoActionBar '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + + < activity android : name= '' .BlockedContactsActivity '' + android : theme= '' @ style/TextSecure.LightTheme '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + < activity android : name= '' com.soundcloud.android.crop.CropImageActivity '' / > < service android : enabled= '' true '' android : name= '' .service.ApplicationMigrationService '' / > diff -- git a/res/drawable-hdpi/ic_block_grey600_18dp.png b/res/drawable-hdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..02982bf Binary files /dev/null and b/res/drawable-hdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_block_white_18dp.png b/res/drawable-hdpi/ic_block_white_18dp.png new file mode 100644 index 0000000..71b0a08 Binary files /dev/null and b/res/drawable-hdpi/ic_block_white_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_grey600_18dp.png b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png new file mode 100644 index 0000000..6cf04dc Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_white_18dp.png b/res/drawable-hdpi/ic_volume_off_white_18dp.png new file mode 100644 index 0000000..a227897 Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_white_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_grey600_18dp.png b/res/drawable-mdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..ddf39b3 Binary files /dev/null and b/res/drawable-mdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_white_18dp.png b/res/drawable-mdpi/ic_block_white_18dp.png new file mode 100644 index different notification settings for group chats __EoT__ It would be very nice to be able to change the notification settings for goups independently from other ( personal ) chats , as group chats might have a lower priority for the user .
diff -- git a/res/drawable-xxhdpi/ic_error_red_18dp.png b/res/drawable-xxhdpi/ic_error_red_18dp.png new file mode 100644 index 0000000..ed4faed Binary files /dev/null and b/res/drawable-xxhdpi/ic_error_red_18dp.png differ diff -- git a/res/layout/alert_view.xml b/res/layout/alert_view.xml new file mode 100644 index 0000000..80c2daa -- - /dev/null +++ b/res/layout/alert_view.xml @ @ -0,0 +1,24 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < merge xmlns : android= '' http : //schemas.android.com/apk/res/android '' + xmlns : tools= '' http : //schemas.android.com/tools '' > + + < ImageView + android : id= '' @ +id/sms_failed_indicator '' + android : layout_width= '' wrap_content '' + android : layout_height= '' wrap_content '' + android : src= '' @ drawable/ic_error_red_24dp '' + android : visibility= '' gone '' + tools : visibility= '' visible '' + android : contentDescription= '' @ string/conversation_item_sent__send_failed_indicator_description '' / > + + < ImageView + android : id= '' @ +id/pending_approval_indicator '' + android : layout_width= '' wrap_content '' + android : layout_height= '' wrap_content '' + android : src= '' @ drawable/ic_info_outline_grey600_24dp '' + android : visibility= '' gone '' + tools : visibility= '' visible '' + android : layout_gravity= '' center_vertical '' + android : contentDescription= '' @ string/conversation_item_sent__pending_approval_description '' / > + + < `` Archived '' and outgoing picture bug in conversation list __EoT__ Signal 3.6.0 . Screen is about 4.3 '' . 1 . I have a conversation where the last two messages are outgoing pictures ; 2 . I archived it ; 3 . When I go to the archived conversations , the label `` archived '' covers a small part of the picture 's preview .
diff -- git a/res/layout/message_details_footer.xml b/res/layout/message_details_footer.xml new file mode 100644 index 0000000..19099bc -- - /dev/null +++ b/res/layout/message_details_footer.xml @ @ -0,0 +1,30 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + + < LinearLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' + xmlns : tools= '' http : //schemas.android.com/tools '' + android : layout_width= '' match_parent '' + android : layout_height= '' wrap_content '' + android : gravity= '' right '' + android : orientation= '' horizontal '' + android : paddingTop= '' 5dp '' + android : paddingLeft= '' 10dp '' + android : paddingRight= '' 10dp '' + android : paddingBottom= '' 10dp '' + android : clipToPadding= '' false '' > + + < Button android : id= '' @ +id/resend_all_button '' + android : layout_width= '' wrap_content '' + android : layout_height= '' 38sp '' + style= '' @ style/InfoButton '' + android : paddingLeft= '' 10dp '' + android : paddingRight= '' 10dp '' + android : paddingTop= '' 5dp '' + android : paddingBottom= '' 5dp '' + android : drawablePadding= '' 2dp '' + android : layout_gravity= '' center_vertical '' + android : drawableLeft= '' @ Ca n't resend message despite being notified the message could n't be delivered __EoT__ I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description SOmetimes after sending a group message I get messages undelivered , even though they do n't show the resend capability . Not really sure if it 's a sending error or just lack of processing received messages . # # # Steps to reproduce -Send message to group . **Actual result : ** Message says is was n't delivered , but I ca n't resend message **Expected result : ** can resend undelivered message . # # # Screenshots ! [ 20170904_170504 ] ( https : //user-images.githubusercontent.com/4967949/30039886-66495636-9194-11e7-9c53-a66b9cff81a5.png ) # # # Device info **Device : ** Samsung galaxy s8 stock rom **Android version : ** 7.0 **Signal version : ** 4.9.9 # # # Link to debug log https : //gist.github.com/537972abcf37d7ed356eeaa41cbd65f0
diff -- git a/res/layout/conversation_item_sent.xml b/res/layout/conversation_item_sent.xml index 5462104..9aa61cc 100644 -- - a/res/layout/conversation_item_sent.xml +++ b/res/layout/conversation_item_sent.xml @ @ -145,33 +145,11 @ @ android : paddingBottom= '' 2dp '' tools : text= '' 30 mins '' / > - < FrameLayout android : id= '' @ +id/pending_indicator_stub '' - android : layout_width= '' wrap_content '' - android : layout_height= '' wrap_content '' / > - - < ImageView android : id= '' @ +id/sent_indicator '' - android : layout_width= '' wrap_content '' - android : layout_height= '' wrap_content '' - android : layout_gravity= '' center_vertical|end '' - android : src= '' @ drawable/ic_done_white_18dp '' - android : paddingLeft= '' 2dp '' - android : paddingBottom= '' 2dp '' - android : visibility= '' gone '' - android : tint= '' ? conversation_item_sent_text_secondary_color '' - android : tintMode= '' multiply '' - android : contentDescription= '' @ string/conversation_item_sent__delivered_description '' / > - - < ImageView android : id= '' @ +id/delivered_indicator '' - android : layout_width= '' wrap_content '' - android : layout_height= '' wrap_content '' - android : layout_gravity= '' center_vertical|end '' - android : src= '' @ drawable/ic_done_all_white_18dp '' - android : paddingLeft= '' 2dp '' - android : paddingBottom= '' 2dp '' better highlight conversations with failed messages __EoT__ When sending a message fails , the current behaviour is that you get a notification about the failure . I think it would be better to also display something like a red triangle in the conversations list , mostly because : -you may swipe the notification without taking care of resending the message right away -several messages may fail to send if you temporarily lose your connection , and clicking every notification seems cumbersome to me -it would just make sense for the sake of clarity And maybe move the failed messages to the top of the conversations list ( ? ) Thank you
diff -- git a/res/values/dimens.xml b/res/values/dimens.xml index b05db94..d333d0e 100644 -- - a/res/values/dimens.xml +++ b/res/values/dimens.xml @ @ -3,6 +3,7 @ @ < dimen name= '' emoji_drawer_size '' > 32sp < /dimen > < dimen name= '' min_keyboard_size '' > 50dp < /dimen > < dimen name= '' min_emoji_drawer_height '' > 200dp < /dimen > + < dimen name= '' min_emoji_drawer_top_margin '' > 170dp < /dimen > < dimen name= '' emoji_drawer_item_padding '' > 5dp < /dimen > < dimen name= '' emoji_drawer_indicator_height '' > 1.5dp < /dimen > < dimen name= '' emoji_drawer_left_right_padding '' > 5dp < /dimen > diff -- git a/src/org/thoughtcrime/securesms/ConversationActivity.java b/src/org/thoughtcrime/securesms/ConversationActivity.java index e585fa1..1b4a2c6 100644 -- - a/src/org/thoughtcrime/securesms/ConversationActivity.java +++ b/src/org/thoughtcrime/securesms/ConversationActivity.java @ @ -23,6 +23,7 @ @ import android.content.Context ; import android.content.DialogInterface ; import android.content.Intent ; import android.content.IntentFilter ; +import android.content.res.Configuration ; import android.content.res.TypedArray ; import android.graphics.Color ; import android.graphics.PorterDuff ; @ @ -113,6 +114,7 @ @ import org.thoughtcrime.securesms.util.DirectoryHelper ; import org.thoughtcrime.securesms.util.DynamicLanguage ; import org.thoughtcrime.securesms.util.DynamicTheme ; import org.thoughtcrime.securesms.util.GroupUtil ; +import org.thoughtcrime.securesms.util.ServiceUtil ; import org.thoughtcrime.securesms.util.TextSecurePreferences ; import org.thoughtcrime.securesms.util.Util ; import org.thoughtcrime.securesms.util.concurrent.ListenableFuture ; @ @ -268,12 +270,18 @ @ public class ConversationActivity extends PassphraseRequiredActionBarActivity quickAttachmentDrawer.onConfigurationChanged ( ) ; } + @ Override public void onConfigurationChanged ( Configuration newConfig ) { + super.onConfigurationChanged ( emoji keyboard consumes all space on rotate from portrait to landscape __EoT__ tested on 4c89b242be51afee7e28861912c9e0a2b7e62ebd on my N5 1 ) have device in portrait 2 ) open a conversation 3 ) click on the message composition edit text 4 ) open the emoji keyboard 5 ) rotate device to landscape 6 ) emoji errewhere ! [ emoji ! ] ( http : //i.imgur.com/zLAAufs.png )
diff -- git a/res/values/strings.xml b/res/values/strings.xml index 2cff514..5bc3801 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -754,6 +754,7 @ @ < ! -- SearchToolbar -- > < string name= '' SearchToolbar_search '' > Search < /string > + < string name= '' SearchToolbar_search_icon_tooltip '' > Search for conversations , contacts , and messages < /string > < ! -- SingleRecipientNotificationBuilder -- > < string name= '' SingleRecipientNotificationBuilder_signal '' > Signal < /string > diff -- git a/src/org/thoughtcrime/securesms/ConversationListActivity.java b/src/org/thoughtcrime/securesms/ConversationListActivity.java index 991c573..4685009 100644 -- - a/src/org/thoughtcrime/securesms/ConversationListActivity.java +++ b/src/org/thoughtcrime/securesms/ConversationListActivity.java @ @ -25,6 +25,7 @ @ import android.net.Uri ; import android.os.AsyncTask ; import android.os.Bundle ; import android.support.v7.widget.Toolbar ; +import android.support.v7.widget.TooltipCompat ; import android.text.TextUtils ; import android.util.Log ; import android.view.Menu ; @ @ -89,6 +90,8 @ @ public class ConversationListActivity extends PassphraseRequiredActionBarActivit RatingManager.showRatingDialogIfNecessary ( this ) ; RegistrationLockDialog.showReminderIfNecessary ( this ) ; + + TooltipCompat.setTooltipText ( searchAction , getText ( R.string.SearchToolbar_search_icon_tooltip ) ) ; } @ Override Long-pressing the search icon does n't display icon description __EoT__ < ! -- This is a bug report template . By following the instructions below and filling out the sections with your information , you will help the developers get all the necessary data to fix your issue . You can also preview your report before submitting it . You may remove sections that are n't relevant to your particular case . Before we begin , please note that this tracker is only for issues . It is not for questions , comments , or feature requests . If you would like to discuss a new feature or submit suggestions , please visit the community forum : https : //community.signalusers.org If you are looking for support , please visit our support center : https : //support.signal.org/ or email support @ signal.org Let 's begin with a checklist : Replace the empty checkboxes [ ] below with checked ones [ x ] accordingly . -- > - [ x ] I have searched open and closed issues for duplicates - [ x ] I am submitting a bug report for existing functionality that does not work as intended - [ x
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 35629e8..4a93ea6 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -91,6 +91,7 @ @ < application android : name= '' .ApplicationContext '' android : icon= '' @ drawable/icon '' + android : roundIcon= '' @ drawable/icon_circle '' android : label= '' @ string/app_name '' android : supportsRtl= '' true '' tools : replace= '' android : allowBackup '' diff -- git a/artwork/logo-512.png b/artwork/logo-512.png index 9ff2982..282f477 100644 Binary files a/artwork/logo-512.png and b/artwork/logo-512.png differ diff -- git a/res/drawable-hdpi-v11/icon_notification.png b/res/drawable-hdpi-v11/icon_notification.png index aa31bf5..025ce4d 100644 Binary files a/res/drawable-hdpi-v11/icon_notification.png and b/res/drawable-hdpi-v11/icon_notification.png differ diff -- git a/res/drawable-hdpi-v9/icon_notification.png b/res/drawable-hdpi-v9/icon_notification.png index ffa5235..f0f52a2 100644 Binary files a/res/drawable-hdpi-v9/icon_notification.png and b/res/drawable-hdpi-v9/icon_notification.png differ diff -- git a/res/drawable-hdpi/actionbar_icon_holo_dark.png b/res/drawable-hdpi/actionbar_icon_holo_dark.png index c2efbf0..a75443f 100644 Binary files a/res/drawable-hdpi/actionbar_icon_holo_dark.png and b/res/drawable-hdpi/actionbar_icon_holo_dark.png differ diff -- git a/res/drawable-hdpi/actionbar_icon_holo_light.png b/res/drawable-hdpi/actionbar_icon_holo_light.png new file mode 100644 index 0000000..4977ce2 Binary files /dev/null and b/res/drawable-hdpi/actionbar_icon_holo_light.png differ diff -- git a/res/drawable-hdpi/ic_signal_grey_24dp.png b/res/drawable-hdpi/ic_signal_grey_24dp.png index e01390d..0389fad 100644 Binary files a/res/drawable-hdpi/ic_signal_grey_24dp.png and b/res/drawable-hdpi/ic_signal_grey_24dp.png differ diff -- git a/res/drawable-hdpi/ic_signal_white_48dp.png b/res/drawable-hdpi/ic_signal_white_48dp.png index 28ede6b..d418114 100644 Binary files a/res/drawable-hdpi/ic_signal_white_48dp.png and b/res/drawable-hdpi/ic_signal_white_48dp.png differ diff -- git a/res/drawable-hdpi/icon.png b/res/drawable-hdpi/icon.png index aba1dee..21b81b7 100644 Binary files a/res/drawable-hdpi/icon.png and b/res/drawable-hdpi/icon.png differ diff -- git a/res/drawable-hdpi/icon_circle.png b/res/drawable-hdpi/icon_circle.png new file mode 100644 index 0000000..a467775 Binary files /dev/null and b/res/drawable-hdpi/icon_circle.png differ diff -- git a/res/drawable-hdpi/icon_dialog.png b/res/drawable-hdpi/icon_dialog.png Adaptive icons do not work . __EoT__ Tested on a Pixel XL with Android 8.1 https : //github.com/signalapp/Signal-Android/issues/6511 should be reopened .
diff -- git a/res/layout/verify_identity_activity.xml b/res/layout/verify_identity_activity.xml index 1c20f7e..b81516e 100644 -- - a/res/layout/verify_identity_activity.xml +++ b/res/layout/verify_identity_activity.xml @ @ -18,6 +18,13 @ @ android : padding= '' 7dip '' / > < TextView + android : layout_width= '' fill_parent '' + android : layout_height= '' wrap_content '' + android : textAppearance= '' ? android : attr/textAppearanceLarge '' + android : paddingLeft= '' 7dip '' + android : id= '' @ +id/friend_verified '' / > + + < TextView android : layout_width= '' fill_parent '' android : layout_height= '' wrap_content '' android : textAppearance= '' ? android : attr/textAppearanceLarge '' diff -- git a/res/layout/view_identity_activity.xml b/res/layout/view_identity_activity.xml index 1bc52c3..b1f3dbc 100644 -- - a/res/layout/view_identity_activity.xml +++ b/res/layout/view_identity_activity.xml @ @ -19,5 +19,12 @ @ android : text= '' '' android : padding= '' 7dip '' / > + < TextView + android : layout_width= '' fill_parent '' + android : layout_height= '' wrap_content '' + android : textAppearance= '' ? android : attr/textAppearanceLarge '' + android : padding= '' 7dip '' + android : id= '' @ +id/identity_verified '' / > + < /LinearLayout > < /ScrollView > diff -- git a/res/menu/key_scanning.xml b/res/menu/key_scanning.xml index 7c36bc3..7a08e7c 100644 -- - a/res/menu/key_scanning.xml +++ b/res/menu/key_scanning.xml @ @ -13,6 +13,8 @ @ < item android Add trust level indicator to conversation screen __EoT__ In # 766 @ lindworm suggested adding display of trust level with the other party to the conversation screen . This requires a separate issue from the aforementioned ticket . There were different suggestions as to how this should be done . - @ lindworm suggested coloring the lock icon in the top bar ( green = manually verified , black/yellow = unverified/automatic key exchange/ , red = unencrypted ) . - I suggested overlaying the other party 's avatar with an icon instead . Icon indicates they 're a manually verified contact . No icons means they 're not . Specifically I also suggested not mixing the information of whether a conversation is encrypted or not with the information of how well the other party is trusted , into one icon . Least not by color . There are color vision impaired users and this information , if displayed at all , needs to be unambiguous .
diff -- git a/src/org/thoughtcrime/securesms/ConversationActivity.java b/src/org/thoughtcrime/securesms/ConversationActivity.java index 1504e88..2cfaee4 100644 -- - a/src/org/thoughtcrime/securesms/ConversationActivity.java +++ b/src/org/thoughtcrime/securesms/ConversationActivity.java @ @ -33,6 +33,7 @ @ import android.os.AsyncTask ; import android.os.Build ; import android.os.Bundle ; import android.os.Vibrator ; +import android.provider.Browser ; import android.provider.ContactsContract ; import android.support.annotation.NonNull ; import android.support.v4.view.WindowCompat ; @ @ -369,6 +370,15 @ @ public class ConversationActivity extends PassphraseRequiredActionBarActivity } @ Override + public void startActivity ( Intent intent ) { + if ( intent.getStringExtra ( Browser.EXTRA_APPLICATION_ID ) ! = null ) { + Log.d ( TAG , `` Starting the Browser without replacing current tab . `` ) ; + intent.removeExtra ( Browser.EXTRA_APPLICATION_ID ) ; + } + super.startActivity ( intent ) ; + } + + @ Override public boolean onPrepareOptionsMenu ( Menu menu ) { MenuInflater inflater = this.getMenuInflater ( ) ; menu.clear ( ) ; Links wo n't open in new tabs __EoT__ Since version 3.7.2 , it is impossible to open multiple links from a conversation in separate browser tabs , as every link will be opened in the same tab and so , overwrite the previously opened link . I am using Firefox for Android . It does not seem to be a Firefox bug , as with other apps the browser behaves as expected ( it is opening a new tab for every link )
diff -- git a/res/layout/load_more_header.xml b/res/layout/load_more_header.xml new file mode 100644 index 0000000..99cae04 -- - /dev/null +++ b/res/layout/load_more_header.xml @ @ -0,0 +1,9 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < Button xmlns : android= '' http : //schemas.android.com/apk/res/android '' + android : layout_width= '' match_parent '' + android : layout_height= '' wrap_content '' + android : layout_gravity= '' center '' + android : background= '' ? conversation_item_bubble_background '' + android : textColor= '' ? conversation_item_sent_text_primary_color '' + android : text= '' @ string/load_more_header__load_full_conversation '' / > + diff -- git a/res/values/strings.xml b/res/values/strings.xml index c1beed9..709931f 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -640,6 +640,9 @ @ < string name= '' import_fragment__import_a_plaintext_backup_file '' > Import a plaintext backup file . Compatible with \'SMSBackup And Restore.\ ' < /string > + < ! -- load_more_header -- > + < string name= '' load_more_header__load_full_conversation '' > Load full conversation ... < /string > + < ! -- media_overview_activity -- > < string name= '' media_overview_activity__no_images '' > No images < /string > diff -- git a/src/org/thoughtcrime/securesms/ConversationAdapter.java b/src/org/thoughtcrime/securesms/ConversationAdapter.java index 730c149..94d3103 100644 -- - a/src/org/thoughtcrime/securesms/ConversationAdapter.java +++ b/src/org/thoughtcrime/securesms/ConversationAdapter.java @ @ -113,7 +113,7 @ @ public class ConversationAdapter < Sending mssages to this specific contact almost always crashes textsecure __EoT__ I have a conversation with this friend of mine that recently has been causing a lot of problems . ( This happened on 2.24 too , so it should n't be 2.25-related ) So basically : 1 . I type a message 2 . Hit send 3 . Wait ... 4 . Sometimes the message bubble appears , sometimes it crashes before it does 5 . I reopen ts , unlock it , go to the conversation and the message bubble is there . The message is also correctly marked as send and delivered debug log : https : //gist.github.com/a3061a1f4b7edfcfdcab
diff -- git a/res/values-ru/strings.xml b/res/values-ru/strings.xml new file mode 100644 index 0000000..a0f3efb -- - /dev/null +++ b/res/values-ru/strings.xml @ @ -0,0 +1,6 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < resources > + < string name= '' app_name '' > TextSecure < /string > + < string name= '' yes '' > Да < /string > + < string name= '' no '' > Нет < /string > + < /resources > Signal crashes during loading after update 3.29.6 __EoT__ < ! -- This is a bug report template . By following the instructions below and filling out the sections with your information , you will help the developers to get all the necessary data to fix your issue . You can also preview your report before submitting it . You may remove sections that are n't relevant to your particular case . Before we begin , please note that this tracker is only for issues , not questions or comments . If you are looking for support , please see our support center instead : https : //support.whispersystems.org/ or email support @ whispersystems.org Let 's begin with a checklist : replace the empty checkboxes [ ] below with checked ones [ x ] accordingly -- > I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description Signal 3.29.6 3.30.1-4 3.31.4 closes after starting on Asus_T00Q ( x86 ) ( Could n't load **jingle_peerconnection_so** error
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 85e316e..ddaf212 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -226,6 +226,14 @ @ < /intent-filter > < /activity > + < activity android : name= '' .RecipientPreferenceActivity '' + android : theme= '' @ style/TextSecure.LightNoActionBar '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + + < activity android : name= '' .BlockedContactsActivity '' + android : theme= '' @ style/TextSecure.LightTheme '' + android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + < activity android : name= '' com.soundcloud.android.crop.CropImageActivity '' / > < service android : enabled= '' true '' android : name= '' .service.ApplicationMigrationService '' / > diff -- git a/res/drawable-hdpi/ic_block_grey600_18dp.png b/res/drawable-hdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..02982bf Binary files /dev/null and b/res/drawable-hdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_block_white_18dp.png b/res/drawable-hdpi/ic_block_white_18dp.png new file mode 100644 index 0000000..71b0a08 Binary files /dev/null and b/res/drawable-hdpi/ic_block_white_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_grey600_18dp.png b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png new file mode 100644 index 0000000..6cf04dc Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_grey600_18dp.png differ diff -- git a/res/drawable-hdpi/ic_volume_off_white_18dp.png b/res/drawable-hdpi/ic_volume_off_white_18dp.png new file mode 100644 index 0000000..a227897 Binary files /dev/null and b/res/drawable-hdpi/ic_volume_off_white_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_grey600_18dp.png b/res/drawable-mdpi/ic_block_grey600_18dp.png new file mode 100644 index 0000000..ddf39b3 Binary files /dev/null and b/res/drawable-mdpi/ic_block_grey600_18dp.png differ diff -- git a/res/drawable-mdpi/ic_block_white_18dp.png b/res/drawable-mdpi/ic_block_white_18dp.png new file mode 100644 index Feature Request : Different notifications for groupmsg and PM __EoT__ I would like to set different notifications for group and direkt messages . When I get a direct message I like a rather intrusive notification while I do n't want group messages to play the same ringtone all the time ( example : threema ) . If you are bothered with the additional settings for this , please at least consider an option to only allow the first new message to spawn a notification and suppress the rest ( for 1h ? ) .
diff -- git a/src/org/thoughtcrime/securesms/service/MessageRetrievalService.java b/src/org/thoughtcrime/securesms/service/MessageRetrievalService.java index c7b0a6c..296d031 100644 -- - a/src/org/thoughtcrime/securesms/service/MessageRetrievalService.java +++ b/src/org/thoughtcrime/securesms/service/MessageRetrievalService.java @ @ -1,9 +1,14 @ @ package org.thoughtcrime.securesms.service ; import android.app.Service ; +import android.app.AlarmManager ; +import android.app.PendingIntent ; +import android.content.BroadcastReceiver ; import android.content.Context ; import android.content.Intent ; +import android.content.IntentFilter ; import android.os.IBinder ; +import android.os.SystemClock ; import android.support.annotation.Nullable ; import android.support.v4.app.NotificationCompat ; import android.util.Log ; @ @ -20,6 +25,7 @ @ import org.whispersystems.jobqueue.requirements.RequirementListener ; import org.whispersystems.libsignal.InvalidVersionException ; import org.whispersystems.signalservice.api.SignalServiceMessagePipe ; import org.whispersystems.signalservice.api.SignalServiceMessageReceiver ; +import org.whispersystems.signalservice.api.util.SignalThread ; import java.util.LinkedList ; import java.util.List ; @ @ -43,6 +49,7 @ @ public class MessageRetrievalService extends Service implements InjectableType , private NetworkRequirement networkRequirement ; private NetworkRequirementProvider networkRequirementProvider ; + private KeepAliveAlarmReceiver keepAliveAlarmReceiver = null ; @ Inject public SignalServiceMessageReceiver receiver ; @ @ -67,6 +74,7 @ @ public class MessageRetrievalService extends Service implements InjectableType , retrievalThread.start ( ) ; setForegroundIfNecessary ( ) ; + enableKeepAliveAlarmIfNecessary ( ) ; } public int onStartCommand ( Intent intent , int flags , int startId ) { @ @ -87,6 +95,11 @ @ public class MessageRetrievalService extends Service implements InjectableType , retrievalThread.stopThread ( ) ; } + if ( keepAliveAlarmReceiver ! = null ) { + keepAliveAlarmReceiver.stop ( ) ; + unregisterReceiver ( keepAliveAlarmReceiver ) Network connection seems to get stuck ( without Google services ) __EoT__ < ! -- This is a bug report template . By following the instructions below and filling out the sections with your information , you will help the developers to get all the necessary data to fix your issue . You can also preview your report before submitting it . You may remove sections that are n't relevant to your particular case . Before we begin , please note that this tracker is only for issues , not questions or comments . If you are looking for support , please see our support center instead : https : //support.whispersystems.org/ or email support @ whispersystems.org Let 's begin with a checklist : replace the empty checkboxes [ ] below with checked ones [ x ] accordingly -- > I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description First of all , I apologize if this is the same issue as #
diff -- git a/res/layout/conversation_activity.xml b/res/layout/conversation_activity.xml index 0057771..94600c8 100644 -- - a/res/layout/conversation_activity.xml +++ b/res/layout/conversation_activity.xml @ @ -88,7 +88,6 @ @ android : background= '' # 00ffffff '' android : padding= '' 12dp '' android : paddingRight= '' 0dp '' - android : hint= '' @ string/conversation_activity__type_message '' android : imeOptions= '' actionSend|flagNoEnterAction '' android : inputType= '' textShortMessage|textAutoCorrect|textCapSentences|textMultiLine '' android : maxLength= '' 1000 '' diff -- git a/res/values/strings.xml b/res/values/strings.xml index ad08d51..4285929 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -435,7 +435,11 @ @ < string name= '' contact_selection_recent_activity__no_recent_calls '' > No recent calls. < /string > < ! -- conversation_activity -- > - < string name= '' conversation_activity__type_message '' > < small > Send a message < /small > < /string > + < string name= '' conversation_activity__type_message_push '' > Send TextSecure message < /string > + < string name= '' conversation_activity__type_message_sms_secure '' > Send secure SMS < /string > + < string name= '' conversation_activity__type_message_sms_insecure '' > Send insecure SMS < /string > + < string name= '' conversation_activity__type_message_mms_secure '' > Send secure MMS < /string > + < string name= '' conversation_activity__type_message_mms_insecure '' > Send insecure MMS < /string > < string name= '' conversation_activity__send '' > Send improve 'send encrypted ' icon __EoT__ The icon for indicating to the user that the message is going to be sent encrypted is the paper plane with a green lock icon overlaid . The lock is rotated 90deg . Two issues : - Encrypted messages are colored blue , not green . The overlaid lock icon should be blue , if any color . - The icon is rotated 90deg . The lock has rounded corners and and the arch of the lock is much smaller . All other lock icons used throughout TS do not have rounded corners and have a larger arch to be better recognizable . Accordingly , the lock on the paper plane should be a scaled version of ` ic_menu_lock_ ... png ` at the resp . size and same orientation .
diff -- git a/res/drawable/conversation_item_received_shape.xml b/res/drawable/conversation_item_received_shape.xml deleted file mode 100644 index 6a9a81d..0000000 -- - a/res/drawable/conversation_item_received_shape.xml +++ /dev/null @ @ -1,19 +0,0 @ @ - < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > - < layer-list xmlns : android= '' http : //schemas.android.com/apk/res/android '' > - - < item > - < shape android : shape= '' rectangle '' > - < solid android : color= '' @ color/conversation_item_received_shadow_light '' / > - < corners android : radius= '' @ dimen/conversation_item_corner_radius '' / > - < /shape > - < /item > - - < item android : bottom= '' @ dimen/conversation_item_drop_shadow_dist '' > - < shape xmlns : android= '' http : //schemas.android.com/apk/res/android '' > - < solid android : color= '' @ color/conversation_item_received_background_light '' / > - < ! -- stroke android : width= '' 0.5dp '' android : color= '' # 03000000 '' / -- > - < corners android : radius= '' @ dimen/conversation_item_corner_radius '' / > - < /shape > - < /item > - - < /layer-list > \ No newline at end of file diff -- git a/res/drawable/conversation_item_received_shape_dark.xml b/res/drawable/conversation_item_received_shape_dark.xml deleted file mode 100644 index 4b77765..0000000 -- - a/res/drawable/conversation_item_received_shape_dark.xml +++ /dev/null Attachments are flickering when sending a message __EoT__ Attachments thumbnails ( picture , video and audio ) in the ConversationActivity are flickering ~4 times if you send a new textmessage ( or another attachment ) after # 2430 I guess you are already aware of that , but I thought I open this for completeness ...
diff -- git a/src/org/thoughtcrime/securesms/ConversationActivity.java b/src/org/thoughtcrime/securesms/ConversationActivity.java index 58a6883..8c09fc3 100644 -- - a/src/org/thoughtcrime/securesms/ConversationActivity.java +++ b/src/org/thoughtcrime/securesms/ConversationActivity.java @ @ -163,6 +163,7 @ @ public class ConversationActivity extends PassphraseRequiredActionBarActivity private static final int PICK_CONTACT_INFO = 4 ; private static final int GROUP_EDIT = 5 ; private static final int TAKE_PHOTO = 6 ; + private static final int ADD_CONTACT = 7 ; private MasterSecret masterSecret ; protected ComposeText composeText ; @ @ -337,6 +338,11 @ @ public class ConversationActivity extends PassphraseRequiredActionBarActivity setMedia ( attachmentManager.getCaptureUri ( ) , MediaType.IMAGE , true ) ; } break ; + case ADD_CONTACT : + recipients = RecipientFactory.getRecipientsForIds ( ConversationActivity.this , recipients.getIds ( ) , true ) ; + recipients.addListener ( this ) ; + fragment.reloadList ( ) ; + break ; } } @ @ -673,7 +679,7 @ @ public class ConversationActivity extends PassphraseRequiredActionBarActivity final Intent intent = new Intent ( Intent.ACTION_INSERT_OR_EDIT ) ; intent.putExtra ( ContactsContract.Intents.Insert.PHONE , recipients.getPrimaryRecipient ( ) .getNumber ( ) ) ; intent.setType ( ContactsContract.Contacts.CONTENT_ITEM_TYPE ) ; - startActivity ( intent ) ; + startActivityForResult ( intent , ADD_CONTACT ) ; } private void handleAddAttachment ( ) { diff -- git a/src/org/thoughtcrime/securesms/ConversationFragment.java b/src/org/thoughtcrime/securesms/ConversationFragment.java index b9de105..b4483d0 100644 -- - a/src/org/thoughtcrime/securesms/ConversationFragment.java +++ b/src/org/thoughtcrime/securesms/ConversationFragment.java @ @ -127,6 +127,10 contact name does n't update after adding contact __EoT__ it requires that you manually exit the conversion and reenter
diff -- git a/src/org/thoughtcrime/securesms/ConversationActivity.java b/src/org/thoughtcrime/securesms/ConversationActivity.java index 7fdde5e..ed51b13 100644 -- - a/src/org/thoughtcrime/securesms/ConversationActivity.java +++ b/src/org/thoughtcrime/securesms/ConversationActivity.java @ @ -35,20 +35,15 @ @ import android.os.Build ; import android.os.Bundle ; import android.provider.ContactsContract ; import android.support.annotation.NonNull ; +import android.support.v4.view.GestureDetectorCompat ; import android.support.v4.view.WindowCompat ; import android.text.Editable ; -import android.text.InputType ; import android.text.TextWatcher ; import android.util.Log ; -import android.view.KeyEvent ; -import android.view.Menu ; -import android.view.MenuInflater ; -import android.view.MenuItem ; -import android.view.View ; +import android.view . * ; import android.view.View.OnClickListener ; import android.view.View.OnFocusChangeListener ; import android.view.View.OnKeyListener ; -import android.view.ViewStub ; import android.view.inputmethod.EditorInfo ; import android.view.inputmethod.InputMethodManager ; import android.widget.Button ; @ @ -146,20 +141,23 @ @ public class ConversationActivity extends PassphraseRequiredActionBarActivity { private static final String TAG = ConversationActivity.class.getSimpleName ( ) ; - public static final String RECIPIENTS_EXTRA = `` recipients '' ; - public static final String THREAD_ID_EXTRA = `` thread_id '' ; - public static final String DRAFT_TEXT_EXTRA = `` draft_text '' ; - public static final String DRAFT_IMAGE_EXTRA = `` draft_image '' ; - public static final String DRAFT_AUDIO_EXTRA = `` draft_audio '' ; - public static final String DRAFT_VIDEO_EXTRA = `` draft_video '' ; - public static final String DISTRIBUTION_TYPE_EXTRA = `` distribution_type '' ; - - private static final int PICK_IMAGE = 1 ; - Avatar in conversation view should be tappable __EoT__ I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description I want to tap the conversation header to open the new conversation settings screen which also shows the enlarged avatar . I can tap the contact / group name , but not the avatar itself , which is unexpected . # # # Steps to reproduce - open a conversation - tap the avatar in the conversation header **Actual result : ** Nothings happens . **Expected result : ** Should open the conversation settings screen . Also note that in the old conversation screen one could tap the avatar on the left of each message bubble ( which has been removed ) to see that users full contacts info to e.g . start a normal ( non-Signal ) phone call . This quick access option is not available anymore anywhere . # # # Device info **Android version : ** 5.1.1 & AVD 7.1.1 **Signal
diff -- git a/src/org/thoughtcrime/securesms/components/emoji/EmojiEditText.java b/src/org/thoughtcrime/securesms/components/emoji/EmojiEditText.java index e9f032b..fed5c32 100644 -- - a/src/org/thoughtcrime/securesms/components/emoji/EmojiEditText.java +++ b/src/org/thoughtcrime/securesms/components/emoji/EmojiEditText.java @ @ -26,7 +26,7 @ @ public class EmojiEditText extends AppCompatEditText { public EmojiEditText ( Context context , AttributeSet attrs , int defStyleAttr ) { super ( context , attrs , defStyleAttr ) ; if ( ! TextSecurePreferences.isSystemEmojiPreferred ( getContext ( ) ) ) { - setFilters ( new InputFilter [ ] { new EmojiFilter ( this ) } ) ; + setFilters ( appendEmojiFilter ( this.getFilters ( ) ) ) ; } } @ @ -42,4 +42,14 @ @ public class EmojiEditText extends AppCompatEditText { if ( drawable instanceof EmojiDrawable ) invalidate ( ) ; else super.invalidateDrawable ( drawable ) ; } + + private InputFilter [ ] appendEmojiFilter ( InputFilter [ ] originalFilters ) { + int originalLength = originalFilters.length ; + final InputFilter [ ] result = new InputFilter [ originalLength+1 ] ; + + result [ 0 ] = new EmojiFilter ( this ) ; + System.arraycopy ( originalFilters,0 , result,1 , originalLength ) ; + + return result ; + } } This one weird trick , the devs do n't want you to know , crashes recipients ' TS __EoT__ ( Could n't resist with the title : ( · ) There seems to be no size checking on group name . 1 . Update a group 's name with _A Modest Proposal_ by _Jonathan Swift_ ( Try the _Plain Text UTF-8_ option from [ Project Gutenberg ] ( https : //www.gutenberg.org/ebooks/1080 ) . Direct links do n't work . ) 2 . After tapping the checkmark to broadcast the update **the other group members ' TS will crash** If you strip the Gutenberg metadata ( introduction , license etc . ) and just paste the actual text it wo n't crash . So the sweet spot is somewhere between 20-40KB . In any case it 's still a big wall of text that should n't be . ! [ a modest proposal-jonathan swift ] ( https : //cloud.githubusercontent.com/assets/174176/8141636/b5a2ce1e-1172-11e5-8f6a-1e2e6ae356c1.png ) - TS 2.17.0 - Nexus 4 , stock Android 5.1.1 - Huawei U8800 , Android 4.0.4 Debug log : https : //gist.github.com/152ae1566c6c3d245ab0 `` ` E/AndroidRuntime ( 4560 ) : FATAL EXCEPTION : Thread-530 E/AndroidRuntime ( 4560 ) : Process : org.thoughtcrime.securesms
diff -- git a/src/org/thoughtcrime/securesms/jobs/SmsSendJob.java b/src/org/thoughtcrime/securesms/jobs/SmsSendJob.java index 06e21ee..d9b9ba8 100644 -- - a/src/org/thoughtcrime/securesms/jobs/SmsSendJob.java +++ b/src/org/thoughtcrime/securesms/jobs/SmsSendJob.java @ @ -4,6 +4,7 @ @ import android.app.PendingIntent ; import android.content.Context ; import android.content.Intent ; import android.net.Uri ; +import android.telephony.PhoneNumberUtils ; import android.telephony.SmsManager ; import android.util.Log ; @ @ -91,6 +92,10 @ @ public class SmsSendJob extends SendJob { ArrayList < PendingIntent > deliveredIntents = constructDeliveredIntents ( message.getId ( ) , message.getType ( ) , messages ) ; String recipient = message.getIndividualRecipient ( ) .getNumber ( ) ; + // Remove all the separators from the phone number , since some ( e.g . no-break space ) can + // cause NPEs in SmsManager 's sendTextMessage ( ) function . + recipient = PhoneNumberUtils.stripSeparators ( recipient ) ; + // NOTE 11/04/14 -- There 's apparently a bug where for some unknown recipients // and messages , this will throw an NPE . We have no idea why , so we 're just // catching it and marking the message as a failure . That way at least it does n't Can ’ t send SMS to phone numbers with brackets after upgrade to 3.3+ __EoT__ Messages ( SMS , not MMS , not data ) appear to be sent successfully in the UI but are never received by the contact after upgrading to any version later than 3.1.1 . Messages from other contacts are still received , only sending is broken . Manually downgrading to 3.1.1 apk restores SMS sending functionality . Other SMS apps continue to work . Latest 3.6.1 release from Play Store is still broken . Disabling Signal messages in Advanced prefs does not fix the problem . Uninstalling and reinstalling does not fix the problem . Device info : Samsung Galaxy S5 Dev Ed , stock Android 4.4.4 , Signal 3.6.1 App state : Push registered , SMS Enabled , SMS deliver disabled , Wi-Fi Calling compatibility disabled ( phone is not Wi-Fi Calling enabled ) , MMS Default settings , Media auto-download disabled Log , starting Signal & sending SMS : https : //gist.github.com/csnover/dd39624d381160536798 This may be related to the shortcode sending problem reported around the same time but I am _not_ sending to shortcode contacts , these are full 10-digit ( US ) numbers
diff -- git a/res/color/text_color_dark_theme.xml b/res/color/text_color_dark_theme.xml new file mode 100644 index 0000000..4f5d366 -- - /dev/null +++ b/res/color/text_color_dark_theme.xml @ @ -0,0 +1,5 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < selector xmlns : android= '' http : //schemas.android.com/apk/res/android '' > + < item android : state_enabled= '' false '' android : color= '' # ff808080 '' / > + < item android : color= '' @ color/gray5 '' / > + < /selector > \ No newline at end of file diff -- git a/res/color/text_color_light_theme.xml b/res/color/text_color_light_theme.xml new file mode 100644 index 0000000..3304b74 -- - /dev/null +++ b/res/color/text_color_light_theme.xml @ @ -0,0 +1,5 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < selector xmlns : android= '' http : //schemas.android.com/apk/res/android '' > + < item android : state_enabled= '' false '' android : color= '' # ffbbbbbb '' / > + < item android : color= '' @ color/gray95 '' / > + < /selector > \ No newline at end of file diff -- git a/res/color/text_color_secondary_dark_theme.xml b/res/color/text_color_secondary_dark_theme.xml new file mode 100644 index 0000000..7c8704a -- - /dev/null +++ b/res/color/text_color_secondary_dark_theme.xml @ @ -0,0 +1,5 @ @ ActionBar Icons change to dark color in dark theme __EoT__ As reported in https : //github.com/WhisperSystems/TextSecure/pull/1635 # issuecomment-62222759 the back arrow and the triple dot menu button switch to dark on the dark theme , when returning from a new activity ( ? ) ! [ unbenannt ] ( https : //cloud.githubusercontent.com/assets/5326916/4961044/2a3eaa1c-66ca-11e4-8e40-6a4f95cc5590.png ) ! [ unbenannt ] ( https : //cloud.githubusercontent.com/assets/5326916/4961092/a516b5ae-66ca-11e4-94d7-bbbb78662c70.png ) This seem to happen only when you come back from an unthemed activity like - Configure MMS settings ( pops up , when you want to attach something on an non TS registered device without MMS settings ) - Change passphrase ( enable local encryption in settings ) but not if you press `` Skip '' in the TS registration activity opened from the green reminder ? ! To verify my assumption I added DynamicTheme to PassphraseChangeActivity which seemed to helped . ( I am aware that this activity is not fully themed yet . In fact I 'm working on applying dynamic themeing were it 's missing ... ) **EDIT** coming back from submit debug also recolors the icons and yes , latest HEAD : )
diff -- git a/res/color/text_color_dark_theme.xml b/res/color/text_color_dark_theme.xml new file mode 100644 index 0000000..4f5d366 -- - /dev/null +++ b/res/color/text_color_dark_theme.xml @ @ -0,0 +1,5 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < selector xmlns : android= '' http : //schemas.android.com/apk/res/android '' > + < item android : state_enabled= '' false '' android : color= '' # ff808080 '' / > + < item android : color= '' @ color/gray5 '' / > + < /selector > \ No newline at end of file diff -- git a/res/color/text_color_light_theme.xml b/res/color/text_color_light_theme.xml new file mode 100644 index 0000000..3304b74 -- - /dev/null +++ b/res/color/text_color_light_theme.xml @ @ -0,0 +1,5 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < selector xmlns : android= '' http : //schemas.android.com/apk/res/android '' > + < item android : state_enabled= '' false '' android : color= '' # ffbbbbbb '' / > + < item android : color= '' @ color/gray95 '' / > + < /selector > \ No newline at end of file diff -- git a/res/color/text_color_secondary_dark_theme.xml b/res/color/text_color_secondary_dark_theme.xml new file mode 100644 index 0000000..7c8704a -- - /dev/null +++ b/res/color/text_color_secondary_dark_theme.xml @ @ -0,0 +1,5 @ @ ActionBar Icons change to dark color in dark theme __EoT__ As reported in https : //github.com/WhisperSystems/TextSecure/pull/1635 # issuecomment-62222759 the back arrow and the triple dot menu button switch to dark on the dark theme , when returning from a new activity ( ? ) ! [ unbenannt ] ( https : //cloud.githubusercontent.com/assets/5326916/4961044/2a3eaa1c-66ca-11e4-8e40-6a4f95cc5590.png ) ! [ unbenannt ] ( https : //cloud.githubusercontent.com/assets/5326916/4961092/a516b5ae-66ca-11e4-94d7-bbbb78662c70.png ) This seem to happen only when you come back from an unthemed activity like - Configure MMS settings ( pops up , when you want to attach something on an non TS registered device without MMS settings ) - Change passphrase ( enable local encryption in settings ) but not if you press `` Skip '' in the TS registration activity opened from the green reminder ? ! To verify my assumption I added DynamicTheme to PassphraseChangeActivity which seemed to helped . ( I am aware that this activity is not fully themed yet . In fact I 'm working on applying dynamic themeing were it 's missing ... ) **EDIT** coming back from submit debug also recolors the icons and yes , latest HEAD : )
diff -- git a/res/color/text_color_dark_theme.xml b/res/color/text_color_dark_theme.xml new file mode 100644 index 0000000..4f5d366 -- - /dev/null +++ b/res/color/text_color_dark_theme.xml @ @ -0,0 +1,5 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < selector xmlns : android= '' http : //schemas.android.com/apk/res/android '' > + < item android : state_enabled= '' false '' android : color= '' # ff808080 '' / > + < item android : color= '' @ color/gray5 '' / > + < /selector > \ No newline at end of file diff -- git a/res/color/text_color_light_theme.xml b/res/color/text_color_light_theme.xml new file mode 100644 index 0000000..3304b74 -- - /dev/null +++ b/res/color/text_color_light_theme.xml @ @ -0,0 +1,5 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < selector xmlns : android= '' http : //schemas.android.com/apk/res/android '' > + < item android : state_enabled= '' false '' android : color= '' # ffbbbbbb '' / > + < item android : color= '' @ color/gray95 '' / > + < /selector > \ No newline at end of file diff -- git a/res/color/text_color_secondary_dark_theme.xml b/res/color/text_color_secondary_dark_theme.xml new file mode 100644 index 0000000..7c8704a -- - /dev/null +++ b/res/color/text_color_secondary_dark_theme.xml @ @ -0,0 +1,5 @ @ ActionBar Icons change to dark color in dark theme __EoT__ As reported in https : //github.com/WhisperSystems/TextSecure/pull/1635 # issuecomment-62222759 the back arrow and the triple dot menu button switch to dark on the dark theme , when returning from a new activity ( ? ) ! [ unbenannt ] ( https : //cloud.githubusercontent.com/assets/5326916/4961044/2a3eaa1c-66ca-11e4-8e40-6a4f95cc5590.png ) ! [ unbenannt ] ( https : //cloud.githubusercontent.com/assets/5326916/4961092/a516b5ae-66ca-11e4-94d7-bbbb78662c70.png ) This seem to happen only when you come back from an unthemed activity like - Configure MMS settings ( pops up , when you want to attach something on an non TS registered device without MMS settings ) - Change passphrase ( enable local encryption in settings ) but not if you press `` Skip '' in the TS registration activity opened from the green reminder ? ! To verify my assumption I added DynamicTheme to PassphraseChangeActivity which seemed to helped . ( I am aware that this activity is not fully themed yet . In fact I 'm working on applying dynamic themeing were it 's missing ... ) **EDIT** coming back from submit debug also recolors the icons and yes , latest HEAD : )
diff -- git a/res/color/text_color_dark_theme.xml b/res/color/text_color_dark_theme.xml new file mode 100644 index 0000000..95308fe -- - /dev/null +++ b/res/color/text_color_dark_theme.xml @ @ -0,0 +1,5 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < selector xmlns : android= '' http : //schemas.android.com/apk/res/android '' > + < item android : state_enabled= '' false '' android : color= '' @ color/gray50 '' / > + < item android : color= '' @ color/gray5 '' / > + < /selector > \ No newline at end of file diff -- git a/res/color/text_color_light_theme.xml b/res/color/text_color_light_theme.xml new file mode 100644 index 0000000..4bb2be8 -- - /dev/null +++ b/res/color/text_color_light_theme.xml @ @ -0,0 +1,5 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < selector xmlns : android= '' http : //schemas.android.com/apk/res/android '' > + < item android : state_enabled= '' false '' android : color= '' @ color/gray27 '' / > + < item android : color= '' @ color/gray95 '' / > + < /selector > \ No newline at end of file diff -- git a/res/color/text_color_secondary_dark_theme.xml b/res/color/text_color_secondary_dark_theme.xml new file mode 100644 index 0000000..5510b32 -- - /dev/null +++ b/res/color/text_color_secondary_dark_theme.xml @ @ -0,0 +1,5 @ @ ActionBar Icons change to dark color in dark theme __EoT__ As reported in https : //github.com/WhisperSystems/TextSecure/pull/1635 # issuecomment-62222759 the back arrow and the triple dot menu button switch to dark on the dark theme , when returning from a new activity ( ? ) ! [ unbenannt ] ( https : //cloud.githubusercontent.com/assets/5326916/4961044/2a3eaa1c-66ca-11e4-8e40-6a4f95cc5590.png ) ! [ unbenannt ] ( https : //cloud.githubusercontent.com/assets/5326916/4961092/a516b5ae-66ca-11e4-94d7-bbbb78662c70.png ) This seem to happen only when you come back from an unthemed activity like - Configure MMS settings ( pops up , when you want to attach something on an non TS registered device without MMS settings ) - Change passphrase ( enable local encryption in settings ) but not if you press `` Skip '' in the TS registration activity opened from the green reminder ? ! To verify my assumption I added DynamicTheme to PassphraseChangeActivity which seemed to helped . ( I am aware that this activity is not fully themed yet . In fact I 'm working on applying dynamic themeing were it 's missing ... ) **EDIT** coming back from submit debug also recolors the icons and yes , latest HEAD : )
diff -- git a/res/layout/conversation_activity.xml b/res/layout/conversation_activity.xml index 0057771..94600c8 100644 -- - a/res/layout/conversation_activity.xml +++ b/res/layout/conversation_activity.xml @ @ -88,7 +88,6 @ @ android : background= '' # 00ffffff '' android : padding= '' 12dp '' android : paddingRight= '' 0dp '' - android : hint= '' @ string/conversation_activity__type_message '' android : imeOptions= '' actionSend|flagNoEnterAction '' android : inputType= '' textShortMessage|textAutoCorrect|textCapSentences|textMultiLine '' android : maxLength= '' 1000 '' diff -- git a/res/values/strings.xml b/res/values/strings.xml index ad08d51..4285929 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -435,7 +435,11 @ @ < string name= '' contact_selection_recent_activity__no_recent_calls '' > No recent calls. < /string > < ! -- conversation_activity -- > - < string name= '' conversation_activity__type_message '' > < small > Send a message < /small > < /string > + < string name= '' conversation_activity__type_message_push '' > Send TextSecure message < /string > + < string name= '' conversation_activity__type_message_sms_secure '' > Send secure SMS < /string > + < string name= '' conversation_activity__type_message_sms_insecure '' > Send insecure SMS < /string > + < string name= '' conversation_activity__type_message_mms_secure '' > Send secure MMS < /string > + < string name= '' conversation_activity__type_message_mms_insecure '' > Send insecure MMS < /string > < string name= '' conversation_activity__send '' > Send Alternative model to visualize security in TS __EoT__ # # # I . Introduction Currently near consensus has been reached in these issues about implementing a visual security model in TS : # 910 , # 945 , # 766 and # 741 . In my oppinion this model has some problems which I 'd like discuss here and propose a different model . I created this issue because right now there is no chance to change the course of the discussion in the mentioned issues . So I chose to not interfere any further , let the participants improve their model and work on an alternative model separately . # # # II . Criticism of the proposed model This is the visual model as proposed in the aforementioned issues . # # # # # Contact list I had to make this up myself based on # 741 . And yes , this has been done with MS Paint : ! [ contact-list-with locks1 ] ( https : //f.cloud.github.com/assets/6848629/2428418/bb727eb2-ac46-11e3-9d88-e84acd5fbac4.png ) # # # # # Messaging window ! [ 4 ] ( https : //f.cloud.github.com/assets/6848629/2428409/7e1cc54a-ac46-11e3-9430-5338739b0c08.jpg ) ! [ 3 ] ( https : //f.cloud.github.com/assets/6848629/2428410/7e247664-ac46-11e3-8fe7-449465b7b6f5.jpg ) ! [ 2
diff -- git a/src/org/thoughtcrime/securesms/ConversationActivity.java b/src/org/thoughtcrime/securesms/ConversationActivity.java index df5f9f3..e75a0e3 100644 -- - a/src/org/thoughtcrime/securesms/ConversationActivity.java +++ b/src/org/thoughtcrime/securesms/ConversationActivity.java @ @ -179,12 +179,12 @ @ public class ConversationActivity extends PassphraseRequiredActionBarActivity initializeReceivers ( ) ; initializeResources ( ) ; + initializeDraft ( ) ; } @ Override protected void onStart ( ) { super.onStart ( ) ; - initializeDraft ( ) ; } @ Override Back button on conversation thread does not clear the stack __EoT__ After the most recent update , I noticed a change in behavior with the back button . Before , hitting the back button while in a conversation thread would always return me back to the message list view . Now , hitting back will often send me to other conversation threads , often times it will send me to the SAME conversation thread I just hit back on . I believe this happens when I view messages via the status bar notification . Example : I am talking to somebody in a conversation thread then hit home . The same person messages me again , and I select the message from the status bar to view it . Then I hit back - it will take me to the exact same conversation I was just on . Then I have to hit back again to get to the message list view . When talking to many people at once this gets quite annoying . The back button on a conversation should always return to the message list ! Thank you guys for the fantastic software .
diff -- git a/res/layout/contact_selection_list_fragment.xml b/res/layout/contact_selection_list_fragment.xml index a0c8e9f..f537b50 100644 -- - a/res/layout/contact_selection_list_fragment.xml +++ b/res/layout/contact_selection_list_fragment.xml @ @ -28,6 +28,7 @ @ android : id= '' @ +id/fast_scroller '' android : layout_width= '' wrap_content '' android : layout_height= '' match_parent '' + android : visibility= '' gone '' android : layout_gravity= '' right '' / > < /FrameLayout > diff -- git a/src/org/thoughtcrime/securesms/ContactSelectionListFragment.java b/src/org/thoughtcrime/securesms/ContactSelectionListFragment.java index 8991bb2..d89895e 100644 -- - a/src/org/thoughtcrime/securesms/ContactSelectionListFragment.java +++ b/src/org/thoughtcrime/securesms/ContactSelectionListFragment.java @ @ -101,7 +101,6 @ @ public class ContactSelectionListFragment extends Fragment swipeRefresh = ViewUtil.findById ( view , R.id.swipe_refresh ) ; fastScroller = ViewUtil.findById ( view , R.id.fast_scroller ) ; recyclerView.setLayoutManager ( new LinearLayoutManager ( getActivity ( ) ) ) ; - fastScroller.setRecyclerView ( recyclerView ) ; swipeRefresh.setEnabled ( getActivity ( ) .getIntent ( ) .getBooleanExtra ( REFRESHABLE , true ) & & Build.VERSION.SDK_INT > = Build.VERSION_CODES.JELLY_BEAN ) ; @ @ -163,11 +162,16 @ @ public class ContactSelectionListFragment extends Fragment public void onLoadFinished ( Loader < Cursor > loader , Cursor data ) { ( ( CursorRecyclerViewAdapter ) recyclerView.getAdapter ( ) ) .changeCursor ( data ) ; emptyText.setText ( R.string.contact_selection_group_activity__no_contacts ) ; + if ( recyclerView.getAdapter ( ) .getItemCount ( ) > 20 ) { + fastScroller.setVisibility ( View.VISIBLE ) ; + Crash in contact selection view __EoT__ Tapped on FAB in conversation list screen and signal crashed . https : //gist.github.com/dddac80d2dd2670a2294
diff -- git a/res/drawable-hdpi/ic_menu_invite.png b/res/drawable-hdpi/ic_menu_invite.png new file mode 100644 index 0000000..ec88b99 Binary files /dev/null and b/res/drawable-hdpi/ic_menu_invite.png differ diff -- git a/res/drawable-mdpi/ic_menu_invite.png b/res/drawable-mdpi/ic_menu_invite.png new file mode 100644 index 0000000..aa1898d Binary files /dev/null and b/res/drawable-mdpi/ic_menu_invite.png differ diff -- git a/res/drawable-xhdpi/ic_menu_invite.png b/res/drawable-xhdpi/ic_menu_invite.png new file mode 100644 index 0000000..d594607 Binary files /dev/null and b/res/drawable-xhdpi/ic_menu_invite.png differ diff -- git a/res/drawable-xxhdpi/ic_menu_invite.png b/res/drawable-xxhdpi/ic_menu_invite.png new file mode 100644 index 0000000..8020fd8 Binary files /dev/null and b/res/drawable-xxhdpi/ic_menu_invite.png differ diff -- git a/res/menu/conversation.xml b/res/menu/conversation.xml index 90df2df..99a8d9e 100644 -- - a/res/menu/conversation.xml +++ b/res/menu/conversation.xml @ @ -5,12 +5,12 @ @ android : id= '' @ +id/menu_add_attachment '' android : icon= '' @ drawable/ic_menu_attach '' / > - < item android : title= '' @ string/conversation__menu_add_contact_info '' - android : id= '' @ +id/menu_add_contact_info '' - android : icon= '' @ drawable/ic_menu_friendslist '' / > - < item android : title= '' @ string/conversation__menu_delete_thread '' android : id= '' @ +id/menu_delete_thread '' android : icon= '' @ android : drawable/ic_menu_delete '' / > + < item android : title= '' @ string/conversation__menu_add_to_contacts '' + android : id= '' @ +id/menu_add_to_contacts '' + android : icon= '' @ drawable/ic_menu_invite '' / > + < /menu > diff -- git a/res/values/strings.xml b/res/values/strings.xml index a6b5ae7..1e44de4 100644 -- add + to blank avatar to clarify that you can add to contacts __EoT__ After setting up a couple of people with TextSecure , we were all stumped that TextSecure did not have a way to add a new phone number to a Contact . We tried everything we can think of and no luck . So I decided to file a bug report , and found # 822 then explored a bit more , and found that you can add an unknown number as a contact by clicking the blank avatar icon . This was not intuitive but I think it can be greatly improved by a simple fix : add a + to the blank avatar icon if clicking it will trigger the `` add to contacts '' sequence .
diff -- git a/res/values/strings.xml b/res/values/strings.xml index dc4e019..9e2f497 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -208,6 +208,7 @ @ < string name= '' DeviceListItem_unnamed_device '' > Unnamed device < /string > < string name= '' DeviceListItem_linked_s '' > Linked % s < /string > < string name= '' DeviceListItem_last_active_s '' > Last active % s < /string > + < string name= '' DeviceListItem_today '' > Today < /string > < ! -- ShareActivity -- > < string name= '' ShareActivity_share_with '' > Share with < /string > diff -- git a/src/org/thoughtcrime/securesms/util/DateUtils.java b/src/org/thoughtcrime/securesms/util/DateUtils.java index 830020d..8179bb0 100644 -- - a/src/org/thoughtcrime/securesms/util/DateUtils.java +++ b/src/org/thoughtcrime/securesms/util/DateUtils.java @ @ -87,7 +87,7 @ @ public class DateUtils extends android.text.format.DateUtils { SimpleDateFormat simpleDateFormat = new SimpleDateFormat ( `` yyyyMMdd '' ) ; if ( simpleDateFormat.format ( System.currentTimeMillis ( ) ) .equals ( simpleDateFormat.format ( timestamp ) ) ) { - return `` Today '' ; + return context.getString ( R.string.DeviceListItem_today ) ; } else { String format ; Dates have wrong locale in 'Manage linked devices ' __EoT__ 3.6.0 # # # System language : Korean , Signal language : Default ! [ screenshot_2015-11-28-17-21-20 ] ( https : //cloud.githubusercontent.com/assets/174176/11453026/c0f20e22-9603-11e5-8f29-79923478a03a.png ) -- - # # # System language : English ( US ) , Signal language : Korean ! [ screenshot_2015-11-28-17-22-35 ] ( https : //cloud.githubusercontent.com/assets/174176/11453027/c55f47c2-9603-11e5-809a-1667bcf504ab.png ) ( oh yeah , the title^ has some localization issues too ... it 's translated but does not change immediately after Signal language change )
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index a5f52bb..eef1814 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -158,6 +158,19 @ @ < activity android : name= '' .RegistrationProgressActivity '' android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' / > + < activity + android : name= '' .ConfigContactsActivity '' + android : configChanges= '' keyboardHidden|orientation|screenSize '' + android : label= '' @ string/preferences__contacts_title '' + android : launchMode= '' singleTop '' > + < /activity > + < activity + android : name= '' .ConfigNotificationActivity '' + android : configChanges= '' keyboardHidden|orientation|screenSize '' + android : label= '' @ string/preferences__contacts_title '' + android : launchMode= '' singleTop '' > + < /activity > + < service android : enabled= '' true '' android : name= '' .service.ApplicationMigrationService '' / > < service android : enabled= '' true '' android : name= '' .service.KeyCachingService '' / > @ @ -220,6 +233,8 @ @ < provider android : name= '' .providers.PartProvider '' android : authorities= '' org.thoughtcrime.provider.securesms '' / > + < provider android : name= '' .providers.NotificationProvider '' + android : authorities= '' org.thoughtcrime.notificationprovider.securesms '' / > < uses-library android : name= '' android.test.runner '' / > < /application > diff -- git a/res/layout/config_contacts_fragment.xml b/res/layout/config_contacts_fragment.xml Feature Request : Notification options per contact __EoT__ I know this is a bit above and beyond the typical SMS functionality , and I totally understand if this gets dropped to the bottom of the list , but I do find I often need to find out about some SMSs far more urgently than others -- in my case , I have a critical server that tells me when it 's down : I 'd like that one to scream loudly at me even if I 'm sleeping deeply . Some unknown number texting me about a dream vacation that I have won I am quite happy to sleep thru . : ) Awesome work regardless , team ! R
diff -- git a/proguard.cfg b/proguard.cfg index a280972..50377be 100644 -- - a/proguard.cfg +++ b/proguard.cfg @ @ -1,3 +1,5 @ @ +-dontoptimize +-keepattributes SourceFile , LineNumberTable -keep class org.whispersystems . ** { * ; } -keep class org.thoughtcrime.securesms . ** { * ; } Stack traces no longer contain line number information __EoT__ eg . `` ` java.lang.NullPointerException at java.lang.String. < init > ( String.java:141 ) at org.thoughtcrime.securesms.jobs.MmsDownloadJob.onRun ( Unknown Source ) at org.thoughtcrime.securesms.jobs.MasterSecretJob.onRun ( Unknown Source ) at org.whispersystems.jobqueue.JobConsumer.runJob ( Unknown Source ) at org.whispersystems.jobqueue.JobConsumer.run ( Unknown Source ) `` `
diff -- git a/res/drawable-hdpi/ic_priority_high_white_48dp.png b/res/drawable-hdpi/ic_priority_high_white_48dp.png new file mode 100644 index 0000000..66366c9 Binary files /dev/null and b/res/drawable-hdpi/ic_priority_high_white_48dp.png differ diff -- git a/res/drawable-mdpi/ic_priority_high_white_48dp.png b/res/drawable-mdpi/ic_priority_high_white_48dp.png new file mode 100644 index 0000000..a719158 Binary files /dev/null and b/res/drawable-mdpi/ic_priority_high_white_48dp.png differ diff -- git a/res/drawable-xhdpi/ic_priority_high_white_48dp.png b/res/drawable-xhdpi/ic_priority_high_white_48dp.png new file mode 100644 index 0000000..f1dc48c Binary files /dev/null and b/res/drawable-xhdpi/ic_priority_high_white_48dp.png differ diff -- git a/res/drawable-xxhdpi/ic_priority_high_white_48dp.png b/res/drawable-xxhdpi/ic_priority_high_white_48dp.png new file mode 100644 index 0000000..5ca2452 Binary files /dev/null and b/res/drawable-xxhdpi/ic_priority_high_white_48dp.png differ diff -- git a/res/drawable-xxxhdpi/ic_priority_high_white_48dp.png b/res/drawable-xxxhdpi/ic_priority_high_white_48dp.png new file mode 100644 index 0000000..121e049 Binary files /dev/null and b/res/drawable-xxxhdpi/ic_priority_high_white_48dp.png differ diff -- git a/res/layout/prompt_passphrase_activity.xml b/res/layout/prompt_passphrase_activity.xml index ca8b673..abe0c2f 100644 -- - a/res/layout/prompt_passphrase_activity.xml +++ b/res/layout/prompt_passphrase_activity.xml @ @ -24,14 +24,16 @ @ < android.support.v7.widget.Toolbar android : id= '' @ +id/toolbar '' + android : theme= '' ? attr/actionBarStyle '' android : layout_width= '' match_parent '' android : layout_height= '' ? attr/actionBarSize '' android : layout_marginTop= '' 20dp '' > < ImageView - android : layout_width= '' wrap_content '' - android : layout_height= '' wrap_content '' + android : layout_width= '' 36dp '' + android : layout_height= '' 36dp '' android : src= '' @ drawable/icon_transparent '' + android : layout_centerVertical= '' true '' android : layout_gravity= '' center '' / > < /android.support.v7.widget.Toolbar > @ @ -39,7 +41,7 The new password screen in incorrect __EoT__ - [ x ] I have searched open and closed issues for duplicates - [ x ] I am submitting a bug report for existing functionality that does not work as intended - [ x ] I have read https : //github.com/signalapp/Signal-Android/wiki/Submitting-useful-bug-reports - [ x ] This is n't a feature request or a discussion topic -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description I use a password to unlock Signal and I did n't change it since the default functinality was changed to use the standard Android unlock mechanism ( code , pattern or biometry ) . This still works but since 4.25.0 Signal seems to assume that `` unlock '' means `` fingerprint scanner '' . I do n't even have a fingerprint scanner on this device and if I had I would not use it for security reasons . # # # Screenshots ! [ signal_20180814-164233 ] ( https : //user-images.githubusercontent.com/8427572/44098973-15ef0414-9fd1-11e8-984c-291a31a7cc1c.jpg ) # # # Device info < ! -- replace the examples with your info -- > **Device : ** Sony Z3
diff -- git a/res/drawable-hdpi/ic_save_all_white_24dp.png b/res/drawable-hdpi/ic_save_all_white_24dp.png new file mode 100644 index 0000000..93dccdd Binary files /dev/null and b/res/drawable-hdpi/ic_save_all_white_24dp.png differ diff -- git a/res/drawable-mdpi/ic_save_all_white_24dp.png b/res/drawable-mdpi/ic_save_all_white_24dp.png new file mode 100644 index 0000000..6728179 Binary files /dev/null and b/res/drawable-mdpi/ic_save_all_white_24dp.png differ diff -- git a/res/drawable-xhdpi/ic_save_all_white_24dp.png b/res/drawable-xhdpi/ic_save_all_white_24dp.png new file mode 100644 index 0000000..799802d Binary files /dev/null and b/res/drawable-xhdpi/ic_save_all_white_24dp.png differ diff -- git a/res/drawable-xxhdpi/ic_save_all_white_24dp.png b/res/drawable-xxhdpi/ic_save_all_white_24dp.png new file mode 100644 index 0000000..1c6ba84 Binary files /dev/null and b/res/drawable-xxhdpi/ic_save_all_white_24dp.png differ diff -- git a/res/drawable-xxxhdpi/ic_save_all_white_24dp.png b/res/drawable-xxxhdpi/ic_save_all_white_24dp.png new file mode 100644 index 0000000..94f67c9 Binary files /dev/null and b/res/drawable-xxxhdpi/ic_save_all_white_24dp.png differ diff -- git a/res/menu/media_overview.xml b/res/menu/media_overview.xml new file mode 100644 index 0000000..e860d75 -- - /dev/null +++ b/res/menu/media_overview.xml @ @ -0,0 +1,8 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < menu xmlns : android= '' http : //schemas.android.com/apk/res/android '' + xmlns : app= '' http : //schemas.android.com/apk/res-auto '' > + < item android : id= '' @ +id/save '' + android : title= '' @ string/media_overview__save_all '' + android : icon= '' @ drawable/ic_save_all_white_24dp '' + app : showAsAction= '' ifRoom '' / > + < /menu > diff -- git a/res/values/strings.xml b/res/values/strings.xml index dc4e019..5b59af3 100644 -- - a/res/values/strings.xml +++ b/res/values/strings.xml @ @ -147,12 +147,25 @ @ Feature request : A way to store incoming pictures in bulk __EoT__ Some of my contacts use Signal to send me pictures of their lives . i want to store them permanently rather than in Signal . Currently I have to tap each picture individually , then the save button , then answer a question , the tap back , rinse and repeat . I would like to propose a more efficient way for this scenario . Different options could be considered : a ) extend the `` all images '' view to allow selecting and storing all pictures at once . b ) an option to automatically store all incoming pictures in a folder on the sd-card . I 'm sure other options might be perceivable . Thanks for your consideration .
diff -- git a/res/layout/media_overview_item.xml b/res/layout/media_overview_item.xml index f02d942..715651a 100644 -- - a/res/layout/media_overview_item.xml +++ b/res/layout/media_overview_item.xml @ @ -8,6 +8,6 @ @ android : id= '' @ +id/image '' android : layout_width= '' match_parent '' android : layout_height= '' match_parent '' - android : contentDescription= '' @ string/media_preview_activity__image_content_description '' / > + android : contentDescription= '' @ string/media_preview_activity__media_content_description '' / > < /org.thoughtcrime.securesms.components.SquareFrameLayout > diff -- git a/res/menu/conversation.xml b/res/menu/conversation.xml index 81587e8..ac15ff1 100644 -- - a/res/menu/conversation.xml +++ b/res/menu/conversation.xml @ @ -4,7 +4,7 @ @ < item android : title= '' @ string/conversation__menu_add_attachment '' android : id= '' @ +id/menu_add_attachment '' / > - < item android : title= '' @ string/conversation__menu_view_media '' + < item android : title= '' @ string/conversation__menu_view_all_media '' android : id= '' @ +id/menu_view_media '' / > < item android : title= '' @ string/conversation__menu_conversation_settings '' diff -- git a/res/menu/media_preview.xml b/res/menu/media_preview.xml index 8bee836..9e2d676 100644 -- - a/res/menu/media_preview.xml +++ b/res/menu/media_preview.xml @ @ -10,7 +10,7 @ @ android : icon= '' @ drawable/ic_save_white_24dp '' app : showAsAction= '' always '' / > < item android : id= '' @ +id/media_preview__overview '' - android : title= '' @ string/media_preview__overview_title '' + android : title= '' @ string/media_preview__all_media_title '' android : icon= '' @ Inconsistency : When watching a video and pressing the gallery button , the video is not in the list of `` all pictures '' __EoT__ < ! -- This is a bug report template . By following the instructions below and filling out the sections with your information , you will help the developers to get all the necessary data to fix your issue . You can also preview your report before submitting it . You may remove sections that are n't relevant to your particular case . Before we begin , please note that this tracker is only for issues , not questions or comments . If you are looking for support , please see our support center instead : http : //support.whispersystems.org/ or email support @ whispersystems.org Let 's begin with a checklist : replace the empty checkboxes [ ] below with checked ones [ x ] accordingly -- > I have : - [ x ] searched open and closed issues for duplicates - [ x ] read https : //github.com/WhisperSystems/Signal-Android/wiki/Submitting-useful-bug-reports -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- # # # Bug description Thanks
diff -- git a/.gitignore b/.gitignore index ccf7cd1..ae3bf7b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -3,4 +3,4 @ @ project.properties .project .settings bin/ -gen/ +gen/ \ No newline at end of file diff -- git a/assets/DDC_Uchen.ttf b/assets/DDC_Uchen.ttf new file mode 100644 index 0000000..b4707dc Binary files /dev/null and b/assets/DDC_Uchen.ttf differ diff -- git a/assets/monlambodyig.ttf b/assets/monlambodyig.ttf new file mode 100644 index 0000000..3f51f30 Binary files /dev/null and b/assets/monlambodyig.ttf differ diff -- git a/res/layout/auto_initiate_activity.xml b/res/layout/auto_initiate_activity.xml index 6a3e71e..c07be0d 100644 -- - a/res/layout/auto_initiate_activity.xml +++ b/res/layout/auto_initiate_activity.xml @ @ -5,24 +5,24 @ @ android : orientation= '' vertical '' android : padding= '' 10px '' > - < TextView android : id= '' @ +id/description_text '' + < org.thoughtcrime.securesms.lang.BhoTextView android : id= '' @ +id/description_text '' android : layout_width= '' fill_parent '' android : layout_height= '' wrap_content '' android : layout_marginBottom= '' 5px '' - android : text= '' You have received a message from someone who supports TextSecure encrypted sessions . Would you like to initiate a key exchange so you can communicate securely ? `` / > + android : text= '' @ string/you_have_received_a_message_from_someone_who_supports_textsecure '' / > < LinearLayout android : layout_width= '' fill_parent '' android : layout_height= '' wrap_content '' android : layout_marginTop= '' 10px Sprint Bad encrypted MMS message __EoT__ Hello , I know there was an issue in the past with an extra digit while decrypting but I 'm not sure if that is whats going on . Any help would be appreciated . Both phones are on version 0.9.9.8 One phone has : Android 4.2.2 CM 10.1.2 Kernal 3.4.45 OpenPDroid framework additions The other phone has : Android 4.1.2 ( I think ) Stock rooted Sending log via Catlog 07-30 13:39:44.506 D/dalvikvm ( 9902 ) : Added shared lib libnativehelper.so 0x0 07-30 13:39:44.646 D/AndroidRuntime ( 9902 ) : Calling main entry com.android.commands.am.Am 07-30 13:39:44.646 D/dalvikvm ( 9902 ) : Note : class Landroid/app/ActivityManagerNative ; has 157 unimplemented ( abstract ) methods 07-30 13:39:44.666 I/System.out ( 9026 ) : tainted command part 0 : su 07-30 13:39:44.666 I/System.out ( 9026 ) : Now test tainted command : su 07-30 13:39:44.666 D/AndroidRuntime ( 9902 ) : Shutting down VM 07-30 13:39:44.676 D/dalvikvm ( 9902 ) : GC_CONCURRENT freed 93K , 16 % free 509K/604K , paused 0ms+0ms , total 4ms 07-30 13:39:44.736 D/dalvikvm ( 9026 ) : GC_CONCURRENT freed 1452K , 48 % free 5593K/10688K , paused 3ms+9ms , total 49ms 07-30 13:39:44.806 I/System.out
diff -- git a/AndroidManifest.xml b/AndroidManifest.xml index 78a3e65..4904ed9 100644 -- - a/AndroidManifest.xml +++ b/AndroidManifest.xml @ @ -174,7 +174,7 @ @ < /activity-alias > < activity android : name= '' .ConversationListArchiveActivity '' - android : label= '' @ string/AndroidManifeset_conversations_archive '' + android : label= '' @ string/AndroidManifest_conversations_archive '' android : launchMode= '' singleTask '' android : configChanges= '' touchscreen|keyboard|keyboardHidden|orientation|screenLayout|screenSize '' android : parentActivityName= '' .ConversationListActivity '' > diff -- git a/res/menu/conversation_list_batch_archive.xml b/res/menu/conversation_list_batch_archive.xml index 1c91c1b..3ed58c4 100644 -- - a/res/menu/conversation_list_batch_archive.xml +++ b/res/menu/conversation_list_batch_archive.xml @ @ -2,7 +2,7 @ @ < menu xmlns : android= '' http : //schemas.android.com/apk/res/android '' xmlns : app= '' http : //schemas.android.com/apk/res-auto '' > - < item android : title= '' @ string/conversation_list_batch__archive_selected '' + < item android : title= '' @ string/conversation_list_batch_archive__menu_archive_selected '' android : id= '' @ +id/menu_archive_selected '' android : icon= '' @ drawable/ic_archive_white_24dp '' app : showAsAction= '' always '' / > diff -- git a/res/menu/conversation_list_batch_unarchive.xml b/res/menu/conversation_list_batch_unarchive.xml index ecb7bb3..3d42468 100644 -- - a/res/menu/conversation_list_batch_unarchive.xml +++ b/res/menu/conversation_list_batch_unarchive.xml @ @ -2,7 +2,7 @ @ < menu xmlns : android= '' http : //schemas.android.com/apk/res/android '' xmlns : app= '' http : //schemas.android.com/apk/res-auto '' > - < item android : title= '' @ string/conversation_list_batch__archive_selected '' + < item android : title= '' Unarchive button uses archive button 's title string __EoT__ The unarchive button in the Conversations Archive batch select menu uses the same title as the Conversation List 's archive button : `` Archive selected '' . This is visible on long-press of the button : ! [ unarchive-button-before ] ( https : //cloud.githubusercontent.com/assets/11031903/11451719/41b4bfa0-9613-11e5-95e3-274176a1cbfc.png )
diff -- git a/README.md b/README.md index 1accf45..de75f90 100644 -- - a/README.md +++ b/README.md @ @ -2,7 +2,7 @ @ - [ **Fully Kotlin support** ] ( https : //github.com/hotchemi/PermissionsDispatcher/blob/master/doc/kotlin_support.md ) - [ **Special Permissions support** ] ( https : //github.com/hotchemi/PermissionsDispatcher/blob/master/doc/special_permissions.md ) -- **Xiaomi support** +- **Xiaomi ( [ API level > = 23 ] ( https : //github.com/permissions-dispatcher/PermissionsDispatcher/issues/386 # issuecomment-418680789 ) ) support** - **100 % reflection-free** PermissionsDispatcher provides a simple annotation-based API to handle runtime permissions . Check permissions on xiaomi device with a version below api 23 __EoT__ As you know , Xiaomi devices have their own system of permissions . I 'm testing my application on the device xiaomi redmi 3 , api 22 , android 5.1.1 . I want to check if there is permission to access the camera and audio . ` boolean b = hasSelfPermissionForXiaomi ( getActivity ( ) , '' android.permission.CAMERA '' ) ; } ` ` private boolean hasSelfPermissionForXiaomi ( Context context , String permission ) { String permissionTop = AppOpsManagerCompat.permissionToOp ( permission ) ; if ( permissionTop == null ) { // not dangerous return true ; } int noteOp = AppOpsManagerCompat.noteOp ( context , permissionTop , Process.myUid ( ) , context.getPackageName ( ) ) ; return noteOp == AppOpsManagerCompat.MODE_ALLOWED & & checkSelfPermission ( context , permission ) == PackageManager.PERMISSION_GRANTED ; } ` b = true , although this is not true .
diff -- git a/processor/build.gradle b/processor/build.gradle index ad3b1a7..cd33910 100644 -- - a/processor/build.gradle +++ b/processor/build.gradle @ @ -67,6 +67,7 @ @ dependencies { testCompile `` junit : junit : $ JUNIT_VERSION '' testCompile `` com.google.testing.compile : compile-testing : $ COMPILE_TESTING_VERSION '' testCompile `` com.google.android : android : $ GOOGLE_ANDROID_VERSION '' + testCompile 'commons-io : commons-io:2.4' testCompile fileTree ( dir : './src/test/libs ' , includes : [ '*.jar ' ] ) testCompile files ( Jvm.current ( ) .getToolsJar ( ) ) diff -- git a/processor/src/test/java/permissions/dispatcher/processor/utils/AssetsUtils.java b/processor/src/test/java/permissions/dispatcher/processor/utils/AssetsUtils.java new file mode 100644 index 0000000..bd0400c -- - /dev/null +++ b/processor/src/test/java/permissions/dispatcher/processor/utils/AssetsUtils.java @ @ -0,0 +1,24 @ @ +package permissions.dispatcher.processor.utils ; + +import org.apache.commons.io.IOUtils ; + +import java.io.File ; +import java.io.FileInputStream ; +import java.io.IOException ; + +/** + * Provides util methods which Load files from assets dir . + */ +public final class AssetsUtils { + + private AssetsUtils ( ) { + } + + public static String readString ( String fileName ) { + try ( FileInputStream fis = new FileInputStream ( new File ( `` src/test/assets '' , fileName ) ) ) { + return IOUtils.toString ( fis , `` UTF-8 '' ) ; + } catch ( IOException e ) { + throw Test code refactoring __EoT__ Our test code has gotten massive and it 's so hard to maintain . So , we should separate expected String arrays to each Java file .
diff -- git a/gradle.properties b/gradle.properties index 830dd05..4e1a659 100644 -- - a/gradle.properties +++ b/gradle.properties @ @ -33,7 +33,7 @ @ COMMONS_IO_VERSION = 2.6 # Android configuration COMPILE_SDK_VERSION = android-28 -BUILD_TOOLS_VERSION = 28.0.0-rc2 +BUILD_TOOLS_VERSION = 28.0.3 TARGET_SDK_VERSION = 28 MIN_SDK_VERSION = 14 diff -- git a/lint/src/test/java/permissions/dispatcher/CallNeedsPermissionDetectorTest.kt b/lint/src/test/java/permissions/dispatcher/CallNeedsPermissionDetectorTest.kt index 4eaa34a..508b253 100644 -- - a/lint/src/test/java/permissions/dispatcher/CallNeedsPermissionDetectorTest.kt +++ b/lint/src/test/java/permissions/dispatcher/CallNeedsPermissionDetectorTest.kt @ @ -84,4 +84,46 @ @ class CallNeedsPermissionDetectorTest { .run ( ) .expectClean ( ) } + + @ Test + @ Throws ( Exception : :class ) + fun callNeedsPermissionMethodForIssues502 ( ) { + @ Language ( `` JAVA '' ) val foo = `` '' '' + package com.example ; + + import permissions.dispatcher.NeedsPermission ; + + public class Foo extends AppCompatActivity { + @ NeedsPermission ( { Manifest.permission.READ_SMS , Manifest.permission.RECEIVE_SMS } ) + void requestOTP ( ) { + new PhoneVerificationInputFragment ( ) .requestOTP ( ) ; + } + } + + class FooFragment extends Fragment { + public void resendOTP ( ) { + requestOTP ( ) ; + } + private void requestOTP ( ) { + } + } + `` '' '' .trimMargin ( ) + + val expectedText = `` '' '' + |src/com/example/Foo.java:14 : Error : Trying Lint complains for CallNeedsPermission over a method in fragment which exists in activity with same name . __EoT__ I am facing this ` Error : Trying to access permission-protected method directly [ CallNeedsPermission ] ` The lint complains this error and my build is failing due to this . The error is reported in a Fragment which does not require any special permission and is not annotated with ` @ RuntimePermissions. ` This rule complains for a method in following scenario 1 . Another method with same name in the Activity where this fragment is attached . 2 . The method in the activity is annotated with ` @ NeedsPermission ` As you see in following code snippet , I am delegating the requestOTP ( ) function to fragment 's requestOTP ( ) method . `` ` @ RuntimePermissions public class SetupActivity extends AppCompatActivity { // Some other code @ Override public void onPhoneNumberInput ( @ NonNull String phone ) { phoneNumber = phone ; SetupActivityPermissionsDispatcher.requestOTPWithPermissionCheck ( this ) ; } @ NeedsPermission ( { Manifest.permission.READ_SMS , Manifest.permission.RECEIVE_SMS } ) void requestOTP ( ) { ( ( PhoneVerificationInputFragment ) mFragment ) .requestOTP ( ) ; } // Some other code
diff -- git a/presto-server-rpm/pom.xml b/presto-server-rpm/pom.xml index 4ed71e3..a6821c5 100644 -- - a/presto-server-rpm/pom.xml +++ b/presto-server-rpm/pom.xml @ @ -97,6 +97,9 @ @ < dependency > < name > /usr/sbin/groupadd < /name > < /dependency > + < dependency > + < name > /usr/bin/uuidgen < /name > + < /dependency > < /dependencies > < links > 0.203 release notes __EoT__ # # Andrii Rosa - [ x ] all checked - 05-23 08:51:45 c10376c7a2 Run different hive tests in separate travis branches - 05-23 08:51:45 c346768372 Fix failing test in TestHiveClient - 05-23 08:51:45 e03fba400b Rename test methods in AbstractTestHiveClient - 05-23 12:37:31 71f7ef57d2 Run presto-main tests as a separate Travis job - 05-29 07:00:01 32c3020004 Return empty list instead of null from the getPartitionedBy - 05-29 07:00:01 4a4fbb4a37 Refactor HiveMetastore statistics related interfaces - 05-29 07:00:01 5b9cdd9bdf Refactor enforceLayoutProcessor - 05-29 07:00:01 6efaa261a6 Fix parameter names related to getting partition statistics from Hive - 05-29 07:00:01 7b8e89b316 Check partitioned_by and bucketed_by before getting the layout - 05-29 07:00:01 a49a78de21 Remove generics from HiveColumnStatistics - 05-29 07:00:01 f3978ed0f9 Do not store NDV for Boolean in HiveColumnStatistics # # Dain Sundstrom - [ x ] all checked - 05-24 10:59:35 2da712aaef Fix IntelliJ warnings in SqlQueryScheduler - 05-24 15:58:35 40083af07a Move query submission to background thread - 05-24 15:58:35 89adfb2e06 Move QueryId creation into explicit separate step - 05-24 15:58:36 568449b8d0 Delay query submission until first data get call - 05-24 18:25:13 34cea981c7 Delegate output operator blocking to output buffer - 05-24 19:46:14 93b2be6825 Upgrade to Airlift
diff -- git a/presto-main/src/main/java/com/facebook/presto/cost/ComparisonStatsCalculator.java b/presto-main/src/main/java/com/facebook/presto/cost/ComparisonStatsCalculator.java index 94f48e2..c3aedf0 100644 -- - a/presto-main/src/main/java/com/facebook/presto/cost/ComparisonStatsCalculator.java +++ b/presto-main/src/main/java/com/facebook/presto/cost/ComparisonStatsCalculator.java @ @ -19,7 +19,6 @ @ import com.facebook.presto.sql.tree.ComparisonExpressionType ; import java.util.Optional ; import java.util.OptionalDouble ; -import static com.facebook.presto.cost.FilterStatsCalculator.filterStatsForUnknownExpression ; import static com.facebook.presto.cost.SymbolStatsEstimate.buildFrom ; import static com.facebook.presto.util.MoreMath.firstNonNaN ; import static com.facebook.presto.util.MoreMath.max ; @ @ -34,7 +33,7 @ @ public final class ComparisonStatsCalculator { private ComparisonStatsCalculator ( ) { } - public static PlanNodeStatsEstimate comparisonExpressionToLiteralStats ( + public static Optional < PlanNodeStatsEstimate > comparisonExpressionToLiteralStats ( PlanNodeStatsEstimate inputStatistics , Optional < Symbol > symbol , SymbolStatsEstimate expressionStats , @ @ -54,11 +53,11 @ @ public final class ComparisonStatsCalculator return expressionToLiteralGreaterThan ( inputStatistics , symbol , expressionStats , doubleLiteral ) ; case IS_DISTINCT_FROM : default : - return filterStatsForUnknownExpression ( inputStatistics ) ; + return Optional.empty ( ) ; } } - private static PlanNodeStatsEstimate expressionToLiteralRangeComparison ( + private static Optional < PlanNodeStatsEstimate > expressionToLiteralRangeComparison ( PlanNodeStatsEstimate inputStatistics , Optional < Symbol > symbol , SymbolStatsEstimate expressionStats , @ @ -79,10 +78,10 @ @ public final class ComparisonStatsCalculator .build ( ) ; estimate = estimate.mapSymbolColumnStatistics ( symbol.get ( ) , oldStats - > symbolNewEstimate ) ; } - return estimate ; + return Optional.of ( estimate ) ; } - private Investigate if Hive connector should add stats properties __EoT__ Partitions ( or unpartitioned tables ) written by Hive seem to have the following properties ( tested with Hive 1.2.1 ) : * ` COLUMN_STATS_ACCURATE ` = ` true ` * ` numFiles ` * ` numRows ` * ` rawDataSize ` * ` totalSize ` This looks like a good starting point : https : //github.com/apache/hive/blob/master/standalone-metastore/src/main/java/org/apache/hadoop/hive/common/StatsSetupConst.java
diff -- git a/presto-main/src/main/java/com/facebook/presto/cost/AbstractSetOperationStatsRule.java b/presto-main/src/main/java/com/facebook/presto/cost/AbstractSetOperationStatsRule.java new file mode 100644 index 0000000..cd2345d -- - /dev/null +++ b/presto-main/src/main/java/com/facebook/presto/cost/AbstractSetOperationStatsRule.java @ @ -0,0 +1,74 @ @ +/* + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ + +package com.facebook.presto.cost ; + +import com.facebook.presto.Session ; +import com.facebook.presto.spi.type.Type ; +import com.facebook.presto.sql.planner.Symbol ; +import com.facebook.presto.sql.planner.iterative.Lookup ; +import com.facebook.presto.sql.planner.plan.PlanNode ; +import com.facebook.presto.sql.planner.plan.SetOperationNode ; +import com.google.common.collect.ListMultimap ; + +import java.util.Map ; +import java.util.Optional ; + +import static com.google.common.base.Preconditions.checkState ; + +abstract class AbstractSetOperationStatsRule + extends SimpleStatsRule + { + public AbstractSetOperationStatsRule ( StatsNormalizer normalizer ) + { + super ( Investigate if Hive connector should add stats properties __EoT__ Partitions ( or unpartitioned tables ) written by Hive seem to have the following properties ( tested with Hive 1.2.1 ) : * ` COLUMN_STATS_ACCURATE ` = ` true ` * ` numFiles ` * ` numRows ` * ` rawDataSize ` * ` totalSize ` This looks like a good starting point : https : //github.com/apache/hive/blob/master/standalone-metastore/src/main/java/org/apache/hadoop/hive/common/StatsSetupConst.java
diff -- git a/presto-base-jdbc/src/test/java/com/facebook/presto/plugin/jdbc/MetadataUtil.java b/presto-base-jdbc/src/test/java/com/facebook/presto/plugin/jdbc/MetadataUtil.java index bce7ffb..1a3f405 100644 -- - a/presto-base-jdbc/src/test/java/com/facebook/presto/plugin/jdbc/MetadataUtil.java +++ b/presto-base-jdbc/src/test/java/com/facebook/presto/plugin/jdbc/MetadataUtil.java @ @ -53,7 +53,7 @ @ final class MetadataUtil { private final Map < String , Type > types = ImmutableMap. < String , Type > of ( StandardTypes.BIGINT , BIGINT , - StandardTypes.VARCHAR , VARCHAR ) ; + VARCHAR.getTypeSignature ( ) .toString ( ) , VARCHAR ) ; // for varchar ( MAX_INT ) public TestingTypeDeserializer ( ) { diff -- git a/presto-client/src/main/java/com/facebook/presto/client/ClientTypeSignature.java b/presto-client/src/main/java/com/facebook/presto/client/ClientTypeSignature.java index 44bb9ca..81220aa 100644 -- - a/presto-client/src/main/java/com/facebook/presto/client/ClientTypeSignature.java +++ b/presto-client/src/main/java/com/facebook/presto/client/ClientTypeSignature.java @ @ -87,7 +87,7 @ @ public class ClientTypeSignature else { checkArgument ( literalArguments.isEmpty ( ) , `` Unexpected literal arguments from legacy server '' ) ; for ( ClientTypeSignature typeArgument : typeArguments ) { - convertedArguments.add ( new ClientTypeSignatureParameter ( ParameterKind.TYPE_SIGNATURE , typeArgument ) ) ; + convertedArguments.add ( new ClientTypeSignatureParameter ( ParameterKind.TYPE , typeArgument ) ) ; } } this.arguments = convertedArguments.build ( ) ; @ @ -105,11 +105,11 @ @ public class ClientTypeSignature private static TypeSignatureParameter legacyClientTypeSignatureParameterToTypeSignatureParameter ( ClientTypeSignatureParameter parameter ) { switch ( parameter.getKind ( ) ) { - case LONG_LITERAL : + case LONG : throw new UnsupportedOperationException ( `` Unexpected long type literal returned by legacy server '' Add support for CAST ( ... AS VARCHAR ( x ) ) __EoT__
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java index ea1d289..b70a460 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java @ @ -271,10 +271,8 @ @ class RelationPlanner Analysis.JoinInPredicates joinInPredicates = analysis.getJoinInPredicates ( node ) ; // Add semi joins if necessary - if ( joinInPredicates ! = null ) { - leftPlanBuilder = appendSemiJoins ( leftPlanBuilder , joinInPredicates.getLeftInPredicates ( ) ) ; - rightPlanBuilder = appendSemiJoins ( rightPlanBuilder , joinInPredicates.getRightInPredicates ( ) ) ; - } + leftPlanBuilder = appendSemiJoins ( leftPlanBuilder , joinInPredicates.getLeftInPredicates ( ) ) ; + rightPlanBuilder = appendSemiJoins ( rightPlanBuilder , joinInPredicates.getRightInPredicates ( ) ) ; // Add projections for join criteria leftPlanBuilder = appendProjections ( leftPlanBuilder , leftExpressions ) ; Join with multiple IN-subquery clauses fails __EoT__ I believe this is due to the fact that ` analysis.addJoinInPredicates ` is called in a loop in ` StatementAnalyzer ` . This is almost certainly wrong , as it does a ` put ` into an identity map , ignoring any previous value `` ` select * from ( values 1 ) t ( x ) join ( values 1 ) t2 ( y ) on ( x in ( values 1 ) ) = ( y in ( values 1 ) ) and ( x in ( values 2 ) ) = ( y in ( values 2 ) ) ; `` ` Fails with : `` ` Query 20151230_004032_00259_cku6f failed : com.facebook.presto.sql.tree.Query can not be cast to com.facebook.presto.sql.tree.Expression java.lang.ClassCastException : com.facebook.presto.sql.tree.Query can not be cast to com.facebook.presto.sql.tree.Expression at com.facebook.presto.sql.planner.SubExpressionExtractor $ 1.process ( SubExpressionExtractor.java:65 ) at com.facebook.presto.sql.planner.SubExpressionExtractor $ 1.process ( SubExpressionExtractor.java:61 ) at com.facebook.presto.sql.tree.DefaultTraversalVisitor.visitSubqueryExpression ( DefaultTraversalVisitor.java:319 ) at com.facebook.presto.sql.tree.SubqueryExpression.accept ( SubqueryExpression.java:47 ) at com.facebook.presto.sql.tree.AstVisitor.process ( AstVisitor.java:22 ) at com.facebook.presto.sql.planner.SubExpressionExtractor $ 1.process ( SubExpressionExtractor.java:68 ) at com.facebook.presto.sql.planner.SubExpressionExtractor $ 1.process ( SubExpressionExtractor.java:61 ) at com.facebook.presto.sql.tree.DefaultTraversalVisitor.visitInPredicate ( DefaultTraversalVisitor.java:149 ) at com.facebook.presto.sql.tree.InPredicate.accept ( InPredicate.java:54 ) at com.facebook.presto.sql.tree.AstVisitor.process ( AstVisitor.java:22 ) at com.facebook.presto.sql.planner.SubExpressionExtractor $ 1.process (
diff -- git a/presto-main/src/main/java/com/facebook/presto/FullConnectorSession.java b/presto-main/src/main/java/com/facebook/presto/FullConnectorSession.java index 00db4dd..3b9162c 100644 -- - a/presto-main/src/main/java/com/facebook/presto/FullConnectorSession.java +++ b/presto-main/src/main/java/com/facebook/presto/FullConnectorSession.java @ @ -39,7 +39,6 @ @ public class FullConnectorSession private final String catalog ; private final SessionPropertyManager sessionPropertyManager ; private final boolean isLegacyTimestamp ; - private final boolean isLegacyRoundNBigint ; public FullConnectorSession ( Session session ) { @ @ -49,7 +48,6 @ @ public class FullConnectorSession this.catalog = null ; this.sessionPropertyManager = null ; this.isLegacyTimestamp = SystemSessionProperties.isLegacyTimestamp ( session ) ; - this.isLegacyRoundNBigint = SystemSessionProperties.isLegacyRoundNBigint ( session ) ; } public FullConnectorSession ( @ @ -65,7 +63,6 @ @ public class FullConnectorSession this.catalog = requireNonNull ( catalog , `` catalog is null '' ) ; this.sessionPropertyManager = requireNonNull ( sessionPropertyManager , `` sessionPropertyManager is null '' ) ; this.isLegacyTimestamp = SystemSessionProperties.isLegacyTimestamp ( session ) ; - this.isLegacyRoundNBigint = SystemSessionProperties.isLegacyRoundNBigint ( session ) ; } public Session getSession ( ) @ @ -128,12 +125,6 @ @ public class FullConnectorSession } @ Override - public boolean isLegacyRoundNBigint ( ) - { - return isLegacyRoundNBigint ; - } - - @ Override public < T > T getProperty ( String propertyName , Class < T > type ) { if ( properties == null ) { diff -- git a/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java Release notes for 0.212 __EoT__ # # Andrii Rosa - [ x ] all checked - 09-17 14:45:21 15acda5262 Use release version of hadoop-apache2 - 09-19 16:28:31 04920e5412 Remove RangeColumnStatistics - 09-19 16:28:31 31ce36963e Add TableStatistics # empty ( ) method - 09-19 16:28:31 351a61fae2 Refactor Estimate - 09-19 16:28:32 1344eb92a7 Normalize distinct values count - 09-19 16:28:32 1ff1e28f2a Extract parsePartition in PartitionManager - 09-19 16:28:32 5b9a58fc62 Remove MIN/MAX statistics support for TIMESTAMP in Hive Connector - 09-19 16:28:32 5f5e6629d3 Refactor MetastoreHiveStatisticsProvider - 09-19 16:28:32 652112e7fc Ignore corrupted statistics when altering partition - 09-19 16:28:32 845a0d8a36 Print column statistics in deterministic manner - 09-19 16:28:32 9229cda964 Remove validation from HiveBasicStatistics - 09-19 16:28:32 aed92f8e17 Refactor TableStatistics - 09-19 16:28:32 b3827bfb7f Fix incorrect partitions sample size - 09-19 16:28:32 ea3a81417b Represent min and max statistics in SPI as double - 09-19 16:28:32 f847336c88 Make getPartitionsSample deterministic - 09-19 16:38:41 e10912726d Fix flaky testComplexStateEstimatedSize test - 09-21 08:27:48 4075a5c93b Fix JoinStatsRule crash when missing column statistics # # Dain Sundstrom - [ x ] all checked - 09-18 10:34:23 002c40264e Replace most uses of QueryInfo with BasicQueryInfo - 09-18 10:34:23 021c7855f7 Use event listeners to create final query info - 09-18 10:34:23
diff -- git a/presto-client/src/main/java/com/facebook/presto/client/ClientTypeSignature.java b/presto-client/src/main/java/com/facebook/presto/client/ClientTypeSignature.java index 99b3911..64512d3 100644 -- - a/presto-client/src/main/java/com/facebook/presto/client/ClientTypeSignature.java +++ b/presto-client/src/main/java/com/facebook/presto/client/ClientTypeSignature.java @ @ -13,6 +13,7 @ @ */ package com.facebook.presto.client ; +import com.facebook.presto.spi.type.StandardTypes ; import com.facebook.presto.spi.type.TypeSignature ; import com.fasterxml.jackson.annotation.JsonCreator ; import com.fasterxml.jackson.annotation.JsonProperty ; @ @ -34,21 +35,21 @ @ public class ClientTypeSignature { private static final Pattern PATTERN = Pattern.compile ( `` .* [ < > , ] . * '' ) ; private final String rawType ; - private final List < ClientTypeSignature > typeArguments ; + private final List < ClientTypeSignatureParameter > typeArguments ; private final List < Object > literalArguments ; public ClientTypeSignature ( TypeSignature typeSignature ) { this ( typeSignature.getBase ( ) , - Lists.transform ( typeSignature.getParameters ( ) , ClientTypeSignature : :new ) , + Lists.transform ( typeSignature.getParameters ( ) , ClientTypeSignatureParameter : :new ) , typeSignature.getLiteralParameters ( ) ) ; } @ JsonCreator public ClientTypeSignature ( @ JsonProperty ( `` rawType '' ) String rawType , - @ JsonProperty ( `` typeArguments '' ) List < ClientTypeSignature > typeArguments , + @ JsonProperty ( `` typeArguments '' ) List < ClientTypeSignatureParameter > typeArguments , @ JsonProperty ( `` literalArguments '' ) List < Object > literalArguments ) { checkArgument ( rawType ! Add syntax for ROW type __EoT__
diff -- git a/presto-benchmark/src/main/java/com/facebook/presto/benchmark/HashAggregationBenchmark.java b/presto-benchmark/src/main/java/com/facebook/presto/benchmark/HashAggregationBenchmark.java index 31fa1d6..d320b6c 100644 -- - a/presto-benchmark/src/main/java/com/facebook/presto/benchmark/HashAggregationBenchmark.java +++ b/presto-benchmark/src/main/java/com/facebook/presto/benchmark/HashAggregationBenchmark.java @ @ -51,7 +51,8 @ @ public class HashAggregationBenchmark { OperatorFactory tableScanOperator = createTableScanOperator ( 0 , new PlanNodeId ( `` test '' ) , `` orders '' , `` orderstatus '' , `` totalprice '' ) ; List < Type > types = ImmutableList.of ( tableScanOperator.getTypes ( ) .get ( 0 ) ) ; - HashAggregationOperatorFactory aggregationOperator = new HashAggregationOperatorFactory ( 1 , + HashAggregationOperatorFactory aggregationOperator = new HashAggregationOperatorFactory ( + 1 , new PlanNodeId ( `` test '' ) , types , Ints.asList ( 0 ) , diff -- git a/presto-main/src/main/java/com/facebook/presto/operator/HashAggregationOperator.java b/presto-main/src/main/java/com/facebook/presto/operator/HashAggregationOperator.java index 0c32ddf..0f24e14 100644 -- - a/presto-main/src/main/java/com/facebook/presto/operator/HashAggregationOperator.java +++ b/presto-main/src/main/java/com/facebook/presto/operator/HashAggregationOperator.java @ @ -196,7 +196,7 @ @ public class HashAggregationOperator @ Override public boolean needsInput ( ) { - return ! finishing & & outputIterator == null & & ( aggregationBuilder == null || ! aggregationBuilder.isFull ( ) ) ; + return ! finishing & & outputIterator == null & & ( aggregationBuilder == null || ! aggregationBuilder.checkFullAndUpdateMemory ( ) ) ; } @ Override @ @ -217,7 +217,7 @ @ public class HashAggregationOperator // assume initial aggregationBuilder is not full } else { - checkState OperatorContext is not ThreadSafe __EoT__ Contrary to the misleading ` @ ThreadSafe ` annotation and usage of ` AtomicLong ` everywhere in it ` OperatorContext ` is not ThreadSafe . I have stumbled on it while implementing some things related to spilling https : //github.com/prestodb/presto/pull/5142 and revocable memory https : //github.com/prestodb/presto/pull/5711 There is at least problem with ` setMemoryReservation ` , ` trySetMemoryReservation ` methods and ` transferMemoryToTaskContext ` : `` ` private final AtomicLong memoryReservation = new AtomicLong ( ) ; ( ... ) public void setMemoryReservation ( long newMemoryReservation ) { checkArgument ( newMemoryReservation > = 0 , `` newMemoryReservation is negative '' ) ; long delta = newMemoryReservation - memoryReservation.get ( ) ; if ( delta > 0 ) { reserveMemory ( delta ) ; } else { freeMemory ( -delta ) ; } } `` ` Example scenario . ` memoryReservation ` equals to ` 10 ` . 1. caller A initiate ` setMemoryReservation ( 3 ) ` . 2 . A thread calculates ` delta = -7 ` and hangs . 3. caller B changes memory reservation by calling ` setMemoryReservation ( 3 ) ` which finishes before A thread resumes work . This give
diff -- git a/presto-main/src/main/java/com/facebook/presto/execution/DataDefinitionExecution.java b/presto-main/src/main/java/com/facebook/presto/execution/DataDefinitionExecution.java index 121c017..978050e 100644 -- - a/presto-main/src/main/java/com/facebook/presto/execution/DataDefinitionExecution.java +++ b/presto-main/src/main/java/com/facebook/presto/execution/DataDefinitionExecution.java @ @ -80,6 +80,12 @ @ public class DataDefinitionExecution < T extends Statement > } @ Override + public long getTotalRevocableMemoryReservation ( ) + { + return 0 ; + } + + @ Override public Duration getTotalCpuTime ( ) { return new Duration ( 0 , TimeUnit.SECONDS ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/execution/FailedQueryExecution.java b/presto-main/src/main/java/com/facebook/presto/execution/FailedQueryExecution.java index fe18592..9d8d4ae 100644 -- - a/presto-main/src/main/java/com/facebook/presto/execution/FailedQueryExecution.java +++ b/presto-main/src/main/java/com/facebook/presto/execution/FailedQueryExecution.java @ @ -79,6 +79,12 @ @ public class FailedQueryExecution } @ Override + public long getTotalRevocableMemoryReservation ( ) + { + return 0 ; + } + + @ Override public Duration getTotalCpuTime ( ) { return new Duration ( 0 , TimeUnit.SECONDS ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/execution/QueryExecution.java b/presto-main/src/main/java/com/facebook/presto/execution/QueryExecution.java index 0fe2fbe..6e9d56e 100644 -- - a/presto-main/src/main/java/com/facebook/presto/execution/QueryExecution.java +++ b/presto-main/src/main/java/com/facebook/presto/execution/QueryExecution.java @ @ -36,6 +36,8 @ @ public interface QueryExecution long getTotalMemoryReservation ( ) ; + long getTotalRevocableMemoryReservation ( ) ; + Duration getTotalCpuTime ( ) ; Session getSession ( ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java b/presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java index 16fa98d..32144d8 100644 -- - a/presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java +++ b/presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java @ @ -238,6 +238,7 @ @ public class QueryStateMachine long cumulativeMemory = 0 ; long totalMemoryReservation = 0 ; + long totalRevocableMemoryReservation OperatorContext is not ThreadSafe __EoT__ Contrary to the misleading ` @ ThreadSafe ` annotation and usage of ` AtomicLong ` everywhere in it ` OperatorContext ` is not ThreadSafe . I have stumbled on it while implementing some things related to spilling https : //github.com/prestodb/presto/pull/5142 and revocable memory https : //github.com/prestodb/presto/pull/5711 There is at least problem with ` setMemoryReservation ` , ` trySetMemoryReservation ` methods and ` transferMemoryToTaskContext ` : `` ` private final AtomicLong memoryReservation = new AtomicLong ( ) ; ( ... ) public void setMemoryReservation ( long newMemoryReservation ) { checkArgument ( newMemoryReservation > = 0 , `` newMemoryReservation is negative '' ) ; long delta = newMemoryReservation - memoryReservation.get ( ) ; if ( delta > 0 ) { reserveMemory ( delta ) ; } else { freeMemory ( -delta ) ; } } `` ` Example scenario . ` memoryReservation ` equals to ` 10 ` . 1. caller A initiate ` setMemoryReservation ( 3 ) ` . 2 . A thread calculates ` delta = -7 ` and hangs . 3. caller B changes memory reservation by calling ` setMemoryReservation ( 3 ) ` which finishes before A thread resumes work . This give
diff -- git a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java index ebfbfdd..48fcaf9 100644 -- - a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java +++ b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java @ @ -201,6 +201,7 @ @ import static com.facebook.presto.spi.type.VarbinaryType.VARBINARY ; import static com.facebook.presto.spi.type.VarcharType.VARCHAR ; import static com.facebook.presto.spi.type.VarcharType.createUnboundedVarcharType ; import static com.facebook.presto.spi.type.Varchars.isVarcharType ; +import static com.facebook.presto.testing.DateTimeTestingUtils.sqlTimestampOf ; import static com.facebook.presto.testing.MaterializedResult.materializeSourceDataStream ; import static com.google.common.base.MoreObjects.toStringHelper ; import static com.google.common.base.Preconditions.checkArgument ; @ @ -3401,7 +3402,7 @ @ public abstract class AbstractTestHiveClient assertNull ( row.getField ( index ) ) ; } else { - SqlTimestamp expected = new SqlTimestamp ( new DateTime ( 2011 , 5 , 6 , 7 , 8 , 9 , 123 , timeZone ) .getMillis ( ) , UTC_KEY ) ; + SqlTimestamp expected = sqlTimestampOf ( 2011 , 5 , 6 , 7 , 8 , 9 , 123 , timeZone , UTC_KEY , SESSION ) ; assertEquals ( row.getField ( index ) , expected ) ; } } diff -- git a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java index 9f4c999..031a9f1 100644 -- - a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java +++ b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java @ @ -108,6 +108,7 @ @ import static com.facebook.presto.spi.type.VarbinaryType.VARBINARY ; import static com.facebook.presto.spi.type.VarcharType.createUnboundedVarcharType ; import static com.facebook.presto.spi.type.VarcharType.createVarcharType ; import static com.facebook.presto.spi.type.Varchars.isVarcharType ; +import static com.facebook.presto.testing.DateTimeTestingUtils.sqlTimestampOf ; import static com.facebook.presto.testing.MaterializedResult.materializeSourceDataStream ; import static com.facebook.presto.tests.StructuralTestUtil.arrayBlockOf ; import static com.facebook.presto.tests.StructuralTestUtil.decimalArrayBlockOf ; @ @ -750,7 +751,7 @ Release notes for 0.206 __EoT__ Issue to track release notes for next release .
diff -- git a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java index ebfbfdd..48fcaf9 100644 -- - a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java +++ b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java @ @ -201,6 +201,7 @ @ import static com.facebook.presto.spi.type.VarbinaryType.VARBINARY ; import static com.facebook.presto.spi.type.VarcharType.VARCHAR ; import static com.facebook.presto.spi.type.VarcharType.createUnboundedVarcharType ; import static com.facebook.presto.spi.type.Varchars.isVarcharType ; +import static com.facebook.presto.testing.DateTimeTestingUtils.sqlTimestampOf ; import static com.facebook.presto.testing.MaterializedResult.materializeSourceDataStream ; import static com.google.common.base.MoreObjects.toStringHelper ; import static com.google.common.base.Preconditions.checkArgument ; @ @ -3401,7 +3402,7 @ @ public abstract class AbstractTestHiveClient assertNull ( row.getField ( index ) ) ; } else { - SqlTimestamp expected = new SqlTimestamp ( new DateTime ( 2011 , 5 , 6 , 7 , 8 , 9 , 123 , timeZone ) .getMillis ( ) , UTC_KEY ) ; + SqlTimestamp expected = sqlTimestampOf ( 2011 , 5 , 6 , 7 , 8 , 9 , 123 , timeZone , UTC_KEY , SESSION ) ; assertEquals ( row.getField ( index ) , expected ) ; } } diff -- git a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java index 9f4c999..031a9f1 100644 -- - a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java +++ b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java @ @ -108,6 +108,7 @ @ import static com.facebook.presto.spi.type.VarbinaryType.VARBINARY ; import static com.facebook.presto.spi.type.VarcharType.createUnboundedVarcharType ; import static com.facebook.presto.spi.type.VarcharType.createVarcharType ; import static com.facebook.presto.spi.type.Varchars.isVarcharType ; +import static com.facebook.presto.testing.DateTimeTestingUtils.sqlTimestampOf ; import static com.facebook.presto.testing.MaterializedResult.materializeSourceDataStream ; import static com.facebook.presto.tests.StructuralTestUtil.arrayBlockOf ; import static com.facebook.presto.tests.StructuralTestUtil.decimalArrayBlockOf ; @ @ -750,7 +751,7 @ Release notes for 0.206 __EoT__ Issue to track release notes for next release .
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/gen/InCodeGenerator.java b/presto-main/src/main/java/com/facebook/presto/sql/gen/InCodeGenerator.java index 9d3184b..3d916e7 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/gen/InCodeGenerator.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/gen/InCodeGenerator.java @ @ -23,6 +23,8 @ @ import com.facebook.presto.byteCode.instruction.LabelNode ; import com.facebook.presto.metadata.FunctionInfo ; import com.facebook.presto.metadata.OperatorType ; import com.facebook.presto.metadata.Signature ; +import com.facebook.presto.spi.type.BigintType ; +import com.facebook.presto.spi.type.DateType ; import com.facebook.presto.spi.type.Type ; import com.facebook.presto.sql.relational.ConstantExpression ; import com.facebook.presto.sql.relational.RowExpression ; @ @ -41,10 +43,45 @ @ import static com.facebook.presto.byteCode.instruction.JumpInstruction.jump ; import static com.facebook.presto.sql.gen.ByteCodeUtils.ifWasNullPopAndGoto ; import static com.facebook.presto.sql.gen.ByteCodeUtils.invoke ; import static com.facebook.presto.sql.gen.ByteCodeUtils.loadConstant ; +import static com.google.common.base.Verify.verify ; public class InCodeGenerator implements ByteCodeGenerator { + enum SwitchGenerationCase + { + DIRECT_SWITCH , + HASH_SWITCH , + SET_CONTAINS , + } + + static SwitchGenerationCase checkSwitchGenerationCase ( Type type , List < RowExpression > values ) + { + if ( values.size ( ) < = 1000 ) { + boolean areSmallPrimitives = false ; + if ( type instanceof BigintType || type instanceof DateType ) { + areSmallPrimitives = true ; + for ( RowExpression expression : values ) { + if ( expression instanceof ConstantExpression ) { + Object constant = ( ( ConstantExpression ) expression ) .getValue ( ) ; + if ( constant ! = null ) { + verify ( constant instanceof Long ) ; + Long longConstant = ( Long ) Use direct switch for small IN lists of small primitives __EoT__ If all of the constants fit in an ` int ` ( less than ` 2^32 ` ) , we can switch on the values directly , rather than on the hash code . This removes both the hash computation of the lookup value and the extra comparison when the hash matches . https : //github.com/facebook/presto/blob/master/presto-main/src/main/java/com/facebook/presto/sql/gen/InCodeGenerator.java # L102
diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveClientConfig.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveClientConfig.java index 17c7110..8a9a268 100644 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/HiveClientConfig.java +++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveClientConfig.java @ @ -121,6 +121,7 @ @ public class HiveClientConfig private HiveMetastoreAuthenticationType hiveMetastoreAuthenticationType = HiveMetastoreAuthenticationType.NONE ; private HdfsAuthenticationType hdfsAuthenticationType = HdfsAuthenticationType.NONE ; private boolean hdfsImpersonationEnabled ; + private boolean hdfsWireEncryptionEnabled ; private boolean skipDeletionForAlter ; @ @ -954,6 +955,19 @ @ public class HiveClientConfig return this ; } + public boolean isHdfsWireEncryptionEnabled ( ) + { + return hdfsWireEncryptionEnabled ; + } + + @ Config ( `` hive.hdfs.wire-encryption.enabled '' ) + @ ConfigDescription ( `` Should be turned on when HDFS wire encryption is enabled '' ) + public HiveClientConfig setHdfsWireEncryptionEnabled ( boolean hdfsWireEncryptionEnabled ) + { + this.hdfsWireEncryptionEnabled = hdfsWireEncryptionEnabled ; + return this ; + } + public boolean isSkipDeletionForAlter ( ) { return skipDeletionForAlter ; diff -- git a/presto-hive/src/test/java/com/facebook/presto/hive/TestHiveClientConfig.java b/presto-hive/src/test/java/com/facebook/presto/hive/TestHiveClientConfig.java index ef579e0..b663e89 100644 -- - a/presto-hive/src/test/java/com/facebook/presto/hive/TestHiveClientConfig.java +++ b/presto-hive/src/test/java/com/facebook/presto/hive/TestHiveClientConfig.java @ @ -104,7 +104,8 @ @ public class TestHiveClientConfig .setFileSystemMaxCacheSize ( 1000 ) .setTableStatisticsEnabled ( true ) .setWritesToNonManagedTablesEnabled ( false ) - .setCreatesOfNonManagedTablesEnabled ( true ) ) ; + .setCreatesOfNonManagedTablesEnabled ( true ) + .setHdfsWireEncryptionEnabled ( false ) ) ; } @ Test @ @ -178,6 +179,7 @ @ public class TestHiveClientConfig .put ( `` hive.table-statistics-enabled Presto is not able to connect to hive metastore when hadoop.rpc.protection=privacy __EoT__ If hadoop.rpc.proctecion=privacy then presto fails to connect to hive metastore `` ` < property > < name > hadoop.rpc.protection < /name > < value > privacy < /value > < /property > `` ` The error message is ` Could not connect to meta store using any of the URIs provided . M ost recent failure : org.apache.thrift.transport.TTransportException : No common protection layer between client and server ` It is possible to patch presto code in order to fix this : In KerberosHiveMetastoreAuthentication.java file the line `` ` Sasl.QOP , `` auth '' , `` ` should be replaced with `` ` Sasl.QOP , `` auth-conf '' , `` ` The standard hive mestastore client works out of the box when core-site.xml and hive-site.xml are added to HiveConf as resources .
diff -- git a/presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java b/presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java index 4bb6739..1648047 100644 -- - a/presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java +++ b/presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java @ @ -230,11 +230,7 @ @ public final class SqlStageExecution public StageInfo getStageInfo ( ) { - return stateMachine.getStageInfo ( - ( ) - > getAllTasks ( ) .stream ( ) - .map ( RemoteTask : :getTaskInfo ) - .collect ( toImmutableList ( ) ) , - ImmutableList : :of ) ; + return stateMachine.getStageInfo ( this : :getAllTaskInfo , ImmutableList : :of ) ; } public synchronized void addExchangeLocations ( PlanFragmentId fragmentId , Set < RemoteTask > sourceTasks , boolean noMoreExchangeLocations ) @ @ -307,6 +303,16 @ @ public final class SqlStageExecution .collect ( toImmutableList ( ) ) ; } + private List < TaskInfo > getAllTaskInfo ( ) + { + // This avoids calling getAllTasks ( ) , creating immutable list out of it and + // then creating immutable list of TaskInfo . + return tasks.values ( ) .stream ( ) + .flatMap ( Set : :stream ) + .map ( RemoteTask : :getTaskInfo ) + .collect ( toImmutableList ( ) ) ; + } + public synchronized RemoteTask scheduleTask ( Node node , int partition , OptionalInt totalPartitions ) { requireNonNull ( Optimise StageStateMachine for memory __EoT__ `` ` SqlQueryScheduler | SqlStageExecution| StageStateMachine : :getStageInfo `` ` are frequently executed codepaths in presto . There are couple of places where ImmutableList is called on top of immutable lists creating additional objects . Intention is to reduce the memory usage as size of tasks , operatorStats can be high in busy clusters .
diff -- git a/presto-main/src/main/java/com/facebook/presto/operator/aggregation/TypedSet.java b/presto-main/src/main/java/com/facebook/presto/operator/aggregation/TypedSet.java index cf1e343..ca5fb5c 100644 -- - a/presto-main/src/main/java/com/facebook/presto/operator/aggregation/TypedSet.java +++ b/presto-main/src/main/java/com/facebook/presto/operator/aggregation/TypedSet.java @ @ -18,9 +18,10 @ @ import com.facebook.presto.spi.block.BlockBuilder ; import com.facebook.presto.spi.block.BlockBuilderStatus ; import com.facebook.presto.spi.type.Type ; import io.airlift.units.DataSize ; -import it.unimi.dsi.fastutil.ints.IntArrayList ; import org.openjdk.jol.info.ClassLayout ; +import java.util.Arrays ; + import static com.facebook.presto.ExceededMemoryLimitException.exceededLocalLimit ; import static com.facebook.presto.type.TypeUtils.hashPosition ; import static com.facebook.presto.type.TypeUtils.positionEqualsPosition ; @ @ -32,18 +33,16 @ @ import static java.util.Objects.requireNonNull ; public class TypedSet { private static final int INSTANCE_SIZE = ClassLayout.parseClass ( TypedSet.class ) .instanceSize ( ) ; - private static final int INT_ARRAY_LIST_INSTANCE_SIZE = ClassLayout.parseClass ( IntArrayList.class ) .instanceSize ( ) ; private static final float FILL_RATIO = 0.75f ; private static final long FOUR_MEGABYTES = new DataSize ( 4 , MEGABYTE ) .toBytes ( ) ; + private static final int EMPTY_SLOT = -1 ; private final Type elementType ; - private final IntArrayList blockPositionByHash ; private final BlockBuilder elementBlock ; + private int [ ] blockPositionByHash ; private int maxFill ; private int hashMask ; - private static final int EMPTY_SLOT = -1 ; - private boolean containsNullElement ; public TypedSet ( Type elementType , int expectedSize ) @ @ -56,18 +55,15 @ @ public class TypedSet this.maxFill = calculateMaxFill ( hashSize ) ; Improve memory performance for MAP_UNION and MAP_AGG __EoT__ When most aggregation keys are different , we have found in some cases ` MAP_UNION ` can take up to 4x memory compared with ` ARRAY_AGG ` . One potential reason could be ` TypedSet ` is not quite memory efficient . A microbenchmark : - Create the dataset : `` ` CREATE TABLE test_id_and_map AS SELECT id , MAP ( ARRAY [ 1 ] , ARRAY [ id ] ) as m FROM ( select sequence ( 1 , 10000000 ) AS seq ) tmp CROSS JOIN UNNEST ( seq ) AS t ( id ) `` ` - The queries : `` ` CREATE TABLE test_map_union AS SELECT id , MAP_UNION ( m ) AS m_agg FROM test_id_and_map GROUP BY id `` ` vs. `` ` CREATE TABLE test_array_agg AS SELECT id , ARRAY_AGG ( m ) AS m_agg FROM test_id_and_map GROUP BY id `` ` The peak memories for this case are 7.07G and 2.38G , respectively .
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/SubqueryPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/SubqueryPlanner.java index a2314f6..cc2b641 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/SubqueryPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/SubqueryPlanner.java @ @ -39,7 +39,6 @ @ import com.facebook.presto.sql.tree.NotExpression ; import com.facebook.presto.sql.tree.QualifiedNameReference ; import com.facebook.presto.sql.tree.QuantifiedComparisonExpression ; import com.facebook.presto.sql.tree.QuantifiedComparisonExpression.Quantifier ; -import com.facebook.presto.sql.tree.Query ; import com.facebook.presto.sql.tree.SubqueryExpression ; import com.facebook.presto.sql.tree.SymbolReference ; import com.google.common.collect.ImmutableList ; @ @ -265,18 +264,21 @ @ class SubqueryPlanner PlanBuilder subqueryPlan = createPlanBuilder ( existsPredicate.getSubquery ( ) ) ; - if ( isAggregationWithEmptyGroupBy ( subqueryPlan.getRoot ( ) ) ) { + PlanNode subqueryPlanRoot = subqueryPlan.getRoot ( ) ; + if ( isAggregationWithEmptyGroupBy ( subqueryPlanRoot ) ) { subPlan.getTranslations ( ) .put ( existsPredicate , BooleanLiteral.TRUE_LITERAL ) ; return subPlan ; } Symbol exists = symbolAllocator.newSymbol ( `` exists '' , BOOLEAN ) ; subPlan.getTranslations ( ) .put ( existsPredicate , exists ) ; + ExistsPredicate rewrittenExistsPredicate = new ExistsPredicate ( + subqueryPlanRoot.getOutputSymbols ( ) .get ( 0 ) .toSymbolReference ( ) ) ; return appendApplyNode ( subPlan , existsPredicate.getSubquery ( ) , subqueryPlan , - Assignments.of ( exists , existsPredicate ) , + Assignments.of ( exists , rewrittenExistsPredicate ) , correlationAllowed ) ; } @ @ -452,30 +454,19 @ @ class SubqueryPlanner return Optional.empty ( ) ; } - private PlanBuilder createPlanBuilder ( Expression expression ) + private Invalid initial plan for EXISTS subquery __EoT__ This query : `` ` sql SELECT orderkey FROM orders WHERE EXISTS ( SELECT orderkey FROM lineitem ) `` ` produces an initial plan with the following shape . Note that the expression in the Apply node contains a full subquery , which is invalid . `` ` - Output [ orderkey ] = > [ expr_9 : bigint ] orderkey : = expr_9 - Project = > [ expr_9 : bigint ] expr_9 : = `` expr_8 '' - Project = > [ expr_8 : bigint ] expr_8 : = `` orderkey_7 '' - Project = > [ orderkey_7 : bigint ] orderkey_7 : = `` orderkey_6 '' - Project = > [ orderkey_6 : bigint ] orderkey_6 : = `` orderkey '' - Filter [ `` exists '' ] = > [ orderkey : bigint , custkey : bigint , orderstatus : varchar ( 1 ) , totalprice : double , orderdate : date , orderpriority : varchar ( 15 ) , clerk : varchar ( 15 ) , shippriority : integer , comment : varchar ( 79 ) , row_number : bigint , exists : boolean ] - Apply [
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/SystemPartitioningHandle.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/SystemPartitioningHandle.java index af302b9..c04930c 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/SystemPartitioningHandle.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/SystemPartitioningHandle.java @ @ -51,7 +51,8 @ @ public final class SystemPartitioningHandle FIXED , SOURCE , SCALED , - COORDINATOR_ONLY + COORDINATOR_ONLY , + ARBITRARY } public static final PartitioningHandle SINGLE_DISTRIBUTION = createSystemPartitioning ( SystemPartitioning.SINGLE , SystemPartitionFunction.SINGLE ) ; @ @ -61,6 +62,7 @ @ public final class SystemPartitioningHandle public static final PartitioningHandle FIXED_BROADCAST_DISTRIBUTION = createSystemPartitioning ( SystemPartitioning.FIXED , SystemPartitionFunction.BROADCAST ) ; public static final PartitioningHandle SCALED_WRITER_DISTRIBUTION = createSystemPartitioning ( SystemPartitioning.SCALED , SystemPartitionFunction.ROUND_ROBIN ) ; public static final PartitioningHandle SOURCE_DISTRIBUTION = createSystemPartitioning ( SystemPartitioning.SOURCE , SystemPartitionFunction.UNKNOWN ) ; + public static final PartitioningHandle ARBITRARY_DISTRIBUTION = createSystemPartitioning ( SystemPartitioning.ARBITRARY , SystemPartitionFunction.UNKNOWN ) ; private static PartitioningHandle createSystemPartitioning ( SystemPartitioning partitioning , SystemPartitionFunction function ) { diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PropertyDerivations.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PropertyDerivations.java index 2449ae1..8e4b037 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PropertyDerivations.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PropertyDerivations.java @ @ -85,6 +85,7 @ @ import java.util.stream.Collectors ; import static com.facebook.presto.SystemSessionProperties.planWithTableNodePartitioning ; import static com.facebook.presto.spi.predicate.TupleDomain.extractFixedValues ; import static com.facebook.presto.sql.analyzer.ExpressionAnalyzer.getExpressionTypes ; +import static com.facebook.presto.sql.planner.SystemPartitioningHandle.ARBITRARY_DISTRIBUTION ; import static com.facebook.presto.sql.planner.optimizations.ActualProperties.Global.arbitraryPartition ; import static com.facebook.presto.sql.planner.optimizations.ActualProperties.Global.coordinatorSingleStreamPartition ; import static com.facebook.presto.sql.planner.optimizations.ActualProperties.Global.partitionedOn ; @ @ -181,7 +182,15 @ @ public class PropertyDerivations @ Override public ActualProperties visitAssignUniqueId ( AssignUniqueId node , List < ActualProperties > inputProperties ) { Release notes for 0.204 __EoT__ Issue to track release notes for next release
diff -- git a/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java b/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java index fd0db39..71e04c2 100644 -- - a/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java +++ b/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java @ @ -42,6 +42,7 @ @ import static com.facebook.presto.benchmark.driver.BenchmarkQueryResult.failResu import static com.facebook.presto.benchmark.driver.BenchmarkQueryResult.passResult ; import static com.facebook.presto.client.OkHttpUtil.setupCookieJar ; import static com.facebook.presto.client.OkHttpUtil.setupSocksProxy ; +import static com.facebook.presto.client.StatementClientFactory.newStatementClient ; import static com.google.common.base.Preconditions.checkArgument ; import static com.google.common.base.Verify.verify ; import static io.airlift.http.client.HttpUriBuilder.uriBuilderFrom ; @ @ -199,7 +200,7 @ @ public class BenchmarkQueryRunner private StatementStats execute ( ClientSession session , String query , Consumer < QueryData > queryDataConsumer , Consumer < QueryError > queryErrorConsumer ) { // start query - try ( StatementClient client = new StatementClient ( okHttpClient , session , query ) ) { + try ( StatementClient client = newStatementClient ( okHttpClient , session , query ) ) { // read query output while ( client.isRunning ( ) ) { queryDataConsumer.accept ( client.currentData ( ) ) ; diff -- git a/presto-cli/src/main/java/com/facebook/presto/cli/Query.java b/presto-cli/src/main/java/com/facebook/presto/cli/Query.java index 2639f8f..cf5ccd5 100644 -- - a/presto-cli/src/main/java/com/facebook/presto/cli/Query.java +++ b/presto-cli/src/main/java/com/facebook/presto/cli/Query.java @ @ -23,7 +23,6 @ @ import com.google.common.base.Splitter ; import com.google.common.base.Strings ; import com.google.common.collect.ImmutableList ; import com.google.common.collect.Lists ; -import io.airlift.log.Logger ; import org.fusesource.jansi.Ansi ; import sun.misc.Signal ; import sun.misc.SignalHandler ; @ @ -51,8 +50,6 @ @ import static java.util.Objects.requireNonNull ; public class Query implements Closeable { - private static final Logger PREPARE statement query failing with 500 error __EoT__ I am trying to run a prepared statement query but I am getting a 500 error in the output . Running the query without preparing it works fine ( there are no parameters to bind ) . This error is occurring on both the Presto CLI tool and in my application . Input : `` ` PREPARE stmt0 FROM < < SELECT query 11.7 kbytes in size > > ; `` ` Output : `` ` java.lang.RuntimeException : Error fetching next at http : //localhost:28881/v1/statement/20180228_143747_01091_gjj7v/1 returned an invalid response : JsonResponse { statusCode=500 , statusMessage=Server Error , headers= { connection= [ close ] } , hasValue=false } [ Error : ] at com.facebook.presto.client.StatementClient.requestFailedException ( StatementClient.java:390 ) at com.facebook.presto.client.StatementClient.advance ( StatementClient.java:333 ) at com.facebook.presto.cli.StatusPrinter.printInitialStatusUpdates ( StatusPrinter.java:122 ) at com.facebook.presto.cli.Query.renderQueryOutput ( Query.java:134 ) at com.facebook.presto.cli.Query.renderOutput ( Query.java:118 ) at com.facebook.presto.cli.Console.process ( Console.java:299 ) at com.facebook.presto.cli.Console.runConsole ( Console.java:251 ) at com.facebook.presto.cli.Console.run ( Console.java:145 ) at com.facebook.presto.cli.Presto.main ( Presto.java:32 ) Query is gone ( server restarted ? ) `` ` There is no indication that the query failed in the presto UI or in the server.log file . It is marked as finished . Perhaps there
diff -- git a/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java b/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java index fd0db39..71e04c2 100644 -- - a/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java +++ b/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java @ @ -42,6 +42,7 @ @ import static com.facebook.presto.benchmark.driver.BenchmarkQueryResult.failResu import static com.facebook.presto.benchmark.driver.BenchmarkQueryResult.passResult ; import static com.facebook.presto.client.OkHttpUtil.setupCookieJar ; import static com.facebook.presto.client.OkHttpUtil.setupSocksProxy ; +import static com.facebook.presto.client.StatementClientFactory.newStatementClient ; import static com.google.common.base.Preconditions.checkArgument ; import static com.google.common.base.Verify.verify ; import static io.airlift.http.client.HttpUriBuilder.uriBuilderFrom ; @ @ -199,7 +200,7 @ @ public class BenchmarkQueryRunner private StatementStats execute ( ClientSession session , String query , Consumer < QueryData > queryDataConsumer , Consumer < QueryError > queryErrorConsumer ) { // start query - try ( StatementClient client = new StatementClient ( okHttpClient , session , query ) ) { + try ( StatementClient client = newStatementClient ( okHttpClient , session , query ) ) { // read query output while ( client.isRunning ( ) ) { queryDataConsumer.accept ( client.currentData ( ) ) ; diff -- git a/presto-cli/src/main/java/com/facebook/presto/cli/Query.java b/presto-cli/src/main/java/com/facebook/presto/cli/Query.java index 2639f8f..cf5ccd5 100644 -- - a/presto-cli/src/main/java/com/facebook/presto/cli/Query.java +++ b/presto-cli/src/main/java/com/facebook/presto/cli/Query.java @ @ -23,7 +23,6 @ @ import com.google.common.base.Splitter ; import com.google.common.base.Strings ; import com.google.common.collect.ImmutableList ; import com.google.common.collect.Lists ; -import io.airlift.log.Logger ; import org.fusesource.jansi.Ansi ; import sun.misc.Signal ; import sun.misc.SignalHandler ; @ @ -51,8 +50,6 @ @ import static java.util.Objects.requireNonNull ; public class Query implements Closeable { - private static final Logger PREPARE statement query failing with 500 error __EoT__ I am trying to run a prepared statement query but I am getting a 500 error in the output . Running the query without preparing it works fine ( there are no parameters to bind ) . This error is occurring on both the Presto CLI tool and in my application . Input : `` ` PREPARE stmt0 FROM < < SELECT query 11.7 kbytes in size > > ; `` ` Output : `` ` java.lang.RuntimeException : Error fetching next at http : //localhost:28881/v1/statement/20180228_143747_01091_gjj7v/1 returned an invalid response : JsonResponse { statusCode=500 , statusMessage=Server Error , headers= { connection= [ close ] } , hasValue=false } [ Error : ] at com.facebook.presto.client.StatementClient.requestFailedException ( StatementClient.java:390 ) at com.facebook.presto.client.StatementClient.advance ( StatementClient.java:333 ) at com.facebook.presto.cli.StatusPrinter.printInitialStatusUpdates ( StatusPrinter.java:122 ) at com.facebook.presto.cli.Query.renderQueryOutput ( Query.java:134 ) at com.facebook.presto.cli.Query.renderOutput ( Query.java:118 ) at com.facebook.presto.cli.Console.process ( Console.java:299 ) at com.facebook.presto.cli.Console.runConsole ( Console.java:251 ) at com.facebook.presto.cli.Console.run ( Console.java:145 ) at com.facebook.presto.cli.Presto.main ( Presto.java:32 ) Query is gone ( server restarted ? ) `` ` There is no indication that the query failed in the presto UI or in the server.log file . It is marked as finished . Perhaps there
diff -- git a/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java b/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java index fd0db39..71e04c2 100644 -- - a/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java +++ b/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java @ @ -42,6 +42,7 @ @ import static com.facebook.presto.benchmark.driver.BenchmarkQueryResult.failResu import static com.facebook.presto.benchmark.driver.BenchmarkQueryResult.passResult ; import static com.facebook.presto.client.OkHttpUtil.setupCookieJar ; import static com.facebook.presto.client.OkHttpUtil.setupSocksProxy ; +import static com.facebook.presto.client.StatementClientFactory.newStatementClient ; import static com.google.common.base.Preconditions.checkArgument ; import static com.google.common.base.Verify.verify ; import static io.airlift.http.client.HttpUriBuilder.uriBuilderFrom ; @ @ -199,7 +200,7 @ @ public class BenchmarkQueryRunner private StatementStats execute ( ClientSession session , String query , Consumer < QueryData > queryDataConsumer , Consumer < QueryError > queryErrorConsumer ) { // start query - try ( StatementClient client = new StatementClient ( okHttpClient , session , query ) ) { + try ( StatementClient client = newStatementClient ( okHttpClient , session , query ) ) { // read query output while ( client.isRunning ( ) ) { queryDataConsumer.accept ( client.currentData ( ) ) ; diff -- git a/presto-cli/src/main/java/com/facebook/presto/cli/Query.java b/presto-cli/src/main/java/com/facebook/presto/cli/Query.java index 2639f8f..cf5ccd5 100644 -- - a/presto-cli/src/main/java/com/facebook/presto/cli/Query.java +++ b/presto-cli/src/main/java/com/facebook/presto/cli/Query.java @ @ -23,7 +23,6 @ @ import com.google.common.base.Splitter ; import com.google.common.base.Strings ; import com.google.common.collect.ImmutableList ; import com.google.common.collect.Lists ; -import io.airlift.log.Logger ; import org.fusesource.jansi.Ansi ; import sun.misc.Signal ; import sun.misc.SignalHandler ; @ @ -51,8 +50,6 @ @ import static java.util.Objects.requireNonNull ; public class Query implements Closeable { - private static final Logger PREPARE statement query failing with 500 error __EoT__ I am trying to run a prepared statement query but I am getting a 500 error in the output . Running the query without preparing it works fine ( there are no parameters to bind ) . This error is occurring on both the Presto CLI tool and in my application . Input : `` ` PREPARE stmt0 FROM < < SELECT query 11.7 kbytes in size > > ; `` ` Output : `` ` java.lang.RuntimeException : Error fetching next at http : //localhost:28881/v1/statement/20180228_143747_01091_gjj7v/1 returned an invalid response : JsonResponse { statusCode=500 , statusMessage=Server Error , headers= { connection= [ close ] } , hasValue=false } [ Error : ] at com.facebook.presto.client.StatementClient.requestFailedException ( StatementClient.java:390 ) at com.facebook.presto.client.StatementClient.advance ( StatementClient.java:333 ) at com.facebook.presto.cli.StatusPrinter.printInitialStatusUpdates ( StatusPrinter.java:122 ) at com.facebook.presto.cli.Query.renderQueryOutput ( Query.java:134 ) at com.facebook.presto.cli.Query.renderOutput ( Query.java:118 ) at com.facebook.presto.cli.Console.process ( Console.java:299 ) at com.facebook.presto.cli.Console.runConsole ( Console.java:251 ) at com.facebook.presto.cli.Console.run ( Console.java:145 ) at com.facebook.presto.cli.Presto.main ( Presto.java:32 ) Query is gone ( server restarted ? ) `` ` There is no indication that the query failed in the presto UI or in the server.log file . It is marked as finished . Perhaps there
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/EqualityInference.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/EqualityInference.java index cdd64fd..83b3c49 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/EqualityInference.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/EqualityInference.java @ @ -62,7 +62,7 @ @ public class EqualityInference // Current cost heuristic : // 1 ) Prefer fewer input symbols // 2 ) Prefer smaller expression trees - // 3 ) Ordering.arbitrary ( ) - creates a stable consistent ordering ( extremely useful for unit testing ) + // 3 ) Sort the expressions alphabetically - creates a stable consistent ordering ( extremely useful for unit testing ) // TODO : be more precise in determining the cost of an expression return ComparisonChain.start ( ) .compare ( DependencyExtractor.extractAll ( expression1 ) .size ( ) , DependencyExtractor.extractAll ( expression2 ) .size ( ) ) diff -- git a/presto-tests/src/main/java/com/facebook/presto/tests/PlanDeterminismChecker.java b/presto-tests/src/main/java/com/facebook/presto/tests/PlanDeterminismChecker.java new file mode 100644 index 0000000..b5eb7f9 -- - /dev/null +++ b/presto-tests/src/main/java/com/facebook/presto/tests/PlanDeterminismChecker.java @ @ -0,0 +1,62 @ @ +/* + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or Query plans not deterministic __EoT__ There are cases where subsequent executions of a query differ because of the query plan being created in a non-deterministic way . The simplest example we 've spotted so far is : `` ` SELECT COUNT ( * ) FROM part ps , supplier l WHERE ps.comment = l.comment AND ps.brand = l.address `` ` which produces at least two different plans : `` ` - Output [ _col0 ] = > [ count : bigint ] _col0 : = count - Aggregate ( FINAL ) = > [ count : bigint ] count : = `` count '' ( `` count_10 '' ) - LocalExchange [ SINGLE ] ( ) = > count_10 : bigint - Aggregate ( PARTIAL ) = > [ count_11 : bigint ] count_11 : = `` count '' ( * ) - Project = > [ ] - InnerJoin [ ( `` comment '' = `` comment_1 '' ) AND ( `` brand '' = `` address '' ) ] [ $ hashvalue , $ hashvalue_12 ] = > [ brand : varchar ( 10 ) , comment : varchar ( 23 ) , $ hashvalue : bigint ,
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/gen/ExpressionCompiler.java b/presto-main/src/main/java/com/facebook/presto/sql/gen/ExpressionCompiler.java index ec012e2..f8eb31b 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/gen/ExpressionCompiler.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/gen/ExpressionCompiler.java @ @ -23,6 +23,7 @ @ import com.facebook.presto.sql.relational.RowExpression ; import com.google.common.base.Throwables ; import com.google.common.cache.CacheBuilder ; import com.google.common.cache.CacheLoader ; +import com.google.common.cache.CacheStats ; import com.google.common.cache.LoadingCache ; import com.google.common.collect.ImmutableList ; import org.weakref.jmx.Managed ; @ @ -47,7 +48,7 @ @ public class ExpressionCompiler { private final Metadata metadata ; - private final LoadingCache < CacheKey , Class < ? extends PageProcessor > > pageProcessors = CacheBuilder.newBuilder ( ) .maximumSize ( 1000 ) .build ( + private final LoadingCache < CacheKey , Class < ? extends PageProcessor > > pageProcessors = CacheBuilder.newBuilder ( ) .recordStats ( ) .maximumSize ( 1000 ) .build ( new CacheLoader < CacheKey , Class < ? extends PageProcessor > > ( ) { @ Override @ @ -58,7 +59,7 @ @ public class ExpressionCompiler } } ) ; - private final LoadingCache < CacheKey , Class < ? extends CursorProcessor > > cursorProcessors = CacheBuilder.newBuilder ( ) .maximumSize ( 1000 ) .build ( + private final LoadingCache < CacheKey , Class < ? extends CursorProcessor > > cursorProcessors = CacheBuilder.newBuilder ( ) .recordStats ( ) .maximumSize ( 1000 ) .build ( new CacheLoader < CacheKey , Class Add hit/miss metrics for compiled code caches __EoT__ I suspect that the caches for compiled code are not very effective for large , varied workloads . We should add cache hit/miss metrics and expose them via JMX to be able to test this hypothesis . Classes that need to be instrumented : ExpressionCompiler , JoinCompiler , JoinFilterFunctionCompiler , JoinProbeCompiler , OrderingCompiler
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/gen/CacheStatsMBean.java b/presto-main/src/main/java/com/facebook/presto/sql/gen/CacheStatsMBean.java new file mode 100644 index 0000000..74fb5ac -- - /dev/null +++ b/presto-main/src/main/java/com/facebook/presto/sql/gen/CacheStatsMBean.java @ @ -0,0 +1,40 @ @ +/* + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ +package com.facebook.presto.sql.gen ; + +import com.google.common.cache.CacheStats ; +import org.weakref.jmx.Managed ; + +public class CacheStatsMBean + { + private final CacheStats cacheStats ; + + public CacheStatsMBean ( CacheStats cacheStats ) + { + this.cacheStats = cacheStats ; + } + + @ Managed + public Double getHitRate ( ) + { + return cacheStats.hitRate ( ) ; + } Add hit/miss metrics for compiled code caches __EoT__ I suspect that the caches for compiled code are not very effective for large , varied workloads . We should add cache hit/miss metrics and expose them via JMX to be able to test this hypothesis . Classes that need to be instrumented : ExpressionCompiler , JoinCompiler , JoinFilterFunctionCompiler , JoinProbeCompiler , OrderingCompiler
diff -- git a/presto-main/src/main/java/com/facebook/presto/server/OutputStreamSliceOutputAdapter.java b/presto-main/src/main/java/com/facebook/presto/server/OutputStreamSliceOutputAdapter.java new file mode 100644 index 0000000..dd04a4e -- - /dev/null +++ b/presto-main/src/main/java/com/facebook/presto/server/OutputStreamSliceOutputAdapter.java @ @ -0,0 +1,355 @ @ +/* + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ +package com.facebook.presto.server ; + +import io.airlift.slice.RuntimeIOException ; +import io.airlift.slice.Slice ; +import io.airlift.slice.SliceOutput ; +import io.airlift.slice.Slices ; +import org.openjdk.jol.info.ClassLayout ; + +import java.io.IOException ; +import java.io.InputStream ; +import java.io.OutputStream ; +import java.nio.charset.Charset ; +import java.util.Arrays ; + +import static com.google.common.base.Preconditions.checkArgument ; +import static com.google.common.primitives.Ints.checkedCast ; +import static io.airlift.slice.SizeOf.SIZE_OF_BYTE ; +import static io.airlift.slice.SizeOf.SIZE_OF_DOUBLE ; +import static io.airlift.slice.SizeOf.SIZE_OF_FLOAT ; +import static io.airlift.slice.SizeOf.SIZE_OF_INT Performance degradation for a specific query from 0.139 to 0.149 __EoT__ I am seeing a performance degradation of 10-15 % for a limit query when I test ` 0.149 ` against ` 0.139 ` . There are a few differences in the plans produced by these versions . I see that the plan in ` 0.149 ` has two additional project operators in stage 0 and 1 applying the same projection while ` 0.139 ` do n't have those . Also I see that the filter expressions differ quite a bit , but not sure whether that will affect the performance much . [ Here ] ( https : //gist.github.com/nezihyigitbasi/aa9c222c644c86f9163a83a5c9800443 ) is the query , the plan in [ 0.139 ] ( https : //gist.github.com/nezihyigitbasi/ce0cb2914c9c8635bb737ad8161237f2 ) and the plan in [ 0.149 ] ( https : //gist.github.com/nezihyigitbasi/7965d784633cda268c2763d85617a6ed ) . Any insights appreciated .
diff -- git a/presto-jdbc/src/main/java/com/facebook/presto/jdbc/ConnectionParameters.java b/presto-jdbc/src/main/java/com/facebook/presto/jdbc/ConnectionParameters.java new file mode 100644 index 0000000..c2c3920 -- - /dev/null +++ b/presto-jdbc/src/main/java/com/facebook/presto/jdbc/ConnectionParameters.java @ @ -0,0 +1,169 @ @ +/* + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ +package com.facebook.presto.jdbc ; + +import com.google.common.base.Splitter ; +import com.google.common.net.HostAndPort ; + +import java.net.URI ; +import java.net.URISyntaxException ; +import java.sql.SQLException ; +import java.util.HashMap ; +import java.util.List ; +import java.util.Map ; + +import static com.google.common.base.Strings.isNullOrEmpty ; +import static io.airlift.http.client.HttpUriBuilder.uriBuilder ; + +/** + * Container for parameters of a JDBC connection . The class is also responsible for parsing Presto JDBC HTTPS port is hardcoded __EoT__ Currently HTTPS port is hard coded and value 443 does not allowed for ordinary user , What about introducing jdbc url parameter say jdbc : presto : //host:8443/catalog/schema ? protocol=https .src/main/java/com/facebook/presto/jdbc/PrestoConnection.java `` ` String scheme = ( address.getPort ( ) == 443 ) ? `` https '' : `` http '' ; List < NameValuePair > kv = null ; try { if ( uri ! = null ) { kv = URLEncodedUtils.parse ( uri , `` ASCII '' ) ; if ( kv.contains ( new BasicNameValuePair ( `` protocol '' , `` https '' ) ) ) { scheme = `` https '' ; } } } catch ( Exception e ) { } `` `
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/QueryPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/QueryPlanner.java index 00c7e7e..c6d9467 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/QueryPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/QueryPlanner.java @ @ -560,6 +560,7 @ @ class QueryPlanner subPlan.getRoot ( ) , aggregations , groupingSymbols , + ImmutableList.of ( ) , AggregationNode.Step.SINGLE , Optional.empty ( ) , groupIdSymbol ) ; @ @ -770,6 +771,7 @ @ class QueryPlanner subPlan.getRoot ( ) , ImmutableMap.of ( ) , ImmutableList.of ( subPlan.getRoot ( ) .getOutputSymbols ( ) ) , + ImmutableList.of ( ) , AggregationNode.Step.SINGLE , Optional.empty ( ) , Optional.empty ( ) ) ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java index ef66649..dde7e66 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java @ @ -813,6 +813,7 @ @ class RelationPlanner node , ImmutableMap.of ( ) , ImmutableList.of ( node.getOutputSymbols ( ) ) , + ImmutableList.of ( ) , AggregationNode.Step.SINGLE , Optional.empty ( ) , Optional.empty ( ) ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/AddIntermediateAggregations.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/AddIntermediateAggregations.java index 8f2c4ea..0aaaaf7 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/AddIntermediateAggregations.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/AddIntermediateAggregations.java @ @ -117,6 +117,7 @ @ public class AddIntermediateAggregations source , inputsAsOutputs ( aggregation.getAggregations ( ) ) , aggregation.getGroupingSets ( ) , + aggregation.getPreGroupedSymbols ( ) , AggregationNode.Step.INTERMEDIATE , aggregation.getHashSymbol ( ) , aggregation.getGroupIdSymbol ( ) ) ; @ @ -159,6 +160,7 @ @ public class AddIntermediateAggregations gatheringExchange , outputsAsInputs ( Partial aggregation is missing when filter reduces the data to a single group __EoT__ The plan for the following query is missing partial aggregation making it so that aggregation happens very slowly on a single node . This looks like a regression caused by # 10731 `` ` explain select sum ( totalprice ) , orderstatus from orders where orderstatus='O ' group by orderstatus ; - Output [ _col0 , orderstatus ] = > [ sum : double , orderstatus : varchar ( 1 ) ] Cost : { rows : 1 ( 20B ) , cpu : 1026620.00 , memory : 20.00 , network : 220010.00 } _col0 : = sum - RemoteExchange [ GATHER ] = > orderstatus : varchar ( 1 ) , sum : double Cost : { rows : 1 ( 20B ) , cpu : 1026620.00 , memory : 20.00 , network : 220010.00 } - Aggregate ( STREAMING ) [ orderstatus ] = > [ orderstatus : varchar ( 1 ) , sum : double ] Cost : { rows : 1 ( 20B ) , cpu : 1026620.00 , memory : 20.00 , network : 219990.00 } sum : = `` sum
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/QueryPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/QueryPlanner.java index 00c7e7e..c6d9467 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/QueryPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/QueryPlanner.java @ @ -560,6 +560,7 @ @ class QueryPlanner subPlan.getRoot ( ) , aggregations , groupingSymbols , + ImmutableList.of ( ) , AggregationNode.Step.SINGLE , Optional.empty ( ) , groupIdSymbol ) ; @ @ -770,6 +771,7 @ @ class QueryPlanner subPlan.getRoot ( ) , ImmutableMap.of ( ) , ImmutableList.of ( subPlan.getRoot ( ) .getOutputSymbols ( ) ) , + ImmutableList.of ( ) , AggregationNode.Step.SINGLE , Optional.empty ( ) , Optional.empty ( ) ) ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java index ef66649..dde7e66 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java @ @ -813,6 +813,7 @ @ class RelationPlanner node , ImmutableMap.of ( ) , ImmutableList.of ( node.getOutputSymbols ( ) ) , + ImmutableList.of ( ) , AggregationNode.Step.SINGLE , Optional.empty ( ) , Optional.empty ( ) ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/AddIntermediateAggregations.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/AddIntermediateAggregations.java index 8f2c4ea..0aaaaf7 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/AddIntermediateAggregations.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/AddIntermediateAggregations.java @ @ -117,6 +117,7 @ @ public class AddIntermediateAggregations source , inputsAsOutputs ( aggregation.getAggregations ( ) ) , aggregation.getGroupingSets ( ) , + aggregation.getPreGroupedSymbols ( ) , AggregationNode.Step.INTERMEDIATE , aggregation.getHashSymbol ( ) , aggregation.getGroupIdSymbol ( ) ) ; @ @ -159,6 +160,7 @ @ public class AddIntermediateAggregations gatheringExchange , outputsAsInputs ( Partial aggregation is missing when filter reduces the data to a single group __EoT__ The plan for the following query is missing partial aggregation making it so that aggregation happens very slowly on a single node . This looks like a regression caused by # 10731 `` ` explain select sum ( totalprice ) , orderstatus from orders where orderstatus='O ' group by orderstatus ; - Output [ _col0 , orderstatus ] = > [ sum : double , orderstatus : varchar ( 1 ) ] Cost : { rows : 1 ( 20B ) , cpu : 1026620.00 , memory : 20.00 , network : 220010.00 } _col0 : = sum - RemoteExchange [ GATHER ] = > orderstatus : varchar ( 1 ) , sum : double Cost : { rows : 1 ( 20B ) , cpu : 1026620.00 , memory : 20.00 , network : 220010.00 } - Aggregate ( STREAMING ) [ orderstatus ] = > [ orderstatus : varchar ( 1 ) , sum : double ] Cost : { rows : 1 ( 20B ) , cpu : 1026620.00 , memory : 20.00 , network : 219990.00 } sum : = `` sum
diff -- git a/presto-thrift-connector/src/main/java/com/facebook/presto/connector/thrift/ThriftMetadata.java b/presto-thrift-connector/src/main/java/com/facebook/presto/connector/thrift/ThriftMetadata.java index c38f474..837276d 100644 -- - a/presto-thrift-connector/src/main/java/com/facebook/presto/connector/thrift/ThriftMetadata.java +++ b/presto-thrift-connector/src/main/java/com/facebook/presto/connector/thrift/ThriftMetadata.java @ @ -208,8 +208,17 @ @ public class ThriftMetadata private PrestoThriftNullableTableMetadata getTableMetadata ( SchemaTableName schemaTableName ) { + // treat invalid names as not found + PrestoThriftSchemaTableName name ; try { - return client.get ( ) .getTableMetadata ( new PrestoThriftSchemaTableName ( schemaTableName ) ) ; + name = new PrestoThriftSchemaTableName ( schemaTableName ) ; + } + catch ( IllegalArgumentException e ) { + return new PrestoThriftNullableTableMetadata ( null ) ; + } + + try { + return client.get ( ) .getTableMetadata ( name ) ; } catch ( PrestoThriftServiceException | TException e ) { throw toPrestoException ( e ) ; SHOW PARTITIONS should avoid partitions scan limit __EoT__ When the user wants to lists all the partitions it should not use a read partitions count limit as there is these partitions are not going to be read . `` ` presto : xxx > show partitions in some_table where event_dt=date'2017-05-01 ' ; event_dt | hash_prtn_nb -- -- -- -- -- -- + -- -- -- -- -- -- -- 2017-05-01 | 0 2017-05-01 | 1 2017-05-01 | 2 ... . presto : xxx > show partitions in some_table limit 5 ; Query 20180305_204534_00022_sc8vc failed : Query over table 'some_table ' can potentially read more than 100000 partitions `` ` This error should be thrown only when query is going to scan these partitions . Maybe this check should be moved to ` HiveSplitManager ` ? CC : @ electrum @ findepi
diff -- git a/presto-docs/src/main/sphinx/functions/string.rst b/presto-docs/src/main/sphinx/functions/string.rst index fcf6d76..2a544d2 100644 -- - a/presto-docs/src/main/sphinx/functions/string.rst +++ b/presto-docs/src/main/sphinx/functions/string.rst @ @ -46,12 +46,6 @ @ String Functions Converts `` string `` to lowercase . -.. note : : - - This method does not perform perform locale-sensitive , context-sensitive , - or one-to-many mappings required for some languages . Specifically , this - will return incorrect results for Lithuanian , Turkish and Azeri . - .. function : : ltrim ( string ) - > varchar Removes leading whitespace from `` string `` . diff -- git a/presto-docs/src/main/sphinx/sql/create-table.rst b/presto-docs/src/main/sphinx/sql/create-table.rst index dc92c4d..d3da5e4 100644 -- - a/presto-docs/src/main/sphinx/sql/create-table.rst +++ b/presto-docs/src/main/sphinx/sql/create-table.rst @ @ -7,7 +7,7 @ @ Synopsis .. code-block : : none - CREATE TABLE table_name ( + CREATE TABLE [ IF NOT EXISTS ] table_name ( column_name data_type [ , ... ] ) @ @ -17,6 +17,9 @ @ Description Create a new , empty table with the specified columns . Use : doc : ` create-table-as ` to create a table with data . +The optional `` IF NOT EXISTS `` clause causes the error to be +suppressed if the table already exists . + Examples -- -- -- -- @ @ -28,3 +31,12 @ @ Create Add more failure info to QueryCompletionEvent __EoT__ We need to know the task ID and the machine on which the failure occurred . This helps with finding logs related to a failure , correlating machines with higher than average failure counts , etc .
diff -- git a/pom.xml b/pom.xml index b137d77..32bde44 100644 -- - a/pom.xml +++ b/pom.xml @ @ -42,7 +42,7 @ @ < air.check.fail-checkstyle > true < /air.check.fail-checkstyle > < air.check.skip-checkstyle > false < /air.check.skip-checkstyle > - < dep.antlr.version > 4.3 < /dep.antlr.version > + < dep.antlr.version > 4.5.1 < /dep.antlr.version > < dep.airlift.version > 0.112 < /dep.airlift.version > < dep.packaging.version > $ { dep.airlift.version } < /dep.packaging.version > < dep.slice.version > 0.14 < /dep.slice.version > @ @ -496,12 +496,6 @ @ < /dependency > < dependency > - < groupId > org.antlr < /groupId > - < artifactId > antlr4-annotations < /artifactId > - < version > $ { dep.antlr.version } < /version > - < /dependency > - - < dependency > < groupId > jline < /groupId > < artifactId > jline < /artifactId > < version > 2.12 < /version > diff -- git a/presto-cassandra/src/test/java/com/facebook/presto/cassandra/TestCassandraDistributed.java b/presto-cassandra/src/test/java/com/facebook/presto/cassandra/TestCassandraDistributed.java index 8501029..e80de18 100644 -- - a/presto-cassandra/src/test/java/com/facebook/presto/cassandra/TestCassandraDistributed.java +++ b/presto-cassandra/src/test/java/com/facebook/presto/cassandra/TestCassandraDistributed.java @ @ -78,4 +78,11 @ @ public class TestCassandraDistributed { // Cassandra connector currently does not support delete } + + @ Override + public void testDeleteSemiJoin ( ) + throws Exception + { + // Cassandra connector currently does not support delete + } Add more failure info to QueryCompletionEvent __EoT__ We need to know the task ID and the machine on which the failure occurred . This helps with finding logs related to a failure , correlating machines with higher than average failure counts , etc .
diff -- git a/presto-base-jdbc/src/main/java/com/facebook/presto/plugin/jdbc/BaseJdbcClient.java b/presto-base-jdbc/src/main/java/com/facebook/presto/plugin/jdbc/BaseJdbcClient.java index c9bc1b0..41cf694 100644 -- - a/presto-base-jdbc/src/main/java/com/facebook/presto/plugin/jdbc/BaseJdbcClient.java +++ b/presto-base-jdbc/src/main/java/com/facebook/presto/plugin/jdbc/BaseJdbcClient.java @ @ -432,7 +432,9 @ @ public class BaseJdbcClient case Types.BOOLEAN : return BOOLEAN ; case Types.TINYINT : + return TINYINT ; case Types.SMALLINT : + return SMALLINT ; case Types.INTEGER : return INTEGER ; case Types.BIGINT : diff -- git a/presto-mysql/src/main/java/com/facebook/presto/plugin/mysql/MySqlClient.java b/presto-mysql/src/main/java/com/facebook/presto/plugin/mysql/MySqlClient.java index 2d032de..3b93dab 100644 -- - a/presto-mysql/src/main/java/com/facebook/presto/plugin/mysql/MySqlClient.java +++ b/presto-mysql/src/main/java/com/facebook/presto/plugin/mysql/MySqlClient.java @ @ -47,6 +47,7 @ @ public class MySqlClient connectionProperties.setProperty ( `` nullCatalogMeansCurrent '' , `` false '' ) ; connectionProperties.setProperty ( `` useUnicode '' , `` true '' ) ; connectionProperties.setProperty ( `` characterEncoding '' , `` utf8 '' ) ; + connectionProperties.setProperty ( `` tinyInt1isBit '' , `` false '' ) ; if ( mySqlConfig.isAutoReconnect ( ) ) { connectionProperties.setProperty ( `` autoReconnect '' , String.valueOf ( mySqlConfig.isAutoReconnect ( ) ) ) ; connectionProperties.setProperty ( `` maxReconnects '' , String.valueOf ( mySqlConfig.getMaxReconnects ( ) ) ) ; diff -- git a/presto-mysql/src/test/java/com/facebook/presto/plugin/mysql/TestMySqlDistributedQueries.java b/presto-mysql/src/test/java/com/facebook/presto/plugin/mysql/TestMySqlDistributedQueries.java index 5a6dfd6..a366eb0 100644 -- - a/presto-mysql/src/test/java/com/facebook/presto/plugin/mysql/TestMySqlDistributedQueries.java +++ b/presto-mysql/src/test/java/com/facebook/presto/plugin/mysql/TestMySqlDistributedQueries.java @ @ -15,6 +15,7 @ @ package com.facebook.presto.plugin.mysql ; import com.facebook.presto.spi.type.VarcharType ; import com.facebook.presto.testing.MaterializedResult ; +import com.facebook.presto.testing.MaterializedRow ; import com.facebook.presto.tests.AbstractTestQueries ; import com.facebook.presto.tests.datatype.CreateAndInsertDataSetup ; import com.facebook.presto.tests.datatype.CreateAsSelectDataSetup ; @ @ -33,12 +34,14 @ @ import tinyint ( 1 ) treated as bool but the actual value is int __EoT__ run sql return `` Operator EQUAL ( boolean , bigint ) not registered ''
diff -- git a/presto-main/src/main/java/com/facebook/presto/FullConnectorSession.java b/presto-main/src/main/java/com/facebook/presto/FullConnectorSession.java index b7c817b..46ef7fb 100644 -- - a/presto-main/src/main/java/com/facebook/presto/FullConnectorSession.java +++ b/presto-main/src/main/java/com/facebook/presto/FullConnectorSession.java @ @ -43,6 +43,7 @ @ public class FullConnectorSession private final ConnectorId connectorId ; private final String catalog ; private final SessionPropertyManager sessionPropertyManager ; + private final boolean isLegacyTimestamp ; public FullConnectorSession ( String queryId , @ @ -50,7 +51,8 @ @ public class FullConnectorSession Optional < String > source , TimeZoneKey timeZoneKey , Locale locale , - long startTime ) + long startTime , + boolean isLegacyTimestamp ) { this.queryId = requireNonNull ( queryId , `` queryId is null '' ) ; this.identity = requireNonNull ( identity , `` identity is null '' ) ; @ @ -63,6 +65,7 @ @ public class FullConnectorSession this.connectorId = null ; this.catalog = null ; this.sessionPropertyManager = null ; + this.isLegacyTimestamp = isLegacyTimestamp ; } public FullConnectorSession ( @ @ -75,7 +78,8 @ @ public class FullConnectorSession Map < String , String > properties , ConnectorId connectorId , String catalog , - SessionPropertyManager sessionPropertyManager ) + SessionPropertyManager sessionPropertyManager , + boolean isLegacyTimestamp ) { this.queryId = requireNonNull ( queryId , `` queryId is null '' ) ; this.identity = requireNonNull ( identity , `` identity is null '' ) TIMESTAMP WITH TIME ZONE and TIME WITH TIME ZONE equality does n't conform to standard __EoT__ SQL 2003 says > TIME — contains the < primary datetime field > s HOUR , MINUTE , and SECOND . > TIMESTAMP — contains the < primary datetime field > s YEAR , MONTH , DAY , HOUR , MINUTE , and SECOND . ( this listing was n't suppose to cover ` TIMEZONE_HOUR ` , ` TIMEZONE_MINUTE ` fields present in the ` WITH TIME ZONE ` data types ) > Items of type datetime are comparable only if they have the same < primary datetime field > s . * My understanding is that the TIME and TIMESTAMP equality ` = ` ( and comparisons ` < , > ` ) should be based on those fields . * This is further reinforced by reasoning that if values are printed differently , then they are different ( not equal ) * ... and that if ` a = b ` , then ` hour ( a ) = hour ( b ) ` ( which does n't hold today ) Thus the following should return ` false ` , but they
diff -- git a/presto-main/src/main/java/com/facebook/presto/FullConnectorSession.java b/presto-main/src/main/java/com/facebook/presto/FullConnectorSession.java index b7c817b..46ef7fb 100644 -- - a/presto-main/src/main/java/com/facebook/presto/FullConnectorSession.java +++ b/presto-main/src/main/java/com/facebook/presto/FullConnectorSession.java @ @ -43,6 +43,7 @ @ public class FullConnectorSession private final ConnectorId connectorId ; private final String catalog ; private final SessionPropertyManager sessionPropertyManager ; + private final boolean isLegacyTimestamp ; public FullConnectorSession ( String queryId , @ @ -50,7 +51,8 @ @ public class FullConnectorSession Optional < String > source , TimeZoneKey timeZoneKey , Locale locale , - long startTime ) + long startTime , + boolean isLegacyTimestamp ) { this.queryId = requireNonNull ( queryId , `` queryId is null '' ) ; this.identity = requireNonNull ( identity , `` identity is null '' ) ; @ @ -63,6 +65,7 @ @ public class FullConnectorSession this.connectorId = null ; this.catalog = null ; this.sessionPropertyManager = null ; + this.isLegacyTimestamp = isLegacyTimestamp ; } public FullConnectorSession ( @ @ -75,7 +78,8 @ @ public class FullConnectorSession Map < String , String > properties , ConnectorId connectorId , String catalog , - SessionPropertyManager sessionPropertyManager ) + SessionPropertyManager sessionPropertyManager , + boolean isLegacyTimestamp ) { this.queryId = requireNonNull ( queryId , `` queryId is null '' ) ; this.identity = requireNonNull ( identity , `` identity is null '' ) TIMESTAMP WITH TIME ZONE and TIME WITH TIME ZONE equality does n't conform to standard __EoT__ SQL 2003 says > TIME — contains the < primary datetime field > s HOUR , MINUTE , and SECOND . > TIMESTAMP — contains the < primary datetime field > s YEAR , MONTH , DAY , HOUR , MINUTE , and SECOND . ( this listing was n't suppose to cover ` TIMEZONE_HOUR ` , ` TIMEZONE_MINUTE ` fields present in the ` WITH TIME ZONE ` data types ) > Items of type datetime are comparable only if they have the same < primary datetime field > s . * My understanding is that the TIME and TIMESTAMP equality ` = ` ( and comparisons ` < , > ` ) should be based on those fields . * This is further reinforced by reasoning that if values are printed differently , then they are different ( not equal ) * ... and that if ` a = b ` , then ` hour ( a ) = hour ( b ) ` ( which does n't hold today ) Thus the following should return ` false ` , but they
diff -- git a/presto-main/src/main/java/com/facebook/presto/execution/MemoryRevokingScheduler.java b/presto-main/src/main/java/com/facebook/presto/execution/MemoryRevokingScheduler.java new file mode 100644 index 0000000..3dee15d -- - /dev/null +++ b/presto-main/src/main/java/com/facebook/presto/execution/MemoryRevokingScheduler.java @ @ -0,0 +1,103 @ @ +/* + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ +package com.facebook.presto.execution ; + +import com.facebook.presto.memory.LocalMemoryManager ; +import com.facebook.presto.memory.QueryContext ; +import com.facebook.presto.memory.TraversingQueryContextVisitor ; +import com.facebook.presto.operator.OperatorContext ; +import com.google.common.collect.Ordering ; + +import javax.inject.Inject ; + +import java.util.Collection ; +import java.util.concurrent.atomic.AtomicLong ; + +import static java.util.Objects.requireNonNull ; + +public class MemoryRevokingScheduler + { + private static final Ordering < SqlTask > ORDER_BY_CREATE_TIME = Ordering.natural ( ) .onResultOf ( task - > Data spilling in join __EoT__ We started to work on data spilling in join . Currently it was mostly conceptual work , not much code yet . Before we start any serious coding we would like to hear you opinion about our idea of how we think it should be done . Here is a design doc : https : //docs.google.com/document/d/1FyT2-2ocOZ6dvzGK70yrUIhd9oucmfnreFWqd3SmfyU/edit # If you notice any problem : our code misunderstanding , performance or correctness issue , please comment there . Our idea is to arrange short meeting once you review above document to discuss that design . Unless everything is obvious and clear then we will just start to code ; ) CC : @ pnowojski @ losipiuk @ martint , @ dain , @ erichwang , @ cberner ( feel free to invite others if I missed someone with context )
diff -- git a/presto-main/src/main/java/com/facebook/presto/execution/MemoryRevokingScheduler.java b/presto-main/src/main/java/com/facebook/presto/execution/MemoryRevokingScheduler.java new file mode 100644 index 0000000..3dee15d -- - /dev/null +++ b/presto-main/src/main/java/com/facebook/presto/execution/MemoryRevokingScheduler.java @ @ -0,0 +1,103 @ @ +/* + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ +package com.facebook.presto.execution ; + +import com.facebook.presto.memory.LocalMemoryManager ; +import com.facebook.presto.memory.QueryContext ; +import com.facebook.presto.memory.TraversingQueryContextVisitor ; +import com.facebook.presto.operator.OperatorContext ; +import com.google.common.collect.Ordering ; + +import javax.inject.Inject ; + +import java.util.Collection ; +import java.util.concurrent.atomic.AtomicLong ; + +import static java.util.Objects.requireNonNull ; + +public class MemoryRevokingScheduler + { + private static final Ordering < SqlTask > ORDER_BY_CREATE_TIME = Ordering.natural ( ) .onResultOf ( task - > Data spilling in join __EoT__ We started to work on data spilling in join . Currently it was mostly conceptual work , not much code yet . Before we start any serious coding we would like to hear you opinion about our idea of how we think it should be done . Here is a design doc : https : //docs.google.com/document/d/1FyT2-2ocOZ6dvzGK70yrUIhd9oucmfnreFWqd3SmfyU/edit # If you notice any problem : our code misunderstanding , performance or correctness issue , please comment there . Our idea is to arrange short meeting once you review above document to discuss that design . Unless everything is obvious and clear then we will just start to code ; ) CC : @ pnowojski @ losipiuk @ martint , @ dain , @ erichwang , @ cberner ( feel free to invite others if I missed someone with context )
diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java index c8e48aa..054e4a8 100644 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java +++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java @ @ -91,6 +91,7 @ @ import static com.facebook.presto.hive.HiveErrorCode.HIVE_WRITER_ERROR ; import static com.facebook.presto.hive.HiveTableProperties.PARTITIONED_BY_PROPERTY ; import static com.facebook.presto.hive.HiveTableProperties.STORAGE_FORMAT_PROPERTY ; import static com.facebook.presto.hive.HiveTableProperties.getHiveStorageFormat ; +import static com.facebook.presto.hive.HiveTableProperties.getHiveTableType ; import static com.facebook.presto.hive.HiveTableProperties.getPartitionedBy ; import static com.facebook.presto.hive.HiveType.toHiveType ; import static com.facebook.presto.hive.HiveUtil.PRESTO_VIEW_FLAG ; @ @ -123,6 +124,7 @ @ import static java.util.Objects.requireNonNull ; import static java.util.UUID.randomUUID ; import static java.util.stream.Collectors.joining ; import static java.util.stream.Collectors.toList ; +import static org.apache.hadoop.hive.metastore.TableType.EXTERNAL_TABLE ; import static org.apache.hadoop.hive.serde.serdeConstants.STRING_TYPE_NAME ; public class HiveMetadata @ @ -397,7 +399,8 @ @ public class HiveMetadata List < String > partitionedBy = getPartitionedBy ( tableMetadata.getProperties ( ) ) ; List < HiveColumnHandle > columnHandles = getColumnHandles ( connectorId , tableMetadata , ImmutableSet.copyOf ( partitionedBy ) ) ; HiveStorageFormat hiveStorageFormat = getHiveStorageFormat ( tableMetadata.getProperties ( ) ) ; - createTable ( schemaName , tableName , tableMetadata.getOwner ( ) , columnHandles , hiveStorageFormat , partitionedBy ) ; + TableType hiveTableType = getHiveTableType ( tableMetadata.getProperties ( ) ) ; + createTable ( schemaName , tableName , tableMetadata.getOwner ( ) , columnHandles , hiveStorageFormat , hiveTableType , partitionedBy ) ; } public void createTable ( String schemaName , @ @ -405,6 +408,7 @ @ public class HiveMetadata create external hive table execution failing __EoT__ Hi , The otherday i was able to create and delete external table from data on s3 . But today i tried the same procedure with a different table name but it failed error message presto : default > create external table test ( a STRING ) ; Query 20151026_225840_00002_4mjn7 failed : line 1:8 : no viable alternative at input 'create external' create external table test ( a STRING ) debug log from the server.log is 2015-10-26T22:55:58.455Z INFO main com.facebook.presto.server.PrestoServer ======== SERVER STARTED ======== 2015-10-26T22:58:16.677Z WARN http-client-shared-116 com.facebook.presto.memory.RemoteNodeMemory Error fetching memory info from http : //10.195.0.44:8090/v1/memory : java.util.concurrent.TimeoutException 2015-10-26T22:58:17.514Z INFO query-execution-2 com.facebook.presto.event.query.QueryMonitor TIMELINE : Query 20151026_225816_00000_4mjn7 : : elapsed 723.00ms : : planning 216.70ms : : scheduling 420.00ms : : running 78.00ms : : finishing 8.00ms : : begin 2015-10-26T22:58:16.754Z : : end 2015-10-26T22:58:17.477Z 2015-10-26T22:58:17.913Z INFO query-execution-1 com.facebook.presto.event.query.QueryMonitor TIMELINE : Query 20151026_225817_00001_4mjn7 : : elapsed 349.00ms : : planning 74.23ms : : scheduling 156.00ms : : running 92.00ms : : finishing 27.00ms : : begin 2015-10-26T22:58:17.544Z : : end 2015-10-26T22:58:17.893Z 2015-10-26T22:58:40.481Z ERROR http-worker-114 com.facebook.presto.execution.QueryStateMachine Query 20151026_225840_00002_4mjn7 failed com.facebook.presto.sql.parser.ParsingException : line 1:8 : no viable alternative at input 'create external' at com.facebook.presto.sql.parser.SqlParser $ 1.syntaxError
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/LambdaCaptureDesugaringRewriter.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/LambdaCaptureDesugaringRewriter.java deleted file mode 100644 index a868fdc..0000000 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/LambdaCaptureDesugaringRewriter.java +++ /dev/null @ @ -1,149 +0,0 @ @ -/* - * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - * you may not use this file except in compliance with the License . - * You may obtain a copy of the License at - * - * http : //www.apache.org/licenses/LICENSE-2.0 - * - * Unless required by applicable law or agreed to in writing , software - * distributed under the License is distributed on an `` AS IS '' BASIS , - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . - * See the License for the specific language governing permissions and - * limitations under the License . - */ - -package com.facebook.presto.sql.planner ; - -import com.facebook.presto.spi.type.Type ; -import com.facebook.presto.sql.tree.BindExpression ; -import com.facebook.presto.sql.tree.Expression ; -import com.facebook.presto.sql.tree.ExpressionRewriter ; -import com.facebook.presto.sql.tree.ExpressionTreeRewriter ; -import com.facebook.presto.sql.tree.Identifier ; -import com.facebook.presto.sql.tree.LambdaArgumentDeclaration ; -import com.facebook.presto.sql.tree.LambdaExpression ; -import com.facebook.presto.sql.tree.SymbolReference ; -import com.google.common.collect.ImmutableList ; -import com.google.common.collect.ImmutableMap ; - -import java.util.LinkedHashSet ; -import java.util.List ; -import java.util.Map ; -import java.util.Set ; - -import static com.google.common.collect.ImmutableList.toImmutableList ; -import static java.util.Objects.requireNonNull Migrate DesugaringOptimizer to iterative optimizer __EoT__
diff -- git a/presto-main/src/main/java/com/facebook/presto/type/DoubleOperators.java b/presto-main/src/main/java/com/facebook/presto/type/DoubleOperators.java index 1c182d7..e8a29af 100644 -- - a/presto-main/src/main/java/com/facebook/presto/type/DoubleOperators.java +++ b/presto-main/src/main/java/com/facebook/presto/type/DoubleOperators.java @ @ -217,7 +217,12 @ @ public final class DoubleOperators @ SqlType ( StandardTypes.BIGINT ) public static long castToLong ( @ SqlType ( StandardTypes.DOUBLE ) double value ) { - return ( long ) MathFunctions.round ( value ) ; + try { + return toIntExact ( ( long ) MathFunctions.round ( value ) ) ; + } + catch ( ArithmeticException e ) { + throw new PrestoException ( NUMERIC_VALUE_OUT_OF_RANGE , `` Out of range for bigint : `` + value , e ) ; + } } @ ScalarOperator ( CAST ) Fix silent clamping in double to long cast __EoT__ ` cast ( 9.3e18 as bigint ) ` should fail the same way as ` cast ( 2.2e9 as integer ) ` . However , it clamps silently right now . `` ` presto : di > select cast ( 9.3e18 as bigint ) ; _col0 -- -- -- -- -- -- -- -- -- -- - 9223372036854775807 ( 1 row ) `` `
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/EffectivePredicateExtractor.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/EffectivePredicateExtractor.java index e70f12e..78acde5 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/EffectivePredicateExtractor.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/EffectivePredicateExtractor.java @ @ -149,7 +149,7 @ @ public class EffectivePredicateExtractor Expression underlyingPredicate = node.getSource ( ) .accept ( this , context ) ; - List < Expression > projectionEqualities = node.getAssignments ( ) .entrySet ( ) .stream ( ) + List < Expression > projectionEqualities = node.getAssignmentsMap ( ) .entrySet ( ) .stream ( ) .filter ( SYMBOL_MATCHES_EXPRESSION.negate ( ) ) .map ( ENTRY_TO_EQUALITY ) .collect ( toImmutableList ( ) ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/ExpressionExtractor.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/ExpressionExtractor.java index 59513a9..65bb99a 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/ExpressionExtractor.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/ExpressionExtractor.java @ @ -72,7 +72,7 @ @ public class ExpressionExtractor @ Override public Void visitProject ( ProjectNode node , ImmutableList.Builder < Expression > context ) { - context.addAll ( node.getAssignments ( ) .values ( ) ) ; + context.addAll ( node.getAssignments ( ) .getExpressions ( ) ) ; return super.visitProject ( node , context ) ; } diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/LocalExecutionPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/LocalExecutionPlanner.java index eb6a029..2297594 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/LocalExecutionPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/LocalExecutionPlanner.java @ @ -101,6 +101,7 @ @ import com.facebook.presto.sql.planner.Partitioning.ArgumentBinding ; import com.facebook.presto.sql.planner.optimizations.IndexJoinOptimizer ; import com.facebook.presto.sql.planner.plan.AggregationNode ; import com.facebook.presto.sql.planner.plan.AssignUniqueId ; +import com.facebook.presto.sql.planner.plan.Assignments ; import com.facebook.presto.sql.planner.plan.DeleteNode ; import com.facebook.presto.sql.planner.plan.DistinctLimitNode ; import com.facebook.presto.sql.planner.plan.EnforceSingleRowNode ; @ @ -925,10 +926,7 Integer overflow with IN and doubles . __EoT__ `` ` presto > with table2 ( id2 ) as ( values 1,1,2,2,3,3,4,4,5,5,6,6,7,8,9,10 ) , table1 ( id1 ) as ( values 1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0 ) select * from table1 where id1 in ( select id2 from table2 group by id2 having count ( * ) > 1 ) ; Query 20161212_224603_01571_dvnc7 , FAILED , 2 nodes Splits : 7 total , 3 done ( 42.86 % ) 0:00 [ 0 rows , 0B ] [ 0 rows/s , 0B/s ] Query 20161212_224603_01571_dvnc7 failed : integer overflow `` `
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/EffectivePredicateExtractor.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/EffectivePredicateExtractor.java index e70f12e..78acde5 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/EffectivePredicateExtractor.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/EffectivePredicateExtractor.java @ @ -149,7 +149,7 @ @ public class EffectivePredicateExtractor Expression underlyingPredicate = node.getSource ( ) .accept ( this , context ) ; - List < Expression > projectionEqualities = node.getAssignments ( ) .entrySet ( ) .stream ( ) + List < Expression > projectionEqualities = node.getAssignmentsMap ( ) .entrySet ( ) .stream ( ) .filter ( SYMBOL_MATCHES_EXPRESSION.negate ( ) ) .map ( ENTRY_TO_EQUALITY ) .collect ( toImmutableList ( ) ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/ExpressionExtractor.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/ExpressionExtractor.java index 59513a9..65bb99a 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/ExpressionExtractor.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/ExpressionExtractor.java @ @ -72,7 +72,7 @ @ public class ExpressionExtractor @ Override public Void visitProject ( ProjectNode node , ImmutableList.Builder < Expression > context ) { - context.addAll ( node.getAssignments ( ) .values ( ) ) ; + context.addAll ( node.getAssignments ( ) .getExpressions ( ) ) ; return super.visitProject ( node , context ) ; } diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/LocalExecutionPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/LocalExecutionPlanner.java index eb6a029..2297594 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/LocalExecutionPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/LocalExecutionPlanner.java @ @ -101,6 +101,7 @ @ import com.facebook.presto.sql.planner.Partitioning.ArgumentBinding ; import com.facebook.presto.sql.planner.optimizations.IndexJoinOptimizer ; import com.facebook.presto.sql.planner.plan.AggregationNode ; import com.facebook.presto.sql.planner.plan.AssignUniqueId ; +import com.facebook.presto.sql.planner.plan.Assignments ; import com.facebook.presto.sql.planner.plan.DeleteNode ; import com.facebook.presto.sql.planner.plan.DistinctLimitNode ; import com.facebook.presto.sql.planner.plan.EnforceSingleRowNode ; @ @ -925,10 +926,7 Integer overflow with IN and doubles . __EoT__ `` ` presto > with table2 ( id2 ) as ( values 1,1,2,2,3,3,4,4,5,5,6,6,7,8,9,10 ) , table1 ( id1 ) as ( values 1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0 ) select * from table1 where id1 in ( select id2 from table2 group by id2 having count ( * ) > 1 ) ; Query 20161212_224603_01571_dvnc7 , FAILED , 2 nodes Splits : 7 total , 3 done ( 42.86 % ) 0:00 [ 0 rows , 0B ] [ 0 rows/s , 0B/s ] Query 20161212_224603_01571_dvnc7 failed : integer overflow `` `
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java index 1a52f01..ef66649 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java @ @ -34,6 +34,7 @ @ import com.facebook.presto.sql.planner.plan.ExceptNode ; import com.facebook.presto.sql.planner.plan.FilterNode ; import com.facebook.presto.sql.planner.plan.IntersectNode ; import com.facebook.presto.sql.planner.plan.JoinNode ; +import com.facebook.presto.sql.planner.plan.LateralJoinNode ; import com.facebook.presto.sql.planner.plan.PlanNode ; import com.facebook.presto.sql.planner.plan.ProjectNode ; import com.facebook.presto.sql.planner.plan.SampleNode ; @ @ -521,7 +522,7 @ @ class RelationPlanner PlanBuilder leftPlanBuilder = initializePlanBuilder ( leftPlan ) ; PlanBuilder rightPlanBuilder = initializePlanBuilder ( rightPlan ) ; - PlanBuilder planBuilder = subqueryPlanner.appendLateralJoin ( leftPlanBuilder , rightPlanBuilder , lateral.getQuery ( ) , true ) ; + PlanBuilder planBuilder = subqueryPlanner.appendLateralJoin ( leftPlanBuilder , rightPlanBuilder , lateral.getQuery ( ) , true , LateralJoinNode.Type.INNER ) ; List < Symbol > outputSymbols = ImmutableList. < Symbol > builder ( ) .addAll ( leftPlan.getRoot ( ) .getOutputSymbols ( ) ) diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/SubqueryPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/SubqueryPlanner.java index d314e32..76bf560 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/SubqueryPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/SubqueryPlanner.java @ @ -231,10 +231,10 @ @ class SubqueryPlanner subPlan.getTranslations ( ) .put ( coercion , coercionSymbol ) ; } - return appendLateralJoin ( subPlan , subqueryPlan , scalarSubquery.getQuery ( ) , correlationAllowed ) ; + return appendLateralJoin ( subPlan , subqueryPlan , scalarSubquery.getQuery ( ) , correlationAllowed , LateralJoinNode.Type.LEFT ) ; } - public PlanBuilder appendLateralJoin ( PlanBuilder subPlan , PlanBuilder subqueryPlan Introduce JoinNode # matchMax __EoT__ # 10405 improved support for correlated no aggregation scalar queries . A query like ` SELECT name , ( SELECT name FROM region WHERE regionkey = nation.regionkey ) FROM nation ` is planned as a left join sandwiched between ` AssignUniqueId ` and ` MarkDistinct ` + ` Filter ` : - Filter if ( is_distint , true , fail ( 'Scalar sub-query has returned multiple rows ' ) ) - MarkDistinct ( unique ) - LeftJoin - AssignUniqueId ( unique ) - probe - build The sole purpose of extra ` AssignUniqueId ` , ` MarkDistinct ` and ` Filter ` nodes is to verify at runtime that the scalar subquery returns zero or one row . However , this check is expensive . The distributed plan includes a remote exchange between ` MarkDistinct ` and ` LeftJoin ` : - Filter if ( is_distint , true , fail ( 'Scalar sub-query has returned multiple rows ' ) ) - MarkDistinct ( unique ) - RemoteExchange ( hash ( unique ) ) - LeftJoin - RemoteExchange ( hash ( joinkey ) ) - AssignUniqueId ( unique ) - probe - RemoteExchange ( hash (
diff -- git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/FailureFunction.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/FailureFunction.java index 75af69d..2388002 100644 -- - a/presto-main/src/main/java/com/facebook/presto/operator/scalar/FailureFunction.java +++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/FailureFunction.java @ @ -31,12 +31,35 @ @ public final class FailureFunction // We should n't be using UNKNOWN as an explicit type . This will be fixed when we fix type inference @ Description ( `` Decodes json to an exception and throws it '' ) - @ ScalarFunction ( hidden = true ) + @ ScalarFunction ( value = `` fail '' , hidden = true ) @ SqlType ( `` unknown '' ) - public static void fail ( @ SqlType ( StandardTypes.JSON ) Slice failureInfoSlice ) + public static void failWithException ( @ SqlType ( StandardTypes.JSON ) Slice failureInfoSlice ) { FailureInfo failureInfo = JSON_CODEC.fromJson ( failureInfoSlice.getBytes ( ) ) ; // wrap the failure in a new exception to append the current stack trace throw new PrestoException ( StandardErrorCode.GENERIC_USER_ERROR , failureInfo.toException ( ) ) ; } + + @ Description ( `` Throws an exception with a given message '' ) + @ ScalarFunction ( value = `` fail '' , hidden = true ) + @ SqlType ( `` unknown '' ) + public static void fail ( @ SqlType ( StandardTypes.VARCHAR ) Introduce JoinNode # matchMax __EoT__ # 10405 improved support for correlated no aggregation scalar queries . A query like ` SELECT name , ( SELECT name FROM region WHERE regionkey = nation.regionkey ) FROM nation ` is planned as a left join sandwiched between ` AssignUniqueId ` and ` MarkDistinct ` + ` Filter ` : - Filter if ( is_distint , true , fail ( 'Scalar sub-query has returned multiple rows ' ) ) - MarkDistinct ( unique ) - LeftJoin - AssignUniqueId ( unique ) - probe - build The sole purpose of extra ` AssignUniqueId ` , ` MarkDistinct ` and ` Filter ` nodes is to verify at runtime that the scalar subquery returns zero or one row . However , this check is expensive . The distributed plan includes a remote exchange between ` MarkDistinct ` and ` LeftJoin ` : - Filter if ( is_distint , true , fail ( 'Scalar sub-query has returned multiple rows ' ) ) - MarkDistinct ( unique ) - RemoteExchange ( hash ( unique ) ) - LeftJoin - RemoteExchange ( hash ( joinkey ) ) - AssignUniqueId ( unique ) - probe - RemoteExchange ( hash (
diff -- git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/FailureFunction.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/FailureFunction.java index 75af69d..2388002 100644 -- - a/presto-main/src/main/java/com/facebook/presto/operator/scalar/FailureFunction.java +++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/FailureFunction.java @ @ -31,12 +31,35 @ @ public final class FailureFunction // We should n't be using UNKNOWN as an explicit type . This will be fixed when we fix type inference @ Description ( `` Decodes json to an exception and throws it '' ) - @ ScalarFunction ( hidden = true ) + @ ScalarFunction ( value = `` fail '' , hidden = true ) @ SqlType ( `` unknown '' ) - public static void fail ( @ SqlType ( StandardTypes.JSON ) Slice failureInfoSlice ) + public static void failWithException ( @ SqlType ( StandardTypes.JSON ) Slice failureInfoSlice ) { FailureInfo failureInfo = JSON_CODEC.fromJson ( failureInfoSlice.getBytes ( ) ) ; // wrap the failure in a new exception to append the current stack trace throw new PrestoException ( StandardErrorCode.GENERIC_USER_ERROR , failureInfo.toException ( ) ) ; } + + @ Description ( `` Throws an exception with a given message '' ) + @ ScalarFunction ( value = `` fail '' , hidden = true ) + @ SqlType ( `` unknown '' ) + public static void fail ( @ SqlType ( StandardTypes.VARCHAR ) Introduce JoinNode # matchMax __EoT__ # 10405 improved support for correlated no aggregation scalar queries . A query like ` SELECT name , ( SELECT name FROM region WHERE regionkey = nation.regionkey ) FROM nation ` is planned as a left join sandwiched between ` AssignUniqueId ` and ` MarkDistinct ` + ` Filter ` : - Filter if ( is_distint , true , fail ( 'Scalar sub-query has returned multiple rows ' ) ) - MarkDistinct ( unique ) - LeftJoin - AssignUniqueId ( unique ) - probe - build The sole purpose of extra ` AssignUniqueId ` , ` MarkDistinct ` and ` Filter ` nodes is to verify at runtime that the scalar subquery returns zero or one row . However , this check is expensive . The distributed plan includes a remote exchange between ` MarkDistinct ` and ` LeftJoin ` : - Filter if ( is_distint , true , fail ( 'Scalar sub-query has returned multiple rows ' ) ) - MarkDistinct ( unique ) - RemoteExchange ( hash ( unique ) ) - LeftJoin - RemoteExchange ( hash ( joinkey ) ) - AssignUniqueId ( unique ) - probe - RemoteExchange ( hash (
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PredicatePushDown.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PredicatePushDown.java index 0adc9a9..b8d47f5 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PredicatePushDown.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PredicatePushDown.java @ @ -236,8 +236,10 @ @ public class PredicatePushDown @ Override public PlanNode visitMarkDistinct ( MarkDistinctNode node , RewriteContext < Expression > context ) { - checkState ( ! SymbolsExtractor.extractUnique ( context.get ( ) ) .contains ( node.getMarkerSymbol ( ) ) , `` predicate depends on marker symbol '' ) ; - return context.defaultRewrite ( node , context.get ( ) ) ; + if ( ! SymbolsExtractor.extractUnique ( context.get ( ) ) .contains ( node.getMarkerSymbol ( ) ) ) { + return context.defaultRewrite ( node , context.get ( ) ) ; + } + return new FilterNode ( idAllocator.getNextId ( ) , node , combineConjuncts ( context.get ( ) ) ) ; } @ Override Add support for LEFT spatial JOIN __EoT__ Extend spatial join optimization introduced in # 9890 to left joins to support correlated sub-queries . E.g . optimize left joins expressed with ` ST_Contains ` , ` ST_Intersects ` and ` ST_Distance ` relationships to use spatial index ( R-Tree ) for the build side . `` ` select * from t left join u on ST_Contains ( u.geometry , t.geometry ) `` ` Then it will be possible to use correlated sub-queries to implement reverse-geocoding processing like so : `` ` select * , ( select arbitrary ( name ) from regions where ST_Contains ( geometry , t.point ) ) from t `` ` ( See # 8435 for ideas on how to remove ` arbitrary ` aggregation from that query . )
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/TransformCorrelatedScalarAggregationToJoin.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/TransformCorrelatedScalarAggregationToJoin.java index 0b8ebd1..711f9e4 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/TransformCorrelatedScalarAggregationToJoin.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/TransformCorrelatedScalarAggregationToJoin.java @ @ -18,7 +18,7 @ @ import com.facebook.presto.matching.Pattern ; import com.facebook.presto.metadata.FunctionRegistry ; import com.facebook.presto.sql.planner.iterative.Lookup ; import com.facebook.presto.sql.planner.iterative.Rule ; -import com.facebook.presto.sql.planner.optimizations.ScalarAggregationToJoinRewriter ; +import com.facebook.presto.sql.planner.optimizations.ScalarSubqueryToJoinRewriter ; import com.facebook.presto.sql.planner.plan.AggregationNode ; import com.facebook.presto.sql.planner.plan.EnforceSingleRowNode ; import com.facebook.presto.sql.planner.plan.LateralJoinNode ; @ @ -96,7 +96,7 @ @ public class TransformCorrelatedScalarAggregationToJoin return Result.empty ( ) ; } - ScalarAggregationToJoinRewriter rewriter = new ScalarAggregationToJoinRewriter ( functionRegistry , context.getSymbolAllocator ( ) , context.getIdAllocator ( ) , context.getLookup ( ) ) ; + ScalarSubqueryToJoinRewriter rewriter = new ScalarSubqueryToJoinRewriter ( functionRegistry , context.getSymbolAllocator ( ) , context.getIdAllocator ( ) , context.getLookup ( ) ) ; PlanNode rewrittenNode = rewriter.rewriteScalarAggregation ( lateralJoinNode , aggregation.get ( ) ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PredicatePushDown.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PredicatePushDown.java index 0adc9a9..e496fd8 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PredicatePushDown.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PredicatePushDown.java @ @ -55,7 +55,6 @ @ import com.facebook.presto.sql.tree.SymbolReference ; import com.google.common.collect.ImmutableList ; import com.google.common.collect.ImmutableSet ; import com.google.common.collect.Iterables ; -import io.airlift.log.Logger ; import java.util.ArrayList ; import java.util.Collection ; @ @ -90,8 +89,6 @ @ import static java.util.Objects.requireNonNull ; public class PredicatePushDown implements PlanOptimizer { - private static final Logger log = Logger.get ( PredicatePushDown.class ) ; - private final Metadata metadata ; private final SqlParser sqlParser ; @ @ -236,8 +233,10 Add support for LEFT spatial JOIN __EoT__ Extend spatial join optimization introduced in # 9890 to left joins to support correlated sub-queries . E.g . optimize left joins expressed with ` ST_Contains ` , ` ST_Intersects ` and ` ST_Distance ` relationships to use spatial index ( R-Tree ) for the build side . `` ` select * from t left join u on ST_Contains ( u.geometry , t.geometry ) `` ` Then it will be possible to use correlated sub-queries to implement reverse-geocoding processing like so : `` ` select * , ( select arbitrary ( name ) from regions where ST_Contains ( geometry , t.point ) ) from t `` ` ( See # 8435 for ideas on how to remove ` arbitrary ` aggregation from that query . )
diff -- git a/pom.xml b/pom.xml index 5409824..a662528 100644 -- - a/pom.xml +++ b/pom.xml @ @ -167,6 +167,12 @ @ < /dependency > < dependency > + < groupId > com.teradata < /groupId > + < artifactId > re2j-td < /artifactId > + < version > 1.4 < /version > + < /dependency > + + < dependency > < groupId > com.facebook.presto < /groupId > < artifactId > presto-tpch < /artifactId > < version > $ { project.version } < /version > diff -- git a/presto-main/pom.xml b/presto-main/pom.xml index c3ad24b..a588fee 100644 -- - a/presto-main/pom.xml +++ b/presto-main/pom.xml @ @ -147,6 +147,11 @ @ < /dependency > < dependency > + < groupId > com.teradata < /groupId > + < artifactId > re2j-td < /artifactId > + < /dependency > + + < dependency > < groupId > io.airlift.discovery < /groupId > < artifactId > discovery-server < /artifactId > < /dependency > diff -- git a/presto-main/src/main/java/com/facebook/presto/metadata/FunctionRegistry.java b/presto-main/src/main/java/com/facebook/presto/metadata/FunctionRegistry.java index f390d98..ea6e639 100644 -- - a/presto-main/src/main/java/com/facebook/presto/metadata/FunctionRegistry.java +++ b/presto-main/src/main/java/com/facebook/presto/metadata/FunctionRegistry.java @ @ -64,6 +64,7 @ @ import com.facebook.presto.operator.scalar.CombineHashFunction ; import com.facebook.presto.operator.scalar.DateTimeFunctions ; import com.facebook.presto.operator.scalar.FailureFunction ; import com.facebook.presto.operator.scalar.HyperLogLogFunctions ; +import com.facebook.presto.operator.scalar.JoniRegexpFunctions ; import com.facebook.presto.operator.scalar.JsonFunctions ; import com.facebook.presto.operator.scalar.JsonOperators ; import com.facebook.presto.operator.scalar.MapCardinalityFunction ; @ @ -74,7 +75,8 @ @ import com.facebook.presto.operator.scalar.MapNotEqualOperator Regex improvements __EoT__ We are creating this issue in order to explore and find an alternative to the current regular expression library used by the regexp_ functions . It is intended to overcome the computing overhead when worst case backtracking is involved . Other regular expression libraries such as RE2 has attempted to avoid the slowdown present in the backtracking based regex libraries . For this purpose , we have explored RE2J as a starting point for RE2 based regular expression library . Our early tests are mostly regarding the feature completeness of RE2J and the performance difference between regexp_ functions with RE2J and regexp_ functions with JONI . **1 . Feature comparison** We used Java Pattern class as the basis for feature comparison for syntax supported by RE2J . There are few features in Pattern class that we have n't tested/verified yet ( eg . unicode , POSIX character classes ) . Below is the list of features supported by Pattern class and RE2J support . | Regular expression feature | RE2J support | Pattern | Matching text | Non matching text | | -- - | -- - | -- - | -- - | -- - |
diff -- git a/presto-docs/src/main/sphinx/admin.rst b/presto-docs/src/main/sphinx/admin.rst index eab299a..8947d7a 100644 -- - a/presto-docs/src/main/sphinx/admin.rst +++ b/presto-docs/src/main/sphinx/admin.rst @ @ -9,3 +9,4 @ @ Administration admin/tuning admin/queue admin/resource-groups + admin/feature-toggles diff -- git a/presto-docs/src/main/sphinx/admin/feature-toggles.rst b/presto-docs/src/main/sphinx/admin/feature-toggles.rst new file mode 100644 index 0000000..7eb18ac -- - /dev/null +++ b/presto-docs/src/main/sphinx/admin/feature-toggles.rst @ @ -0,0 +1,16 @ @ +=============== +Feature Toggles +=============== + +The default Presto settings should work well for most workloads . The following +information may help you if some of the features are not working correctly for you . +Though , if you think the behavior of a feature is unexpected , do n't hesitate to file a bug report regardless if it 's enabled or disabled by default . + +Config Properties + -- -- -- -- -- -- -- -- - + ++ -- -- -- -- -- -- -- -- -- -- -- -- -- + -- -- -- -- -- -- -- -+ -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- Window function dependencies not in source plan output __EoT__ `` ` with t1 as ( select orderkey , totalprice from tpch.tiny.orders ) , t2 as ( select orderkey , totalprice , sum ( totalprice ) over ( ) x from t1 ) , t3 as ( select orderkey , max ( x ) over ( ) from t2 ) select * from t3 `` ` `` ` java.lang.IllegalArgumentException : Invalid node . Window function dependencies ( [ sum ] ) not in source plan output ( [ orderkey ] ) at com.google.common.base.Preconditions.checkArgument ( Preconditions.java:145 ) at com.facebook.presto.sql.planner.sanity.ValidateDependenciesChecker.checkDependencies ( ValidateDependenciesChecker.java:645 ) at com.facebook.presto.sql.planner.sanity.ValidateDependenciesChecker.access $ 100 ( ValidateDependenciesChecker.java:80 ) at com.facebook.presto.sql.planner.sanity.ValidateDependenciesChecker $ Visitor.visitWindow ( ValidateDependenciesChecker.java:187 ) at com.facebook.presto.sql.planner.sanity.ValidateDependenciesChecker $ Visitor.visitWindow ( ValidateDependenciesChecker.java:94 ) at com.facebook.presto.sql.planner.plan.WindowNode.accept ( WindowNode.java:154 ) at com.facebook.presto.sql.planner.sanity.ValidateDependenciesChecker $ Visitor.visitOutput ( ValidateDependenciesChecker.java:303 ) at com.facebook.presto.sql.planner.sanity.ValidateDependenciesChecker $ Visitor.visitOutput ( ValidateDependenciesChecker.java:94 ) at com.facebook.presto.sql.planner.plan.OutputNode.accept ( OutputNode.java:82 ) at com.facebook.presto.sql.planner.sanity.ValidateDependenciesChecker.validate ( ValidateDependenciesChecker.java:91 ) at com.facebook.presto.sql.planner.sanity.ValidateDependenciesChecker.validate ( ValidateDependenciesChecker.java:86 ) at com.facebook.presto.sql.planner.sanity.PlanSanityChecker.lambda $ validate $ 0 ( PlanSanityChecker.java:44 ) at java.lang.Iterable.forEach ( Iterable.java:75 ) at com.facebook.presto.sql.planner.sanity.PlanSanityChecker.validate ( PlanSanityChecker.java:44 ) at com.facebook.presto.sql.planner.LogicalPlanner.plan ( LogicalPlanner.java:127 ) at com.facebook.presto.sql.planner.LogicalPlanner.plan ( LogicalPlanner.java:111 ) at com.facebook.presto.execution.SqlQueryExecution.doAnalyzeQuery ( SqlQueryExecution.java:297 ) at com.facebook.presto.execution.SqlQueryExecution.analyzeQuery ( SqlQueryExecution.java:276 ) at com.facebook.presto.execution.SqlQueryExecution.start ( SqlQueryExecution.java:234 ) at
diff -- git a/pom.xml b/pom.xml index 229bd84..842b47a 100644 -- - a/pom.xml +++ b/pom.xml @ @ -222,6 +222,48 @ @ < /dependency > < dependency > + < groupId > com.facebook.hive < /groupId > + < artifactId > hive-dwrf < /artifactId > + < version > 0.8 < /version > + < exclusions > + < exclusion > + < groupId > commons-logging < /groupId > + < artifactId > commons-logging < /artifactId > + < /exclusion > + < exclusion > + < groupId > org.iq80.snappy < /groupId > + < artifactId > snappy < /artifactId > + < /exclusion > + < exclusion > + < groupId > com.facebook.presto.hadoop < /groupId > + < artifactId > hadoop-cdh4 < /artifactId > + < /exclusion > + < exclusion > + < groupId > it.unimi.dsi < /groupId > + < artifactId > fastutil < /artifactId > + < /exclusion > + < /exclusions > + < /dependency > + + < dependency > + < groupId > com.facebook.hive < /groupId > + < artifactId > hive-dwrf-shims < /artifactId > + < version > 0.8 < /version > + < exclusions > + < exclusion > + < artifactId > commons-logging < presto-0.75 query hive 0.13.1 orc table fail __EoT__ 2014-08-27T23:19:25.328+0800 DEBUG query-execution-0 com.facebook.presto.execution.QueryStateMachine Query 20140827_151924_00000_qq85a is PLANNING 2014-08-27T23:19:33.454+0800 DEBUG query-execution-0 com.facebook.presto.execution.QueryStateMachine Query 20140827_151924_00000_qq85a is STARTING 2014-08-27T23:19:33.470+0800 DEBUG query-execution-2 com.facebook.presto.execution.SqlStageExecution Stage 20140827_151924_00000_qq85a.1 is SCHEDULING 2014-08-27T23:19:33.475+0800 DEBUG query-execution-3 com.facebook.presto.execution.SqlStageExecution Stage 20140827_151924_00000_qq85a.0 is SCHEDULING 2014-08-27T23:19:33.871+0800 DEBUG query-execution-2 com.facebook.presto.execution.SqlStageExecution Stage 20140827_151924_00000_qq85a.0 is SCHEDULED 2014-08-27T23:19:33.876+0800 DEBUG query-execution-3 com.facebook.presto.execution.QueryStateMachine Query 20140827_151924_00000_qq85a is RUNNING 2014-08-27T23:19:33.987+0800 DEBUG query-execution-2 com.facebook.presto.execution.SqlStageExecution Stage 20140827_151924_00000_qq85a.1 is SCHEDULED 2014-08-27T23:19:34.500+0800 DEBUG 20140827_151924_00000_qq85a.1.0-0-46 com.facebook.presto.execution.TaskExecutor Split 20140827_151924_00000_qq85a.1.0-0 ( start = 1409152774195 , wall = 304 ms , cpu = 55 ms , calls = 1 ) is finished 2014-08-27T23:19:35.071+0800 DEBUG query-execution-1 com.facebook.presto.execution.SqlStageExecution Stage 20140827_151924_00000_qq85a.1 is RUNNING 2014-08-27T23:19:35.126+0800 DEBUG query-execution-1 com.facebook.presto.execution.SqlStageExecution Stage 20140827_151924_00000_qq85a.0 is RUNNING 2014-08-27T23:19:35.404+0800 DEBUG task-notification-1 com.facebook.presto.execution.TaskStateMachine Task 20140827_151924_00000_qq85a.1.0 is FINISHED 2014-08-27T23:19:35.421+0800 DEBUG query-execution-1 com.facebook.presto.execution.SqlStageExecution Stage 20140827_151924_00000_qq85a.1 is FINISHED 2014-08-27T23:19:35.597+0800 DEBUG 20140827_151924_00000_qq85a.0.0-0-45 com.facebook.presto.execution.TaskExecutor Split 20140827_151924_00000_qq85a.0.0-0 ( start = 1409152774183 , wall = 1414 ms , cpu = 165 ms , calls = 3 ) is finished 2014-08-27T23:19:35.627+0800 DEBUG task-notification-2 com.facebook.presto.execution.TaskStateMachine Task 20140827_151924_00000_qq85a.0.0 is FINISHED 2014-08-27T23:19:35.745+0800 DEBUG query-execution-1 com.facebook.presto.execution.SqlStageExecution Stage 20140827_151924_00000_qq85a.0 is FINISHED 2014-08-27T23:19:35.755+0800 DEBUG query-execution-2 com.facebook.presto.execution.QueryStateMachine Query 20140827_151924_00000_qq85a is FINISHED 2014-08-27T23:19:35.884+0800 INFO query-execution-2 com.facebook.presto.event.query.QueryMonitor TIMELINE : Query 20140827_151924_00000_qq85a : : elapsed 10468.00ms : : planning 8167.10ms : : scheduling 1042.00ms : : running 893.00ms : :
diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java b/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java index e89dc7e..44f7b68 100644 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java +++ b/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java @ @ -345,7 +345,7 @ @ public class PrestoS3FileSystem { return new FSDataInputStream ( new BufferedFSInputStream ( - new PrestoS3InputStream ( s3 , uri.getHost ( ) , path , maxAttempts , maxBackoffTime , maxRetryTime ) , + new PrestoS3InputStream ( s3 , getBucketName ( uri ) , path , maxAttempts , maxBackoffTime , maxRetryTime ) , bufferSize ) ) ; } @ @ -367,7 +367,7 @ @ public class PrestoS3FileSystem String key = keyFromPath ( qualifiedPath ( path ) ) ; return new FSDataOutputStream ( - new PrestoS3OutputStream ( s3 , transferConfig , uri.getHost ( ) , key , tempFile , sseEnabled , sseType , sseKmsKeyId ) , + new PrestoS3OutputStream ( s3 , transferConfig , getBucketName ( uri ) , key , tempFile , sseEnabled , sseType , sseKmsKeyId ) , statistics ) ; } @ @ -412,7 +412,7 @ @ public class PrestoS3FileSystem deleteObject ( keyFromPath ( src ) + DIRECTORY_SUFFIX ) ; } else { - s3.copyObject ( uri.getHost ( ) , keyFromPath ( src ) , uri.getHost ( ) , keyFromPath ( dst ) ) ; + s3.copyObject ( getBucketName ( uri ) PrestoS3FileSystem passing null bucket when actual bucket name contains an underscore __EoT__ When attempting to query data stored in an S3 bucket whose name contains an underscore , the query fails with the below error . After attaching a debugger and tracing the execution it seems that the root cause is the fact that URI uses ‘ _ ’ ( among other chars ) as a signal character that distinguishes between URIs that are host vs. registry based . Presto ’ s PrestoS3FileSystem then assumes all S3 URIs are host based resulting in a null being passed to the S3 client when calling operations against buckets containing an ‘ _ ’ in the bucket name . Normally this is n't an issue because you can only create buckets with an '_ ' when using the aws cli and the us-east-1 region . [ PrestoS3FileSystem.java:479 ] ( https : //github.com/prestodb/presto/blob/0707f2f21a96d2fd30953fb3fa9a9a03f03d88bd/presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java # L479 ) is one example where the URI.getHost ( ) assumption is made . You can also see where URI treats authorities with '_ ' differently [ here ] ( http : //grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/java/net/URI.java # 3119 ) . `` ` com.facebook.presto.spi.PrestoException : The bucket name parameter must be specified when listing
diff -- git a/presto-main/src/main/java/com/facebook/presto/cost/ComparisonStatsCalculator.java b/presto-main/src/main/java/com/facebook/presto/cost/ComparisonStatsCalculator.java index 94f48e2..c3aedf0 100644 -- - a/presto-main/src/main/java/com/facebook/presto/cost/ComparisonStatsCalculator.java +++ b/presto-main/src/main/java/com/facebook/presto/cost/ComparisonStatsCalculator.java @ @ -19,7 +19,6 @ @ import com.facebook.presto.sql.tree.ComparisonExpressionType ; import java.util.Optional ; import java.util.OptionalDouble ; -import static com.facebook.presto.cost.FilterStatsCalculator.filterStatsForUnknownExpression ; import static com.facebook.presto.cost.SymbolStatsEstimate.buildFrom ; import static com.facebook.presto.util.MoreMath.firstNonNaN ; import static com.facebook.presto.util.MoreMath.max ; @ @ -34,7 +33,7 @ @ public final class ComparisonStatsCalculator { private ComparisonStatsCalculator ( ) { } - public static PlanNodeStatsEstimate comparisonExpressionToLiteralStats ( + public static Optional < PlanNodeStatsEstimate > comparisonExpressionToLiteralStats ( PlanNodeStatsEstimate inputStatistics , Optional < Symbol > symbol , SymbolStatsEstimate expressionStats , @ @ -54,11 +53,11 @ @ public final class ComparisonStatsCalculator return expressionToLiteralGreaterThan ( inputStatistics , symbol , expressionStats , doubleLiteral ) ; case IS_DISTINCT_FROM : default : - return filterStatsForUnknownExpression ( inputStatistics ) ; + return Optional.empty ( ) ; } } - private static PlanNodeStatsEstimate expressionToLiteralRangeComparison ( + private static Optional < PlanNodeStatsEstimate > expressionToLiteralRangeComparison ( PlanNodeStatsEstimate inputStatistics , Optional < Symbol > symbol , SymbolStatsEstimate expressionStats , @ @ -79,10 +78,10 @ @ public final class ComparisonStatsCalculator .build ( ) ; estimate = estimate.mapSymbolColumnStatistics ( symbol.get ( ) , oldStats - > symbolNewEstimate ) ; } - return estimate ; + return Optional.of ( estimate ) ; } - private Flaky test : TestTpchDistributedStats.testValues ( ) __EoT__ Entire test output is [ here ] ( https : //gist.githubusercontent.com/nezihyigitbasi/261c563d2591e4b649ec8ef85129df37/raw/983cc31e929a8fbbd4476317af974bf5ae3c98ce/gistfile1.txt ) . `` ` [ ERROR ] Tests run : 2122 , Failures : 1 , Errors : 0 , Skipped : 0 , Time elapsed : 2,173.575 s < < < FAILURE ! - in TestSuite [ ERROR ] testValues ( com.facebook.presto.tests.TestTpchDistributedStats ) Time elapsed : 0.037 s < < < FAILURE ! java.lang.AssertionError : Following metrics do not match : Metric [ OUTPUT_ROW_COUNT ] - estimated : [ 1.0 ] , real : [ UNKNOWN ] - plan node : [ com.facebook.presto.sql.planner.plan.OutputNode @ 2b575894 ] expected [ true ] but found [ false ] at com.facebook.presto.tests.TestTpchDistributedStats.testValues ( TestTpchDistributedStats.java:104 ) `` `
diff -- git a/presto-main/src/main/java/com/facebook/presto/cost/ComparisonStatsCalculator.java b/presto-main/src/main/java/com/facebook/presto/cost/ComparisonStatsCalculator.java index 94f48e2..c3aedf0 100644 -- - a/presto-main/src/main/java/com/facebook/presto/cost/ComparisonStatsCalculator.java +++ b/presto-main/src/main/java/com/facebook/presto/cost/ComparisonStatsCalculator.java @ @ -19,7 +19,6 @ @ import com.facebook.presto.sql.tree.ComparisonExpressionType ; import java.util.Optional ; import java.util.OptionalDouble ; -import static com.facebook.presto.cost.FilterStatsCalculator.filterStatsForUnknownExpression ; import static com.facebook.presto.cost.SymbolStatsEstimate.buildFrom ; import static com.facebook.presto.util.MoreMath.firstNonNaN ; import static com.facebook.presto.util.MoreMath.max ; @ @ -34,7 +33,7 @ @ public final class ComparisonStatsCalculator { private ComparisonStatsCalculator ( ) { } - public static PlanNodeStatsEstimate comparisonExpressionToLiteralStats ( + public static Optional < PlanNodeStatsEstimate > comparisonExpressionToLiteralStats ( PlanNodeStatsEstimate inputStatistics , Optional < Symbol > symbol , SymbolStatsEstimate expressionStats , @ @ -54,11 +53,11 @ @ public final class ComparisonStatsCalculator return expressionToLiteralGreaterThan ( inputStatistics , symbol , expressionStats , doubleLiteral ) ; case IS_DISTINCT_FROM : default : - return filterStatsForUnknownExpression ( inputStatistics ) ; + return Optional.empty ( ) ; } } - private static PlanNodeStatsEstimate expressionToLiteralRangeComparison ( + private static Optional < PlanNodeStatsEstimate > expressionToLiteralRangeComparison ( PlanNodeStatsEstimate inputStatistics , Optional < Symbol > symbol , SymbolStatsEstimate expressionStats , @ @ -79,10 +78,10 @ @ public final class ComparisonStatsCalculator .build ( ) ; estimate = estimate.mapSymbolColumnStatistics ( symbol.get ( ) , oldStats - > symbolNewEstimate ) ; } - return estimate ; + return Optional.of ( estimate ) ; } - private Flaky test : TestTpchDistributedStats.testValues ( ) __EoT__ Entire test output is [ here ] ( https : //gist.githubusercontent.com/nezihyigitbasi/261c563d2591e4b649ec8ef85129df37/raw/983cc31e929a8fbbd4476317af974bf5ae3c98ce/gistfile1.txt ) . `` ` [ ERROR ] Tests run : 2122 , Failures : 1 , Errors : 0 , Skipped : 0 , Time elapsed : 2,173.575 s < < < FAILURE ! - in TestSuite [ ERROR ] testValues ( com.facebook.presto.tests.TestTpchDistributedStats ) Time elapsed : 0.037 s < < < FAILURE ! java.lang.AssertionError : Following metrics do not match : Metric [ OUTPUT_ROW_COUNT ] - estimated : [ 1.0 ] , real : [ UNKNOWN ] - plan node : [ com.facebook.presto.sql.planner.plan.OutputNode @ 2b575894 ] expected [ true ] but found [ false ] at com.facebook.presto.tests.TestTpchDistributedStats.testValues ( TestTpchDistributedStats.java:104 ) `` `
diff -- git a/presto-docs/src/main/sphinx/admin.rst b/presto-docs/src/main/sphinx/admin.rst index eab299a..0af2c6e 100644 -- - a/presto-docs/src/main/sphinx/admin.rst +++ b/presto-docs/src/main/sphinx/admin.rst @ @ -7,5 +7,6 @ @ Administration admin/web-interface admin/tuning + admin/properties admin/queue admin/resource-groups diff -- git a/presto-docs/src/main/sphinx/admin/properties.rst b/presto-docs/src/main/sphinx/admin/properties.rst new file mode 100644 index 0000000..5e713ef -- - /dev/null +++ b/presto-docs/src/main/sphinx/admin/properties.rst @ @ -0,0 +1,26 @ @ +================= +Presto properties +================= + +These configuration options may require tuning in specific situations : + +* `` task.max-worker-threads `` : + Sets the number of threads used by workers to process splits . Increasing this number + can improve throughput if worker CPU utilization is low and all the threads are in use , + but will cause increased heap space usage . The number of active threads is available via + the `` com.facebook.presto.execution.TaskExecutor.RunningSplits `` JMX stat . + +* `` distributed-joins-enabled `` : + Use hash distributed joins instead of broadcast joins . Distributed joins + require redistributing both tables using a hash of the join key . This can + be slower ( sometimes substantially ) than broadcast joins , but allows much + larger joins . Broadcast joins require that the tables on the right side of + the join fit in memory on each machine , Where is the configuration properties description ? __EoT__ Where is the detailed description of the configuration parameters ? I have read the official website of the document , but not a very comprehensive description . Regards .
diff -- git a/presto-client/src/main/java/com/facebook/presto/client/StatementStats.java b/presto-client/src/main/java/com/facebook/presto/client/StatementStats.java index 2902bc5..b611f9b 100644 -- - a/presto-client/src/main/java/com/facebook/presto/client/StatementStats.java +++ b/presto-client/src/main/java/com/facebook/presto/client/StatementStats.java @ @ -27,6 +27,7 @ @ import static java.util.Objects.requireNonNull ; public class StatementStats { private final String state ; + private final boolean queued ; private final boolean scheduled ; private final int nodes ; private final int totalSplits ; @ @ -43,6 +44,7 @ @ public class StatementStats @ JsonCreator public StatementStats ( @ JsonProperty ( `` state '' ) String state , + @ JsonProperty ( `` queued '' ) boolean queued , @ JsonProperty ( `` scheduled '' ) boolean scheduled , @ JsonProperty ( `` nodes '' ) int nodes , @ JsonProperty ( `` totalSplits '' ) int totalSplits , @ @ -57,6 +59,7 @ @ public class StatementStats @ JsonProperty ( `` rootStage '' ) StageStats rootStage ) { this.state = requireNonNull ( state , `` state is null '' ) ; + this.queued = queued ; this.scheduled = scheduled ; this.nodes = nodes ; this.totalSplits = totalSplits ; @ @ -79,6 +82,12 @ @ public class StatementStats } @ JsonProperty + public boolean isQueued ( ) + { + return queued ; + } + + @ JsonProperty public boolean Add queued flag to StatementStats __EoT__ This flag should be added before the ` scheduled ` flag . It provides a proper way for clients to know if the query is waiting in the queue . ( clients should not be programmatically using the ` state ` field )
diff -- git a/pom.xml b/pom.xml index e7d53ab..0b91be2 100644 -- - a/pom.xml +++ b/pom.xml @ @ -55,8 +55,14 @ @ < dep.testng.version > 6.10 < /dep.testng.version > < dep.assertj-core.version > 3.8.0 < /dep.assertj-core.version > - < ! -- use a fractional hour timezone offset for tests -- > - < air.test.timezone > Asia/Katmandu < /air.test.timezone > + < ! -- + America/Bahia_Banderas has : + - offset change since 1970 ( offset Jan 1970 : -08:00 , offset Jan 2018 : -06:00 ) + - DST ( e.g . at 2017-04-02 02:00:00 clocks turned forward 1 hour ; 2017-10-29 02:00:00 clocks turned backward 1 hour ) + - has forward offset change on first day of epoch ( 1970-01-01 00:00:00 clocks turned forward 1 hour ) + - had forward change at midnight ( 1970-01-01 00:00:00 clocks turned forward 1 hour ) + -- > + < air.test.timezone > America/Bahia_Banderas < /air.test.timezone > < air.test.parallel > methods < /air.test.parallel > < air.test.thread-count > 2 < /air.test.thread-count > < air.test.jvmsize > 2g < /air.test.jvmsize > @ @ -372,7 +378,7 @ @ < dependency > < groupId > com.facebook.presto.hive < /groupId > < artifactId > hive-apache < /artifactId > - < version > Change time zone used in tests to better test date/time/zone/JVM-related corner cases __EoT__ All tests are run with ` Asia/Kathmandu ` time zone . I think it was chosen because : 1. it 's zone offset has changed since 1970 2. it 's zone offset is not whole hours ( was it the case ? ) These are nice properties , but there are other nice properties a time zone could have : 3 . DST ( breaks so many things ) 4. having DST change at midnight ( breaks all those code paths that represent date as local time at midnight ) Since it 's not possible to change JVM default zone for just a single test , using ` Asia/Kathmandu ` makes it not possible to test functionalities around DST changes . For example , reading TIMESTAMP values using JDBC ` ResultSet.getTimestamp ( ) ` can not succeed when TIMESTAMP value to be returned never occurred in JVM time zone , was skipped ( DST change forward ) . For these reasons , I 'd like to change time zone used in tests to one having DST . Unfortunately there is n't a zone that has all 4
diff -- git a/pom.xml b/pom.xml index 37a67be..bf9ae7d 100644 -- - a/pom.xml +++ b/pom.xml @ @ -48,7 +48,7 @ @ < dep.antlr.version > 4.5.1 < /dep.antlr.version > < dep.airlift.version > 0.131 < /dep.airlift.version > < dep.packaging.version > $ { dep.airlift.version } < /dep.packaging.version > - < dep.slice.version > 0.22 < /dep.slice.version > + < dep.slice.version > 0.23 < /dep.slice.version > < dep.aws-sdk.version > 1.9.40 < /dep.aws-sdk.version > < dep.tempto.version > 1.8 < /dep.tempto.version > Java 9 support __EoT__ This is an umbrella issue to track the changes needed to be able to run Presto on Java 9 : - [ x ] https : //github.com/prestodb/presto/pull/5789 - [ x ] https : //github.com/airlift/airlift/pull/438 - [ x ] https : //github.com/airlift/airlift/pull/437 - [ x ] https : //github.com/dain/leveldb/pull/70 - [ x ] https : //github.com/airlift/airlift/pull/439 - [ x ] https : //github.com/airlift/discovery/pull/39 - [ x ] Update to airbase 56 - [ x ] https : //github.com/airlift/slice/pull/59 - [ x ] https : //github.com/prestodb/presto/pull/5794 - [ x ] https : //github.com/airlift/airlift/pull/440 - [ x ] https : //github.com/airlift/discovery/pull/40 - [ x ] Update to airlift 0.132 - [ x ] Update to slice 0.23 : https : //github.com/prestodb/presto/pull/5795 - [ x ] Update to discovery 1.26 - [ x ] https : //github.com/airlift/airlift/pull/441
diff -- git a/presto-jdbc/src/main/java/com/facebook/presto/jdbc/PrestoDatabaseMetaData.java b/presto-jdbc/src/main/java/com/facebook/presto/jdbc/PrestoDatabaseMetaData.java index 9c8c228..9ed11da 100644 -- - a/presto-jdbc/src/main/java/com/facebook/presto/jdbc/PrestoDatabaseMetaData.java +++ b/presto-jdbc/src/main/java/com/facebook/presto/jdbc/PrestoDatabaseMetaData.java @ @ -916,34 +916,34 @ @ public class PrestoDatabaseMetaData { StringBuilder query = new StringBuilder ( 1024 ) ; query.append ( `` SELECT '' ) ; - query.append ( `` table_catalog AS TABLE_CAT '' ) ; - query.append ( `` , table_schema AS TABLE_SCHEM '' ) ; + query.append ( `` table_cat AS TABLE_CAT '' ) ; + query.append ( `` , table_schem AS TABLE_SCHEM '' ) ; query.append ( `` , table_name AS TABLE_NAME '' ) ; query.append ( `` , table_type AS TABLE_TYPE '' ) ; - query.append ( `` , `` AS REMARKS '' ) ; - query.append ( `` , `` AS TYPE_CAT '' ) ; - query.append ( `` , `` AS TYPE_SCHEM '' ) ; - query.append ( `` , `` AS TYPE_NAME '' ) ; - query.append ( `` , `` AS SELF_REFERENCING_COL_NAME '' ) ; - query.append ( `` , `` AS REF_GENERATION '' ) ; - query.append ( `` FROM information_schema.tables `` ) ; + query.append ( `` , remarks AS REMARKS '' ) ; + query.append ( `` , type_cat AS TYPE_CAT '' ) ; + query.append Fix table type handling in DatabaseMetaData __EoT__ Two problems : - ` getTableTypes ( ) ` returns ` BASE TABLE ` rather than ` TABLE ` - ` getTables ( ) ` takes a ` types ` filter that does not filter ` TABLE ` correctly Related , there is an additional type ` SYSTEM TABLE ` which would be nice to have that does not exist in the ` information_schema.tables ` specification . This could all be fixed by having metadata tables specifically for JDBC .
diff -- git a/presto-base-jdbc/src/main/java/com/facebook/presto/plugin/jdbc/BaseJdbcClient.java b/presto-base-jdbc/src/main/java/com/facebook/presto/plugin/jdbc/BaseJdbcClient.java index 30b4772..4b92c6f 100644 -- - a/presto-base-jdbc/src/main/java/com/facebook/presto/plugin/jdbc/BaseJdbcClient.java +++ b/presto-base-jdbc/src/main/java/com/facebook/presto/plugin/jdbc/BaseJdbcClient.java @ @ -35,12 +35,7 @ @ import io.airlift.slice.Slice ; import javax.annotation.Nullable ; -import java.sql.Connection ; -import java.sql.DatabaseMetaData ; -import java.sql.Driver ; -import java.sql.ResultSet ; -import java.sql.SQLException ; -import java.sql.Statement ; +import java.sql . * ; import java.sql.Types ; import java.util.ArrayList ; import java.util.Collection ; @ @ -73,6 +68,7 @ @ public class BaseJdbcClient implements JdbcClient { private static final Logger log = Logger.get ( BaseJdbcClient.class ) ; + private static final int FETCHSIZE = 1000 ; private static final Map < Type , String > SQL_TYPES = ImmutableMap. < Type , String > builder ( ) .put ( BOOLEAN , `` boolean '' ) @ @ -381,6 +377,27 @ @ public class BaseJdbcClient return driver.connect ( handle.getConnectionUrl ( ) , toProperties ( handle.getConnectionProperties ( ) ) ) ; } + @ Override + public Statement getStatement ( Connection connection ) + throws SQLException + { + Statement statement ; + String dataBaseName = connection.getMetaData ( ) .getDatabaseProductName ( ) ; + if ( dataBaseName.contains ( `` PostgreSQL '' ) ) { + connection.setAutoCommit ( false ) ; + statement = connection.createStatement ( ) ; + statement.setFetchSize ( Enable streaming results for JDBC connector __EoT__ In ` JdbcRecordCursor ` : For PostgreSQL , we need to call ` setAutoCommit ( false ) ` on the ` Connection ` : https : //jdbc.postgresql.org/documentation/head/query.html For MySQL , we need to call ` enableStreamingResults ( ) ` on the MySQL ` Statement ` ( see ` ShardIterator ` for an example ) . Since we need specific logic for different databases , we should add a ` getStatement ( connection ) ` method to ` JdbcClient ` that can do the customization .
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analyzer.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analyzer.java index c8cebb4..3c51602 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analyzer.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analyzer.java @ @ -65,7 +65,7 @ @ public class Analyzer Statement rewrittenStatement = StatementRewrite.rewrite ( session , metadata , sqlParser , queryExplainer , statement , parameters , accessControl ) ; Analysis analysis = new Analysis ( rewrittenStatement , parameters , isDescribe ) ; StatementAnalyzer analyzer = new StatementAnalyzer ( analysis , metadata , sqlParser , accessControl , session ) ; - analyzer.analyze ( rewrittenStatement , Scope.create ( ) ) ; + analyzer.analyze ( rewrittenStatement , Optional.empty ( ) ) ; return analysis ; } diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ResolvedField.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ResolvedField.java index 8cea073..3755661 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ResolvedField.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ResolvedField.java @ @ -24,14 +24,16 @ @ public class ResolvedField { private final Scope scope ; private final Field field ; - private final int fieldIndex ; + private final int hierarchyFieldIndex ; + private final int relationFieldIndex ; private final boolean local ; - public ResolvedField ( Scope scope , Field field , int fieldIndex , boolean local ) + public ResolvedField ( Scope scope , Field field , int hierarchyFieldIndex , int relationFieldIndex , boolean local ) { this.scope = requireNonNull ( scope , `` scope is null '' ) Lambdas are not suffciently verified during analyzis __EoT__ Query : `` ` select filter ( array [ 5 ] , x - > x + a > 0 ) from ( VALUES ( 1,2 ) ) t ( a , b ) ; `` ` fails with : `` ` Query 20170215_110307_00000_geqw6 failed : No type for symbol field `` ` This should be addressed after # 7354 and # 7315 are merged . FYI : @ martint @ kokosing
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java index e6a20f5..42b0927 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java @ @ -39,7 +39,6 @ @ import com.facebook.presto.sql.tree.InListExpression ; import com.facebook.presto.sql.tree.InPredicate ; import com.facebook.presto.sql.tree.IsNotNullPredicate ; import com.facebook.presto.sql.tree.IsNullPredicate ; -import com.facebook.presto.sql.tree.LambdaArgumentDeclaration ; import com.facebook.presto.sql.tree.LambdaExpression ; import com.facebook.presto.sql.tree.LikePredicate ; import com.facebook.presto.sql.tree.Literal ; @ @ -59,23 +58,22 @ @ import com.facebook.presto.sql.tree.TryExpression ; import com.facebook.presto.sql.tree.WhenClause ; import com.facebook.presto.sql.tree.Window ; import com.facebook.presto.sql.tree.WindowFrame ; -import com.facebook.presto.util.maps.IdentityLinkedHashMap ; import com.google.common.collect.ImmutableList ; -import com.google.common.collect.ImmutableSet ; import com.google.common.collect.Iterables ; import javax.annotation.Nullable ; import java.util.List ; import java.util.Optional ; -import java.util.Set ; import static com.facebook.presto.sql.NodeUtils.getSortItemsFromOrderBy ; +import static com.facebook.presto.sql.analyzer.ScopeReferenceExtractor.getReferencesToScope ; import static com.facebook.presto.sql.analyzer.SemanticErrorCode.MUST_BE_AGGREGATE_OR_GROUP_BY ; import static com.facebook.presto.sql.analyzer.SemanticErrorCode.MUST_BE_AGGREGATION_FUNCTION ; import static com.facebook.presto.sql.analyzer.SemanticErrorCode.NESTED_AGGREGATION ; import static com.facebook.presto.sql.analyzer.SemanticErrorCode.NESTED_WINDOW ; import static com.facebook.presto.sql.analyzer.SemanticErrorCode.NOT_SUPPORTED ; +import static com.facebook.presto.sql.analyzer.SemanticErrorCode.REFERENCE_TO_OUTPUT_ATTRIBUTE_WITHIN_ORDER_BY_AGGREGATION ; import static com.facebook.presto.util.ImmutableCollectors.toImmutableList ; import static com.google.common.base.Preconditions.checkArgument ; import static com.google.common.base.Preconditions.checkState ; @ @ -91,36 +89,48 @ @ class AggregationAnalyzer private final List < Expression > expressions ; private final Metadata metadata ; - private final Set < Expression > columnReferences ; - private final IdentityLinkedHashMap < Identifier , LambdaArgumentDeclaration > lambdaArgumentReferences ; - private final List < Expression > parameters ; - private final boolean isDescribe ; + private final Analysis analysis ; - private final Scope scope ; + private final Lambdas are not suffciently verified during analyzis __EoT__ Query : `` ` select filter ( array [ 5 ] , x - > x + a > 0 ) from ( VALUES ( 1,2 ) ) t ( a , b ) ; `` ` fails with : `` ` Query 20170215_110307_00000_geqw6 failed : No type for symbol field `` ` This should be addressed after # 7354 and # 7315 are merged . FYI : @ martint @ kokosing
diff -- git a/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java b/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java index e131eb1..a6cd781 100644 -- - a/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java +++ b/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java @ @ -56,6 +56,7 @ @ public final class SystemSessionProperties public static final String PLAN_WITH_TABLE_NODE_PARTITIONING = `` plan_with_table_node_partitioning '' ; public static final String INITIAL_SPLITS_PER_NODE = `` initial_splits_per_node '' ; public static final String SPLIT_CONCURRENCY_ADJUSTMENT_INTERVAL = `` split_concurrency_adjustment_interval '' ; + public static final String OPTIMIZE_METADATA_QUERIES = `` optimize_metadata_queries '' ; private final List < PropertyMetadata < ? > > sessionProperties ; @ @ -192,6 +193,11 @ @ public final class SystemSessionProperties false , value - > Duration.valueOf ( ( String ) value ) ) , booleanSessionProperty ( + OPTIMIZE_METADATA_QUERIES , + `` Enable optimization for metadata queries '' , + featuresConfig.isOptimizeMetadataQueries ( ) , + false ) , + booleanSessionProperty ( PLAN_WITH_TABLE_NODE_PARTITIONING , `` Experimental : Adapt plan to pre-partitioned tables '' , true , @ @ -288,6 +294,11 @ @ public final class SystemSessionProperties return session.getProperty ( DICTIONARY_AGGREGATION , Boolean.class ) ; } + public static boolean isOptimizeMetadataQueries ( Session session ) + { + return session.getProperty ( OPTIMIZE_METADATA_QUERIES , Boolean.class ) ; + } + public static DataSize getQueryMaxMemory ( Session session ) { return session.getProperty ( QUERY_MAX_MEMORY , DataSize.class ) ; diff -- Add session property for MetadataQueryOptimizer __EoT__ Currently , the optimizer can only the activated via a global configuration option . We should add a session property to be able to turn it on for specific queries .
diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java index d41568d..1000b05 100644 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java +++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java @ @ -88,7 +88,10 @ @ import org.apache.hadoop.hive.ql.exec.FileSinkOperator ; import org.apache.hadoop.mapred.JobConf ; import org.joda.time.DateTimeZone ; +import java.io.File ; import java.io.IOException ; +import java.net.MalformedURLException ; +import java.net.URL ; import java.util.ArrayList ; import java.util.Collection ; import java.util.Iterator ; @ @ -128,6 +131,7 @ @ import static com.facebook.presto.hive.HiveSessionProperties.isCollectColumnStat import static com.facebook.presto.hive.HiveSessionProperties.isRespectTableFormat ; import static com.facebook.presto.hive.HiveSessionProperties.isSortedWritingEnabled ; import static com.facebook.presto.hive.HiveSessionProperties.isStatisticsEnabled ; +import static com.facebook.presto.hive.HiveTableProperties.AVRO_SCHEMA_URL ; import static com.facebook.presto.hive.HiveTableProperties.BUCKETED_BY_PROPERTY ; import static com.facebook.presto.hive.HiveTableProperties.BUCKET_COUNT_PROPERTY ; import static com.facebook.presto.hive.HiveTableProperties.EXTERNAL_LOCATION_PROPERTY ; @ @ -136,6 +140,7 @ @ import static com.facebook.presto.hive.HiveTableProperties.ORC_BLOOM_FILTER_FPP ; import static com.facebook.presto.hive.HiveTableProperties.PARTITIONED_BY_PROPERTY ; import static com.facebook.presto.hive.HiveTableProperties.SORTED_BY_PROPERTY ; import static com.facebook.presto.hive.HiveTableProperties.STORAGE_FORMAT_PROPERTY ; +import static com.facebook.presto.hive.HiveTableProperties.getAvroSchemaUrl ; import static com.facebook.presto.hive.HiveTableProperties.getBucketProperty ; import static com.facebook.presto.hive.HiveTableProperties.getExternalLocation ; import static com.facebook.presto.hive.HiveTableProperties.getHiveStorageFormat ; @ @ -206,6 +211,7 @ @ public class HiveMetadata private static final String ORC_BLOOM_FILTER_FPP_KEY = `` orc.bloom.filter.fpp '' ; private static final String PARTITIONS_TABLE_SUFFIX = `` $ partitions '' ; + private static final String AVRO_SCHEMA_URL_KEY = `` avro.schema.url '' ; private final boolean allowCorruptWritesForTesting ; private final SemiTransactionalHiveMetastore metastore ; @ @ -432,6 +438,12 @ @ public class HiveMetadata properties.put ( ORC_BLOOM_FILTER_FPP , Double.parseDouble ( orcBloomFilterFfp ) ) ; } + // Avro specfic property Presto Schema not correct when we use `` avro.schema.url '' properties to create table in hive . __EoT__ HiveMetaStore provide `` client.get_schema '' to get correct table schema from hive . Presto only use `` client.get_table '' to get the `` org.apache.hadoop.hive.metastore.api.Table '' and then get the MColumnDescriptor from this `` Table '' instance . In our cases , we use `` avro.schema.url '' to create table , and update the schema file in hdfs . Then this problems happened . When we run `` describe table '' command in Presto , the schemas is not correct . But we run same command in hive , its correct . This because Hive use `` get_schema '' function to get correct schema . Hive will do some special process in `` get_schema '' , such as bellow codes : `` ` try { tbl = get_table_core ( db , base_table_name ) ; } catch ( NoSuchObjectException e ) { throw new UnknownTableException ( e.getMessage ( ) ) ; } if ( null == tbl.getSd ( ) .getSerdeInfo ( ) .getSerializationLib ( ) || hiveConf.getStringCollection ( ConfVars.SERDESUSINGMETASTOREFORSCHEMA.varname ) .contains ( tbl.getSd ( ) .getSerdeInfo ( ) .getSerializationLib ( ) ) ) {
diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java index d41568d..0886c4e 100644 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java +++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java @ @ -88,7 +88,10 @ @ import org.apache.hadoop.hive.ql.exec.FileSinkOperator ; import org.apache.hadoop.mapred.JobConf ; import org.joda.time.DateTimeZone ; +import java.io.File ; import java.io.IOException ; +import java.net.MalformedURLException ; +import java.net.URL ; import java.util.ArrayList ; import java.util.Collection ; import java.util.Iterator ; @ @ -128,6 +131,7 @ @ import static com.facebook.presto.hive.HiveSessionProperties.isCollectColumnStat import static com.facebook.presto.hive.HiveSessionProperties.isRespectTableFormat ; import static com.facebook.presto.hive.HiveSessionProperties.isSortedWritingEnabled ; import static com.facebook.presto.hive.HiveSessionProperties.isStatisticsEnabled ; +import static com.facebook.presto.hive.HiveTableProperties.AVRO_SCHEMA_URL ; import static com.facebook.presto.hive.HiveTableProperties.BUCKETED_BY_PROPERTY ; import static com.facebook.presto.hive.HiveTableProperties.BUCKET_COUNT_PROPERTY ; import static com.facebook.presto.hive.HiveTableProperties.EXTERNAL_LOCATION_PROPERTY ; @ @ -136,6 +140,7 @ @ import static com.facebook.presto.hive.HiveTableProperties.ORC_BLOOM_FILTER_FPP ; import static com.facebook.presto.hive.HiveTableProperties.PARTITIONED_BY_PROPERTY ; import static com.facebook.presto.hive.HiveTableProperties.SORTED_BY_PROPERTY ; import static com.facebook.presto.hive.HiveTableProperties.STORAGE_FORMAT_PROPERTY ; +import static com.facebook.presto.hive.HiveTableProperties.getAvroSchemaUrl ; import static com.facebook.presto.hive.HiveTableProperties.getBucketProperty ; import static com.facebook.presto.hive.HiveTableProperties.getExternalLocation ; import static com.facebook.presto.hive.HiveTableProperties.getHiveStorageFormat ; @ @ -206,6 +211,7 @ @ public class HiveMetadata private static final String ORC_BLOOM_FILTER_FPP_KEY = `` orc.bloom.filter.fpp '' ; private static final String PARTITIONS_TABLE_SUFFIX = `` $ partitions '' ; + public static final String AVRO_SCHEMA_URL_KEY = `` avro.schema.url '' ; private final boolean allowCorruptWritesForTesting ; private final SemiTransactionalHiveMetastore metastore ; @ @ -432,6 +438,12 @ @ public class HiveMetadata properties.put ( ORC_BLOOM_FILTER_FPP , Double.parseDouble ( orcBloomFilterFfp ) ) ; } + // Avro specfic property Presto Schema not correct when we use `` avro.schema.url '' properties to create table in hive . __EoT__ HiveMetaStore provide `` client.get_schema '' to get correct table schema from hive . Presto only use `` client.get_table '' to get the `` org.apache.hadoop.hive.metastore.api.Table '' and then get the MColumnDescriptor from this `` Table '' instance . In our cases , we use `` avro.schema.url '' to create table , and update the schema file in hdfs . Then this problems happened . When we run `` describe table '' command in Presto , the schemas is not correct . But we run same command in hive , its correct . This because Hive use `` get_schema '' function to get correct schema . Hive will do some special process in `` get_schema '' , such as bellow codes : `` ` try { tbl = get_table_core ( db , base_table_name ) ; } catch ( NoSuchObjectException e ) { throw new UnknownTableException ( e.getMessage ( ) ) ; } if ( null == tbl.getSd ( ) .getSerdeInfo ( ) .getSerializationLib ( ) || hiveConf.getStringCollection ( ConfVars.SERDESUSINGMETASTOREFORSCHEMA.varname ) .contains ( tbl.getSd ( ) .getSerdeInfo ( ) .getSerializationLib ( ) ) ) {
diff -- git a/presto-main/src/main/java/com/facebook/presto/operator/ArrayUnnester.java b/presto-main/src/main/java/com/facebook/presto/operator/ArrayUnnester.java index 4d88468..c15b8a3 100644 -- - a/presto-main/src/main/java/com/facebook/presto/operator/ArrayUnnester.java +++ b/presto-main/src/main/java/com/facebook/presto/operator/ArrayUnnester.java @ @ -27,11 +27,11 @ @ public class ArrayUnnester implements Unnester { private final Type elementType ; - private final Block arrayBlock ; + private Block arrayBlock ; private final int channelCount ; private int position ; - private final int positionCount ; + private int positionCount ; public ArrayUnnester ( ArrayType arrayType , @ Nullable Block arrayBlock ) { @ @ -66,4 +66,12 @ @ public class ArrayUnnester { appendTo ( pageBuilder , outputChannelOffset ) ; } + + @ Override + public void setBlock ( @ Nullable Block arrayBlock ) + { + this.arrayBlock = arrayBlock ; + this.position = 0 ; + this.positionCount = arrayBlock == null ? 0 : arrayBlock.getPositionCount ( ) ; + } } diff -- git a/presto-main/src/main/java/com/facebook/presto/operator/MapUnnester.java b/presto-main/src/main/java/com/facebook/presto/operator/MapUnnester.java index b2f3265..aa9ab67 100644 -- - a/presto-main/src/main/java/com/facebook/presto/operator/MapUnnester.java +++ b/presto-main/src/main/java/com/facebook/presto/operator/MapUnnester.java @ @ -28,11 +28,11 @ @ public class MapUnnester { private final Type keyType ; private final Type valueType ; - private final Block block ; + private Block block ; private final int channelCount ; private int position ; - private final int positionCount ; + private int positionCount ; public MapUnnester ( Create unnesters in UnnestOperator once __EoT__ Currently , the list of type-specific unnesters is created for every page . This should n't be necessary , as the types are known statically when the operator is constructed .
diff -- git a/presto-product-tests/README.md b/presto-product-tests/README.md index e0091ed..a6220e6 100644 -- - a/presto-product-tests/README.md +++ b/presto-product-tests/README.md @ @ -35,7 +35,16 @ @ broken . pip install docker-compose `` ` - # # # OS X ( 10.8 `` Mountain Lion '' or newer ) + # # # OS X using Docker for Mac ( macOS 10.10.3 Yosemite or newer ) [ PREFERED WAY ] + +* Docker for Mac has to be installed . +For details follow the link : https : //docs.docker.com/engine/installation/mac/ # /docker-for-mac + +* Add entries in /etc/hosts for all services running in docker containers : + ` hadoop-master ` , ` mysql ` , ` postgres ` , ` presto-master ` . +They should point to your external IP address ( shown by ` ifconfig ` on your Mac ( not inside docker ) ) . + + # # # OS X using Docker Toolbox ( 10.8 `` Mountain Lion '' or newer ) [ NOT RECOMMENDED ] * [ ` VirtualBox > = 5.0 ` ] ( https : //www.virtualbox.org/wiki/Downloads ) @ @ -56,7 +65,7 @ @ Terminal '' icon located in ~/Applications/Docker . Note that all commands listed in subsequent parts of this tutorial must Update product-tests README for new Mac Docker __EoT__ Docker is now natively supported on Mac , so the VirtualBox / Docker Toolbox instructions should be updated . I think the steps are - Install Docker for Mac : download the DMG , copy to Applications , run the Docker application to install . - Increase Docker memory : click the Docker icon in the menu bar , choose Preferences , increase memory slider to 4 GB . Everything after that seems to work automatically ( no need to use ` docker-machine ` or ` eval ` ) .
diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveErrorCode.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveErrorCode.java index 2ca5348..31b637a 100644 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/HiveErrorCode.java +++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveErrorCode.java @ @ -46,7 +46,7 @ @ public enum HiveErrorCode HIVE_PARTITION_READ_ONLY ( 20 , EXTERNAL ) , HIVE_TOO_MANY_OPEN_PARTITIONS ( 21 , EXTERNAL ) , HIVE_CONCURRENT_MODIFICATION_DETECTED ( 22 , EXTERNAL ) , - HIVE_COLUMN_ORDER_MISMATCH ( 23 , EXTERNAL ) , + HIVE_COLUMN_ORDER_MISMATCH ( 23 , USER_ERROR ) , HIVE_FILE_MISSING_COLUMN_NAMES ( 24 , EXTERNAL ) , HIVE_WRITER_OPEN_ERROR ( 25 , EXTERNAL ) , HIVE_WRITER_CLOSE_ERROR ( 26 , EXTERNAL ) , diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveType.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveType.java index 2a0059f..830d021 100644 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/HiveType.java +++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveType.java @ @ -124,20 +124,11 @ @ public final class HiveType @ Override public boolean equals ( Object o ) { - if ( this == o ) { - return true ; - } - if ( o == null || getClass ( ) ! = o.getClass ( ) ) { - return false ; - } - - HiveType hiveType = ( HiveType ) o ; - - if ( ! hiveTypeName.equals ( hiveType.hiveTypeName ) ) { + try { + return this == o || hiveTypeName.equals ( ( ( HiveType ) o ) .hiveTypeName ) ; + } catch ( Exception e ) { return HIVE_COLUMN_ORDER_MISMATCH should be USER_ERROR __EoT__ This is in ` HiveErrorCode `
diff -- git a/pom.xml b/pom.xml index 4012f97..0c864df 100644 -- - a/pom.xml +++ b/pom.xml @ @ -76,6 +76,7 @ @ < module > presto-accumulo < /module > < module > presto-cassandra < /module > < module > presto-blackhole < /module > + < module > presto-memory < /module > < module > presto-orc < /module > < module > presto-rcfile < /module > < module > presto-hive < /module > @ @ -223,6 +224,12 @ @ < dependency > < groupId > com.facebook.presto < /groupId > + < artifactId > presto-memory < /artifactId > + < version > $ { project.version } < /version > + < /dependency > + + < dependency > + < groupId > com.facebook.presto < /groupId > < artifactId > presto-base-jdbc < /artifactId > < version > $ { project.version } < /version > < /dependency > diff -- git a/presto-benchmark/pom.xml b/presto-benchmark/pom.xml index 78b0451..0bb8489 100644 -- - a/presto-benchmark/pom.xml +++ b/presto-benchmark/pom.xml @ @ -32,6 +32,11 @ @ < /dependency > < dependency > + < groupId > com.facebook.presto < /groupId > + < artifactId > presto-memory < /artifactId > + < /dependency > + + < dependency > < groupId > com.google.code.findbugs < /groupId > < artifactId how to change the data source __EoT__ Does anyone know how to change the data source itself in TPCH to my own data source in the class of TestHiddenColumns ? Is the dataSource of TPCH produced by the class of TableScanNode ? What should I do to achieve ?
diff -- git a/presto-cli/src/test/java/com/facebook/presto/cli/TestQueryRunner.java b/presto-cli/src/test/java/com/facebook/presto/cli/TestQueryRunner.java index 5432f7a..52b1bea 100644 -- - a/presto-cli/src/test/java/com/facebook/presto/cli/TestQueryRunner.java +++ b/presto-cli/src/test/java/com/facebook/presto/cli/TestQueryRunner.java @ @ -122,6 +122,7 @ @ public class TestQueryRunner StatementStats.builder ( ) .setState ( `` FINISHED '' ) .build ( ) , //new StatementStats ( `` FINISHED '' , false , true , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , null ) , null , + ImmutableList.of ( ) , null , null ) ; return QUERY_RESULTS_CODEC.toJson ( queryResults ) ; diff -- git a/presto-client/src/main/java/com/facebook/presto/client/QueryResults.java b/presto-client/src/main/java/com/facebook/presto/client/QueryResults.java index 86593d3..df8ac62 100644 -- - a/presto-client/src/main/java/com/facebook/presto/client/QueryResults.java +++ b/presto-client/src/main/java/com/facebook/presto/client/QueryResults.java @ @ -13,6 +13,7 @ @ */ package com.facebook.presto.client ; +import com.facebook.presto.spi.PrestoWarning ; import com.fasterxml.jackson.annotation.JsonCreator ; import com.fasterxml.jackson.annotation.JsonProperty ; import com.google.common.collect.ImmutableList ; @ @ -42,6 +43,7 @ @ public class QueryResults private final Iterable < List < Object > > data ; private final StatementStats stats ; private final QueryError error ; + private final List < PrestoWarning > warnings ; private final String updateType ; private final Long updateCount ; @ @ -55,10 +57,11 @ @ public class QueryResults @ JsonProperty ( `` data '' ) List < List < Object > > The presto-jdbc Statement.execute ( ) method returns true even for DDL statements __EoT__ If a ddl task is not yet submitted a default empty QueryResults is returned to the client which has getUpdateType == null when it should be set to the task name ( ex . `` CREATE TABLE '' , `` CREATE SCHEMA '' , etc. ) . From com.facebook.presto.jdbc.PrestoStatement.internalExecute ( ) : `` ` if ( client.currentStatusInfo ( ) .getUpdateType ( ) == null ) { currentResult.set ( resultSet ) ; return true ; } `` ` From com.facebook.presto.server.protocol.Query.getNextResults ( ) : `` ` // if query query submission has not finished , return simple empty result if ( ! submissionFuture.isDone ( ) ) { QueryResults queryResults = new QueryResults ( queryId.toString ( ) , queryHtmlUri , null , createNextResultsUri ( scheme , uriInfo ) , null , null , StatementStats.builder ( ) .setState ( QueryState.QUEUED.toString ( ) ) .setQueued ( true ) .setScheduled ( false ) .build ( ) , null , ImmutableList.of ( ) , null , null ) ; cacheLastResults ( queryResults ) ; return queryResults ; } `` `
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ExpressionAnalysis.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ExpressionAnalysis.java index ced62d2..53c7d63 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ExpressionAnalysis.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ExpressionAnalysis.java @ @ -88,9 +88,9 @ @ public class ExpressionAnalysis return typeOnlyCoercions.contains ( expression ) ; } - public Set < Expression > getColumnReferences ( ) + public boolean isColumnReference ( Expression node ) { - return columnReferences ; + return columnReferences.contains ( node ) ; } public Set < InPredicate > getSubqueryInPredicates ( ) diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ExpressionAnalyzer.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ExpressionAnalyzer.java index 7a098e0..51f1ce8 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ExpressionAnalyzer.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ExpressionAnalyzer.java @ @ -143,7 +143,6 @ @ import static com.facebook.presto.util.DateTimeUtils.parseTimestampLiteral ; import static com.facebook.presto.util.DateTimeUtils.timeHasTimeZone ; import static com.facebook.presto.util.DateTimeUtils.timestampHasTimeZone ; import static com.facebook.presto.util.MoreSets.newIdentityHashSet ; -import static com.google.common.base.Preconditions.checkArgument ; import static com.google.common.base.Preconditions.checkState ; import static com.google.common.base.Verify.verify ; import static com.google.common.collect.ImmutableList.toImmutableList ; @ @ -203,6 +202,16 @ @ public class ExpressionAnalyzer return expressionTypes ; } + public Type setExpressionType ( Expression expression , Type type ) + { + requireNonNull ( expression , `` expression can not be null '' ) ; + requireNonNull ( type , `` type can not be null '' ) ; + + expressionTypes.put ( expression , type ) ; + + return type ; + } + public IdentityLinkedHashMap < Expression , Type > getExpressionCoercions ( ) { Bad error message when lambda expression references column in enclosing query __EoT__ `` ` sql SELECT filter ( a , v - > v > = c ) FROM ( VALUES ( 1 , array [ 1 ] ) ) t ( c , a ) ) `` ` Fails with : `` ` Query 20161229_202516_00011_suq2a failed : No type for symbol field java.lang.IllegalArgumentException : No type for symbol field at com.google.common.base.Preconditions.checkArgument ( Preconditions.java:145 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.visitSymbolReference ( ExpressionAnalyzer.java:334 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.visitSymbolReference ( ExpressionAnalyzer.java:255 ) at com.facebook.presto.sql.tree.SymbolReference.accept ( SymbolReference.java:41 ) at com.facebook.presto.sql.tree.StackableAstVisitor.process ( StackableAstVisitor.java:26 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.process ( ExpressionAnalyzer.java:274 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.getOperator ( ExpressionAnalyzer.java:1126 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.visitComparisonExpression ( ExpressionAnalyzer.java:424 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.visitComparisonExpression ( ExpressionAnalyzer.java:255 ) at com.facebook.presto.sql.tree.ComparisonExpression.accept ( ComparisonExpression.java:71 ) at com.facebook.presto.sql.tree.StackableAstVisitor.process ( StackableAstVisitor.java:26 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.process ( ExpressionAnalyzer.java:274 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer.analyze ( ExpressionAnalyzer.java:237 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer.access $ 1800 ( ExpressionAnalyzer.java:152 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.lambda $ visitFunctionCall $ 1 ( ExpressionAnalyzer.java:810 ) at com.facebook.presto.sql.analyzer.TypeSignatureProvider.getTypeSignature ( TypeSignatureProvider.java:61 ) at com.facebook.presto.metadata.SignatureBinder $ FunctionSolver.update ( SignatureBinder.java:725 ) at com.facebook.presto.metadata.SignatureBinder.iterativeSolve ( SignatureBinder.java:399 ) at com.facebook.presto.metadata.SignatureBinder.bindVariables ( SignatureBinder.java:114 ) at com.facebook.presto.metadata.SignatureBinder.bind ( SignatureBinder.java:91 ) at com.facebook.presto.metadata.FunctionRegistry.identifyApplicableFunctions ( FunctionRegistry.java:692 ) at
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java index 28b8eda..ed705ff 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java @ @ -144,7 +144,10 @ @ class AggregationAnalyzer // For a query like `` SELECT * FROM T GROUP BY a '' , groupByExpressions will contain `` a '' , // and the '* ' will be expanded to Field references . Therefore we translate all simple name expressions // in the group by clause to fields they reference so that the expansion from '* ' can be matched against them - for ( Expression expression : Iterables.filter ( expressions , analysis.getColumnReferences ( ) : :contains ) ) { + List < Expression > nonFieldReferenceGroupingExpressions = expressions.stream ( ) + .filter ( expression - > analysis.getColumnReferences ( ) .contains ( expression ) & & ! ( expression instanceof FieldReference ) ) + .collect ( toImmutableList ( ) ) ; + for ( Expression expression : nonFieldReferenceGroupingExpressions ) { QualifiedName name ; if ( expression instanceof Identifier ) { name = QualifiedName.of ( ( ( Identifier ) expression ) .getName ( ) ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analysis.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analysis.java index 1857fa0..2a1c07c 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analysis.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analysis.java @ @ -47,6 +47,7 @ @ import javax.annotation.concurrent.Immutable ; import java.util.ArrayDeque Bad error message when lambda expression references column in enclosing query __EoT__ `` ` sql SELECT filter ( a , v - > v > = c ) FROM ( VALUES ( 1 , array [ 1 ] ) ) t ( c , a ) ) `` ` Fails with : `` ` Query 20161229_202516_00011_suq2a failed : No type for symbol field java.lang.IllegalArgumentException : No type for symbol field at com.google.common.base.Preconditions.checkArgument ( Preconditions.java:145 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.visitSymbolReference ( ExpressionAnalyzer.java:334 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.visitSymbolReference ( ExpressionAnalyzer.java:255 ) at com.facebook.presto.sql.tree.SymbolReference.accept ( SymbolReference.java:41 ) at com.facebook.presto.sql.tree.StackableAstVisitor.process ( StackableAstVisitor.java:26 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.process ( ExpressionAnalyzer.java:274 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.getOperator ( ExpressionAnalyzer.java:1126 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.visitComparisonExpression ( ExpressionAnalyzer.java:424 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.visitComparisonExpression ( ExpressionAnalyzer.java:255 ) at com.facebook.presto.sql.tree.ComparisonExpression.accept ( ComparisonExpression.java:71 ) at com.facebook.presto.sql.tree.StackableAstVisitor.process ( StackableAstVisitor.java:26 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.process ( ExpressionAnalyzer.java:274 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer.analyze ( ExpressionAnalyzer.java:237 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer.access $ 1800 ( ExpressionAnalyzer.java:152 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.lambda $ visitFunctionCall $ 1 ( ExpressionAnalyzer.java:810 ) at com.facebook.presto.sql.analyzer.TypeSignatureProvider.getTypeSignature ( TypeSignatureProvider.java:61 ) at com.facebook.presto.metadata.SignatureBinder $ FunctionSolver.update ( SignatureBinder.java:725 ) at com.facebook.presto.metadata.SignatureBinder.iterativeSolve ( SignatureBinder.java:399 ) at com.facebook.presto.metadata.SignatureBinder.bindVariables ( SignatureBinder.java:114 ) at com.facebook.presto.metadata.SignatureBinder.bind ( SignatureBinder.java:91 ) at com.facebook.presto.metadata.FunctionRegistry.identifyApplicableFunctions ( FunctionRegistry.java:692 ) at
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java index 28b8eda..c1e3677 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/AggregationAnalyzer.java @ @ -47,7 +47,6 @ @ import com.facebook.presto.sql.tree.Node ; import com.facebook.presto.sql.tree.NotExpression ; import com.facebook.presto.sql.tree.NullIfExpression ; import com.facebook.presto.sql.tree.Parameter ; -import com.facebook.presto.sql.tree.QualifiedName ; import com.facebook.presto.sql.tree.Row ; import com.facebook.presto.sql.tree.SearchedCaseExpression ; import com.facebook.presto.sql.tree.SimpleCaseExpression ; @ @ -59,16 +58,19 @ @ import com.facebook.presto.sql.tree.WhenClause ; import com.facebook.presto.sql.tree.Window ; import com.facebook.presto.sql.tree.WindowFrame ; import com.google.common.collect.ImmutableList ; -import com.google.common.collect.Iterables ; import javax.annotation.Nullable ; import java.util.List ; +import java.util.Map ; import java.util.Optional ; +import java.util.Set ; import static com.facebook.presto.sql.NodeUtils.getSortItemsFromOrderBy ; import static com.facebook.presto.sql.analyzer.LambdaReferenceExtractor.hasReferencesToLambdaArgument ; import static com.facebook.presto.sql.analyzer.ScopeReferenceExtractor.getReferencesToScope ; +import static com.facebook.presto.sql.analyzer.ScopeReferenceExtractor.hasReferencesToScope ; +import static com.facebook.presto.sql.analyzer.ScopeReferenceExtractor.isFieldFromScope ; import static com.facebook.presto.sql.analyzer.SemanticErrorCode.MUST_BE_AGGREGATE_OR_GROUP_BY ; import static com.facebook.presto.sql.analyzer.SemanticErrorCode.MUST_BE_AGGREGATION_FUNCTION ; import static com.facebook.presto.sql.analyzer.SemanticErrorCode.NESTED_AGGREGATION ; @ @ -78,6 +80,7 @ @ import static com.facebook.presto.sql.analyzer.SemanticErrorCode.REFERENCE_TO_OU import static com.google.common.base.Preconditions.checkArgument ; import static com.google.common.base.Preconditions.checkState ; import static com.google.common.collect.ImmutableList.toImmutableList ; +import static com.google.common.collect.ImmutableSet.toImmutableSet ; import static java.util.Objects.requireNonNull ; /** @ @ -86,8 +89,9 @ @ import static java.util.Objects.requireNonNull ; class AggregationAnalyzer { // fields and expressions in the group by clause - private final List < Integer > fieldIndexes ; + private final Set < FieldId > groupingFields ; private final List < Expression > expressions ; + private final Map < Expression , FieldId > columnReferences ; Bad error message when lambda expression references column in enclosing query __EoT__ `` ` sql SELECT filter ( a , v - > v > = c ) FROM ( VALUES ( 1 , array [ 1 ] ) ) t ( c , a ) ) `` ` Fails with : `` ` Query 20161229_202516_00011_suq2a failed : No type for symbol field java.lang.IllegalArgumentException : No type for symbol field at com.google.common.base.Preconditions.checkArgument ( Preconditions.java:145 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.visitSymbolReference ( ExpressionAnalyzer.java:334 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.visitSymbolReference ( ExpressionAnalyzer.java:255 ) at com.facebook.presto.sql.tree.SymbolReference.accept ( SymbolReference.java:41 ) at com.facebook.presto.sql.tree.StackableAstVisitor.process ( StackableAstVisitor.java:26 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.process ( ExpressionAnalyzer.java:274 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.getOperator ( ExpressionAnalyzer.java:1126 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.visitComparisonExpression ( ExpressionAnalyzer.java:424 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.visitComparisonExpression ( ExpressionAnalyzer.java:255 ) at com.facebook.presto.sql.tree.ComparisonExpression.accept ( ComparisonExpression.java:71 ) at com.facebook.presto.sql.tree.StackableAstVisitor.process ( StackableAstVisitor.java:26 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.process ( ExpressionAnalyzer.java:274 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer.analyze ( ExpressionAnalyzer.java:237 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer.access $ 1800 ( ExpressionAnalyzer.java:152 ) at com.facebook.presto.sql.analyzer.ExpressionAnalyzer $ Visitor.lambda $ visitFunctionCall $ 1 ( ExpressionAnalyzer.java:810 ) at com.facebook.presto.sql.analyzer.TypeSignatureProvider.getTypeSignature ( TypeSignatureProvider.java:61 ) at com.facebook.presto.metadata.SignatureBinder $ FunctionSolver.update ( SignatureBinder.java:725 ) at com.facebook.presto.metadata.SignatureBinder.iterativeSolve ( SignatureBinder.java:399 ) at com.facebook.presto.metadata.SignatureBinder.bindVariables ( SignatureBinder.java:114 ) at com.facebook.presto.metadata.SignatureBinder.bind ( SignatureBinder.java:91 ) at com.facebook.presto.metadata.FunctionRegistry.identifyApplicableFunctions ( FunctionRegistry.java:692 ) at
diff -- git a/presto-main/src/main/java/com/facebook/presto/operator/InMemoryJoinHash.java b/presto-main/src/main/java/com/facebook/presto/operator/InMemoryJoinHash.java index b9836b3..2ae74db 100644 -- - a/presto-main/src/main/java/com/facebook/presto/operator/InMemoryJoinHash.java +++ b/presto-main/src/main/java/com/facebook/presto/operator/InMemoryJoinHash.java @ @ -15,13 +15,15 @ @ package com.facebook.presto.operator ; import com.facebook.presto.spi.Page ; import com.facebook.presto.spi.PageBuilder ; -import com.facebook.presto.spi.block.Block ; import com.google.common.primitives.Ints ; import io.airlift.units.DataSize ; import it.unimi.dsi.fastutil.HashCommon ; import it.unimi.dsi.fastutil.longs.LongArrayList ; +import javax.annotation.Nullable ; + import java.util.Arrays ; +import java.util.Optional ; import static com.facebook.presto.operator.SyntheticAddress.decodePosition ; import static com.facebook.presto.operator.SyntheticAddress.decodeSliceIndex ; @ @ -37,24 +39,28 @ @ public final class InMemoryJoinHash private final LongArrayList addresses ; private final PagesHashStrategy pagesHashStrategy ; + // we unwrap Optinal < JoinFilterFunctionVerifier > to actual verifier or null in constructor for performance reasons + // we do quick check for ` filterFunctionVerifier == null ` in ` getNextJoinPositionFrom ` to avoid calls to applyFilterFunction + @ Nullable + private final JoinFilterFunctionVerifier filterFunctionVerifier ; + private final int channelCount ; private final int mask ; private final int [ ] key ; private final int [ ] positionLinks ; private final long size ; - private final boolean filterFunctionPresent ; // Native array of hashes for faster collisions resolution compared // to accessing values in blocks . We use bytes to reduce memory foot print // and there is no performance gain from storing full non-equi join for left ( right ) join ? __EoT__ Hi , I tested the feature of simple non-equi join , it works fine for inner join as I expected . I 'd like to know is there any plan to support non-equi left join and non-equi right join ? It will be really helpful to me ! Thanks ! @ cberner
diff -- git a/presto-tests/pom.xml b/presto-tests/pom.xml index 6d35669..b2f05af 100644 -- - a/presto-tests/pom.xml +++ b/presto-tests/pom.xml @ @ -197,7 +197,6 @ @ < exclude > **/TestDistributedQueriesNoHashGeneration.java < /exclude > < exclude > **/TestLocalQueries.java < /exclude > < exclude > **/TestLocalQueriesIndexed.java < /exclude > - < exclude > **/TestLocalBinarySpilledQueries.java < /exclude > < /excludes > < /configuration > < /plugin > @ @ -233,7 +232,6 @ @ < include > **/TestDistributedQueriesNoHashGeneration.java < /include > < include > **/TestLocalQueries.java < /include > < include > **/TestLocalQueriesIndexed.java < /include > - < include > **/TestLocalBinarySpilledQueries.java < /include > < /includes > < /configuration > < /plugin > diff -- git a/presto-tests/src/test/java/com/facebook/presto/tests/TestLocalBinarySpilledQueries.java b/presto-tests/src/test/java/com/facebook/presto/tests/TestLocalBinarySpilledQueries.java deleted file mode 100644 index adce683..0000000 -- - a/presto-tests/src/test/java/com/facebook/presto/tests/TestLocalBinarySpilledQueries.java +++ /dev/null @ @ -1,69 +0,0 @ @ -/* - * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - * you may not use this file except in compliance with the License . - * You may obtain a copy of the License at - * - * http : //www.apache.org/licenses/LICENSE-2.0 - * - * Unless required by applicable law or agreed to in writing , software - * distributed under the License is distributed on an Presto tests TEST_SPECIFIC_MODULES=presto-tests take a long time __EoT__ For example : https : //travis-ci.org/prestodb/presto/builds/337969486 . ` TEST_SPECIFIC_MODULES=presto-tests ` takes now about 1h while other jobs mostly around 30mins . We should probably split this into two jobs or address testing holistically . FYI : @ findepi @ electrum
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java index 67efb70..da50ce1 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java @ @ -37,7 +37,6 @ @ import com.facebook.presto.sql.planner.plan.ValuesNode ; import com.google.common.collect.ImmutableList ; import com.google.common.collect.ImmutableMap ; import com.google.common.collect.ImmutableSet ; -import com.google.common.collect.Iterables ; import com.google.common.collect.Maps ; import java.util.ArrayList ; @ @ -186,24 +185,17 @ @ public class PlanFragmenter PartitioningScheme partitioningScheme = exchange.getPartitioningScheme ( ) ; - ImmutableList.Builder < SubPlan > builder = ImmutableList.builder ( ) ; if ( exchange.getType ( ) == ExchangeNode.Type.GATHER ) { context.get ( ) .setSingleNodeDistribution ( ) ; - - for ( int i = 0 ; i < exchange.getSources ( ) .size ( ) ; i++ ) { - FragmentProperties childProperties = new FragmentProperties ( partitioningScheme.translateOutputLayout ( exchange.getInputs ( ) .get ( i ) ) ) ; - builder.add ( buildSubPlan ( exchange.getSources ( ) .get ( i ) , childProperties , context ) ) ; - } } else if ( exchange.getType ( ) == ExchangeNode.Type.REPARTITION ) { context.get ( ) .setDistribution ( partitioningScheme.getPartitioning ( ) .getHandle ( ) ) ; - - FragmentProperties childProperties = new FragmentProperties ( partitioningScheme.translateOutputLayout ( Iterables.getOnlyElement ( exchange.getInputs ( ) ) ) ) ; - builder.add ( buildSubPlan ( Iterables.getOnlyElement ( exchange.getSources ( ) ) , childProperties Planning failure for UNION and GROUP BY __EoT__ The following query : `` ` WITH t1 AS ( SELECT 1 FROM tpch.tiny.nation GROUP BY 1 ) , t2 AS ( SELECT 1 FROM tpch.tiny.nation UNION ALL SELECT 1 FROM tpch.tiny.nation ) SELECT 1 FROM t1 UNION ALL SELECT 1 FROM t2 `` ` Fails during planning with : `` ` java.lang.IllegalStateException : Can not set distribution to ROUND_ROBIN . Already set to Optional [ HASH ] at com.google.common.base.Preconditions.checkState ( Preconditions.java:721 ) at com.facebook.presto.sql.planner.PlanFragmenter $ FragmentProperties.setDistribution ( PlanFragmenter.java:259 ) at com.facebook.presto.sql.planner.PlanFragmenter $ Fragmenter.visitExchange ( PlanFragmenter.java:192 ) at com.facebook.presto.sql.planner.PlanFragmenter $ Fragmenter.visitExchange ( PlanFragmenter.java:84 ) at com.facebook.presto.sql.planner.plan.ExchangeNode.accept ( ExchangeNode.java:195 ) at com.facebook.presto.sql.planner.plan.SimplePlanRewriter $ RewriteContext.rewrite ( SimplePlanRewriter.java:84 ) at com.facebook.presto.sql.planner.plan.SimplePlanRewriter $ RewriteContext.lambda $ defaultRewrite $ 0 ( SimplePlanRewriter.java:73 ) at java.util.stream.ReferencePipeline $ 3 $ 1.accept ( ReferencePipeline.java:193 ) at java.util.Spliterators $ ArraySpliterator.forEachRemaining ( Spliterators.java:948 ) at java.util.stream.AbstractPipeline.copyInto ( AbstractPipeline.java:481 ) at java.util.stream.AbstractPipeline.wrapAndCopyInto ( AbstractPipeline.java:471 ) at java.util.stream.ReduceOps $ ReduceOp.evaluateSequential ( ReduceOps.java:708 ) at java.util.stream.AbstractPipeline.evaluate ( AbstractPipeline.java:234 ) at java.util.stream.ReferencePipeline.collect ( ReferencePipeline.java:499 ) at com.facebook.presto.sql.planner.plan.SimplePlanRewriter $ RewriteContext.defaultRewrite ( SimplePlanRewriter.java:74 ) at com.facebook.presto.sql.planner.PlanFragmenter $ Fragmenter.visitExchange ( PlanFragmenter.java:183 ) at com.facebook.presto.sql.planner.PlanFragmenter $ Fragmenter.visitExchange ( PlanFragmenter.java:84 ) at com.facebook.presto.sql.planner.plan.ExchangeNode.accept ( ExchangeNode.java:195 ) at com.facebook.presto.sql.planner.plan.SimplePlanRewriter $ RewriteContext.rewrite ( SimplePlanRewriter.java:84
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/SubqueryPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/SubqueryPlanner.java index 0334319..cd8c5a1 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/SubqueryPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/SubqueryPlanner.java @ @ -16,7 +16,6 @ @ package com.facebook.presto.sql.planner ; import com.facebook.presto.Session ; import com.facebook.presto.metadata.Metadata ; import com.facebook.presto.sql.analyzer.Analysis ; -import com.facebook.presto.sql.planner.optimizations.Predicates ; import com.facebook.presto.sql.planner.plan.AggregationNode ; import com.facebook.presto.sql.planner.plan.ApplyNode ; import com.facebook.presto.sql.planner.plan.EnforceSingleRowNode ; @ @ -41,6 +40,7 @ @ import com.facebook.presto.sql.tree.QuantifiedComparisonExpression.Quantifier ; import com.facebook.presto.sql.tree.Query ; import com.facebook.presto.sql.tree.SubqueryExpression ; import com.facebook.presto.sql.tree.SymbolReference ; +import com.facebook.presto.util.Predicates ; import com.google.common.collect.ImmutableList ; import com.google.common.collect.ImmutableMap ; import com.google.common.collect.ImmutableSet ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/MergeProjections.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/MergeProjections.java index cd74481..96c127b 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/MergeProjections.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/MergeProjections.java @ @ -26,6 +26,7 @ @ import com.facebook.presto.sql.planner.plan.SimplePlanRewriter ; import com.facebook.presto.sql.tree.Expression ; import com.facebook.presto.sql.tree.ExpressionTreeRewriter ; import com.facebook.presto.sql.tree.TryExpression ; +import com.facebook.presto.sql.util.AstUtils ; import com.google.common.collect.ImmutableList ; import com.google.common.collect.ImmutableMap ; @ @ -83,7 +84,14 @ @ public class MergeProjections private static boolean containsTry ( ProjectNode node ) { - return node.getAssignments ( ) .values ( ) .stream ( ) .anyMatch ( TryExpression.class : :isInstance ) ; + return node.getAssignments ( ) .values ( ) .stream ( ) + .anyMatch ( Rewriter : :containsTryExpression ) ; + } + + private static boolean containsTryExpression ( Expression expression ) + { + return AstUtils.stream ( expression ) + .anyMatch ( TryExpression.class : :isInstance ) ; } } } diff Incorrect results due to improper inlining of arguments to TRY __EoT__ The following query should fail : `` ` sql SELECT TRY ( x ) IS NULL FROM ( SELECT 1/y as x FROM ( VALUES 1 , 2 , 3 , 0 , 4 ) t ( y ) ) `` ` However , it succeeds and produces this incorrect output : `` ` _col0 -- -- -- - false false false true false ( 5 rows ) `` ` This is due to this check in MergeProjections , which only tests whether TRY appears at the root of an expression : `` ` java private static boolean containsTry ( ProjectNode node ) { return node.getAssignments ( ) .values ( ) .stream ( ) .anyMatch ( TryExpression.class : :isInstance ) ; } `` `
diff -- git a/presto-docs/src/main/sphinx/sql/alter-table.rst b/presto-docs/src/main/sphinx/sql/alter-table.rst index 82f37aa..85e8af8 100644 -- - a/presto-docs/src/main/sphinx/sql/alter-table.rst +++ b/presto-docs/src/main/sphinx/sql/alter-table.rst @ @ -8,7 +8,7 @ @ Synopsis .. code-block : : none ALTER TABLE name RENAME TO new_name - ALTER TABLE name ADD COLUMN column_name data_type [ COMMENT comment ] + ALTER TABLE name ADD COLUMN column_name data_type [ COMMENT comment ] [ WITH ( property_name = expression [ , ... ] ) ] ALTER TABLE name DROP COLUMN column_name ALTER TABLE name RENAME COLUMN column_name TO new_column_name diff -- git a/presto-docs/src/main/sphinx/sql/create-table.rst b/presto-docs/src/main/sphinx/sql/create-table.rst index 05b5403..ab357c4 100644 -- - a/presto-docs/src/main/sphinx/sql/create-table.rst +++ b/presto-docs/src/main/sphinx/sql/create-table.rst @ @ -9,7 +9,7 @ @ Synopsis CREATE TABLE [ IF NOT EXISTS ] table_name ( - { column_name data_type [ COMMENT comment ] + { column_name data_type [ COMMENT comment ] [ WITH ( property_name = expression [ , ... ] ) ] | LIKE existing_table_name [ { INCLUDING | EXCLUDING } PROPERTIES ] } [ , ... ] ) @ @ -27,11 +27,15 @ @ The optional `` IF NOT EXISTS `` clause causes the error to be suppressed if the table already exists . The optional `` WITH `` clause can be used to set properties -on the newly created table . To can not create table in cassandra database __EoT__ ! [ image ] ( https : //user-images.githubusercontent.com/33027182/39687092-493fa95c-51ea-11e8-91a9-ddb630b438bf.png )
diff -- git a/presto-hive/pom.xml b/presto-hive/pom.xml index 7af09c2..7487563 100644 -- - a/presto-hive/pom.xml +++ b/presto-hive/pom.xml @ @ -128,6 +128,11 @ @ < /dependency > < dependency > + < groupId > com.google.inject.extensions < /groupId > + < artifactId > guice-multibindings < /artifactId > + < /dependency > + + < dependency > < groupId > javax.inject < /groupId > < artifactId > javax.inject < /artifactId > < /dependency > diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveClient.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveClient.java index b054d89..038d33c 100644 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/HiveClient.java +++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveClient.java @ @ -58,8 +58,8 @ @ import com.google.common.collect.AbstractIterator ; import com.google.common.collect.FluentIterable ; import com.google.common.collect.ImmutableList ; import com.google.common.collect.ImmutableMap ; +import com.google.common.collect.ImmutableSet ; import com.google.common.collect.Iterables ; -import com.google.common.collect.Lists ; import com.google.common.collect.Maps ; import com.google.common.collect.Ordering ; import com.google.inject.Inject ; @ @ -86,11 +86,11 @ @ import org.joda.time.DateTimeZone ; import java.io.IOException ; import java.util.ArrayList ; import java.util.Collection ; -import java.util.Collections ; import java.util.Iterator ; import java.util.List ; import java.util.Map ; import java.util.Map.Entry ; +import java.util.Set ; import java.util.concurrent.Executor ; import java.util.concurrent.ExecutorService ; import java.util.concurrent.TimeUnit ; @ @ -110,6 +110,7 @ @ import static com.facebook.presto.hive.HiveUtil.decodeViewData ; import static com.facebook.presto.hive.HiveUtil.encodeViewData ; import static com.facebook.presto.hive.HiveUtil.getTableStructFields ; import static com.facebook.presto.hive.HiveUtil.parseHiveTimestamp ; +import static com.facebook.presto.hive.HiveUtil.partitionIdGetter ; import static com.facebook.presto.hive.UnpartitionedPartition.UNPARTITIONED_PARTITION ; import static com.facebook.presto.hive.util.Types.checkType ; import static com.facebook.presto.spi.StandardErrorCode.PERMISSION_DENIED ; @ Add support for ORC __EoT__ Trying to read an ORC table fails with an exception . At a minimum , we probably need to upgrade to Hive 0.12 . See https : //groups.google.com/d/msg/presto-users/iKmsQuwuFMs/NJVukDHZFQAJ
diff -- git a/pom.xml b/pom.xml index 229bd84..842b47a 100644 -- - a/pom.xml +++ b/pom.xml @ @ -222,6 +222,48 @ @ < /dependency > < dependency > + < groupId > com.facebook.hive < /groupId > + < artifactId > hive-dwrf < /artifactId > + < version > 0.8 < /version > + < exclusions > + < exclusion > + < groupId > commons-logging < /groupId > + < artifactId > commons-logging < /artifactId > + < /exclusion > + < exclusion > + < groupId > org.iq80.snappy < /groupId > + < artifactId > snappy < /artifactId > + < /exclusion > + < exclusion > + < groupId > com.facebook.presto.hadoop < /groupId > + < artifactId > hadoop-cdh4 < /artifactId > + < /exclusion > + < exclusion > + < groupId > it.unimi.dsi < /groupId > + < artifactId > fastutil < /artifactId > + < /exclusion > + < /exclusions > + < /dependency > + + < dependency > + < groupId > com.facebook.hive < /groupId > + < artifactId > hive-dwrf-shims < /artifactId > + < version > 0.8 < /version > + < exclusions > + < exclusion > + < artifactId > commons-logging < Add support for ORC __EoT__ Trying to read an ORC table fails with an exception . At a minimum , we probably need to upgrade to Hive 0.12 . See https : //groups.google.com/d/msg/presto-users/iKmsQuwuFMs/NJVukDHZFQAJ
diff -- git a/pom.xml b/pom.xml index 229bd84..3be7d5f 100644 -- - a/pom.xml +++ b/pom.xml @ @ -222,6 +222,54 @ @ < /dependency > < dependency > + < groupId > com.facebook.hive < /groupId > + < artifactId > hive-dwrf < /artifactId > + < version > 0.8 < /version > + < exclusions > + < exclusion > + < groupId > commons-logging < /groupId > + < artifactId > commons-logging < /artifactId > + < /exclusion > + < exclusion > + < groupId > org.iq80.snappy < /groupId > + < artifactId > snappy < /artifactId > + < /exclusion > + < exclusion > + < groupId > com.facebook.presto.hadoop < /groupId > + < artifactId > hadoop-cdh4 < /artifactId > + < /exclusion > + < exclusion > + < groupId > it.unimi.dsi < /groupId > + < artifactId > fastutil < /artifactId > + < /exclusion > + < /exclusions > + < /dependency > + + < dependency > + < groupId > com.facebook.hive < /groupId > + < artifactId > hive-dwrf-shims < /artifactId > + < version > 0.8 < /version > + < exclusions > + < exclusion > + < artifactId > commons-logging < Add support for ORC __EoT__ Trying to read an ORC table fails with an exception . At a minimum , we probably need to upgrade to Hive 0.12 . See https : //groups.google.com/d/msg/presto-users/iKmsQuwuFMs/NJVukDHZFQAJ
diff -- git a/presto-product-tests/src/main/java/com/facebook/presto/tests/hive/TestTablePartitioningSelect.java b/presto-product-tests/src/main/java/com/facebook/presto/tests/hive/TestTablePartitioningSelect.java index 5ecbb04..b4bcba8 100644 -- - a/presto-product-tests/src/main/java/com/facebook/presto/tests/hive/TestTablePartitioningSelect.java +++ b/presto-product-tests/src/main/java/com/facebook/presto/tests/hive/TestTablePartitioningSelect.java @ @ -15,12 +15,14 @ @ package com.facebook.presto.tests.hive ; import com.google.inject.Inject ; +import com.teradata.tempto.ProductTest ; import com.teradata.tempto.Requirement ; import com.teradata.tempto.RequirementsProvider ; import com.teradata.tempto.configuration.Configuration ; import com.teradata.tempto.fulfillment.table.MutableTablesState ; import com.teradata.tempto.fulfillment.table.hive.HiveDataSource ; import com.teradata.tempto.fulfillment.table.hive.HiveTableDefinition ; +import com.teradata.tempto.query.QueryExecutionException ; import com.teradata.tempto.query.QueryResult ; import org.testng.annotations.Test ; @ @ -34,11 +36,12 @ @ import static com.teradata.tempto.assertions.QueryAssert.assertThat ; import static com.teradata.tempto.fulfillment.table.MutableTableRequirement.State.LOADED ; import static com.teradata.tempto.fulfillment.table.TableRequirements.mutableTable ; import static com.teradata.tempto.fulfillment.table.hive.InlineDataSource.createResourceDataSource ; +import static com.teradata.tempto.fulfillment.table.hive.InlineDataSource.createStringDataSource ; import static com.teradata.tempto.query.QueryExecutor.query ; -import static org.assertj.core.api.Assertions.assertThat ; +import static java.lang.System.currentTimeMillis ; public class TestTablePartitioningSelect - extends HivePartitioningTest + extends ProductTest implements RequirementsProvider { private static final HiveTableDefinition SINGLE_INT_COLUMN_PARTITIONEND_TEXTFILE = singleIntColumnPartitionedTableDefinition ( `` TEXTFILE '' , Optional.of ( `` DELIMITED FIELDS TERMINATED BY '| ' '' ) ) ; @ @ -53,10 +56,11 @ @ public class TestTablePartitioningSelect private static HiveTableDefinition singleIntColumnPartitionedTableDefinition ( String fileFormat , Optional < String > serde ) { String tableName = fileFormat.toLowerCase ( ) + `` _single_int_column_partitioned '' ; - HiveDataSource dataSource = createResourceDataSource ( tableName , `` '' + System.currentTimeMillis ( ) , `` com/facebook/presto/tests/hive/data/single_int_column/data . '' + fileFormat.toLowerCase ( ) ) ; + HiveDataSource dataSource = createResourceDataSource ( tableName , `` '' testSelectPartitionedHiveTableDifferentFormats is flaky __EoT__ Just ran this test on my box 200 times , and saw no failures . However , Travis keeps randomly failing on this test . I 'm also not sure what it 's really meant to test .
diff -- git a/presto-benchmark/src/main/java/com/facebook/presto/benchmark/AbstractSimpleOperatorBenchmark.java b/presto-benchmark/src/main/java/com/facebook/presto/benchmark/AbstractSimpleOperatorBenchmark.java index c8d6156..f600032 100644 -- - a/presto-benchmark/src/main/java/com/facebook/presto/benchmark/AbstractSimpleOperatorBenchmark.java +++ b/presto-benchmark/src/main/java/com/facebook/presto/benchmark/AbstractSimpleOperatorBenchmark.java @ @ -13,11 +13,13 @ @ */ package com.facebook.presto.benchmark ; +import com.facebook.presto.metadata.MetadataManager ; import com.facebook.presto.operator.Driver ; import com.facebook.presto.operator.DriverContext ; import com.facebook.presto.operator.DriverFactory ; import com.facebook.presto.operator.OperatorFactory ; import com.facebook.presto.operator.TaskContext ; +import com.facebook.presto.sql.analyzer.FeaturesConfig ; import com.facebook.presto.sql.gen.JoinCompiler ; import com.facebook.presto.sql.planner.plan.PlanNodeId ; import com.facebook.presto.testing.LocalQueryRunner ; @ @ -34,7 +36,7 @ @ import static com.facebook.presto.operator.PipelineExecutionStrategy.UNGROUPED_E public abstract class AbstractSimpleOperatorBenchmark extends AbstractOperatorBenchmark { - protected static final JoinCompiler JOIN_COMPILER = new JoinCompiler ( ) ; + protected static final JoinCompiler JOIN_COMPILER = new JoinCompiler ( MetadataManager.createTestMetadataManager ( ) , new FeaturesConfig ( ) ) ; protected AbstractSimpleOperatorBenchmark ( LocalQueryRunner localQueryRunner , diff -- git a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java index 3ce5ef8..1b22c11 100644 -- - a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java +++ b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java @ @ -35,6 +35,7 @ @ import com.facebook.presto.hive.orc.OrcPageSource ; import com.facebook.presto.hive.parquet.ParquetHiveRecordCursor ; import com.facebook.presto.hive.parquet.ParquetPageSource ; import com.facebook.presto.hive.rcfile.RcFilePageSource ; +import com.facebook.presto.metadata.MetadataManager ; import com.facebook.presto.spi.ColumnHandle ; import com.facebook.presto.spi.ColumnMetadata ; import com.facebook.presto.spi.ConnectorInsertTableHandle ; @ @ -81,6 +82,7 @ @ import com.facebook.presto.spi.type.SqlTimestamp ; import com.facebook.presto.spi.type.SqlVarbinary ; import com.facebook.presto.spi.type.StandardTypes ; import com.facebook.presto.spi.type.Type ; +import com.facebook.presto.sql.analyzer.FeaturesConfig ; import com.facebook.presto.sql.gen.JoinCompiler ; import com.facebook.presto.testing.MaterializedResult ; import com.facebook.presto.testing.MaterializedRow ; @ @ -394,7 +396,7 @ @ public abstract class AbstractTestHiveClient protected Set < HiveStorageFormat > createTableFormats = difference ( ImmutableSet.copyOf O ( N^2 ) behavior when grouping by double column containing NaNs __EoT__ NaNs are not equal to any other value ( even to NaN ) . This causes insertions into the hash table of a group by or join to become O ( N ) for NaN values . Once https : //github.com/prestodb/presto/issues/1508 is implemented , this should no longer be a problem . In the meantime , we should consider failing queries that GROUP BY or JOIN on NaNs .
diff -- git a/presto-cassandra/src/main/java/com/facebook/presto/cassandra/CassandraSession.java b/presto-cassandra/src/main/java/com/facebook/presto/cassandra/CassandraSession.java index 6a62938..5983bf7 100644 -- - a/presto-cassandra/src/main/java/com/facebook/presto/cassandra/CassandraSession.java +++ b/presto-cassandra/src/main/java/com/facebook/presto/cassandra/CassandraSession.java @ @ -49,7 +49,6 @ @ import io.airlift.json.JsonCodec ; import java.nio.ByteBuffer ; import java.util.ArrayList ; -import java.util.Collection ; import java.util.HashMap ; import java.util.HashSet ; import java.util.List ; @ @ -104,14 +103,7 @ @ public class CassandraSession public Set < Host > getReplicas ( final String schemaName , final ByteBuffer partitionKey ) { - return executeWithSession ( schemaName , new SessionCallable < Set < Host > > ( ) - { - @ Override - public Set < Host > executeWithSession ( Session session ) - { - return session.getCluster ( ) .getMetadata ( ) .getReplicas ( schemaName , partitionKey ) ; - } - } ) ; + return executeWithSession ( schemaName , session - > session.getCluster ( ) .getMetadata ( ) .getReplicas ( schemaName , partitionKey ) ) ; } private Session getSession ( String schemaName ) @ @ -126,48 +118,18 @ @ public class CassandraSession public ResultSet executeQuery ( String schemaName , final String cql ) { - return executeWithSession ( schemaName , new SessionCallable < ResultSet > ( ) { - @ Override - public ResultSet executeWithSession ( Session session ) - { - Cassandra collector SELECT error __EoT__ I 've defined the Cassandra catalog like this and Cassandra is running on the default port : ` connector.name=cassandra ` ` cassandra.contact-points=localhost ` In Presto-Cli when I type the command DESCRIBE it works fine but my SELECT command fails because of Thrift connection refused error . ` presto : cmf > DESCRIBE stats ; ` ` Column | Type | Extra | Comment ` ` -- -- -- -- -- -- -- -- + -- -- -- -- -+ -- -- -- -+ -- -- -- -- - ` ` username | varchar | | ` ` a | bigint | | ` ` b | bigint | | ` ` c | bigint | | ` ` d | bigint | | ` ` e | bigint | | ` ` ( 6 rows ) ` ` presto : cmf > SELECT * FROM stats ; ` ` Query 20161226_083409_00044_2cdmr failed : java.io.IOException : Unable to connect to server localhost:9160 ` Trace : ` java.lang.RuntimeException : java.io.IOException : Unable to connect to server localhost:9160 at com.facebook.presto.cassandra.CassandraThriftConnectionFactory.create ( CassandraThriftConnectionFactory.java:56 ) at com.facebook.presto.cassandra.CassandraThriftClient.getRangeMap ( CassandraThriftClient.java:38 ) at com.facebook.presto.cassandra.CassandraTokenSplitManager.getSplits ( CassandraTokenSplitManager.java:65 ) at com.facebook.presto.cassandra.CassandraSplitManager.getSplitsByTokenRange ( CassandraSplitManager.java:99 )
diff -- git a/presto-main/src/main/java/com/facebook/presto/server/ServerMainModule.java b/presto-main/src/main/java/com/facebook/presto/server/ServerMainModule.java index 56f7b4c..11066f4 100644 -- - a/presto-main/src/main/java/com/facebook/presto/server/ServerMainModule.java +++ b/presto-main/src/main/java/com/facebook/presto/server/ServerMainModule.java @ @ -156,10 +156,10 @ @ public class ServerMainModule if ( serverConfig.isCoordinator ( ) ) { discoveryBinder ( binder ) .bindHttpAnnouncement ( `` presto-coordinator '' ) ; - binder.bind ( new TypeLiteral < Optional < QueryPerformanceFetcher > > ( ) { } ) .toProvider ( QueryPerformanceFetcherProvider.class ) .in ( Scopes.SINGLETON ) ; + binder.bind ( new TypeLiteral < Optional < QueryPerformanceFetcher > > ( ) { } ) .toProvider ( QueryPerformanceFetcherProvider.class ) .in ( Scopes.SINGLETON ) ; } else { - binder.bind ( new TypeLiteral < Optional < QueryPerformanceFetcher > > ( ) { } ) .toInstance ( Optional.empty ( ) ) ; + binder.bind ( new TypeLiteral < Optional < QueryPerformanceFetcher > > ( ) { } ) .toInstance ( Optional.empty ( ) ) ; } binder.bind ( SqlParser.class ) .in ( Scopes.SINGLETON ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/ExpressionNodeInliner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/ExpressionNodeInliner.java index edadb6b..b436397 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/ExpressionNodeInliner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/ExpressionNodeInliner.java @ @ -22,6 +22,11 @ @ import java.util.Map ; public class ExpressionNodeInliner extends ExpressionRewriter < Void > { + public static Expression replaceExpression ( Expression expression , Map < ? extends Expression , ? extends Expression > mappings Support for correlated subqueries __EoT__ It relates to subqueries used in IN , EXISTS predicates and scalar subqueries .
diff -- git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/ApplyFunction.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/ApplyFunction.java index 1f8a3c2..cc982b3 100644 -- - a/presto-main/src/main/java/com/facebook/presto/operator/scalar/ApplyFunction.java +++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/ApplyFunction.java @ @ -18,13 +18,13 @ @ import com.facebook.presto.metadata.FunctionKind ; import com.facebook.presto.metadata.FunctionRegistry ; import com.facebook.presto.metadata.Signature ; import com.facebook.presto.metadata.SqlScalarFunction ; -import com.facebook.presto.spi.ConnectorSession ; import com.facebook.presto.spi.type.Type ; import com.facebook.presto.spi.type.TypeManager ; import com.google.common.base.Throwables ; import com.google.common.collect.ImmutableList ; import java.lang.invoke.MethodHandle ; +import java.util.Optional ; import static com.facebook.presto.metadata.Signature.typeVariable ; import static com.facebook.presto.spi.type.TypeSignature.parseTypeSignature ; @ @ -39,7 +39,7 @ @ public final class ApplyFunction { public static final ApplyFunction APPLY_FUNCTION = new ApplyFunction ( ) ; - private static final MethodHandle METHOD_HANDLE = methodHandle ( ApplyFunction.class , `` apply '' , ConnectorSession.class , Object.class , MethodHandle.class ) ; + private static final MethodHandle METHOD_HANDLE = methodHandle ( ApplyFunction.class , `` apply '' , Object.class , MethodHandle.class ) ; private ApplyFunction ( ) { @ @ -79,17 +79,19 @ @ public final class ApplyFunction return new ScalarFunctionImplementation ( true , ImmutableList.of ( true , false ) , + ImmutableList.of ( false , false ) , + ImmutableList.of ( Optional.empty ( ) , Optional.of ( MethodHandle.class ) ) , METHOD_HANDLE.asType ( METHOD_HANDLE.type ( ) .changeReturnType ( wrap ( returnType.getJavaType ( ) ) ) - .changeParameterType ( 1 , wrap ( argumentType.getJavaType ( ) ) ) ) Excessive classes are generated during lambda execution __EoT__ The simplest way I found to the problem is to have a table with a lot of nested arrays ( e.g . ` ARRAY ( ARRAY ( INTEGER ) ) ` : `` ` CREATE TABLE test_100k_rows AS SELECT id as rid FROM ( select sequence ( 1 , 100000 ) AS seq ) tmp CROSS JOIN UNNEST ( seq ) AS t ( id ) CREATE TABLE test_2lev_array AS SELECT transform ( sequence ( 1 , 1000 ) , x- > ARRAY [ x ] ) AS arr FROM test_100k_rows `` ` This will generate an table with 100k rows ( I think 10k rows are also enough ) , each row contains an ` ARRAY < ARRAY < INTEGER > > ` , and each array contains 1000 entries . The following query will cause the problem : `` ` SELECT count ( filter ( arr , x- > false ) ) FROM test_2lev_array `` ` You will then see about 100k LambdaForm classes generated in the form ` LambdaForm $ xxxx.class ` , which are all ( almost ) same , here is one example of the disassemble code
diff -- git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/ApplyFunction.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/ApplyFunction.java index 1f8a3c2..cc982b3 100644 -- - a/presto-main/src/main/java/com/facebook/presto/operator/scalar/ApplyFunction.java +++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/ApplyFunction.java @ @ -18,13 +18,13 @ @ import com.facebook.presto.metadata.FunctionKind ; import com.facebook.presto.metadata.FunctionRegistry ; import com.facebook.presto.metadata.Signature ; import com.facebook.presto.metadata.SqlScalarFunction ; -import com.facebook.presto.spi.ConnectorSession ; import com.facebook.presto.spi.type.Type ; import com.facebook.presto.spi.type.TypeManager ; import com.google.common.base.Throwables ; import com.google.common.collect.ImmutableList ; import java.lang.invoke.MethodHandle ; +import java.util.Optional ; import static com.facebook.presto.metadata.Signature.typeVariable ; import static com.facebook.presto.spi.type.TypeSignature.parseTypeSignature ; @ @ -39,7 +39,7 @ @ public final class ApplyFunction { public static final ApplyFunction APPLY_FUNCTION = new ApplyFunction ( ) ; - private static final MethodHandle METHOD_HANDLE = methodHandle ( ApplyFunction.class , `` apply '' , ConnectorSession.class , Object.class , MethodHandle.class ) ; + private static final MethodHandle METHOD_HANDLE = methodHandle ( ApplyFunction.class , `` apply '' , Object.class , MethodHandle.class ) ; private ApplyFunction ( ) { @ @ -79,17 +79,19 @ @ public final class ApplyFunction return new ScalarFunctionImplementation ( true , ImmutableList.of ( true , false ) , + ImmutableList.of ( false , false ) , + ImmutableList.of ( Optional.empty ( ) , Optional.of ( MethodHandle.class ) ) , METHOD_HANDLE.asType ( METHOD_HANDLE.type ( ) .changeReturnType ( wrap ( returnType.getJavaType ( ) ) ) - .changeParameterType ( 1 , wrap ( argumentType.getJavaType ( ) ) ) ) Excessive classes are generated during lambda execution __EoT__ The simplest way I found to the problem is to have a table with a lot of nested arrays ( e.g . ` ARRAY ( ARRAY ( INTEGER ) ) ` : `` ` CREATE TABLE test_100k_rows AS SELECT id as rid FROM ( select sequence ( 1 , 100000 ) AS seq ) tmp CROSS JOIN UNNEST ( seq ) AS t ( id ) CREATE TABLE test_2lev_array AS SELECT transform ( sequence ( 1 , 1000 ) , x- > ARRAY [ x ] ) AS arr FROM test_100k_rows `` ` This will generate an table with 100k rows ( I think 10k rows are also enough ) , each row contains an ` ARRAY < ARRAY < INTEGER > > ` , and each array contains 1000 entries . The following query will cause the problem : `` ` SELECT count ( filter ( arr , x- > false ) ) FROM test_2lev_array `` ` You will then see about 100k LambdaForm classes generated in the form ` LambdaForm $ xxxx.class ` , which are all ( almost ) same , here is one example of the disassemble code
diff -- git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/ApplyFunction.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/ApplyFunction.java index 1f8a3c2..2dc7e72 100644 -- - a/presto-main/src/main/java/com/facebook/presto/operator/scalar/ApplyFunction.java +++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/ApplyFunction.java @ @ -18,13 +18,14 @ @ import com.facebook.presto.metadata.FunctionKind ; import com.facebook.presto.metadata.FunctionRegistry ; import com.facebook.presto.metadata.Signature ; import com.facebook.presto.metadata.SqlScalarFunction ; -import com.facebook.presto.spi.ConnectorSession ; import com.facebook.presto.spi.type.Type ; import com.facebook.presto.spi.type.TypeManager ; +import com.facebook.presto.sql.gen.lambda.UnaryFunctionInterface ; import com.google.common.base.Throwables ; import com.google.common.collect.ImmutableList ; import java.lang.invoke.MethodHandle ; +import java.util.Optional ; import static com.facebook.presto.metadata.Signature.typeVariable ; import static com.facebook.presto.spi.type.TypeSignature.parseTypeSignature ; @ @ -39,7 +40,7 @ @ public final class ApplyFunction { public static final ApplyFunction APPLY_FUNCTION = new ApplyFunction ( ) ; - private static final MethodHandle METHOD_HANDLE = methodHandle ( ApplyFunction.class , `` apply '' , ConnectorSession.class , Object.class , MethodHandle.class ) ; + private static final MethodHandle METHOD_HANDLE = methodHandle ( ApplyFunction.class , `` apply '' , Object.class , UnaryFunctionInterface.class ) ; private ApplyFunction ( ) { @ @ -79,17 +80,19 @ @ public final class ApplyFunction return new ScalarFunctionImplementation ( true , ImmutableList.of ( true , false ) , + ImmutableList.of ( false , false ) , + ImmutableList.of ( Optional.empty ( ) , Optional.of ( UnaryFunctionInterface.class ) ) , METHOD_HANDLE.asType ( METHOD_HANDLE.type ( ) .changeReturnType ( wrap ( returnType.getJavaType ( ) ) ) - .changeParameterType ( 1 , wrap ( argumentType.getJavaType ( ) Excessive classes are generated during lambda execution __EoT__ The simplest way I found to the problem is to have a table with a lot of nested arrays ( e.g . ` ARRAY ( ARRAY ( INTEGER ) ) ` : `` ` CREATE TABLE test_100k_rows AS SELECT id as rid FROM ( select sequence ( 1 , 100000 ) AS seq ) tmp CROSS JOIN UNNEST ( seq ) AS t ( id ) CREATE TABLE test_2lev_array AS SELECT transform ( sequence ( 1 , 1000 ) , x- > ARRAY [ x ] ) AS arr FROM test_100k_rows `` ` This will generate an table with 100k rows ( I think 10k rows are also enough ) , each row contains an ` ARRAY < ARRAY < INTEGER > > ` , and each array contains 1000 entries . The following query will cause the problem : `` ` SELECT count ( filter ( arr , x- > false ) ) FROM test_2lev_array `` ` You will then see about 100k LambdaForm classes generated in the form ` LambdaForm $ xxxx.class ` , which are all ( almost ) same , here is one example of the disassemble code
diff -- git a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java index 2d1db65..29e1fd3 100644 -- - a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java +++ b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java @ @ -182,6 +182,7 @ @ import static com.facebook.presto.spi.type.VarbinaryType.VARBINARY ; import static com.facebook.presto.spi.type.VarcharType.createUnboundedVarcharType ; import static com.facebook.presto.spi.type.Varchars.isVarcharType ; import static com.facebook.presto.testing.MaterializedResult.materializeSourceDataStream ; +import static com.facebook.presto.testing.TestingSqlTime.sqlTimestampOf ; import static com.google.common.base.MoreObjects.toStringHelper ; import static com.google.common.base.Preconditions.checkArgument ; import static com.google.common.base.Preconditions.checkState ; @ @ -2749,7 +2750,7 @ @ public abstract class AbstractTestHiveClient assertNull ( row.getField ( index ) ) ; } else { - SqlTimestamp expected = new SqlTimestamp ( new DateTime ( 2011 , 5 , 6 , 7 , 8 , 9 , 123 , timeZone ) .getMillis ( ) , UTC_KEY ) ; + SqlTimestamp expected = sqlTimestampOf ( 2011 , 5 , 6 , 7 , 8 , 9 , 123 , timeZone , UTC_KEY , SESSION ) ; assertEquals ( row.getField ( index ) , expected ) ; } } diff -- git a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java index b99b183..77418e2 100644 -- - a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java +++ b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java @ @ -107,6 +107,7 @ @ import static com.facebook.presto.spi.type.VarcharType.createUnboundedVarcharTyp import static com.facebook.presto.spi.type.VarcharType.createVarcharType ; import static com.facebook.presto.spi.type.Varchars.isVarcharType ; import static com.facebook.presto.testing.MaterializedResult.materializeSourceDataStream ; +import static com.facebook.presto.testing.TestingSqlTime.sqlTimestampOf ; import static com.facebook.presto.tests.StructuralTestUtil.arrayBlockOf ; import static com.facebook.presto.tests.StructuralTestUtil.decimalArrayBlockOf ; import static com.facebook.presto.tests.StructuralTestUtil.decimalMapBlockOf ; @ @ -737,7 +738,7 @ @ Inadequate representation of temporal types in tests __EoT__ There are 3 places in tests where for the sake of comparisons we convert data to `` common type domain '' : * ` com.facebook.presto.testing.MaterializedResult # toJdbcTypes ` * ` com.facebook.presto.tests.TestingPrestoClient # convertToRowValue ` * ` com.facebook.presto.tests.H2QueryRunner # rowMapper ` However , 1. we use wrong type for ` timestamp with time zone ` : ` java.sql.Timestamp ` ( so we ignore time zone in comparisons ) * we also use wrong ` timestamp with time zone ` literals in H2 ... H2 does n't have ` timestamp with time zone ` literals despite what ` com.facebook.presto.tests.AbstractTestQueries # testAtTimeZone ` has to say about that 2. we use wrong type for ` time with time zone ` : ` java.sql.Time ` ( we we ignore timezone/zone offset in comparisons ) 3. using JDBC type domain as `` common type domain '' in tests , makes us to use ` java.sql . { Date , Time , Timestamp } ` which all extend ` java.util.Date ` and all bear limitations and discomfort related to this class . # # # # Proposal A ( fix ` { time , timestamp } with time
diff -- git a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java index 2d1db65..29e1fd3 100644 -- - a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java +++ b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveClient.java @ @ -182,6 +182,7 @ @ import static com.facebook.presto.spi.type.VarbinaryType.VARBINARY ; import static com.facebook.presto.spi.type.VarcharType.createUnboundedVarcharType ; import static com.facebook.presto.spi.type.Varchars.isVarcharType ; import static com.facebook.presto.testing.MaterializedResult.materializeSourceDataStream ; +import static com.facebook.presto.testing.TestingSqlTime.sqlTimestampOf ; import static com.google.common.base.MoreObjects.toStringHelper ; import static com.google.common.base.Preconditions.checkArgument ; import static com.google.common.base.Preconditions.checkState ; @ @ -2749,7 +2750,7 @ @ public abstract class AbstractTestHiveClient assertNull ( row.getField ( index ) ) ; } else { - SqlTimestamp expected = new SqlTimestamp ( new DateTime ( 2011 , 5 , 6 , 7 , 8 , 9 , 123 , timeZone ) .getMillis ( ) , UTC_KEY ) ; + SqlTimestamp expected = sqlTimestampOf ( 2011 , 5 , 6 , 7 , 8 , 9 , 123 , timeZone , UTC_KEY , SESSION ) ; assertEquals ( row.getField ( index ) , expected ) ; } } diff -- git a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java index b99b183..77418e2 100644 -- - a/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java +++ b/presto-hive/src/test/java/com/facebook/presto/hive/AbstractTestHiveFileFormats.java @ @ -107,6 +107,7 @ @ import static com.facebook.presto.spi.type.VarcharType.createUnboundedVarcharTyp import static com.facebook.presto.spi.type.VarcharType.createVarcharType ; import static com.facebook.presto.spi.type.Varchars.isVarcharType ; import static com.facebook.presto.testing.MaterializedResult.materializeSourceDataStream ; +import static com.facebook.presto.testing.TestingSqlTime.sqlTimestampOf ; import static com.facebook.presto.tests.StructuralTestUtil.arrayBlockOf ; import static com.facebook.presto.tests.StructuralTestUtil.decimalArrayBlockOf ; import static com.facebook.presto.tests.StructuralTestUtil.decimalMapBlockOf ; @ @ -737,7 +738,7 @ @ Inadequate representation of temporal types in tests __EoT__ There are 3 places in tests where for the sake of comparisons we convert data to `` common type domain '' : * ` com.facebook.presto.testing.MaterializedResult # toJdbcTypes ` * ` com.facebook.presto.tests.TestingPrestoClient # convertToRowValue ` * ` com.facebook.presto.tests.H2QueryRunner # rowMapper ` However , 1. we use wrong type for ` timestamp with time zone ` : ` java.sql.Timestamp ` ( so we ignore time zone in comparisons ) * we also use wrong ` timestamp with time zone ` literals in H2 ... H2 does n't have ` timestamp with time zone ` literals despite what ` com.facebook.presto.tests.AbstractTestQueries # testAtTimeZone ` has to say about that 2. we use wrong type for ` time with time zone ` : ` java.sql.Time ` ( we we ignore timezone/zone offset in comparisons ) 3. using JDBC type domain as `` common type domain '' in tests , makes us to use ` java.sql . { Date , Time , Timestamp } ` which all extend ` java.util.Date ` and all bear limitations and discomfort related to this class . # # # # Proposal A ( fix ` { time , timestamp } with time
diff -- git a/presto-docs/src/main/sphinx/functions/datetime.rst b/presto-docs/src/main/sphinx/functions/datetime.rst index 0b92168..12fd5ff 100644 -- - a/presto-docs/src/main/sphinx/functions/datetime.rst +++ b/presto-docs/src/main/sphinx/functions/datetime.rst @ @ -48,6 +48,11 @ @ Date and Time Functions Returns the current timestamp as of the start of the query . +.. function : : current_timezone ( ) - > time zone + + Returns the current time zone in the form `` Area/Location `` + ( e.g. , `` America/Los_Angeles `` ) . + .. function : : from_unixtime ( unixtime ) - > timestamp Returns the UNIX timestamp `` unixtime `` as a timestamp . diff -- git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/DateTimeFunctions.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/DateTimeFunctions.java index 6b6fe5a..fb0c92b 100644 -- - a/presto-main/src/main/java/com/facebook/presto/operator/scalar/DateTimeFunctions.java +++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/DateTimeFunctions.java @ @ -105,6 +105,14 @ @ public final class DateTimeFunctions return getChronology ( session.getTimeZoneKey ( ) ) .millisOfDay ( ) .get ( session.getStartTime ( ) ) ; } + @ Description ( `` current time zone '' ) + @ ScalarFunction ( `` current_timezone '' ) + @ SqlType ( StandardTypes.VARCHAR ) + public static Slice currentTimeZone ( ConnectorSession session ) + { + return Slices.copiedBuffer ( session.getTimeZoneKey ( ) .getId ( ) , Charsets.UTF_8 ) ; + } + @ Description ( `` current timestamp with time zone '' ) @ ScalarFunction ( value = Add current_timezone ( ) function __EoT__
diff -- git a/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java b/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java index fd0db39..71e04c2 100644 -- - a/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java +++ b/presto-benchmark-driver/src/main/java/com/facebook/presto/benchmark/driver/BenchmarkQueryRunner.java @ @ -42,6 +42,7 @ @ import static com.facebook.presto.benchmark.driver.BenchmarkQueryResult.failResu import static com.facebook.presto.benchmark.driver.BenchmarkQueryResult.passResult ; import static com.facebook.presto.client.OkHttpUtil.setupCookieJar ; import static com.facebook.presto.client.OkHttpUtil.setupSocksProxy ; +import static com.facebook.presto.client.StatementClientFactory.newStatementClient ; import static com.google.common.base.Preconditions.checkArgument ; import static com.google.common.base.Verify.verify ; import static io.airlift.http.client.HttpUriBuilder.uriBuilderFrom ; @ @ -199,7 +200,7 @ @ public class BenchmarkQueryRunner private StatementStats execute ( ClientSession session , String query , Consumer < QueryData > queryDataConsumer , Consumer < QueryError > queryErrorConsumer ) { // start query - try ( StatementClient client = new StatementClient ( okHttpClient , session , query ) ) { + try ( StatementClient client = newStatementClient ( okHttpClient , session , query ) ) { // read query output while ( client.isRunning ( ) ) { queryDataConsumer.accept ( client.currentData ( ) ) ; diff -- git a/presto-cli/src/main/java/com/facebook/presto/cli/QueryRunner.java b/presto-cli/src/main/java/com/facebook/presto/cli/QueryRunner.java index 59991f6..c3671ac 100644 -- - a/presto-cli/src/main/java/com/facebook/presto/cli/QueryRunner.java +++ b/presto-cli/src/main/java/com/facebook/presto/cli/QueryRunner.java @ @ -33,6 +33,7 @ @ import static com.facebook.presto.client.OkHttpUtil.setupKerberos ; import static com.facebook.presto.client.OkHttpUtil.setupSocksProxy ; import static com.facebook.presto.client.OkHttpUtil.setupSsl ; import static com.facebook.presto.client.OkHttpUtil.setupTimeouts ; +import static com.facebook.presto.client.StatementClientFactory.newStatementClient ; import static com.google.common.base.Preconditions.checkArgument ; import static java.util.Objects.requireNonNull ; import static java.util.concurrent.TimeUnit.SECONDS ; @ @ -122,7 +123,7 @ @ public class QueryRunner sslSetup.accept ( builder ) PreparedStatement # close does not deallocate the prepared statement from session __EoT__ Hi Guys , Here are the versions : - OSX ( does the same on my production environment - Ubuntu ) - Presto JDBC Driver/0.206 - Presto CLI 0.206 - Same for presto server - NiFi : stable 1.7.1 # The actual issue I am using NiFi and its [ DBCPConnectionPool ] ( https : //nifi.apache.org/docs/nifi-docs/components/org.apache.nifi/nifi-dbcp-service-nar/1.7.1/org.apache.nifi.dbcp.DBCPConnectionPool/index.html ) to query Presto with the JDBC Driver . It works the first few times . But after a while it does n't work anymore and I get the following error on presto side : `` ` tail -f /usr/local/var/presto/data/var/log/server.log 2018-07-23T17:32:11.402+0200 WARN http-worker-520 org.eclipse.jetty.http.HttpParser Header is too large 8193 > 8192 `` ` The first request send to Presto via NiFi ( found it via mitmproxy ) is : `` ` X-Presto-User : micka X-Presto-Source : presto-jdbc X-Presto-Time-Zone : Europe/Paris X-Presto-Language : en-US X-Presto-Transaction-Id : NONE X-Presto-Client-Capabilities : PATH User-Agent : Presto JDBC Driver/0.206 Content-Type : text/plain ; charset=utf-8 Content-Length : 64 Host : 127.0.0.1 Connection : Keep-Alive Accept-Encoding : gzip -- -RAW BODY -- - PREPARE statement1 FROM SELECT * FROM pg.public.csv_test limit 5 `` ` The seconde one is :
diff -- git a/presto-docs/src/main/sphinx/language/reserved.rst b/presto-docs/src/main/sphinx/language/reserved.rst index 9cf05af..fe8de97 100644 -- - a/presto-docs/src/main/sphinx/language/reserved.rst +++ b/presto-docs/src/main/sphinx/language/reserved.rst @ @ -21,6 +21,8 @ @ Keyword SQL:2016 SQL-92 `` CROSS `` reserved reserved `` CUBE `` reserved `` CURRENT_DATE `` reserved reserved + `` CURRENT_ROLE `` reserved reserved + `` CURRENT_USER `` reserved reserved `` CURRENT_TIME `` reserved reserved `` CURRENT_TIMESTAMP `` reserved reserved `` DEALLOCATE `` reserved reserved diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java index f15d39a..fbb7f5a 100644 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java +++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java @ @ -24,6 +24,7 @ @ import com.facebook.presto.hive.metastore.SemiTransactionalHiveMetastore ; import com.facebook.presto.hive.metastore.SemiTransactionalHiveMetastore.WriteMode ; import com.facebook.presto.hive.metastore.StorageFormat ; import com.facebook.presto.hive.metastore.Table ; +import com.facebook.presto.hive.metastore.thrift.ThriftMetastoreUtil ; import com.facebook.presto.hive.statistics.HiveStatisticsProvider ; import com.facebook.presto.spi.ColumnHandle ; import com.facebook.presto.spi.ColumnMetadata ; @ @ -51,8 +52,10 @ @ import com.facebook.presto.spi.predicate.Domain ; import com.facebook.presto.spi.predicate.NullableValue ; import com.facebook.presto.spi.predicate.TupleDomain ; import com.facebook.presto.spi.security.GrantInfo ; +import com.facebook.presto.spi.security.PrestoPrincipal ; import com.facebook.presto.spi.security.Privilege ; import com.facebook.presto.spi.security.PrivilegeInfo ; +import com.facebook.presto.spi.security.RoleGrant ; import com.facebook.presto.spi.statistics.TableStatistics ; import com.facebook.presto.spi.type.Type ; import com.facebook.presto.spi.type.TypeManager ; @ @ -135,18 +138,20 @ @ import static com.facebook.presto.hive.metastore.HivePrivilegeInfo.toHivePrivile import static com.facebook.presto.hive.metastore.MetastoreUtil.getHiveSchema ; import static com.facebook.presto.hive.metastore.MetastoreUtil.getProtectMode ; import static com.facebook.presto.hive.metastore.MetastoreUtil.verifyOnline ; -import static com.facebook.presto.hive.metastore.PrincipalType.USER ; import static com.facebook.presto.hive.metastore.SemiTransactionalHiveMetastore.WriteMode.DIRECT_TO_TARGET_EXISTING_DIRECTORY ; import static com.facebook.presto.hive.metastore.SemiTransactionalHiveMetastore.WriteMode.DIRECT_TO_TARGET_NEW_DIRECTORY ; import static com.facebook.presto.hive.metastore.SemiTransactionalHiveMetastore.WriteMode.STAGE_AND_MOVE_TO_TARGET_DIRECTORY ; import static com.facebook.presto.hive.metastore.StorageFormat.VIEW_STORAGE_FORMAT ; import static com.facebook.presto.hive.metastore.StorageFormat.fromHiveStorageFormat ; +import static com.facebook.presto.hive.metastore.thrift.ThriftMetastoreUtil.listApplicableTablePrivileges ; import static com.facebook.presto.hive.util.ConfigurationUtils.toJobConf ; +import static Presto and RBAC -roadmap ? __EoT__ I know presto does n't support RBAC for authorization . Do you have any plan in the future or is it included in the roadmap ? The RBAC can be a plugin either with Apache Ranger or Apache Sentry or it can have its own model .
diff -- git a/presto-docs/src/main/sphinx/language/reserved.rst b/presto-docs/src/main/sphinx/language/reserved.rst index 9cf05af..fe8de97 100644 -- - a/presto-docs/src/main/sphinx/language/reserved.rst +++ b/presto-docs/src/main/sphinx/language/reserved.rst @ @ -21,6 +21,8 @ @ Keyword SQL:2016 SQL-92 `` CROSS `` reserved reserved `` CUBE `` reserved `` CURRENT_DATE `` reserved reserved + `` CURRENT_ROLE `` reserved reserved + `` CURRENT_USER `` reserved reserved `` CURRENT_TIME `` reserved reserved `` CURRENT_TIMESTAMP `` reserved reserved `` DEALLOCATE `` reserved reserved diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java index f15d39a..25cdb6f 100644 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java +++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java @ @ -24,6 +24,7 @ @ import com.facebook.presto.hive.metastore.SemiTransactionalHiveMetastore ; import com.facebook.presto.hive.metastore.SemiTransactionalHiveMetastore.WriteMode ; import com.facebook.presto.hive.metastore.StorageFormat ; import com.facebook.presto.hive.metastore.Table ; +import com.facebook.presto.hive.metastore.thrift.ThriftMetastoreUtil ; import com.facebook.presto.hive.statistics.HiveStatisticsProvider ; import com.facebook.presto.spi.ColumnHandle ; import com.facebook.presto.spi.ColumnMetadata ; @ @ -51,8 +52,10 @ @ import com.facebook.presto.spi.predicate.Domain ; import com.facebook.presto.spi.predicate.NullableValue ; import com.facebook.presto.spi.predicate.TupleDomain ; import com.facebook.presto.spi.security.GrantInfo ; +import com.facebook.presto.spi.security.PrestoPrincipal ; import com.facebook.presto.spi.security.Privilege ; import com.facebook.presto.spi.security.PrivilegeInfo ; +import com.facebook.presto.spi.security.RoleGrant ; import com.facebook.presto.spi.statistics.TableStatistics ; import com.facebook.presto.spi.type.Type ; import com.facebook.presto.spi.type.TypeManager ; @ @ -135,18 +138,21 @ @ import static com.facebook.presto.hive.metastore.HivePrivilegeInfo.toHivePrivile import static com.facebook.presto.hive.metastore.MetastoreUtil.getHiveSchema ; import static com.facebook.presto.hive.metastore.MetastoreUtil.getProtectMode ; import static com.facebook.presto.hive.metastore.MetastoreUtil.verifyOnline ; -import static com.facebook.presto.hive.metastore.PrincipalType.USER ; import static com.facebook.presto.hive.metastore.SemiTransactionalHiveMetastore.WriteMode.DIRECT_TO_TARGET_EXISTING_DIRECTORY ; import static com.facebook.presto.hive.metastore.SemiTransactionalHiveMetastore.WriteMode.DIRECT_TO_TARGET_NEW_DIRECTORY ; import static com.facebook.presto.hive.metastore.SemiTransactionalHiveMetastore.WriteMode.STAGE_AND_MOVE_TO_TARGET_DIRECTORY ; import static com.facebook.presto.hive.metastore.StorageFormat.VIEW_STORAGE_FORMAT ; import static com.facebook.presto.hive.metastore.StorageFormat.fromHiveStorageFormat ; +import static com.facebook.presto.hive.metastore.thrift.ThriftMetastoreUtil.listApplicableTablePrivileges ; import static com.facebook.presto.hive.util.ConfigurationUtils.toJobConf ; +import static Presto and RBAC -roadmap ? __EoT__ I know presto does n't support RBAC for authorization . Do you have any plan in the future or is it included in the roadmap ? The RBAC can be a plugin either with Apache Ranger or Apache Sentry or it can have its own model .
diff -- git a/presto-cli/pom.xml b/presto-cli/pom.xml index 8455d4a..6c91be5 100644 -- - a/presto-cli/pom.xml +++ b/presto-cli/pom.xml @ @ -24,6 +24,11 @ @ < dependency > < groupId > com.facebook.presto < /groupId > + < artifactId > presto-spi < /artifactId > + < /dependency > + + < dependency > + < groupId > com.facebook.presto < /groupId > < artifactId > presto-parser < /artifactId > < /dependency > diff -- git a/presto-cli/src/main/java/com/facebook/presto/cli/Console.java b/presto-cli/src/main/java/com/facebook/presto/cli/Console.java index 5551ec0..ab78549 100644 -- - a/presto-cli/src/main/java/com/facebook/presto/cli/Console.java +++ b/presto-cli/src/main/java/com/facebook/presto/cli/Console.java @ @ -15,6 +15,7 @ @ package com.facebook.presto.cli ; import com.facebook.presto.cli.ClientOptions.OutputFormat ; import com.facebook.presto.client.ClientSession ; +import com.facebook.presto.spi.security.SelectedRole ; import com.facebook.presto.sql.parser.IdentifierSymbol ; import com.facebook.presto.sql.parser.SqlParser ; import com.facebook.presto.sql.parser.SqlParserOptions ; @ @ -53,6 +54,7 @ @ import static com.facebook.presto.client.ClientSession.stripTransactionId ; import static com.facebook.presto.client.ClientSession.withCatalogAndSchema ; import static com.facebook.presto.client.ClientSession.withPreparedStatements ; import static com.facebook.presto.client.ClientSession.withProperties ; +import static com.facebook.presto.client.ClientSession.withRoles ; import static com.facebook.presto.client.ClientSession.withTransactionId ; import static com.facebook.presto.sql.parser.StatementSplitter.Statement ; import static com.facebook.presto.sql.parser.StatementSplitter.isEmptyStatement ; @ @ -315,6 +317,13 @ @ public class Console session = withProperties ( session , sessionProperties ) ; } + // update session roles + if ( ! query.getSetRoles ( ) .isEmpty ( ) ) { + Map < String , SelectedRole > roles = new HashMap < > ( session.getRoles ( ) ) ; + roles.putAll ( Presto and RBAC -roadmap ? __EoT__ I know presto does n't support RBAC for authorization . Do you have any plan in the future or is it included in the roadmap ? The RBAC can be a plugin either with Apache Ranger or Apache Sentry or it can have its own model .
diff -- git a/presto-cli/pom.xml b/presto-cli/pom.xml index 8455d4a..6c91be5 100644 -- - a/presto-cli/pom.xml +++ b/presto-cli/pom.xml @ @ -24,6 +24,11 @ @ < dependency > < groupId > com.facebook.presto < /groupId > + < artifactId > presto-spi < /artifactId > + < /dependency > + + < dependency > + < groupId > com.facebook.presto < /groupId > < artifactId > presto-parser < /artifactId > < /dependency > diff -- git a/presto-cli/src/main/java/com/facebook/presto/cli/Console.java b/presto-cli/src/main/java/com/facebook/presto/cli/Console.java index 5551ec0..ab78549 100644 -- - a/presto-cli/src/main/java/com/facebook/presto/cli/Console.java +++ b/presto-cli/src/main/java/com/facebook/presto/cli/Console.java @ @ -15,6 +15,7 @ @ package com.facebook.presto.cli ; import com.facebook.presto.cli.ClientOptions.OutputFormat ; import com.facebook.presto.client.ClientSession ; +import com.facebook.presto.spi.security.SelectedRole ; import com.facebook.presto.sql.parser.IdentifierSymbol ; import com.facebook.presto.sql.parser.SqlParser ; import com.facebook.presto.sql.parser.SqlParserOptions ; @ @ -53,6 +54,7 @ @ import static com.facebook.presto.client.ClientSession.stripTransactionId ; import static com.facebook.presto.client.ClientSession.withCatalogAndSchema ; import static com.facebook.presto.client.ClientSession.withPreparedStatements ; import static com.facebook.presto.client.ClientSession.withProperties ; +import static com.facebook.presto.client.ClientSession.withRoles ; import static com.facebook.presto.client.ClientSession.withTransactionId ; import static com.facebook.presto.sql.parser.StatementSplitter.Statement ; import static com.facebook.presto.sql.parser.StatementSplitter.isEmptyStatement ; @ @ -315,6 +317,13 @ @ public class Console session = withProperties ( session , sessionProperties ) ; } + // update session roles + if ( ! query.getSetRoles ( ) .isEmpty ( ) ) { + Map < String , SelectedRole > roles = new HashMap < > ( session.getRoles ( ) ) ; + roles.putAll ( Presto and RBAC -roadmap ? __EoT__ I know presto does n't support RBAC for authorization . Do you have any plan in the future or is it included in the roadmap ? The RBAC can be a plugin either with Apache Ranger or Apache Sentry or it can have its own model .
diff -- git a/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java b/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java index 252d63e..85811cb 100644 -- - a/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java +++ b/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java @ @ -45,6 +45,7 @ @ public final class SystemSessionProperties public static final String PREFER_STREAMING_OPERATORS = `` prefer_streaming_operators '' ; public static final String TASK_WRITER_COUNT = `` task_writer_count '' ; public static final String TASK_CONCURRENCY = `` task_concurrency '' ; + public static final String LOCAL_EXCHANGE_CONCURRENCY = `` local_exchange_concurrency '' ; public static final String TASK_SHARE_INDEX_LOADING = `` task_share_index_loading '' ; public static final String QUERY_MAX_MEMORY = `` query_max_memory '' ; public static final String QUERY_MAX_RUN_TIME = `` query_max_run_time '' ; @ @ -154,6 +155,11 @ @ public final class SystemSessionProperties return concurrency ; } , value - > value ) , + integerSessionProperty ( + LOCAL_EXCHANGE_CONCURRENCY , + `` Number of local parallel hash partitioners per local exchange '' , + 1 , + false ) , booleanSessionProperty ( TASK_SHARE_INDEX_LOADING , `` Share index join lookups and caching within a task '' , @ @ -311,6 +317,11 @ @ public final class SystemSessionProperties return session.getSystemProperty ( TASK_CONCURRENCY , Integer.class ) ; } + public static int getLocalExchangeConcurrency ( Session session ) + { + return session.getSystemProperty ( LOCAL_EXCHANGE_CONCURRENCY , Integer.class ) ; + } + public Performance regression for OUTER JOINs __EoT__ Following simple query : `` ` SELECT COUNT ( * ) FROM store_sales s FULL OUTER JOIN web_sales w ON s.ss_item_sk = w.ws_item_sk AND s.ss_sold_date_sk = w.ws_sold_date_sk ; `` ` has slowed down between versions 154 and 157 by the factor of 10 . On 8 nodes cluster it was completing in ~60 seconds now it completes in over 540 seconds , with very low CPU usage ( constant ~20 % of 24 cores ) regardless of the ` task_concurrency ` . It does n't seem to be the problem with hash partitioning ( https : //github.com/prestodb/presto/pull/6864 ) . From profiling it seems like the problem is with ` OuterLookupSource.OuterPositionTracker # positionVisited ` method ( called from ` PartitionedLookupSource # appendTo ` ) in which code spends ~90 % of the time . This code was changed recently by @ dain here https : //github.com/prestodb/presto/commit/4f0f9fae5611bbcb0632798a751adda0d9f40a62 Previous version of ` PartitionedLookupSource ` did n't synchronize ` visitedPositions [ ] [ ] ` array , but ` OuterLookupSource ` did synchronize it . Currently , both are synchronized . From profiling it looks like synchronization/locking prevents query from utilizing more CPU . I did n't have
diff -- git a/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java b/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java index 252d63e..85811cb 100644 -- - a/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java +++ b/presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java @ @ -45,6 +45,7 @ @ public final class SystemSessionProperties public static final String PREFER_STREAMING_OPERATORS = `` prefer_streaming_operators '' ; public static final String TASK_WRITER_COUNT = `` task_writer_count '' ; public static final String TASK_CONCURRENCY = `` task_concurrency '' ; + public static final String LOCAL_EXCHANGE_CONCURRENCY = `` local_exchange_concurrency '' ; public static final String TASK_SHARE_INDEX_LOADING = `` task_share_index_loading '' ; public static final String QUERY_MAX_MEMORY = `` query_max_memory '' ; public static final String QUERY_MAX_RUN_TIME = `` query_max_run_time '' ; @ @ -154,6 +155,11 @ @ public final class SystemSessionProperties return concurrency ; } , value - > value ) , + integerSessionProperty ( + LOCAL_EXCHANGE_CONCURRENCY , + `` Number of local parallel hash partitioners per local exchange '' , + 1 , + false ) , booleanSessionProperty ( TASK_SHARE_INDEX_LOADING , `` Share index join lookups and caching within a task '' , @ @ -311,6 +317,11 @ @ public final class SystemSessionProperties return session.getSystemProperty ( TASK_CONCURRENCY , Integer.class ) ; } + public static int getLocalExchangeConcurrency ( Session session ) + { + return session.getSystemProperty ( LOCAL_EXCHANGE_CONCURRENCY , Integer.class ) ; + } + public Performance regression for OUTER JOINs __EoT__ Following simple query : `` ` SELECT COUNT ( * ) FROM store_sales s FULL OUTER JOIN web_sales w ON s.ss_item_sk = w.ws_item_sk AND s.ss_sold_date_sk = w.ws_sold_date_sk ; `` ` has slowed down between versions 154 and 157 by the factor of 10 . On 8 nodes cluster it was completing in ~60 seconds now it completes in over 540 seconds , with very low CPU usage ( constant ~20 % of 24 cores ) regardless of the ` task_concurrency ` . It does n't seem to be the problem with hash partitioning ( https : //github.com/prestodb/presto/pull/6864 ) . From profiling it seems like the problem is with ` OuterLookupSource.OuterPositionTracker # positionVisited ` method ( called from ` PartitionedLookupSource # appendTo ` ) in which code spends ~90 % of the time . This code was changed recently by @ dain here https : //github.com/prestodb/presto/commit/4f0f9fae5611bbcb0632798a751adda0d9f40a62 Previous version of ` PartitionedLookupSource ` did n't synchronize ` visitedPositions [ ] [ ] ` array , but ` OuterLookupSource ` did synchronize it . Currently , both are synchronized . From profiling it looks like synchronization/locking prevents query from utilizing more CPU . I did n't have
diff -- git a/presto-main/src/main/java/com/facebook/presto/metadata/FunctionRegistry.java b/presto-main/src/main/java/com/facebook/presto/metadata/FunctionRegistry.java index 82bc057..860b785 100644 -- - a/presto-main/src/main/java/com/facebook/presto/metadata/FunctionRegistry.java +++ b/presto-main/src/main/java/com/facebook/presto/metadata/FunctionRegistry.java @ @ -45,6 +45,7 @ @ import com.facebook.presto.operator.scalar.ArrayElementAtFunction ; import com.facebook.presto.operator.scalar.ArrayEqualOperator ; import com.facebook.presto.operator.scalar.ArrayFunctions ; import com.facebook.presto.operator.scalar.ArrayGreaterThanOperator ; +import com.facebook.presto.operator.scalar.ArrayLessThanOperator ; import com.facebook.presto.operator.scalar.ArrayLessThanOrEqualOperator ; import com.facebook.presto.operator.scalar.ArrayMaxFunction ; import com.facebook.presto.operator.scalar.ArrayMinFunction ; @ @ -162,7 +163,6 @ @ import static com.facebook.presto.operator.scalar.ArrayHashCodeOperator.ARRAY_HA import static com.facebook.presto.operator.scalar.ArrayIntersectFunction.ARRAY_INTERSECT_FUNCTION ; import static com.facebook.presto.operator.scalar.ArrayJoin.ARRAY_JOIN ; import static com.facebook.presto.operator.scalar.ArrayJoin.ARRAY_JOIN_WITH_NULL_REPLACEMENT ; -import static com.facebook.presto.operator.scalar.ArrayLessThanOperator.ARRAY_LESS_THAN ; import static com.facebook.presto.operator.scalar.ArrayPositionFunction.ARRAY_POSITION ; import static com.facebook.presto.operator.scalar.ArraySliceFunction.ARRAY_SLICE_FUNCTION ; import static com.facebook.presto.operator.scalar.ArraySortFunction.ARRAY_SORT_FUNCTION ; @ @ -345,6 +345,7 @ @ public class FunctionRegistry .scalar ( JsonOperators.class ) .scalar ( FailureFunction.class ) .functions ( IDENTITY_CAST , CAST_FROM_UNKNOWN ) + .scalar ( ArrayLessThanOperator.class ) .scalar ( ArrayLessThanOrEqualOperator.class ) .scalar ( ArrayRemoveFunction.class ) .scalar ( ArrayGreaterThanOperator.class ) @ @ -357,7 +358,7 @ @ public class FunctionRegistry .scalar ( MapEqualOperator.class ) .scalar ( ArrayEqualOperator.class ) .functions ( ARRAY_CONTAINS , ARRAY_JOIN , ARRAY_JOIN_WITH_NULL_REPLACEMENT ) - .functions ( ARRAY_TO_ARRAY_CAST , ARRAY_HASH_CODE , ARRAY_LESS_THAN , ARRAY_GREATER_THAN_OR_EQUAL ) + .functions ( ARRAY_TO_ARRAY_CAST , ARRAY_HASH_CODE , ARRAY_GREATER_THAN_OR_EQUAL ) .functions ( ARRAY_TO_ELEMENT_CONCAT_FUNCTION , ELEMENT_TO_ARRAY_CONCAT_FUNCTION ) .functions ( MAP_NOT_EQUAL , MAP_HASH_CODE ) .functions ( ARRAY_CONSTRUCTOR , ARRAY_SUBSCRIPT , ARRAY_CARDINALITY , ARRAY_POSITION , ARRAY_SORT_FUNCTION , ARRAY_INTERSECT_FUNCTION , ARRAY_TO_JSON , JSON_TO_ARRAY , ARRAY_SLICE_FUNCTION ) diff -- git Migrate array less_than operator to new framework __EoT__ See https : //github.com/cberner/presto/commit/b0f94c381f61465779f909ed6592dfcd8fdbd01a for an example of how this is done . The code is in ` ArrayLessThanOperator.java `
diff -- git a/presto-docs/src/main/sphinx/connector/hive.rst b/presto-docs/src/main/sphinx/connector/hive.rst index 84e2e3b..30ab8a3 100644 -- - a/presto-docs/src/main/sphinx/connector/hive.rst +++ b/presto-docs/src/main/sphinx/connector/hive.rst @ @ -123,8 +123,6 @ @ Property Name Description `` hive.max-partitions-per-writers `` Maximum number of partitions per writer . 100 - `` hive.s3.sse.enabled `` Enable S3 server-side encryption . `` false `` - `` hive.metastore.authentication.type `` Hive metastore authentication type . `` NONE `` Possible values are `` NONE `` or `` KERBEROS `` . @ @ -195,3 +193,119 @ @ Hive Connector Limitations -- -- -- -- -- -- -- -- -- -- -- -- -- : doc : ` /sql/delete ` is only supported if the `` WHERE `` clause matches entire partitions . + + +Hive Data Stored in Amazon S3 + -- -- -- -- -- -- -- -- -- -- -- -- -- -- - + +The Hive Connector can read data from files stored in S3 , assuming the Hive +Metastore has tables defined as `` external '' which have locations defined as +S3 URIs . + +Presto registers its own S3 filesystem for the following URI schemes : + `` s3 : // `` , `` s3a : // `` , `` s3n : // `` and it registers the Document S3 custom credentials providers __EoT__ We should add documentation for # 5667 . Maybe add a section to the Hive connector docs about S3 and add a sub-section for this .
diff -- git a/presto-cli/src/main/java/com/facebook/presto/cli/StatusPrinter.java b/presto-cli/src/main/java/com/facebook/presto/cli/StatusPrinter.java index 71cf26d..0eda863 100644 -- - a/presto-cli/src/main/java/com/facebook/presto/cli/StatusPrinter.java +++ b/presto-cli/src/main/java/com/facebook/presto/cli/StatusPrinter.java @ @ -122,6 +122,9 @ @ Parallelism : 2.5 } catch ( RuntimeException e ) { log.debug ( e , `` error printing status '' ) ; + if ( debug ) { + e.printStackTrace ( out ) ; + } } } } [ StatementResource ] Properly handle exceptions while handling blocks/types __EoT__ See # 4369
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java index 070e4c7..795b5bb 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java @ @ -73,6 +73,7 @ @ import com.facebook.presto.sql.tree.Join ; import com.facebook.presto.sql.tree.JoinCriteria ; import com.facebook.presto.sql.tree.JoinOn ; import com.facebook.presto.sql.tree.JoinUsing ; +import com.facebook.presto.sql.tree.Lateral ; import com.facebook.presto.sql.tree.LongLiteral ; import com.facebook.presto.sql.tree.NaturalJoin ; import com.facebook.presto.sql.tree.Node ; @ @ -585,6 +586,15 @ @ class StatementAnalyzer } @ Override + protected Scope visitLateral ( Lateral node , Scope scope ) + { + StatementAnalyzer analyzer = new StatementAnalyzer ( analysis , metadata , sqlParser , accessControl , session ) ; + Scope queryScope = analyzer.process ( node.getQuery ( ) , scope ) ; + analysis.setScope ( node , queryScope ) ; + return queryScope ; + } + + @ Override protected Scope visitTable ( Table table , Scope scope ) { if ( ! table.getName ( ) .getPrefix ( ) .isPresent ( ) ) { @ @ -898,7 +908,7 @ @ class StatementAnalyzer } Scope left = process ( node.getLeft ( ) , scope ) ; - Scope right = process ( node.getRight ( ) , isUnnestRelation ( node.getRight ( ) ) ? left : scope ) ; + Scope right = process ( node.getRight ( ) , isLateralRelation ( node.getRight ( ) ) Aggregate before join for simple correlated scalar subqueries __EoT__ Correlated scalar subqueries currently get rewritten to a left outer join followed by an aggregation with a grouping on all the columns from the left table , followed by a filter . When the join condition is an equality join condition in conjunctive normal form , we can instead perform the aggregation before the join , and group by the join keys . Example : `` ` SELECT * FROM nation n1 WHERE ( n1.nationkey > ( SELECT avg ( nationkey ) FROM nation n2 WHERE n1.regionkey=n2.regionkey ) `` ` Currently we would do `` ` - Filter ( `` nationkey '' > `` avg '' ) - Aggregate ( Group by : all columns from the left talbe , aggregation : avg ( `` n2.nationkey '' ) ) - LeftJoin ( `` regionkey '' = `` regionkey '' ) - Add unique id ( nation ) - Tablescan ( nation ) - Tablescan ( nation ) `` ` Instead we could aggregate before the join . `` ` - Filter ( `` nationkey '' > `` avg '' ) - LeftJoin ( `` regionkey '' = `` regionkey '' )
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java index 070e4c7..795b5bb 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java @ @ -73,6 +73,7 @ @ import com.facebook.presto.sql.tree.Join ; import com.facebook.presto.sql.tree.JoinCriteria ; import com.facebook.presto.sql.tree.JoinOn ; import com.facebook.presto.sql.tree.JoinUsing ; +import com.facebook.presto.sql.tree.Lateral ; import com.facebook.presto.sql.tree.LongLiteral ; import com.facebook.presto.sql.tree.NaturalJoin ; import com.facebook.presto.sql.tree.Node ; @ @ -585,6 +586,15 @ @ class StatementAnalyzer } @ Override + protected Scope visitLateral ( Lateral node , Scope scope ) + { + StatementAnalyzer analyzer = new StatementAnalyzer ( analysis , metadata , sqlParser , accessControl , session ) ; + Scope queryScope = analyzer.process ( node.getQuery ( ) , scope ) ; + analysis.setScope ( node , queryScope ) ; + return queryScope ; + } + + @ Override protected Scope visitTable ( Table table , Scope scope ) { if ( ! table.getName ( ) .getPrefix ( ) .isPresent ( ) ) { @ @ -898,7 +908,7 @ @ class StatementAnalyzer } Scope left = process ( node.getLeft ( ) , scope ) ; - Scope right = process ( node.getRight ( ) , isUnnestRelation ( node.getRight ( ) ) ? left : scope ) ; + Scope right = process ( node.getRight ( ) , isLateralRelation ( node.getRight ( ) ) Aggregate before join for simple correlated scalar subqueries __EoT__ Correlated scalar subqueries currently get rewritten to a left outer join followed by an aggregation with a grouping on all the columns from the left table , followed by a filter . When the join condition is an equality join condition in conjunctive normal form , we can instead perform the aggregation before the join , and group by the join keys . Example : `` ` SELECT * FROM nation n1 WHERE ( n1.nationkey > ( SELECT avg ( nationkey ) FROM nation n2 WHERE n1.regionkey=n2.regionkey ) `` ` Currently we would do `` ` - Filter ( `` nationkey '' > `` avg '' ) - Aggregate ( Group by : all columns from the left talbe , aggregation : avg ( `` n2.nationkey '' ) ) - LeftJoin ( `` regionkey '' = `` regionkey '' ) - Add unique id ( nation ) - Tablescan ( nation ) - Tablescan ( nation ) `` ` Instead we could aggregate before the join . `` ` - Filter ( `` nationkey '' > `` avg '' ) - LeftJoin ( `` regionkey '' = `` regionkey '' )
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analysis.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analysis.java index b12936f..4efb986 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analysis.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analysis.java @ @ -439,6 +439,13 @ @ public class Analysis return unmodifiableMap ( columnReferences ) ; } + public boolean isColumnReference ( Expression expression ) + { + requireNonNull ( expression , `` expression is null '' ) ; + checkArgument ( getType ( expression ) ! = null , `` expression % s has not been analyzed '' , expression ) ; + return columnReferences.containsKey ( NodeRef.of ( expression ) ) ; + } + public void addTypes ( Map < NodeRef < Expression > , Type > types ) { this.types.putAll ( types ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ExpressionAnalyzer.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ExpressionAnalyzer.java index a5559d0..1eb6e63 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ExpressionAnalyzer.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ExpressionAnalyzer.java @ @ -98,7 +98,6 @ @ import io.airlift.slice.SliceUtf8 ; import javax.annotation.Nullable ; import java.util.ArrayList ; -import java.util.HashMap ; import java.util.LinkedHashMap ; import java.util.LinkedHashSet ; import java.util.List ; @ @ -255,12 +254,12 @ @ public class ExpressionAnalyzer public Type analyze ( Expression expression , Scope scope ) { Visitor visitor = new Visitor ( scope ) ; - return visitor.process ( expression , new StackableAstVisitor.StackableAstVisitorContext < > ( Context.notInLambda ( ) ) ) ; + return visitor.process ( expression Lambda captures do not work with qualified column names __EoT__ This works : `` ` select transform ( ARRAY [ 1 ] , x - > x + a ) from ( values 1 ) u ( a ) ; -- output : 2 `` ` But this does not : `` ` select transform ( ARRAY [ 1 ] , x - > x + u.a ) from ( values 1 ) u ( a ) ; -- line 1:37 : Column 'u ' can not be resolved `` ` FYI : @ martint @ haozhun @ sopel39
diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/CoercionPolicy.java b/presto-hive/src/main/java/com/facebook/presto/hive/CoercionPolicy.java index 7cdb9ad..1268b33 100644 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/CoercionPolicy.java +++ b/presto-hive/src/main/java/com/facebook/presto/hive/CoercionPolicy.java @ @ -13,7 +13,13 @ @ */ package com.facebook.presto.hive ; +import com.facebook.presto.spi.block.Block ; + +import java.util.function.Function ; + public interface CoercionPolicy { boolean canCoerce ( HiveType fromType , HiveType toType ) ; + + Function < Block , Block > createCoercer ( HiveType fromHiveType , HiveType toHiveType ) ; } diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveClientModule.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveClientModule.java index ddccba2..c3242b9 100644 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/HiveClientModule.java +++ b/presto-hive/src/main/java/com/facebook/presto/hive/HiveClientModule.java @ @ -13,6 +13,7 @ @ */ package com.facebook.presto.hive ; +import com.facebook.presto.hive.coercions.HiveCoercionPolicy ; import com.facebook.presto.hive.metastore.SemiTransactionalHiveMetastore ; import com.facebook.presto.hive.orc.DwrfPageSourceFactory ; import com.facebook.presto.hive.orc.OrcPageSourceFactory ; diff -- git a/presto-hive/src/main/java/com/facebook/presto/hive/HiveCoercionPolicy.java b/presto-hive/src/main/java/com/facebook/presto/hive/HiveCoercionPolicy.java deleted file mode 100644 index ed9a5a5..0000000 -- - a/presto-hive/src/main/java/com/facebook/presto/hive/HiveCoercionPolicy.java +++ /dev/null @ @ -1,67 +0,0 @ @ -/* - * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - * you may not use this file except in compliance with the License . - * You may obtain a copy of the License at - * - * http : //www.apache.org/licenses/LICENSE-2.0 - * - * Unless required by applicable law or agreed to in writing , software - * distributed under the License is distributed on an `` AS IS DECIMAL not handled in HiveCoercionPolicy __EoT__ HiveCoercionPolicy does not handle DECIMAL at all . This is needed for schema changes to and from decimal types .
diff -- git a/presto-main/src/test/java/com/facebook/presto/operator/scalar/BenchmarkJsonToArrayCast.java b/presto-main/src/test/java/com/facebook/presto/operator/scalar/BenchmarkJsonToArrayCast.java new file mode 100644 index 0000000..2ae70e7 -- - /dev/null +++ b/presto-main/src/test/java/com/facebook/presto/operator/scalar/BenchmarkJsonToArrayCast.java @ @ -0,0 +1,199 @ @ +/* + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ +package com.facebook.presto.operator.scalar ; + +import com.facebook.presto.metadata.FunctionKind ; +import com.facebook.presto.metadata.MetadataManager ; +import com.facebook.presto.metadata.Signature ; +import com.facebook.presto.operator.project.PageProcessor ; +import com.facebook.presto.spi.Page ; +import com.facebook.presto.spi.block.Block ; +import com.facebook.presto.spi.block.BlockBuilder ; +import com.facebook.presto.spi.block.BlockBuilderStatus ; +import com.facebook.presto.spi.type.ArrayType ; +import com.facebook.presto.spi.type.Type ; +import com.facebook.presto.sql.gen.ExpressionCompiler ; +import com.facebook.presto.sql.relational.CallExpression ; +import com.facebook.presto.sql.relational.RowExpression ; +import com.google.common.collect.ImmutableList ; +import io.airlift.slice.DynamicSliceOutput ; +import io.airlift.slice.SliceOutput ; +import org.openjdk.jmh.annotations.Benchmark ; +import org.openjdk.jmh.annotations.BenchmarkMode ; +import NPE `` Value can not be cast to map ( varchar , varchar ) '' __EoT__ `` ` Caused by : com.facebook.presto.spi.PrestoException : Value can not be cast to map ( varchar , varchar ) at com.facebook.presto.operator.scalar.JsonToMapCast.toMap ( JsonToMapCast.java:94 ) at com.facebook.presto. $ gen.PageFilter_10704.filter ( Unknown Source ) at com.facebook.presto. $ gen.PageFilter_10704.filter ( Unknown Source ) at com.facebook.presto.operator.project.DictionaryAwarePageFilter.filter ( DictionaryAwarePageFilter.java:85 ) at com.facebook.presto.operator.project.PageProcessor.process ( PageProcessor.java:80 ) at com.facebook.presto.operator.ScanFilterAndProjectOperator.processPageSource ( ScanFilterAndProjectOperator.java:283 ) at com.facebook.presto.operator.ScanFilterAndProjectOperator.getOutput ( ScanFilterAndProjectOperator.java:229 ) at com.facebook.presto.operator.Driver.processInternal ( Driver.java:303 ) at com.facebook.presto.operator.Driver.lambda $ processFor $ 6 ( Driver.java:234 ) at com.facebook.presto.operator.Driver.tryWithLock ( Driver.java:541 ) at com.facebook.presto.operator.Driver.processFor ( Driver.java:229 ) at com.facebook.presto.execution.SqlTaskExecution $ DriverSplitRunner.processFor ( SqlTaskExecution.java:623 ) at com.facebook.presto.execution.executor.PrioritizedSplitRunner.process ( PrioritizedSplitRunner.java:162 ) at com.facebook.presto.execution.executor.TaskExecutor $ TaskRunner.run ( TaskExecutor.java:463 ) at java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1142 ) at java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:617 ) at java.lang.Thread.run ( Thread.java:748 ) Caused by : java.lang.NullPointerException : string is null at java.util.Objects.requireNonNull ( Objects.java:228 ) at io.airlift.slice.Slices.copiedBuffer ( Slices.java:289 ) at io.airlift.slice.Slices.utf8Slice ( Slices.java:297 ) at com.facebook.presto.type.TypeJsonUtils.stackRepresentationToObjectHelper ( TypeJsonUtils.java:134 ) at com.facebook.presto.type.TypeJsonUtils.stackRepresentationToObjectHelper ( TypeJsonUtils.java:109 ) at com.facebook.presto.type.TypeJsonUtils.stackRepresentationToObject ( TypeJsonUtils.java:74 ) at com.facebook.presto.operator.scalar.JsonToMapCast.toMap ( JsonToMapCast.java:80 ) ... 16 more
diff -- git a/pom.xml b/pom.xml index 6bc1a0b..a55a3da 100644 -- - a/pom.xml +++ b/pom.xml @ @ -446,7 +446,7 @ @ < dependency > < groupId > io.airlift.tpch < /groupId > < artifactId > tpch < /artifactId > - < version > 0.4 < /version > + < version > 0.5 < /version > < /dependency > < dependency > diff -- git a/presto-client/src/main/java/com/facebook/presto/client/QueryResults.java b/presto-client/src/main/java/com/facebook/presto/client/QueryResults.java index 32fdc32..eec0de4 100644 -- - a/presto-client/src/main/java/com/facebook/presto/client/QueryResults.java +++ b/presto-client/src/main/java/com/facebook/presto/client/QueryResults.java @ @ -38,6 +38,7 @ @ import static com.facebook.presto.spi.type.StandardTypes.ARRAY ; import static com.facebook.presto.spi.type.StandardTypes.BIGINT ; import static com.facebook.presto.spi.type.StandardTypes.BOOLEAN ; import static com.facebook.presto.spi.type.StandardTypes.DATE ; +import static com.facebook.presto.spi.type.StandardTypes.DECIMAL ; import static com.facebook.presto.spi.type.StandardTypes.DOUBLE ; import static com.facebook.presto.spi.type.StandardTypes.INTERVAL_DAY_TO_SECOND ; import static com.facebook.presto.spi.type.StandardTypes.INTERVAL_YEAR_TO_MONTH ; @ @ -281,6 +282,7 @ @ public class QueryResults case DATE : case INTERVAL_YEAR_TO_MONTH : case INTERVAL_DAY_TO_SECOND : + case DECIMAL : return String.class.cast ( value ) ; default : // for now we assume that only the explicit types above are passed diff -- git a/presto-docs/src/main/sphinx/functions.rst b/presto-docs/src/main/sphinx/functions.rst index c08a6d3..4d42a10 100644 -- - a/presto-docs/src/main/sphinx/functions.rst +++ b/presto-docs/src/main/sphinx/functions.rst @ @ -11,6 +11,7 @ @ Functions and Operators functions/conversion functions/math functions/bitwise + functions/decimal functions/string functions/binary functions/datetime diff -- git a/presto-docs/src/main/sphinx/functions/decimal.rst b/presto-docs/src/main/sphinx/functions/decimal.rst new file mode 100644 index 0000000..a8c4bb7 -- - /dev/null +++ b/presto-docs/src/main/sphinx/functions/decimal.rst @ @ Implement DECIMAL type __EoT__
diff -- git a/presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java b/presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java index 897cd33..e91c98d 100644 -- - a/presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java +++ b/presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java @ @ -21,8 +21,6 @ @ import com.facebook.presto.memory.context.MemoryTrackingContext ; import com.facebook.presto.operator.TaskContext ; import com.facebook.presto.spi.QueryId ; import com.facebook.presto.spiller.SpillSpaceTracker ; -import com.google.common.util.concurrent.FutureCallback ; -import com.google.common.util.concurrent.Futures ; import com.google.common.util.concurrent.ListenableFuture ; import io.airlift.units.DataSize ; @ @ -43,6 +41,7 @ @ import static com.facebook.presto.memory.context.AggregatedMemoryContext.newRoot import static com.facebook.presto.operator.Operator.NOT_BLOCKED ; import static com.google.common.base.Preconditions.checkArgument ; import static com.google.common.base.Verify.verify ; +import static com.google.common.util.concurrent.MoreExecutors.directExecutor ; import static io.airlift.units.DataSize.Unit.MEGABYTE ; import static io.airlift.units.DataSize.succinctBytes ; import static java.util.Objects.requireNonNull ; @ @ -170,7 +169,7 @ @ public class QueryContext public synchronized void setMemoryPool ( MemoryPool pool ) { requireNonNull ( pool , `` pool is null '' ) ; - if ( pool.getId ( ) .equals ( memoryPool.getId ( ) ) ) { + if ( memoryPool == pool ) { // Do n't unblock our tasks and thrash the pools , if this is a no-op return ; } @ @ -178,24 +177,11 @ @ public class QueryContext long originalReserved = queryMemoryContext.getUserMemory ( ) + queryMemoryContext.getRevocableMemory ( ) ; memoryPool = pool ; ListenableFuture < ? > future = pool.reserve ( queryId , originalReserved ) ; - Futures.addCallback ( future , new FutureCallback < Object > ( ) - Getting `` Tried to free more revocable memory than is reserved '' randomly when using spill __EoT__ Presto Version - 0.188 Here is stacktrace for the error . `` ` java.lang.IllegalArgumentException : tried to free more revocable memory than is reserved at com.google.common.base.Preconditions.checkArgument ( Preconditions.java:122 ) at com.facebook.presto.memory.MemoryPool.freeRevocable ( MemoryPool.java:196 ) at com.facebook.presto.memory.QueryContext.freeRevocableMemory ( QueryContext.java:168 ) at com.facebook.presto.operator.TaskContext.freeRevocableMemory ( TaskContext.java:226 ) at com.facebook.presto.operator.PipelineContext.freeRevocableMemory ( PipelineContext.java:274 ) at com.facebook.presto.operator.DriverContext.freeRevocableMemory ( DriverContext.java:254 ) at com.facebook.presto.operator.OperatorContext.freeRevocableMemory ( OperatorContext.java:315 ) at com.facebook.presto.operator.OperatorContext.setRevocableMemoryReservation ( OperatorContext.java:307 ) at com.facebook.presto.operator.HashBuilderOperator.lambda $ close $ 11 ( HashBuilderOperator.java:644 ) at com.google.common.io.Closer.close ( Closer.java:216 ) at com.facebook.presto.operator.HashBuilderOperator.close ( HashBuilderOperator.java:645 ) at com.facebook.presto.operator.HashBuilderOperator.finish ( HashBuilderOperator.java:450 ) at com.facebook.presto.operator.Driver.processInternal ( Driver.java:357 ) at com.facebook.presto.operator.Driver.lambda $ processFor $ 6 ( Driver.java:241 ) at com.facebook.presto.operator.Driver.tryWithLock ( Driver.java:614 ) at com.facebook.presto.operator.Driver.processFor ( Driver.java:235 ) at com.facebook.presto.execution.SqlTaskExecution $ DriverSplitRunner.processFor ( SqlTaskExecution.java:622 ) at com.facebook.presto.execution.executor.PrioritizedSplitRunner.process ( PrioritizedSplitRunner.java:163 ) at com.facebook.presto.execution.executor.LegacyPrioritizedSplitRunner.process ( LegacyPrioritizedSplitRunner.java:23 ) at com.facebook.presto.execution.executor.TaskExecutor $ TaskRunner.run ( TaskExecutor.java:492 ) at java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1149 ) at java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:624 ) at java.lang.Thread.run ( Thread.java:748 ) `` `
diff -- git a/presto-docs/src/main/sphinx/functions/datetime.rst b/presto-docs/src/main/sphinx/functions/datetime.rst index f5904e3..c42af53 100644 -- - a/presto-docs/src/main/sphinx/functions/datetime.rst +++ b/presto-docs/src/main/sphinx/functions/datetime.rst @ @ -210,9 +210,9 @ @ Java Date Functions -- -- -- -- -- -- -- -- -- - The functions in this section use a format string that is compatible with -the Java ` SimpleDateFormat ` _ pattern format . +JodaTime 's ` DateTimeFormat ` _ pattern format . -.. _SimpleDateFormat : http : //docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html +.. _DateTimeFormat : http : //joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html .. function : : format_datetime ( timestamp , format ) - > varchar format_datetime/parse_datetime docs incorrectly reference Java 's SimpleDateTimeFormat __EoT__ The documentation for format_datetime indicate the functions use Java 's SimpleDateTimeFormat syntax . In reality , the implementation uses JodaTime 's DateTimeFormat , which supports a different syntax . Java : http : //docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html JodaTime : http : //joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analyzer.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analyzer.java index c8cebb4..3c51602 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analyzer.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/Analyzer.java @ @ -65,7 +65,7 @ @ public class Analyzer Statement rewrittenStatement = StatementRewrite.rewrite ( session , metadata , sqlParser , queryExplainer , statement , parameters , accessControl ) ; Analysis analysis = new Analysis ( rewrittenStatement , parameters , isDescribe ) ; StatementAnalyzer analyzer = new StatementAnalyzer ( analysis , metadata , sqlParser , accessControl , session ) ; - analyzer.analyze ( rewrittenStatement , Scope.create ( ) ) ; + analyzer.analyze ( rewrittenStatement , Optional.empty ( ) ) ; return analysis ; } diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ResolvedField.java b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ResolvedField.java index 8cea073..3755661 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ResolvedField.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/analyzer/ResolvedField.java @ @ -24,14 +24,16 @ @ public class ResolvedField { private final Scope scope ; private final Field field ; - private final int fieldIndex ; + private final int hierarchyFieldIndex ; + private final int relationFieldIndex ; private final boolean local ; - public ResolvedField ( Scope scope , Field field , int fieldIndex , boolean local ) + public ResolvedField ( Scope scope , Field field , int hierarchyFieldIndex , int relationFieldIndex , boolean local ) { this.scope = requireNonNull ( scope , `` scope is null '' ) AnalyzeAggregations does n't correctly verify lambas __EoT__ `` ` presto : sf1 > select transform ( array [ 0 ] , y - > transform ( array [ 42 ] , y - > x + y ) ) from ( values ( 1,2 ) ) t ( x , y ) group by x+y ; Query 20170331_142639_00008_tdkiy failed : Invalid node . Expression dependencies ( [ field ] ) not in source plan output ( [ expr_6 , $ hashvalue ] ) `` ` I will fix it as part ( or prerequisite ) of https : //github.com/prestodb/presto/pull/7315 since it closely related and I want to avoid conflicts . FYI : @ martint @ haozhun
diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/QueryPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/QueryPlanner.java index 00c7e7e..c6d9467 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/QueryPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/QueryPlanner.java @ @ -560,6 +560,7 @ @ class QueryPlanner subPlan.getRoot ( ) , aggregations , groupingSymbols , + ImmutableList.of ( ) , AggregationNode.Step.SINGLE , Optional.empty ( ) , groupIdSymbol ) ; @ @ -770,6 +771,7 @ @ class QueryPlanner subPlan.getRoot ( ) , ImmutableMap.of ( ) , ImmutableList.of ( subPlan.getRoot ( ) .getOutputSymbols ( ) ) , + ImmutableList.of ( ) , AggregationNode.Step.SINGLE , Optional.empty ( ) , Optional.empty ( ) ) ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java index ef66649..dde7e66 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java @ @ -813,6 +813,7 @ @ class RelationPlanner node , ImmutableMap.of ( ) , ImmutableList.of ( node.getOutputSymbols ( ) ) , + ImmutableList.of ( ) , AggregationNode.Step.SINGLE , Optional.empty ( ) , Optional.empty ( ) ) ; diff -- git a/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/AddIntermediateAggregations.java b/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/AddIntermediateAggregations.java index 8f2c4ea..0aaaaf7 100644 -- - a/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/AddIntermediateAggregations.java +++ b/presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/AddIntermediateAggregations.java @ @ -117,6 +117,7 @ @ public class AddIntermediateAggregations source , inputsAsOutputs ( aggregation.getAggregations ( ) ) , aggregation.getGroupingSets ( ) , + aggregation.getPreGroupedSymbols ( ) , AggregationNode.Step.INTERMEDIATE , aggregation.getHashSymbol ( ) , aggregation.getGroupIdSymbol ( ) ) ; @ @ -159,6 +160,7 @ @ public class AddIntermediateAggregations gatheringExchange , outputsAsInputs ( Avoid unnecessary exchange and partial aggregation in correlated scalar subquery and correlated IN predicate __EoT__ For a correlated scalar subquery like `` ` select name , ( select max ( name ) from region where regionkey = nation.regionkey ) from nation ; `` ` we currently produce the following plan ( i 'm using ` set session push_aggregation_through_join = false ; ` to have the plan more readable ) `` ` - Output [ name , _col1 ] = > [ name : varchar ( 25 ) , max : varchar ( 25 ) ] _col1 : = max - RemoteExchange [ GATHER ] = > name : varchar ( 25 ) , max : varchar ( 25 ) - Project [ ] = > [ name : varchar ( 25 ) , max : varchar ( 25 ) ] x - Aggregate ( FINAL ) [ name , regionkey , unique ] [ $ hashvalue ] = > [ name : varchar ( 25 ) , regionkey : bigint , unique : bigint , $ hashvalue : bigint , max : varchar ( 25 ) ] x max : = `` max '' ( `` max_17 '' ) x
diff -- git a/MPChartExample/AndroidManifest.xml b/MPChartExample/AndroidManifest.xml index b1ac584..1b9e002 100644 -- - a/MPChartExample/AndroidManifest.xml +++ b/MPChartExample/AndroidManifest.xml @ @ -66,6 +66,7 @ @ < activity android : name= '' .BarChartPositiveNegative '' > < /activity > < activity android : name= '' .FilledLineActivity '' > < /activity > < activity android : name= '' .HalfPieChartActivity '' > < /activity > + < activity android : name= '' .SpecificXLabelsLineChartActivity '' > < /activity > < /application > < /manifest > diff -- git a/MPChartExample/src/com/xxmassdeveloper/mpchartexample/SpecificXLabelsLineChartActivity.java b/MPChartExample/src/com/xxmassdeveloper/mpchartexample/SpecificXLabelsLineChartActivity.java new file mode 100644 index 0000000..8e327b0 -- - /dev/null +++ b/MPChartExample/src/com/xxmassdeveloper/mpchartexample/SpecificXLabelsLineChartActivity.java @ @ -0,0 +1,454 @ @ + +package com.xxmassdeveloper.mpchartexample ; + +import android.graphics.Color ; +import android.graphics.DashPathEffect ; +import android.graphics.Typeface ; +import android.graphics.drawable.Drawable ; +import android.os.Bundle ; +import android.support.v4.content.ContextCompat ; +import android.util.Log ; +import android.view.Menu ; +import android.view.MenuItem ; +import android.view.MotionEvent ; +import android.view.WindowManager ; +import android.widget.SeekBar ; +import android.widget.SeekBar.OnSeekBarChangeListener ; +import android.widget.TextView ; +import android.widget.Toast ; + +import com.github.mikephil.charting.animation.Easing ; +import com.github.mikephil.charting.charts.LineChart ; +import com.github.mikephil.charting.components.Legend ; +import com.github.mikephil.charting.components.Legend.LegendForm ; +import com.github.mikephil.charting.components.LimitLine ; +import com.github.mikephil.charting.components.LimitLine.LimitLabelPosition ; +import com.github.mikephil.charting.components.XAxis ; +import com.github.mikephil.charting.components.YAxis ; +import com.github.mikephil.charting.data.Entry ; +import com.github.mikephil.charting.data.LineData ; +import com.github.mikephil.charting.data.LineDataSet ; +import com.github.mikephil.charting.highlight.Highlight ; +import com.github.mikephil.charting.interfaces.datasets.ILineDataSet ; +import com.github.mikephil.charting.listener.ChartTouchListener ; +import com.github.mikephil.charting.listener.OnChartGestureListener ; +import com.github.mikephil.charting.listener.OnChartValueSelectedListener ; +import com.github.mikephil.charting.utils.Utils ; +import com.xxmassdeveloper.mpchartexample.custom.MyMarkerView Understanding 2 label concepts __EoT__ I am having 2 problems with my MPAndroidChart 3.0.1 graphs and since I ca n't find the programatically answer I am trying to understand on a concept level how things work so I can try to workout my code . By the way my charts are time series with temperature as Y value and timestamps as X values . Basically this is problem 1 that I do n't understand . When I plot a chart , even if I do n't set ANY xAxis value formatter , I get vertical grid lines that are not equally spaced , and are not exclusively marking my Y values . See : < img width= '' 261 '' alt= '' screen shot 2017-03-03 at 15 18 09 '' src= '' https : //cloud.githubusercontent.com/assets/1178093/23555388/08f74008-0029-11e7-9c4e-de2a27c0f534.png '' > So regarding this issue , my goal was to either have these lines equally spaced representing fixed time periods , OR , ONLY to mark my Y values , AND NOT random spots where I do n't even have a Y value . Then my issue number 2 that I would like to understand conceptually . I have a database with 2 columns
diff -- git a/MPChartLib/src/main/java/com/github/mikephil/charting/components/LimitLine.java b/MPChartLib/src/main/java/com/github/mikephil/charting/components/LimitLine.java index 8fcdee8..1ce3a59 100644 -- - a/MPChartLib/src/main/java/com/github/mikephil/charting/components/LimitLine.java +++ b/MPChartLib/src/main/java/com/github/mikephil/charting/components/LimitLine.java @ @ -40,7 +40,7 @ @ public class LimitLine extends ComponentBase { /** enum that indicates the position of the LimitLine label */ public enum LimitLabelPosition { - LEFT_TOP , LEFT_BOTTOM , RIGHT_TOP , RIGHT_BOTTOM + LEFT_TOP , LEFT_BOTTOM , RIGHT_TOP , RIGHT_BOTTOM , CENTER_BOTTOM } /** diff -- git a/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/XAxisRenderer.java b/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/XAxisRenderer.java index 2c30579..43485f1 100644 -- - a/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/XAxisRenderer.java +++ b/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/XAxisRenderer.java @ @ -344,7 +344,12 @ @ public class XAxisRenderer extends AxisRenderer { mLimitLineSegmentsBuffer [ 0 ] = position [ 0 ] ; mLimitLineSegmentsBuffer [ 1 ] = mViewPortHandler.contentTop ( ) ; mLimitLineSegmentsBuffer [ 2 ] = position [ 0 ] ; - mLimitLineSegmentsBuffer [ 3 ] = mViewPortHandler.contentBottom ( ) ; + + if ( limitLine.getLabelPosition ( ) == LimitLine.LimitLabelPosition.CENTER_BOTTOM ) { + mLimitLineSegmentsBuffer [ 3 ] = mViewPortHandler.contentBottom ( ) - limitLine.getTextSize ( ) ; + } else { + mLimitLineSegmentsBuffer [ 3 ] = mViewPortHandler.contentBottom ( ) ; + } mLimitLinePath.reset ( ) ; mLimitLinePath.moveTo ( mLimitLineSegmentsBuffer [ 0 ] , mLimitLineSegmentsBuffer [ 1 ] ) ; @ @ -391,7 +396,12 @ @ public class XAxisRenderer extends AxisRenderer { final float labelLineHeight = Utils.calcTextHeight ( Why does AxisBase.setLabelCount has a maximum value ? And why 25 ? __EoT__ AxisBase.setLabelCount put a maximum of 25 labels . Why this limit ? How has it been decided ? `` ` public void setLabelCount ( int count ) { if ( count > 25 ) count = 25 ; if ( count < 2 ) count = 2 ; mLabelCount = count ; mForceLabels = false ; } `` ` I 'm trying to have only specific labels displayed on xAxis ( one every two points , starting at the second data point ) , so I was going to tell the axis I have 52 labels ( the number of points in my case , from 0 to 51 ) , and then in my custom axisFormatter , return empty string for labels that should not be shown . Is there an easier way ? In other word , I want to specifically tell the graph to show a label for one ( or several ) x points , by deciding which x point ( not having it automatically chosen by the lib ) . thanks
diff -- git a/MPChartLib/src/com/github/mikephil/charting/charts/LineChart.java b/MPChartLib/src/com/github/mikephil/charting/charts/LineChart.java index bc51eb3..2716230 100644 -- - a/MPChartLib/src/com/github/mikephil/charting/charts/LineChart.java +++ b/MPChartLib/src/com/github/mikephil/charting/charts/LineChart.java @ @ -198,11 +198,12 @ @ public class LineChart extends BarLineChartBase < LineData > { // if filled is enabled , close the path if ( dataSet.isDrawFilledEnabled ( ) ) { - float fillMin = mFillFormatter - .getFillLinePosition ( dataSet , mOriginalData , mYChartMax , mYChartMin ) ; +// float fillMin = mFillFormatter +// .getFillLinePosition ( dataSet , mOriginalData , mYChartMax , mYChartMin ) ; - spline.lineTo ( ( entries.size ( ) - 1 ) * mPhaseX , fillMin ) ; - spline.lineTo ( 0 , fillMin ) ; + CPoint lastPoint = points.get ( points.size ( ) -1 ) ; + spline.lineTo ( lastPoint.x , 0 ) ; + spline.lineTo ( 0 , 0 ) ; spline.close ( ) ; mRenderPaint.setStyle ( Paint.Style.FILL ) ; linechart fill incomplete when cubic is set __EoT__ I have a chart with 5 datasets . They are ordered so that filled areas block each other . This works great until I set drawCubic to true . Then all the fills are drawn from 0,0 to the entry point . This works : ! [ screen shot 2014-10-28 at 1 52 58 pm ] ( https : //cloud.githubusercontent.com/assets/1617276/4815044/ef1a5434-5ed3-11e4-8579-dd686bad9dd7.png ) This shows the bug ; ! [ screen shot 2014-10-28 at 1 54 39 pm ] ( https : //cloud.githubusercontent.com/assets/1617276/4815057/ff2c23fc-5ed3-11e4-8009-4dd32dd7f900.png )
diff -- git a/MPChartLib/src/com/github/mikephil/charting/utils/Utils.java b/MPChartLib/src/com/github/mikephil/charting/utils/Utils.java index 7a562a1..a038a80 100644 -- - a/MPChartLib/src/com/github/mikephil/charting/utils/Utils.java +++ b/MPChartLib/src/com/github/mikephil/charting/utils/Utils.java @ @ -532,7 +532,7 @ @ public abstract class Utils { private static Rect mDrawTextRectBuffer = new Rect ( ) ; private static Paint.FontMetrics mFontMetricsBuffer = new Paint.FontMetrics ( ) ; - private static float mLineHeight = 9999.0f ; + private static float mLineHeight = 0.0f ; public static void drawText ( Canvas c , String text , float x , float y , Paint paint , @ @ -543,11 +543,15 @ @ public abstract class Utils { paint.getTextBounds ( text , 0 , text.length ( ) , mDrawTextRectBuffer ) ; - if ( mDrawTextRectBuffer.height ( ) < mLineHeight ) { + //the method paint.getTextBounds return different values height for letter . + //so we need get only one lineHeight for textAlign + if ( mDrawTextRectBuffer.height ( ) > mLineHeight ) { mLineHeight = mDrawTextRectBuffer.height ( ) ; } - final float lineHeight = mLineHeight ; + mLineHeight = mDrawTextRectBuffer.bottom + mLineHeight / 2 ; + + final float lineHeight = mLineHeight ; // Android sometimes has pre-padding drawOffsetX -= mDrawTextRectBuffer.left ; X Axis Labels being cut off horizontally __EoT__ I have a line chart with the X Axis position set to BOTTOM . A visual issue occurs where some labels are cut off horizontally . Adding a margin or extra padding does not resolve this issue . I 'm confused at to why the first label appears correctly and the rest do not . It 's worth noting that I 'm using a custom font for the chart level TypeFace . ! [ chartxaxisissue ] ( https : //cloud.githubusercontent.com/assets/3513340/14315104/549a12be-fbf3-11e5-8f1a-5b254d38616d.png ) Using version 2.2.4 Potentially related to Issue # 1484
diff -- git a/MPChartLib/src/main/java/com/github/mikephil/charting/charts/PieChart.java b/MPChartLib/src/main/java/com/github/mikephil/charting/charts/PieChart.java index bad10db..85231cf 100644 -- - a/MPChartLib/src/main/java/com/github/mikephil/charting/charts/PieChart.java +++ b/MPChartLib/src/main/java/com/github/mikephil/charting/charts/PieChart.java @ @ -70,7 +70,7 @ @ public class PieChart extends PieRadarChartBase < PieData > { /** * variable for the text that is drawn in the center of the pie-chart */ - private CharSequence mCenterText = `` '' ; + private CharSequence mCenterText ; private MPPointF mCenterTextOffset = MPPointF.getInstance ( 0 , 0 ) ; Why ca n't Override init ( ) to set some attribute ? __EoT__ * I have read all issues . When I override init ( ) to set some attribute like ` setScaleYEnabled ( false ) ; ` ` setDoubleTapToZoomEnabled ( false ) ; ` Its wo n't work ! I have debug this issues , ` mScaleXEnabled=true ` ` mDoubleTapToZoomEnabled = true ` after ` setData ( CombinedData data ) ` . ref : # 2733 # 2511 # 2055
diff -- git a/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/BarChartRenderer.java b/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/BarChartRenderer.java index cffcc1c..30168e3 100644 -- - a/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/BarChartRenderer.java +++ b/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/BarChartRenderer.java @ @ -334,7 +334,7 @ @ public class BarChartRenderer extends BarLineScatterCandleBubbleRenderer { if ( set == null || ! set.isHighlightEnabled ( ) ) continue ; - BarEntry e = set.getEntryForXPos ( high.getX ( ) ) ; + BarEntry e = set.getEntryForXIndex ( high.getX ( ) ) ; if ( ! isInBoundsX ( e , set ) ) continue ; diff -- git a/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/BarLineScatterCandleBubbleRenderer.java b/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/BarLineScatterCandleBubbleRenderer.java index 60697ea..66e7ca2 100644 -- - a/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/BarLineScatterCandleBubbleRenderer.java +++ b/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/BarLineScatterCandleBubbleRenderer.java @ @ -1,7 +1,6 @ @ package com.github.mikephil.charting.renderer ; import com.github.mikephil.charting.animation.ChartAnimator ; -import com.github.mikephil.charting.data.BarEntry ; import com.github.mikephil.charting.data.DataSet ; import com.github.mikephil.charting.data.Entry ; import com.github.mikephil.charting.interfaces.dataprovider.BarLineScatterCandleBubbleDataProvider ; @ @ -83,8 +82,8 @ @ public abstract class BarLineScatterCandleBubbleRenderer extends DataRenderer { float low = chart.getLowestVisibleX ( ) ; float high = chart.getHighestVisibleX ( ) ; - Entry entryFrom = dataSet.getEntryForXPos ( low , DataSet.Rounding.DOWN ) ; - Entry entryTo = dataSet.getEntryForXPos ( high , DataSet.Rounding.UP ) ; + Entry entryFrom = dataSet.getEntryForXIndex ( low , DataSet.Rounding.DOWN ) ; + Entry entryTo = dataSet.getEntryForXIndex ( high , DataSet.Rounding.UP ) ; min = dataSet.getEntryIndex ( entryFrom ) ; max = dataSet.getEntryIndex ( entryTo ) ; diff -- git a/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/BubbleChartRenderer.java b/MPChartLib/src/main/java/com/github/mikephil/charting/renderer/BubbleChartRenderer.java index Eliminate GC-induced stuttering during animations by eliminating wasteful allocations __EoT__ I noticed that the Realtime chart demo can stutter due to many repeated and wasteful allocations in sections of code that are called in each update of the data , and it would be great to smooth out the animations and remove stuttering . I 've so far identified , verified , and tested ways to reduce the number of allocations by approximately 70 % and memory consumed by about 30 % , with an attendant improvement in animation quality through various means , such as : 1 . Eliminating the use of convenience iterations in favor of old fashioned iteration . for ( ; ; ) { } instead of for ( Object foo : inSet ) { } 2 . Caching the results of String Formatting and using those cached results when the value in the dataset has not changed 3 . Using field level references to store short-lived instances within methods and re-setting them instead of instantiating a new one eg 1 : instead of instantiating a float [ ] temp = new float [ 2 ] ; inside a method declare the float [ ] as
diff -- git a/core/src/main/java/com/afollestad/materialdialogs/DialogInit.java b/core/src/main/java/com/afollestad/materialdialogs/DialogInit.java index 5a287f2..54d737d 100644 -- - a/core/src/main/java/com/afollestad/materialdialogs/DialogInit.java +++ b/core/src/main/java/com/afollestad/materialdialogs/DialogInit.java @ @ -13,6 +13,7 @ @ import android.text.method.LinkMovementMethod ; import android.text.method.PasswordTransformationMethod ; import android.view.View ; import android.view.ViewGroup ; +import android.widget.CheckBox ; import android.widget.EditText ; import android.widget.FrameLayout ; import android.widget.ImageView ; @ @ -128,6 +129,7 @ @ class DialogInit { dialog.titleFrame = dialog.view.findViewById ( R.id.titleFrame ) ; dialog.content = ( TextView ) dialog.view.findViewById ( R.id.content ) ; dialog.listView = ( ListView ) dialog.view.findViewById ( R.id.contentListView ) ; + dialog.checkBox = ( CheckBox ) dialog.view.findViewById ( R.id.checkboxSelection ) ; // Button views initially used by checkIfStackingNeeded ( ) dialog.positiveButton = ( MDButton ) dialog.view.findViewById ( R.id.buttonDefaultPositive ) ; @ @ -231,6 +233,11 @ @ class DialogInit { textAllCaps = DialogUtils.resolveBoolean ( builder.context , R.attr.textAllCaps , true ) ; } + if ( builder.checkboxText ! = null ) { + dialog.checkBox.setText ( builder.checkboxText ) ; + dialog.view.findViewById ( R.id.checkboxSelectionRoot ) .setVisibility ( View.VISIBLE ) ; + } + MDButton positiveTextView = dialog.positiveButton ; dialog.setTypeface ( positiveTextView , builder.mediumFont ) ; positiveTextView.setAllCapsCompat ( textAllCaps ) ; diff -- git a/core/src/main/java/com/afollestad/materialdialogs/MaterialDialog.java b/core/src/main/java/com/afollestad/materialdialogs/MaterialDialog.java index f5eeabd..6c1a3eb 100644 -- - a/core/src/main/java/com/afollestad/materialdialogs/MaterialDialog.java +++ b/core/src/main/java/com/afollestad/materialdialogs/MaterialDialog.java @ @ -75,6 +75,7 @ @ public class MaterialDialog extends DialogBase implements Option to add checkbox as in system permission dialog __EoT__ Would be useful if we can have the option to add a checkbox like the one in the system permission dialog . This can be used to have options like `` Never ask again '' or `` Save this preference '' .
diff -- git a/LottieSample/screenshots/Hello_World.png b/LottieSample/screenshots/Hello_World.png index 8a240ed..d949d01 100644 Binary files a/LottieSample/screenshots/Hello_World.png and b/LottieSample/screenshots/Hello_World.png differ diff -- git a/LottieSample/screenshots/WeAccept.png b/LottieSample/screenshots/WeAccept.png index 9cb773a..da5ac42 100644 Binary files a/LottieSample/screenshots/WeAccept.png and b/LottieSample/screenshots/WeAccept.png differ diff -- git a/LottieSample/screenshots/lottiefiles.com_-_Beating_Heart.png b/LottieSample/screenshots/lottiefiles.com_-_Beating_Heart.png index 1029fcd..b0d4d9b 100644 Binary files a/LottieSample/screenshots/lottiefiles.com_-_Beating_Heart.png and b/LottieSample/screenshots/lottiefiles.com_-_Beating_Heart.png differ diff -- git a/LottieSample/screenshots/lottiefiles.com_-_Loading_3.png b/LottieSample/screenshots/lottiefiles.com_-_Loading_3.png index c42d964..2f43e00 100644 Binary files a/LottieSample/screenshots/lottiefiles.com_-_Loading_3.png and b/LottieSample/screenshots/lottiefiles.com_-_Loading_3.png differ diff -- git a/LottieSample/screenshots/lottiefiles.com_-_Retweet.png b/LottieSample/screenshots/lottiefiles.com_-_Retweet.png index 6410659..b9859dc 100644 Binary files a/LottieSample/screenshots/lottiefiles.com_-_Retweet.png and b/LottieSample/screenshots/lottiefiles.com_-_Retweet.png differ diff -- git a/lottie/src/main/java/com/airbnb/lottie/LottieComposition.java b/lottie/src/main/java/com/airbnb/lottie/LottieComposition.java index bc0b1d6..5ad8768 100644 -- - a/lottie/src/main/java/com/airbnb/lottie/LottieComposition.java +++ b/lottie/src/main/java/com/airbnb/lottie/LottieComposition.java @ @ -45,14 +45,14 @ @ public class LottieComposition { private final Rect bounds ; private final long startFrame ; private final long endFrame ; - private final int frameRate ; + private final float frameRate ; private final float dpScale ; /* Bodymovin version */ private final int majorVersion ; private final int minorVersion ; private final int patchVersion ; - private LottieComposition ( Rect bounds , long startFrame , long endFrame , int frameRate , + private LottieComposition ( Rect bounds , long startFrame , long endFrame , float frameRate , float dpScale , int major , int minor , int patch ) { this.bounds = bounds ; this.startFrame = startFrame ; @ @ -244,7 Animation timing drifts for a long animation ( 233s or more ) __EoT__ I am trying to play long animations with lottie 2.0.0-rc2 . There is a drift of 7s , so the animation ends after 240s instead of 233s . Here the json file that I use : [ lottie-drift.zip ] ( https : //github.com/airbnb/lottie-android/files/1048318/lottie-drift.zip ) I used the lottie sample , and replaced the `` WeAccept '' demo by my json file and my images . I also added some System.currentTimeMillis ( ) logs in the AnimatorListener onAnimationStart and onAnimationEnd methods to measure the drift . Note that I can reproduce the issue with other json files that are similar ( images animation , with a duration of several minutes ) . Let me know if you need more information .
diff -- git a/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieSnapshotProvider.java b/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieSnapshotProvider.java index d110ee0..585baf5 100644 -- - a/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieSnapshotProvider.java +++ b/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieSnapshotProvider.java @ @ -68,6 +68,7 @ @ public class LottieSnapshotProvider extends SnapshotProvider { onError ( e ) ; } testFrameBoundary ( ) ; + testFrameBoundary2 ( ) ; testScaleTypes ( ) ; testDynamicProperties ( ) ; } @ @ -217,6 +218,22 @ @ public class LottieSnapshotProvider extends SnapshotProvider { recordSnapshot ( animationView , 1080 , `` android '' , `` Frame Boundary '' , `` Frame 51 Green '' , params ) ; } + private void testFrameBoundary2 ( ) { + LottieAnimationView animationView = new LottieAnimationView ( context ) ; + LottieComposition composition = + LottieComposition.Factory.fromFileSync ( context , `` Tests/RGB.json '' ) ; + animationView.setComposition ( composition ) ; + ViewGroup.LayoutParams params = new ViewGroup.LayoutParams ( + ViewGroup.LayoutParams.WRAP_CONTENT , ViewGroup.LayoutParams.WRAP_CONTENT ) ; + + animationView.setFrame ( 0 ) ; + recordSnapshot ( animationView , 1080 , `` android '' , `` Frame Boundary '' , `` Frame 0 Red '' , params ) ; + animationView.setFrame ( 1 ) ; + recordSnapshot ( animationView , 1080 , `` android '' , `` Frame Boundary '' , `` Frame 1 Green '' , params ) ; + Appintro Animation start progress is not the same on different devices __EoT__ On testing my appIntro animation it works well on my Xiaomi Mi A1 Android Oreo , it starts on the expected progress which is 0.20f shown in [ this screenshot ] ( https : //drive.google.com/open ? id=1-ejQkg19QUGuD2lSytlTuOUAdHuBc0eg ) . But on testing on a Samsung Galaxy S4 Android Lollipop 5.0.1 it starts on a different Progress shown in [ this screenshot ] ( https : //drive.google.com/open ? id=1FQHHv6EEwg9ALC5jbjo3lWNnh9B09Fmo ) , I do n't know the reason for this I tried to Debug to check the progress value that the AnimationView takes on the start and it takes the correct value which is 0.20f . Here is my AppIntro Class code `` ` public class AppIntroActivity extends IntroActivity { private static final float [ ] ANIMATION_TIMES = new float [ ] { 0.20f , 0.60f , 1f , 1f } ; private LottieAnimationView animationView ; private LockableViewPager viewPager ; @ Override protected Collection < ? extends Fragment > generatePages ( Bundle savedInstanceState ) { return new ArrayList < EmptyFragment > ( ) { { add ( EmptyFragment.newInstance ( ) ) ; add ( EmptyFragment.newInstance ( ) ) ; add
diff -- git a/LottieSample/libs/happo.aar b/LottieSample/libs/happo.aar index d075332..43a9f0a 100644 Binary files a/LottieSample/libs/happo.aar and b/LottieSample/libs/happo.aar differ diff -- git a/lottie/src/main/java/com/airbnb/lottie/LottieComposition.java b/lottie/src/main/java/com/airbnb/lottie/LottieComposition.java index 97293c1..396fc3c 100644 -- - a/lottie/src/main/java/com/airbnb/lottie/LottieComposition.java +++ b/lottie/src/main/java/com/airbnb/lottie/LottieComposition.java @ @ -9,6 +9,7 @ @ import android.support.annotation.RawRes ; import android.support.annotation.RestrictTo ; import android.support.v4.util.LongSparseArray ; import android.support.v4.util.SparseArrayCompat ; +import android.util.JsonReader ; import android.util.Log ; import com.airbnb.lottie.model.FileCompositionLoader ; @ @ -18,14 +19,12 @ @ import com.airbnb.lottie.model.JsonCompositionLoader ; import com.airbnb.lottie.model.layer.Layer ; import com.airbnb.lottie.utils.Utils ; -import org.json.JSONArray ; -import org.json.JSONException ; import org.json.JSONObject ; -import java.io.BufferedReader ; import java.io.IOException ; import java.io.InputStream ; import java.io.InputStreamReader ; +import java.io.StringReader ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.HashMap ; @ @ -53,30 +52,14 @ @ public class LottieComposition { // This is stored as a set to avoid duplicates . private final HashSet < String > warnings = new HashSet < > ( ) ; private final PerformanceTracker performanceTracker = new PerformanceTracker ( ) ; - private final Rect bounds ; - private final float startFrame ; - private final float endFrame ; - private final float frameRate ; - private final float dpScale ; + private Rect bounds ; + private float startFrame ; + private float endFrame ; + private float frameRate ; /* Bodymovin OutOfMemoryError when loading a ludicrously huge JSON animation on a Galaxy S3 __EoT__ JSON is 1.5 MB uncompressed , 94 KB zipped . Lottie should probably switch from JSON to Flatbuffers . I 'll open a separate issue for that .
diff -- git a/LottieSample/src/main/AndroidManifest.xml b/LottieSample/src/main/AndroidManifest.xml index abc6318..2831dce 100644 -- - a/LottieSample/src/main/AndroidManifest.xml +++ b/LottieSample/src/main/AndroidManifest.xml @ @ -12,7 +12,9 @ @ android : supportsRtl= '' true '' android : theme= '' @ style/AppTheme '' android : name= '' com.airbnb.lottie.samples.LottieApplication '' > - < activity android : name= '' com.airbnb.lottie.samples.MainActivity '' > + < activity + android : name= '' com.airbnb.lottie.samples.MainActivity '' + android : screenOrientation= '' portrait '' > < intent-filter > < action android : name= '' android.intent.action.MAIN '' / > @ @ -22,10 +24,12 @ @ < activity android : name= '' com.airbnb.lottie.samples.FontActivity '' - android : windowSoftInputMode= '' stateVisible '' / > + android : windowSoftInputMode= '' stateVisible '' + android : screenOrientation= '' portrait '' / > < activity - android : name= '' com.airbnb.lottie.samples.AppIntroActivity '' / > + android : name= '' com.airbnb.lottie.samples.AppIntroActivity '' + android : screenOrientation= '' portrait '' / > < /application > - < /manifest > \ No newline at end of file + < /manifest > Letters disappears on changing the screen orientation in FontActivity of Sample App __EoT__ Currently when the screen orientation is changed then the letters written disappears . Expected that letters should not disappears on changing the orientation . : )
diff -- git a/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieTest.java b/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieTest.java index 4fead43..a7ed1ad 100644 -- - a/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieTest.java +++ b/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieTest.java @ @ -22,34 +22,35 @ @ public class LottieTest { MainActivity.class ) ; @ Test public void testAll ( ) { - TestRobot.testAnimation ( activityRule.getActivity ( ) , `` 9squares-AlBoardman.json '' ) ; - TestRobot.testAnimation ( activityRule.getActivity ( ) , `` EmptyState.json '' ) ; - TestRobot.testAnimation ( activityRule.getActivity ( ) , `` HamburgerArrow.json '' ) ; - TestRobot.testAnimation ( activityRule.getActivity ( ) , `` LottieLogo1.json '' ) ; - TestRobot.testAnimation ( activityRule.getActivity ( ) , `` LottieLogo2.json '' ) ; - TestRobot.testAnimation ( activityRule.getActivity ( ) , `` MotionCorpse-Jrcanest.json '' ) ; - TestRobot.testAnimation ( activityRule.getActivity ( ) , `` PinJump.json '' ) ; - TestRobot.testAnimation ( activityRule.getActivity ( ) , `` TwitterHeart.json '' ) ; - TestRobot.testAnimation ( activityRule.getActivity ( ) , `` Tests/Hosts.json '' ) ; - TestRobot.testAnimation ( activityRule.getActivity ( ) , `` Tests/LightBulb.json '' , null , + MainActivity activity = activityRule.getActivity ( ) ; + TestRobot.testAnimation ( activity , `` 9squares-AlBoardman.json '' ) ; + TestRobot.testAnimation ( activity , `` EmptyState.json '' ) ; + TestRobot.testAnimation ( activity , `` HamburgerArrow.json '' ) ; + TestRobot.testAnimation ( activity , `` LottieLogo1.json Create a pluggable JSON parsing module __EoT__ Ideally there would be 2 ( or n ) optional json parsing modules . 1 would use raw json objects so there would be no transitive dependencies The other would use jackson or another more performant json parsing library .
diff -- git a/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieSnapshotProvider.java b/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieSnapshotProvider.java index d110ee0..585baf5 100644 -- - a/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieSnapshotProvider.java +++ b/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieSnapshotProvider.java @ @ -68,6 +68,7 @ @ public class LottieSnapshotProvider extends SnapshotProvider { onError ( e ) ; } testFrameBoundary ( ) ; + testFrameBoundary2 ( ) ; testScaleTypes ( ) ; testDynamicProperties ( ) ; } @ @ -217,6 +218,22 @ @ public class LottieSnapshotProvider extends SnapshotProvider { recordSnapshot ( animationView , 1080 , `` android '' , `` Frame Boundary '' , `` Frame 51 Green '' , params ) ; } + private void testFrameBoundary2 ( ) { + LottieAnimationView animationView = new LottieAnimationView ( context ) ; + LottieComposition composition = + LottieComposition.Factory.fromFileSync ( context , `` Tests/RGB.json '' ) ; + animationView.setComposition ( composition ) ; + ViewGroup.LayoutParams params = new ViewGroup.LayoutParams ( + ViewGroup.LayoutParams.WRAP_CONTENT , ViewGroup.LayoutParams.WRAP_CONTENT ) ; + + animationView.setFrame ( 0 ) ; + recordSnapshot ( animationView , 1080 , `` android '' , `` Frame Boundary '' , `` Frame 0 Red '' , params ) ; + animationView.setFrame ( 1 ) ; + recordSnapshot ( animationView , 1080 , `` android '' , `` Frame Boundary '' , `` Frame 1 Green '' , params ) ; + setProgress going to wrong frame when startFrame > 0 __EoT__ This is happening after # 624. https : //github.com/airbnb/lottie-android/blob/05df617dc2c1656b0db2dc5f24f2bde0eb4c2c8c/lottie/src/main/java/com/airbnb/lottie/LottieDrawable.java # L514is not considering the startFrame .
diff -- git a/LottieSample/screenshots/Tests_Laugh4.png b/LottieSample/screenshots/Tests_Laugh4.png index 34eb7f0..a163cbe 100644 Binary files a/LottieSample/screenshots/Tests_Laugh4.png and b/LottieSample/screenshots/Tests_Laugh4.png differ diff -- git a/LottieSample/screenshots/lottiefiles.com_-_ATM.png b/LottieSample/screenshots/lottiefiles.com_-_ATM.png index ac83a07..a9a1cca 100644 Binary files a/LottieSample/screenshots/lottiefiles.com_-_ATM.png and b/LottieSample/screenshots/lottiefiles.com_-_ATM.png differ diff -- git a/LottieSample/screenshots/lottiefiles.com_-_Emoji_Shock.png b/LottieSample/screenshots/lottiefiles.com_-_Emoji_Shock.png index 9727c87..aa14578 100644 Binary files a/LottieSample/screenshots/lottiefiles.com_-_Emoji_Shock.png and b/LottieSample/screenshots/lottiefiles.com_-_Emoji_Shock.png differ diff -- git a/LottieSample/screenshots/lottiefiles.com_-_Emoji_Tongue.png b/LottieSample/screenshots/lottiefiles.com_-_Emoji_Tongue.png index 83b3e60..b5ee9b8 100644 Binary files a/LottieSample/screenshots/lottiefiles.com_-_Emoji_Tongue.png and b/LottieSample/screenshots/lottiefiles.com_-_Emoji_Tongue.png differ diff -- git a/lottie/src/main/java/com/airbnb/lottie/BaseLayer.java b/lottie/src/main/java/com/airbnb/lottie/BaseLayer.java index 1ef2438..da1cb15 100644 -- - a/lottie/src/main/java/com/airbnb/lottie/BaseLayer.java +++ b/lottie/src/main/java/com/airbnb/lottie/BaseLayer.java @ @ -49,6 +49,8 @ @ abstract class BaseLayer implements DrawingContent , BaseKeyframeAnimation.Animat private final Paint mattePaint = new Paint ( Paint.ANTI_ALIAS_FLAG ) ; private final Paint clearPaint = new Paint ( ) ; private final RectF rect = new RectF ( ) ; + private final RectF maskBoundsRect = new RectF ( ) ; + private final RectF tempMaskBoundsRect = new RectF ( ) ; final LottieDrawable lottieDrawable ; final Layer layerModel ; @ Nullable private MaskKeyframeAnimation mask ; @ @ -151,11 +153,21 @ @ abstract class BaseLayer implements DrawingContent , BaseKeyframeAnimation.Animat return ; } - // TODO : make sure this is the right clip . - rect.set ( canvas.getClipBounds ( ) ) ; + rect.set ( 0 , 0 , 0 , 0 ) ; + getBounds ( Improve the performance of mattes and masks __EoT__ This seems to be an issue that 's relegated to Android playback of JSON files that is n't reproducible on iOS . When using track mattes from After Effects , frame rates just plummet . Not sure what exactly is going on , but wondering if anybody else has seen same issues .
diff -- git a/LottieSample/screenshots/MotionCorpse-Jrcanest.png b/LottieSample/screenshots/MotionCorpse-Jrcanest.png index b06ae66..8075e8b 100644 Binary files a/LottieSample/screenshots/MotionCorpse-Jrcanest.png and b/LottieSample/screenshots/MotionCorpse-Jrcanest.png differ diff -- git a/LottieSample/screenshots/Tests_Laugh4.png b/LottieSample/screenshots/Tests_Laugh4.png index 34eb7f0..7493c26 100644 Binary files a/LottieSample/screenshots/Tests_Laugh4.png and b/LottieSample/screenshots/Tests_Laugh4.png differ diff -- git a/LottieSample/screenshots/Tests_Precomps.png b/LottieSample/screenshots/Tests_Precomps.png index 530fb60..f9f8dc0 100644 Binary files a/LottieSample/screenshots/Tests_Precomps.png and b/LottieSample/screenshots/Tests_Precomps.png differ diff -- git a/LottieSample/screenshots/lottiefiles.com_-_ATM.png b/LottieSample/screenshots/lottiefiles.com_-_ATM.png index ac83a07..57586f4 100644 Binary files a/LottieSample/screenshots/lottiefiles.com_-_ATM.png and b/LottieSample/screenshots/lottiefiles.com_-_ATM.png differ diff -- git a/LottieSample/screenshots/lottiefiles.com_-_Emoji_Shock.png b/LottieSample/screenshots/lottiefiles.com_-_Emoji_Shock.png index 9727c87..151e03e 100644 Binary files a/LottieSample/screenshots/lottiefiles.com_-_Emoji_Shock.png and b/LottieSample/screenshots/lottiefiles.com_-_Emoji_Shock.png differ diff -- git a/LottieSample/screenshots/lottiefiles.com_-_Emoji_Tongue.png b/LottieSample/screenshots/lottiefiles.com_-_Emoji_Tongue.png index 83b3e60..26d87ae 100644 Binary files a/LottieSample/screenshots/lottiefiles.com_-_Emoji_Tongue.png and b/LottieSample/screenshots/lottiefiles.com_-_Emoji_Tongue.png differ diff -- git a/LottieSample/screenshots/lottiefiles.com_-_Loading_2.png b/LottieSample/screenshots/lottiefiles.com_-_Loading_2.png index 668c5e4..9b38ffa 100644 Binary files a/LottieSample/screenshots/lottiefiles.com_-_Loading_2.png and b/LottieSample/screenshots/lottiefiles.com_-_Loading_2.png differ diff -- git a/LottieSample/screenshots/lottiefiles.com_-_Tadah_Image.png b/LottieSample/screenshots/lottiefiles.com_-_Tadah_Image.png index d910691..407d74e 100644 Binary files a/LottieSample/screenshots/lottiefiles.com_-_Tadah_Image.png and b/LottieSample/screenshots/lottiefiles.com_-_Tadah_Image.png differ diff -- git a/LottieSample/src/main/res/layout/fragment_list.xml b/LottieSample/src/main/res/layout/fragment_list.xml index b34560c..a4b425b 100644 -- - a/LottieSample/src/main/res/layout/fragment_list.xml +++ b/LottieSample/src/main/res/layout/fragment_list.xml @ @ -16,7 +16,7 @ @ android : layout_width= '' wrap_content '' android : layout_height= '' wrap_content '' android : layout_gravity= '' center '' - app : lottie_fileName= '' Logo/LogoSmall.json '' + app : lottie_fileName= '' TrackMattes.json '' app : lottie_loop= '' true '' / > < /FrameLayout > diff -- git a/lottie/src/main/java/com/airbnb/lottie/BaseLayer.java b/lottie/src/main/java/com/airbnb/lottie/BaseLayer.java index 1ef2438..21fe453 100644 -- - a/lottie/src/main/java/com/airbnb/lottie/BaseLayer.java +++ b/lottie/src/main/java/com/airbnb/lottie/BaseLayer.java @ @ -7,6 +7,7 @ @ import android.graphics.Path ; import android.graphics.PorterDuff ; import Improve the performance of mattes and masks __EoT__ This seems to be an issue that 's relegated to Android playback of JSON files that is n't reproducible on iOS . When using track mattes from After Effects , frame rates just plummet . Not sure what exactly is going on , but wondering if anybody else has seen same issues .
diff -- git a/LottieSample/screenshots/HamburgerArrow 0.png b/LottieSample/screenshots/HamburgerArrow 0.png index c1afe0f..db8d0bb 100644 Binary files a/LottieSample/screenshots/HamburgerArrow 0.png and b/LottieSample/screenshots/HamburgerArrow 0.png differ diff -- git a/LottieSample/screenshots/HamburgerArrow 10.png b/LottieSample/screenshots/HamburgerArrow 10.png index c1afe0f..db8d0bb 100644 Binary files a/LottieSample/screenshots/HamburgerArrow 10.png and b/LottieSample/screenshots/HamburgerArrow 10.png differ diff -- git a/LottieSample/screenshots/HamburgerArrow 100.png b/LottieSample/screenshots/HamburgerArrow 100.png index b4d7d6e..db8d0bb 100644 Binary files a/LottieSample/screenshots/HamburgerArrow 100.png and b/LottieSample/screenshots/HamburgerArrow 100.png differ diff -- git a/LottieSample/screenshots/HamburgerArrow 20.png b/LottieSample/screenshots/HamburgerArrow 20.png index 696105b..e2e9d24 100644 Binary files a/LottieSample/screenshots/HamburgerArrow 20.png and b/LottieSample/screenshots/HamburgerArrow 20.png differ diff -- git a/LottieSample/screenshots/HamburgerArrow 30.png b/LottieSample/screenshots/HamburgerArrow 30.png index a79d616..ade67c9 100644 Binary files a/LottieSample/screenshots/HamburgerArrow 30.png and b/LottieSample/screenshots/HamburgerArrow 30.png differ diff -- git a/LottieSample/screenshots/HamburgerArrow 40.png b/LottieSample/screenshots/HamburgerArrow 40.png index 89f0ab3..25f19ec 100644 Binary files a/LottieSample/screenshots/HamburgerArrow 40.png and b/LottieSample/screenshots/HamburgerArrow 40.png differ diff -- git a/LottieSample/screenshots/HamburgerArrow 5.png b/LottieSample/screenshots/HamburgerArrow 5.png index c1afe0f..db8d0bb 100644 Binary files a/LottieSample/screenshots/HamburgerArrow 5.png and b/LottieSample/screenshots/HamburgerArrow 5.png differ diff -- git a/LottieSample/screenshots/HamburgerArrow 50.png b/LottieSample/screenshots/HamburgerArrow 50.png index 89f0ab3..25f19ec 100644 Binary files a/LottieSample/screenshots/HamburgerArrow 50.png and b/LottieSample/screenshots/HamburgerArrow 50.png differ diff -- git a/LottieSample/screenshots/HamburgerArrow 60.png b/LottieSample/screenshots/HamburgerArrow 60.png index 89f0ab3..25f19ec 100644 Binary files a/LottieSample/screenshots/HamburgerArrow 60.png and b/LottieSample/screenshots/HamburgerArrow 60.png differ diff -- git a/LottieSample/screenshots/HamburgerArrow 70.png b/LottieSample/screenshots/HamburgerArrow 70.png index d435481..71eb826 100644 Binary files a/LottieSample/screenshots/HamburgerArrow 70.png and b/LottieSample/screenshots/HamburgerArrow 70.png differ diff -- git a/LottieSample/screenshots/HamburgerArrow 80.png b/LottieSample/screenshots/HamburgerArrow 80.png index b4d7d6e..db8d0bb 100644 Binary files a/LottieSample/screenshots/HamburgerArrow 80.png and b/LottieSample/screenshots/HamburgerArrow 80.png differ diff -- Animation max size __EoT__ I have animation with following spec : `` ` `` v '' : `` 4.5.6 '' , `` fr '' : 25 , `` ip '' : 0 , `` op '' : 38 , `` w '' : 360 , `` h '' : 146 , `` ddd '' : 0 , ... ... . `` ` I want to achieve behavior when animation view fits on screen width . If i set to LottieAnimationView layout_width= '' match_parent '' and layout_height= '' wrap_content '' i faced with following issue on phones : if phone 's width is 1440px ( samsung s7 ) , animation viewport width is 1000px because of LottieComposition MAX_PIXELS = 1000 constraint . So i got space between animation and screen edge . I solved this issue by dynamically changing view height to proper value : `` ` DisplayMetrics displayMetrics = getResources ( ) .getDisplayMetrics ( ) ; float dpWidth = displayMetrics.widthPixels / displayMetrics.density ; float dpHeight = displayMetrics.heightPixels / displayMetrics.density ; mLottieAnimationView.getLayoutParams ( ) .height = ( int ) ( displayMetrics.density * 146f / ( 360f / dpWidth ) ) ; `` ` After applying new height on view , animation
diff -- git a/lottie/src/main/java/com/airbnb/lottie/BaseKeyframeAnimation.java b/lottie/src/main/java/com/airbnb/lottie/BaseKeyframeAnimation.java index 1391c88..8b153af 100644 -- - a/lottie/src/main/java/com/airbnb/lottie/BaseKeyframeAnimation.java +++ b/lottie/src/main/java/com/airbnb/lottie/BaseKeyframeAnimation.java @ @ -18,7 +18,6 @ @ abstract class BaseKeyframeAnimation < K , A > { // This is not a Set because we do n't want to create an iterator object on every setProgress . final List < AnimationListener > listeners = new ArrayList < > ( ) ; private boolean isDiscrete = false ; - @ Nullable private A previousValue ; private final List < ? extends Keyframe < K > > keyframes ; private float progress = 0f ; @ @ -49,12 +48,8 @ @ abstract class BaseKeyframeAnimation < K , A > { } this.progress = progress ; - A value = getValue ( ) ; - if ( previousValue == null || ! previousValue.equals ( value ) ) { - previousValue = value ; - for ( int i = 0 ; i < listeners.size ( ) ; i++ ) { - listeners.get ( i ) .onValueChanged ( ) ; - } + for ( int i = 0 ; i < listeners.size ( ) ; i++ ) { + listeners.get ( i ) .onValueChanged ( ) ; } } diff -- git Improve the keyframe value caching __EoT__ https : //github.com/airbnb/lottie-android/commit/d5f141dbbe6c7e1ab90e7ca94bb0b38af561fec5 does n't work . Investigate .
diff -- git a/LottieSample/screenshots/Name.png b/LottieSample/screenshots/Name.png new file mode 100644 index 0000000..d7b388b Binary files /dev/null and b/LottieSample/screenshots/Name.png differ diff -- git a/LottieSample/src/androidTest/java/com/airbnb/lottie/AnimationLinearLayout.java b/LottieSample/src/androidTest/java/com/airbnb/lottie/AnimationLinearLayout.java index b47e810..fdadf6e 100644 -- - a/LottieSample/src/androidTest/java/com/airbnb/lottie/AnimationLinearLayout.java +++ b/LottieSample/src/androidTest/java/com/airbnb/lottie/AnimationLinearLayout.java @ @ -50,6 +50,16 @ @ public class AnimationLinearLayout extends LinearLayout { } } + void setTextDelegate ( TextDelegate textDelegate ) { + for ( int i = getChildCount ( ) - 1 ; i > = 0 ; i -- ) { + View child = getChildAt ( i ) ; + if ( ! ( child instanceof LottieAnimationView ) ) { + continue ; + } + ( ( LottieAnimationView ) child ) .setTextDelegate ( textDelegate ) ; + } + } + void setComposition ( LottieComposition composition ) { for ( int i = getChildCount ( ) - 1 ; i > = 0 ; i -- ) { View child = getChildAt ( i ) ; diff -- git a/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieTest.java b/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieTest.java index 7dca687..11b1d31 100644 -- - a/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieTest.java +++ b/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieTest.java @ @ -36,7 +36,10 @ @ public class LottieTest { TestRobot.testLinearAnimation ( activity , `` PinJump.json '' ) ; TestRobot.testLinearAnimation ( activity , `` TwitterHeart.json '' ) ; TestRobot.testLinearAnimation ( activity , `` Hello World.json '' ) Improve the keyframe value caching __EoT__ https : //github.com/airbnb/lottie-android/commit/d5f141dbbe6c7e1ab90e7ca94bb0b38af561fec5 does n't work . Investigate .
diff -- git a/lottie/src/main/java/com/airbnb/lottie/LottieAnimationView.java b/lottie/src/main/java/com/airbnb/lottie/LottieAnimationView.java index a007ab3..9f2e355 100644 -- - a/lottie/src/main/java/com/airbnb/lottie/LottieAnimationView.java +++ b/lottie/src/main/java/com/airbnb/lottie/LottieAnimationView.java @ @ -337,7 +337,7 @ @ import java.util.Map ; } this.animationName = animationName ; - lottieDrawable.cancelAnimation ( ) ; + lottieDrawable.clearComposition ( ) ; cancelLoaderTask ( ) ; compositionLoader = LottieComposition.Factory.fromAssetFileName ( getContext ( ) , animationName , new OnCompositionLoadedListener ( ) { @ @ -415,88 +415,119 @ @ import java.util.Map ; return lottieDrawable.hasMatte ( ) ; } - public void addAnimatorUpdateListener ( ValueAnimator.AnimatorUpdateListener updateListener ) { - lottieDrawable.addAnimatorUpdateListener ( updateListener ) ; - } - - public void removeUpdateListener ( ValueAnimator.AnimatorUpdateListener updateListener ) { - lottieDrawable.removeAnimatorUpdateListener ( updateListener ) ; - } - - public void addAnimatorListener ( Animator.AnimatorListener listener ) { - lottieDrawable.addAnimatorListener ( listener ) ; - } - - public void removeAnimatorListener ( Animator.AnimatorListener listener ) { - lottieDrawable.removeAnimatorListener ( listener ) ; - } - - public void loop ( boolean loop ) { - lottieDrawable.loop ( loop ) ; - } - - public boolean isAnimating ( ) { - return lottieDrawable.isAnimating ( ) ; - } - + /** + * Plays the animation from the beginning . If speed is < 0 , it will start at the end Animation not being chained properly since 2.2.2 __EoT__ On every version since 2.2.2 included , I see my animations not being chained properly . Here is a gif of the chained animation working on 2.2.1 ( see the little robot at the bottom of the screen ) : ! [ good ] ( https : //user-images.githubusercontent.com/14746791/31183410-ca5e0e7e-a926-11e7-9d1f-cc5824d8e396.gif ) it is made of 2 compositions that are chained following user 's actions : ( 1 ) - > When the user scroll away from the top of the RecyclerView : the robot scales down and goes gray ( 2 ) - > When the user scrolls back to top of the RecyclerView : the robot scales up and goes colorful ( 3 ) - > When user clicks on the robot : the robot 's helmet smoothly transition from a face to a cross The logic of chaining the animation goes like this : - Whenever the user enter a different state ( scrolled away from the top , clicked the robot ... ) : - If no animation are running , I launch an animation to go to that state - Else , I save the different state - At the
diff -- git a/LottieSample/screenshots/300x300 @ 2x.png b/LottieSample/screenshots/300x300 @ 2x.png new file mode 100644 index 0000000..b6b8491 Binary files /dev/null and b/LottieSample/screenshots/300x300 @ 2x.png differ diff -- git a/LottieSample/screenshots/300x300 @ 4x.png b/LottieSample/screenshots/300x300 @ 4x.png new file mode 100644 index 0000000..b6b8491 Binary files /dev/null and b/LottieSample/screenshots/300x300 @ 4x.png differ diff -- git a/LottieSample/screenshots/300x300 centerCrop @ 2x.png b/LottieSample/screenshots/300x300 centerCrop @ 2x.png new file mode 100644 index 0000000..8f8b4aa Binary files /dev/null and b/LottieSample/screenshots/300x300 centerCrop @ 2x.png differ diff -- git a/LottieSample/screenshots/300x300 centerCrop.png b/LottieSample/screenshots/300x300 centerCrop.png new file mode 100644 index 0000000..b2e8312 Binary files /dev/null and b/LottieSample/screenshots/300x300 centerCrop.png differ diff -- git a/LottieSample/screenshots/300x300 centerInside @ 2x.png b/LottieSample/screenshots/300x300 centerInside @ 2x.png new file mode 100644 index 0000000..2ae31d5 Binary files /dev/null and b/LottieSample/screenshots/300x300 centerInside @ 2x.png differ diff -- git a/LottieSample/screenshots/300x300 centerInside.png b/LottieSample/screenshots/300x300 centerInside.png new file mode 100644 index 0000000..2ae31d5 Binary files /dev/null and b/LottieSample/screenshots/300x300 centerInside.png differ diff -- git a/LottieSample/screenshots/300x600 centerInside.png b/LottieSample/screenshots/300x600 centerInside.png new file mode 100644 index 0000000..fbd7de3 Binary files /dev/null and b/LottieSample/screenshots/300x600 centerInside.png differ diff -- git a/LottieSample/screenshots/600x300 centerInside.png b/LottieSample/screenshots/600x300 centerInside.png new file mode 100644 index 0000000..f3cdbbd Binary files /dev/null and b/LottieSample/screenshots/600x300 centerInside.png differ diff -- git a/LottieSample/screenshots/LottieLogo1.png b/LottieSample/screenshots/LottieLogo1.png index c84c99c..7b535d5 100644 Binary files a/LottieSample/screenshots/LottieLogo1.png and b/LottieSample/screenshots/LottieLogo1.png differ diff -- git a/LottieSample/screenshots/LottieLogo2.png b/LottieSample/screenshots/LottieLogo2.png index e1c77bf..7518334 100644 Scaling Issues with Matte Layer __EoT__ It seems that the presence of a matte layer causes incorrect scaling . There was an issue with this in release 2.1.0 and now there seems to be a different issue in 2.1.2 . The attached zip contains a document and JSON that describe the behavior . [ Android Scaling Issues With Matte Layer.zip ] ( https : //github.com/airbnb/lottie-android/files/1192946/Android.Scaling.Issues.With.Matte.Layer.zip )
diff -- git a/LottieSample/src/main/kotlin/com/airbnb/lottie/samples/PlayerFragment.kt b/LottieSample/src/main/kotlin/com/airbnb/lottie/samples/PlayerFragment.kt index f3b0301..314fd9a 100644 -- - a/LottieSample/src/main/kotlin/com/airbnb/lottie/samples/PlayerFragment.kt +++ b/LottieSample/src/main/kotlin/com/airbnb/lottie/samples/PlayerFragment.kt @ @ -363,6 +363,7 @ @ class PlayerFragment : Fragment ( ) { warningsContainer.removeAllViews ( ) updateWarnings ( ) + // Scale up to fill the screen scaleSeekBar.progress = 100 } diff -- git a/lottie/src/main/java/com/airbnb/lottie/utils/LottieValueAnimator.java b/lottie/src/main/java/com/airbnb/lottie/utils/LottieValueAnimator.java index ecaf1c4..dcee48a 100644 -- - a/lottie/src/main/java/com/airbnb/lottie/utils/LottieValueAnimator.java +++ b/lottie/src/main/java/com/airbnb/lottie/utils/LottieValueAnimator.java @ @ -16,7 +16,7 @ @ public class LottieValueAnimator extends BaseLottieAnimator implements Choreogra private float speed = 1f ; - private long frameTime = 0 ; + private long lastFrameTimeNs = 0 ; private float frame = 0 ; private int repeatCount = 0 ; private float minFrame = Integer.MIN_VALUE ; @ @ -81,19 +81,15 @ @ public class LottieValueAnimator extends BaseLottieAnimator implements Choreogra } long now = System.nanoTime ( ) ; - long timeSinceFrame = now - frameTime ; + long timeSinceFrame = now - lastFrameTimeNs ; float frameDuration = getFrameDurationNs ( ) ; - float frames = timeSinceFrame / frameDuration ; - int wholeFrames = ( int ) frames ; - if ( wholeFrames == 0 ) { - return ; - } - frame += isReversed ( ) ? -wholeFrames : wholeFrames ; + float dFrames = timeSinceFrame / frameDuration Frame Drop __EoT__ @ gpeal My animations are dropped frame . Currently I have an onboarding screen in which it has four 4 , each with an animation . *Pixel 1 - Android Oreo *Lottie 2.5.0 [ raw.zip.zip ] ( https : //github.com/airbnb/lottie-android/files/1749837/raw.zip.zip )
diff -- git a/lotte/build.gradle b/lotte/build.gradle index 8eac2d2..8a6a451 100644 -- - a/lotte/build.gradle +++ b/lotte/build.gradle @ @ -2,7 +2,7 @ @ apply plugin : 'com.android.library' android { compileSdkVersion 24 - buildToolsVersion `` 24.0.1 '' + buildToolsVersion `` 24.0.3 '' defaultConfig { minSdkVersion 16 @ @ -26,7 +26,7 @ @ dependencies { androidTestCompile ( 'com.android.support.test.espresso : espresso-core:2.2.2 ' , { exclude group : 'com.android.support ' , module : 'support-annotations' } ) - compile 'com.android.support : appcompat-v7:24.1.1' + compile 'com.android.support : appcompat-v7:24.2.1' testCompile 'junit : junit:4.12' testCompile `` org.robolectric : robolectric:3.1.2 '' } When I used the version of 2.2.5.I could n't get the com.android.support : appcompat-v7:26.1.0 ? __EoT__ Error : Failed to resolve : com.android.support : appcompat-v7:26.1.0 Install Repository and sync project
diff -- git a/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieSnapshotProvider.java b/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieSnapshotProvider.java index d110ee0..585baf5 100644 -- - a/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieSnapshotProvider.java +++ b/LottieSample/src/androidTest/java/com/airbnb/lottie/LottieSnapshotProvider.java @ @ -68,6 +68,7 @ @ public class LottieSnapshotProvider extends SnapshotProvider { onError ( e ) ; } testFrameBoundary ( ) ; + testFrameBoundary2 ( ) ; testScaleTypes ( ) ; testDynamicProperties ( ) ; } @ @ -217,6 +218,22 @ @ public class LottieSnapshotProvider extends SnapshotProvider { recordSnapshot ( animationView , 1080 , `` android '' , `` Frame Boundary '' , `` Frame 51 Green '' , params ) ; } + private void testFrameBoundary2 ( ) { + LottieAnimationView animationView = new LottieAnimationView ( context ) ; + LottieComposition composition = + LottieComposition.Factory.fromFileSync ( context , `` Tests/RGB.json '' ) ; + animationView.setComposition ( composition ) ; + ViewGroup.LayoutParams params = new ViewGroup.LayoutParams ( + ViewGroup.LayoutParams.WRAP_CONTENT , ViewGroup.LayoutParams.WRAP_CONTENT ) ; + + animationView.setFrame ( 0 ) ; + recordSnapshot ( animationView , 1080 , `` android '' , `` Frame Boundary '' , `` Frame 0 Red '' , params ) ; + animationView.setFrame ( 1 ) ; + recordSnapshot ( animationView , 1080 , `` android '' , `` Frame Boundary '' , `` Frame 1 Green '' , params ) ; + setMinAndMaxFrame may be off by one frame for the min value __EoT__ i found that when i had to update the ` playAnimation ` call - previously we could pass a frame range , now to effect the same i needed to ` setMinAndMaxFrame ` before calling ` playAnimation ` , here i note that i was needing to add +1 to the min frame value . could this also need the same fix you had implemented for set/get frames ? Thanks , Shyam
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g3d/Model.java b/gdx/src/com/badlogic/gdx/graphics/g3d/Model.java index 1aedee9..6c0e116 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g3d/Model.java +++ b/gdx/src/com/badlogic/gdx/graphics/g3d/Model.java @ @ -255,7 +255,6 @ @ public class Model implements Disposable { ObjectMap < String , Texture > textures = new ObjectMap < String , Texture > ( ) ; - // FIXME uvScaling/uvTranslation totally ignored if ( mtl.textures ! = null ) { for ( ModelTexture tex : mtl.textures ) { Texture texture ; @ @ -274,16 +273,28 @ @ public class Model implements Disposable { descriptor.vWrap = texture.getVWrap ( ) ; switch ( tex.usage ) { case ModelTexture.USAGE_DIFFUSE : - result.set ( new TextureAttribute ( TextureAttribute.Diffuse , descriptor ) ) ; + result.set ( new TextureAttribute ( TextureAttribute.Diffuse , descriptor , tex.uvTranslation , tex.uvScaling ) ) ; break ; case ModelTexture.USAGE_SPECULAR : - result.set ( new TextureAttribute ( TextureAttribute.Specular , descriptor ) ) ; + result.set ( new TextureAttribute ( TextureAttribute.Specular , descriptor , tex.uvTranslation , tex.uvScaling ) ) ; break ; case ModelTexture.USAGE_BUMP : - result.set ( new TextureAttribute ( TextureAttribute.Bump , descriptor ) ) ; + result.set ( new TextureAttribute ( TextureAttribute.Bump , descriptor , tex.uvTranslation , tex.uvScaling ) ) ; break ; case ModelTexture.USAGE_NORMAL : - result.set ( new TextureAttribute ( TextureAttribute.Normal Backspace in iOS with non-continuous rendering issue . __EoT__ Sort of specific , but I suppose it is a bug . This only happens on iOS with **Gdx.graphics.setContinuousRendering ( false ) ** . Typing in a TextField works , but backspace does n't **appear** to change the text ( no rendering occurs I suppose ) until the user goes to type something , which at that point the TextField refreshes to show what was backspaced . This can be re-created easily with the TextAreaTest , just set it to non-continuous rendering . As a gag , I extended the TextField class with this code : `` ` @ Override protected InputListener createInputListener ( ) { return new TextFieldClickListener ( ) { @ Override public boolean keyTyped ( InputEvent event , char character ) { if ( super.keyTyped ( event , character ) == true ) { Gdx.graphics.requestRendering ( ) ; return true ; } return false ; } } ; } `` ` It does fix the issue , but it 's obviously a bit hacky .
diff -- git a/extensions/gdx-tools/src/com/badlogic/gdx/tools/hiero/unicodefont/Glyph.java b/extensions/gdx-tools/src/com/badlogic/gdx/tools/hiero/unicodefont/Glyph.java index 6007d1a..ae54295 100644 -- - a/extensions/gdx-tools/src/com/badlogic/gdx/tools/hiero/unicodefont/Glyph.java +++ b/extensions/gdx-tools/src/com/badlogic/gdx/tools/hiero/unicodefont/Glyph.java @ @ -80,8 +80,8 @ @ public class Glyph { char [ ] chars = Character.toChars ( codePoint ) ; GlyphVector charVector = unicodeFont.getFont ( ) .layoutGlyphVector ( GlyphPage.renderContext , chars , 0 , chars.length , Font.LAYOUT_LEFT_TO_RIGHT ) ; - GlyphMetrics charMetrics = vector.getGlyphMetrics ( 0 ) ; - xOffset = vector.getGlyphPixelBounds ( 0 , GlyphPage.renderContext , 0 , 0 ) .x - unicodeFont.getPaddingLeft ( ) ; + GlyphMetrics charMetrics = charVector.getGlyphMetrics ( 0 ) ; + xOffset = charVector.getGlyphPixelBounds ( 0 , GlyphPage.renderContext , 0 , 0 ) .x - unicodeFont.getPaddingLeft ( ) ; xAdvance = ( int ) ( metrics.getAdvanceX ( ) + unicodeFont.getPaddingAdvanceX ( ) + unicodeFont.getPaddingLeft ( ) + unicodeFont.getPaddingRight ( ) ) ; Distance Field Font renders certain characters with improper padding __EoT__ # # # # Issue details When rendering text on screen using Distance Field Fonts as described in the tutorial , some letters have the wrong padding . I tried this with multiple fonts and they all had this problem . The last one I tried was Arial Black with the same settings in Hiero as described in this tutorial : [ https : //github.com/libgdx/libgdx/wiki/Distance-field-fonts ] ( https : //github.com/libgdx/libgdx/wiki/Distance-field-fonts ) I noticed the problem always seemed to be with the same letters , like with the letter 'j ' in this case ! [ 6e03375d772b45e243484ccb470a10e2 ] ( https : //cloud.githubusercontent.com/assets/15983269/15627771/4e6147c8-24f7-11e6-9ce0-957ba645e51f.png ) As you can see , the first 'i ' after the 'j ' is too close . I tried this again with another font ( `` Roboto '' ) and it still had the same problem with the same settings . Note that this problem persisted regardless of my settings or my font . ! [ 524f56d475893268c3385e2572cda93e ] ( https : //cloud.githubusercontent.com/assets/15983269/15627781/aa5fc77a-24f7-11e6-9c91-fba943575bd5.png ) # # # # Reproduction steps/code Here is the code I used . This code was compiled using IntelliJ and Gradle , with LibGDX version
diff -- git a/backends/gdx-backend-headless/src/com/badlogic/gdx/backends/headless/mock/audio/MockMusic.java b/backends/gdx-backend-headless/src/com/badlogic/gdx/backends/headless/mock/audio/MockMusic.java index 27d2ee8..34693b3 100644 -- - a/backends/gdx-backend-headless/src/com/badlogic/gdx/backends/headless/mock/audio/MockMusic.java +++ b/backends/gdx-backend-headless/src/com/badlogic/gdx/backends/headless/mock/audio/MockMusic.java @ @ -66,6 +66,11 @ @ public class MockMusic implements Music { public void setPan ( float pan , float volume ) { } + + @ Override + public void setPosition ( float position ) { + + } @ Override public float getPosition ( ) { diff -- git a/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/LwjglGraphics.java b/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/LwjglGraphics.java index 985bc76..333631c 100644 -- - a/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/LwjglGraphics.java +++ b/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/LwjglGraphics.java @ @ -434,8 +434,23 @ @ public class LwjglGraphics implements Graphics { } @ Override - public boolean supportsExtension ( String extension ) { - if ( extensions == null ) extensions = gl20.glGetString ( GL20.GL_EXTENSIONS ) ; + public boolean supportsExtension ( String extension ) { + if ( extensions == null ) { + if ( gl30 ! = null ) { + //old style glGetString ( GL_EXTENSIONS ) is not valid in 3.2 core : + StringBuilder extensionsBuilder = new StringBuilder ( ) ; + + int numExtensions = GL11.glGetInteger ( GL30.GL_NUM_EXTENSIONS ) ; + for ( int i = 0 ; i < numExtensions ; ++i ) { + extensionsBuilder.append ( gl30.glGetStringi ( GL20.GL_EXTENSIONS , i ) ) ; + extensionsBuilder.append ( Lwjgl backend does n't support OpenGL ES 3.2+ __EoT__ Creating a LwjglApplication with useGL30 set to true still does n't create an OpenGL ES 3 context . Additionally , Gdx.gl30 is null . The issue seems to be [ here ] ( https : //github.com/libgdx/libgdx/blob/master/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/LwjglGraphics.java # L166 ) . context should be passed in to Display.create along with the PixelFormat . [ This line ] ( https : //github.com/libgdx/libgdx/blob/master/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/LwjglGraphics.java # L241 ) should also check whether the major version is 3 and set gl30 accordingly .
diff -- git a/extensions/gdx-jnigen/src/com/badlogic/gdx/jnigen/JniGenSharedLibraryLoader.java b/extensions/gdx-jnigen/src/com/badlogic/gdx/jnigen/JniGenSharedLibraryLoader.java index 5549c5a..0ccfb68 100644 -- - a/extensions/gdx-jnigen/src/com/badlogic/gdx/jnigen/JniGenSharedLibraryLoader.java +++ b/extensions/gdx-jnigen/src/com/badlogic/gdx/jnigen/JniGenSharedLibraryLoader.java @ @ -100,7 +100,9 @ @ public class JniGenSharedLibraryLoader { private InputStream getFromJar ( String jarFile , String sharedLibrary ) throws IOException { ZipFile file = new ZipFile ( nativesJar ) ; ZipEntry entry = file.getEntry ( sharedLibrary ) ; - return file.getInputStream ( entry ) ; + InputStream stream = file.getInputStream ( entry ) ; + file.close ( ) ; + return stream ; } /** Loads a shared library with the given name for the platform the application is running on . The name should not contain a diff -- git a/gdx/src/com/badlogic/gdx/utils/SharedLibraryLoader.java b/gdx/src/com/badlogic/gdx/utils/SharedLibraryLoader.java index f3f41b3..c102e28 100644 -- - a/gdx/src/com/badlogic/gdx/utils/SharedLibraryLoader.java +++ b/gdx/src/com/badlogic/gdx/utils/SharedLibraryLoader.java @ @ -127,8 +127,13 @ @ public class SharedLibraryLoader { try { ZipFile file = new ZipFile ( nativesJar ) ; ZipEntry entry = file.getEntry ( path ) ; - if ( entry == null ) throw new GdxRuntimeException ( `` Could n't find ' '' + path + `` ' in JAR : `` + nativesJar ) ; - return file.getInputStream ( entry ) ; + if ( entry == null ) { + file.close ( ) ; + throw new GdxRuntimeException ( Support Immutable Color __EoT__ We are running into an issue where a static Color stored in the Colors map is being changed - so that the shared Color used across the game changes also . ( i.e `` BLACK '' was changed to no longer be black ) While we 've fixed the cause of this , it is n't possible currently to make a Color object that enforces this . The ` r ` ` g ` ` b ` values are public , which means there is no easy way to subclass Color to make an `` UnchangeableColor '' class . There are hundreds of direct references to these public variables in the libGDX codebase . Here 's what i 'd propose : 1 . Replace the ` public float r , g , b , a ` with getters and setters . 2 . Create an unchangeable Color class that is only set in the constructor and use it for colors like `` BLACK '' and `` RED '' which should never be accidentally changed , and optionally for any unchangable colors that a game wants to add to the Colors map . Thoughts ?
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java index 91171a0..fb50f3c 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java @ @ -177,6 +177,19 @ @ public class GlyphLayout implements Poolable { } else { next = wrap ( fontData , run , glyphRunPool , wrapIndex , i ) ; runs.add ( next ) ; + + // Remove whitespace at the front and end of the run after wrap + if ( fontData.isWhitespace ( ( char ) run.glyphs.first ( ) .id ) ) { + run.glyphs.removeIndex ( 0 ) ; + float removedXAdvance = run.xAdvances.removeIndex ( 1 ) ; + run.width -= removedXAdvance ; + } + if ( fontData.isWhitespace ( ( char ) run.glyphs.peek ( ) .id ) ) { + run.glyphs.pop ( ) ; + float removedXAdvance = run.xAdvances.pop ( ) ; + run.width -= removedXAdvance ; + } + width = Math.max ( width , run.x + run.width ) ; } diff -- git a/tests/gdx-tests/src/com/badlogic/gdx/tests/GlyphLayoutWrapTest.java b/tests/gdx-tests/src/com/badlogic/gdx/tests/GlyphLayoutWrapTest.java new file mode 100644 index 0000000..175ac50 -- - /dev/null +++ b/tests/gdx-tests/src/com/badlogic/gdx/tests/GlyphLayoutWrapTest.java @ @ -0,0 +1,127 @ @ +/******************************************************************************* + * Copyright 2011 See AUTHORS file . + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * [ Android ] Sound issue __EoT__ # # # # Issue details On my Android 7.0 smartphone some sounds are gone at play mission time . Usually it happened on looped `` engine '' sound . But also gone other random sounds like shot , explosion , collision and so on . On Android 4.4 all works fine . I solved this problem by writing my own AndroidSound class that use new way to initialize SoundPool . And also increase priority for looping sounds . I think it should be applied for all , so I suggest you to fix this : **gdx.backends.android.AndroidAudio.java constructor must be updated by this way : ** `` ` public AndroidAudio ( Context context , AndroidApplicationConfiguration config ) { if ( ! config.disableAudio ) { if ( Build.VERSION.SDK_INT > = Build.VERSION_CODES.LOLLIPOP ) { AudioAttributes audioAttrib = new AudioAttributes.Builder ( ) .setUsage ( AudioAttributes.USAGE_GAME ) .setContentType ( AudioAttributes.CONTENT_TYPE_SONIFICATION ) .build ( ) ; soundPool = new SoundPool.Builder ( ) .setAudioAttributes ( audioAttrib ) .setMaxStreams ( config.maxSimultaneousSounds ) .build ( ) ; } else { soundPool = new SoundPool ( config.maxSimultaneousSounds , AudioManager.STREAM_MUSIC , 0 ) ; // srcQuality : the sample-rate converter quality . Currently has
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java index 91171a0..8fa05e1 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java @ @ -146,52 +146,60 @ @ public class GlyphLayout implements Poolable { glyphRunPool.free ( run ) ; else { runs.add ( run ) ; - - // Compute the run width , wrap if necessary , and position the run . float [ ] xAdvances = run.xAdvances.items ; - for ( int i = 0 , n = run.xAdvances.size ; i < n ; i++ ) { - float xAdvance = xAdvances [ i ] ; - x += xAdvance ; - - // Do n't wrap if the glyph would fit with just its width ( no xadvance or kerning ) . - if ( wrap & & x > targetWidth & & i > 1 - & & x - xAdvance + ( run.glyphs.get ( i - 1 ) .xoffset + run.glyphs.get ( i - 1 ) .width ) * fontData.scaleX - - 0.0001f > targetWidth ) { - - if ( truncate ! = null ) { - truncate ( fontData , run , targetWidth , truncate , i , glyphRunPool ) ; - x = run.x + run.width ; - break outer ; [ Android ] Sound issue __EoT__ # # # # Issue details On my Android 7.0 smartphone some sounds are gone at play mission time . Usually it happened on looped `` engine '' sound . But also gone other random sounds like shot , explosion , collision and so on . On Android 4.4 all works fine . I solved this problem by writing my own AndroidSound class that use new way to initialize SoundPool . And also increase priority for looping sounds . I think it should be applied for all , so I suggest you to fix this : **gdx.backends.android.AndroidAudio.java constructor must be updated by this way : ** `` ` public AndroidAudio ( Context context , AndroidApplicationConfiguration config ) { if ( ! config.disableAudio ) { if ( Build.VERSION.SDK_INT > = Build.VERSION_CODES.LOLLIPOP ) { AudioAttributes audioAttrib = new AudioAttributes.Builder ( ) .setUsage ( AudioAttributes.USAGE_GAME ) .setContentType ( AudioAttributes.CONTENT_TYPE_SONIFICATION ) .build ( ) ; soundPool = new SoundPool.Builder ( ) .setAudioAttributes ( audioAttrib ) .setMaxStreams ( config.maxSimultaneousSounds ) .build ( ) ; } else { soundPool = new SoundPool ( config.maxSimultaneousSounds , AudioManager.STREAM_MUSIC , 0 ) ; // srcQuality : the sample-rate converter quality . Currently has
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl b/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl index fc9acab..b2c9ecf 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl +++ b/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl @ @ -1,4 +1,4 @ @ - # ifdef GL_ES + # ifdef GL_ES # define LOWP lowp # define MED mediump # define HIGH highp @ @ -28,7 +28,7 @ @ varying float v_alphaTest ; # endif //alphaTestFlag # endif //blendedFlag - # if defined ( diffuseTextureFlag ) || defined ( specularTextureFlag ) + # if defined ( diffuseTextureFlag ) || defined ( specularTextureFlag ) || defined ( emissiveTextureFlag ) # define textureFlag # endif @ @ -40,6 +40,10 @ @ varying MED vec2 v_diffuseUV ; varying MED vec2 v_specularUV ; # endif + # ifdef emissiveTextureFlag +varying MED vec2 v_emissiveUV ; + # endif + # ifdef diffuseColorFlag uniform vec4 u_diffuseColor ; # endif @ @ -60,6 +64,14 @ @ uniform sampler2D u_specularTexture ; uniform sampler2D u_normalTexture ; # endif + # ifdef emissiveColorFlag +uniform vec4 u_emissiveColor ; + # endif + + # ifdef emissiveTextureFlag +uniform sampler2D u_emissiveTexture ; + # endif + # ifdef lightingFlag varying vec3 v_lightDiffuse ; @ @ -80,12 +92,12 @ @ varying vec3 v_shadowMapUv ; float getShadowness ( vec2 offset ) { const vec4 bitShifts = vec4 ( 1.0 build.gradle version number __EoT__ # # # # Issue details The build.gradle seems to be on version ` 1.9.5-SNAPSHOT ` . This seems incorrect to me as the current version in this repo is something like 1.9.9-SNAPSHOT or 1.9.8 . Am I missing something ? Is there a reason this number is lagging behind or is it just something that has been forgotten ?
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java index 91171a0..1253544 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java @ @ -175,8 +175,9 @ @ public class GlyphLayout implements Poolable { run.width = 0 ; width = Math.max ( width , run.x ) ; } else { - next = wrap ( fontData , run , glyphRunPool , wrapIndex , i ) ; + next = wrap ( fontData , run , glyphRunPool , halign , wrapIndex , i ) ; runs.add ( next ) ; + width = Math.max ( width , run.x + run.width ) ; } @ @ -289,7 +290,7 @ @ public class GlyphLayout implements Poolable { glyphRunPool.free ( truncateRun ) ; } - private GlyphRun wrap ( BitmapFontData fontData , GlyphRun first , Pool < GlyphRun > glyphRunPool , int wrapIndex , int widthIndex ) { + private GlyphRun wrap ( BitmapFontData fontData , GlyphRun first , Pool < GlyphRun > glyphRunPool , int halign , int wrapIndex , int widthIndex ) { GlyphRun second = glyphRunPool.obtain ( ) ; second.color.set ( first.color ) ; int glyphCount = first.glyphs.size ; @ @ -319,6 +320,34 @ @ public class GlyphLayout implements Poolable { FloatArray xAdvances2 = first.xAdvances ; // Starts with all build.gradle version number __EoT__ # # # # Issue details The build.gradle seems to be on version ` 1.9.5-SNAPSHOT ` . This seems incorrect to me as the current version in this repo is something like 1.9.9-SNAPSHOT or 1.9.8 . Am I missing something ? Is there a reason this number is lagging behind or is it just something that has been forgotten ?
diff -- git a/CHANGES b/CHANGES index ea974f5..98f7b07 100755 -- - a/CHANGES +++ b/CHANGES @ @ -8,6 +8,7 @ @ - SkinLoader can be used on subclasses of Skin by overriding generateSkin ( ) . - API addition : Tree indentation can be customized . - Fixed GlyphLayout not respecting BitmapFontData # down . +- API Addition : Added FileHandle # map ( ) , can be used to memory map a file - API Addition : Added faceIndex paramter to # FreeTypeFontGenerator ( FileHandle , int ) . - API Change : BitmapFont # getSpaceWidth changed to BitmapFont # getSpaceXadvance . - Many GlyphLayout fixes . diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java index 1eb4142..6328680 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java @ @ -18,9 +18,13 @ @ package com.badlogic.gdx.backends.android ; import java.io.File ; import java.io.FileFilter ; +import java.io.FileInputStream ; import java.io.FilenameFilter ; import java.io.IOException ; import java.io.InputStream ; +import java.nio.ByteBuffer ; +import java.nio.ByteOrder ; +import java.nio.channels.FileChannel ; import android.content.res.AssetFileDescriptor ; import android.content.res.AssetManager ; @ @ -29,6 +33,7 @ @ import com.badlogic.gdx.Files.FileType ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.files.FileHandle ; import com.badlogic.gdx.utils.GdxRuntimeException ; +import com.badlogic.gdx.utils.StreamUtils ; /** @ author mzechner * @ author Nathan Sweet */ @ @ -80,6 +85,24 @ @ public class build.gradle version number __EoT__ # # # # Issue details The build.gradle seems to be on version ` 1.9.5-SNAPSHOT ` . This seems incorrect to me as the current version in this repo is something like 1.9.9-SNAPSHOT or 1.9.8 . Am I missing something ? Is there a reason this number is lagging behind or is it just something that has been forgotten ?
diff -- git a/gdx/src/com/badlogic/gdx/math/Intersector.java b/gdx/src/com/badlogic/gdx/math/Intersector.java index efa8c02..2795489 100644 -- - a/gdx/src/com/badlogic/gdx/math/Intersector.java +++ b/gdx/src/com/badlogic/gdx/math/Intersector.java @ @ -302,6 +302,7 @ @ public final class Intersector { private static final Plane p = new Plane ( new Vector3 ( ) , 0 ) ; private static final Vector3 i = new Vector3 ( ) ; + private static final float epsilon = 0.00001f ; /** Intersect a { @ link Ray } and a triangle , returning the intersection point in intersection . * @ @ -312,37 +313,42 @ @ public final class Intersector { * @ param intersection The intersection point ( optional ) * @ return True in case an intersection is present . */ public static boolean intersectRayTriangle ( Ray ray , Vector3 t1 , Vector3 t2 , Vector3 t3 , Vector3 intersection ) { - if ( t1.idt ( ray.origin ) || t2.idt ( ray.origin ) || t3.idt ( ray.origin ) ) { - if ( intersection ! = null ) intersection.set ( ray.origin ) ; - return true ; - } - - p.set ( t1 , t2 , t3 ) ; - if ( ! intersectRayPlane ( ray , p , i ) ) return false ; Intersector.intersectRayTriangle failures ( again ) __EoT__ I have found another issue with intersectRayTriangle . How to reproduce : `` ` java Vector3 t1 = new Vector3 ( 90.0f , -150.0f , 1077.0f ) ; Vector3 t2 = new Vector3 ( 90.0f , -120.0f , 1109.0f ) ; Vector3 t3 = new Vector3 ( 120.0f , -150.0f , 1076.0f ) ; Ray ray = new Ray ( new Vector3 ( 90.0f , -150.0f , 1077.1f ) , new Vector3 ( -0.0f , 0.99503726f , 0.099503726f ) ) ; System.out.println ( Intersector.intersectRayTriangle ( ray , t1 , t2 , t3 , null ) ; // error : print false `` ` It 's not obvious there is an intersection , but it is at : [ 90.0 , -149.89658 , 1077.1104 ] Suggested fix ( adapted from the [ Möller-Trumbore algorithm ] ( http : //www.cs.virginia.edu/~gfx/Courses/2003/ImageSynthesis/papers/Acceleration/Fast % 20MinimumStorage % 20RayTriangle % 20Intersection.pdf ) ) : `` ` java private static final float epsilon = 0.00001f ; public static boolean intersectRayTriangle ( Ray ray , Vector3 t1 , Vector3 t2 , Vector3 t3 , Vector3 intersection ) { Vector3 edge1 = v0.set ( t2 ) .sub ( t1 ) ; Vector3 edge2 =
diff -- git a/gdx/src/com/badlogic/gdx/math/Intersector.java b/gdx/src/com/badlogic/gdx/math/Intersector.java index 4ee6705..bf84917 100644 -- - a/gdx/src/com/badlogic/gdx/math/Intersector.java +++ b/gdx/src/com/badlogic/gdx/math/Intersector.java @ @ -149,7 +149,7 @ @ public final class Intersector { private final static Vector2 s = new Vector2 ( ) ; private final static Vector2 e = new Vector2 ( ) ; - /** Intersects two resulting polygons with the same winding and sets the overlap polygon resulting from the intersection . + /** Intersects two polygons with clockwise vertices and sets the overlap polygon resulting from the intersection . * Follows the Sutherland-Hodgman algorithm . * * @ param p1 The polygon that is being clipped @ @ -157,13 +157,13 @ @ public final class Intersector { * @ param overlap The intersection of the two polygons ( optional ) * @ return Whether the two polygons intersect . */ public static boolean intersectPolygons ( Polygon p1 , Polygon p2 , Polygon overlap ) { + if ( p1.getVertices ( ) .length == 0 || p2.getVertices ( ) .length == 0 ) { + return false ; + } // reusable points to trace edges around polygon floatArray2.clear ( ) ; floatArray.clear ( ) ; floatArray2.addAll ( p1.getTransformedVertices ( ) ) ; - if ( SelectBox Javadoc is wrong __EoT__ [ ` SelectBox.getItems ( ) ` ] ( https : //github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SelectBox.java # L164 ) proclaims that ` `` If modified , { @ link # setItems ( Array ) } must be called to reflect the changes . `` ` , however this ca n't ever work , because [ ` setItems ( Array ) ` ] ( https : //github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SelectBox.java # L148 ) clears ` items ` , which clears any modification done on ` getItems ( ) ` ` Array ` . I do n't have time to look into this right now , but I believe that this pattern of ` setItems ( getItems ( ) ) ` is already present somewhere in libGDX and I am in favor of keeping it , because it can be useful ( rather than fixing docs ) . When fixing , scene2d should be searched whether this error appears somewhere else as well , as it looks like a copy-paste error .
diff -- git a/CHANGES b/CHANGES index ea974f5..2554dbc 100755 -- - a/CHANGES +++ b/CHANGES @ @ -11,6 +11,7 @ @ - API Addition : Added faceIndex paramter to # FreeTypeFontGenerator ( FileHandle , int ) . - API Change : BitmapFont # getSpaceWidth changed to BitmapFont # getSpaceXadvance . - Many GlyphLayout fixes . +- API Addition : Added FileHandle # map ( ) , can be used to memory map a file [ 1.9.8 ] - Add iPhoneX images diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java index 1eb4142..6328680 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java @ @ -18,9 +18,13 @ @ package com.badlogic.gdx.backends.android ; import java.io.File ; import java.io.FileFilter ; +import java.io.FileInputStream ; import java.io.FilenameFilter ; import java.io.IOException ; import java.io.InputStream ; +import java.nio.ByteBuffer ; +import java.nio.ByteOrder ; +import java.nio.channels.FileChannel ; import android.content.res.AssetFileDescriptor ; import android.content.res.AssetManager ; @ @ -29,6 +33,7 @ @ import com.badlogic.gdx.Files.FileType ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.files.FileHandle ; import com.badlogic.gdx.utils.GdxRuntimeException ; +import com.badlogic.gdx.utils.StreamUtils ; /** @ author mzechner * @ author Nathan Sweet */ @ @ -80,6 +85,24 @ @ public class AndroidFileHandle extends FileHandle { return super.read ( ) ; } + public ByteBuffer map ( FileChannel.MapMode mode ) { + if ( type == FileType.Internal ) { SelectBox Javadoc is wrong __EoT__ [ ` SelectBox.getItems ( ) ` ] ( https : //github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SelectBox.java # L164 ) proclaims that ` `` If modified , { @ link # setItems ( Array ) } must be called to reflect the changes . `` ` , however this ca n't ever work , because [ ` setItems ( Array ) ` ] ( https : //github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SelectBox.java # L148 ) clears ` items ` , which clears any modification done on ` getItems ( ) ` ` Array ` . I do n't have time to look into this right now , but I believe that this pattern of ` setItems ( getItems ( ) ) ` is already present somewhere in libGDX and I am in favor of keeping it , because it can be useful ( rather than fixing docs ) . When fixing , scene2d should be searched whether this error appears somewhere else as well , as it looks like a copy-paste error .
diff -- git a/gdx/src/com/badlogic/gdx/utils/BinaryHeap.java b/gdx/src/com/badlogic/gdx/utils/BinaryHeap.java index 3bd1855..3f40049 100644 -- - a/gdx/src/com/badlogic/gdx/utils/BinaryHeap.java +++ b/gdx/src/com/badlogic/gdx/utils/BinaryHeap.java @ @ -50,6 +50,28 @ @ public class BinaryHeap < T extends BinaryHeap.Node > { node.value = value ; return add ( node ) ; } + + /** Returns if binary heap contains the provided node . + * @ param node - may be null + * @ param identity - if true , == is used . Otherwise , .equals is used + */ + public boolean contains ( T node , boolean identity ) { + if ( identity || node == null ) { + for ( Node n : nodes ) { + if ( n == node ) { + return true ; + } + } + } else { + for ( Node n : nodes ) { + if ( n.equals ( node ) ) { + return true ; + } + } + } + + return false ; + } public T peek ( ) { if ( size == 0 ) throw new IllegalStateException ( `` The heap is empty . `` ) ; SelectBox Javadoc is wrong __EoT__ [ ` SelectBox.getItems ( ) ` ] ( https : //github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SelectBox.java # L164 ) proclaims that ` `` If modified , { @ link # setItems ( Array ) } must be called to reflect the changes . `` ` , however this ca n't ever work , because [ ` setItems ( Array ) ` ] ( https : //github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SelectBox.java # L148 ) clears ` items ` , which clears any modification done on ` getItems ( ) ` ` Array ` . I do n't have time to look into this right now , but I believe that this pattern of ` setItems ( getItems ( ) ) ` is already present somewhere in libGDX and I am in favor of keeping it , because it can be useful ( rather than fixing docs ) . When fixing , scene2d should be searched whether this error appears somewhere else as well , as it looks like a copy-paste error .
diff -- git a/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/objectal/ALSource.java b/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/objectal/ALSource.java index 42e976a..bb906bd 100644 -- - a/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/objectal/ALSource.java +++ b/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/objectal/ALSource.java @ @ -38,6 +38,9 @ @ public class ALSource extends NSObject { @ Property ( selector = `` sourceId '' ) public native int getSourceId ( ) ; + @ Property ( selector = `` state '' ) + public native int getState ( ) ; + @ Method ( selector = `` stop '' ) public native void stop ( ) ; [ Skins ] Not possible to use superclass as parent for cascading styles __EoT__ # # # # Issue details Recently the possibility to use cascading styles was introduced to Skins . However , it is not possible to use superclasses as parent styles : # # # # Reproduction steps/code `` ` text { ButtonStyle : { parent : { // ... } } , TextButtonStyle : { child : { parent : parent // error } } } `` ` # # # # Version of LibGDX and/or relevant dependencies 1.9.9 # # # # copyFields ( ) This is because [ Json : :copyFields ( ) ] ( https : //github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/utils/Json.java # L1058 ) ( also new ) requires all fields of the target class to be present in the source class , which generally is n't the case if the source class is a superclass of the target class . https : //github.com/libgdx/libgdx/blob/d72e375d6f1ba8c8f2cf22038b7a36a1ea892690/gdx/src/com/badlogic/gdx/utils/Json.java # L1058-L1073 I assume that ` copyFields ( ) ` is actually supposed to do it the other way around : all fields in the source class should be present in the target class .
diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidMultiTouchHandler.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidMultiTouchHandler.java index 145a2b4..13d5f35 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidMultiTouchHandler.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidMultiTouchHandler.java @ @ -60,7 +60,6 @ @ public class AndroidMultiTouchHandler implements AndroidTouchHandler { case MotionEvent.ACTION_UP : case MotionEvent.ACTION_POINTER_UP : case MotionEvent.ACTION_OUTSIDE : - case MotionEvent.ACTION_CANCEL : realPointerIndex = input.lookUpPointerIndex ( pointerId ) ; if ( realPointerIndex == -1 ) break ; if ( realPointerIndex > = AndroidInput.NUM_TOUCHES ) break ; @ @ -77,6 +76,18 @ @ public class AndroidMultiTouchHandler implements AndroidTouchHandler { input.button [ realPointerIndex ] = 0 ; break ; + case MotionEvent.ACTION_CANCEL : + for ( int i = 0 ; i < input.realId.length ; i++ ) { + input.realId [ i ] = -1 ; + input.touchX [ i ] = 0 ; + input.touchY [ i ] = 0 ; + input.deltaX [ i ] = 0 ; + input.deltaY [ i ] = 0 ; + input.touched [ i ] = false ; + input.button [ i ] = 0 ; + } + break ; + case MotionEvent.ACTION_MOVE : int pointerCount = event.getPointerCount ( ) ; for ( int i = 0 ; i < pointerCount ; i++ ) { [ Skins ] Not possible to use superclass as parent for cascading styles __EoT__ # # # # Issue details Recently the possibility to use cascading styles was introduced to Skins . However , it is not possible to use superclasses as parent styles : # # # # Reproduction steps/code `` ` text { ButtonStyle : { parent : { // ... } } , TextButtonStyle : { child : { parent : parent // error } } } `` ` # # # # Version of LibGDX and/or relevant dependencies 1.9.9 # # # # copyFields ( ) This is because [ Json : :copyFields ( ) ] ( https : //github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/utils/Json.java # L1058 ) ( also new ) requires all fields of the target class to be present in the source class , which generally is n't the case if the source class is a superclass of the target class . https : //github.com/libgdx/libgdx/blob/d72e375d6f1ba8c8f2cf22038b7a36a1ea892690/gdx/src/com/badlogic/gdx/utils/Json.java # L1058-L1073 I assume that ` copyFields ( ) ` is actually supposed to do it the other way around : all fields in the source class should be present in the target class .
diff -- git a/gdx/src/com/badlogic/gdx/math/Intersector.java b/gdx/src/com/badlogic/gdx/math/Intersector.java index 4ee6705..8861cfa 100644 -- - a/gdx/src/com/badlogic/gdx/math/Intersector.java +++ b/gdx/src/com/badlogic/gdx/math/Intersector.java @ @ -149,21 +149,21 @ @ public final class Intersector { private final static Vector2 s = new Vector2 ( ) ; private final static Vector2 e = new Vector2 ( ) ; - /** Intersects two resulting polygons with the same winding and sets the overlap polygon resulting from the intersection . + /** Intersects two convex polygons with clockwise vertices and sets the overlap polygon resulting from the intersection . * Follows the Sutherland-Hodgman algorithm . * * @ param p1 The polygon that is being clipped * @ param p2 The clip polygon - * @ param overlap The intersection of the two polygons ( optional ) + * @ param overlap The intersection of the two polygons ( can be null , if an intersection polygon is not needed ) * @ return Whether the two polygons intersect . */ public static boolean intersectPolygons ( Polygon p1 , Polygon p2 , Polygon overlap ) { + if ( p1.getVertices ( ) .length == 0 || p2.getVertices ( ) .length == 0 ) { + return false ; + } // reusable points to [ Skins ] Not possible to use superclass as parent for cascading styles __EoT__ # # # # Issue details Recently the possibility to use cascading styles was introduced to Skins . However , it is not possible to use superclasses as parent styles : # # # # Reproduction steps/code `` ` text { ButtonStyle : { parent : { // ... } } , TextButtonStyle : { child : { parent : parent // error } } } `` ` # # # # Version of LibGDX and/or relevant dependencies 1.9.9 # # # # copyFields ( ) This is because [ Json : :copyFields ( ) ] ( https : //github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/utils/Json.java # L1058 ) ( also new ) requires all fields of the target class to be present in the source class , which generally is n't the case if the source class is a superclass of the target class . https : //github.com/libgdx/libgdx/blob/d72e375d6f1ba8c8f2cf22038b7a36a1ea892690/gdx/src/com/badlogic/gdx/utils/Json.java # L1058-L1073 I assume that ` copyFields ( ) ` is actually supposed to do it the other way around : all fields in the source class should be present in the target class .
diff -- git a/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SplitPane.java b/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SplitPane.java index 9763be9..430f493 100644 -- - a/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SplitPane.java +++ b/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SplitPane.java @ @ -50,6 +50,7 @ @ public class SplitPane extends WidgetGroup { private Rectangle firstWidgetBounds = new Rectangle ( ) ; private Rectangle secondWidgetBounds = new Rectangle ( ) ; Rectangle handleBounds = new Rectangle ( ) ; + boolean cursorOverHandle ; private Rectangle tempScissors = new Rectangle ( ) ; Vector2 lastPoint = new Vector2 ( ) ; @ @ -123,6 +124,11 @ @ public class SplitPane extends WidgetGroup { } invalidate ( ) ; } + + public boolean mouseMoved ( InputEvent event , float x , float y ) { + cursorOverHandle = handleBounds.contains ( x , y ) ; + return false ; + } } ) ; } @ @ -378,6 +384,10 @ @ public class SplitPane extends WidgetGroup { } return false ; } + + public boolean isCursorOverHandle ( ) { + return cursorOverHandle ; + } /** The style for a splitpane , see { @ link SplitPane } . * @ author mzechner [ Skins ] Not possible to use superclass as parent for cascading styles __EoT__ # # # # Issue details Recently the possibility to use cascading styles was introduced to Skins . However , it is not possible to use superclasses as parent styles : # # # # Reproduction steps/code `` ` text { ButtonStyle : { parent : { // ... } } , TextButtonStyle : { child : { parent : parent // error } } } `` ` # # # # Version of LibGDX and/or relevant dependencies 1.9.9 # # # # copyFields ( ) This is because [ Json : :copyFields ( ) ] ( https : //github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/utils/Json.java # L1058 ) ( also new ) requires all fields of the target class to be present in the source class , which generally is n't the case if the source class is a superclass of the target class . https : //github.com/libgdx/libgdx/blob/d72e375d6f1ba8c8f2cf22038b7a36a1ea892690/gdx/src/com/badlogic/gdx/utils/Json.java # L1058-L1073 I assume that ` copyFields ( ) ` is actually supposed to do it the other way around : all fields in the source class should be present in the target class .
diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java index 12afc86..ceac630 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java @ @ -22,8 +22,8 @ @ import java.io.FileInputStream ; import java.io.FilenameFilter ; import java.io.IOException ; import java.io.InputStream ; +import java.nio.ByteBuffer ; import java.nio.ByteOrder ; -import java.nio.MappedByteBuffer ; import java.nio.channels.FileChannel ; import android.content.res.AssetFileDescriptor ; @ @ -85,7 +85,7 @ @ public class AndroidFileHandle extends FileHandle { return super.read ( ) ; } - public MappedByteBuffer map ( FileChannel.MapMode mode ) { + public ByteBuffer map ( FileChannel.MapMode mode ) { if ( type == FileType.Internal ) { FileInputStream input = null ; try { @ @ -93,7 +93,7 @ @ public class AndroidFileHandle extends FileHandle { long startOffset = fd.getStartOffset ( ) ; long declaredLength = fd.getDeclaredLength ( ) ; input = new FileInputStream ( fd.getFileDescriptor ( ) ) ; - MappedByteBuffer map = input.getChannel ( ) .map ( mode , startOffset , declaredLength ) ; + ByteBuffer map = input.getChannel ( ) .map ( mode , startOffset , declaredLength ) ; map.order ( ByteOrder.nativeOrder ( ) ) ; return map ; } catch ( Exception ex ) { diff -- git a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtFileHandle.java b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtFileHandle.java index d8a96b5..c6844c5 100644 -- - a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtFileHandle.java +++ b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtFileHandle.java @ @ -28,7 +28,7 @ @ [ Skins ] Not possible to use superclass as parent for cascading styles __EoT__ # # # # Issue details Recently the possibility to use cascading styles was introduced to Skins . However , it is not possible to use superclasses as parent styles : # # # # Reproduction steps/code `` ` text { ButtonStyle : { parent : { // ... } } , TextButtonStyle : { child : { parent : parent // error } } } `` ` # # # # Version of LibGDX and/or relevant dependencies 1.9.9 # # # # copyFields ( ) This is because [ Json : :copyFields ( ) ] ( https : //github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/utils/Json.java # L1058 ) ( also new ) requires all fields of the target class to be present in the source class , which generally is n't the case if the source class is a superclass of the target class . https : //github.com/libgdx/libgdx/blob/d72e375d6f1ba8c8f2cf22038b7a36a1ea892690/gdx/src/com/badlogic/gdx/utils/Json.java # L1058-L1073 I assume that ` copyFields ( ) ` is actually supposed to do it the other way around : all fields in the source class should be present in the target class .
diff -- git a/CHANGES b/CHANGES index ace0a15..9a81095 100755 -- - a/CHANGES +++ b/CHANGES @ @ -8,6 +8,7 @ @ - SkinLoader can be used on subclasses of Skin by overriding generateSkin ( ) . - API addition : Tree indentation can be customized . - Fixed GlyphLayout not respecting BitmapFontData # down . +- API Addition : Added faceIndex paramter to # FreeTypeFontGenerator ( FileHandle , int ) . [ 1.9.8 ] - Add iPhoneX images diff -- git a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java index 415025a..0de4cae 100755 -- - a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java +++ b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java @ @ -84,10 +84,15 @ @ public class FreeTypeFontGenerator implements Disposable { boolean bitmapped = false ; private int pixelWidth , pixelHeight ; + /** { @ link # FreeTypeFontGenerator ( FileHandle , int ) } */ + public FreeTypeFontGenerator ( FileHandle fontFile ) { + this ( fontFile , 0 ) ; + } + /** Creates a new generator from the given font file . Uses { @ link FileHandle # length ( ) } to determine the file size . If the file * length could not be determined ( it was 0 ) , an extra copy of the font bytes is performed . Throws a * [ Skins ] Not possible to use superclass as parent for cascading styles __EoT__ # # # # Issue details Recently the possibility to use cascading styles was introduced to Skins . However , it is not possible to use superclasses as parent styles : # # # # Reproduction steps/code `` ` text { ButtonStyle : { parent : { // ... } } , TextButtonStyle : { child : { parent : parent // error } } } `` ` # # # # Version of LibGDX and/or relevant dependencies 1.9.9 # # # # copyFields ( ) This is because [ Json : :copyFields ( ) ] ( https : //github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/utils/Json.java # L1058 ) ( also new ) requires all fields of the target class to be present in the source class , which generally is n't the case if the source class is a superclass of the target class . https : //github.com/libgdx/libgdx/blob/d72e375d6f1ba8c8f2cf22038b7a36a1ea892690/gdx/src/com/badlogic/gdx/utils/Json.java # L1058-L1073 I assume that ` copyFields ( ) ` is actually supposed to do it the other way around : all fields in the source class should be present in the target class .
diff -- git a/gdx/src/com/badlogic/gdx/graphics/glutils/GLFrameBuffer.java b/gdx/src/com/badlogic/gdx/graphics/glutils/GLFrameBuffer.java index fd0a287..36b428d 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/glutils/GLFrameBuffer.java +++ b/gdx/src/com/badlogic/gdx/graphics/glutils/GLFrameBuffer.java @ @ -202,11 +202,12 @ @ public abstract class GLFrameBuffer < T extends GLTexture > implements Disposable { gl.glFramebufferRenderbuffer ( GL20.GL_FRAMEBUFFER , GL20.GL_DEPTH_ATTACHMENT , GL20.GL_RENDERBUFFER , depthStencilPackedBufferHandle ) ; gl.glFramebufferRenderbuffer ( GL20.GL_FRAMEBUFFER , GL20.GL_STENCIL_ATTACHMENT , GL20.GL_RENDERBUFFER , depthStencilPackedBufferHandle ) ; - result = gl.glCheckFramebufferStatus ( GL20.GL_FRAMEBUFFER ) ; } gl.glBindFramebuffer ( GL20.GL_FRAMEBUFFER , defaultFramebufferHandle ) ; + result = gl.glCheckFramebufferStatus ( GL20.GL_FRAMEBUFFER ) ; + if ( result ! = GL20.GL_FRAMEBUFFER_COMPLETE ) { disposeColorTexture ( colorTexture ) ; `` unknown error 36059 '' when instantiating FrameBufferCubemap __EoT__ When attempting to construct a simple FrameBufferCubemap on OS/X Yosemite ( 10.10.5 ) , using LibGDX 1.9.4 stable on the LWJGL/Desktop backend , I 'm getting the error below . I have not attempted to reproduce on other platforms . OpenGL appears to return an error status from ` glCheckFramebufferStatus ` if it 's queried before ` glBindFramebuffer ` . In the current state of GLFrameBuffer the status is queried before the FB bind , resulting in an error code . This appears to be regression on https : //github.com/libgdx/libgdx/issues/3227 . See also the original fix commit at : https : //github.com/libgdx/libgdx/pull/3233 . Stack trace : `` ` Exception in thread `` LWJGL Application '' java.lang.IllegalStateException : frame buffer could n't be constructed : unknown error 36059 at com.badlogic.gdx.graphics.glutils.GLFrameBuffer.build ( GLFrameBuffer.java:230 ) at com.badlogic.gdx.graphics.glutils.GLFrameBuffer. < init > ( GLFrameBuffer.java:118 ) at com.badlogic.gdx.graphics.glutils.FrameBufferCubemap. < init > ( FrameBufferCubemap.java:88 ) at com.badlogic.gdx.graphics.glutils.FrameBufferCubemap. < init > ( FrameBufferCubemap.java:75 ) at xyz.jmullin.fbcube.error.desktop.FbCubeError.create ( FbCubeError.java:11 ) at com.badlogic.gdx.backends.lwjgl.LwjglApplication.mainLoop ( LwjglApplication.java:147 ) at com.badlogic.gdx.backends.lwjgl.LwjglApplication $ 1.run ( LwjglApplication.java:124 ) `` ` Minimal application to reproduce : `` ` import com.badlogic.gdx.backends.lwjgl.LwjglApplication ; import com.badlogic.gdx . * ; import
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g3d/Model.java b/gdx/src/com/badlogic/gdx/graphics/g3d/Model.java index 1aedee9..2c4503a 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g3d/Model.java +++ b/gdx/src/com/badlogic/gdx/graphics/g3d/Model.java @ @ -255,7 +255,6 @ @ public class Model implements Disposable { ObjectMap < String , Texture > textures = new ObjectMap < String , Texture > ( ) ; - // FIXME uvScaling/uvTranslation totally ignored if ( mtl.textures ! = null ) { for ( ModelTexture tex : mtl.textures ) { Texture texture ; @ @ -274,16 +273,25 @ @ public class Model implements Disposable { descriptor.vWrap = texture.getVWrap ( ) ; switch ( tex.usage ) { case ModelTexture.USAGE_DIFFUSE : - result.set ( new TextureAttribute ( TextureAttribute.Diffuse , descriptor ) ) ; + result.set ( new TextureAttribute ( TextureAttribute.Diffuse , descriptor , tex.uvTranslation , tex.uvScaling ) ) ; break ; case ModelTexture.USAGE_SPECULAR : - result.set ( new TextureAttribute ( TextureAttribute.Specular , descriptor ) ) ; + result.set ( new TextureAttribute ( TextureAttribute.Specular , descriptor , tex.uvTranslation , tex.uvScaling ) ) ; break ; case ModelTexture.USAGE_BUMP : - result.set ( new TextureAttribute ( TextureAttribute.Bump , descriptor ) ) ; + result.set ( new TextureAttribute ( TextureAttribute.Bump , descriptor , tex.uvTranslation , tex.uvScaling ) ) ; break ; case ModelTexture.USAGE_NORMAL : - result.set ( new TextureAttribute ( TextureAttribute.Normal JSON improvements : # toString and # name ( ) __EoT__ Hi , # # # # Problem : it seems that this commit : https : //github.com/libgdx/libgdx/commit/72c9d62cfb9810459a1de85f3101f1a3cb6f7213 changed JSON to use Enums # name ( ) instead of Enums # toString ( ) and this broke our tests and build . # # # # Use case : Having the following autogenerated java class : `` ` java /** * Simple object for storing information about the current release of the ead2 editor . This release.json file should be generated automatically on each release . * */ @ Generated ( `` org.jsonschema2pojo '' ) public class ReleaseInfo { /** * Name of the application . Used mostly in tracking * */ private String appName ; /** * The release version given as three numbers separated by dots ( e.g . 2.0.0 ) * */ private String appVersion = `` 0.0.0 '' ; /** * The release flavour . For explanations on canary , beta and stable , see the wiki * */ private ReleaseInfo.ReleaseType releaseType ; /** * true if this is a dev working copy , not an actual release . If true , the update system is
diff -- git a/CHANGES b/CHANGES index 3e20ae1..ace0a15 100755 -- - a/CHANGES +++ b/CHANGES @ @ -3,6 +3,9 @ @ - Update to Lwjgl 3.1.4 - Update android level we build against to 7.1 ( API 25 ) - API Change : gdx-tools no longer bundles dependencies to be compatible with java 9 +- Skin JSON files can now use the simple names of classes , i.e . `` BitmapFont '' rather than `` com.badlogic.gdx.graphics.g2d.BitmapFont '' . Custom classes can be added by overriding Skin.getJsonLoader ( ) and calling json.setClassTag ( ) . +- Skin supports cascading styles in JSON . Use the `` parent '' property to tag another style by name to use its values as defaults . See https : //github.com/libgdx/libgdx/blob/master/tests/gdx-tests-android/assets/data/uiskin.json for example . +- SkinLoader can be used on subclasses of Skin by overriding generateSkin ( ) . - API addition : Tree indentation can be customized . - Fixed GlyphLayout not respecting BitmapFontData # down . Labels do n't wrap in the correct position with markup enabled __EoT__ # # # # Issue details If markup is used to changed the colour of a word that is at a wrap boundary then the word will not wrap correctly and the label will spill out of the bounds of the table that it is contained in . This increases the width of the layout and causes text to be cut off or drawn in the wrong place . I 've tested combinations of opening and closing the colour markup as well as different colours and the consistently reproducible thing is that if the word after the colour change needed to wrap then it will not . ( even with a space between the markup and the word ) . # # # # Reproduction steps/code Note in the example below if the [ GREEN ] tag is moved one word before or after its current position then all the text will wrap correctly and fit within the table as it should . `` ` public class TextWrapping extends ApplicationAdapter { Stage activeStage ; @ Override public void create ( ) { activeStage = new Stage ( new
diff -- git a/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/audio/Wav.java b/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/audio/Wav.java index 5008635..4819fc9 100644 -- - a/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/audio/Wav.java +++ b/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/audio/Wav.java @ @ -157,10 +157,17 @ @ public class Wav { public int read ( byte [ ] buffer ) throws IOException { if ( dataRemaining == 0 ) return -1 ; - int length = Math.min ( super.read ( buffer ) , dataRemaining ) ; - if ( length == -1 ) return -1 ; - dataRemaining -= length ; - return length ; + int offset = 0 ; + do { + int length = Math.min ( super.read ( buffer , offset , buffer.length - offset ) , dataRemaining ) ; + if ( length == -1 ) { + if ( offset > 0 ) return offset ; + return -1 ; + } + offset += length ; + dataRemaining -= length ; + } while ( offset < buffer.length ) ; + return offset ; } } } diff -- git a/backends/gdx-backend-lwjgl3/src/com/badlogic/gdx/backends/lwjgl3/audio/Wav.java b/backends/gdx-backend-lwjgl3/src/com/badlogic/gdx/backends/lwjgl3/audio/Wav.java index bbe97e8..e7dafca 100644 -- - a/backends/gdx-backend-lwjgl3/src/com/badlogic/gdx/backends/lwjgl3/audio/Wav.java +++ b/backends/gdx-backend-lwjgl3/src/com/badlogic/gdx/backends/lwjgl3/audio/Wav.java @ @ -133,10 +133,17 @ @ public class Wav { public int read ( byte [ ] buffer ) throws IOException { if ( dataRemaining == 0 ) return -1 ; Labels do n't wrap in the correct position with markup enabled __EoT__ # # # # Issue details If markup is used to changed the colour of a word that is at a wrap boundary then the word will not wrap correctly and the label will spill out of the bounds of the table that it is contained in . This increases the width of the layout and causes text to be cut off or drawn in the wrong place . I 've tested combinations of opening and closing the colour markup as well as different colours and the consistently reproducible thing is that if the word after the colour change needed to wrap then it will not . ( even with a space between the markup and the word ) . # # # # Reproduction steps/code Note in the example below if the [ GREEN ] tag is moved one word before or after its current position then all the text will wrap correctly and fit within the table as it should . `` ` public class TextWrapping extends ApplicationAdapter { Stage activeStage ; @ Override public void create ( ) { activeStage = new Stage ( new
diff -- git a/gdx/src/com/badlogic/gdx/utils/Align.java b/gdx/src/com/badlogic/gdx/utils/Align.java index c2fe5c8..0d22927 100644 -- - a/gdx/src/com/badlogic/gdx/utils/Align.java +++ b/gdx/src/com/badlogic/gdx/utils/Align.java @ @ -1,12 +1,12 @ @ /******************************************************************************* * Copyright 2011 See AUTHORS file . - * + * * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; * you may not use this file except in compliance with the License . * You may obtain a copy of the License at - * + * * http : //www.apache.org/licenses/LICENSE-2.0 - * + * * Unless required by applicable law or agreed to in writing , software * distributed under the License is distributed on an `` AS IS '' BASIS , * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . @ @ -29,4 +29,28 @ @ public class Align { static public final int topRight = top | right ; static public final int bottomLeft = bottom | left ; static public final int bottomRight = bottom | right ; + + static public final boolean isHorizontalLeft ( int align ) { + return align == topLeft || align == left || align == bottomLeft ; + } + + static public final boolean isHorizontalCenter Labels do n't wrap in the correct position with markup enabled __EoT__ # # # # Issue details If markup is used to changed the colour of a word that is at a wrap boundary then the word will not wrap correctly and the label will spill out of the bounds of the table that it is contained in . This increases the width of the layout and causes text to be cut off or drawn in the wrong place . I 've tested combinations of opening and closing the colour markup as well as different colours and the consistently reproducible thing is that if the word after the colour change needed to wrap then it will not . ( even with a space between the markup and the word ) . # # # # Reproduction steps/code Note in the example below if the [ GREEN ] tag is moved one word before or after its current position then all the text will wrap correctly and fit within the table as it should . `` ` public class TextWrapping extends ApplicationAdapter { Stage activeStage ; @ Override public void create ( ) { activeStage = new Stage ( new
diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java index f8500bb..f12d8d2 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java @ @ -25,7 +25,6 @ @ import android.os.Build ; import android.os.Bundle ; import android.os.Debug ; import android.os.Handler ; -import android.util.Log ; import android.view.Gravity ; import android.view.View ; import android.view.Window ; @ @ -39,7 +38,6 @ @ import com.badlogic.gdx.Audio ; import com.badlogic.gdx.Files ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.Graphics ; -import com.badlogic.gdx.Input ; import com.badlogic.gdx.LifecycleListener ; import com.badlogic.gdx.Net ; import com.badlogic.gdx.Preferences ; @ @ -51,7 +49,6 @ @ import com.badlogic.gdx.utils.GdxRuntimeException ; import com.badlogic.gdx.utils.SnapshotArray ; import java.lang.reflect.Method ; -import java.util.Arrays ; /** An implementation of the { @ link Application } interface for Android . Create an { @ link Activity } that derives from this class . In * the { @ link Activity # onCreate ( Bundle ) } method call the { @ link # initialize ( ApplicationListener ) } method specifying the @ @ -198,6 +195,10 @ @ public class AndroidApplication extends Activity implements AndroidApplicationBa log ( `` AndroidApplication '' , `` Failed to create AndroidVisibilityListener '' , e ) ; } } + + // detect an already connected bluetooth keyboardAvailable + if ( getResources ( ) .getConfiguration ( ) .keyboard ! = Configuration.KEYBOARD_NOKEYS ) Labels do n't wrap in the correct position with markup enabled __EoT__ # # # # Issue details If markup is used to changed the colour of a word that is at a wrap boundary then the word will not wrap correctly and the label will spill out of the bounds of the table that it is contained in . This increases the width of the layout and causes text to be cut off or drawn in the wrong place . I 've tested combinations of opening and closing the colour markup as well as different colours and the consistently reproducible thing is that if the word after the colour change needed to wrap then it will not . ( even with a space between the markup and the word ) . # # # # Reproduction steps/code Note in the example below if the [ GREEN ] tag is moved one word before or after its current position then all the text will wrap correctly and fit within the table as it should . `` ` public class TextWrapping extends ApplicationAdapter { Stage activeStage ; @ Override public void create ( ) { activeStage = new Stage ( new
diff -- git a/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/HorizontalGroup.java b/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/HorizontalGroup.java index c00f354..8e493b3 100644 -- - a/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/HorizontalGroup.java +++ b/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/HorizontalGroup.java @ @ -69,7 +69,12 @ @ public class HorizontalGroup extends WidgetGroup { Actor child = children.get ( i ) ; if ( child instanceof Layout ) { Layout layout = ( Layout ) child ; - prefWidth += layout.getPrefWidth ( ) ; + float width = layout.getPrefWidth ( ) ; + if ( width == 0 ) { + // a Label with text-wrapping on ? + width = child.getWidth ( ) ; + } + prefWidth += width ; prefHeight = Math.max ( prefHeight , layout.getPrefHeight ( ) ) ; } else { prefWidth += child.getWidth ( ) ; @ @ -86,7 +91,6 @ @ public class HorizontalGroup extends WidgetGroup { float spacing = this.spacing ; float groupHeight = getHeight ( ) > 0 ? getHeight ( ) : getMinHeight ( ) ; float x = reverse ? ( getWidth ( ) > 0 ? getWidth ( ) : getMinWidth ( ) ) : 0 ; - float dir = reverse ? -1 : 1 ; SnapshotArray < Actor > children = getChildren ( ) ; for ( int i = 0 , n = children.size VerticalGroup ignores Width of children __EoT__ Put a TextField into an VerticalGroup and the TextField will be drawn with a width of 150px regardless of its set width ( eg . 300px ) , even if the VerticalGroups width is set much higher ( eg . 500px ) . Put the TextField instead directly onto the stage and it will be drawn with the correct size . I used setWidth ( ... ) to set the width of each actor .
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java index 91171a0..8fa05e1 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java @ @ -146,52 +146,60 @ @ public class GlyphLayout implements Poolable { glyphRunPool.free ( run ) ; else { runs.add ( run ) ; - - // Compute the run width , wrap if necessary , and position the run . float [ ] xAdvances = run.xAdvances.items ; - for ( int i = 0 , n = run.xAdvances.size ; i < n ; i++ ) { - float xAdvance = xAdvances [ i ] ; - x += xAdvance ; - - // Do n't wrap if the glyph would fit with just its width ( no xadvance or kerning ) . - if ( wrap & & x > targetWidth & & i > 1 - & & x - xAdvance + ( run.glyphs.get ( i - 1 ) .xoffset + run.glyphs.get ( i - 1 ) .width ) * fontData.scaleX - - 0.0001f > targetWidth ) { - - if ( truncate ! = null ) { - truncate ( fontData , run , targetWidth , truncate , i , glyphRunPool ) ; - x = run.x + run.width ; - break outer ; PolygonSprite.java setRegion bug __EoT__ I am trying to execute this piece of code in my game . ` public void draw ( Batch batch , float parentAlpha ) { PolygonRegion polyReg = new PolygonRegion ( connectorTextureRegion , getVertices ( ) , getTriangles ( ) ) ; polygonSprite.setRegion ( polyReg ) ; polygonSprite.draw ( ( PolygonSpriteBatch ) batch ) ; } ` In general , it works well but sometimes I 'm getting an ArrayIndexOutOfBounds exception caused by the setRegion line . If I dive into the methods code , it fails at the first line in the for loop . public void setRegion ( PolygonRegion region ) { this.region = region ; float [ ] regionVertices = region.vertices ; float [ ] textureCoords = region.textureCoords ; if ( vertices == null || regionVertices.length ! = vertices.length ) vertices = new float [ ( regionVertices.length / 2 ) * 5 ] ; // Set the color and UVs in this sprite 's vertices . float floatColor = color.toFloatBits ( ) ; float [ ] vertices = this.vertices ; for ( int i = 0 , v = 2 , n = regionVertices.length ; i < n ; i += 2 ,
diff -- git a/gdx/src/com/badlogic/gdx/scenes/scene2d/Stage.java b/gdx/src/com/badlogic/gdx/scenes/scene2d/Stage.java index cd6ec5b..2e9ba21 100644 -- - a/gdx/src/com/badlogic/gdx/scenes/scene2d/Stage.java +++ b/gdx/src/com/badlogic/gdx/scenes/scene2d/Stage.java @ @ -125,8 +125,11 @ @ public class Stage extends InputAdapter implements Disposable { Batch batch = this.batch ; batch.setProjectionMatrix ( camera.combined ) ; batch.begin ( ) ; - root.draw ( batch , 1 ) ; - batch.end ( ) ; + try { + root.draw ( batch , 1 ) ; + } finally { + batch.end ( ) ; + } if ( debug ) drawDebug ( ) ; } @ @ -165,8 +168,11 @ @ public class Stage extends InputAdapter implements Disposable { Gdx.gl.glEnable ( GL20.GL_BLEND ) ; debugShapes.setProjectionMatrix ( viewport.getCamera ( ) .combined ) ; debugShapes.begin ( ) ; - root.drawDebug ( debugShapes ) ; - debugShapes.end ( ) ; + try { + root.drawDebug ( debugShapes ) ; + } finally { + debugShapes.end ( ) ; + } } /** Disables debug on all actors recursively except the specified actor and any children . */ PolygonSprite.java setRegion bug __EoT__ I am trying to execute this piece of code in my game . ` public void draw ( Batch batch , float parentAlpha ) { PolygonRegion polyReg = new PolygonRegion ( connectorTextureRegion , getVertices ( ) , getTriangles ( ) ) ; polygonSprite.setRegion ( polyReg ) ; polygonSprite.draw ( ( PolygonSpriteBatch ) batch ) ; } ` In general , it works well but sometimes I 'm getting an ArrayIndexOutOfBounds exception caused by the setRegion line . If I dive into the methods code , it fails at the first line in the for loop . public void setRegion ( PolygonRegion region ) { this.region = region ; float [ ] regionVertices = region.vertices ; float [ ] textureCoords = region.textureCoords ; if ( vertices == null || regionVertices.length ! = vertices.length ) vertices = new float [ ( regionVertices.length / 2 ) * 5 ] ; // Set the color and UVs in this sprite 's vertices . float floatColor = color.toFloatBits ( ) ; float [ ] vertices = this.vertices ; for ( int i = 0 , v = 2 , n = regionVertices.length ; i < n ; i += 2 ,
diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java index f8500bb..f12d8d2 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java @ @ -25,7 +25,6 @ @ import android.os.Build ; import android.os.Bundle ; import android.os.Debug ; import android.os.Handler ; -import android.util.Log ; import android.view.Gravity ; import android.view.View ; import android.view.Window ; @ @ -39,7 +38,6 @ @ import com.badlogic.gdx.Audio ; import com.badlogic.gdx.Files ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.Graphics ; -import com.badlogic.gdx.Input ; import com.badlogic.gdx.LifecycleListener ; import com.badlogic.gdx.Net ; import com.badlogic.gdx.Preferences ; @ @ -51,7 +49,6 @ @ import com.badlogic.gdx.utils.GdxRuntimeException ; import com.badlogic.gdx.utils.SnapshotArray ; import java.lang.reflect.Method ; -import java.util.Arrays ; /** An implementation of the { @ link Application } interface for Android . Create an { @ link Activity } that derives from this class . In * the { @ link Activity # onCreate ( Bundle ) } method call the { @ link # initialize ( ApplicationListener ) } method specifying the @ @ -198,6 +195,10 @ @ public class AndroidApplication extends Activity implements AndroidApplicationBa log ( `` AndroidApplication '' , `` Failed to create AndroidVisibilityListener '' , e ) ; } } + + // detect an already connected bluetooth keyboardAvailable + if ( getResources ( ) .getConfiguration ( ) .keyboard ! = Configuration.KEYBOARD_NOKEYS ) PolygonSprite.java setRegion bug __EoT__ I am trying to execute this piece of code in my game . ` public void draw ( Batch batch , float parentAlpha ) { PolygonRegion polyReg = new PolygonRegion ( connectorTextureRegion , getVertices ( ) , getTriangles ( ) ) ; polygonSprite.setRegion ( polyReg ) ; polygonSprite.draw ( ( PolygonSpriteBatch ) batch ) ; } ` In general , it works well but sometimes I 'm getting an ArrayIndexOutOfBounds exception caused by the setRegion line . If I dive into the methods code , it fails at the first line in the for loop . public void setRegion ( PolygonRegion region ) { this.region = region ; float [ ] regionVertices = region.vertices ; float [ ] textureCoords = region.textureCoords ; if ( vertices == null || regionVertices.length ! = vertices.length ) vertices = new float [ ( regionVertices.length / 2 ) * 5 ] ; // Set the color and UVs in this sprite 's vertices . float floatColor = color.toFloatBits ( ) ; float [ ] vertices = this.vertices ; for ( int i = 0 , v = 2 , n = regionVertices.length ; i < n ; i += 2 ,
diff -- git a/CHANGES b/CHANGES index 96ed842..1071112 100755 -- - a/CHANGES +++ b/CHANGES @ @ -1,4 +1,5 @ @ [ 1.9.5 ] +- Fix NPE swallowing `` video driver unsupported '' error on LWJGL 2 backend . - Allow window icons to be set in Lwjgl3ApplicationConfiguration or Lwjgl3WindowConfiguration . - Allow window icon and title to be changed in Lwjgl3Window - API Addition : ApplicationLogger interface , allowing easier access to custom logging diff -- git a/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/LwjglGraphics.java b/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/LwjglGraphics.java index 167e829..7df2f4c 100644 -- - a/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/LwjglGraphics.java +++ b/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/LwjglGraphics.java @ @ -319,7 +319,7 @ @ public class LwjglGraphics implements Graphics { createDisplayPixelFormat ( useGL30 , gles30ContextMajor , gles30ContextMinor ) ; return ; } - throw new GdxRuntimeException ( `` OpenGL is not supported by the video driver : `` + glVersion.getDebugVersionString ( ) , ex3 ) ; + throw new GdxRuntimeException ( `` OpenGL is not supported by this video driver . `` , ex3 ) ; } if ( getDisplayMode ( ) .bitsPerPixel == 16 ) { bufferFormat = new BufferFormat ( 5 , 6 , 5 , 0 , 8 , 0 , 0 , false ) ; A clean test app wo n't launch due to LwjglGraphics.createDisplayPixelFormat error __EoT__ I just installed created a fresh libgdx application via the generator found on the official web site . I left practically all things at default . Once generated , I imported the project in eclipse using Gradle ( as explained in the official procedure ) . Upon trying to launch my application on desktop , I get the following error : Exception in thread `` LWJGL Application '' java.lang.NullPointerException at com.badlogic.gdx.backends.lwjgl.LwjglGraphics.createDisplayPixelFormat ( LwjglGraphics.java:322 ) at com.badlogic.gdx.backends.lwjgl.LwjglGraphics.setupDisplay ( LwjglGraphics.java:216 ) at com.badlogic.gdx.backends.lwjgl.LwjglApplication.mainLoop ( LwjglApplication.java:142 ) at com.badlogic.gdx.backends.lwjgl.LwjglApplication $ 1.run ( LwjglApplication.java:124 ) Under `` Project and External Dependencies '' I can see it links to libgdx 1.9.4 and lwjgl 2.9.2 ( by the way , why is n't libgdx using lwjgl 2.9.3 , which is the latest version ? ) and some other non-important stuff . Note that this is a fresh project generated by the `` Libgdx Project Generator '' - I have n't modified a thing ! I 'm running Windows 10 on HP Elitebook 8560p ( it 's a laptop ) and it has Intel HD Graphics 3000 ( which is Microsoft DirectX 10.1 ( Shader
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl b/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl index fc9acab..b2c9ecf 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl +++ b/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl @ @ -1,4 +1,4 @ @ - # ifdef GL_ES + # ifdef GL_ES # define LOWP lowp # define MED mediump # define HIGH highp @ @ -28,7 +28,7 @ @ varying float v_alphaTest ; # endif //alphaTestFlag # endif //blendedFlag - # if defined ( diffuseTextureFlag ) || defined ( specularTextureFlag ) + # if defined ( diffuseTextureFlag ) || defined ( specularTextureFlag ) || defined ( emissiveTextureFlag ) # define textureFlag # endif @ @ -40,6 +40,10 @ @ varying MED vec2 v_diffuseUV ; varying MED vec2 v_specularUV ; # endif + # ifdef emissiveTextureFlag +varying MED vec2 v_emissiveUV ; + # endif + # ifdef diffuseColorFlag uniform vec4 u_diffuseColor ; # endif @ @ -60,6 +64,14 @ @ uniform sampler2D u_specularTexture ; uniform sampler2D u_normalTexture ; # endif + # ifdef emissiveColorFlag +uniform vec4 u_emissiveColor ; + # endif + + # ifdef emissiveTextureFlag +uniform sampler2D u_emissiveTexture ; + # endif + # ifdef lightingFlag varying vec3 v_lightDiffuse ; @ @ -80,12 +92,12 @ @ varying vec3 v_shadowMapUv ; float getShadowness ( vec2 offset ) { const vec4 bitShifts = vec4 ( 1.0 Request : Switch to lwjgl version 3.1.4 for next release __EoT__ Current libGDX version is using 3.1.3 . Version 3.1.4 of lwjgl supposedly fixes an important issue that affects all windows ( 10 ) users with UI scaling > 100 % ( which is probably a lot , considering high density displays are commonplace ) . This should fix the following libGDX issue : # 3813 Here 's the underlying lwjgl issue , closed via the 3.1.4 release : https : //github.com/LWJGL/lwjgl3/issues/252 I 'm happy to test a snapshot release of libgdx , if you make one !
diff -- git a/CHANGES b/CHANGES index ea974f5..98f7b07 100755 -- - a/CHANGES +++ b/CHANGES @ @ -8,6 +8,7 @ @ - SkinLoader can be used on subclasses of Skin by overriding generateSkin ( ) . - API addition : Tree indentation can be customized . - Fixed GlyphLayout not respecting BitmapFontData # down . +- API Addition : Added FileHandle # map ( ) , can be used to memory map a file - API Addition : Added faceIndex paramter to # FreeTypeFontGenerator ( FileHandle , int ) . - API Change : BitmapFont # getSpaceWidth changed to BitmapFont # getSpaceXadvance . - Many GlyphLayout fixes . diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java index 1eb4142..6328680 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java @ @ -18,9 +18,13 @ @ package com.badlogic.gdx.backends.android ; import java.io.File ; import java.io.FileFilter ; +import java.io.FileInputStream ; import java.io.FilenameFilter ; import java.io.IOException ; import java.io.InputStream ; +import java.nio.ByteBuffer ; +import java.nio.ByteOrder ; +import java.nio.channels.FileChannel ; import android.content.res.AssetFileDescriptor ; import android.content.res.AssetManager ; @ @ -29,6 +33,7 @ @ import com.badlogic.gdx.Files.FileType ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.files.FileHandle ; import com.badlogic.gdx.utils.GdxRuntimeException ; +import com.badlogic.gdx.utils.StreamUtils ; /** @ author mzechner * @ author Nathan Sweet */ @ @ -80,6 +85,24 @ @ public class Request : Switch to lwjgl version 3.1.4 for next release __EoT__ Current libGDX version is using 3.1.3 . Version 3.1.4 of lwjgl supposedly fixes an important issue that affects all windows ( 10 ) users with UI scaling > 100 % ( which is probably a lot , considering high density displays are commonplace ) . This should fix the following libGDX issue : # 3813 Here 's the underlying lwjgl issue , closed via the 3.1.4 release : https : //github.com/LWJGL/lwjgl3/issues/252 I 'm happy to test a snapshot release of libgdx , if you make one !
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java index 91171a0..8fa05e1 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java @ @ -146,52 +146,60 @ @ public class GlyphLayout implements Poolable { glyphRunPool.free ( run ) ; else { runs.add ( run ) ; - - // Compute the run width , wrap if necessary , and position the run . float [ ] xAdvances = run.xAdvances.items ; - for ( int i = 0 , n = run.xAdvances.size ; i < n ; i++ ) { - float xAdvance = xAdvances [ i ] ; - x += xAdvance ; - - // Do n't wrap if the glyph would fit with just its width ( no xadvance or kerning ) . - if ( wrap & & x > targetWidth & & i > 1 - & & x - xAdvance + ( run.glyphs.get ( i - 1 ) .xoffset + run.glyphs.get ( i - 1 ) .width ) * fontData.scaleX - - 0.0001f > targetWidth ) { - - if ( truncate ! = null ) { - truncate ( fontData , run , targetWidth , truncate , i , glyphRunPool ) ; - x = run.x + run.width ; - break outer ; Request : Switch to lwjgl version 3.1.4 for next release __EoT__ Current libGDX version is using 3.1.3 . Version 3.1.4 of lwjgl supposedly fixes an important issue that affects all windows ( 10 ) users with UI scaling > 100 % ( which is probably a lot , considering high density displays are commonplace ) . This should fix the following libGDX issue : # 3813 Here 's the underlying lwjgl issue , closed via the 3.1.4 release : https : //github.com/LWJGL/lwjgl3/issues/252 I 'm happy to test a snapshot release of libgdx , if you make one !
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/ParticleEffect.java b/gdx/src/com/badlogic/gdx/graphics/g2d/ParticleEffect.java index 18f6977..82b8f4c 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g2d/ParticleEffect.java +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/ParticleEffect.java @ @ -22,7 +22,6 @ @ import java.io.IOException ; import java.io.InputStream ; import java.io.InputStreamReader ; import java.io.Writer ; -import java.util.HashMap ; import com.badlogic.gdx.files.FileHandle ; import com.badlogic.gdx.graphics.Texture ; @ @ -30,6 +29,7 @ @ import com.badlogic.gdx.math.collision.BoundingBox ; import com.badlogic.gdx.utils.Array ; import com.badlogic.gdx.utils.Disposable ; import com.badlogic.gdx.utils.GdxRuntimeException ; +import com.badlogic.gdx.utils.ObjectMap ; import com.badlogic.gdx.utils.StreamUtils ; /** See < a href= '' http : //www.badlogicgames.com/wordpress/ ? p=1255 '' > http : //www.badlogicgames.com/wordpress/ ? p=1255 < /a > @ @ -205,7 +205,7 @ @ public class ParticleEffect implements Disposable { public void loadEmitterImages ( FileHandle imagesDir ) { ownsTexture = true ; - HashMap < String , Sprite > loadedSprites = new HashMap < String , Sprite > ( emitters.size ) ; + ObjectMap < String , Sprite > loadedSprites = new ObjectMap < String , Sprite > ( emitters.size ) ; for ( int i = 0 , n = emitters.size ; i < n ; i++ ) { ParticleEmitter emitter = emitters.get ( i ) ; if ( emitter.getImagePaths ( ) .size == 0 ) continue ; Request : Switch to lwjgl version 3.1.4 for next release __EoT__ Current libGDX version is using 3.1.3 . Version 3.1.4 of lwjgl supposedly fixes an important issue that affects all windows ( 10 ) users with UI scaling > 100 % ( which is probably a lot , considering high density displays are commonplace ) . This should fix the following libGDX issue : # 3813 Here 's the underlying lwjgl issue , closed via the 3.1.4 release : https : //github.com/LWJGL/lwjgl3/issues/252 I 'm happy to test a snapshot release of libgdx , if you make one !
diff -- git a/gdx/src/com/badlogic/gdx/graphics/GLTexture.java b/gdx/src/com/badlogic/gdx/graphics/GLTexture.java index 5c3cec1..d4b2cf6 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/GLTexture.java +++ b/gdx/src/com/badlogic/gdx/graphics/GLTexture.java @ @ -111,11 +111,11 @ @ public abstract class GLTexture implements Disposable { * @ param force True to always set the values , even if they are the same as the current values . */ public void unsafeSetWrap ( TextureWrap u , TextureWrap v , boolean force ) { if ( u ! = null & & ( force || uWrap ! = u ) ) { - Gdx.gl.glTexParameterf ( glTarget , GL20.GL_TEXTURE_WRAP_S , u.getGLEnum ( ) ) ; + Gdx.gl.glTexParameteri ( glTarget , GL20.GL_TEXTURE_WRAP_S , u.getGLEnum ( ) ) ; uWrap = u ; } if ( v ! = null & & ( force || vWrap ! = v ) ) { - Gdx.gl.glTexParameterf ( glTarget , GL20.GL_TEXTURE_WRAP_T , v.getGLEnum ( ) ) ; + Gdx.gl.glTexParameteri ( glTarget , GL20.GL_TEXTURE_WRAP_T , v.getGLEnum ( ) ) ; vWrap = v ; } } @ @ -127,8 +127,8 @ @ public abstract class GLTexture implements Disposable { this.uWrap = u ; this.vWrap = v ; bind ( ) ; - Gdx.gl.glTexParameterf ( glTarget , GL20.GL_TEXTURE_WRAP_S , u.getGLEnum ( ) ) ; - Gdx.gl.glTexParameterf ( glTarget , Request : Switch to lwjgl version 3.1.4 for next release __EoT__ Current libGDX version is using 3.1.3 . Version 3.1.4 of lwjgl supposedly fixes an important issue that affects all windows ( 10 ) users with UI scaling > 100 % ( which is probably a lot , considering high density displays are commonplace ) . This should fix the following libGDX issue : # 3813 Here 's the underlying lwjgl issue , closed via the 3.1.4 release : https : //github.com/LWJGL/lwjgl3/issues/252 I 'm happy to test a snapshot release of libgdx , if you make one !
diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java index f8500bb..d4893a9 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java @ @ -1,529 +1,530 @ @ -/******************************************************************************* - * Copyright 2011 See AUTHORS file . - * - * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - * you may not use this file except in compliance with the License . - * You may obtain a copy of the License at - * - * http : //www.apache.org/licenses/LICENSE-2.0 - * - * Unless required by applicable law or agreed to in writing , software - * distributed under the License is distributed on an `` AS IS '' BASIS , - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . - * See the License for the specific language governing permissions and - * limitations under the License . - ******************************************************************************/ - -package com.badlogic.gdx.backends.android ; - -import android.annotation.TargetApi ; -import android.app.Activity ; -import android.content.Context ; -import android.content.Intent ; -import android.content.res.Configuration ; -import android.os.Build ; -import android.os.Bundle ; -import android.os.Debug ; -import android.os.Handler ; -import android.util.Log ; -import android.view.Gravity ; -import android.view.View ; -import android.view.Window ; -import android.view.WindowManager ; -import android.widget.FrameLayout ; - -import LWJGL3 backend expose window hint auto_iconify __EoT__ I am trying to have multiple fullscreen windows on multiple displays . In GLFW , it seems the default behavior for fullscreen windows is to minimize itself when input focus is lost , for instance by clicking on another monitor 's desktop . Which breaks the ability to have multiple fullscreen windows ? GLFW documentation shows a window hint to disable this behavior : GLFW_AUTO_ICONIFY Would it be possible to add a parameter to lwjgl3 application configuration to expose this ?
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/RepeatablePolygonSprite.java b/gdx/src/com/badlogic/gdx/graphics/g2d/RepeatablePolygonSprite.java new file mode 100644 index 0000000..546ebe6 -- - /dev/null +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/RepeatablePolygonSprite.java @ @ -0,0 +1,253 @ @ +/******************************************************************************* + * Copyright 2011 See AUTHORS file . + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + ******************************************************************************/ + +package com.badlogic.gdx.graphics.g2d ; + +import com.badlogic.gdx.graphics.Color ; +import com.badlogic.gdx.graphics.g2d.PolygonSpriteBatch ; +import com.badlogic.gdx.graphics.g2d.TextureRegion ; +import com.badlogic.gdx.math . * ; +import com.badlogic.gdx.utils.Array ; +import com.badlogic.gdx.utils.ShortArray ; + +/** + * Renders polygon filled with a repeating TextureRegion with specified density + * Without causing an additional flush or render call Intersector duplicating vertices when overlapping polygon __EoT__ Intersector : ` public static boolean intersectPolygons ( Polygon p1 , Polygon p2 , Polygon overlap ) ` method is working presumably faulty for a specific scenario when intersecting polygons have exactly intersecting vertices , as a result this vertices get duplicated . Here is an example : ! [ polytestdiag ] ( https : //cloud.githubusercontent.com/assets/2115888/12695409/b3a08cbe-c766-11e5-8f26-125b3b726409.png ) The resulting overlap polygon has A and B vertices duplicated , resulting in a 10 size array of floats .
diff -- git a/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/audio/OpenALMusic.java b/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/audio/OpenALMusic.java index 39a683e..9dc5526 100644 -- - a/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/audio/OpenALMusic.java +++ b/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/audio/OpenALMusic.java @ @ -25,6 +25,8 @ @ import org.lwjgl.openal.AL11 ; import com.badlogic.gdx.audio.Music ; import com.badlogic.gdx.files.FileHandle ; import com.badlogic.gdx.math.MathUtils ; +import com.badlogic.gdx.utils.Array ; +import com.badlogic.gdx.utils.FloatArray ; import com.badlogic.gdx.utils.GdxRuntimeException ; import static org.lwjgl.openal.AL10 . * ; @ @ -36,7 +38,9 @ @ public abstract class OpenALMusic implements Music { static private final int bytesPerSample = 2 ; static private final byte [ ] tempBytes = new byte [ bufferSize ] ; static private final ByteBuffer tempBuffer = BufferUtils.createByteBuffer ( bufferSize ) ; - + + private FloatArray renderedSecondsQueue = new FloatArray ( bufferCount ) ; + private final OpenALAudio audio ; private IntBuffer buffers ; private int sourceID = -1 ; @ @ -44,7 +48,7 @ @ public abstract class OpenALMusic implements Music { private boolean isLooping , isPlaying ; private float volume = 1 ; private float pan = 0 ; - private float renderedSeconds , secondsPerBuffer ; + private float renderedSeconds , maxSecondsPerBuffer ; protected final FileHandle file ; protected int bufferOverhead = 0 ; @ @ -60,7 +64,7 @ @ public abstract class OpenALMusic implements Music { protected void setup ( int channels , int sampleRate ) Fix for getPosition ( ) on OpenALMusic __EoT__ Please ensure you have given all the following requested information in your report . # # # # Issue details After trying to sync some music on desktop , I found out that music.getPosition ( ) does not always return accurate values . This is due to the field `` renderedSeconds '' being set to 0 once there is n't data to be put on one of the buffer , even with the other two buffers still not processed . # # # # Reproduction steps/code The music being used for this example was .wav , 10s long , 16bit , 44100Hz , mono -- > 10s_2bytes_44100Hz = 882000 bytes of music . It was set to loop and , on the first loop , the method music.getPosition ( ) did not go all the way to 10s , instead only went to 9.287981859s before going back to 0 , and here is why : The class OpenALMusic uses three byte buffers of maximum size 40960 bytes each to transfer data to the audio device . In this example it is needed 21 buffers of size 40960 bytes and 1 of size
diff -- git a/gdx/src/com/badlogic/gdx/scenes/scene2d/Actor.java b/gdx/src/com/badlogic/gdx/scenes/scene2d/Actor.java index ac157ea..32b8eed 100644 -- - a/gdx/src/com/badlogic/gdx/scenes/scene2d/Actor.java +++ b/gdx/src/com/badlogic/gdx/scenes/scene2d/Actor.java @ @ -377,6 +377,21 @ @ public class Actor { this.visible = visible ; } + /** + * Check if all parent actors are visible . + * @ return true is all parents as well as the actor itself are visible . + */ + public boolean isComponentHierarchyVisible ( ) { + Actor currentParent=this ; + while ( currentParent.hasParent ( ) ) { + if ( ! currentParent.isVisible ( ) ) { + return false ; + } + currentParent=currentParent.getParent ( ) ; + } + return currentParent.isVisible ( ) ; + } + /** Returns an application specific object for convenience , or null . */ public Object getUserObject ( ) { return userObject ; diff -- git a/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/TextField.java b/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/TextField.java deleted file mode 100644 index 96e07a3..0000000 -- - a/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/TextField.java +++ /dev/null @ @ -1,1095 +0,0 @ @ -/******************************************************************************* - * Copyright 2011 See AUTHORS file . - * - * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - * you may not use this file except in compliance with the License . - * You may Pointer not always removed from 'touched ' Array in AndroidInput __EoT__ # # # # Issue details This issue can be reproduced by executing the movements below , but I 've also experienced this with far less complex movements . ( but not without using multiple fingers yet ) Basically , sometimes the pointers do n't seem to be properly removed from the touched Array in com.badlogic.gdx.backends.android.AndroidInput , resulting in Gdx.input.isTouched ( ) always returning true and the pointer id affected being stuck in the Array . This is n't an issue for projects that only detect a input once . I am however storing all touches that happened in certain areas in hashsets and check if the pointer id has been released by now before removing it from the hashset . This was an attempt for a workaround , I 've been using the touchUp method before . Pointers also get stuck on buttons , which will appear to be always hovered over . **Edit** : I have now noticed the following message in the console ; > 04-26 18:07:01.551 16133-16133/bug.report D/ViewRootImpl : [ ViewRootImpl ] action cancel - 1 , eccen:1.4761904 # # # # Reproduction steps/code I
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java index 91171a0..1253544 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java @ @ -175,8 +175,9 @ @ public class GlyphLayout implements Poolable { run.width = 0 ; width = Math.max ( width , run.x ) ; } else { - next = wrap ( fontData , run , glyphRunPool , wrapIndex , i ) ; + next = wrap ( fontData , run , glyphRunPool , halign , wrapIndex , i ) ; runs.add ( next ) ; + width = Math.max ( width , run.x + run.width ) ; } @ @ -289,7 +290,7 @ @ public class GlyphLayout implements Poolable { glyphRunPool.free ( truncateRun ) ; } - private GlyphRun wrap ( BitmapFontData fontData , GlyphRun first , Pool < GlyphRun > glyphRunPool , int wrapIndex , int widthIndex ) { + private GlyphRun wrap ( BitmapFontData fontData , GlyphRun first , Pool < GlyphRun > glyphRunPool , int halign , int wrapIndex , int widthIndex ) { GlyphRun second = glyphRunPool.obtain ( ) ; second.color.set ( first.color ) ; int glyphCount = first.glyphs.size ; @ @ -319,6 +320,34 @ @ public class GlyphLayout implements Poolable { FloatArray xAdvances2 = first.xAdvances ; // Starts with all Pointer not always removed from 'touched ' Array in AndroidInput __EoT__ # # # # Issue details This issue can be reproduced by executing the movements below , but I 've also experienced this with far less complex movements . ( but not without using multiple fingers yet ) Basically , sometimes the pointers do n't seem to be properly removed from the touched Array in com.badlogic.gdx.backends.android.AndroidInput , resulting in Gdx.input.isTouched ( ) always returning true and the pointer id affected being stuck in the Array . This is n't an issue for projects that only detect a input once . I am however storing all touches that happened in certain areas in hashsets and check if the pointer id has been released by now before removing it from the hashset . This was an attempt for a workaround , I 've been using the touchUp method before . Pointers also get stuck on buttons , which will appear to be always hovered over . **Edit** : I have now noticed the following message in the console ; > 04-26 18:07:01.551 16133-16133/bug.report D/ViewRootImpl : [ ViewRootImpl ] action cancel - 1 , eccen:1.4761904 # # # # Reproduction steps/code I
diff -- git a/extensions/gdx-setup/src/com/badlogic/gdx/setup/resources/desktop/build.gradle b/extensions/gdx-setup/src/com/badlogic/gdx/setup/resources/desktop/build.gradle index 606dc86..db4495a 100644 -- - a/extensions/gdx-setup/src/com/badlogic/gdx/setup/resources/desktop/build.gradle +++ b/extensions/gdx-setup/src/com/badlogic/gdx/setup/resources/desktop/build.gradle @ @ -1,3 +1,5 @ @ +import org.apache.tools.ant.taskdefs.condition.Os + apply plugin : `` % LANG % '' sourceCompatibility = 1.6 @ @ -12,6 +14,9 @ @ task run ( dependsOn : classes , type : JavaExec ) { standardInput = System.in workingDir = project.assetsDir ignoreExitValue = true + + if ( Os.isFamily ( Os.FAMILY_MAC ) ) + jvmArgs += `` -XstartOnFirstThread '' } task debug ( dependsOn : classes , type : JavaExec ) { Pointer not always removed from 'touched ' Array in AndroidInput __EoT__ # # # # Issue details This issue can be reproduced by executing the movements below , but I 've also experienced this with far less complex movements . ( but not without using multiple fingers yet ) Basically , sometimes the pointers do n't seem to be properly removed from the touched Array in com.badlogic.gdx.backends.android.AndroidInput , resulting in Gdx.input.isTouched ( ) always returning true and the pointer id affected being stuck in the Array . This is n't an issue for projects that only detect a input once . I am however storing all touches that happened in certain areas in hashsets and check if the pointer id has been released by now before removing it from the hashset . This was an attempt for a workaround , I 've been using the touchUp method before . Pointers also get stuck on buttons , which will appear to be always hovered over . **Edit** : I have now noticed the following message in the console ; > 04-26 18:07:01.551 16133-16133/bug.report D/ViewRootImpl : [ ViewRootImpl ] action cancel - 1 , eccen:1.4761904 # # # # Reproduction steps/code I
diff -- git a/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SplitPane.java b/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SplitPane.java index 9763be9..430f493 100644 -- - a/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SplitPane.java +++ b/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/SplitPane.java @ @ -50,6 +50,7 @ @ public class SplitPane extends WidgetGroup { private Rectangle firstWidgetBounds = new Rectangle ( ) ; private Rectangle secondWidgetBounds = new Rectangle ( ) ; Rectangle handleBounds = new Rectangle ( ) ; + boolean cursorOverHandle ; private Rectangle tempScissors = new Rectangle ( ) ; Vector2 lastPoint = new Vector2 ( ) ; @ @ -123,6 +124,11 @ @ public class SplitPane extends WidgetGroup { } invalidate ( ) ; } + + public boolean mouseMoved ( InputEvent event , float x , float y ) { + cursorOverHandle = handleBounds.contains ( x , y ) ; + return false ; + } } ) ; } @ @ -378,6 +384,10 @ @ public class SplitPane extends WidgetGroup { } return false ; } + + public boolean isCursorOverHandle ( ) { + return cursorOverHandle ; + } /** The style for a splitpane , see { @ link SplitPane } . * @ author mzechner Pointer not always removed from 'touched ' Array in AndroidInput __EoT__ # # # # Issue details This issue can be reproduced by executing the movements below , but I 've also experienced this with far less complex movements . ( but not without using multiple fingers yet ) Basically , sometimes the pointers do n't seem to be properly removed from the touched Array in com.badlogic.gdx.backends.android.AndroidInput , resulting in Gdx.input.isTouched ( ) always returning true and the pointer id affected being stuck in the Array . This is n't an issue for projects that only detect a input once . I am however storing all touches that happened in certain areas in hashsets and check if the pointer id has been released by now before removing it from the hashset . This was an attempt for a workaround , I 've been using the touchUp method before . Pointers also get stuck on buttons , which will appear to be always hovered over . **Edit** : I have now noticed the following message in the console ; > 04-26 18:07:01.551 16133-16133/bug.report D/ViewRootImpl : [ ViewRootImpl ] action cancel - 1 , eccen:1.4761904 # # # # Reproduction steps/code I
diff -- git a/CHANGES b/CHANGES index ace0a15..0537b3e 100755 -- - a/CHANGES +++ b/CHANGES @ @ -8,6 +8,7 @ @ - SkinLoader can be used on subclasses of Skin by overriding generateSkin ( ) . - API addition : Tree indentation can be customized . - Fixed GlyphLayout not respecting BitmapFontData # down . +- API Addition : Added FileHandle # map ( ) , can be used to memory map a file [ 1.9.8 ] - Add iPhoneX images diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java index 1eb4142..6328680 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java @ @ -18,9 +18,13 @ @ package com.badlogic.gdx.backends.android ; import java.io.File ; import java.io.FileFilter ; +import java.io.FileInputStream ; import java.io.FilenameFilter ; import java.io.IOException ; import java.io.InputStream ; +import java.nio.ByteBuffer ; +import java.nio.ByteOrder ; +import java.nio.channels.FileChannel ; import android.content.res.AssetFileDescriptor ; import android.content.res.AssetManager ; @ @ -29,6 +33,7 @ @ import com.badlogic.gdx.Files.FileType ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.files.FileHandle ; import com.badlogic.gdx.utils.GdxRuntimeException ; +import com.badlogic.gdx.utils.StreamUtils ; /** @ author mzechner * @ author Nathan Sweet */ @ @ -80,6 +85,24 @ @ public class AndroidFileHandle extends FileHandle { return super.read ( ) ; } + public ByteBuffer map ( FileChannel.MapMode mode ) { + if ( type == FileType.Internal ) { Pointer not always removed from 'touched ' Array in AndroidInput __EoT__ # # # # Issue details This issue can be reproduced by executing the movements below , but I 've also experienced this with far less complex movements . ( but not without using multiple fingers yet ) Basically , sometimes the pointers do n't seem to be properly removed from the touched Array in com.badlogic.gdx.backends.android.AndroidInput , resulting in Gdx.input.isTouched ( ) always returning true and the pointer id affected being stuck in the Array . This is n't an issue for projects that only detect a input once . I am however storing all touches that happened in certain areas in hashsets and check if the pointer id has been released by now before removing it from the hashset . This was an attempt for a workaround , I 've been using the touchUp method before . Pointers also get stuck on buttons , which will appear to be always hovered over . **Edit** : I have now noticed the following message in the console ; > 04-26 18:07:01.551 16133-16133/bug.report D/ViewRootImpl : [ ViewRootImpl ] action cancel - 1 , eccen:1.4761904 # # # # Reproduction steps/code I
diff -- git a/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java b/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java index 548a3dd..23bd82c 100644 -- - a/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java +++ b/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java @ @ -38,6 +38,11 @ @ import com.badlogic.gdx.utils.reflect.ClassReflection ; public class Controllers { private static final String TAG = `` Controllers '' ; static final ObjectMap < Application , ControllerManager > managers = new ObjectMap < Application , ControllerManager > ( ) ; + /** + * The class name of a preferred { @ link ControllerManager } . If this is null then an appropriate ControllerManager will + * automatically be selected . This must be set before any controllers or managers are found . + */ + public static String preferredManager = null ; /** Returns an array of connected { @ link Controller } instances . This method should only be called on the rendering thread . * @ @ -85,7 +90,9 @ @ public class Controllers { ApplicationType type = Gdx.app.getType ( ) ; ControllerManager manager = null ; - if ( type == ApplicationType.Android ) { + if ( preferredManager ! = null ) { + className = preferredManager ; + } else if ( type == ApplicationType.Android ) { if ( Gdx.app.getVersion ( ) > = 12 ) { className = Pointer not always removed from 'touched ' Array in AndroidInput __EoT__ # # # # Issue details This issue can be reproduced by executing the movements below , but I 've also experienced this with far less complex movements . ( but not without using multiple fingers yet ) Basically , sometimes the pointers do n't seem to be properly removed from the touched Array in com.badlogic.gdx.backends.android.AndroidInput , resulting in Gdx.input.isTouched ( ) always returning true and the pointer id affected being stuck in the Array . This is n't an issue for projects that only detect a input once . I am however storing all touches that happened in certain areas in hashsets and check if the pointer id has been released by now before removing it from the hashset . This was an attempt for a workaround , I 've been using the touchUp method before . Pointers also get stuck on buttons , which will appear to be always hovered over . **Edit** : I have now noticed the following message in the console ; > 04-26 18:07:01.551 16133-16133/bug.report D/ViewRootImpl : [ ViewRootImpl ] action cancel - 1 , eccen:1.4761904 # # # # Reproduction steps/code I
diff -- git a/gdx/src/com/badlogic/gdx/scenes/scene2d/Stage.java b/gdx/src/com/badlogic/gdx/scenes/scene2d/Stage.java index 2e9ba21..dcc4f5a 100644 -- - a/gdx/src/com/badlogic/gdx/scenes/scene2d/Stage.java +++ b/gdx/src/com/badlogic/gdx/scenes/scene2d/Stage.java @ @ -40,6 +40,7 @ @ import com.badlogic.gdx.scenes.scene2d.utils.FocusListener.FocusEvent ; import com.badlogic.gdx.scenes.scene2d.utils.ScissorStack ; import com.badlogic.gdx.utils.Array ; import com.badlogic.gdx.utils.Disposable ; +import com.badlogic.gdx.utils.GdxRuntimeException ; import com.badlogic.gdx.utils.Pool.Poolable ; import com.badlogic.gdx.utils.Pools ; import com.badlogic.gdx.utils.Scaling ; @ @ -86,6 +87,8 @ @ public class Stage extends InputAdapter implements Disposable { private Debug debugTableUnderMouse = Debug.none ; private final Color debugColor = new Color ( 0 , 1 , 0 , 0.85f ) ; + public Exception lastException ; + /** Creates a stage with a { @ link ScalingViewport } set to { @ link Scaling # stretch } . The stage will use its own { @ link Batch } * which will be disposed when the stage is disposed . */ public Stage ( ) { @ @ -126,9 +129,18 @ @ public class Stage extends InputAdapter implements Disposable { batch.setProjectionMatrix ( camera.combined ) ; batch.begin ( ) ; try { + lastException = null ; root.draw ( batch , 1 ) ; + } catch ( Exception e ) { + lastException = e ; + throw new GdxRuntimeException ( e ) ; } finally { - batch.end ( ) Pointer not always removed from 'touched ' Array in AndroidInput __EoT__ # # # # Issue details This issue can be reproduced by executing the movements below , but I 've also experienced this with far less complex movements . ( but not without using multiple fingers yet ) Basically , sometimes the pointers do n't seem to be properly removed from the touched Array in com.badlogic.gdx.backends.android.AndroidInput , resulting in Gdx.input.isTouched ( ) always returning true and the pointer id affected being stuck in the Array . This is n't an issue for projects that only detect a input once . I am however storing all touches that happened in certain areas in hashsets and check if the pointer id has been released by now before removing it from the hashset . This was an attempt for a workaround , I 've been using the touchUp method before . Pointers also get stuck on buttons , which will appear to be always hovered over . **Edit** : I have now noticed the following message in the console ; > 04-26 18:07:01.551 16133-16133/bug.report D/ViewRootImpl : [ ViewRootImpl ] action cancel - 1 , eccen:1.4761904 # # # # Reproduction steps/code I
diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java index f8500bb..f12d8d2 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java @ @ -25,7 +25,6 @ @ import android.os.Build ; import android.os.Bundle ; import android.os.Debug ; import android.os.Handler ; -import android.util.Log ; import android.view.Gravity ; import android.view.View ; import android.view.Window ; @ @ -39,7 +38,6 @ @ import com.badlogic.gdx.Audio ; import com.badlogic.gdx.Files ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.Graphics ; -import com.badlogic.gdx.Input ; import com.badlogic.gdx.LifecycleListener ; import com.badlogic.gdx.Net ; import com.badlogic.gdx.Preferences ; @ @ -51,7 +49,6 @ @ import com.badlogic.gdx.utils.GdxRuntimeException ; import com.badlogic.gdx.utils.SnapshotArray ; import java.lang.reflect.Method ; -import java.util.Arrays ; /** An implementation of the { @ link Application } interface for Android . Create an { @ link Activity } that derives from this class . In * the { @ link Activity # onCreate ( Bundle ) } method call the { @ link # initialize ( ApplicationListener ) } method specifying the @ @ -198,6 +195,10 @ @ public class AndroidApplication extends Activity implements AndroidApplicationBa log ( `` AndroidApplication '' , `` Failed to create AndroidVisibilityListener '' , e ) ; } } + + // detect an already connected bluetooth keyboardAvailable + if ( getResources ( ) .getConfiguration ( ) .keyboard ! = Configuration.KEYBOARD_NOKEYS ) Pointer not always removed from 'touched ' Array in AndroidInput __EoT__ # # # # Issue details This issue can be reproduced by executing the movements below , but I 've also experienced this with far less complex movements . ( but not without using multiple fingers yet ) Basically , sometimes the pointers do n't seem to be properly removed from the touched Array in com.badlogic.gdx.backends.android.AndroidInput , resulting in Gdx.input.isTouched ( ) always returning true and the pointer id affected being stuck in the Array . This is n't an issue for projects that only detect a input once . I am however storing all touches that happened in certain areas in hashsets and check if the pointer id has been released by now before removing it from the hashset . This was an attempt for a workaround , I 've been using the touchUp method before . Pointers also get stuck on buttons , which will appear to be always hovered over . **Edit** : I have now noticed the following message in the console ; > 04-26 18:07:01.551 16133-16133/bug.report D/ViewRootImpl : [ ViewRootImpl ] action cancel - 1 , eccen:1.4761904 # # # # Reproduction steps/code I
diff -- git a/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/TextArea.java b/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/TextArea.java index 8179aed..4d71a66 100644 -- - a/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/TextArea.java +++ b/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/TextArea.java @ @ -86,7 +86,7 @ @ public class TextArea extends TextField { x += glyphPositions [ start ] ; int end = linesBreak.items [ cursorLine * 2 + 1 ] ; int i = start ; - for ( ; i < = end ; i++ ) + for ( ; i < end ; i++ ) if ( glyphPositions [ i ] > x ) break ; if ( glyphPositions [ i ] - x < = x - glyphPositions [ i - 1 ] ) return i ; return Math.max ( 0 , i - 1 ) ; diff -- git a/tests/gdx-tests/src/com/badlogic/gdx/tests/TextAreaTest2.java b/tests/gdx-tests/src/com/badlogic/gdx/tests/TextAreaTest2.java new file mode 100644 index 0000000..d78aa91 -- - /dev/null +++ b/tests/gdx-tests/src/com/badlogic/gdx/tests/TextAreaTest2.java @ @ -0,0 +1,79 @ @ +/******************************************************************************* + * Copyright 2011 See AUTHORS file . + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * TextArea assumes Raw Array is bigger than FloatArray __EoT__ # # # # Issue details During development and debugging a different issue ( on my my side ) I came across the following issue : The TextArea class assumes that the raw backing array of FloatArray is bigger than the actual used data . When filling the text area with x amount of characters the letterUnderCursor method ( TextArea:90 ) will cause an ArrayOutOfBoundsException because of this . ( this method wrongly assumes the backing array is bigger ) . # # # # Reproduction steps/code Compile and run the code below ; then click just anywhere on the right side of the text ( but inside the text area ) . This will cause the TextArea to throw a ArrayIndexOutOfBoundsException . Note : The code snippet below is based upon the TextAreaTest class ( in gidx-tests ) . `` ` java /******************************************************************************* * Copyright 2011 See AUTHORS file . * * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; * you may not use this file except in compliance with the License . * You may obtain a copy of the License
diff -- git a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeType.java b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeType.java index 33a74c1..7980871 100644 -- - a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeType.java +++ b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeType.java @ @ -67,7 +67,8 @ @ public class FreeType { public void dispose ( ) { doneFreeType ( address ) ; for ( ByteBuffer buffer : fontData.values ( ) ) { - BufferUtils.disposeUnsafeByteBuffer ( buffer ) ; + if ( BufferUtils.isUnsafeByteBuffer ( buffer ) ) + BufferUtils.disposeUnsafeByteBuffer ( buffer ) ; } } @ @ -139,7 +140,8 @ @ public class FreeType { ByteBuffer buffer = library.fontData.get ( address ) ; if ( buffer ! = null ) { library.fontData.remove ( address ) ; - BufferUtils.disposeUnsafeByteBuffer ( buffer ) ; + if ( BufferUtils.isUnsafeByteBuffer ( buffer ) ) + BufferUtils.disposeUnsafeByteBuffer ( buffer ) ; } } diff -- git a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java index 813469a..dbda8e2 100755 -- - a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java +++ b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java @ @ -99,23 +99,32 @ @ public class FreeTypeFontGenerator implements Disposable { library = FreeType.initFreeType ( ) ; if ( library == null ) throw new GdxRuntimeException ( `` Could n't initialize FreeType '' ) ; - ByteBuffer buffer ; - InputStream input = fontFile.read ( ) ; + ByteBuffer buffer = null ; + try { - if ( fileSize == 0 ) { - // Copy Color markup causes text to be display in wrong position , and does not escape properly __EoT__ # # # # Issue details When using color markup , each subsequent block after a colored block is offset to the left compared to unstyled text . Additionally , the markup escape code ` [ [ ` does not correctly cause the markup to be ignored if a closing bracket follows after a word which happens to be a valid color . ! [ libgdxcolormarkup ] ( https : //cloud.githubusercontent.com/assets/1232124/16882909/68a9b026-4a8f-11e6-9150-241e3017b3b8.png ) # # # # Reproduction steps/code `` ` java import com.badlogic.gdx.ApplicationAdapter ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.backends.lwjgl.LwjglApplication ; import com.badlogic.gdx.graphics.Color ; import com.badlogic.gdx.graphics.GL20 ; import com.badlogic.gdx.graphics.g2d.BitmapFont ; import com.badlogic.gdx.graphics.g2d.SpriteBatch ; public class ColorRenderingMain extends ApplicationAdapter { static final String TEXT_PLAIN = `` AAA BBB CCC DDD EEE '' ; static final String TEXT_COLOR = `` [ RED ] AAA [ BLUE ] BBB [ RED ] CCC [ BLUE ] DDD [ RED ] EEE '' ; static final String TEXT_ESCAPE = `` [ [ ORANGE ] Escaped , but is colored '' ; SpriteBatch batch ; BitmapFont font ; public void create ( ) { batch = new SpriteBatch (
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java index 91171a0..dab06b8 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java @ @ -177,6 +177,14 @ @ public class GlyphLayout implements Poolable { } else { next = wrap ( fontData , run , glyphRunPool , wrapIndex , i ) ; runs.add ( next ) ; + + // Remove whitespace at the end of the run after wrap + if ( fontData.isWhitespace ( ( char ) run.glyphs.peek ( ) .id ) ) { + run.glyphs.pop ( ) ; + float removedXAdvance = run.xAdvances.pop ( ) ; + run.width -= removedXAdvance ; + } + width = Math.max ( width , run.x + run.width ) ; } Color markup causes text to be display in wrong position , and does not escape properly __EoT__ # # # # Issue details When using color markup , each subsequent block after a colored block is offset to the left compared to unstyled text . Additionally , the markup escape code ` [ [ ` does not correctly cause the markup to be ignored if a closing bracket follows after a word which happens to be a valid color . ! [ libgdxcolormarkup ] ( https : //cloud.githubusercontent.com/assets/1232124/16882909/68a9b026-4a8f-11e6-9150-241e3017b3b8.png ) # # # # Reproduction steps/code `` ` java import com.badlogic.gdx.ApplicationAdapter ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.backends.lwjgl.LwjglApplication ; import com.badlogic.gdx.graphics.Color ; import com.badlogic.gdx.graphics.GL20 ; import com.badlogic.gdx.graphics.g2d.BitmapFont ; import com.badlogic.gdx.graphics.g2d.SpriteBatch ; public class ColorRenderingMain extends ApplicationAdapter { static final String TEXT_PLAIN = `` AAA BBB CCC DDD EEE '' ; static final String TEXT_COLOR = `` [ RED ] AAA [ BLUE ] BBB [ RED ] CCC [ BLUE ] DDD [ RED ] EEE '' ; static final String TEXT_ESCAPE = `` [ [ ORANGE ] Escaped , but is colored '' ; SpriteBatch batch ; BitmapFont font ; public void create ( ) { batch = new SpriteBatch (
diff -- git a/gdx/src/com/badlogic/gdx/utils/PropertiesUtils.java b/gdx/src/com/badlogic/gdx/utils/PropertiesUtils.java index 4557edd..6f044b7 100644 -- - a/gdx/src/com/badlogic/gdx/utils/PropertiesUtils.java +++ b/gdx/src/com/badlogic/gdx/utils/PropertiesUtils.java @ @ -44,7 +44,7 @ @ public final class PropertiesUtils { * compatible with < code > java.util.Properties < /code > . * < p > * The input stream remains open after this method returns . - * + * * @ param properties the map to be filled . * @ param reader the input character stream reader . * @ throws IOException if an error occurred when reading from the input stream . @ @ -221,7 +221,7 @ @ public final class PropertiesUtils { * < code > = < /code > , and < code > : < /code > are written with a preceding backslash to ensure that they are properly loaded . * < p > * After the entries have been written , the output stream is flushed . The output stream remains open after this method returns . - * + * * @ param properties the { @ code ObjectMap } . * @ param writer an output character stream writer . * @ param comment an optional comment to be written , or null . @ @ Color markup causes text to be display in wrong position , and does not escape properly __EoT__ # # # # Issue details When using color markup , each subsequent block after a colored block is offset to the left compared to unstyled text . Additionally , the markup escape code ` [ [ ` does not correctly cause the markup to be ignored if a closing bracket follows after a word which happens to be a valid color . ! [ libgdxcolormarkup ] ( https : //cloud.githubusercontent.com/assets/1232124/16882909/68a9b026-4a8f-11e6-9150-241e3017b3b8.png ) # # # # Reproduction steps/code `` ` java import com.badlogic.gdx.ApplicationAdapter ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.backends.lwjgl.LwjglApplication ; import com.badlogic.gdx.graphics.Color ; import com.badlogic.gdx.graphics.GL20 ; import com.badlogic.gdx.graphics.g2d.BitmapFont ; import com.badlogic.gdx.graphics.g2d.SpriteBatch ; public class ColorRenderingMain extends ApplicationAdapter { static final String TEXT_PLAIN = `` AAA BBB CCC DDD EEE '' ; static final String TEXT_COLOR = `` [ RED ] AAA [ BLUE ] BBB [ RED ] CCC [ BLUE ] DDD [ RED ] EEE '' ; static final String TEXT_ESCAPE = `` [ [ ORANGE ] Escaped , but is colored '' ; SpriteBatch batch ; BitmapFont font ; public void create ( ) { batch = new SpriteBatch (
diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java index 12afc86..ceac630 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java @ @ -22,8 +22,8 @ @ import java.io.FileInputStream ; import java.io.FilenameFilter ; import java.io.IOException ; import java.io.InputStream ; +import java.nio.ByteBuffer ; import java.nio.ByteOrder ; -import java.nio.MappedByteBuffer ; import java.nio.channels.FileChannel ; import android.content.res.AssetFileDescriptor ; @ @ -85,7 +85,7 @ @ public class AndroidFileHandle extends FileHandle { return super.read ( ) ; } - public MappedByteBuffer map ( FileChannel.MapMode mode ) { + public ByteBuffer map ( FileChannel.MapMode mode ) { if ( type == FileType.Internal ) { FileInputStream input = null ; try { @ @ -93,7 +93,7 @ @ public class AndroidFileHandle extends FileHandle { long startOffset = fd.getStartOffset ( ) ; long declaredLength = fd.getDeclaredLength ( ) ; input = new FileInputStream ( fd.getFileDescriptor ( ) ) ; - MappedByteBuffer map = input.getChannel ( ) .map ( mode , startOffset , declaredLength ) ; + ByteBuffer map = input.getChannel ( ) .map ( mode , startOffset , declaredLength ) ; map.order ( ByteOrder.nativeOrder ( ) ) ; return map ; } catch ( Exception ex ) { diff -- git a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtFileHandle.java b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtFileHandle.java index d8a96b5..c6844c5 100644 -- - a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtFileHandle.java +++ b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtFileHandle.java @ @ -28,7 +28,7 @ @ Color markup causes text to be display in wrong position , and does not escape properly __EoT__ # # # # Issue details When using color markup , each subsequent block after a colored block is offset to the left compared to unstyled text . Additionally , the markup escape code ` [ [ ` does not correctly cause the markup to be ignored if a closing bracket follows after a word which happens to be a valid color . ! [ libgdxcolormarkup ] ( https : //cloud.githubusercontent.com/assets/1232124/16882909/68a9b026-4a8f-11e6-9150-241e3017b3b8.png ) # # # # Reproduction steps/code `` ` java import com.badlogic.gdx.ApplicationAdapter ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.backends.lwjgl.LwjglApplication ; import com.badlogic.gdx.graphics.Color ; import com.badlogic.gdx.graphics.GL20 ; import com.badlogic.gdx.graphics.g2d.BitmapFont ; import com.badlogic.gdx.graphics.g2d.SpriteBatch ; public class ColorRenderingMain extends ApplicationAdapter { static final String TEXT_PLAIN = `` AAA BBB CCC DDD EEE '' ; static final String TEXT_COLOR = `` [ RED ] AAA [ BLUE ] BBB [ RED ] CCC [ BLUE ] DDD [ RED ] EEE '' ; static final String TEXT_ESCAPE = `` [ [ ORANGE ] Escaped , but is colored '' ; SpriteBatch batch ; BitmapFont font ; public void create ( ) { batch = new SpriteBatch (
diff -- git a/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSApplicationConfiguration.java b/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSApplicationConfiguration.java index 0653733..67d70ef 100644 -- - a/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSApplicationConfiguration.java +++ b/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSApplicationConfiguration.java @ @ -20,6 +20,7 @ @ import org.robovm.apple.glkit.GLKViewDrawableColorFormat ; import org.robovm.apple.glkit.GLKViewDrawableDepthFormat ; import org.robovm.apple.glkit.GLKViewDrawableMultisample ; import org.robovm.apple.glkit.GLKViewDrawableStencilFormat ; +import org.robovm.apple.uikit.UIRectEdge ; public class IOSApplicationConfiguration { /** whether to enable screen dimming . */ @ @ -100,4 +101,8 @ @ public class IOSApplicationConfiguration { /** Whether to override the ringer/mute switch , see https : //github.com/libgdx/libgdx/issues/4430 */ public boolean overrideRingerSwitch = false ; + + /** Edges where app gestures must be fired over system gestures . + * Prior to iOS 11 , UIRectEdge.All was default behaviour if status bar hidden , see https : //github.com/libgdx/libgdx/issues/5110 **/ + public UIRectEdge screenEdgesDeferringSystemGestures = UIRectEdge.None ; } diff -- git a/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSGraphics.java b/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSGraphics.java index c6d9e29..d202953 100644 -- - a/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSGraphics.java +++ b/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSGraphics.java @ @ -17,7 +17,18 @ @ package com.badlogic.gdx.backends.iosrobovm ; import com.badlogic.gdx.Application ; +import com.badlogic.gdx.Gdx ; +import com.badlogic.gdx.Graphics ; +import com.badlogic.gdx.LifecycleListener ; +import com.badlogic.gdx.backends.iosrobovm.custom.HWMachine ; +import com.badlogic.gdx.graphics.Cursor ; +import com.badlogic.gdx.graphics.Cursor.SystemCursor ; +import com.badlogic.gdx.graphics.GL20 ; +import com.badlogic.gdx.graphics.GL30 ; +import com.badlogic.gdx.graphics.Pixmap ; import com.badlogic.gdx.graphics.glutils.GLVersion ; +import com.badlogic.gdx.utils.Array ; + import org.robovm.apple.coregraphics.CGRect ; import org.robovm.apple.foundation.NSObject ; import org.robovm.apple.glkit.GLKView ; @ @ -33,23 +44,13 @ @ import org.robovm.apple.opengles.EAGLRenderingAPI ; import org.robovm.apple.uikit.UIEvent ; import org.robovm.apple.uikit.UIInterfaceOrientation Color markup causes text to be display in wrong position , and does not escape properly __EoT__ # # # # Issue details When using color markup , each subsequent block after a colored block is offset to the left compared to unstyled text . Additionally , the markup escape code ` [ [ ` does not correctly cause the markup to be ignored if a closing bracket follows after a word which happens to be a valid color . ! [ libgdxcolormarkup ] ( https : //cloud.githubusercontent.com/assets/1232124/16882909/68a9b026-4a8f-11e6-9150-241e3017b3b8.png ) # # # # Reproduction steps/code `` ` java import com.badlogic.gdx.ApplicationAdapter ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.backends.lwjgl.LwjglApplication ; import com.badlogic.gdx.graphics.Color ; import com.badlogic.gdx.graphics.GL20 ; import com.badlogic.gdx.graphics.g2d.BitmapFont ; import com.badlogic.gdx.graphics.g2d.SpriteBatch ; public class ColorRenderingMain extends ApplicationAdapter { static final String TEXT_PLAIN = `` AAA BBB CCC DDD EEE '' ; static final String TEXT_COLOR = `` [ RED ] AAA [ BLUE ] BBB [ RED ] CCC [ BLUE ] DDD [ RED ] EEE '' ; static final String TEXT_ESCAPE = `` [ [ ORANGE ] Escaped , but is colored '' ; SpriteBatch batch ; BitmapFont font ; public void create ( ) { batch = new SpriteBatch (
diff -- git a/CHANGES b/CHANGES index 3e20ae1..ace0a15 100755 -- - a/CHANGES +++ b/CHANGES @ @ -3,6 +3,9 @ @ - Update to Lwjgl 3.1.4 - Update android level we build against to 7.1 ( API 25 ) - API Change : gdx-tools no longer bundles dependencies to be compatible with java 9 +- Skin JSON files can now use the simple names of classes , i.e . `` BitmapFont '' rather than `` com.badlogic.gdx.graphics.g2d.BitmapFont '' . Custom classes can be added by overriding Skin.getJsonLoader ( ) and calling json.setClassTag ( ) . +- Skin supports cascading styles in JSON . Use the `` parent '' property to tag another style by name to use its values as defaults . See https : //github.com/libgdx/libgdx/blob/master/tests/gdx-tests-android/assets/data/uiskin.json for example . +- SkinLoader can be used on subclasses of Skin by overriding generateSkin ( ) . - API addition : Tree indentation can be customized . - Fixed GlyphLayout not respecting BitmapFontData # down . Color markup causes text to be display in wrong position , and does not escape properly __EoT__ # # # # Issue details When using color markup , each subsequent block after a colored block is offset to the left compared to unstyled text . Additionally , the markup escape code ` [ [ ` does not correctly cause the markup to be ignored if a closing bracket follows after a word which happens to be a valid color . ! [ libgdxcolormarkup ] ( https : //cloud.githubusercontent.com/assets/1232124/16882909/68a9b026-4a8f-11e6-9150-241e3017b3b8.png ) # # # # Reproduction steps/code `` ` java import com.badlogic.gdx.ApplicationAdapter ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.backends.lwjgl.LwjglApplication ; import com.badlogic.gdx.graphics.Color ; import com.badlogic.gdx.graphics.GL20 ; import com.badlogic.gdx.graphics.g2d.BitmapFont ; import com.badlogic.gdx.graphics.g2d.SpriteBatch ; public class ColorRenderingMain extends ApplicationAdapter { static final String TEXT_PLAIN = `` AAA BBB CCC DDD EEE '' ; static final String TEXT_COLOR = `` [ RED ] AAA [ BLUE ] BBB [ RED ] CCC [ BLUE ] DDD [ RED ] EEE '' ; static final String TEXT_ESCAPE = `` [ [ ORANGE ] Escaped , but is colored '' ; SpriteBatch batch ; BitmapFont font ; public void create ( ) { batch = new SpriteBatch (
diff -- git a/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/audio/Wav.java b/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/audio/Wav.java index 5008635..4819fc9 100644 -- - a/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/audio/Wav.java +++ b/backends/gdx-backend-lwjgl/src/com/badlogic/gdx/backends/lwjgl/audio/Wav.java @ @ -157,10 +157,17 @ @ public class Wav { public int read ( byte [ ] buffer ) throws IOException { if ( dataRemaining == 0 ) return -1 ; - int length = Math.min ( super.read ( buffer ) , dataRemaining ) ; - if ( length == -1 ) return -1 ; - dataRemaining -= length ; - return length ; + int offset = 0 ; + do { + int length = Math.min ( super.read ( buffer , offset , buffer.length - offset ) , dataRemaining ) ; + if ( length == -1 ) { + if ( offset > 0 ) return offset ; + return -1 ; + } + offset += length ; + dataRemaining -= length ; + } while ( offset < buffer.length ) ; + return offset ; } } } diff -- git a/backends/gdx-backend-lwjgl3/src/com/badlogic/gdx/backends/lwjgl3/audio/Wav.java b/backends/gdx-backend-lwjgl3/src/com/badlogic/gdx/backends/lwjgl3/audio/Wav.java index bbe97e8..e7dafca 100644 -- - a/backends/gdx-backend-lwjgl3/src/com/badlogic/gdx/backends/lwjgl3/audio/Wav.java +++ b/backends/gdx-backend-lwjgl3/src/com/badlogic/gdx/backends/lwjgl3/audio/Wav.java @ @ -133,10 +133,17 @ @ public class Wav { public int read ( byte [ ] buffer ) throws IOException { if ( dataRemaining == 0 ) return -1 ; Color markup causes text to be display in wrong position , and does not escape properly __EoT__ # # # # Issue details When using color markup , each subsequent block after a colored block is offset to the left compared to unstyled text . Additionally , the markup escape code ` [ [ ` does not correctly cause the markup to be ignored if a closing bracket follows after a word which happens to be a valid color . ! [ libgdxcolormarkup ] ( https : //cloud.githubusercontent.com/assets/1232124/16882909/68a9b026-4a8f-11e6-9150-241e3017b3b8.png ) # # # # Reproduction steps/code `` ` java import com.badlogic.gdx.ApplicationAdapter ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.backends.lwjgl.LwjglApplication ; import com.badlogic.gdx.graphics.Color ; import com.badlogic.gdx.graphics.GL20 ; import com.badlogic.gdx.graphics.g2d.BitmapFont ; import com.badlogic.gdx.graphics.g2d.SpriteBatch ; public class ColorRenderingMain extends ApplicationAdapter { static final String TEXT_PLAIN = `` AAA BBB CCC DDD EEE '' ; static final String TEXT_COLOR = `` [ RED ] AAA [ BLUE ] BBB [ RED ] CCC [ BLUE ] DDD [ RED ] EEE '' ; static final String TEXT_ESCAPE = `` [ [ ORANGE ] Escaped , but is colored '' ; SpriteBatch batch ; BitmapFont font ; public void create ( ) { batch = new SpriteBatch (
diff -- git a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplicationLogger.java b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplicationLogger.java index ae74e41..b2df712 100644 -- - a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplicationLogger.java +++ b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplicationLogger.java @ @ -101,20 +101,20 @ @ public class GwtApplicationLogger implements ApplicationLogger { } private String getMessages ( Throwable e ) { - StringBuffer buffer = new StringBuffer ( ) ; + StringBuilder sb = new StringBuilder ( ) ; while ( e ! = null ) { - buffer.append ( e.getMessage ( ) + `` \n '' ) ; + sb.append ( e.getMessage ( ) + `` \n '' ) ; e = e.getCause ( ) ; } - return buffer.toString ( ) ; + return sb.toString ( ) ; } private String getStackTrace ( Throwable e ) { - StringBuffer buffer = new StringBuffer ( ) ; + StringBuilder sb = new StringBuilder ( ) ; for ( StackTraceElement trace : e.getStackTrace ( ) ) { - buffer.append ( trace.toString ( ) + `` \n '' ) ; + sb.append ( trace.toString ( ) + `` \n '' ) ; } - return buffer.toString ( ) ; + return sb.toString ( ) ; } } diff -- git a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/emu/com/badlogic/gdx/graphics/profiling/GLErrorListener.java b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/emu/com/badlogic/gdx/graphics/profiling/GLErrorListener.java index 99c91d0..5c39fe9 100644 -- - a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/emu/com/badlogic/gdx/graphics/profiling/GLErrorListener.java +++ b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/emu/com/badlogic/gdx/graphics/profiling/GLErrorListener.java @ @ -54,18 +54,18 @ @ public interface Color markup causes text to be display in wrong position , and does not escape properly __EoT__ # # # # Issue details When using color markup , each subsequent block after a colored block is offset to the left compared to unstyled text . Additionally , the markup escape code ` [ [ ` does not correctly cause the markup to be ignored if a closing bracket follows after a word which happens to be a valid color . ! [ libgdxcolormarkup ] ( https : //cloud.githubusercontent.com/assets/1232124/16882909/68a9b026-4a8f-11e6-9150-241e3017b3b8.png ) # # # # Reproduction steps/code `` ` java import com.badlogic.gdx.ApplicationAdapter ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.backends.lwjgl.LwjglApplication ; import com.badlogic.gdx.graphics.Color ; import com.badlogic.gdx.graphics.GL20 ; import com.badlogic.gdx.graphics.g2d.BitmapFont ; import com.badlogic.gdx.graphics.g2d.SpriteBatch ; public class ColorRenderingMain extends ApplicationAdapter { static final String TEXT_PLAIN = `` AAA BBB CCC DDD EEE '' ; static final String TEXT_COLOR = `` [ RED ] AAA [ BLUE ] BBB [ RED ] CCC [ BLUE ] DDD [ RED ] EEE '' ; static final String TEXT_ESCAPE = `` [ [ ORANGE ] Escaped , but is colored '' ; SpriteBatch batch ; BitmapFont font ; public void create ( ) { batch = new SpriteBatch (
diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java index f8500bb..d4893a9 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java @ @ -1,529 +1,530 @ @ -/******************************************************************************* - * Copyright 2011 See AUTHORS file . - * - * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - * you may not use this file except in compliance with the License . - * You may obtain a copy of the License at - * - * http : //www.apache.org/licenses/LICENSE-2.0 - * - * Unless required by applicable law or agreed to in writing , software - * distributed under the License is distributed on an `` AS IS '' BASIS , - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . - * See the License for the specific language governing permissions and - * limitations under the License . - ******************************************************************************/ - -package com.badlogic.gdx.backends.android ; - -import android.annotation.TargetApi ; -import android.app.Activity ; -import android.content.Context ; -import android.content.Intent ; -import android.content.res.Configuration ; -import android.os.Build ; -import android.os.Bundle ; -import android.os.Debug ; -import android.os.Handler ; -import android.util.Log ; -import android.view.Gravity ; -import android.view.View ; -import android.view.Window ; -import android.view.WindowManager ; -import android.widget.FrameLayout ; - -import Color markup causes text to be display in wrong position , and does not escape properly __EoT__ # # # # Issue details When using color markup , each subsequent block after a colored block is offset to the left compared to unstyled text . Additionally , the markup escape code ` [ [ ` does not correctly cause the markup to be ignored if a closing bracket follows after a word which happens to be a valid color . ! [ libgdxcolormarkup ] ( https : //cloud.githubusercontent.com/assets/1232124/16882909/68a9b026-4a8f-11e6-9150-241e3017b3b8.png ) # # # # Reproduction steps/code `` ` java import com.badlogic.gdx.ApplicationAdapter ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.backends.lwjgl.LwjglApplication ; import com.badlogic.gdx.graphics.Color ; import com.badlogic.gdx.graphics.GL20 ; import com.badlogic.gdx.graphics.g2d.BitmapFont ; import com.badlogic.gdx.graphics.g2d.SpriteBatch ; public class ColorRenderingMain extends ApplicationAdapter { static final String TEXT_PLAIN = `` AAA BBB CCC DDD EEE '' ; static final String TEXT_COLOR = `` [ RED ] AAA [ BLUE ] BBB [ RED ] CCC [ BLUE ] DDD [ RED ] EEE '' ; static final String TEXT_ESCAPE = `` [ [ ORANGE ] Escaped , but is colored '' ; SpriteBatch batch ; BitmapFont font ; public void create ( ) { batch = new SpriteBatch (
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/ParticleEffect.java b/gdx/src/com/badlogic/gdx/graphics/g2d/ParticleEffect.java index 18f6977..82b8f4c 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g2d/ParticleEffect.java +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/ParticleEffect.java @ @ -22,7 +22,6 @ @ import java.io.IOException ; import java.io.InputStream ; import java.io.InputStreamReader ; import java.io.Writer ; -import java.util.HashMap ; import com.badlogic.gdx.files.FileHandle ; import com.badlogic.gdx.graphics.Texture ; @ @ -30,6 +29,7 @ @ import com.badlogic.gdx.math.collision.BoundingBox ; import com.badlogic.gdx.utils.Array ; import com.badlogic.gdx.utils.Disposable ; import com.badlogic.gdx.utils.GdxRuntimeException ; +import com.badlogic.gdx.utils.ObjectMap ; import com.badlogic.gdx.utils.StreamUtils ; /** See < a href= '' http : //www.badlogicgames.com/wordpress/ ? p=1255 '' > http : //www.badlogicgames.com/wordpress/ ? p=1255 < /a > @ @ -205,7 +205,7 @ @ public class ParticleEffect implements Disposable { public void loadEmitterImages ( FileHandle imagesDir ) { ownsTexture = true ; - HashMap < String , Sprite > loadedSprites = new HashMap < String , Sprite > ( emitters.size ) ; + ObjectMap < String , Sprite > loadedSprites = new ObjectMap < String , Sprite > ( emitters.size ) ; for ( int i = 0 , n = emitters.size ; i < n ; i++ ) { ParticleEmitter emitter = emitters.get ( i ) ; if ( emitter.getImagePaths ( ) .size == 0 ) continue ; Color markup causes text to be display in wrong position , and does not escape properly __EoT__ # # # # Issue details When using color markup , each subsequent block after a colored block is offset to the left compared to unstyled text . Additionally , the markup escape code ` [ [ ` does not correctly cause the markup to be ignored if a closing bracket follows after a word which happens to be a valid color . ! [ libgdxcolormarkup ] ( https : //cloud.githubusercontent.com/assets/1232124/16882909/68a9b026-4a8f-11e6-9150-241e3017b3b8.png ) # # # # Reproduction steps/code `` ` java import com.badlogic.gdx.ApplicationAdapter ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.backends.lwjgl.LwjglApplication ; import com.badlogic.gdx.graphics.Color ; import com.badlogic.gdx.graphics.GL20 ; import com.badlogic.gdx.graphics.g2d.BitmapFont ; import com.badlogic.gdx.graphics.g2d.SpriteBatch ; public class ColorRenderingMain extends ApplicationAdapter { static final String TEXT_PLAIN = `` AAA BBB CCC DDD EEE '' ; static final String TEXT_COLOR = `` [ RED ] AAA [ BLUE ] BBB [ RED ] CCC [ BLUE ] DDD [ RED ] EEE '' ; static final String TEXT_ESCAPE = `` [ [ ORANGE ] Escaped , but is colored '' ; SpriteBatch batch ; BitmapFont font ; public void create ( ) { batch = new SpriteBatch (
diff -- git a/tests/gdx-tests/src/com/badlogic/gdx/tests/ScrollPaneTextAreaTest.java b/tests/gdx-tests/src/com/badlogic/gdx/tests/ScrollPaneTextAreaTest.java new file mode 100644 index 0000000..5ac3f79 -- - /dev/null +++ b/tests/gdx-tests/src/com/badlogic/gdx/tests/ScrollPaneTextAreaTest.java @ @ -0,0 +1,104 @ @ +package com.badlogic.gdx.tests ; + +import com.badlogic.gdx.Gdx ; +import com.badlogic.gdx.graphics.GL20 ; +import com.badlogic.gdx.graphics.g2d.SpriteBatch ; +import com.badlogic.gdx.scenes.scene2d.Stage ; +import com.badlogic.gdx.scenes.scene2d.ui.Label ; +import com.badlogic.gdx.scenes.scene2d.ui.ScrollPane ; +import com.badlogic.gdx.scenes.scene2d.ui.Skin ; +import com.badlogic.gdx.scenes.scene2d.ui.Table ; +import com.badlogic.gdx.scenes.scene2d.ui.TextArea ; +import com.badlogic.gdx.tests.utils.GdxTest ; +import com.badlogic.gdx.utils.FloatArray ; +import com.badlogic.gdx.utils.viewport.ScreenViewport ; + +public class ScrollPaneTextAreaTest extends GdxTest { + Stage stage ; + TextArea textArea ; + ScrollPane scrollPane ; + Skin skin ; + + + @ Override + public void create ( ) { + stage = new Stage ( new ScreenViewport ( ) ) ; + skin = new Skin ( Gdx.files.internal ( `` data/uiskin.json '' ) ) ; + Gdx.input.setInputProcessor ( stage ) ; + + Table container = new Table ( ) ; + stage.addActor ( container ) ; + + container.setFillParent ( true ) ; + container.pad ( 10 ) .defaults ( ) .expandX ( ) .fillX ( ) .space ( 4 ) ; + + textArea = new TextArea ( + '' > > > FIRST LINE < < < \n '' + + `` Scrolling to the bottom of the area Color markup causes text to be display in wrong position , and does not escape properly __EoT__ # # # # Issue details When using color markup , each subsequent block after a colored block is offset to the left compared to unstyled text . Additionally , the markup escape code ` [ [ ` does not correctly cause the markup to be ignored if a closing bracket follows after a word which happens to be a valid color . ! [ libgdxcolormarkup ] ( https : //cloud.githubusercontent.com/assets/1232124/16882909/68a9b026-4a8f-11e6-9150-241e3017b3b8.png ) # # # # Reproduction steps/code `` ` java import com.badlogic.gdx.ApplicationAdapter ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.backends.lwjgl.LwjglApplication ; import com.badlogic.gdx.graphics.Color ; import com.badlogic.gdx.graphics.GL20 ; import com.badlogic.gdx.graphics.g2d.BitmapFont ; import com.badlogic.gdx.graphics.g2d.SpriteBatch ; public class ColorRenderingMain extends ApplicationAdapter { static final String TEXT_PLAIN = `` AAA BBB CCC DDD EEE '' ; static final String TEXT_COLOR = `` [ RED ] AAA [ BLUE ] BBB [ RED ] CCC [ BLUE ] DDD [ RED ] EEE '' ; static final String TEXT_ESCAPE = `` [ [ ORANGE ] Escaped , but is colored '' ; SpriteBatch batch ; BitmapFont font ; public void create ( ) { batch = new SpriteBatch (
diff -- git a/backends/gdx-backend-lwjgl3/src/com/badlogic/gdx/backends/lwjgl3/Lwjgl3Graphics.java b/backends/gdx-backend-lwjgl3/src/com/badlogic/gdx/backends/lwjgl3/Lwjgl3Graphics.java index 5f5533c..aa1881c 100644 -- - a/backends/gdx-backend-lwjgl3/src/com/badlogic/gdx/backends/lwjgl3/Lwjgl3Graphics.java +++ b/backends/gdx-backend-lwjgl3/src/com/badlogic/gdx/backends/lwjgl3/Lwjgl3Graphics.java @ @ -64,6 +64,7 @ @ public class Lwjgl3Graphics implements Graphics , Disposable { return ; } GLFW.glfwMakeContextCurrent ( windowHandle ) ; + gl20.glViewport ( 0 , 0 , width , height ) ; window.getListener ( ) .resize ( getWidth ( ) , getHeight ( ) ) ; window.getListener ( ) .render ( ) ; GLFW.glfwSwapBuffers ( windowHandle ) ; LWJGL3 - Windows Only - glViewport must now be called by user after any resize . __EoT__ # # # Description When using LWJGL3 on Windows , when the window is resized , the application must call ` glViewport ( ) ` in order to be able to access the new screen size . # # # Modified Example App To see the problem , resize the app on Windows . Make the window wider than it was . EXPECTED : The logo fills the window : ACTUAL : There is a red bar at the right edge of the window . Then recompile with the glViewport ( ) line commented in , and see that it behaves as expected . gradle : `` ` project ( `` : desktop '' ) { apply plugin : `` java '' dependencies { compile project ( `` : core '' ) compile `` com.badlogicgames.gdx : gdx-backend-lwjgl3 : $ gdxVersion '' compile `` com.badlogicgames.gdx : gdx-platform : $ gdxVersion : natives-desktop '' } } `` ` Launcher : `` ` public class DesktopLauncher { public static void main ( String [ ] arg ) { Lwjgl3ApplicationConfiguration config = new Lwjgl3ApplicationConfiguration ( ) ;
diff -- git a/gdx/src/com/badlogic/gdx/maps/tiled/AtlasTmxMapLoader.java b/gdx/src/com/badlogic/gdx/maps/tiled/AtlasTmxMapLoader.java index d55ced2..82d2cc9 100644 -- - a/gdx/src/com/badlogic/gdx/maps/tiled/AtlasTmxMapLoader.java +++ b/gdx/src/com/badlogic/gdx/maps/tiled/AtlasTmxMapLoader.java @ @ -441,6 +441,14 @ @ public class AtlasTmxMapLoader extends BaseTmxMapLoader < AtlasTmxMapLoader.AtlasT tile = animatedTile ; } + Element objectgroupElement = tileElement.getChildByName ( `` objectgroup '' ) ; + if ( objectgroupElement ! = null ) { + + for ( Element objectElement : objectgroupElement.getChildrenByName ( `` object '' ) ) { + loadObject ( map , tile , objectElement ) ; + } + } + String terrain = tileElement.getAttribute ( `` terrain '' , null ) ; if ( terrain ! = null ) { tile.getProperties ( ) .put ( `` terrain '' , terrain ) ; diff -- git a/gdx/src/com/badlogic/gdx/maps/tiled/BaseTmxMapLoader.java b/gdx/src/com/badlogic/gdx/maps/tiled/BaseTmxMapLoader.java index 7980f6e..3d6877c 100644 -- - a/gdx/src/com/badlogic/gdx/maps/tiled/BaseTmxMapLoader.java +++ b/gdx/src/com/badlogic/gdx/maps/tiled/BaseTmxMapLoader.java @ @ -18,6 +18,7 @ @ import com.badlogic.gdx.graphics.g2d.TextureRegion ; import com.badlogic.gdx.maps.ImageResolver ; import com.badlogic.gdx.maps.MapLayer ; import com.badlogic.gdx.maps.MapObject ; +import com.badlogic.gdx.maps.MapObjects ; import com.badlogic.gdx.maps.MapProperties ; import com.badlogic.gdx.maps.objects.EllipseMapObject ; import com.badlogic.gdx.maps.objects.PolygonMapObject ; @ @ -166,6 +167,14 @ @ public abstract class BaseTmxMapLoader < P extends AssetLoaderParameters < TiledMap > } protected void loadObject ( TiledMap map , MapLayer layer , Element element ) { + loadObject ( map , layer.getObjects ( ) , element , mapHeightInPixels Tiled map tiles objects support __EoT__ Tiled tiles collision objects support request http : //doc.mapeditor.org/reference/tmx-changelog/ # tiled-010 LibGDX 1.9.5 *.tmx file fragment sample with emded tileset based on image collestion : `` ` < tileset > < tile id= '' 14 '' > < image/ > < objectgroup draworder= '' index '' > < object id= '' 1 '' x= '' 0 '' y= '' 0 '' width= '' 256 '' height= '' 210 '' / > < ! -- rectangle -- > < /objectgroup > < /tile > < /tileset > `` ` *.tsx file fragment sample to tilemap with tileset in source based on tileset image : `` ` < tileset > < image source= '' ... '' / > < tile id= '' 34 '' > < objectgroup draworder= '' index '' > < object id= '' 1 '' x= '' 25 '' y= '' 34 '' width= '' 102 '' height= '' 26 '' / > < ! -- rectangle -- > < object id= '' 2 '' x= '' 35 '' y= '' 105 '' width= '' 95 '' height= '' 27 '' > < ellipse/ > < /object > < object id= '' 3
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl b/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl index fc9acab..b2c9ecf 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl +++ b/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl @ @ -1,4 +1,4 @ @ - # ifdef GL_ES + # ifdef GL_ES # define LOWP lowp # define MED mediump # define HIGH highp @ @ -28,7 +28,7 @ @ varying float v_alphaTest ; # endif //alphaTestFlag # endif //blendedFlag - # if defined ( diffuseTextureFlag ) || defined ( specularTextureFlag ) + # if defined ( diffuseTextureFlag ) || defined ( specularTextureFlag ) || defined ( emissiveTextureFlag ) # define textureFlag # endif @ @ -40,6 +40,10 @ @ varying MED vec2 v_diffuseUV ; varying MED vec2 v_specularUV ; # endif + # ifdef emissiveTextureFlag +varying MED vec2 v_emissiveUV ; + # endif + # ifdef diffuseColorFlag uniform vec4 u_diffuseColor ; # endif @ @ -60,6 +64,14 @ @ uniform sampler2D u_specularTexture ; uniform sampler2D u_normalTexture ; # endif + # ifdef emissiveColorFlag +uniform vec4 u_emissiveColor ; + # endif + + # ifdef emissiveTextureFlag +uniform sampler2D u_emissiveTexture ; + # endif + # ifdef lightingFlag varying vec3 v_lightDiffuse ; @ @ -80,12 +92,12 @ @ varying vec3 v_shadowMapUv ; float getShadowness ( vec2 offset ) { const vec4 bitShifts = vec4 ( 1.0 Padded fonts have inconsistent space calculation around [ ] tags in marked up strings . __EoT__ Please merge # 3432 and other relevant issues to this : After testing with padded and not-padded fonts it is clear that padding is bugged . Tested with the built-in : data\arial-32.fnt and data\arial-32-pad.fnt for contrast ( and to eliminate issues with my personal assets that I wrongly uploaded in # 3432 ) . The top pair of draws are the padded font , the second pair has no padding and is displayed correctly . If the last glyphrun ended with a space , the location to start the new glyphrun ( for the next colored text section ) does n't compute the correct offset taking into account pad left & pad right . The same happens when closing a tag since a new run starts with the previous color . Edit : Note that it 's not about glyphs or spaces at all , the text from the next run has wrong offset and overlaps the previous text and the total width of the text element is incorrect . Edit 2 : Note how the 4rth line is also different than the 3d
diff -- git a/gdx/src/com/badlogic/gdx/math/Intersector.java b/gdx/src/com/badlogic/gdx/math/Intersector.java index 4ee6705..bf84917 100644 -- - a/gdx/src/com/badlogic/gdx/math/Intersector.java +++ b/gdx/src/com/badlogic/gdx/math/Intersector.java @ @ -149,7 +149,7 @ @ public final class Intersector { private final static Vector2 s = new Vector2 ( ) ; private final static Vector2 e = new Vector2 ( ) ; - /** Intersects two resulting polygons with the same winding and sets the overlap polygon resulting from the intersection . + /** Intersects two polygons with clockwise vertices and sets the overlap polygon resulting from the intersection . * Follows the Sutherland-Hodgman algorithm . * * @ param p1 The polygon that is being clipped @ @ -157,13 +157,13 @ @ public final class Intersector { * @ param overlap The intersection of the two polygons ( optional ) * @ return Whether the two polygons intersect . */ public static boolean intersectPolygons ( Polygon p1 , Polygon p2 , Polygon overlap ) { + if ( p1.getVertices ( ) .length == 0 || p2.getVertices ( ) .length == 0 ) { + return false ; + } // reusable points to trace edges around polygon floatArray2.clear ( ) ; floatArray.clear ( ) ; floatArray2.addAll ( p1.getTransformedVertices ( ) ) ; - if ( Padded fonts have inconsistent space calculation around [ ] tags in marked up strings . __EoT__ Please merge # 3432 and other relevant issues to this : After testing with padded and not-padded fonts it is clear that padding is bugged . Tested with the built-in : data\arial-32.fnt and data\arial-32-pad.fnt for contrast ( and to eliminate issues with my personal assets that I wrongly uploaded in # 3432 ) . The top pair of draws are the padded font , the second pair has no padding and is displayed correctly . If the last glyphrun ended with a space , the location to start the new glyphrun ( for the next colored text section ) does n't compute the correct offset taking into account pad left & pad right . The same happens when closing a tag since a new run starts with the previous color . Edit : Note that it 's not about glyphs or spaces at all , the text from the next run has wrong offset and overlaps the previous text and the total width of the text element is incorrect . Edit 2 : Note how the 4rth line is also different than the 3d
diff -- git a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplication.java b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplication.java index 7525caf..231e7d5 100644 -- - a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplication.java +++ b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplication.java @ @ -105,7 +105,6 @ @ public abstract class GwtApplication implements EntryPoint , Application { this.config = getConfig ( ) ; setApplicationLogger ( new GwtApplicationLogger ( this.config.log ) ) ; - addEventListeners ( ) ; if ( config.rootPanel ! = null ) { this.root = config.rootPanel ; @ @ -170,6 +169,7 @ @ public abstract class GwtApplication implements EntryPoint , Application { if ( loadingListener ! = null ) loadingListener.beforeSetup ( ) ; setupLoop ( ) ; + addEventListeners ( ) ; if ( loadingListener ! = null ) loadingListener.afterSetup ( ) ; } Padded fonts have inconsistent space calculation around [ ] tags in marked up strings . __EoT__ Please merge # 3432 and other relevant issues to this : After testing with padded and not-padded fonts it is clear that padding is bugged . Tested with the built-in : data\arial-32.fnt and data\arial-32-pad.fnt for contrast ( and to eliminate issues with my personal assets that I wrongly uploaded in # 3432 ) . The top pair of draws are the padded font , the second pair has no padding and is displayed correctly . If the last glyphrun ended with a space , the location to start the new glyphrun ( for the next colored text section ) does n't compute the correct offset taking into account pad left & pad right . The same happens when closing a tag since a new run starts with the previous color . Edit : Note that it 's not about glyphs or spaces at all , the text from the next run has wrong offset and overlaps the previous text and the total width of the text element is incorrect . Edit 2 : Note how the 4rth line is also different than the 3d
diff -- git a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java index 53406cf..8048422 100755 -- - a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java +++ b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java @ @ -399,6 +399,7 @ @ public class FreeTypeFontGenerator implements Disposable { Glyph missingGlyph = createGlyph ( '\0 ' , data , parameter , stroker , baseLine , packer ) ; if ( missingGlyph ! = null & & missingGlyph.width ! = 0 & & missingGlyph.height ! = 0 ) { data.setGlyph ( '\0 ' , missingGlyph ) ; + data.missingGlyph = missingGlyph ; if ( incremental ) data.glyphs.add ( missingGlyph ) ; } Padded fonts have inconsistent space calculation around [ ] tags in marked up strings . __EoT__ Please merge # 3432 and other relevant issues to this : After testing with padded and not-padded fonts it is clear that padding is bugged . Tested with the built-in : data\arial-32.fnt and data\arial-32-pad.fnt for contrast ( and to eliminate issues with my personal assets that I wrongly uploaded in # 3432 ) . The top pair of draws are the padded font , the second pair has no padding and is displayed correctly . If the last glyphrun ended with a space , the location to start the new glyphrun ( for the next colored text section ) does n't compute the correct offset taking into account pad left & pad right . The same happens when closing a tag since a new run starts with the previous color . Edit : Note that it 's not about glyphs or spaces at all , the text from the next run has wrong offset and overlaps the previous text and the total width of the text element is incorrect . Edit 2 : Note how the 4rth line is also different than the 3d
diff -- git a/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java b/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java index 548a3dd..23bd82c 100644 -- - a/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java +++ b/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java @ @ -38,6 +38,11 @ @ import com.badlogic.gdx.utils.reflect.ClassReflection ; public class Controllers { private static final String TAG = `` Controllers '' ; static final ObjectMap < Application , ControllerManager > managers = new ObjectMap < Application , ControllerManager > ( ) ; + /** + * The class name of a preferred { @ link ControllerManager } . If this is null then an appropriate ControllerManager will + * automatically be selected . This must be set before any controllers or managers are found . + */ + public static String preferredManager = null ; /** Returns an array of connected { @ link Controller } instances . This method should only be called on the rendering thread . * @ @ -85,7 +90,9 @ @ public class Controllers { ApplicationType type = Gdx.app.getType ( ) ; ControllerManager manager = null ; - if ( type == ApplicationType.Android ) { + if ( preferredManager ! = null ) { + className = preferredManager ; + } else if ( type == ApplicationType.Android ) { if ( Gdx.app.getVersion ( ) > = 12 ) { className = Usage of controllers in non continous rendering __EoT__ # # # # Issue details My application uses LibGDX in non continuous rendering , with deployment to desktop targets using the LWJGL3 backend . The problem I 'm encountering at the moment is that the ` Lwjgl3ControllerManager ` polls the controller by constantly posting runnables , which triggers the application to redraw immediately , thus moving the application back to continuous rendering . I have a couple of different workarounds in mind , but was curious if any of them would be acceptable to be merged back , or if I should just interact with the GLFW controllers directly in my code . 1 . Add a static function to Controllers and pass it to each backend when instantiated to indicate if it should be continuously polled or not . The signficiant downside to this is that it 's a lot of noise/change to the other back ends for a feature they wo n't implement . 1 . Add a static function to ` Lwjgl3ControllerManager ` to indicate if it should be continously polled or not . Then make ` Lwjgl3ControllerManager.pollState ( ) ` a public funcation , and add a
diff -- git a/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSApplicationConfiguration.java b/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSApplicationConfiguration.java index 0653733..67d70ef 100644 -- - a/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSApplicationConfiguration.java +++ b/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSApplicationConfiguration.java @ @ -20,6 +20,7 @ @ import org.robovm.apple.glkit.GLKViewDrawableColorFormat ; import org.robovm.apple.glkit.GLKViewDrawableDepthFormat ; import org.robovm.apple.glkit.GLKViewDrawableMultisample ; import org.robovm.apple.glkit.GLKViewDrawableStencilFormat ; +import org.robovm.apple.uikit.UIRectEdge ; public class IOSApplicationConfiguration { /** whether to enable screen dimming . */ @ @ -100,4 +101,8 @ @ public class IOSApplicationConfiguration { /** Whether to override the ringer/mute switch , see https : //github.com/libgdx/libgdx/issues/4430 */ public boolean overrideRingerSwitch = false ; + + /** Edges where app gestures must be fired over system gestures . + * Prior to iOS 11 , UIRectEdge.All was default behaviour if status bar hidden , see https : //github.com/libgdx/libgdx/issues/5110 **/ + public UIRectEdge screenEdgesDeferringSystemGestures = UIRectEdge.None ; } diff -- git a/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSGraphics.java b/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSGraphics.java index c6d9e29..d202953 100644 -- - a/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSGraphics.java +++ b/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSGraphics.java @ @ -17,7 +17,18 @ @ package com.badlogic.gdx.backends.iosrobovm ; import com.badlogic.gdx.Application ; +import com.badlogic.gdx.Gdx ; +import com.badlogic.gdx.Graphics ; +import com.badlogic.gdx.LifecycleListener ; +import com.badlogic.gdx.backends.iosrobovm.custom.HWMachine ; +import com.badlogic.gdx.graphics.Cursor ; +import com.badlogic.gdx.graphics.Cursor.SystemCursor ; +import com.badlogic.gdx.graphics.GL20 ; +import com.badlogic.gdx.graphics.GL30 ; +import com.badlogic.gdx.graphics.Pixmap ; import com.badlogic.gdx.graphics.glutils.GLVersion ; +import com.badlogic.gdx.utils.Array ; + import org.robovm.apple.coregraphics.CGRect ; import org.robovm.apple.foundation.NSObject ; import org.robovm.apple.glkit.GLKView ; @ @ -33,23 +44,13 @ @ import org.robovm.apple.opengles.EAGLRenderingAPI ; import org.robovm.apple.uikit.UIEvent ; import org.robovm.apple.uikit.UIInterfaceOrientation [ iOS RoboVM ] System Gestures overriding app gestures at edges on iOS11 __EoT__ # # # # Issue details iOS 11 changed the way apps had to override system gestures ( for example a swipe from the bottom up to display the Control Center ) so that they do n't get over the app . Before iOS11 , it was just enough hiding the Status Bar but now it 's also required to override ` UIViewController # preferredScreenEdgesDeferringSystemGestures ` . This article explains the issue in detail : https : //useyourloaf.com/blog/avoiding-conflicts-with-system-gestures-at-screen-edges/ System gestures taking priority over app gestures may cause several undesired behaviour that not only affect swipe gestures but also simple taps the edge of the screen area ( which are delayed until the system resolves what the user is trying to do making it less responsive ) # # # # Reproduction steps/code Open a RoboVM libGDX app on iOS 11 that has the status bar hidden and do a swipe gesture from the bottom edge of the screen . The whole Control Center appears instead of just `` an arrow '' . # # # # Version of LibGDX and/or relevant dependencies 1.9.8 **NOTE** : It
diff -- git a/gdx/src/com/badlogic/gdx/scenes/scene2d/Actor.java b/gdx/src/com/badlogic/gdx/scenes/scene2d/Actor.java index ac157ea..32b8eed 100644 -- - a/gdx/src/com/badlogic/gdx/scenes/scene2d/Actor.java +++ b/gdx/src/com/badlogic/gdx/scenes/scene2d/Actor.java @ @ -377,6 +377,21 @ @ public class Actor { this.visible = visible ; } + /** + * Check if all parent actors are visible . + * @ return true is all parents as well as the actor itself are visible . + */ + public boolean isComponentHierarchyVisible ( ) { + Actor currentParent=this ; + while ( currentParent.hasParent ( ) ) { + if ( ! currentParent.isVisible ( ) ) { + return false ; + } + currentParent=currentParent.getParent ( ) ; + } + return currentParent.isVisible ( ) ; + } + /** Returns an application specific object for convenience , or null . */ public Object getUserObject ( ) { return userObject ; diff -- git a/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/TextField.java b/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/TextField.java deleted file mode 100644 index 96e07a3..0000000 -- - a/gdx/src/com/badlogic/gdx/scenes/scene2d/ui/TextField.java +++ /dev/null @ @ -1,1095 +0,0 @ @ -/******************************************************************************* - * Copyright 2011 See AUTHORS file . - * - * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - * you may not use this file except in compliance with the License . - * You may Application 's pause ( ) method is called before initialization is done on GWT __EoT__ # # # # Issue details On GWT , libGDX preloads all assets before initializing the game . Also on GWT , the game is paused when the web browser tab is hidden by changing to view another tab . When the tab is changed while the libGDX GWT application is still preloading - users do this when they see that loading will take some time - , the ` pause ( ) ` method on the game 's main ` Game ` class is called *before* ` Gdx.app ` variable is initialized and before the ` create ( ) ` method was called . This should not happen according to the [ documented lifecycle ] ( https : //github.com/libgdx/libgdx/wiki/The-life-cycle ) . # # # # Reproduction steps/code Place some huge assets in the asset directory , and add the following lines to your main game 's class : public class Tralala extends Game { @ Override public void create ( ) { ... . Gdx.app.log ( `` TEST '' , `` Created '' ) ; } @ Override public void pause ( ) {
diff -- git a/extensions/gdx-setup/src/com/badlogic/gdx/setup/resources/desktop/build.gradle b/extensions/gdx-setup/src/com/badlogic/gdx/setup/resources/desktop/build.gradle index 606dc86..db4495a 100644 -- - a/extensions/gdx-setup/src/com/badlogic/gdx/setup/resources/desktop/build.gradle +++ b/extensions/gdx-setup/src/com/badlogic/gdx/setup/resources/desktop/build.gradle @ @ -1,3 +1,5 @ @ +import org.apache.tools.ant.taskdefs.condition.Os + apply plugin : `` % LANG % '' sourceCompatibility = 1.6 @ @ -12,6 +14,9 @ @ task run ( dependsOn : classes , type : JavaExec ) { standardInput = System.in workingDir = project.assetsDir ignoreExitValue = true + + if ( Os.isFamily ( Os.FAMILY_MAC ) ) + jvmArgs += `` -XstartOnFirstThread '' } task debug ( dependsOn : classes , type : JavaExec ) { Application 's pause ( ) method is called before initialization is done on GWT __EoT__ # # # # Issue details On GWT , libGDX preloads all assets before initializing the game . Also on GWT , the game is paused when the web browser tab is hidden by changing to view another tab . When the tab is changed while the libGDX GWT application is still preloading - users do this when they see that loading will take some time - , the ` pause ( ) ` method on the game 's main ` Game ` class is called *before* ` Gdx.app ` variable is initialized and before the ` create ( ) ` method was called . This should not happen according to the [ documented lifecycle ] ( https : //github.com/libgdx/libgdx/wiki/The-life-cycle ) . # # # # Reproduction steps/code Place some huge assets in the asset directory , and add the following lines to your main game 's class : public class Tralala extends Game { @ Override public void create ( ) { ... . Gdx.app.log ( `` TEST '' , `` Created '' ) ; } @ Override public void pause ( ) {
diff -- git a/gdx/src/com/badlogic/gdx/math/Intersector.java b/gdx/src/com/badlogic/gdx/math/Intersector.java index 4ee6705..8861cfa 100644 -- - a/gdx/src/com/badlogic/gdx/math/Intersector.java +++ b/gdx/src/com/badlogic/gdx/math/Intersector.java @ @ -149,21 +149,21 @ @ public final class Intersector { private final static Vector2 s = new Vector2 ( ) ; private final static Vector2 e = new Vector2 ( ) ; - /** Intersects two resulting polygons with the same winding and sets the overlap polygon resulting from the intersection . + /** Intersects two convex polygons with clockwise vertices and sets the overlap polygon resulting from the intersection . * Follows the Sutherland-Hodgman algorithm . * * @ param p1 The polygon that is being clipped * @ param p2 The clip polygon - * @ param overlap The intersection of the two polygons ( optional ) + * @ param overlap The intersection of the two polygons ( can be null , if an intersection polygon is not needed ) * @ return Whether the two polygons intersect . */ public static boolean intersectPolygons ( Polygon p1 , Polygon p2 , Polygon overlap ) { + if ( p1.getVertices ( ) .length == 0 || p2.getVertices ( ) .length == 0 ) { + return false ; + } // reusable points to Application 's pause ( ) method is called before initialization is done on GWT __EoT__ # # # # Issue details On GWT , libGDX preloads all assets before initializing the game . Also on GWT , the game is paused when the web browser tab is hidden by changing to view another tab . When the tab is changed while the libGDX GWT application is still preloading - users do this when they see that loading will take some time - , the ` pause ( ) ` method on the game 's main ` Game ` class is called *before* ` Gdx.app ` variable is initialized and before the ` create ( ) ` method was called . This should not happen according to the [ documented lifecycle ] ( https : //github.com/libgdx/libgdx/wiki/The-life-cycle ) . # # # # Reproduction steps/code Place some huge assets in the asset directory , and add the following lines to your main game 's class : public class Tralala extends Game { @ Override public void create ( ) { ... . Gdx.app.log ( `` TEST '' , `` Created '' ) ; } @ Override public void pause ( ) {
diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java index f8500bb..f12d8d2 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java @ @ -25,7 +25,6 @ @ import android.os.Build ; import android.os.Bundle ; import android.os.Debug ; import android.os.Handler ; -import android.util.Log ; import android.view.Gravity ; import android.view.View ; import android.view.Window ; @ @ -39,7 +38,6 @ @ import com.badlogic.gdx.Audio ; import com.badlogic.gdx.Files ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.Graphics ; -import com.badlogic.gdx.Input ; import com.badlogic.gdx.LifecycleListener ; import com.badlogic.gdx.Net ; import com.badlogic.gdx.Preferences ; @ @ -51,7 +49,6 @ @ import com.badlogic.gdx.utils.GdxRuntimeException ; import com.badlogic.gdx.utils.SnapshotArray ; import java.lang.reflect.Method ; -import java.util.Arrays ; /** An implementation of the { @ link Application } interface for Android . Create an { @ link Activity } that derives from this class . In * the { @ link Activity # onCreate ( Bundle ) } method call the { @ link # initialize ( ApplicationListener ) } method specifying the @ @ -198,6 +195,10 @ @ public class AndroidApplication extends Activity implements AndroidApplicationBa log ( `` AndroidApplication '' , `` Failed to create AndroidVisibilityListener '' , e ) ; } } + + // detect an already connected bluetooth keyboardAvailable + if ( getResources ( ) .getConfiguration ( ) .keyboard ! = Configuration.KEYBOARD_NOKEYS ) Application 's pause ( ) method is called before initialization is done on GWT __EoT__ # # # # Issue details On GWT , libGDX preloads all assets before initializing the game . Also on GWT , the game is paused when the web browser tab is hidden by changing to view another tab . When the tab is changed while the libGDX GWT application is still preloading - users do this when they see that loading will take some time - , the ` pause ( ) ` method on the game 's main ` Game ` class is called *before* ` Gdx.app ` variable is initialized and before the ` create ( ) ` method was called . This should not happen according to the [ documented lifecycle ] ( https : //github.com/libgdx/libgdx/wiki/The-life-cycle ) . # # # # Reproduction steps/code Place some huge assets in the asset directory , and add the following lines to your main game 's class : public class Tralala extends Game { @ Override public void create ( ) { ... . Gdx.app.log ( `` TEST '' , `` Created '' ) ; } @ Override public void pause ( ) {
diff -- git a/CHANGES b/CHANGES index ace0a15..0537b3e 100755 -- - a/CHANGES +++ b/CHANGES @ @ -8,6 +8,7 @ @ - SkinLoader can be used on subclasses of Skin by overriding generateSkin ( ) . - API addition : Tree indentation can be customized . - Fixed GlyphLayout not respecting BitmapFontData # down . +- API Addition : Added FileHandle # map ( ) , can be used to memory map a file [ 1.9.8 ] - Add iPhoneX images diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java index 1eb4142..6328680 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java @ @ -18,9 +18,13 @ @ package com.badlogic.gdx.backends.android ; import java.io.File ; import java.io.FileFilter ; +import java.io.FileInputStream ; import java.io.FilenameFilter ; import java.io.IOException ; import java.io.InputStream ; +import java.nio.ByteBuffer ; +import java.nio.ByteOrder ; +import java.nio.channels.FileChannel ; import android.content.res.AssetFileDescriptor ; import android.content.res.AssetManager ; @ @ -29,6 +33,7 @ @ import com.badlogic.gdx.Files.FileType ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.files.FileHandle ; import com.badlogic.gdx.utils.GdxRuntimeException ; +import com.badlogic.gdx.utils.StreamUtils ; /** @ author mzechner * @ author Nathan Sweet */ @ @ -80,6 +85,24 @ @ public class AndroidFileHandle extends FileHandle { return super.read ( ) ; } + public ByteBuffer map ( FileChannel.MapMode mode ) { + if ( type == FileType.Internal ) { Application 's pause ( ) method is called before initialization is done on GWT __EoT__ # # # # Issue details On GWT , libGDX preloads all assets before initializing the game . Also on GWT , the game is paused when the web browser tab is hidden by changing to view another tab . When the tab is changed while the libGDX GWT application is still preloading - users do this when they see that loading will take some time - , the ` pause ( ) ` method on the game 's main ` Game ` class is called *before* ` Gdx.app ` variable is initialized and before the ` create ( ) ` method was called . This should not happen according to the [ documented lifecycle ] ( https : //github.com/libgdx/libgdx/wiki/The-life-cycle ) . # # # # Reproduction steps/code Place some huge assets in the asset directory , and add the following lines to your main game 's class : public class Tralala extends Game { @ Override public void create ( ) { ... . Gdx.app.log ( `` TEST '' , `` Created '' ) ; } @ Override public void pause ( ) {
diff -- git a/CHANGES b/CHANGES index ea974f5..2554dbc 100755 -- - a/CHANGES +++ b/CHANGES @ @ -11,6 +11,7 @ @ - API Addition : Added faceIndex paramter to # FreeTypeFontGenerator ( FileHandle , int ) . - API Change : BitmapFont # getSpaceWidth changed to BitmapFont # getSpaceXadvance . - Many GlyphLayout fixes . +- API Addition : Added FileHandle # map ( ) , can be used to memory map a file [ 1.9.8 ] - Add iPhoneX images diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java index 1eb4142..6328680 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java @ @ -18,9 +18,13 @ @ package com.badlogic.gdx.backends.android ; import java.io.File ; import java.io.FileFilter ; +import java.io.FileInputStream ; import java.io.FilenameFilter ; import java.io.IOException ; import java.io.InputStream ; +import java.nio.ByteBuffer ; +import java.nio.ByteOrder ; +import java.nio.channels.FileChannel ; import android.content.res.AssetFileDescriptor ; import android.content.res.AssetManager ; @ @ -29,6 +33,7 @ @ import com.badlogic.gdx.Files.FileType ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.files.FileHandle ; import com.badlogic.gdx.utils.GdxRuntimeException ; +import com.badlogic.gdx.utils.StreamUtils ; /** @ author mzechner * @ author Nathan Sweet */ @ @ -80,6 +85,24 @ @ public class AndroidFileHandle extends FileHandle { return super.read ( ) ; } + public ByteBuffer map ( FileChannel.MapMode mode ) { + if ( type == FileType.Internal ) { Application 's pause ( ) method is called before initialization is done on GWT __EoT__ # # # # Issue details On GWT , libGDX preloads all assets before initializing the game . Also on GWT , the game is paused when the web browser tab is hidden by changing to view another tab . When the tab is changed while the libGDX GWT application is still preloading - users do this when they see that loading will take some time - , the ` pause ( ) ` method on the game 's main ` Game ` class is called *before* ` Gdx.app ` variable is initialized and before the ` create ( ) ` method was called . This should not happen according to the [ documented lifecycle ] ( https : //github.com/libgdx/libgdx/wiki/The-life-cycle ) . # # # # Reproduction steps/code Place some huge assets in the asset directory , and add the following lines to your main game 's class : public class Tralala extends Game { @ Override public void create ( ) { ... . Gdx.app.log ( `` TEST '' , `` Created '' ) ; } @ Override public void pause ( ) {
diff -- git a/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java b/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java index 548a3dd..23bd82c 100644 -- - a/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java +++ b/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java @ @ -38,6 +38,11 @ @ import com.badlogic.gdx.utils.reflect.ClassReflection ; public class Controllers { private static final String TAG = `` Controllers '' ; static final ObjectMap < Application , ControllerManager > managers = new ObjectMap < Application , ControllerManager > ( ) ; + /** + * The class name of a preferred { @ link ControllerManager } . If this is null then an appropriate ControllerManager will + * automatically be selected . This must be set before any controllers or managers are found . + */ + public static String preferredManager = null ; /** Returns an array of connected { @ link Controller } instances . This method should only be called on the rendering thread . * @ @ -85,7 +90,9 @ @ public class Controllers { ApplicationType type = Gdx.app.getType ( ) ; ControllerManager manager = null ; - if ( type == ApplicationType.Android ) { + if ( preferredManager ! = null ) { + className = preferredManager ; + } else if ( type == ApplicationType.Android ) { if ( Gdx.app.getVersion ( ) > = 12 ) { className = Application 's pause ( ) method is called before initialization is done on GWT __EoT__ # # # # Issue details On GWT , libGDX preloads all assets before initializing the game . Also on GWT , the game is paused when the web browser tab is hidden by changing to view another tab . When the tab is changed while the libGDX GWT application is still preloading - users do this when they see that loading will take some time - , the ` pause ( ) ` method on the game 's main ` Game ` class is called *before* ` Gdx.app ` variable is initialized and before the ` create ( ) ` method was called . This should not happen according to the [ documented lifecycle ] ( https : //github.com/libgdx/libgdx/wiki/The-life-cycle ) . # # # # Reproduction steps/code Place some huge assets in the asset directory , and add the following lines to your main game 's class : public class Tralala extends Game { @ Override public void create ( ) { ... . Gdx.app.log ( `` TEST '' , `` Created '' ) ; } @ Override public void pause ( ) {
diff -- git a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplication.java b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplication.java index 7525caf..231e7d5 100644 -- - a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplication.java +++ b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplication.java @ @ -105,7 +105,6 @ @ public abstract class GwtApplication implements EntryPoint , Application { this.config = getConfig ( ) ; setApplicationLogger ( new GwtApplicationLogger ( this.config.log ) ) ; - addEventListeners ( ) ; if ( config.rootPanel ! = null ) { this.root = config.rootPanel ; @ @ -170,6 +169,7 @ @ public abstract class GwtApplication implements EntryPoint , Application { if ( loadingListener ! = null ) loadingListener.beforeSetup ( ) ; setupLoop ( ) ; + addEventListeners ( ) ; if ( loadingListener ! = null ) loadingListener.afterSetup ( ) ; } Application 's pause ( ) method is called before initialization is done on GWT __EoT__ # # # # Issue details On GWT , libGDX preloads all assets before initializing the game . Also on GWT , the game is paused when the web browser tab is hidden by changing to view another tab . When the tab is changed while the libGDX GWT application is still preloading - users do this when they see that loading will take some time - , the ` pause ( ) ` method on the game 's main ` Game ` class is called *before* ` Gdx.app ` variable is initialized and before the ` create ( ) ` method was called . This should not happen according to the [ documented lifecycle ] ( https : //github.com/libgdx/libgdx/wiki/The-life-cycle ) . # # # # Reproduction steps/code Place some huge assets in the asset directory , and add the following lines to your main game 's class : public class Tralala extends Game { @ Override public void create ( ) { ... . Gdx.app.log ( `` TEST '' , `` Created '' ) ; } @ Override public void pause ( ) {
diff -- git a/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSInput.java b/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSInput.java index 5f63934..0f07e21 100644 -- - a/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSInput.java +++ b/backends/gdx-backend-robovm/src/com/badlogic/gdx/backends/iosrobovm/IOSInput.java @ @ -56,6 +56,7 @ @ import com.badlogic.gdx.utils.Pool ; public class IOSInput implements Input { static final int MAX_TOUCHES = 20 ; + private static final int POINTER_NOT_FOUND = -1 ; private static class NSObjectWrapper < T extends NSObject > { private static final long HANDLE_OFFSET ; @ @ -639,7 +640,13 @ @ public class IOSInput implements Input { for ( int i = 0 ; i < touchDown.length ; i++ ) { if ( touchDown [ i ] == ptr ) return i ; } - throw new GdxRuntimeException ( `` Could n't find pointer id for touch event ! `` ) ; + // If pointer is not found + StringBuilder sb = new StringBuilder ( ) ; + for ( int i = 0 ; i < touchDown.length ; i++ ) { + sb.append ( i + `` : '' + touchDown [ i ] + `` `` ) ; + } + Gdx.app.error ( `` IOSInput '' , `` Pointer ID lookup failed : `` + ptr + `` , `` + sb.toString ( ) ) ; + return POINTER_NOT_FOUND ; } private Expose ALSource state on iOS __EoT__ I 'd like to be able to access the state information on ALSource on iOS . Does this change only require the following code to bind to the native property or is there something else needed ? `` ` java @ Property ( selector = `` state '' ) public native int getState ( ) ; `` `
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl b/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl index fc9acab..b2c9ecf 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl +++ b/gdx/src/com/badlogic/gdx/graphics/g3d/shaders/default.fragment.glsl @ @ -1,4 +1,4 @ @ - # ifdef GL_ES + # ifdef GL_ES # define LOWP lowp # define MED mediump # define HIGH highp @ @ -28,7 +28,7 @ @ varying float v_alphaTest ; # endif //alphaTestFlag # endif //blendedFlag - # if defined ( diffuseTextureFlag ) || defined ( specularTextureFlag ) + # if defined ( diffuseTextureFlag ) || defined ( specularTextureFlag ) || defined ( emissiveTextureFlag ) # define textureFlag # endif @ @ -40,6 +40,10 @ @ varying MED vec2 v_diffuseUV ; varying MED vec2 v_specularUV ; # endif + # ifdef emissiveTextureFlag +varying MED vec2 v_emissiveUV ; + # endif + # ifdef diffuseColorFlag uniform vec4 u_diffuseColor ; # endif @ @ -60,6 +64,14 @ @ uniform sampler2D u_specularTexture ; uniform sampler2D u_normalTexture ; # endif + # ifdef emissiveColorFlag +uniform vec4 u_emissiveColor ; + # endif + + # ifdef emissiveTextureFlag +uniform sampler2D u_emissiveTexture ; + # endif + # ifdef lightingFlag varying vec3 v_lightDiffuse ; @ @ -80,12 +92,12 @ @ varying vec3 v_shadowMapUv ; float getShadowness ( vec2 offset ) { const vec4 bitShifts = vec4 ( 1.0 Expose ALSource state on iOS __EoT__ I 'd like to be able to access the state information on ALSource on iOS . Does this change only require the following code to bind to the native property or is there something else needed ? `` ` java @ Property ( selector = `` state '' ) public native int getState ( ) ; `` `
diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java index 12afc86..ceac630 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java @ @ -22,8 +22,8 @ @ import java.io.FileInputStream ; import java.io.FilenameFilter ; import java.io.IOException ; import java.io.InputStream ; +import java.nio.ByteBuffer ; import java.nio.ByteOrder ; -import java.nio.MappedByteBuffer ; import java.nio.channels.FileChannel ; import android.content.res.AssetFileDescriptor ; @ @ -85,7 +85,7 @ @ public class AndroidFileHandle extends FileHandle { return super.read ( ) ; } - public MappedByteBuffer map ( FileChannel.MapMode mode ) { + public ByteBuffer map ( FileChannel.MapMode mode ) { if ( type == FileType.Internal ) { FileInputStream input = null ; try { @ @ -93,7 +93,7 @ @ public class AndroidFileHandle extends FileHandle { long startOffset = fd.getStartOffset ( ) ; long declaredLength = fd.getDeclaredLength ( ) ; input = new FileInputStream ( fd.getFileDescriptor ( ) ) ; - MappedByteBuffer map = input.getChannel ( ) .map ( mode , startOffset , declaredLength ) ; + ByteBuffer map = input.getChannel ( ) .map ( mode , startOffset , declaredLength ) ; map.order ( ByteOrder.nativeOrder ( ) ) ; return map ; } catch ( Exception ex ) { diff -- git a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtFileHandle.java b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtFileHandle.java index d8a96b5..c6844c5 100644 -- - a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtFileHandle.java +++ b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtFileHandle.java @ @ -28,7 +28,7 @ @ Expose ALSource state on iOS __EoT__ I 'd like to be able to access the state information on ALSource on iOS . Does this change only require the following code to bind to the native property or is there something else needed ? `` ` java @ Property ( selector = `` state '' ) public native int getState ( ) ; `` `
diff -- git a/CHANGES b/CHANGES index ea974f5..98f7b07 100755 -- - a/CHANGES +++ b/CHANGES @ @ -8,6 +8,7 @ @ - SkinLoader can be used on subclasses of Skin by overriding generateSkin ( ) . - API addition : Tree indentation can be customized . - Fixed GlyphLayout not respecting BitmapFontData # down . +- API Addition : Added FileHandle # map ( ) , can be used to memory map a file - API Addition : Added faceIndex paramter to # FreeTypeFontGenerator ( FileHandle , int ) . - API Change : BitmapFont # getSpaceWidth changed to BitmapFont # getSpaceXadvance . - Many GlyphLayout fixes . diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java index 1eb4142..6328680 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java @ @ -18,9 +18,13 @ @ package com.badlogic.gdx.backends.android ; import java.io.File ; import java.io.FileFilter ; +import java.io.FileInputStream ; import java.io.FilenameFilter ; import java.io.IOException ; import java.io.InputStream ; +import java.nio.ByteBuffer ; +import java.nio.ByteOrder ; +import java.nio.channels.FileChannel ; import android.content.res.AssetFileDescriptor ; import android.content.res.AssetManager ; @ @ -29,6 +33,7 @ @ import com.badlogic.gdx.Files.FileType ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.files.FileHandle ; import com.badlogic.gdx.utils.GdxRuntimeException ; +import com.badlogic.gdx.utils.StreamUtils ; /** @ author mzechner * @ author Nathan Sweet */ @ @ -80,6 +85,24 @ @ public class Expose ALSource state on iOS __EoT__ I 'd like to be able to access the state information on ALSource on iOS . Does this change only require the following code to bind to the native property or is there something else needed ? `` ` java @ Property ( selector = `` state '' ) public native int getState ( ) ; `` `
diff -- git a/gdx/src/com/badlogic/gdx/utils/Array.java b/gdx/src/com/badlogic/gdx/utils/Array.java index f064ef8..4408db7 100644 -- - a/gdx/src/com/badlogic/gdx/utils/Array.java +++ b/gdx/src/com/badlogic/gdx/utils/Array.java @ @ -339,6 +339,16 @ @ public class Array < T > implements Iterable < T > { return items [ 0 ] ; } + /** Returns true if the array is empty . */ + public boolean isEmpty ( ) { + return size == 0 ; + } + + /** Returns true if the array has at least one item . */ + public boolean hasItems ( ) { + return size > 0 ; + } + public void clear ( ) { T [ ] items = this.items ; for ( int i = 0 , n = size ; i < n ; i++ ) diff -- git a/gdx/src/com/badlogic/gdx/utils/ArrayMap.java b/gdx/src/com/badlogic/gdx/utils/ArrayMap.java index 946e325..6b3427d 100644 -- - a/gdx/src/com/badlogic/gdx/utils/ArrayMap.java +++ b/gdx/src/com/badlogic/gdx/utils/ArrayMap.java @ @ -307,6 +307,16 @ @ public class ArrayMap < K , V > implements Iterable < ObjectMap.Entry < K , V > > { values [ size ] = null ; } + /** Returns true if the map is empty . */ + public boolean isEmpty ( ) { + return size == 0 ; + } + + /** Expose ALSource state on iOS __EoT__ I 'd like to be able to access the state information on ALSource on iOS . Does this change only require the following code to bind to the native property or is there something else needed ? `` ` java @ Property ( selector = `` state '' ) public native int getState ( ) ; `` `
diff -- git a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplication.java b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplication.java index 7525caf..231e7d5 100644 -- - a/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplication.java +++ b/backends/gdx-backends-gwt/src/com/badlogic/gdx/backends/gwt/GwtApplication.java @ @ -105,7 +105,6 @ @ public abstract class GwtApplication implements EntryPoint , Application { this.config = getConfig ( ) ; setApplicationLogger ( new GwtApplicationLogger ( this.config.log ) ) ; - addEventListeners ( ) ; if ( config.rootPanel ! = null ) { this.root = config.rootPanel ; @ @ -170,6 +169,7 @ @ public abstract class GwtApplication implements EntryPoint , Application { if ( loadingListener ! = null ) loadingListener.beforeSetup ( ) ; setupLoop ( ) ; + addEventListeners ( ) ; if ( loadingListener ! = null ) loadingListener.afterSetup ( ) ; } Expose ALSource state on iOS __EoT__ I 'd like to be able to access the state information on ALSource on iOS . Does this change only require the following code to bind to the native property or is there something else needed ? `` ` java @ Property ( selector = `` state '' ) public native int getState ( ) ; `` `
diff -- git a/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java b/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java index 548a3dd..23bd82c 100644 -- - a/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java +++ b/extensions/gdx-controllers/gdx-controllers/src/com/badlogic/gdx/controllers/Controllers.java @ @ -38,6 +38,11 @ @ import com.badlogic.gdx.utils.reflect.ClassReflection ; public class Controllers { private static final String TAG = `` Controllers '' ; static final ObjectMap < Application , ControllerManager > managers = new ObjectMap < Application , ControllerManager > ( ) ; + /** + * The class name of a preferred { @ link ControllerManager } . If this is null then an appropriate ControllerManager will + * automatically be selected . This must be set before any controllers or managers are found . + */ + public static String preferredManager = null ; /** Returns an array of connected { @ link Controller } instances . This method should only be called on the rendering thread . * @ @ -85,7 +90,9 @ @ public class Controllers { ApplicationType type = Gdx.app.getType ( ) ; ControllerManager manager = null ; - if ( type == ApplicationType.Android ) { + if ( preferredManager ! = null ) { + className = preferredManager ; + } else if ( type == ApplicationType.Android ) { if ( Gdx.app.getVersion ( ) > = 12 ) { className = Expose ALSource state on iOS __EoT__ I 'd like to be able to access the state information on ALSource on iOS . Does this change only require the following code to bind to the native property or is there something else needed ? `` ` java @ Property ( selector = `` state '' ) public native int getState ( ) ; `` `
diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java index f8500bb..f12d8d2 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java @ @ -25,7 +25,6 @ @ import android.os.Build ; import android.os.Bundle ; import android.os.Debug ; import android.os.Handler ; -import android.util.Log ; import android.view.Gravity ; import android.view.View ; import android.view.Window ; @ @ -39,7 +38,6 @ @ import com.badlogic.gdx.Audio ; import com.badlogic.gdx.Files ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.Graphics ; -import com.badlogic.gdx.Input ; import com.badlogic.gdx.LifecycleListener ; import com.badlogic.gdx.Net ; import com.badlogic.gdx.Preferences ; @ @ -51,7 +49,6 @ @ import com.badlogic.gdx.utils.GdxRuntimeException ; import com.badlogic.gdx.utils.SnapshotArray ; import java.lang.reflect.Method ; -import java.util.Arrays ; /** An implementation of the { @ link Application } interface for Android . Create an { @ link Activity } that derives from this class . In * the { @ link Activity # onCreate ( Bundle ) } method call the { @ link # initialize ( ApplicationListener ) } method specifying the @ @ -198,6 +195,10 @ @ public class AndroidApplication extends Activity implements AndroidApplicationBa log ( `` AndroidApplication '' , `` Failed to create AndroidVisibilityListener '' , e ) ; } } + + // detect an already connected bluetooth keyboardAvailable + if ( getResources ( ) .getConfiguration ( ) .keyboard ! = Configuration.KEYBOARD_NOKEYS ) Expose ALSource state on iOS __EoT__ I 'd like to be able to access the state information on ALSource on iOS . Does this change only require the following code to bind to the native property or is there something else needed ? `` ` java @ Property ( selector = `` state '' ) public native int getState ( ) ; `` `
diff -- git a/CHANGES b/CHANGES index ea974f5..98f7b07 100755 -- - a/CHANGES +++ b/CHANGES @ @ -8,6 +8,7 @ @ - SkinLoader can be used on subclasses of Skin by overriding generateSkin ( ) . - API addition : Tree indentation can be customized . - Fixed GlyphLayout not respecting BitmapFontData # down . +- API Addition : Added FileHandle # map ( ) , can be used to memory map a file - API Addition : Added faceIndex paramter to # FreeTypeFontGenerator ( FileHandle , int ) . - API Change : BitmapFont # getSpaceWidth changed to BitmapFont # getSpaceXadvance . - Many GlyphLayout fixes . diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java index 1eb4142..6328680 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidFileHandle.java @ @ -18,9 +18,13 @ @ package com.badlogic.gdx.backends.android ; import java.io.File ; import java.io.FileFilter ; +import java.io.FileInputStream ; import java.io.FilenameFilter ; import java.io.IOException ; import java.io.InputStream ; +import java.nio.ByteBuffer ; +import java.nio.ByteOrder ; +import java.nio.channels.FileChannel ; import android.content.res.AssetFileDescriptor ; import android.content.res.AssetManager ; @ @ -29,6 +33,7 @ @ import com.badlogic.gdx.Files.FileType ; import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.files.FileHandle ; import com.badlogic.gdx.utils.GdxRuntimeException ; +import com.badlogic.gdx.utils.StreamUtils ; /** @ author mzechner * @ author Nathan Sweet */ @ @ -80,6 +85,24 @ @ public class *.wav music not played in deployed .jar __EoT__ Please ensure you have given all the following requested information in your report . # # # # Issue details I built a very simple prototype of a game . I have some .ogg / .wav / .mp3 files for audio . During debugging in IDEA everything is fine . When the application is deployed only .ogg and .mp3 music files are played . # # # # Reproduction steps/code Music menuMusic = Gdx.audio.newMusic ( Gdx.files.internal ( `` audio/menu_screen_loop.wav '' ) ) ; menuMusic.play ( ) ; < -- -- - this does not work Music gameMusic = Gdx.audio.newMusic ( Gdx.files.internal ( `` audio/DST-DustLoop.mp3 '' ) ) ; gameMusic.play ( ) ; < -- -- -- this does work . https : //github.com/Naxos84/TestRepo.git # # # # Version of LibGDX and/or relevant dependencies Libgdx 1.9.8 Gradle Wrapper : https\ : //services.gradle.org/distributions/gradle-2.14.1-bin.zip # # # # Stacktrace `` ` java No Stacktrace available `` ` # # # # Please select the affected platforms - [ ] Android - [ ] iOS ( robovm ) - [ ] iOS ( MOE ) - [ ] HTML/GWT - [ x ] Windows - [
diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java index f8500bb..d4893a9 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java @ @ -1,529 +1,530 @ @ -/******************************************************************************* - * Copyright 2011 See AUTHORS file . - * - * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - * you may not use this file except in compliance with the License . - * You may obtain a copy of the License at - * - * http : //www.apache.org/licenses/LICENSE-2.0 - * - * Unless required by applicable law or agreed to in writing , software - * distributed under the License is distributed on an `` AS IS '' BASIS , - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . - * See the License for the specific language governing permissions and - * limitations under the License . - ******************************************************************************/ - -package com.badlogic.gdx.backends.android ; - -import android.annotation.TargetApi ; -import android.app.Activity ; -import android.content.Context ; -import android.content.Intent ; -import android.content.res.Configuration ; -import android.os.Build ; -import android.os.Bundle ; -import android.os.Debug ; -import android.os.Handler ; -import android.util.Log ; -import android.view.Gravity ; -import android.view.View ; -import android.view.Window ; -import android.view.WindowManager ; -import android.widget.FrameLayout ; - -import *.wav music not played in deployed .jar __EoT__ Please ensure you have given all the following requested information in your report . # # # # Issue details I built a very simple prototype of a game . I have some .ogg / .wav / .mp3 files for audio . During debugging in IDEA everything is fine . When the application is deployed only .ogg and .mp3 music files are played . # # # # Reproduction steps/code Music menuMusic = Gdx.audio.newMusic ( Gdx.files.internal ( `` audio/menu_screen_loop.wav '' ) ) ; menuMusic.play ( ) ; < -- -- - this does not work Music gameMusic = Gdx.audio.newMusic ( Gdx.files.internal ( `` audio/DST-DustLoop.mp3 '' ) ) ; gameMusic.play ( ) ; < -- -- -- this does work . https : //github.com/Naxos84/TestRepo.git # # # # Version of LibGDX and/or relevant dependencies Libgdx 1.9.8 Gradle Wrapper : https\ : //services.gradle.org/distributions/gradle-2.14.1-bin.zip # # # # Stacktrace `` ` java No Stacktrace available `` ` # # # # Please select the affected platforms - [ ] Android - [ ] iOS ( robovm ) - [ ] iOS ( MOE ) - [ ] HTML/GWT - [ x ] Windows - [
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/ParticleEffect.java b/gdx/src/com/badlogic/gdx/graphics/g2d/ParticleEffect.java index 18f6977..82b8f4c 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g2d/ParticleEffect.java +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/ParticleEffect.java @ @ -22,7 +22,6 @ @ import java.io.IOException ; import java.io.InputStream ; import java.io.InputStreamReader ; import java.io.Writer ; -import java.util.HashMap ; import com.badlogic.gdx.files.FileHandle ; import com.badlogic.gdx.graphics.Texture ; @ @ -30,6 +29,7 @ @ import com.badlogic.gdx.math.collision.BoundingBox ; import com.badlogic.gdx.utils.Array ; import com.badlogic.gdx.utils.Disposable ; import com.badlogic.gdx.utils.GdxRuntimeException ; +import com.badlogic.gdx.utils.ObjectMap ; import com.badlogic.gdx.utils.StreamUtils ; /** See < a href= '' http : //www.badlogicgames.com/wordpress/ ? p=1255 '' > http : //www.badlogicgames.com/wordpress/ ? p=1255 < /a > @ @ -205,7 +205,7 @ @ public class ParticleEffect implements Disposable { public void loadEmitterImages ( FileHandle imagesDir ) { ownsTexture = true ; - HashMap < String , Sprite > loadedSprites = new HashMap < String , Sprite > ( emitters.size ) ; + ObjectMap < String , Sprite > loadedSprites = new ObjectMap < String , Sprite > ( emitters.size ) ; for ( int i = 0 , n = emitters.size ; i < n ; i++ ) { ParticleEmitter emitter = emitters.get ( i ) ; if ( emitter.getImagePaths ( ) .size == 0 ) continue ; *.wav music not played in deployed .jar __EoT__ Please ensure you have given all the following requested information in your report . # # # # Issue details I built a very simple prototype of a game . I have some .ogg / .wav / .mp3 files for audio . During debugging in IDEA everything is fine . When the application is deployed only .ogg and .mp3 music files are played . # # # # Reproduction steps/code Music menuMusic = Gdx.audio.newMusic ( Gdx.files.internal ( `` audio/menu_screen_loop.wav '' ) ) ; menuMusic.play ( ) ; < -- -- - this does not work Music gameMusic = Gdx.audio.newMusic ( Gdx.files.internal ( `` audio/DST-DustLoop.mp3 '' ) ) ; gameMusic.play ( ) ; < -- -- -- this does work . https : //github.com/Naxos84/TestRepo.git # # # # Version of LibGDX and/or relevant dependencies Libgdx 1.9.8 Gradle Wrapper : https\ : //services.gradle.org/distributions/gradle-2.14.1-bin.zip # # # # Stacktrace `` ` java No Stacktrace available `` ` # # # # Please select the affected platforms - [ ] Android - [ ] iOS ( robovm ) - [ ] iOS ( MOE ) - [ ] HTML/GWT - [ x ] Windows - [
diff -- git a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeType.java b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeType.java index 33a74c1..7980871 100644 -- - a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeType.java +++ b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeType.java @ @ -67,7 +67,8 @ @ public class FreeType { public void dispose ( ) { doneFreeType ( address ) ; for ( ByteBuffer buffer : fontData.values ( ) ) { - BufferUtils.disposeUnsafeByteBuffer ( buffer ) ; + if ( BufferUtils.isUnsafeByteBuffer ( buffer ) ) + BufferUtils.disposeUnsafeByteBuffer ( buffer ) ; } } @ @ -139,7 +140,8 @ @ public class FreeType { ByteBuffer buffer = library.fontData.get ( address ) ; if ( buffer ! = null ) { library.fontData.remove ( address ) ; - BufferUtils.disposeUnsafeByteBuffer ( buffer ) ; + if ( BufferUtils.isUnsafeByteBuffer ( buffer ) ) + BufferUtils.disposeUnsafeByteBuffer ( buffer ) ; } } diff -- git a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java index 813469a..dbda8e2 100755 -- - a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java +++ b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java @ @ -99,23 +99,32 @ @ public class FreeTypeFontGenerator implements Disposable { library = FreeType.initFreeType ( ) ; if ( library == null ) throw new GdxRuntimeException ( `` Could n't initialize FreeType '' ) ; - ByteBuffer buffer ; - InputStream input = fontFile.read ( ) ; + ByteBuffer buffer = null ; + try { - if ( fileSize == 0 ) { - // Copy TextArea crash in 1.9.9-SNAPSHOT with FreeType __EoT__ Please ensure you have given all the following requested information in your report . # # # # Issue details Since updating from 1.9.8 to 1.9.9-SNAPSHOT I 've been having a crash caused by a TextArea . TextFields work properly for me . This only happens when using a font created using FreeType . The `` times '' font I 'm using is the Windows builtin Times New Roman font ( C : /Windows/Fonts/times.ttf ) . # # # # Reproduction steps/code `` ` java public class ErrTest extends ApplicationAdapter { private FreeTypeFontGenerator g32 ; private BitmapFont u32 ; private Skin skin ; private Stage stage ; @ Override public void create ( ) { g32 = new FreeTypeFontGenerator ( Gdx.files.internal ( `` times.ttf '' ) ) ; FreeTypeFontParameter param = new FreeTypeFontParameter ( ) ; param.gamma = 1 ; param.incremental = true ; param.magFilter = TextureFilter.Linear ; param.minFilter = TextureFilter.Linear ; param.renderCount = 1 ; param.size = 32 ; u32 = g32.generateFont ( param ) ; u32.getData ( ) .markupEnabled = true ; skin = new Skin ( Gdx.files.internal ( `` uiskin.json '' ) ) ; skin.get ( TextFieldStyle.class ) .font =
diff -- git a/CHANGES b/CHANGES index cc2df03..9a81095 100755 -- - a/CHANGES +++ b/CHANGES @ @ -3,6 +3,12 @ @ - Update to Lwjgl 3.1.4 - Update android level we build against to 7.1 ( API 25 ) - API Change : gdx-tools no longer bundles dependencies to be compatible with java 9 +- Skin JSON files can now use the simple names of classes , i.e . `` BitmapFont '' rather than `` com.badlogic.gdx.graphics.g2d.BitmapFont '' . Custom classes can be added by overriding Skin.getJsonLoader ( ) and calling json.setClassTag ( ) . +- Skin supports cascading styles in JSON . Use the `` parent '' property to tag another style by name to use its values as defaults . See https : //github.com/libgdx/libgdx/blob/master/tests/gdx-tests-android/assets/data/uiskin.json for example . +- SkinLoader can be used on subclasses of Skin by overriding generateSkin ( ) . +- API addition : Tree indentation can be customized . +- Fixed GlyphLayout not respecting BitmapFontData # down . +- API Addition : Added faceIndex paramter to # FreeTypeFontGenerator ( FileHandle , int ) . [ 1.9.8 ] - Add iPhoneX images diff -- git a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java index f8500bb..f12d8d2 100644 -- - a/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java +++ b/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidApplication.java @ @ -25,7 +25,6 TextArea crash in 1.9.9-SNAPSHOT with FreeType __EoT__ Please ensure you have given all the following requested information in your report . # # # # Issue details Since updating from 1.9.8 to 1.9.9-SNAPSHOT I 've been having a crash caused by a TextArea . TextFields work properly for me . This only happens when using a font created using FreeType . The `` times '' font I 'm using is the Windows builtin Times New Roman font ( C : /Windows/Fonts/times.ttf ) . # # # # Reproduction steps/code `` ` java public class ErrTest extends ApplicationAdapter { private FreeTypeFontGenerator g32 ; private BitmapFont u32 ; private Skin skin ; private Stage stage ; @ Override public void create ( ) { g32 = new FreeTypeFontGenerator ( Gdx.files.internal ( `` times.ttf '' ) ) ; FreeTypeFontParameter param = new FreeTypeFontParameter ( ) ; param.gamma = 1 ; param.incremental = true ; param.magFilter = TextureFilter.Linear ; param.minFilter = TextureFilter.Linear ; param.renderCount = 1 ; param.size = 32 ; u32 = g32.generateFont ( param ) ; u32.getData ( ) .markupEnabled = true ; skin = new Skin ( Gdx.files.internal ( `` uiskin.json '' ) ) ; skin.get ( TextFieldStyle.class ) .font =
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g3d/particles/ParticleController.java b/gdx/src/com/badlogic/gdx/graphics/g3d/particles/ParticleController.java index 5272383..ecacdf6 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g3d/particles/ParticleController.java +++ b/gdx/src/com/badlogic/gdx/graphics/g3d/particles/ParticleController.java @ @ -16,6 +16,7 @ @ package com.badlogic.gdx.graphics.g3d.particles ; +import com.badlogic.gdx.Gdx ; import com.badlogic.gdx.assets.AssetManager ; import com.badlogic.gdx.graphics.g3d.particles.ParallelArray.FloatChannel ; import com.badlogic.gdx.graphics.g3d.particles.emitters.Emitter ; @ @ -219,6 +220,12 @ @ public class ParticleController implements Json.Serializable , ResourceData.Confi /** Updates the particles data */ public void update ( ) { + update ( Gdx.graphics.getDeltaTime ( ) ) ; + } + + /** Updates the particles data */ + public void update ( float deltaTime ) { + setTimeStep ( deltaTime ) ; emitter.update ( ) ; for ( Influencer influencer : influencers ) influencer.update ( ) ; diff -- git a/gdx/src/com/badlogic/gdx/graphics/g3d/particles/ParticleEffect.java b/gdx/src/com/badlogic/gdx/graphics/g3d/particles/ParticleEffect.java index 363bcf5..6fd4843 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g3d/particles/ParticleEffect.java +++ b/gdx/src/com/badlogic/gdx/graphics/g3d/particles/ParticleEffect.java @ @ -71,6 +71,11 @ @ public class ParticleEffect implements Disposable , ResourceData.Configurable { controllers.get ( i ) .update ( ) ; } + public void update ( float deltaTime ) { + for ( int i = 0 , n = controllers.size ; i < n ; i++ ) + controllers.get ( i ) .update ( deltaTime ) ; + } + public void draw ( ) { for ( int i = 0 , n = controllers.size ; TextArea crash in 1.9.9-SNAPSHOT with FreeType __EoT__ Please ensure you have given all the following requested information in your report . # # # # Issue details Since updating from 1.9.8 to 1.9.9-SNAPSHOT I 've been having a crash caused by a TextArea . TextFields work properly for me . This only happens when using a font created using FreeType . The `` times '' font I 'm using is the Windows builtin Times New Roman font ( C : /Windows/Fonts/times.ttf ) . # # # # Reproduction steps/code `` ` java public class ErrTest extends ApplicationAdapter { private FreeTypeFontGenerator g32 ; private BitmapFont u32 ; private Skin skin ; private Stage stage ; @ Override public void create ( ) { g32 = new FreeTypeFontGenerator ( Gdx.files.internal ( `` times.ttf '' ) ) ; FreeTypeFontParameter param = new FreeTypeFontParameter ( ) ; param.gamma = 1 ; param.incremental = true ; param.magFilter = TextureFilter.Linear ; param.minFilter = TextureFilter.Linear ; param.renderCount = 1 ; param.size = 32 ; u32 = g32.generateFont ( param ) ; u32.getData ( ) .markupEnabled = true ; skin = new Skin ( Gdx.files.internal ( `` uiskin.json '' ) ) ; skin.get ( TextFieldStyle.class ) .font =
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java index 91171a0..8fa05e1 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java @ @ -146,52 +146,60 @ @ public class GlyphLayout implements Poolable { glyphRunPool.free ( run ) ; else { runs.add ( run ) ; - - // Compute the run width , wrap if necessary , and position the run . float [ ] xAdvances = run.xAdvances.items ; - for ( int i = 0 , n = run.xAdvances.size ; i < n ; i++ ) { - float xAdvance = xAdvances [ i ] ; - x += xAdvance ; - - // Do n't wrap if the glyph would fit with just its width ( no xadvance or kerning ) . - if ( wrap & & x > targetWidth & & i > 1 - & & x - xAdvance + ( run.glyphs.get ( i - 1 ) .xoffset + run.glyphs.get ( i - 1 ) .width ) * fontData.scaleX - - 0.0001f > targetWidth ) { - - if ( truncate ! = null ) { - truncate ( fontData , run , targetWidth , truncate , i , glyphRunPool ) ; - x = run.x + run.width ; - break outer ; TextArea crash in 1.9.9-SNAPSHOT with FreeType __EoT__ Please ensure you have given all the following requested information in your report . # # # # Issue details Since updating from 1.9.8 to 1.9.9-SNAPSHOT I 've been having a crash caused by a TextArea . TextFields work properly for me . This only happens when using a font created using FreeType . The `` times '' font I 'm using is the Windows builtin Times New Roman font ( C : /Windows/Fonts/times.ttf ) . # # # # Reproduction steps/code `` ` java public class ErrTest extends ApplicationAdapter { private FreeTypeFontGenerator g32 ; private BitmapFont u32 ; private Skin skin ; private Stage stage ; @ Override public void create ( ) { g32 = new FreeTypeFontGenerator ( Gdx.files.internal ( `` times.ttf '' ) ) ; FreeTypeFontParameter param = new FreeTypeFontParameter ( ) ; param.gamma = 1 ; param.incremental = true ; param.magFilter = TextureFilter.Linear ; param.minFilter = TextureFilter.Linear ; param.renderCount = 1 ; param.size = 32 ; u32 = g32.generateFont ( param ) ; u32.getData ( ) .markupEnabled = true ; skin = new Skin ( Gdx.files.internal ( `` uiskin.json '' ) ) ; skin.get ( TextFieldStyle.class ) .font =
diff -- git a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeType.java b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeType.java index 33a74c1..7980871 100644 -- - a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeType.java +++ b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeType.java @ @ -67,7 +67,8 @ @ public class FreeType { public void dispose ( ) { doneFreeType ( address ) ; for ( ByteBuffer buffer : fontData.values ( ) ) { - BufferUtils.disposeUnsafeByteBuffer ( buffer ) ; + if ( BufferUtils.isUnsafeByteBuffer ( buffer ) ) + BufferUtils.disposeUnsafeByteBuffer ( buffer ) ; } } @ @ -139,7 +140,8 @ @ public class FreeType { ByteBuffer buffer = library.fontData.get ( address ) ; if ( buffer ! = null ) { library.fontData.remove ( address ) ; - BufferUtils.disposeUnsafeByteBuffer ( buffer ) ; + if ( BufferUtils.isUnsafeByteBuffer ( buffer ) ) + BufferUtils.disposeUnsafeByteBuffer ( buffer ) ; } } diff -- git a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java index 813469a..dbda8e2 100755 -- - a/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java +++ b/extensions/gdx-freetype/src/com/badlogic/gdx/graphics/g2d/freetype/FreeTypeFontGenerator.java @ @ -99,23 +99,32 @ @ public class FreeTypeFontGenerator implements Disposable { library = FreeType.initFreeType ( ) ; if ( library == null ) throw new GdxRuntimeException ( `` Could n't initialize FreeType '' ) ; - ByteBuffer buffer ; - InputStream input = fontFile.read ( ) ; + ByteBuffer buffer = null ; + try { - if ( fileSize == 0 ) { - // Copy [ HTML/GWT ] InputAdapter Basic Mouse Event Handling Bug __EoT__ # # # # Issue details In reference to the findings [ here ] ( https : //stackoverflow.com/questions/48718190/libgdx-mouse-event-detection ) , InputAdapter touchDown ( ) and touchUp ( ) events are not firing as expected when multiple mouse events occur in overlapping sequences for HTML/GWT . If left button is pressed , right button is never detected . But if the right button is pressed , left button is detected after the first try , and after that right button touchUp is not detected . # # # # Reproduction steps/code Given the snippet for handling Input Processing : `` ` Gdx.input.setInputProcessor ( new InputAdapter ( ) { @ Override public boolean touchDown ( int screenX , int screenY , int pointer , int button ) { Engine.console ( `` down : `` + pointer + `` `` + button ) ; return super.touchDown ( screenX , screenY , pointer , button ) ; } @ Override public boolean touchUp ( int screenX , int screenY , int pointer , int button ) { Engine.console ( `` up : `` + pointer + `` `` + button ) ; return super.touchUp
diff -- git a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java index 91171a0..8fa05e1 100644 -- - a/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java +++ b/gdx/src/com/badlogic/gdx/graphics/g2d/GlyphLayout.java @ @ -146,52 +146,60 @ @ public class GlyphLayout implements Poolable { glyphRunPool.free ( run ) ; else { runs.add ( run ) ; - - // Compute the run width , wrap if necessary , and position the run . float [ ] xAdvances = run.xAdvances.items ; - for ( int i = 0 , n = run.xAdvances.size ; i < n ; i++ ) { - float xAdvance = xAdvances [ i ] ; - x += xAdvance ; - - // Do n't wrap if the glyph would fit with just its width ( no xadvance or kerning ) . - if ( wrap & & x > targetWidth & & i > 1 - & & x - xAdvance + ( run.glyphs.get ( i - 1 ) .xoffset + run.glyphs.get ( i - 1 ) .width ) * fontData.scaleX - - 0.0001f > targetWidth ) { - - if ( truncate ! = null ) { - truncate ( fontData , run , targetWidth , truncate , i , glyphRunPool ) ; - x = run.x + run.width ; - break outer ; [ HTML/GWT ] InputAdapter Basic Mouse Event Handling Bug __EoT__ # # # # Issue details In reference to the findings [ here ] ( https : //stackoverflow.com/questions/48718190/libgdx-mouse-event-detection ) , InputAdapter touchDown ( ) and touchUp ( ) events are not firing as expected when multiple mouse events occur in overlapping sequences for HTML/GWT . If left button is pressed , right button is never detected . But if the right button is pressed , left button is detected after the first try , and after that right button touchUp is not detected . # # # # Reproduction steps/code Given the snippet for handling Input Processing : `` ` Gdx.input.setInputProcessor ( new InputAdapter ( ) { @ Override public boolean touchDown ( int screenX , int screenY , int pointer , int button ) { Engine.console ( `` down : `` + pointer + `` `` + button ) ; return super.touchDown ( screenX , screenY , pointer , button ) ; } @ Override public boolean touchUp ( int screenX , int screenY , int pointer , int button ) { Engine.console ( `` up : `` + pointer + `` `` + button ) ; return super.touchUp
diff -- git a/README.md b/README.md index a71d406..e5755a1 100644 -- - a/README.md +++ b/README.md @ @ -33,6 +33,15 @ @ Usage app : border_width= '' 2dp '' app : border_color= '' # FF000000 '' / > `` ` + ! [ CircleImageView ] ( https : //raw.githubusercontent.com/SimoneBellotti/CircleImageView/master/screenshot.gif ) + +Attributes + -- -- -- -- -- + +* `` ` app : border_width `` ` ( dimension ) +* `` ` app : border_color `` ` ( color ) +* `` ` app : selector_color `` ` ( color ) +* `` ` app : selector_border_color `` ` ( color ) Limitations -- -- -- -- -- - diff -- git a/build.gradle b/build.gradle index 55a5fd9..e9475e2 100644 -- - a/build.gradle +++ b/build.gradle @ @ -4,7 +4,7 @ @ buildscript { } dependencies { - classpath 'com.android.tools.build : gradle:0.14.2' + classpath 'com.android.tools.build : gradle:0.12.+' } } diff -- git a/circleimageview/src/main/java/de/hdodenhof/circleimageview/CircleImageView.java b/circleimageview/src/main/java/de/hdodenhof/circleimageview/CircleImageView.java index ed5b125..b174425 100644 -- - a/circleimageview/src/main/java/de/hdodenhof/circleimageview/CircleImageView.java +++ b/circleimageview/src/main/java/de/hdodenhof/circleimageview/CircleImageView.java @ @ -6,8 +6,11 @ @ import android.graphics.Bitmap ; import android.graphics.BitmapShader ; import android.graphics.Canvas ; import android.graphics.Color ; +import android.graphics.ColorFilter ; import android.graphics.Matrix ; import android.graphics.Paint ; +import android.graphics.PorterDuff ; +import android.graphics.PorterDuffColorFilter ; import android.graphics.RectF ; import android.graphics.Shader ; import android.graphics.drawable.BitmapDrawable ; @ @ selector drawable support ? __EoT__
diff -- git a/.travis.yml b/.travis.yml index 088068b..b320311 100755 -- - a/.travis.yml +++ b/.travis.yml @ @ -16,4 +16,4 @ @ android : before_script : - chmod +x gradlew -script : `` ./gradlew build '' \ No newline at end of file +script : `` ./gradlew build '' diff -- git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties index f7d0e81..e167837 100644 -- - a/gradle/wrapper/gradle-wrapper.properties +++ b/gradle/wrapper/gradle-wrapper.properties @ @ -1,6 +1,6 @ @ - # Thu Apr 02 14:03:42 CEST 2015 + # Fri Jul 15 15:31:52 CEST 2016 distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists zipStoreBase=GRADLE_USER_HOME zipStorePath=wrapper/dists -distributionUrl=https\ : //services.gradle.org/distributions/gradle-2.12-all.zip +distributionUrl=https\ : //services.gradle.org/distributions/gradle-2.14-bin.zip diff -- git a/gradlew b/gradlew index 91a7e26..27309d9 100755 -- - a/gradlew +++ b/gradlew @ @ -6,12 +6,30 @ @ # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # - # Add default JVM options here . You can Bitmap too large to be uploaded into a texture error __EoT__ Whenever i load high quality photos and zoom the photos . I am getting Bitmap too large to be uploaded into a texture error and the image view background is hidden . After that only the blank image view is being shown .
diff -- git a/src/main/java/com/alibaba/fastjson/parser/DefaultJSONParser.java b/src/main/java/com/alibaba/fastjson/parser/DefaultJSONParser.java index 105dc67..79e439d 100755 -- - a/src/main/java/com/alibaba/fastjson/parser/DefaultJSONParser.java +++ b/src/main/java/com/alibaba/fastjson/parser/DefaultJSONParser.java @ @ -194,9 +194,9 @ @ public class DefaultJSONParser extends AbstractJSONParser implements Closeable { throw new JSONException ( `` syntax error , expect { , actual `` + lexer.tokenName ( ) ) ; } - ParseContext context = this.getContext ( ) ; + ParseContext objContext = this.getContext ( ) ; + setContext ( object , fieldName ) ; try { - boolean setContextFlag = false ; for ( ; ; ) { lexer.skipWhitespace ( ) ; char ch = lexer.getCurrent ( ) ; @ @ -332,7 +332,7 @ @ public class DefaultJSONParser extends AbstractJSONParser implements Closeable { refValue = this.getContext ( ) .getObject ( ) ; } } else if ( `` .. '' .equals ( ref ) ) { - ParseContext parentContext = context.getParentContext ( ) ; + ParseContext parentContext = objContext.getParentContext ( ) ; if ( parentContext.getObject ( ) ! = null ) { refValue = parentContext.getObject ( ) ; } else { @ @ -340,7 +340,7 @ @ public class DefaultJSONParser extends AbstractJSONParser implements Closeable { setResolveStatus ( DefaultJSONParser.NeedToResolve ) ; } } else if ( `` $ '' .equals ( ref ) ) 还是引用的问题 __EoT__ JSON如下 , `` $ ref '' : `` $ [ 0 ] .dataType '' 为空 , `` version '' : { `` $ ref '' : `` $ [ 0 ] .version '' } 为空 `` ` [ { '' dataType '' : { `` categoryType '' : { `` dataTypes '' : [ { `` $ ref '' : `` $ [ 0 ] .dataType '' } , { `` categoryType '' : { `` $ ref '' : `` $ [ 0 ] .dataType.categoryType '' } , `` id '' : 6 } , { `` categoryType '' : { `` $ ref '' : `` $ [ 0 ] .dataType.categoryType '' } , `` id '' : 7 } , { `` categoryType '' : { `` $ ref '' : `` $ [ 0 ] .dataType.categoryType '' } , `` id '' : 51 } ] } } , '' type '' : { `` $ ref '' : `` $ [ 0 ] .dataType.categoryType '' } , '' version '' : { `` available '' : true , `` id '' : 6001 } } , { '' dataType '' : { ``
diff -- git a/src/main/java/com/alibaba/druid/mock/handler/MySqlMockExecuteHandlerImpl.java b/src/main/java/com/alibaba/druid/mock/handler/MySqlMockExecuteHandlerImpl.java index e7bee2b..98af58a 100644 -- - a/src/main/java/com/alibaba/druid/mock/handler/MySqlMockExecuteHandlerImpl.java +++ b/src/main/java/com/alibaba/druid/mock/handler/MySqlMockExecuteHandlerImpl.java @ @ -44,7 +44,6 @ @ import com.alibaba.druid.sql.ast.statement.SQLSelectQuery ; import com.alibaba.druid.sql.ast.statement.SQLSelectQueryBlock ; import com.alibaba.druid.sql.ast.statement.SQLSelectStatement ; import com.alibaba.druid.sql.ast.statement.SQLTableSource ; -import com.alibaba.druid.sql.dialect.mysql.ast.expr.MySqlBooleanExpr ; import com.alibaba.druid.sql.dialect.mysql.ast.statement.CobarShowStatus ; import com.alibaba.druid.sql.dialect.mysql.parser.MySqlStatementParser ; import com.alibaba.druid.sql.parser.SQLStatementParser ; diff -- git a/src/main/java/com/alibaba/druid/sql/dialect/mysql/parser/MySqlExprParser.java b/src/main/java/com/alibaba/druid/sql/dialect/mysql/parser/MySqlExprParser.java index 3be6b62..a789658 100644 -- - a/src/main/java/com/alibaba/druid/sql/dialect/mysql/parser/MySqlExprParser.java +++ b/src/main/java/com/alibaba/druid/sql/dialect/mysql/parser/MySqlExprParser.java @ @ -22,7 +22,6 @ @ import com.alibaba.druid.sql.ast.SQLOrderBy ; import com.alibaba.druid.sql.ast.expr.SQLAggregateExpr ; import com.alibaba.druid.sql.ast.expr.SQLBinaryOpExpr ; import com.alibaba.druid.sql.ast.expr.SQLBinaryOperator ; -import com.alibaba.druid.sql.ast.expr.SQLBooleanExpr ; import com.alibaba.druid.sql.ast.expr.SQLCharExpr ; import com.alibaba.druid.sql.ast.expr.SQLHexExpr ; import com.alibaba.druid.sql.ast.expr.SQLIdentifierExpr ; diff -- git a/src/main/java/com/alibaba/druid/support/monitor/MonitorClient.java b/src/main/java/com/alibaba/druid/support/monitor/MonitorClient.java index 94499b8..c6a8584 100644 -- - a/src/main/java/com/alibaba/druid/support/monitor/MonitorClient.java +++ b/src/main/java/com/alibaba/druid/support/monitor/MonitorClient.java @ @ -1,504 +1,503 @ @ -/* - * Copyright 1999-2011 Alibaba Group Holding Ltd. - * - * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - * you may not use this file except in compliance with the License . - * You may obtain a copy of the License at - * - * http : //www.apache.org/licenses/LICENSE-2.0 - * - * Unless required by applicable law or agreed to in writing , software - * distributed under the License is distributed on an `` AS IS '' BASIS , - * sqlserver 的 url 怎么无法识别 __EoT__ sqlserver 2005 之后的 url 可以直接写 jdbc : sqlsever 了，但是 druid 1.0.6版本识别有问题，查了下源码，在 JdbcUtils.java 中的 getDriverClassName ( ) 和 getDbType ( ) 中对 rawUrl 的分析不一致，前者处理了 `` jdbc : sqlserver : '' ，而后者没有处理，这是怎么回事呢？另外后者方法签名里的参数 ” String driverClassName “ 是做什么用的？
diff -- git a/doc/alibaba-oss-code-format.xml b/doc/alibaba-oss-code-format.xml index 914899f..7bac4d9 100644 -- - a/doc/alibaba-oss-code-format.xml +++ b/doc/alibaba-oss-code-format.xml @ @ -1,279 +1,279 @ @ - < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' standalone= '' no '' ? > - < profiles version= '' 11 '' > - < profile kind= '' CodeFormatterProfile '' name= '' alibaba-oss-code-format '' version= '' 11 '' > - < setting id= '' org.eclipse.jdt.core.formatter.comment.insert_new_line_before_root_tags '' value= '' insert '' / > - < setting id= '' org.eclipse.jdt.core.formatter.disabling_tag '' value= '' @ formatter : off '' / > - < setting id= '' org.eclipse.jdt.core.formatter.insert_space_after_comma_in_annotation '' value= '' insert '' / > - < setting id= '' org.eclipse.jdt.core.formatter.insert_space_before_comma_in_type_parameters '' value= '' do not insert '' / > - < setting id= '' org.eclipse.jdt.core.formatter.insert_space_before_opening_brace_in_type_declaration '' value= '' insert '' / > - < setting id= '' org.eclipse.jdt.core.formatter.insert_space_after_comma_in_type_arguments '' value= '' insert '' / > - < setting id= '' org.eclipse.jdt.core.formatter.brace_position_for_anonymous_type_declaration '' value= '' end_of_line '' / > - < setting id= '' org.eclipse.jdt.core.formatter.insert_space_before_colon_in_case '' value= '' do not insert '' / > - < setting id= '' org.eclipse.jdt.core.formatter.insert_space_after_opening_brace_in_array_initializer '' value= '' insert '' / > - < setting id= '' org.eclipse.jdt.core.formatter.comment.new_lines_at_block_boundaries '' value= '' true '' / > - < sqlserver 的 url 怎么无法识别 __EoT__ sqlserver 2005 之后的 url 可以直接写 jdbc : sqlsever 了，但是 druid 1.0.6版本识别有问题，查了下源码，在 JdbcUtils.java 中的 getDriverClassName ( ) 和 getDbType ( ) 中对 rawUrl 的分析不一致，前者处理了 `` jdbc : sqlserver : '' ，而后者没有处理，这是怎么回事呢？另外后者方法签名里的参数 ” String driverClassName “ 是做什么用的？
diff -- git a/app/AndroidManifest.xml b/app/AndroidManifest.xml index b395426..a961d10 100644 -- - a/app/AndroidManifest.xml +++ b/app/AndroidManifest.xml @ @ -254,8 +254,10 @ @ < data android : host= '' github.com '' - android : scheme= '' http '' / > + android : scheme= '' http '' + android : pathPrefix= '' / '' / > + < category android : name= '' android.intent.category.BROWSABLE '' / > < category android : name= '' android.intent.category.DEFAULT '' / > < /intent-filter > < intent-filter > @ @ -263,8 +265,10 @ @ < data android : host= '' github.com '' - android : scheme= '' https '' / > + android : scheme= '' https '' + android : pathPrefix= '' / '' / > + < category android : name= '' android.intent.category.BROWSABLE '' / > < category android : name= '' android.intent.category.DEFAULT '' / > < /intent-filter > < intent-filter > @ @ -272,8 +276,10 @ @ < data android : host= '' gist.github.com '' - android : scheme= '' http '' / > + android : scheme= '' http '' + android : pathPrefix= '' / '' / > + < category android : name= '' android.intent.category.BROWSABLE '' / > < category android : name= GitHub links do n't offer the app from K9 Mail __EoT__ When I receive a notification email from GitHub and tap on the link to `` View this on GitHub '' , I get a list of browsers as a choice , but not the GitHub app . However , if I tap and hold on the link , then choose Open Link , I now have a choice of apps including the GitHub app . Maybe a bug in K9 Mail or could it be in the GitHub app ?
diff -- git a/.gitignore b/.gitignore index 1848b97..46b75cd 100644 -- - a/.gitignore +++ b/.gitignore @ @ -1,11 +1,12 @ @ +.gradle +/local.properties +/build */target -target tmp *~ bin */test-output temp-testng-customsuite.xml -**pom.xml.releaseBackup release.properties gen */seed.txt @ @ -16,4 +17,4 @ @ gen-external-apklibs *.iml .DS_Store *.swp -out +out \ No newline at end of file diff -- git a/.idea/compiler.xml b/.idea/compiler.xml new file mode 100644 index 0000000..217af47 -- - /dev/null +++ b/.idea/compiler.xml @ @ -0,0 +1,23 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < project version= '' 4 '' > + < component name= '' CompilerConfiguration '' > + < option name= '' DEFAULT_COMPILER '' value= '' Javac '' / > + < resourceExtensions / > + < wildcardResourcePatterns > + < entry name= '' ! ? *.java '' / > + < entry name= '' ! ? *.form '' / > + < entry name= '' ! ? *.class '' / > + < entry name= '' ! ? *.groovy '' / > + < entry name= '' ! ? *.scala '' / > + < entry name= '' ! ? *.flex '' / > + < entry name= '' ! ? *.kt Integrate with Google 's Navigation Drawer __EoT__ http : //developer.android.com/training/implementing-navigation/nav-drawer.html
diff -- git a/.gitignore b/.gitignore index 1848b97..a2a9f90 100644 -- - a/.gitignore +++ b/.gitignore @ @ -1,11 +1,12 @ @ +.gradle +/local.properties +/build */target -target tmp *~ bin */test-output temp-testng-customsuite.xml -**pom.xml.releaseBackup release.properties gen */seed.txt diff -- git a/.idea/copyright/profiles_settings.xml b/.idea/copyright/profiles_settings.xml new file mode 100644 index 0000000..e7bedf3 -- - /dev/null +++ b/.idea/copyright/profiles_settings.xml @ @ -0,0 +1,3 @ @ + < component name= '' CopyrightManager '' > + < settings default= '' '' / > + < /component > \ No newline at end of file diff -- git a/.idea/scopes/scope_settings.xml b/.idea/scopes/scope_settings.xml new file mode 100644 index 0000000..922003b -- - /dev/null +++ b/.idea/scopes/scope_settings.xml @ @ -0,0 +1,5 @ @ + < component name= '' DependencyValidationManager '' > + < state > + < option name= '' SKIP_IMPORT_STATEMENTS '' value= '' false '' / > + < /state > + < /component > \ No newline at end of file diff -- git a/app/.gitignore b/app/.gitignore new file mode 100644 index 0000000..796b96d -- - /dev/null +++ b/app/.gitignore @ @ -0,0 +1 @ @ +/build diff -- git a/app/app.iml b/app/app.iml new file mode 100644 index 0000000..13a730a -- - /dev/null +++ b/app/app.iml @ @ -0,0 +1,126 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 Integrate with Google 's Navigation Drawer __EoT__ http : //developer.android.com/training/implementing-navigation/nav-drawer.html
diff -- git a/app/build.gradle b/app/build.gradle index 269879d..80baf7a 100644 -- - a/app/build.gradle +++ b/app/build.gradle @ @ -44,6 +44,8 @ @ repositories { dependencies { compile fileTree ( dir : 'libs ' , include : [ '*.jar ' ] ) compile 'com.android.support : appcompat-v7:21.0.3' + compile 'com.squareup.picasso : picasso:2.5.0' + compile 'com.squareup.okhttp : okhttp:2.3.0' compile 'org.roboguice : roboguice:2.0' compile 'com.github.kevinsawicki : http-request:5.6' compile 'com.google.code.gson : gson:2.3.1' diff -- git a/app/res/layout/user_item.xml b/app/res/layout/user_item.xml index 538745f..6776cb7 100644 -- - a/app/res/layout/user_item.xml +++ b/app/res/layout/user_item.xml @ @ -17,11 +17,12 @ @ < LinearLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' style= '' @ style/ListItem '' android : gravity= '' center_vertical '' - android : orientation= '' horizontal '' > + android : orientation= '' horizontal '' > < ImageView android : id= '' @ +id/iv_avatar '' style= '' @ style/AvatarLarge '' + android : src= '' @ drawable/gravatar_icon '' android : contentDescription= '' @ string/avatar '' / > < TextView @ @ -33,4 +34,4 @ @ android : singleLine= '' true '' android : textStyle= '' normal '' / > - < /LinearLayout > \ No newline at end of file + < /LinearLayout > diff -- git a/app/src/main/java/com/github/mobile/ui/search/SearchUserListAdapter.java b/app/src/main/java/com/github/mobile/ui/search/SearchUserListAdapter.java index e39da04..8199e1e 100644 -- - a/app/src/main/java/com/github/mobile/ui/search/SearchUserListAdapter.java +++ Crash in gist 's `` all tab '' , NullPointerException __EoT__ Commit 7bee3b232c876db7c9f80a753079b690b4db8927 ! [ git ] ( http : //7tsy92.com1.z0.glb.clouddn.com/commit_7bee3b232c876db7c9f80a753079b690b4db8927.gif ) Log message : `` ` brash 04-16 08:27:14.040 : E/AndroidRuntime ( 2054 ) : FATAL EXCEPTION : main 04-16 08:27:14.040 : E/AndroidRuntime ( 2054 ) : Process : com.github.mobile , PID : 2054 04-16 08:27:14.040 : E/AndroidRuntime ( 2054 ) : java.lang.NullPointerException : Attempt to invoke virtual method 'java.lang.String org.eclipse.egit.github.core.User.getAvatarUrl ( ) ' on a null object reference 04-16 08:27:14.040 : E/AndroidRuntime ( 2054 ) : at com.github.mobile.util.AvatarLoader.getAvatarUrl ( AvatarLoader.java:200 ) 04-16 08:27:14.040 : E/AndroidRuntime ( 2054 ) : at com.github.mobile.util.AvatarLoader.bind ( AvatarLoader.java:159 ) 04-16 08:27:14.040 : E/AndroidRuntime ( 2054 ) : at com.github.mobile.ui.gist.GistListAdapter.update ( GistListAdapter.java:91 ) 04-16 08:27:14.040 : E/AndroidRuntime ( 2054 ) : at com.github.mobile.ui.gist.GistListAdapter.update ( GistListAdapter.java:37 ) 04-16 08:27:14.040 : E/AndroidRuntime ( 2054 ) : at com.github.kevinsawicki.wishlist.SingleTypeAdapter.update ( SingleTypeAdapter.java:164 ) 04-16 08:27:14.040 : E/AndroidRuntime ( 2054 ) : at com.github.kevinsawicki.wishlist.SingleTypeAdapter.getView ( SingleTypeAdapter.java:180 ) 04-16 08:27:14.040 : E/AndroidRuntime ( 2054 ) : at android.widget.HeaderViewListAdapter.getView ( HeaderViewListAdapter.java:220 ) 04-16 08:27:14.040 : E/AndroidRuntime ( 2054 ) : at android.widget.AbsListView.obtainView ( AbsListView.java:2344 ) 04-16 08:27:14.040 : E/AndroidRuntime ( 2054 ) : at android.widget.ListView.makeAndAddView ( ListView.java:1864 ) 04-16 08:27:14.040 :
diff -- git a/pom.xml b/pom.xml index eff0336..3ac35ef 100644 -- - a/pom.xml +++ b/pom.xml @ @ -190,6 +190,9 @ @ < configuration > < forkCount > 1 < /forkCount > < reuseForks > false < /reuseForks > + < excludes > + < exclude > **/spark/route/RouteOverviewTest.java < /exclude > < ! -- Test works in IntelliJ , functionality works in jar , but this fails during mvn install -- > + < /excludes > < /configuration > < /plugin > < plugin > diff -- git a/src/main/java/spark/FilterImpl.java b/src/main/java/spark/FilterImpl.java index dacecb1..b1d5f8c 100644 -- - a/src/main/java/spark/FilterImpl.java +++ b/src/main/java/spark/FilterImpl.java @ @ -29,6 +29,7 @ @ public abstract class FilterImpl implements Filter { private String path ; private String acceptType ; + private Filter targetFilter ; /** * Wraps the filter in FilterImpl @ @ -53,7 +54,7 @ @ public abstract class FilterImpl implements Filter { if ( acceptType == null ) { acceptType = DEFAULT_ACCEPT_TYPE ; } - return new FilterImpl ( path , acceptType ) { + return new FilterImpl ( path , acceptType , filter ) { @ Override public void handle ( Request request , Response response ) throws Exception { filter.handle ( request , response ) ; @ @ -66,6 Not possible to override headers __EoT__ The **header ( String header , String value ) ** method only adds headers ( contrary to what the javadoc states ) `` ` response.header ( `` X-Frame-Options '' , `` DENY '' ) ; response.header ( `` X-Frame-Options '' , `` SAMEORIGIN '' ) ; //X-Frame-Options is now `` DENY , SAMEORIGIN '' `` ` I suggest setHeader and addHeader . **Current workaround** ` response.raw ( ) .setHeader ( `` X-Frame-Options '' , `` SAMEORIGIN '' ) ; `
diff -- git a/src/main/java/spark/resource/ClassPathResource.java b/src/main/java/spark/resource/ClassPathResource.java index dd8ba97..e4b19f5 100644 -- - a/src/main/java/spark/resource/ClassPathResource.java +++ b/src/main/java/spark/resource/ClassPathResource.java @ @ -23,6 +23,7 @ @ import java.net.URL ; import spark.utils.Assert ; import spark.utils.ClassUtils ; +import spark.utils.ResourceUtils ; import spark.utils.StringUtils ; /** @ @ -74,7 +75,7 @ @ public class ClassPathResource extends AbstractFileResolvingResource { */ public ClassPathResource ( String path , ClassLoader classLoader ) { Assert.notNull ( path , `` Path must not be null '' ) ; - Assert.state ( doesNotContainFileColon ( path ) , `` Path must not contain 'file : ' '' ) ; + Assert.isTrue ( isValid ( path ) , `` Path is not valid '' ) ; String pathToUse = StringUtils.cleanPath ( path ) ; @ @ -86,8 +87,27 @ @ public class ClassPathResource extends AbstractFileResolvingResource { this.classLoader = ( classLoader ! = null ? classLoader : ClassUtils.getDefaultClassLoader ( ) ) ; } - private static boolean doesNotContainFileColon ( String path ) { - return ! path.contains ( `` file : '' ) ; + private static boolean isValid ( final String path ) { + return ! isInvalidPath ( path ) ; + } + + private static boolean isInvalidPath ( String path ) { + if ( path.contains ( Where Can I Report Security Vulnerability ? __EoT__ HI , I found a vulnerability and followed the [ steps ] ( http : //sparkjava.com/news # vulnerability ) , and sent mail to people on [ this page ] ( http : //sparkjava.com/contact ) . But seems one of these mail addresses are not exists and there are no reply for 3 days . Could you check the mail box ? Thanks !
diff -- git a/400.html b/400.html new file mode 100644 index 0000000..db5b392 -- - /dev/null +++ b/400.html @ @ -0,0 +1 @ @ + < html > < body > Yo ! yo ! custom error..Hello Static World ! ! ! ! < /body > < /html > \ No newline at end of file diff -- git a/500.html b/500.html new file mode 100644 index 0000000..78efd52 -- - /dev/null +++ b/500.html @ @ -0,0 +1,10 @ @ + < ! DOCTYPE html > + < html > + < head lang= '' en '' > + < meta charset= '' UTF-8 '' > + < title > < /title > + < /head > + < body > +Yo ! yo ! custom 500 error..Hello Static World ! + < /body > + < /html > \ No newline at end of file diff -- git a/pom.xml b/pom.xml index 931326c..f7085f5 100644 -- - a/pom.xml +++ b/pom.xml @ @ -85,6 +85,11 @ @ < version > 2.2.4 < /version > < scope > test < /scope > < /dependency > + < dependency > + < groupId > commons-io < /groupId > + < artifactId > commons-io < /artifactId > + < Enable custom error pages , when deploy Sparkjava embedded by ( Jetty ) __EoT__ - Can not config custom error pages when deploy SparkJava embedded by Jetty - Description : Jetty 9 config - contextPath = `` / '' - jetty base folder ... ... ./webapps/ ... ... ... ... ... ./WEB-INF/ ... ... ... ... ... ./WEB-INF/lib/ ... ... ... ... ... ./WEB-INF/web.xml ... ... ... ... ... ./errors/ ... ... ... ... ... ... ... ... ... /404.html ... ... ... ... ... ... ... ... ... /500.html - web.xml setting custom errors `` ` xml < error-page > < error-code > 404 < /error-code > < location > /errors/404.html < /location > < /error-page > `` ` When access /not_exists , current 404 error page return by Sparkjava embedded by Jetty is : `` ` code HTTP ERROR 404 Problem accessing /errors/404.html . Reason : Not Found Powered by Jetty : // `` ` # # Expectation Url should redirect from : /not_exists to /errors/404.html
diff -- git a/src/main/java/spark/FilterImpl.java b/src/main/java/spark/FilterImpl.java index 4c867f1..51c3a7a 100644 -- - a/src/main/java/spark/FilterImpl.java +++ b/src/main/java/spark/FilterImpl.java @ @ -72,5 +72,4 @ @ public abstract class FilterImpl implements Filter { String getPath ( ) { return this.path ; } - } \ No newline at end of file diff -- git a/src/main/java/spark/FinallyFilter.java b/src/main/java/spark/FinallyFilter.java new file mode 100644 index 0000000..efadb60 -- - /dev/null +++ b/src/main/java/spark/FinallyFilter.java @ @ -0,0 +1,14 @ @ +package spark ; + +/** + * Markup abstract class + * + * @ author Bortolozzo + * + */ +public abstract class FinallyFilter extends FilterImpl { + + public FinallyFilter ( String path , String acceptType ) { + super ( path , acceptType ) ; + } + } \ No newline at end of file diff -- git a/src/main/java/spark/Spark.java b/src/main/java/spark/Spark.java index 25ca89e..3622fac 100755 -- - a/src/main/java/spark/Spark.java +++ b/src/main/java/spark/Spark.java @ @ -16,6 +16,10 @ @ */ package spark ; +import static java.util.Objects.requireNonNull ; + +import org.eclipse.jetty.server.HttpConnectionFactory ; + import spark.exception.ExceptionHandlerImpl ; import spark.exception.ExceptionMapper ; import spark.route.HttpMethod ; @ @ -151,7 +155,18 @ @ public final class Spark extends SparkBase { public static synchronized void after ( String path , Filter filter ) { addFilter ( HttpMethod.after.name ( ) , wrap ( Need a finally ( ) or around ( ) filter to do proper transactions __EoT__ Currently it is not possible to do a reliable transaction filter with Spark . The problem : after ( ) runs only on successful requests exception ( ) runs only the filter with matching exception , i.e . it is not possible to register another 'global ' exception handler that would run on any error Some filters need to always run after the original route handler , no matter was it successful or not . This is needed for cleanup-type tasks , e.g . close a transaction , or logging of execution times , etc . It would be nice to have a Spark.finally ( ) or similar that would ensure that this filter will be run anyway , after both successful and failing requests . Another option would be to add a Spark.around ( ) filter that will work similarly to java.servlet.Filter in wrapping and delegating the original call , e.g . `` ` java Spark.around ( ( req , res , route ) - > { try { startSomething ( ) ; return route.handle ( req , res ) ; } finally {
diff -- git a/src/main/java/spark/Request.java b/src/main/java/spark/Request.java index fafb0e4..9203826 100644 -- - a/src/main/java/spark/Request.java +++ b/src/main/java/spark/Request.java @ @ -16,23 +16,14 @ @ */ package spark ; -import java.util.ArrayList ; -import java.util.Collections ; -import java.util.Enumeration ; -import java.util.HashMap ; -import java.util.HashSet ; -import java.util.List ; -import java.util.Map ; -import java.util.Set ; -import java.util.TreeSet ; +import spark.routematch.RouteMatch ; +import spark.utils.IOUtils ; +import spark.utils.SparkUtils ; import javax.servlet.http.Cookie ; import javax.servlet.http.HttpServletRequest ; import javax.servlet.http.HttpSession ; - -import spark.routematch.RouteMatch ; -import spark.utils.IOUtils ; -import spark.utils.SparkUtils ; +import java.util . * ; /** * Provides information about the HTTP request diff -- git a/src/main/java/spark/route/SimpleRouteMatcher.java b/src/main/java/spark/route/SimpleRouteMatcher.java index 450c57f..97244a6 100644 -- - a/src/main/java/spark/route/SimpleRouteMatcher.java +++ b/src/main/java/spark/route/SimpleRouteMatcher.java @ @ -16,16 +16,12 @ @ */ package spark.route ; -import java.util.ArrayList ; -import java.util.Arrays ; -import java.util.HashMap ; -import java.util.List ; -import java.util.Map ; - import spark.routematch.RouteMatch ; import spark.utils.MimeParse ; import spark.utils.StringUtils ; +import java.util . * ; + /** * Simple route matcher that is supposed to work exactly as Sinatra's * @ @ -63,16 +59,12 @ @ public class SimpleRouteMatcher { try { method = HttpMethod.valueOf ( httpMethod ) ; } catch ( IllegalArgumentException e ) { - LOG.error ( `` The @ Route value : `` - + route - + Allow ` null ` /empty response body __EoT__ For example : `` ` groovy post ( `` /accounts '' , { req , res - > res.status ( 201 ) } ) `` ` Currently this fails with as a 404 . ` INFO spark.webserver.MatcherFilter - The requested route [ /accounts ] has not been mapped in Spark ` In MatcherFilter.java:227 , ` bodyContent == null ` is not enough to indicate the request has n't been consumed . `` ` boolean consumed = bodyContent ! = null ; if ( ! consumed & & hasOtherHandlers ) { throw new NotConsumedException ( ) ; } if ( ! consumed & & ! isServletContext ) { LOG.info ( `` The requested route [ `` + uri + `` ] has not been mapped in Spark '' ) ; httpResponse.setStatus ( HttpServletResponse.SC_NOT_FOUND ) ; bodyContent = String.format ( NOT_FOUND ) ; consumed = true ; } `` `
diff -- git a/src/main/java/spark/Request.java b/src/main/java/spark/Request.java index fafb0e4..9203826 100644 -- - a/src/main/java/spark/Request.java +++ b/src/main/java/spark/Request.java @ @ -16,23 +16,14 @ @ */ package spark ; -import java.util.ArrayList ; -import java.util.Collections ; -import java.util.Enumeration ; -import java.util.HashMap ; -import java.util.HashSet ; -import java.util.List ; -import java.util.Map ; -import java.util.Set ; -import java.util.TreeSet ; +import spark.routematch.RouteMatch ; +import spark.utils.IOUtils ; +import spark.utils.SparkUtils ; import javax.servlet.http.Cookie ; import javax.servlet.http.HttpServletRequest ; import javax.servlet.http.HttpSession ; - -import spark.routematch.RouteMatch ; -import spark.utils.IOUtils ; -import spark.utils.SparkUtils ; +import java.util . * ; /** * Provides information about the HTTP request diff -- git a/src/main/java/spark/route/SimpleRouteMatcher.java b/src/main/java/spark/route/SimpleRouteMatcher.java index 450c57f..97244a6 100644 -- - a/src/main/java/spark/route/SimpleRouteMatcher.java +++ b/src/main/java/spark/route/SimpleRouteMatcher.java @ @ -16,16 +16,12 @ @ */ package spark.route ; -import java.util.ArrayList ; -import java.util.Arrays ; -import java.util.HashMap ; -import java.util.List ; -import java.util.Map ; - import spark.routematch.RouteMatch ; import spark.utils.MimeParse ; import spark.utils.StringUtils ; +import java.util . * ; + /** * Simple route matcher that is supposed to work exactly as Sinatra's * @ @ -63,16 +59,12 @ @ public class SimpleRouteMatcher { try { method = HttpMethod.valueOf ( httpMethod ) ; } catch ( IllegalArgumentException e ) { - LOG.error ( `` The @ Route value : `` - + route - + Allow ` null ` /empty response body __EoT__ For example : `` ` groovy post ( `` /accounts '' , { req , res - > res.status ( 201 ) } ) `` ` Currently this fails with as a 404 . ` INFO spark.webserver.MatcherFilter - The requested route [ /accounts ] has not been mapped in Spark ` In MatcherFilter.java:227 , ` bodyContent == null ` is not enough to indicate the request has n't been consumed . `` ` boolean consumed = bodyContent ! = null ; if ( ! consumed & & hasOtherHandlers ) { throw new NotConsumedException ( ) ; } if ( ! consumed & & ! isServletContext ) { LOG.info ( `` The requested route [ `` + uri + `` ] has not been mapped in Spark '' ) ; httpResponse.setStatus ( HttpServletResponse.SC_NOT_FOUND ) ; bodyContent = String.format ( NOT_FOUND ) ; consumed = true ; } `` `
diff -- git a/src/main/java/spark/webserver/SparkServerImpl.java b/src/main/java/spark/webserver/SparkServerImpl.java index 8586484..c300135 100644 -- - a/src/main/java/spark/webserver/SparkServerImpl.java +++ b/src/main/java/spark/webserver/SparkServerImpl.java @ @ -21,6 +21,8 @ @ import org.eclipse.jetty.server.Handler ; import org.eclipse.jetty.server.Server ; import org.eclipse.jetty.server.bio.SocketConnector ; +import java.io.IOException ; + /** * Spark server implementation * @ @ -62,7 +64,29 @ @ class SparkServerImpl implements SparkServer { System.out.println ( `` > > Listening on 0.0.0.0 : '' + port ) ; server.start ( ) ; - System.in.read ( ) ; + + /* We need to block the thread here */ + try { + /* Try using stdin first */ + System.in.read ( ) ; + } catch ( IOException e ) { + /* Using stdin did not work */ + System.out.println ( `` > > Could not block with stdin ... '' ) ; + + /* Try waiting using an object */ + Object waitObj = new Object ( ) ; + synchronized ( waitObj ) { + /* Keep waiting forever unless we get interrupted */ + while ( true ) { + try { + waitObj.wait ( ) ; + } catch ( InterruptedException _ ) { + /* The thread was interrupted , so unblock */ + break ; + } bad file descriptor when started with `` nohup '' __EoT__ Hi , I 've normally run my jetty based applications with `` nohup '' so they stay started even when I 'm logged out . However , with Spark it 's not possible : `` ` java.io.IOException : Bad file descriptor at java.io.FileInputStream.readBytes ( Native Method ) at java.io.FileInputStream.read ( FileInputStream.java:236 ) at java.io.BufferedInputStream.fill ( BufferedInputStream.java:235 ) at java.io.BufferedInputStream.read ( BufferedInputStream.java:254 ) at spark.webserver.SparkServerImpl.ignite ( SparkServerImpl.java:65 ) at spark.Spark $ 1.run ( Spark.java:176 ) at java.lang.Thread.run ( Thread.java:636 ) `` ` I guess it want to something with stdin which is not available _then_ which is why it fails . I do n't know any other easy way of demonizing it right now .
diff -- git a/pom.xml b/pom.xml index d3dcbbf..6dd54cb 100644 -- - a/pom.xml +++ b/pom.xml @ @ -3,12 +3,13 @ @ < modelVersion > 4.0.0 < /modelVersion > < groupId > spark < /groupId > < artifactId > spark < /artifactId > - < packaging > jar < /packaging > + < packaging > pom < /packaging > < version > 0.9.9.2-SNAPSHOT < /version > < name > Spark < /name > < url > http : //www.sparkjava.com < /url > < properties > + < project.build.sourceEncoding > UTF-8 < /project.build.sourceEncoding > < jetty.version > 7.3.0.v20110203 < /jetty.version > < /properties > @ @ -25,24 +26,6 @ @ < version > 1.2.14 < /version > < /dependency > - < dependency > - < groupId > org.eclipse.jetty.aggregate < /groupId > - < artifactId > jetty-webapp < /artifactId > - < version > $ { jetty.version } < /version > - < /dependency > - - < ! -- < dependency > -- > - < ! -- < groupId > commons-fileupload < /groupId > -- > - < ! -- < artifactId > commons-fileupload < /artifactId > -- > - < ! -- < version > 1.2.2 < /version > -- > Mime-type differences between 2.5 and 2.5.1 __EoT__ [ This is original description is in error - the bug is not before ( ) /mime-type handling related ] My HTML in static resources does n't end in .html . I 'm adding that with a filter . `` ` public static void main ( String [ ] args ) { staticFiles.location ( `` / '' ) ; // `` foo '' - a html file is in there . before ( `` / '' , ( request , response ) - > { response.type ( `` text/html '' ) ; // `` foo '' gets its html mime type } ) ; } `` ` Was working fine in 2.5 . **Is not working in 2.5.1** I 've looked at https : //github.com/perwendel/spark/compare/2.5 ... 2.5.1 and can not see what broke it .
diff -- git a/pom.xml b/pom.xml index d3dcbbf..6dd54cb 100644 -- - a/pom.xml +++ b/pom.xml @ @ -3,12 +3,13 @ @ < modelVersion > 4.0.0 < /modelVersion > < groupId > spark < /groupId > < artifactId > spark < /artifactId > - < packaging > jar < /packaging > + < packaging > pom < /packaging > < version > 0.9.9.2-SNAPSHOT < /version > < name > Spark < /name > < url > http : //www.sparkjava.com < /url > < properties > + < project.build.sourceEncoding > UTF-8 < /project.build.sourceEncoding > < jetty.version > 7.3.0.v20110203 < /jetty.version > < /properties > @ @ -25,24 +26,6 @ @ < version > 1.2.14 < /version > < /dependency > - < dependency > - < groupId > org.eclipse.jetty.aggregate < /groupId > - < artifactId > jetty-webapp < /artifactId > - < version > $ { jetty.version } < /version > - < /dependency > - - < ! -- < dependency > -- > - < ! -- < groupId > commons-fileupload < /groupId > -- > - < ! -- < artifactId > commons-fileupload < /artifactId > -- > - < ! -- < version > 1.2.2 < /version > -- > Mime-type differences between 2.5 and 2.5.1 __EoT__ [ This is original description is in error - the bug is not before ( ) /mime-type handling related ] My HTML in static resources does n't end in .html . I 'm adding that with a filter . `` ` public static void main ( String [ ] args ) { staticFiles.location ( `` / '' ) ; // `` foo '' - a html file is in there . before ( `` / '' , ( request , response ) - > { response.type ( `` text/html '' ) ; // `` foo '' gets its html mime type } ) ; } `` ` Was working fine in 2.5 . **Is not working in 2.5.1** I 've looked at https : //github.com/perwendel/spark/compare/2.5 ... 2.5.1 and can not see what broke it .
diff -- git a/pom.xml b/pom.xml index d3dcbbf..9d4fcfa 100644 -- - a/pom.xml +++ b/pom.xml @ @ -3,12 +3,13 @ @ < modelVersion > 4.0.0 < /modelVersion > < groupId > spark < /groupId > < artifactId > spark < /artifactId > - < packaging > jar < /packaging > + < packaging > pom < /packaging > < version > 0.9.9.2-SNAPSHOT < /version > < name > Spark < /name > < url > http : //www.sparkjava.com < /url > < properties > + < project.build.sourceEncoding > UTF-8 < /project.build.sourceEncoding > < jetty.version > 7.3.0.v20110203 < /jetty.version > < /properties > @ @ -25,24 +26,6 @ @ < version > 1.2.14 < /version > < /dependency > - < dependency > - < groupId > org.eclipse.jetty.aggregate < /groupId > - < artifactId > jetty-webapp < /artifactId > - < version > $ { jetty.version } < /version > - < /dependency > - - < ! -- < dependency > -- > - < ! -- < groupId > commons-fileupload < /groupId > -- > - < ! -- < artifactId > commons-fileupload < /artifactId > -- > - < ! -- < version > 1.2.2 < /version > -- > Mime-type differences between 2.5 and 2.5.1 __EoT__ [ This is original description is in error - the bug is not before ( ) /mime-type handling related ] My HTML in static resources does n't end in .html . I 'm adding that with a filter . `` ` public static void main ( String [ ] args ) { staticFiles.location ( `` / '' ) ; // `` foo '' - a html file is in there . before ( `` / '' , ( request , response ) - > { response.type ( `` text/html '' ) ; // `` foo '' gets its html mime type } ) ; } `` ` Was working fine in 2.5 . **Is not working in 2.5.1** I 've looked at https : //github.com/perwendel/spark/compare/2.5 ... 2.5.1 and can not see what broke it .
diff -- git a/src/test/java/spark/BodyAvailabilityTest.java b/src/test/java/spark/BodyAvailabilityTest.java index 0b1ec2c..42bb837 100644 -- - a/src/test/java/spark/BodyAvailabilityTest.java +++ b/src/test/java/spark/BodyAvailabilityTest.java @ @ -38,7 +38,7 @ @ public class BodyAvailabilityTest { public static void setup ( ) { LOGGER.debug ( `` setup ( ) '' ) ; - testUtil = new SparkTestUtil ( 4567 ) ; + testUtil = new SparkTestUtil ( 0 ) ; beforeBody = null ; routeBody = null ; diff -- git a/src/test/java/spark/GenericIntegrationTest.java b/src/test/java/spark/GenericIntegrationTest.java index 4d4266f..d5590be 100644 -- - a/src/test/java/spark/GenericIntegrationTest.java +++ b/src/test/java/spark/GenericIntegrationTest.java @ @ -59,7 +59,7 @ @ public class GenericIntegrationTest { @ BeforeClass public static void setup ( ) throws IOException { - testUtil = new SparkTestUtil ( 4567 ) ; + testUtil = new SparkTestUtil ( 0 ) ; tmpExternalFile = new File ( System.getProperty ( `` java.io.tmpdir '' ) , `` externalFile.html '' ) ; @ @ -405,7 +405,7 @ @ public class GenericIntegrationTest { @ Test public void testWebSocketConversation ( ) throws Exception { - String uri = `` ws : //localhost:4567/ws '' ; + String uri = `` ws : //localhost : '' + testUtil.getPort ( ) + `` /ws '' ; WebSocketClient client = new WebSocketClient ( ) ; WebSocketTestClient ws = new WebSocketTestClient ( ) ; diff Tests fail if port 4567 is in use __EoT__ Not sure if this is a bug , but we should probably use a random open port for tests . Or at least not 4567 .
diff -- git a/library/src/main/java/com/github/paolorotolo/appintro/AppIntro.java b/library/src/main/java/com/github/paolorotolo/appintro/AppIntro.java index 44784d3..afa147d 100644 -- - a/library/src/main/java/com/github/paolorotolo/appintro/AppIntro.java +++ b/library/src/main/java/com/github/paolorotolo/appintro/AppIntro.java @ @ -1,5 +1,6 @ @ package com.github.paolorotolo.appintro ; +import android.graphics.Typeface ; import android.graphics.drawable.Drawable ; import android.support.annotation.ColorInt ; import android.support.annotation.DrawableRes ; @ @ -59,6 +60,17 @ @ public abstract class AppIntro extends AppIntroBase { } /** + * Override skip text typeface + * + * @ param texttf URL of font file located in Assets folder + */ + public void setSkipTextTypeface ( @ Nullable final String texttf ) { + TextView skipText = ( TextView ) findViewById ( R.id.skip ) ; + skipText.setTypeface ( CustomFontCache.get ( texttf , this ) ) ; + + } + + /** * Override done text * * @ param text your text @ @ -69,6 +81,16 @ @ public abstract class AppIntro extends AppIntroBase { } /** + * Override done text typeface + * + * @ param texttf your text + */ + public void setDoneTextTypeface ( @ Nullable final String texttf ) { + TextView doneText = ( TextView ) findViewById ( R.id.done ) ; + doneText.setTypeface ( CustomFontCache.get ( texttf , this ) ) ; + } + + /** * Override done button Demo-App : Many deprecated methods are used __EoT__ Example : - DepthAnimation
diff -- git a/README.md b/README.md index 9756a77..c310216 100644 -- - a/README.md +++ b/README.md @ @ -160,6 +160,8 @ @ askForPermissions ( new String [ ] { Manifest.permission.CAMERA } , 2 ) ; // OR // Ensure your slide talks about both so as not to confuse the user . askForPermissions ( new String [ ] { Manifest.permission.CAMERA , Manifest.permission.READ_CONTACTS } , 2 ) ; `` ` + +We are using icons made by < a href= '' http : //www.flaticon.com/authors/freepik '' title= '' Freepik '' > Freepik < /a > from < a href= '' http : //www.flaticon.com '' title= '' Flaticon '' > www.flaticon.com < /a > is licensed by < a href= '' http : //creativecommons.org/licenses/by/3.0/ '' title= '' Creative Commons BY 3.0 '' target= '' _blank '' > CC 3.0 BY < /a > **NOTE : ** It is advised that you only put one permission in the String array unless you want the app to ask for multiple permissions on the same slide . diff -- git a/example/build.gradle b/example/build.gradle index d24e444..4924552 100644 -- - a/example/build.gradle +++ b/example/build.gradle @ @ -2,7 +2,7 @ @ apply plugin : 'com.android.application' android { compileSdkVersion 24 - buildToolsVersion `` 24.0.0 '' Demo-App : Many deprecated methods are used __EoT__ Example : - DepthAnimation
diff -- git a/README.md b/README.md index 9756a77..c310216 100644 -- - a/README.md +++ b/README.md @ @ -160,6 +160,8 @ @ askForPermissions ( new String [ ] { Manifest.permission.CAMERA } , 2 ) ; // OR // Ensure your slide talks about both so as not to confuse the user . askForPermissions ( new String [ ] { Manifest.permission.CAMERA , Manifest.permission.READ_CONTACTS } , 2 ) ; `` ` + +We are using icons made by < a href= '' http : //www.flaticon.com/authors/freepik '' title= '' Freepik '' > Freepik < /a > from < a href= '' http : //www.flaticon.com '' title= '' Flaticon '' > www.flaticon.com < /a > is licensed by < a href= '' http : //creativecommons.org/licenses/by/3.0/ '' title= '' Creative Commons BY 3.0 '' target= '' _blank '' > CC 3.0 BY < /a > **NOTE : ** It is advised that you only put one permission in the String array unless you want the app to ask for multiple permissions on the same slide . diff -- git a/example/build.gradle b/example/build.gradle index d24e444..4924552 100644 -- - a/example/build.gradle +++ b/example/build.gradle @ @ -2,7 +2,7 @ @ apply plugin : 'com.android.application' android { compileSdkVersion 24 - buildToolsVersion `` 24.0.0 '' Demo-App : Many deprecated methods are used __EoT__ Example : - DepthAnimation
diff -- git a/README.md b/README.md index 9756a77..c310216 100644 -- - a/README.md +++ b/README.md @ @ -160,6 +160,8 @ @ askForPermissions ( new String [ ] { Manifest.permission.CAMERA } , 2 ) ; // OR // Ensure your slide talks about both so as not to confuse the user . askForPermissions ( new String [ ] { Manifest.permission.CAMERA , Manifest.permission.READ_CONTACTS } , 2 ) ; `` ` + +We are using icons made by < a href= '' http : //www.flaticon.com/authors/freepik '' title= '' Freepik '' > Freepik < /a > from < a href= '' http : //www.flaticon.com '' title= '' Flaticon '' > www.flaticon.com < /a > is licensed by < a href= '' http : //creativecommons.org/licenses/by/3.0/ '' title= '' Creative Commons BY 3.0 '' target= '' _blank '' > CC 3.0 BY < /a > **NOTE : ** It is advised that you only put one permission in the String array unless you want the app to ask for multiple permissions on the same slide . diff -- git a/example/build.gradle b/example/build.gradle index d24e444..4924552 100644 -- - a/example/build.gradle +++ b/example/build.gradle @ @ -2,7 +2,7 @ @ apply plugin : 'com.android.application' android { compileSdkVersion 24 - buildToolsVersion `` 24.0.0 '' Changelog for AppIntro v4.1.0 __EoT__ ( Ignoring issue template because it does n't apply to this issue . ) It would be awesome if we could get a full changelog going with credits and everything . I think @ maxee has made some big changes , but there have also been some other people as well . If we can track them down and formulate a good changelog , that would help @ PaoloRotolo out a lot . Thanks guys !
diff -- git a/README.md b/README.md index 1f2ae11..2d3d944 100644 -- - a/README.md +++ b/README.md @ @ -14,7 +14,10 @ @ AppIntro is an Android Library that helps you make a **cool intro** for your app < img src= '' https : //github.com/PaoloRotolo/AppIntro/blob/master/art/layout2.png '' width= '' 300 '' > - # # How to use + # # Usage + + # # # Basic usage + Add this to your **build.gradle** : `` ` java repositories { @ @ -89,7 +92,7 @ @ Finally , declare the activity in your Manifest like so : Do not declare the intro as your main app launcher unless you want the intro to launch every time your app starts . Refer to the [ wiki ] ( https : //github.com/PaoloRotolo/AppIntro/wiki/How-to-Use # show-the-intro-once ) for an example of how to launch the intro once from your main activity . - # # # Layout 2 + # # # # Alternative layout If you want to try new layout ( as seen in Google 's Photo app ) , just extend **AppIntro2** in your Activity . That 's all : ) `` ` java @ @ -101,16 +104,12 @ @ public class IntroActivity extends AppIntro2 Changelog for AppIntro v4.1.0 __EoT__ ( Ignoring issue template because it does n't apply to this issue . ) It would be awesome if we could get a full changelog going with credits and everything . I think @ maxee has made some big changes , but there have also been some other people as well . If we can track them down and formulate a good changelog , that would help @ PaoloRotolo out a lot . Thanks guys !
diff -- git a/library/src/main/java/com/github/paolorotolo/appintro/AppIntro.java b/library/src/main/java/com/github/paolorotolo/appintro/AppIntro.java index 44784d3..afa147d 100644 -- - a/library/src/main/java/com/github/paolorotolo/appintro/AppIntro.java +++ b/library/src/main/java/com/github/paolorotolo/appintro/AppIntro.java @ @ -1,5 +1,6 @ @ package com.github.paolorotolo.appintro ; +import android.graphics.Typeface ; import android.graphics.drawable.Drawable ; import android.support.annotation.ColorInt ; import android.support.annotation.DrawableRes ; @ @ -59,6 +60,17 @ @ public abstract class AppIntro extends AppIntroBase { } /** + * Override skip text typeface + * + * @ param texttf URL of font file located in Assets folder + */ + public void setSkipTextTypeface ( @ Nullable final String texttf ) { + TextView skipText = ( TextView ) findViewById ( R.id.skip ) ; + skipText.setTypeface ( CustomFontCache.get ( texttf , this ) ) ; + + } + + /** * Override done text * * @ param text your text @ @ -69,6 +81,16 @ @ public abstract class AppIntro extends AppIntroBase { } /** + * Override done text typeface + * + * @ param texttf your text + */ + public void setDoneTextTypeface ( @ Nullable final String texttf ) { + TextView doneText = ( TextView ) findViewById ( R.id.done ) ; + doneText.setTypeface ( CustomFontCache.get ( texttf , this ) ) ; + } + + /** * Override done button Custom Typefaces Ignored __EoT__ < ! -- Please fill in the below fields with some data to help us best diagnose the issue . The more specific you are , the better ! You can help a lot by not making us ask these questions . Feel free to remove any irrelevant parts that you know are not related to the issue . Any HTML comment like this will be stripped when rendering markdown , no need to delete them . If an issue does not have the following template filled out , it will be closed without discussion . -- > < ! -- What version of AppIntro you 're running , for example : 4.1.0 | 4.0.0 It 's essentially the version number from your build.gradle : ` dependencies { compile ' ... : x.y.z ' } ` -- > **AppIntro Version** : 4.1.0 < ! -- What devices you managed to get the issue to come up on ? For example : fails on Galaxy S4/GT-I9500 4.4.2 , works fine on Nexus 6P 5.1 and Genymotion Nexus 5 5.0.1 -- > **Device/Android Version** : Xiaomi Mi Max ( Android Marshmallow ) < ! -- Share the details
diff -- git a/README.md b/README.md index 9756a77..c310216 100644 -- - a/README.md +++ b/README.md @ @ -160,6 +160,8 @ @ askForPermissions ( new String [ ] { Manifest.permission.CAMERA } , 2 ) ; // OR // Ensure your slide talks about both so as not to confuse the user . askForPermissions ( new String [ ] { Manifest.permission.CAMERA , Manifest.permission.READ_CONTACTS } , 2 ) ; `` ` + +We are using icons made by < a href= '' http : //www.flaticon.com/authors/freepik '' title= '' Freepik '' > Freepik < /a > from < a href= '' http : //www.flaticon.com '' title= '' Flaticon '' > www.flaticon.com < /a > is licensed by < a href= '' http : //creativecommons.org/licenses/by/3.0/ '' title= '' Creative Commons BY 3.0 '' target= '' _blank '' > CC 3.0 BY < /a > **NOTE : ** It is advised that you only put one permission in the String array unless you want the app to ask for multiple permissions on the same slide . diff -- git a/example/build.gradle b/example/build.gradle index d24e444..4924552 100644 -- - a/example/build.gradle +++ b/example/build.gradle @ @ -2,7 +2,7 @ @ apply plugin : 'com.android.application' android { compileSdkVersion 24 - buildToolsVersion `` 24.0.0 '' Custom Typefaces Ignored __EoT__ < ! -- Please fill in the below fields with some data to help us best diagnose the issue . The more specific you are , the better ! You can help a lot by not making us ask these questions . Feel free to remove any irrelevant parts that you know are not related to the issue . Any HTML comment like this will be stripped when rendering markdown , no need to delete them . If an issue does not have the following template filled out , it will be closed without discussion . -- > < ! -- What version of AppIntro you 're running , for example : 4.1.0 | 4.0.0 It 's essentially the version number from your build.gradle : ` dependencies { compile ' ... : x.y.z ' } ` -- > **AppIntro Version** : 4.1.0 < ! -- What devices you managed to get the issue to come up on ? For example : fails on Galaxy S4/GT-I9500 4.4.2 , works fine on Nexus 6P 5.1 and Genymotion Nexus 5 5.0.1 -- > **Device/Android Version** : Xiaomi Mi Max ( Android Marshmallow ) < ! -- Share the details
diff -- git a/library/src/main/java/com/github/paolorotolo/appintro/AppIntroBaseFragment.java b/library/src/main/java/com/github/paolorotolo/appintro/AppIntroBaseFragment.java index 966e2c5..4c369c5 100644 -- - a/library/src/main/java/com/github/paolorotolo/appintro/AppIntroBaseFragment.java +++ b/library/src/main/java/com/github/paolorotolo/appintro/AppIntroBaseFragment.java @ @ -86,7 +86,7 @ @ public abstract class AppIntroBaseFragment extends Fragment implements ISlideSel if ( titleColor ! = 0 ) { t.setTextColor ( titleColor ) ; } - if ( titleTypeface ! = null & & titleTypeface.equals ( `` '' ) ) { + if ( titleTypeface ! = null ) { if ( CustomFontCache.get ( titleTypeface , getContext ( ) ) ! = null ) { t.setTypeface ( CustomFontCache.get ( titleTypeface , getContext ( ) ) ) ; } @ @ -95,7 +95,7 @ @ public abstract class AppIntroBaseFragment extends Fragment implements ISlideSel if ( descColor ! = 0 ) { d.setTextColor ( descColor ) ; } - if ( descTypeface ! = null & & descTypeface.equals ( `` '' ) ) { + if ( descTypeface ! = null ) { if ( CustomFontCache.get ( descTypeface , getContext ( ) ) ! = null ) { d.setTypeface ( CustomFontCache.get ( descTypeface , getContext ( ) ) ) ; } diff -- git a/library/src/main/java/com/github/paolorotolo/appintro/CustomFontCache.java b/library/src/main/java/com/github/paolorotolo/appintro/CustomFontCache.java index be4c371..1a51bcb 100644 -- - a/library/src/main/java/com/github/paolorotolo/appintro/CustomFontCache.java +++ b/library/src/main/java/com/github/paolorotolo/appintro/CustomFontCache.java @ @ -28,7 +28,11 @ @ public class CustomFontCache { return tf setting typeface isnt working . __EoT__ < ! -- Please fill in the below fields with some data to help us best diagnose the issue . The more specific you are , the better ! You can help a lot by not making us ask these questions . Any HTML comment like this will be stripped when rendering markdown , no need to delete them . If an issue does not have the following template filled out , it will be closed without discussion . -- > < ! -- What version of AppIntro you 're running , for example : 4.1.0 | 4.0.0 It 's essentially the version number from your build.gradle : ` dependencies { compile ' ... : x.y.z ' } ` -- > **AppIntro Version** : < ! -- What devices you managed to get the issue to come up on ? For example : fails on Galaxy S4/GT-I9500 4.4.2 , works fine on Nexus 6P 5.1 and Genymotion Nexus 5 5.0.1 -- > **Device/Android Version** : < ! -- Share the details of your issue in prose , detailing actual and expected behavior . It also helps if you give some info **why** you are
diff -- git a/hystrix-core/src/main/java/com/netflix/hystrix/strategy/HystrixPlugins.java b/hystrix-core/src/main/java/com/netflix/hystrix/strategy/HystrixPlugins.java index 3aa0839..f935c79 100644 -- - a/hystrix-core/src/main/java/com/netflix/hystrix/strategy/HystrixPlugins.java +++ b/hystrix-core/src/main/java/com/netflix/hystrix/strategy/HystrixPlugins.java @ @ -1,12 +1,12 @ @ /** * Copyright 2012 Netflix , Inc. - * + * * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; * you may not use this file except in compliance with the License . * You may obtain a copy of the License at - * + * * http : //www.apache.org/licenses/LICENSE-2.0 - * + * * Unless required by applicable law or agreed to in writing , software * distributed under the License is distributed on an `` AS IS '' BASIS , * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . @ @ -44,17 +44,17 @ @ import com.netflix.hystrix.strategy.properties.HystrixPropertiesStrategyDefault ; * < li > plugin registered and retrieved using the JDK { @ link ServiceLoader } < /li > * < li > default implementation < /li > * < /ol > - * - * The exception to the above order is the { @ link HystrixDynamicProperties } implementation + * + * The exception to the above order is the { @ link HystrixDynamicProperties } HystrixPlugins.getInstance ( ) returns private instance __EoT__ In Hystrix 1.5.5 , when calling ` HystrixPlugins.getInstance ( ) ` I get a `` ` java.lang.NoClassDefFoundError : Could not initialize class com.netflix.hystrix.strategy.HystrixPlugins $ LazyHolder `` ` exception in an OSGi environment . In 1.4.x it worked without problems . How is intended to work ? The private inner class effectively prevents the OSGi classloader to make it available to client bundles . As soon as I patch it to be publicly available , I can use the plugin mechanism again . As it worked fine in 1.4.x I 'd consider this a defect .
diff -- git a/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java b/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java index 823e66a..57e8be4 100644 -- - a/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java +++ b/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java @ @ -937,7 +937,6 @ @ import com.netflix.hystrix.util.HystrixTimer.TimerListener ; timeoutRunnable.run ( ) ; } - } @ Override diff -- git a/hystrix-core/src/test/java/com/netflix/hystrix/HystrixCommandTest.java b/hystrix-core/src/test/java/com/netflix/hystrix/HystrixCommandTest.java index dd4cdcb..6c4c150 100644 -- - a/hystrix-core/src/test/java/com/netflix/hystrix/HystrixCommandTest.java +++ b/hystrix-core/src/test/java/com/netflix/hystrix/HystrixCommandTest.java @ @ -5272,7 +5272,7 @ @ public class HystrixCommandTest { } @ Test - public void testExceptionConvertedToBadRequestExceptionInExecutionHookBypassesCircuitBreaker ( ) { + public void testExceptionConvertedToBadRequestExceptionInExecutionHookBypassesCircuitBreaker ( ) { TestCircuitBreaker circuitBreaker = new TestCircuitBreaker ( ) ; try { new ExceptionToBadRequestByExecutionHookCommand ( circuitBreaker , ExecutionIsolationStrategy.THREAD ) .execute ( ) ; @ @ -5291,6 +5291,33 @ @ public class HystrixCommandTest { assertEquals ( 1 , circuitBreaker.metrics.getRollingCount ( HystrixRollingNumberEvent.BAD_REQUEST ) ) ; } + @ Test + public void testInterruptFutureOnTimeout ( ) throws InterruptedException , ExecutionException { + // given + InterruptibleCommand cmd = new InterruptibleCommand ( new TestCircuitBreaker ( ) ) ; + + // when + Future < Boolean > f = cmd.queue ( ) ; + + // then + Thread.sleep ( 3000 ) ; + System.out.println ( `` RESULT : `` + f.get ( ) ) ; + assertTrue ( cmd.hasBeenInterrupted ( ) ) ; + } + + @ Test + public void testInterruptObservableOnTimeout ( Make thread-interruption of Hystrix thread depend on property value __EoT__ At the moment , thread-interrupt is controlled by the internals of the Rx Scheduler infrastructure . @ akarnokd has got an addition to the API in https : //github.com/ReactiveX/RxJava/pull/2579/files that will expose this functionality for the ` HystrixContextScheduler ` to use . Once the next RxJava release comes out , move to that API . Also , see # 593 , # 596 for history
diff -- git a/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java b/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java index 823e66a..8b0c4e3 100644 -- - a/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java +++ b/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java @ @ -27,6 +27,7 @ @ import java.util.concurrent.atomic.AtomicBoolean ; import java.util.concurrent.atomic.AtomicInteger ; import java.util.concurrent.atomic.AtomicReference ; +import com.netflix.hystrix.strategy.concurrency.HystrixContextScheduler ; import org.slf4j.Logger ; import org.slf4j.LoggerFactory ; @ @ -34,7 +35,10 @ @ import rx.Notification ; import rx.Observable ; import rx.Observable.OnSubscribe ; import rx.Observable.Operator ; +import rx.Producer ; +import rx.Scheduler ; import rx.Subscriber ; +import rx.Subscription ; import rx.functions.Action0 ; import rx.functions.Action1 ; import rx.functions.Func1 ; @ @ -528,7 +532,12 @ @ import com.netflix.hystrix.util.HystrixTimer.TimerListener ; } } - } ) .subscribeOn ( threadPool.getScheduler ( ) ) ; + } ) ; + + //I believe there is a bug in RxJava 's { @ link Observable # subscribeOn } method that does n't properly hook up unsubscription . + //In place of that method , I 'm using a custom operator ( { @ link OperatorSubscribeOnThatAllowsUnsubscribe } ) that properly hooks these up . + //Once I get the work done in Rx to apply the fix , this should return to use { @ link Observable # susbcribeOn } + run = run.nest ( ) .lift ( new OperatorSubscribeOnThatAllowsUnsubscribe < R > ( threadPool.getScheduler ( ) , properties ) interruptOnTimeout does n't work in Hystrix 1.4.0-RC5 __EoT__ When using Hystrix 1.4.0-RC5 , the commands are not interrupted when the command times out . The following naive test shows how to reproduce this : `` ` java public class InterruptTest { private static final Logger LOG = LoggerFactory.getLogger ( InterruptTest.class ) ; private class SleepingCommand extends HystrixCommand < Void > { public SleepingCommand ( ) { super ( Setter.withGroupKey ( HystrixCommandGroupKey.Factory.asKey ( `` mygroup '' ) ) .andCommandPropertiesDefaults ( HystrixCommandProperties.Setter ( ) .withExecutionIsolationThreadInterruptOnTimeout ( true ) .withExecutionIsolationThreadTimeoutInMilliseconds ( 1000 ) ) ) ; } private volatile boolean hasBeenInterrupted ; public boolean hasBeenInterrupted ( ) { return hasBeenInterrupted ; } @ Override protected Void run ( ) throws Exception { try { Thread.sleep ( 2000 ) ; } catch ( InterruptedException e ) { LOG.error ( `` Interrupted ! `` , e ) ; hasBeenInterrupted = true ; } return null ; } } @ Test public void shouldInterruptOnTimeout ( ) throws InterruptedException { // given SleepingCommand cmd = new SleepingCommand ( ) ; // when cmd.observe ( ) .subscribe ( ) ; // then Thread.sleep ( 3000 ) ; Assert.assertTrue ( cmd.hasBeenInterrupted ( ) ) ; } } `` `
diff -- git a/CHANGES.md b/CHANGES.md index d2d8081..11c7c61 100644 -- - a/CHANGES.md +++ b/CHANGES.md @ @ -1,5 +1,31 @ @ # Hystrix Releases # + # # # Version 1.3.17 ( [ Maven Central ] ( http : //search.maven.org/ # search % 7Cga % 7C1 % 7Cg % 3A % 22com.netflix.hystrix % 22 % 20AND % 20v % 3A % 221.3.17 % 22 ) ) # # # + +* [ Pull 291 ] ( https : //github.com/Netflix/Hystrix/pull/291 ) String optimization for HystrixRequestLog +* [ Pull 296 ] ( https : //github.com/Netflix/Hystrix/pull/296 ) Fix Premature Unsubscribe Bug +* [ Commit 47122e ] ( https : //github.com/Netflix/Hystrix/commit/1268454ec4381b6ae121cac1675205484847122e ) RxJava 0.20.1 + + # # # Version 1.3.16 ( [ Maven Central ] ( http : //search.maven.org/ # search % 7Cga % 7C1 % 7Cg % 3A % 22com.netflix.hystrix % 22 % 20AND % 20v % 3A % 221.3.16 % 22 ) ) # # # + +* [ Pull 258 ] ( https : //github.com/Netflix/Hystrix/pull/258 ) Skip CachedObservableOriginal when no getCacheKey ( ) +* [ Pull 259 ] ( https : //github.com/Netflix/Hystrix/pull/259 ) Fix # 257 with RxJava 0.18.2 + + # # # Version 1.3.15 ( [ Maven Central ] ( Examine work performed on Hystrix-isolated thread __EoT__ From # 327 and # 378 , the Execution hook ` onThreadComplete ` is getting called earlier than in Hystrix 1.3 . This issue is intended to describe the differences between what work gets executed on the isolated thread in 1.3 and 1.4 and confirm this is being done properly
diff -- git a/CHANGES.md b/CHANGES.md index d2d8081..11c7c61 100644 -- - a/CHANGES.md +++ b/CHANGES.md @ @ -1,5 +1,31 @ @ # Hystrix Releases # + # # # Version 1.3.17 ( [ Maven Central ] ( http : //search.maven.org/ # search % 7Cga % 7C1 % 7Cg % 3A % 22com.netflix.hystrix % 22 % 20AND % 20v % 3A % 221.3.17 % 22 ) ) # # # + +* [ Pull 291 ] ( https : //github.com/Netflix/Hystrix/pull/291 ) String optimization for HystrixRequestLog +* [ Pull 296 ] ( https : //github.com/Netflix/Hystrix/pull/296 ) Fix Premature Unsubscribe Bug +* [ Commit 47122e ] ( https : //github.com/Netflix/Hystrix/commit/1268454ec4381b6ae121cac1675205484847122e ) RxJava 0.20.1 + + # # # Version 1.3.16 ( [ Maven Central ] ( http : //search.maven.org/ # search % 7Cga % 7C1 % 7Cg % 3A % 22com.netflix.hystrix % 22 % 20AND % 20v % 3A % 221.3.16 % 22 ) ) # # # + +* [ Pull 258 ] ( https : //github.com/Netflix/Hystrix/pull/258 ) Skip CachedObservableOriginal when no getCacheKey ( ) +* [ Pull 259 ] ( https : //github.com/Netflix/Hystrix/pull/259 ) Fix # 257 with RxJava 0.18.2 + + # # # Version 1.3.15 ( [ Maven Central ] ( Examine work performed on Hystrix-isolated thread __EoT__ From # 327 and # 378 , the Execution hook ` onThreadComplete ` is getting called earlier than in Hystrix 1.3 . This issue is intended to describe the differences between what work gets executed on the isolated thread in 1.3 and 1.4 and confirm this is being done properly
diff -- git a/guava-tests/test/com/google/common/util/concurrent/UninterruptiblesTest.java b/guava-tests/test/com/google/common/util/concurrent/UninterruptiblesTest.java index 16fd838..614ee38 100644 -- - a/guava-tests/test/com/google/common/util/concurrent/UninterruptiblesTest.java +++ b/guava-tests/test/com/google/common/util/concurrent/UninterruptiblesTest.java @ @ -17,6 +17,8 @ @ package com.google.common.util.concurrent ; import static com.google.common.util.concurrent.InterruptionUtil.repeatedlyInterruptTestThread ; +import static com.google.common.util.concurrent.Uninterruptibles.awaitUninterruptibly ; +import static com.google.common.util.concurrent.Uninterruptibles.awaitUntilUninterruptibly ; import static com.google.common.util.concurrent.Uninterruptibles.joinUninterruptibly ; import static com.google.common.util.concurrent.Uninterruptibles.putUninterruptibly ; import static com.google.common.util.concurrent.Uninterruptibles.takeUninterruptibly ; @ @ -28,10 +30,17 @ @ import com.google.common.base.Stopwatch ; import com.google.common.testing.NullPointerTester ; import com.google.common.testing.TearDown ; import com.google.common.testing.TearDownStack ; +import java.util.Date ; import java.util.concurrent.ArrayBlockingQueue ; import java.util.concurrent.BlockingQueue ; import java.util.concurrent.CountDownLatch ; +import java.util.concurrent.Executors ; +import java.util.concurrent.ScheduledExecutorService ; import java.util.concurrent.Semaphore ; +import java.util.concurrent.TimeUnit ; +import java.util.concurrent.locks.Condition ; +import java.util.concurrent.locks.Lock ; +import java.util.concurrent.locks.ReentrantLock ; import junit.framework.TestCase ; /** @ @ -85,6 +94,103 @ @ public class UninterruptiblesTest extends TestCase { // CountDownLatch.await ( ) tests + // Condition.await ( ) tests + public void testConditionAwaitTimeoutExceeded ( ) { + Stopwatch stopwatch = Stopwatch.createStarted ( ) ; + Condition condition = TestCondition.create ( ) ; + + boolean signaledBeforeTimeout = awaitUninterruptibly ( condition , 500 , MILLISECONDS ) ; + + assertFalse ( signaledBeforeTimeout ) ; + assertTimeNotPassed ( stopwatch , LONG_DELAY_MS ) ; + assertNotInterrupted ( ) ; + } + + public void testConditionAwaitTimeoutNotExceeded ( ) { + Stopwatch stopwatch = Stopwatch.createStarted ( ) ; + Add Uninterruptibles support for Condition __EoT__ It would be nice to have Uninterruptibles support for Condition.await ( ) and overlaods . So we could write `` ` lock.lock ( ) ; try { awaitUninterrutibly ( condition,1 , MINUTE ) ; } finally { lock.unlock ( ) ; } `` `
diff -- git a/build.gradle b/build.gradle index 4edadf9..2dc331d 100644 -- - a/build.gradle +++ b/build.gradle @ @ -32,7 +32,7 @ @ buildscript { targetSdkVersion = 28 // App dependencies - androidGradlePluginVersion = '3.2.0-beta04' + androidGradlePluginVersion = '3.3.0-alpha05' appcompatVersion = '1.0.0-beta01' browserVersion = '1.0.0-beta01' constraintLayoutVersion = '1.1.2' @ @ -66,6 +66,7 @ @ buildscript { mockitoVersion = `` 2.8.9 '' mockitoKotlinVersion = `` 1.5.0 '' okhttpVersion = `` 3.10.0 '' + okioVersion = `` 1.14.0 '' pageIndicatorVersion = `` 1.3.0 '' rulesVersion = '1.1.0-alpha1' runnerVersion = '1.1.0-alpha1' diff -- git a/mobile/build.gradle b/mobile/build.gradle index fbccfd4..2bb3905 100644 -- - a/mobile/build.gradle +++ b/mobile/build.gradle @ @ -170,6 +170,9 @ @ dependencies { // Solve conflicts with gson . DataBinding is using an old version . implementation `` com.google.code.gson : gson : $ gsonVersion '' + // Solve conflicts with okio + implementation `` com.squareup.okio : okio : $ rootProject.okioVersion '' + } apply plugin : 'com.google.gms.google-services ' Ca n't build app on Android Studio 3.3 [ Working as intended ] __EoT__ Works fine on Android Studio 3.1 , but on 3.3 when targeting mobile : 3 errors from Java compiler : ERROR : [ TAG ] Failed to resolve variable ' $ { animal.sniffer.version } ' ERROR : [ TAG ] Failed to resolve variable ' $ { project.version } ' ERROR : [ TAG ] Failed to resolve variable ' $ { animal.sniffer.version } ' 1 error from run tasks : `` ` org.gradle.execution.MultipleBuildFailures : Build completed with 1 failures . at org.gradle.initialization.DefaultGradleLauncher $ ExecuteTasks.run ( DefaultGradleLauncher.java:350 ) at org.gradle.internal.operations.DefaultBuildOperationExecutor $ RunnableBuildOperationWorker.execute ( DefaultBuildOperationExecutor.java:300 ) at org.gradle.internal.operations.DefaultBuildOperationExecutor $ RunnableBuildOperationWorker.execute ( DefaultBuildOperationExecutor.java:292 ) at org.gradle.internal.operations.DefaultBuildOperationExecutor.execute ( DefaultBuildOperationExecutor.java:174 ) at org.gradle.internal.operations.DefaultBuildOperationExecutor.run ( DefaultBuildOperationExecutor.java:90 ) at org.gradle.internal.operations.DelegatingBuildOperationExecutor.run ( DelegatingBuildOperationExecutor.java:31 ) at org.gradle.initialization.DefaultGradleLauncher.runTasks ( DefaultGradleLauncher.java:216 ) at org.gradle.initialization.DefaultGradleLauncher.doBuildStages ( DefaultGradleLauncher.java:146 ) at org.gradle.initialization.DefaultGradleLauncher.executeTasks ( DefaultGradleLauncher.java:121 ) at org.gradle.internal.invocation.GradleBuildController $ 1.call ( GradleBuildController.java:77 ) at org.gradle.internal.invocation.GradleBuildController $ 1.call ( GradleBuildController.java:74 ) at org.gradle.internal.work.DefaultWorkerLeaseService.withLocks ( DefaultWorkerLeaseService.java:152 ) at org.gradle.internal.work.StopShieldingWorkerLeaseService.withLocks ( StopShieldingWorkerLeaseService.java:38 ) at org.gradle.internal.invocation.GradleBuildController.doBuild ( GradleBuildController.java:96 ) at org.gradle.internal.invocation.GradleBuildController.run ( GradleBuildController.java:74 ) at org.gradle.tooling.internal.provider.runner.BuildModelActionRunner.run ( BuildModelActionRunner.java:55 ) at org.gradle.launcher.exec.ChainingBuildActionRunner.run ( ChainingBuildActionRunner.java:35 ) at org.gradle.launcher.exec.ChainingBuildActionRunner.run ( ChainingBuildActionRunner.java:35 ) at org.gradle.tooling.internal.provider.ValidatingBuildActionRunner.run ( ValidatingBuildActionRunner.java:32 )
diff -- git a/.travis.yml b/.travis.yml index 4f16f43..7d8f162 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -14,10 +14,14 @ @ language : android +sudo : false + android : components : - - build-tools-21.1.2 - - android-21 + - platform-tool + - tool + - build-tools-23.0.1 + - android-23 - addon-google_apis-google-21 - extra-google-m2repository - extra-android-m2repository @ @ -31,5 +35,10 @ @ before_install : - emulator -avd test -no-skin -no-audio -no-window & before_script : - - ./scripts/wait_for_emulator.sh + - android-wait-for-emulator - adb shell input keyevent 82 & + - wget -P android https : //github.com/google/iosched/raw/0f7e56ff2588b816476fbad253554f49003e869d/android/debug.keystore + +script : + - ./gradlew clean android : assembleDebug server : assemble + Travis-ci configuration outdated __EoT__ 1 . Migrate from legacy to container-based infrastructure for faster builds adding ` sudo : false ` 2 . Resque the android/debug.keystore from Iosched 2014 for CI usage using wget : wget -P android https : //github.com/google/iosched/raw/0f7e56ff2588b816476fbad253554f49003e869d/android/debug.keystore 3 . Update tools is required . 4 . Travis-ci runs ` ./gradlew build connectedCheck ` by default , ` qualityassurance ` buildType requires new proguard rules and server tests run and fail on build , so I suggest only assemble by now . 5 . Updated : Use [ default android-wait-for-emulator script ] ( https : //github.com/travis-ci/travis-cookbooks/blob/a68419ebe0ce92876a70534cd145ddd931d0feee/ci_environment/android-sdk/files/default/android-wait-for-emulator ) . Optionally , use [ dependency caching ] ( http : //docs.travis-ci.com/user/languages/android/ # Caching ) `` ` before_cache : - rm -f $ HOME/.gradle/caches/modules-2/modules-2.lock cache : directories : - $ HOME/.gradle/caches/ - $ HOME/.gradle/wrapper/ `` ` and new proguard rules to avoid qualityassurance CI build warnings : `` ` # Avoid packageQualityassurance warnings on CI server -dontwarn com.android.volley.toolbox . ** -dontwarn com.google.android.gms.analytics . ** -dontwarn com.google.android.gms.internal.zzvp -dontwarn com.google.android.gms.common.GooglePlayServicesUtil -dontwarn com.google.android.gms.tagmanager . ** -dontwarn com.larvalabs.svgandroid . ** `` `
diff -- git a/gson/src/main/java/com/google/gson/internal/ $ Gson $ Types.java b/gson/src/main/java/com/google/gson/internal/ $ Gson $ Types.java index 6739453..8aa0982 100644 -- - a/gson/src/main/java/com/google/gson/internal/ $ Gson $ Types.java +++ b/gson/src/main/java/com/google/gson/internal/ $ Gson $ Types.java @ @ -334,10 +334,21 @ @ public final class $ Gson $ Types { } public static Type resolve ( Type context , Class < ? > contextRawType , Type toResolve ) { + return resolve ( context , contextRawType , toResolve , new HashSet < TypeVariable > ( ) ) ; + } + + private static Type resolve ( Type context , Class < ? > contextRawType , Type toResolve , + Collection < TypeVariable > visitedTypeVariables ) { // this implementation is made a little more complicated in an attempt to avoid object-creation while ( true ) { if ( toResolve instanceof TypeVariable ) { TypeVariable < ? > typeVariable = ( TypeVariable < ? > ) toResolve ; + if ( visitedTypeVariables.contains ( typeVariable ) ) { + // can not reduce due to infinite recursion + return toResolve ; + } else { + visitedTypeVariables.add ( typeVariable ) ; + } toResolve = resolveTypeVariable ( context , contextRawType , typeVariable ) ; if ( toResolve == Getting this issue while using GSON Api __EoT__ S : Fault xmlns : ns4= '' http : //www.w3.org/2003/05/soap-envelope '' > < faultcode > S : Server < /faultcode > < faultstring > EJB Exception : : java.lang.StackOverflowError at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:375 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:375 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:375 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:375 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:375 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:375 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve (
diff -- git a/gson/src/main/java/com/google/gson/internal/ $ Gson $ Types.java b/gson/src/main/java/com/google/gson/internal/ $ Gson $ Types.java index 6739453..f66ac15 100644 -- - a/gson/src/main/java/com/google/gson/internal/ $ Gson $ Types.java +++ b/gson/src/main/java/com/google/gson/internal/ $ Gson $ Types.java @ @ -25,11 +25,7 @ @ import java.lang.reflect.ParameterizedType ; import java.lang.reflect.Type ; import java.lang.reflect.TypeVariable ; import java.lang.reflect.WildcardType ; -import java.util.Arrays ; -import java.util.Collection ; -import java.util.Map ; -import java.util.NoSuchElementException ; -import java.util.Properties ; +import java.util . * ; import static com.google.gson.internal. $ Gson $ Preconditions.checkArgument ; import static com.google.gson.internal. $ Gson $ Preconditions.checkNotNull ; @ @ -334,10 +330,21 @ @ public final class $ Gson $ Types { } public static Type resolve ( Type context , Class < ? > contextRawType , Type toResolve ) { + return resolve ( context , contextRawType , toResolve , new HashSet < TypeVariable > ( ) ) ; + } + + private static Type resolve ( Type context , Class < ? > contextRawType , Type toResolve , + Collection < TypeVariable > visitedTypeVariables ) { // this implementation is made a little more complicated in an attempt to avoid object-creation while ( true ) { if ( toResolve instanceof TypeVariable ) { TypeVariable < ? > typeVariable = ( TypeVariable < Getting this issue while using GSON Api __EoT__ S : Fault xmlns : ns4= '' http : //www.w3.org/2003/05/soap-envelope '' > < faultcode > S : Server < /faultcode > < faultstring > EJB Exception : : java.lang.StackOverflowError at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:375 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:375 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:375 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:375 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:375 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:375 ) at com.google.gson.internal. $ Gson $ Types.resolve ( $ Gson $ Types.java:380 ) at com.google.gson.internal. $ Gson $ Types.resolve (
diff -- git a/gson/src/main/java/com/google/gson/stream/JsonWriter.java b/gson/src/main/java/com/google/gson/stream/JsonWriter.java index 8148816..a81d270 100644 -- - a/gson/src/main/java/com/google/gson/stream/JsonWriter.java +++ b/gson/src/main/java/com/google/gson/stream/JsonWriter.java @ @ -351,7 +351,7 @ @ public class JsonWriter implements Closeable , Flushable { } private void push ( int newTop ) { - if ( stackSize == stack.length ) { + if ( stack ! =null & & stackSize == stack.length ) { int [ ] newStack = new int [ stackSize * 2 ] ; System.arraycopy ( stack , 0 , newStack , 0 , stackSize ) ; stack = newStack ; Possible dereference of a null value in JsonWriter.java from static analysis tool . __EoT__ While doing a static code analysis from CheckerFramework tool , field ` stack ` might lead to possible null dereference . Here is comparison of suggested code and original code . Code change suggestion for ` push ` method when it called from anonymous block . Here is original code : `` ` private void push ( int newTop ) { if ( stackSize == stack.length ) { `` ` Suggested changes based on class instance still being in under-initialization state . Hence , dereferencing of ` stack ` can be problematic . Error message : `` ` JsonWriter.java:360 : error : [ dereference.of.nullable ] dereference of possibly-null reference stack if ( stackSize == stack.length ) { // Annotation added from nullness checker analysis . `` ` Suggested Changes : `` ` private void push ( /* > > > @ UnknownInitialization ( java.lang.Object.class ) JsonWriter this , */ int newTop ) { if ( stack ! =null & & stackSize == stack.length ) { // Annotation added from nullness checker analysis . `` ` If this issue is needed to be considered a ` pr
diff -- git a/CalligraphySample/src/main/java/uk/co/chrisjenx/calligraphy/sample/MainActivity.java b/CalligraphySample/src/main/java/uk/co/chrisjenx/calligraphy/sample/MainActivity.java index 9691f4e..3c94ef2 100644 -- - a/CalligraphySample/src/main/java/uk/co/chrisjenx/calligraphy/sample/MainActivity.java +++ b/CalligraphySample/src/main/java/uk/co/chrisjenx/calligraphy/sample/MainActivity.java @ @ -7,9 +7,11 @ @ import android.support.v4.app.FragmentActivity ; import android.view.LayoutInflater ; import android.view.View ; import android.view.ViewGroup ; +import android.widget.TextView ; import uk.co.chrisjenx.calligraphy.CalligraphyConfig ; import uk.co.chrisjenx.calligraphy.CalligraphyContextWrapper ; +import uk.co.chrisjenx.calligraphy.CalligraphyUtils ; public class MainActivity extends FragmentActivity { @ @ -19,6 +21,11 @ @ public class MainActivity extends FragmentActivity { CalligraphyConfig.initDefault ( `` fonts/Roboto-ThinItalic.ttf '' ) ; setContentView ( R.layout.activity_main ) ; + + // Init action bar title + int titleId = getResources ( ) .getIdentifier ( `` action_bar_title '' , `` id '' , '' android '' ) ; + TextView tv = ( TextView ) findViewById ( titleId ) ; + CalligraphyUtils.applyFontToTextView ( this , tv , CalligraphyConfig.get ( ) , `` fonts/Roboto-ThinItalic.ttf '' ) ; } @ Override diff -- git a/calligraphy/src/main/java/uk/co/chrisjenx/calligraphy/CalligraphyConfig.java b/calligraphy/src/main/java/uk/co/chrisjenx/calligraphy/CalligraphyConfig.java index 2d4c643..3917609 100644 -- - a/calligraphy/src/main/java/uk/co/chrisjenx/calligraphy/CalligraphyConfig.java +++ b/calligraphy/src/main/java/uk/co/chrisjenx/calligraphy/CalligraphyConfig.java @ @ -21,7 +21,7 @ @ public class CalligraphyConfig { mInstance = new CalligraphyConfig ( defaultFontAssetPath ) ; } - static CalligraphyConfig get ( ) { + public static CalligraphyConfig get ( ) { if ( mInstance == null ) throw new IllegalStateException ( `` You must initDefault for CalligraphyConfig , if you are Crash that happens every so often : Failed to resolve TypedValue attribute __EoT__ We see this reported by our HockeyApp crash reports in the field and I see it happen in the emulator ever once it a while . Unsure how to recreate it . E/AndroidRuntime : FATAL EXCEPTION : main android.view.InflateException : Binary XML file line # 17 : Failed to resolve attribute at index 6 : TypedValue { t=0x1c/d=0xff80cbc4 a=2 r=0x7f0e013a } at android.view.LayoutInflater.inflate ( LayoutInflater.java:539 ) at uk.co.chrisjenx.calligraphy.CalligraphyLayoutInflater.inflate ( CalligraphyLayoutInflater.java:60 ) at android.view.LayoutInflater.inflate ( LayoutInflater.java:423 ) at android.support.v7.view.menu.MenuAdapter.getView ( MenuAdapter.java:89 ) at android.support.v7.view.menu.MenuPopup.measureIndividualMenuWidth ( MenuPopup.java:160 ) at android.support.v7.view.menu.StandardMenuPopup.tryShow ( StandardMenuPopup.java:153 ) at android.support.v7.view.menu.StandardMenuPopup.show ( StandardMenuPopup.java:187 ) at android.support.v7.view.menu.MenuPopupHelper.showPopup ( MenuPopupHelper.java:286 ) at android.support.v7.view.menu.MenuPopupHelper.tryShow ( MenuPopupHelper.java:171 ) at android.support.v7.widget.ActionMenuPresenter $ OpenOverflowRunnable.run ( ActionMenuPresenter.java:803 ) at android.os.Handler.handleCallback ( Handler.java:739 ) at android.os.Handler.dispatchMessage ( Handler.java:95 ) at android.os.Looper.loop ( Looper.java:148 ) at android.app.ActivityThread.main ( ActivityThread.java:5417 ) at java.lang.reflect.Method.invoke ( Native Method ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:726 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:616 ) Caused by : java.lang.UnsupportedOperationException : Failed to resolve attribute at index 6 : TypedValue { t=0x1c/d=0xff80cbc4 a=2 r=0x7f0e013a } at android.content.res.TypedArray.getLayoutDimension ( TypedArray.java:705 ) at android.view.ViewGroup $ LayoutParams.setBaseAttributes ( ViewGroup.java:6890 ) at android.view.ViewGroup $ MarginLayoutParams. <
diff -- git a/CHANGELOG.md b/CHANGELOG.md index e8bd952..fe2bfc6 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,9 +1,10 @ @ # Changelog # 0.8.0 ( WIP ) +- Added ActionBar Title/SubTitle support . # 0.7.1 ( 22/04/2014 ) -- Fixed Resources not found Exception - PR # 31 [ @ Smuldr ] ( https : //github.com/Smuldr ) +- Fixed Resources not found Exception - [ @ Smuldr ] ( https : //github.com/Smuldr ) # 0.7.0 ( 28/01/2014 ) - Added Anti-aliasing support diff -- git a/CalligraphySample/src/main/java/uk/co/chrisjenx/calligraphy/sample/MainActivity.java b/CalligraphySample/src/main/java/uk/co/chrisjenx/calligraphy/sample/MainActivity.java index 6ce4c43..3a46f96 100644 -- - a/CalligraphySample/src/main/java/uk/co/chrisjenx/calligraphy/sample/MainActivity.java +++ b/CalligraphySample/src/main/java/uk/co/chrisjenx/calligraphy/sample/MainActivity.java @ @ -2,6 +2,8 @ @ package uk.co.chrisjenx.calligraphy.sample ; import android.content.Context ; import android.os.Bundle ; +import android.os.Handler ; +import android.os.Looper ; import android.support.v4.app.Fragment ; import android.support.v4.app.FragmentActivity ; import android.view.LayoutInflater ; @ @ -19,6 +21,14 @ @ public class MainActivity extends FragmentActivity { CalligraphyConfig.initDefault ( `` fonts/Roboto-ThinItalic.ttf '' ) ; setContentView ( R.layout.activity_main ) ; + + new Handler ( Looper.getMainLooper ( ) ) .postDelayed ( new Runnable ( ) { + @ Override + public void run ( ) { + setTitle ( `` Calligraphy changed '' ) ; + getActionBar ( ) .setSubtitle ( `` Added subtitle '' ) ; + } + } , Is it possible to set font for Actionbar title or toast and more ? __EoT__
diff -- git a/.gitignore b/.gitignore index 0ef2396..eeb8f77 100644 -- - a/.gitignore +++ b/.gitignore @ @ -11,3 +11,4 @ @ vcs.xml .idea/misc.xml +.idea/ diff -- git a/.idea/.name b/.idea/.name deleted file mode 100644 index e094078..0000000 -- - a/.idea/.name +++ /dev/null @ @ -1 +0,0 @ @ -Luban \ No newline at end of file diff -- git a/.idea/compiler.xml b/.idea/compiler.xml deleted file mode 100644 index 96cc43e..0000000 -- - a/.idea/compiler.xml +++ /dev/null @ @ -1,22 +0,0 @ @ - < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > - < project version= '' 4 '' > - < component name= '' CompilerConfiguration '' > - < resourceExtensions / > - < wildcardResourcePatterns > - < entry name= '' ! ? *.java '' / > - < entry name= '' ! ? *.form '' / > - < entry name= '' ! ? *.class '' / > - < entry name= '' ! ? *.groovy '' / > - < entry name= '' ! ? *.scala '' / > - < entry name= '' ! ? *.flex '' / > - < entry name= '' ! ? *.kt '' / > - < entry name= '' ! ? *.clj '' / 为什么我原来的file是jpg格式的，压缩过后onSuccess里的file就没有格式了呢 __EoT__
diff -- git a/androidframework/src/main/java/com/blankj/androidframework/utils/RegularUtils.java b/androidframework/src/main/java/com/blankj/androidframework/utils/RegularUtils.java index 30e15ac..113007f 100644 -- - a/androidframework/src/main/java/com/blankj/androidframework/utils/RegularUtils.java +++ b/androidframework/src/main/java/com/blankj/androidframework/utils/RegularUtils.java @ @ -16,7 +16,7 @ @ public class RegularUtils { } // 验证手机号 - private static final String REGEX_MOBILE = `` ^ ( 13 [ 0-9 ] |14 [ 5|7 ] |15 [ 0|1|2|3|5|6|7|8|9 ] |18 [ 0|1|2|3|5|6|7|8|9 ] ) \\d { 8 } $ '' ; + private static final String REGEX_MOBILE = `` ^ [ 1 ] \d { 10 } $ '' ; // 验证座机号 , 正确格式：xxx/xxxx-xxxxxxx/xxxxxxxx private static final String REGEX_TEL = `` ^0\\d { 2,3 } [ - ] ? \\d { 7,8 } '' ; // 验证邮箱 1.19.0以上版本ToastUtils导致应用闪退 __EoT__ 机型：小米5 Android版本：魔趣8.1 调用ToastUtils.showShort ( ) ，第一次弹出成功，第二次弹出应用崩溃。 IDE看到的错误为：libc : Fatal signal 6 ( SIGABRT ) , code -6 使用1.19.0版本不会出现这个错误。
diff -- git a/demo/AndroidManifest.xml b/demo/AndroidManifest.xml index aabfb40..a839fca 100644 -- - a/demo/AndroidManifest.xml +++ b/demo/AndroidManifest.xml @ @ -22,6 +22,10 @ @ < category android : name= '' android.intent.category.LAUNCHER '' / > < /intent-filter > < /activity > + < activity + android : name= '' com.sothree.slidinguppanel.demo.RecyclerDemoActivity '' + android : label= '' @ string/app_name '' > + < /activity > < /application > < /manifest > diff -- git a/demo/build.gradle b/demo/build.gradle index 36e0061..7fe7c2d 100644 -- - a/demo/build.gradle +++ b/demo/build.gradle @ @ -2,7 +2,7 @ @ apply plugin : 'com.android.application' android { compileSdkVersion 21 - buildToolsVersion `` 21.0.1 '' + buildToolsVersion `` 21.1.2 '' lintOptions { abortOnError false @ @ -24,7 +24,9 @ @ android { } dependencies { - compile 'com.android.support : support-v4:21.0.0' - compile 'com.android.support : appcompat-v7:21.0.0' + compile 'com.android.support : support-v4:22.2.1' + compile 'com.android.support : appcompat-v7:22.2.1' + compile 'com.android.support : recyclerview-v7:22.2.1' compile project ( ' : library ' ) + compile 'com.android.support : cardview-v7:22.2.1' } diff -- git a/demo/res/layout/activity_demo_recycler.xml b/demo/res/layout/activity_demo_recycler.xml new file mode 100644 index 0000000..25e65db -- - /dev/null +++ b/demo/res/layout/activity_demo_recycler.xml @ @ -0,0 +1,92 @ @ + < RelativeLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' + xmlns : tools= '' http : //schemas.android.com/tools '' + android : Add support for RecycleView in umanoScrollableView __EoT__ Is there a way how to fix functionality of my RecyclerView after implementing SlidingUpPanel ?
diff -- git a/README.md b/README.md index 0009d5d..6cc829a 100644 -- - a/README.md +++ b/README.md @ @ -25,7 +25,7 @ @ dependencies { repositories { mavenCentral ( ) } - compile 'com.sothree.slidinguppanel : library:3.1.0' + compile 'com.sothree.slidinguppanel : library:3.0.0' } `` ` @ @ -87,7 +87,6 @ @ or ` ? attr/actionBarSize ` to support older API versions . * You can set a anchor point in the middle of the screen using ` setAnchorPoint ` to allow an intermediate expanded state for the panel ( similar to Google Maps ) . * You can set a ` PanelSlideListener ` to monitor events about sliding panes . * You can also make the panel slide from the top by changing the ` layout_gravity ` attribute of the layout to ` top ` . -* If you have a ScrollView or a ListView inside of the panel , make sure to set ` umanoScrollableView ` attribute on the panel to supported nested scrolling . * By default , the panel pushes up the main content . You can make it overlay the main content by using ` setOverlayed ` method or ` umanoOverlay ` attribute . This is useful if you would like Add support for RecycleView in umanoScrollableView __EoT__ Is there a way how to fix functionality of my RecyclerView after implementing SlidingUpPanel ?
diff -- git a/README.md b/README.md index c14785b..2c1a91c 100644 -- - a/README.md +++ b/README.md @ @ -1,8 +1,71 @ @ [ ! [ Maven Central ] ( https : //maven-badges.herokuapp.com/maven-central/com.sothree.slidinguppanel/library/badge.svg ) ] ( https : //maven-badges.herokuapp.com/maven-central/com.sothree.slidinguppanel/library ) -Android Sliding Up Panel -========================= +Android Sliding Up Panel - Material Design +=========================================== +This is a fork of Umano Sliding Up Panel that aims to bring some Material Design features : + + # # # # Floating Action Button + +Added the ability to attach a Floating Action Button to the Sliding Up Panel ( as seen in the Google Maps Material Design version ) . To include the Floating Action Button to your layout change it to this : + `` ` xml + < com.sothree.slidinguppanel.FloatingActionButtonLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' + xmlns : fab= '' http : //schemas.android.com/apk/res-auto '' + xmlns : tools= '' http : //schemas.android.com/tools '' + android : layout_width= '' match_parent '' + android : layout_height= '' match_parent '' + tools : context= '' .DemoActivity '' > + + < ! -- SLIDING UP PANEL -- > + < com.sothree.slidinguppanel.SlidingUpPanelLayout xmlns : sothree= '' http : //schemas.android.com/apk/res-auto '' + android : id= '' @ +id/sliding_layout Sliding Panel Overlay __EoT__ Is there a way to add a layer ( full width and height ) over the sliding panel ? For example a floating action button that is over both the sliding panel and the underlying view that is independant of both the views and their behaviors .
diff -- git a/README.md b/README.md index 2cdabe8..a82d67c 100644 -- - a/README.md +++ b/README.md @ @ -1,8 +1,95 @ @ [ ! [ Maven Central ] ( https : //maven-badges.herokuapp.com/maven-central/com.sothree.slidinguppanel/library/badge.svg ) ] ( https : //maven-badges.herokuapp.com/maven-central/com.sothree.slidinguppanel/library ) -Android Sliding Up Panel -========================= +Android Sliding Up Panel - Material Design +=========================================== +This is a fork of Umano Sliding Up Panel that aims to bring some Material Design features : + + # # # # Floating Action Button + +Added the ability to attach a Floating Action Button to the Sliding Up Panel ( as seen in the Google Maps Material Design version ) . To include the Floating Action Button to your layout change it to this : + `` ` xml + < com.sothree.slidinguppanel.FloatingActionButtonLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' + xmlns : sothree= '' http : //schemas.android.com/apk/res-auto '' + xmlns : fab= '' http : //schemas.android.com/apk/res-auto '' + xmlns : tools= '' http : //schemas.android.com/tools '' + android : layout_width= '' match_parent '' + android : layout_height= '' match_parent '' + sothree : umanoFabMode= [ `` leave_behind '' | `` circular_reveal '' | `` fade '' ] + tools : context= '' .DemoActivity '' > + + Sliding Panel Overlay __EoT__ Is there a way to add a layer ( full width and height ) over the sliding panel ? For example a floating action button that is over both the sliding panel and the underlying view that is independant of both the views and their behaviors .
diff -- git a/README.md b/README.md index c14785b..ea46f73 100644 -- - a/README.md +++ b/README.md @ @ -1,8 +1,58 @ @ [ ! [ Maven Central ] ( https : //maven-badges.herokuapp.com/maven-central/com.sothree.slidinguppanel/library/badge.svg ) ] ( https : //maven-badges.herokuapp.com/maven-central/com.sothree.slidinguppanel/library ) -Android Sliding Up Panel -========================= +Android Sliding Up Panel - Material Design +=========================================== +This is a fork of Umano Sliding Up Panel that aims to bring some Material Design features : + + # # # # Floating Action Button + +Added the ability to attach a Floating Action Button to the Sliding Up Panel ( as seen in the Google Maps Material Design version ) . To include the Floating Action Button to your layout change it to this : + `` ` xml + < com.sothree.slidinguppanel.FloatingActionButtonLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' + xmlns : fab= '' http : //schemas.android.com/apk/res-auto '' + xmlns : tools= '' http : //schemas.android.com/tools '' + android : layout_width= '' match_parent '' + android : layout_height= '' match_parent '' + tools : context= '' .DemoActivity '' > + + < ! -- SLIDING UP PANEL -- > + < com.sothree.slidinguppanel.SlidingUpPanelLayout xmlns : sothree= '' http : //schemas.android.com/apk/res-auto '' + android : id= '' @ +id/sliding_layout Floating action button use __EoT__ I wonder if you can use a floating button . Similar to that used by google maps , which is located between the map view and the slide information . How could I simulate it ?
diff -- git a/README.md b/README.md index c14785b..148a50a 100644 -- - a/README.md +++ b/README.md @ @ -1,8 +1,61 @ @ [ ! [ Maven Central ] ( https : //maven-badges.herokuapp.com/maven-central/com.sothree.slidinguppanel/library/badge.svg ) ] ( https : //maven-badges.herokuapp.com/maven-central/com.sothree.slidinguppanel/library ) -Android Sliding Up Panel -========================= +Android Sliding Up Panel - Material Design +=========================================== +This is a fork of Umano Sliding Up Panel that aims to bring some Material Design features : + + # # # # Floating Action Button + +Added the ability to attach a Floating Action Button to the Sliding Up Panel ( as seen in the Google Maps Material Design version ) . To include the Floating Action Button to your layout change it to this : + `` ` xml + < com.sothree.slidinguppanel.FloatingActionButtonLayout xmlns : android= '' http : //schemas.android.com/apk/res/android '' + xmlns : fab= '' http : //schemas.android.com/apk/res-auto '' + xmlns : tools= '' http : //schemas.android.com/tools '' + android : layout_width= '' match_parent '' + android : layout_height= '' match_parent '' + tools : context= '' .DemoActivity '' > + + < ! -- SLIDING UP PANEL -- > + < com.sothree.slidinguppanel.SlidingUpPanelLayout xmlns : sothree= '' http : //schemas.android.com/apk/res-auto '' + android : id= '' @ +id/sliding_layout Floating action button use __EoT__ I wonder if you can use a floating button . Similar to that used by google maps , which is located between the map view and the slide information . How could I simulate it ?
diff -- git a/butterknife-compiler/src/main/java/butterknife/compiler/BindingSet.java b/butterknife-compiler/src/main/java/butterknife/compiler/BindingSet.java index b20aff4..821909f 100644 -- - a/butterknife-compiler/src/main/java/butterknife/compiler/BindingSet.java +++ b/butterknife-compiler/src/main/java/butterknife/compiler/BindingSet.java @ @ -29,6 +29,7 @ @ import javax.lang.model.type.TypeMirror ; import static butterknife.compiler.ButterKnifeProcessor.ACTIVITY_TYPE ; import static butterknife.compiler.ButterKnifeProcessor.DIALOG_TYPE ; import static butterknife.compiler.ButterKnifeProcessor.VIEW_TYPE ; +import static butterknife.compiler.ButterKnifeProcessor.hasAndroidX ; import static butterknife.compiler.ButterKnifeProcessor.isSubtypeOfType ; import static com.google.auto.common.MoreElements.getPackage ; import static java.util.Collections.singletonList ; @ @ -44,14 +45,20 @ @ final class BindingSet { private static final ClassName RESOURCES = ClassName.get ( `` android.content.res '' , `` Resources '' ) ; private static final ClassName UI_THREAD = ClassName.get ( `` android.support.annotation '' , `` UiThread '' ) ; + private static final ClassName UI_THREAD_ANDROIDX = + ClassName.get ( `` androidx.annotation '' , `` UiThread '' ) ; private static final ClassName CALL_SUPER = ClassName.get ( `` android.support.annotation '' , `` CallSuper '' ) ; + private static final ClassName CALL_SUPER_ANDROIDX = + ClassName.get ( `` androidx.annotation '' , `` CallSuper '' ) ; private static final ClassName SUPPRESS_LINT = ClassName.get ( `` android.annotation '' , `` SuppressLint '' ) ; private static final ClassName UNBINDER = ClassName.get ( `` butterknife '' , `` Unbinder '' ) ; static final ClassName BITMAP_FACTORY = ClassName.get ( `` android.graphics '' , `` BitmapFactory '' ) ; static Importing Androidx annotation __EoT__ the generated ViewBinding class imports annotation from android package instead of androidx package hence the error error : package android.support.annotation does not exist error : can not find symbol class UiThread error : can not find symbol class CallSuper # # # Gradle Properties `` ` repositories { google ( ) mavenCentral ( ) maven { name 'Sonatype SNAPSHOTs' url 'https : //oss.sonatype.org/content/repositories/snapshots/' } jcenter ( ) } `` ` `` ` dependencies { classpath 'com.android.tools.build : gradle:3.3.0-alpha09' classpath 'com.google.gms : google-services:4.0.1' classpath 'com.jakewharton : butterknife-gradle-plugin:9.0.0-SNAPSHOT' // NOTE : Do not place your application dependencies here ; they belong // in the individual module build.gradle files } `` ` `` ` implementation 'com.jakewharton : butterknife:8.8.1' annotationProcessor 'com.jakewharton : butterknife-compiler:8.8.1 ' `` `
diff -- git a/butterknife-compiler/src/main/java/butterknife/compiler/BindingSet.java b/butterknife-compiler/src/main/java/butterknife/compiler/BindingSet.java index b20aff4..1c44014 100644 -- - a/butterknife-compiler/src/main/java/butterknife/compiler/BindingSet.java +++ b/butterknife-compiler/src/main/java/butterknife/compiler/BindingSet.java @ @ -44,14 +44,20 @ @ final class BindingSet { private static final ClassName RESOURCES = ClassName.get ( `` android.content.res '' , `` Resources '' ) ; private static final ClassName UI_THREAD = ClassName.get ( `` android.support.annotation '' , `` UiThread '' ) ; + private static final ClassName UI_THREAD_ANDROIDX = + ClassName.get ( `` androidx.annotation '' , `` UiThread '' ) ; private static final ClassName CALL_SUPER = ClassName.get ( `` android.support.annotation '' , `` CallSuper '' ) ; + private static final ClassName CALL_SUPER_ANDROIDX = + ClassName.get ( `` androidx.annotation '' , `` CallSuper '' ) ; private static final ClassName SUPPRESS_LINT = ClassName.get ( `` android.annotation '' , `` SuppressLint '' ) ; private static final ClassName UNBINDER = ClassName.get ( `` butterknife '' , `` Unbinder '' ) ; static final ClassName BITMAP_FACTORY = ClassName.get ( `` android.graphics '' , `` BitmapFactory '' ) ; static final ClassName CONTEXT_COMPAT = ClassName.get ( `` android.support.v4.content '' , `` ContextCompat '' ) ; + static final ClassName CONTEXT_COMPAT_ANDROIDX = + ClassName.get ( `` androidx.core.content '' , `` ContextCompat '' ) ; static final ClassName ANIMATION_UTILS Importing Androidx annotation __EoT__ the generated ViewBinding class imports annotation from android package instead of androidx package hence the error error : package android.support.annotation does not exist error : can not find symbol class UiThread error : can not find symbol class CallSuper # # # Gradle Properties `` ` repositories { google ( ) mavenCentral ( ) maven { name 'Sonatype SNAPSHOTs' url 'https : //oss.sonatype.org/content/repositories/snapshots/' } jcenter ( ) } `` ` `` ` dependencies { classpath 'com.android.tools.build : gradle:3.3.0-alpha09' classpath 'com.google.gms : google-services:4.0.1' classpath 'com.jakewharton : butterknife-gradle-plugin:9.0.0-SNAPSHOT' // NOTE : Do not place your application dependencies here ; they belong // in the individual module build.gradle files } `` ` `` ` implementation 'com.jakewharton : butterknife:8.8.1' annotationProcessor 'com.jakewharton : butterknife-compiler:8.8.1 ' `` `
diff -- git a/butterknife-gradle-plugin/src/main/java/butterknife/plugin/FinalRClassBuilder.java b/butterknife-gradle-plugin/src/main/java/butterknife/plugin/FinalRClassBuilder.java index 931490d..6ab861c 100644 -- - a/butterknife-gradle-plugin/src/main/java/butterknife/plugin/FinalRClassBuilder.java +++ b/butterknife-gradle-plugin/src/main/java/butterknife/plugin/FinalRClassBuilder.java @ @ -12,8 +12,6 @ @ import com.squareup.javapoet.FieldSpec ; import com.squareup.javapoet.JavaFile ; import com.squareup.javapoet.TypeSpec ; import java.io.File ; -import java.util.Arrays ; -import java.util.List ; import static javax.lang.model.element.Modifier.FINAL ; import static javax.lang.model.element.Modifier.PUBLIC ; @ @ -25,9 +23,6 @ @ import static javax.lang.model.element.Modifier.STATIC ; */ public final class FinalRClassBuilder { private static final String SUPPORT_ANNOTATION_PACKAGE = `` android.support.annotation '' ; - private static final String [ ] SUPPORTED_TYPES = { - `` array '' , `` attr '' , `` bool '' , `` color '' , `` dimen '' , `` drawable '' , `` id '' , `` integer '' , `` string '' - } ; private FinalRClassBuilder ( ) { } @ @ -41,7 +36,7 @ @ public final class FinalRClassBuilder { for ( Node node : resourceClass.getChildrenNodes ( ) ) { if ( node instanceof TypeDeclaration ) { - addResourceType ( Arrays.asList ( SUPPORTED_TYPES ) , result , ( TypeDeclaration ) node ) ; + addResourceType ( result , ( TypeDeclaration ) node ) ; } } @ @ -52,12 +47,7 @ @ public final class FinalRClassBuilder { finalR.writeTo ( outputDir ) ; } Allow layout resources in R2 __EoT__ Currently the gradle plugin skips layout types when generating R2 ( https : //github.com/JakeWharton/butterknife/blob/master/butterknife-gradle-plugin/src/main/java/butterknife/plugin/FinalRClassBuilder.java # L28 ) Butterknife does not use these , but I have a feature in [ Epoxy ] ( https : //github.com/airbnb/epoxy ) where a layout resource is a value in an annotation . I would love to support library projects , without having to duplicate the plugin just to add support for layout . I know it 's strange to request this from Butterknife , since it is n't related to the library , but the gradle plugin Butterknife provides is potentially useful to many other libraries . It could be its own generic library . Would it be possible to have the plugin take parameters in our gradle files to specify which resource types it should allow ? @ kageiit R2 actually does include layout files when building with Buck . I 'm wondering if you did something different with buck to allow all resources ?
diff -- git a/butterknife-compiler/src/main/java/butterknife/compiler/ButterKnifeProcessor.java b/butterknife-compiler/src/main/java/butterknife/compiler/ButterKnifeProcessor.java index 83934cd..0df0981 100644 -- - a/butterknife-compiler/src/main/java/butterknife/compiler/ButterKnifeProcessor.java +++ b/butterknife-compiler/src/main/java/butterknife/compiler/ButterKnifeProcessor.java @ @ -1,30 +1,5 @ @ package butterknife.compiler ; -import butterknife.BindArray ; -import butterknife.BindBitmap ; -import butterknife.BindBool ; -import butterknife.BindColor ; -import butterknife.BindDimen ; -import butterknife.BindDrawable ; -import butterknife.BindFloat ; -import butterknife.BindInt ; -import butterknife.BindString ; -import butterknife.BindView ; -import butterknife.BindViews ; -import butterknife.OnCheckedChanged ; -import butterknife.OnClick ; -import butterknife.OnEditorAction ; -import butterknife.OnFocusChange ; -import butterknife.OnItemClick ; -import butterknife.OnItemLongClick ; -import butterknife.OnItemSelected ; -import butterknife.OnLongClick ; -import butterknife.OnPageChange ; -import butterknife.OnTextChanged ; -import butterknife.OnTouch ; -import butterknife.Optional ; -import butterknife.internal.ListenerClass ; -import butterknife.internal.ListenerMethod ; import com.google.auto.common.SuperficialValidation ; import com.google.auto.service.AutoService ; import com.squareup.javapoet.ClassName ; @ @ -35,6 +10,7 @ @ import com.sun.source.util.Trees ; import com.sun.tools.javac.code.Symbol ; import com.sun.tools.javac.tree.JCTree ; import com.sun.tools.javac.tree.TreeScanner ; + import java.io.IOException ; import java.io.PrintWriter ; import java.io.StringWriter ; @ @ -52,6 +28,7 @ @ import java.util.LinkedHashSet ; import java.util.List ; import java.util.Map ; import java.util.Set ; + import javax.annotation.processing.AbstractProcessor ; import javax.annotation.processing.Filer ; import javax.annotation.processing.ProcessingEnvironment ; @ @ -62,6 +39,7 @ @ import javax.lang.model.element.AnnotationMirror ; import javax.lang.model.element.Element ; import javax.lang.model.element.ExecutableElement ; import javax.lang.model.element.Modifier ; +import javax.lang.model.element.Name ; import javax.lang.model.element.TypeElement ; import javax.lang.model.element.VariableElement ; import javax.lang.model.type.ArrayType ; @ @ -74,6 +52,32 @ @ import javax.lang.model.util.Elements ButterKnife generates ViewBinding class with wrong resource ID __EoT__ I am using a 3rd-party library in our project , and compilation works fine , but the app crashes when it starts up . I looked at the logcat and generate source code , it seems the generated source code has the wrong resource ID . For example , the source file is `` ` class HomeActivity ... { @ BindView ( R2.id.mode_transition_layout ) AppModeTransitionLayout modeTransitionLayout ; @ Override protected void onCreate ( @ Nullable Bundle savedInstanceState ) { super.onCreate ( savedInstanceState ) ; setContentView ( R.layout.activity_main ) ; ButterKnife.bind ( this ) ; `` ` The generated ` HomeActivity_ViewBinding ` class has `` ` @ UiThread public HomeActivity_ViewBinding ( T target , View source ) { this.target = target ; target.modeTransitionLayout = Utils.findRequiredViewAsType ( source , R.id.infant_description_text , `` field 'modeTransitionLayout ' '' , AppModeTransitionLayout.class ) ; } `` ` ` R.id.infant_description_text ` is a different resource ID , and I 'd assume here should use ` R.id.mode_transition_layout ` . At the runtime I get an exception says ` java.lang.IllegalStateException : Required view 'infant_description_text ' with ID 2131822441 for field 'modeTransitionLayout ' was not found . If this view is
diff -- git a/build.gradle b/build.gradle index 42dd66f..7db4951 100644 -- - a/build.gradle +++ b/build.gradle @ @ -37,7 +37,7 @ @ subprojects { project - > } } dependencies { - classpath 'com.android.tools.build : gradle:2.2.2' + classpath 'com.android.tools.build : gradle:2.3.0-rc1' classpath 'gradle.plugin.com.kageiit : lintrules:1.1.2' } } diff -- git a/butterknife-compiler/src/main/java/butterknife/compiler/ButterKnifeProcessor.java b/butterknife-compiler/src/main/java/butterknife/compiler/ButterKnifeProcessor.java index 2090066..27aa200 100644 -- - a/butterknife-compiler/src/main/java/butterknife/compiler/ButterKnifeProcessor.java +++ b/butterknife-compiler/src/main/java/butterknife/compiler/ButterKnifeProcessor.java @ @ -1,30 +1,5 @ @ package butterknife.compiler ; -import butterknife.BindArray ; -import butterknife.BindBitmap ; -import butterknife.BindBool ; -import butterknife.BindColor ; -import butterknife.BindDimen ; -import butterknife.BindDrawable ; -import butterknife.BindFloat ; -import butterknife.BindInt ; -import butterknife.BindString ; -import butterknife.BindView ; -import butterknife.BindViews ; -import butterknife.OnCheckedChanged ; -import butterknife.OnClick ; -import butterknife.OnEditorAction ; -import butterknife.OnFocusChange ; -import butterknife.OnItemClick ; -import butterknife.OnItemLongClick ; -import butterknife.OnItemSelected ; -import butterknife.OnLongClick ; -import butterknife.OnPageChange ; -import butterknife.OnTextChanged ; -import butterknife.OnTouch ; -import butterknife.Optional ; -import butterknife.internal.ListenerClass ; -import butterknife.internal.ListenerMethod ; import com.google.auto.common.SuperficialValidation ; import com.google.auto.service.AutoService ; import com.squareup.javapoet.ClassName ; @ @ -35,6 +10,7 @ @ import com.sun.source.util.Trees ; import com.sun.tools.javac.code.Symbol ; import com.sun.tools.javac.tree.JCTree ; import com.sun.tools.javac.tree.TreeScanner ; + import java.io.IOException ; import java.io.PrintWriter ; import java.io.StringWriter ; @ @ -50,8 +26,10 @ @ import java.util.Deque ; import java.util.LinkedHashMap ; import java.util.LinkedHashSet ; import java.util.List ; +import java.util.HashSet ; import ButterKnife generates ViewBinding class with wrong resource ID __EoT__ I am using a 3rd-party library in our project , and compilation works fine , but the app crashes when it starts up . I looked at the logcat and generate source code , it seems the generated source code has the wrong resource ID . For example , the source file is `` ` class HomeActivity ... { @ BindView ( R2.id.mode_transition_layout ) AppModeTransitionLayout modeTransitionLayout ; @ Override protected void onCreate ( @ Nullable Bundle savedInstanceState ) { super.onCreate ( savedInstanceState ) ; setContentView ( R.layout.activity_main ) ; ButterKnife.bind ( this ) ; `` ` The generated ` HomeActivity_ViewBinding ` class has `` ` @ UiThread public HomeActivity_ViewBinding ( T target , View source ) { this.target = target ; target.modeTransitionLayout = Utils.findRequiredViewAsType ( source , R.id.infant_description_text , `` field 'modeTransitionLayout ' '' , AppModeTransitionLayout.class ) ; } `` ` ` R.id.infant_description_text ` is a different resource ID , and I 'd assume here should use ` R.id.mode_transition_layout ` . At the runtime I get an exception says ` java.lang.IllegalStateException : Required view 'infant_description_text ' with ID 2131822441 for field 'modeTransitionLayout ' was not found . If this view is
diff -- git a/butterknife-compiler/pom.xml b/butterknife-compiler/pom.xml new file mode 100644 index 0000000..ab60665 -- - /dev/null +++ b/butterknife-compiler/pom.xml @ @ -0,0 +1,60 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + + < project xmlns= '' http : //maven.apache.org/POM/4.0.0 '' xmlns : xsi= '' http : //www.w3.org/2001/XMLSchema-instance '' xsi : schemaLocation= '' http : //maven.apache.org/POM/4.0.0 http : //maven.apache.org/maven-v4_0_0.xsd '' > + < modelVersion > 4.0.0 < /modelVersion > + + < parent > + < groupId > com.jakewharton < /groupId > + < artifactId > butterknife-parent < /artifactId > + < version > 7.0.2-SNAPSHOT < /version > + < /parent > + + < artifactId > butterknife-compiler < /artifactId > + < name > Butter Knife Compiler < /name > + + < dependencies > + < dependency > + < groupId > junit < /groupId > + < artifactId > junit < /artifactId > + < scope > test < /scope > + < /dependency > + < dependency > + < groupId > org.easytesting < /groupId > + < artifactId > fest-assert-core < /artifactId > + < scope > test < /scope > + < /dependency > + < dependency > + Generate code with JavaPoet __EoT__ Java code generating is currently performed using string builders . This in my opinion makes it hard on readability and maintainability . I would propose changing the code to use [ Square 's JavaPoet ] ( https : //github.com/square/javapoet ) . Could this be something of interest ?
diff -- git a/butterknife-compiler/pom.xml b/butterknife-compiler/pom.xml new file mode 100644 index 0000000..8815e3e -- - /dev/null +++ b/butterknife-compiler/pom.xml @ @ -0,0 +1,66 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + + < project xmlns= '' http : //maven.apache.org/POM/4.0.0 '' xmlns : xsi= '' http : //www.w3.org/2001/XMLSchema-instance '' xsi : schemaLocation= '' http : //maven.apache.org/POM/4.0.0 http : //maven.apache.org/maven-v4_0_0.xsd '' > + < modelVersion > 4.0.0 < /modelVersion > + + < parent > + < groupId > com.jakewharton < /groupId > + < artifactId > butterknife-parent < /artifactId > + < version > 7.0.2-SNAPSHOT < /version > + < /parent > + + < artifactId > butterknife-compiler < /artifactId > + < name > Butter Knife Compiler < /name > + + < dependencies > + < dependency > + < groupId > com.jakewharton < /groupId > + < artifactId > butterknife < /artifactId > + < version > $ { project.version } < /version > + < /dependency > + + < dependency > + < groupId > junit < /groupId > + < artifactId > junit < /artifactId > + < scope > test < /scope > + < /dependency > + Generate code with JavaPoet __EoT__ Java code generating is currently performed using string builders . This in my opinion makes it hard on readability and maintainability . I would propose changing the code to use [ Square 's JavaPoet ] ( https : //github.com/square/javapoet ) . Could this be something of interest ?
diff -- git a/butterknife-annotations/src/main/java/butterknife/OnRatingBarChange.java b/butterknife-annotations/src/main/java/butterknife/OnRatingBarChange.java new file mode 100644 index 0000000..6cda6c1 -- - /dev/null +++ b/butterknife-annotations/src/main/java/butterknife/OnRatingBarChange.java @ @ -0,0 +1,40 @ @ +package butterknife ; + +import android.support.annotation.IdRes ; +import android.view.View ; +import butterknife.internal.ListenerClass ; +import butterknife.internal.ListenerMethod ; +import java.lang.annotation.Retention ; +import java.lang.annotation.Target ; + +import static java.lang.annotation.ElementType.METHOD ; +import static java.lang.annotation.RetentionPolicy.CLASS ; + +/** + * Bind a method to an { @ code OnRatingBarChangeListener } on the view for each ID specified . + * < pre > < code > + * { @ literal @ } OnRatingBarChange ( R.id.example ) void onRatingBarChange ( float rating ) { + * Toast.makeText ( this , `` Rating changed : `` + rating , LENGTH_SHORT ) .show ( ) ; + * } + * < /code > < /pre > + * Any number of parameters from { @ code onRatingChanged } may be used on the method . + */ + @ Target ( METHOD ) + @ Retention ( CLASS ) + @ ListenerClass ( + targetType = `` android.widget.RatingBar '' , + setter = `` setOnRatingBarChangeListener '' , + type = `` android.widget.RatingBar.OnRatingBarChangeListener '' , + method = @ ListenerMethod ( + name = `` Why are n't proposed pull requests merged ? __EoT__ Hi ! Firstly , thank you very much for this library , I 've found it incredibly useful and has helped me remove lots of boilerplate code on my apps . That 's exactly why I 'm surprised it does n't have more stuff . I just read some of the PRs and there are some very useful annotations there , such as https : //github.com/JakeWharton/butterknife/pull/245 https : //github.com/JakeWharton/butterknife/pull/229 https : //github.com/JakeWharton/butterknife/pull/231 https : //github.com/JakeWharton/butterknife/pull/201 They all look like they have useful aplications . In fact , I 'm using two of them on an app I 'm working with at the moment , but I 'd be really nice if they already were integrated with the library , is there any reason they have n't been already ? ( some of them have been there for quite some time ) I understand if you just want to keep this library as small as possible , but then maybe make a butterknife 2.0 or something with the extra stuff ? Or is there another reason ? Idk , just throwing ideas here : P Anyways , just wondering , this still
diff -- git a/butterknife-annotations/src/main/java/butterknife/OnSeekBarChange.java b/butterknife-annotations/src/main/java/butterknife/OnSeekBarChange.java new file mode 100644 index 0000000..69836e4 -- - /dev/null +++ b/butterknife-annotations/src/main/java/butterknife/OnSeekBarChange.java @ @ -0,0 +1,78 @ @ +package butterknife ; + +import android.support.annotation.IdRes ; +import android.view.View ; +import butterknife.internal.ListenerClass ; +import butterknife.internal.ListenerMethod ; +import java.lang.annotation.Retention ; +import java.lang.annotation.Target ; + +import static java.lang.annotation.ElementType.METHOD ; +import static java.lang.annotation.RetentionPolicy.CLASS ; + +/** + * Bind a method to an { @ code OnSeekBarChangeListener } on the view for each ID specified . + * < pre > < code > + * { @ literal @ } OnSeekBarChange ( R.id.example_seekbar ) void onProgressChanged ( int progress ) { + * Toast.makeText ( this , `` Changed progress `` + progress + `` ! `` , LENGTH_SHORT ) .show ( ) ; + * } + * < /code > < /pre > + * Any number of parameters from { @ code onProgressChanged } may be used on the method . + * < p > + * To bind to methods other than { @ code onProgressChanged } , specify a different { @ code callback } . + * < pre > < code > + * { @ literal @ } OnSeekBarChange ( value Why are n't proposed pull requests merged ? __EoT__ Hi ! Firstly , thank you very much for this library , I 've found it incredibly useful and has helped me remove lots of boilerplate code on my apps . That 's exactly why I 'm surprised it does n't have more stuff . I just read some of the PRs and there are some very useful annotations there , such as https : //github.com/JakeWharton/butterknife/pull/245 https : //github.com/JakeWharton/butterknife/pull/229 https : //github.com/JakeWharton/butterknife/pull/231 https : //github.com/JakeWharton/butterknife/pull/201 They all look like they have useful aplications . In fact , I 'm using two of them on an app I 'm working with at the moment , but I 'd be really nice if they already were integrated with the library , is there any reason they have n't been already ? ( some of them have been there for quite some time ) I understand if you just want to keep this library as small as possible , but then maybe make a butterknife 2.0 or something with the extra stuff ? Or is there another reason ? Idk , just throwing ideas here : P Anyways , just wondering , this still
diff -- git a/.travis.yml b/.travis.yml index 4d3f485..881639b 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -14,4 +14,6 @ @ jdk : notifications : email : false -script : ./gradlew assemble check \ No newline at end of file +script : + - ./gradlew assemble check + - ./gradlew checkstyle \ No newline at end of file diff -- git a/checkstyle.xml b/checkstyle.xml new file mode 100644 index 0000000..a3424dd -- - /dev/null +++ b/checkstyle.xml @ @ -0,0 +1,159 @ @ + < ? xml version= '' 1.0 '' ? > + < ! DOCTYPE module PUBLIC + `` -//Puppy Crawl//DTD Check Configuration 1.3//EN '' + `` http : //www.puppycrawl.com/dtds/configuration_1_3.dtd '' > + + < module name= '' Checker '' > + < ! -- module name= '' NewlineAtEndOfFile '' / -- > + < module name= '' FileLength '' / > + < module name= '' FileTabCharacter '' / > + + < ! -- Trailing spaces -- > + < module name= '' RegexpSingleline '' > + < property name= '' format '' value= '' \s+ $ '' / > + < property name= '' message '' value= '' Line has trailing spaces . `` / > + < /module > travis is n't useful yet __EoT__ As I see , there is n't any test in ` Matisse ` .So why do you use ` travis ` .
diff -- git a/matisse/src/main/res/values-pt-rBR/strings.xml b/matisse/src/main/res/values-pt-rBR/strings.xml new file mode 100644 index 0000000..1dd48e8 -- - /dev/null +++ b/matisse/src/main/res/values-pt-rBR/strings.xml @ @ -0,0 +1,35 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < ! -- + Copyright 2017 Zhihu Inc. + + Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + you may not use this file except in compliance with the License . + You may obtain a copy of the License at + + http : //www.apache.org/licenses/LICENSE-2.0 + + Unless required by applicable law or agreed to in writing , software + distributed under the License is distributed on an `` AS IS '' BASIS , + WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + See the License for the specific language governing permissions and + limitations under the License . + -- > + < resources > + < string name= '' album_name_all '' > Todas as mídias < /string > + + < string name= '' button_preview '' > Pré-visualizaçao < /string > + < string name= '' button_apply_disable '' > Aplicar < /string > + < string How to hide types that are not allowed from Matisse ? __EoT__ Hi guys , me again , I 've made a fork of this library because I had to make some minor changes in order to use it into one of my projects , some of them I 've already pull requested here , but the point is that I need to hide files that are not allowed by my application , for example , if I have ` Matisse.from ( this ) .choose ( MimeType.ofVideo ( ) , false ) ` I want to hide all the media that are n't video files , that 's an UX request from my development team , I 've tried to change the AlbumMediaAdapter by filtering and I have some success , but I still have white frames in the RecyclerView , I do n't get why , even trying to use ` notifyItemChanged ` or ` notifyDatasetChanged ` these gaps do n't move away . Do you know why or there 's a better way to achieve this ? These are the changes that I 've made so far , I know that 's not the best option doing this
diff -- git a/build.gradle b/build.gradle index 7de247b..6068a67 100644 -- - a/build.gradle +++ b/build.gradle @ @ -20,7 +20,7 @ @ buildscript { jcenter ( ) } dependencies { - classpath 'com.android.tools.build : gradle:2.3.2' + classpath 'com.android.tools.build : gradle:2.3.3' classpath 'com.novoda : bintray-release:0.4.0' } } diff -- git a/matisse/src/main/java/com/zhihu/matisse/SelectionCreator.java b/matisse/src/main/java/com/zhihu/matisse/SelectionCreator.java index 9b67fc3..1989f5a 100644 -- - a/matisse/src/main/java/com/zhihu/matisse/SelectionCreator.java +++ b/matisse/src/main/java/com/zhihu/matisse/SelectionCreator.java @ @ -140,6 +140,11 @ @ public final class SelectionCreator { return this ; } + public SelectionCreator restrictTypes ( boolean restrict ) { + mSelectionSpec.restrictTypes = restrict ; + return this ; + } + /** * Add filter to filter each selecting item . * diff -- git a/matisse/src/main/java/com/zhihu/matisse/internal/entity/SelectionSpec.java b/matisse/src/main/java/com/zhihu/matisse/internal/entity/SelectionSpec.java index cf4d793..a541eca 100644 -- - a/matisse/src/main/java/com/zhihu/matisse/internal/entity/SelectionSpec.java +++ b/matisse/src/main/java/com/zhihu/matisse/internal/entity/SelectionSpec.java @ @ -44,6 +44,7 @ @ public final class SelectionSpec { public int gridExpectedSize ; public float thumbnailScale ; public ImageEngine imageEngine ; + public boolean restrictTypes ; private SelectionSpec ( ) { } diff -- git a/matisse/src/main/java/com/zhihu/matisse/internal/loader/AlbumMediaLoader.java b/matisse/src/main/java/com/zhihu/matisse/internal/loader/AlbumMediaLoader.java index d5a4581..94aab10 100644 -- - a/matisse/src/main/java/com/zhihu/matisse/internal/loader/AlbumMediaLoader.java +++ b/matisse/src/main/java/com/zhihu/matisse/internal/loader/AlbumMediaLoader.java @ @ -24,30 +24,45 @ @ import android.net.Uri ; import android.provider.MediaStore ; import android.support.v4.content.CursorLoader ; +import com.zhihu.matisse.MimeType ; import com.zhihu.matisse.internal.entity.Album ; import com.zhihu.matisse.internal.entity.Item ; +import com.zhihu.matisse.internal.entity.SelectionSpec ; import com.zhihu.matisse.internal.utils.MediaStoreCompat ; /** * Load images and videos into How to hide types that are not allowed from Matisse ? __EoT__ Hi guys , me again , I 've made a fork of this library because I had to make some minor changes in order to use it into one of my projects , some of them I 've already pull requested here , but the point is that I need to hide files that are not allowed by my application , for example , if I have ` Matisse.from ( this ) .choose ( MimeType.ofVideo ( ) , false ) ` I want to hide all the media that are n't video files , that 's an UX request from my development team , I 've tried to change the AlbumMediaAdapter by filtering and I have some success , but I still have white frames in the RecyclerView , I do n't get why , even trying to use ` notifyItemChanged ` or ` notifyDatasetChanged ` these gaps do n't move away . Do you know why or there 's a better way to achieve this ? These are the changes that I 've made so far , I know that 's not the best option doing this
diff -- git a/.gitignore b/.gitignore index 0d4ee63..e5df7b9 100644 -- - a/.gitignore +++ b/.gitignore @ @ -38,4 +38,4 @ @ captures/ .idea/libraries # Keystore files -*.jks \ No newline at end of file +*.jks diff -- git a/.travis.yml b/.travis.yml index e4725cd..a334bab 100644 -- - a/.travis.yml +++ b/.travis.yml @ @ -6,7 +6,7 @ @ android : components : - tools - platform-tools - - build-tools-25.0.1 + - build-tools-25.0.2 - android-25 - extra-android-m2repository diff -- git a/CHANGELOG.md b/CHANGELOG.md index d9bc0ec..980148f 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -2,6 +2,12 @ @ ( or : y u no add shiny new things ? ! ) + # # # 2.2.0 + +* Ability to change icons when the tabs are selected , using drawable selectors +* Overriding tab selections is now supported , by using [ TabSelectionInterceptor ] ( https : //github.com/roughike/BottomBar/blob/master/bottom-bar/src/main/java/com/roughike/bottombar/TabSelectionInterceptor.java ) +* Internal code quality improvements and small changes + # # # 2.1.2 * Merged [ # 703 ] ( https : //github.com/roughike/BottomBar/pull/703 ) that allows controlling badge visibility for tabs that are active . diff -- git a/README.md b/README.md index 929f52a..5f31bf3 100644 -- - a/README.md +++ b/README.md @ @ -143,6 +143,49 @ @ bottomBar.setOnTabReselectListener ( new OnTabReselectListener ( ) showShadow is not working ! __EoT__ When I set app : bb_showShadow= '' false '' , the shadow is visible ! and it 's not hidden . Please fix it . Thanks
diff -- git a/app/src/main/java/io/plaidapp/ui/HomeActivity.java b/app/src/main/java/io/plaidapp/ui/HomeActivity.java index fbbdcd9..1858b74 100644 -- - a/app/src/main/java/io/plaidapp/ui/HomeActivity.java +++ b/app/src/main/java/io/plaidapp/ui/HomeActivity.java @ @ -69,42 +69,37 @ @ import android.widget.Toolbar ; import com.bumptech.glide.integration.recyclerview.RecyclerViewPreloader ; import com.bumptech.glide.util.ViewPreloadSizeProvider ; -import java.security.InvalidParameterException ; import java.util.ArrayList ; import java.util.Collections ; import java.util.List ; import io.plaidapp.R ; -import io.plaidapp.base.ui.FeedAdapter ; -import io.plaidapp.base.ui.FilterAdapter ; -import io.plaidapp.base.ui.HomeGridItemAnimator ; -import io.plaidapp.base.util.ActivityHelper ; import io.plaidapp.base.data.DataManager ; import io.plaidapp.base.data.PlaidItem ; import io.plaidapp.base.data.Source ; -import io.plaidapp.base.util.DrawableUtils ; -import io.plaidapp.base.designernews.data.api.PostStoryService ; -import io.plaidapp.base.designernews.data.api.model.Story ; import io.plaidapp.base.data.api.dribbble.model.Shot ; import io.plaidapp.base.data.pocket.PocketUtils ; -import io.plaidapp.base.designernews.DesignerNewsPrefs ; import io.plaidapp.base.data.prefs.DribbblePrefs ; import io.plaidapp.base.data.prefs.SourceManager ; -import io.plaidapp.ui.recyclerview.FilterTouchHelperCallback ; -import io.plaidapp.ui.recyclerview.GridItemDividerDecoration ; +import io.plaidapp.base.designernews.DesignerNewsPrefs ; +import io.plaidapp.base.designernews.data.api.PostStoryService ; +import io.plaidapp.base.designernews.data.api.model.Story ; +import io.plaidapp.base.ui.FeedAdapter ; +import io.plaidapp.base.ui.FilterAdapter ; +import io.plaidapp.base.ui.HomeGridItemAnimator ; import io.plaidapp.base.ui.recyclerview.InfiniteScrollListener ; -import io.plaidapp.ui.transitions.FabTransform ; -import io.plaidapp.ui.transitions.MorphTransform ; import io.plaidapp.base.util.Activities ; +import io.plaidapp.base.util.ActivityHelper ; import io.plaidapp.base.util.AnimUtils ; +import io.plaidapp.base.util.DrawableUtils ; import io.plaidapp.base.util.ViewUtils ; +import io.plaidapp.ui.recyclerview.FilterTouchHelperCallback ; +import io.plaidapp.ui.recyclerview.GridItemDividerDecoration ; +import io.plaidapp.ui.transitions.FabTransform ; public class HomeActivity extends Activity { private static final int RC_SEARCH = 0 ; - private static final int RC_AUTH_DRIBBBLE_FOLLOWING = 1 ; - private static final int RC_AUTH_DRIBBBLE_USER_LIKES = 2 ; - private static final int RC_AUTH_DRIBBBLE_USER_SHOTS = 3 ; private static final int RC_NEW_DESIGNER_NEWS_STORY = 4 ; private static final int RC_NEW_DESIGNER_NEWS_LOGIN = [ CI ] Code formatting __EoT__ PRs are getting noisey due to formatting differences . We should check in a formatter and run over the entire project .
diff -- git a/app/src/main/java/io/plaidapp/ui/HomeActivity.java b/app/src/main/java/io/plaidapp/ui/HomeActivity.java index fbbdcd9..e023c02 100644 -- - a/app/src/main/java/io/plaidapp/ui/HomeActivity.java +++ b/app/src/main/java/io/plaidapp/ui/HomeActivity.java @ @ -69,42 +69,36 @ @ import android.widget.Toolbar ; import com.bumptech.glide.integration.recyclerview.RecyclerViewPreloader ; import com.bumptech.glide.util.ViewPreloadSizeProvider ; -import java.security.InvalidParameterException ; import java.util.ArrayList ; import java.util.Collections ; import java.util.List ; import io.plaidapp.R ; -import io.plaidapp.base.ui.FeedAdapter ; -import io.plaidapp.base.ui.FilterAdapter ; -import io.plaidapp.base.ui.HomeGridItemAnimator ; -import io.plaidapp.base.util.ActivityHelper ; import io.plaidapp.base.data.DataManager ; import io.plaidapp.base.data.PlaidItem ; import io.plaidapp.base.data.Source ; -import io.plaidapp.base.util.DrawableUtils ; -import io.plaidapp.base.designernews.data.api.PostStoryService ; -import io.plaidapp.base.designernews.data.api.model.Story ; import io.plaidapp.base.data.api.dribbble.model.Shot ; import io.plaidapp.base.data.pocket.PocketUtils ; -import io.plaidapp.base.designernews.DesignerNewsPrefs ; -import io.plaidapp.base.data.prefs.DribbblePrefs ; import io.plaidapp.base.data.prefs.SourceManager ; -import io.plaidapp.ui.recyclerview.FilterTouchHelperCallback ; -import io.plaidapp.ui.recyclerview.GridItemDividerDecoration ; +import io.plaidapp.base.designernews.DesignerNewsPrefs ; +import io.plaidapp.base.designernews.data.api.PostStoryService ; +import io.plaidapp.base.designernews.data.api.model.Story ; +import io.plaidapp.base.ui.FeedAdapter ; +import io.plaidapp.base.ui.FilterAdapter ; +import io.plaidapp.base.ui.HomeGridItemAnimator ; import io.plaidapp.base.ui.recyclerview.InfiniteScrollListener ; -import io.plaidapp.ui.transitions.FabTransform ; -import io.plaidapp.ui.transitions.MorphTransform ; import io.plaidapp.base.util.Activities ; +import io.plaidapp.base.util.ActivityHelper ; import io.plaidapp.base.util.AnimUtils ; +import io.plaidapp.base.util.DrawableUtils ; import io.plaidapp.base.util.ViewUtils ; +import io.plaidapp.ui.recyclerview.FilterTouchHelperCallback ; +import io.plaidapp.ui.recyclerview.GridItemDividerDecoration ; +import io.plaidapp.ui.transitions.FabTransform ; public class HomeActivity extends Activity { private static final int RC_SEARCH = 0 ; - private static final int RC_AUTH_DRIBBBLE_FOLLOWING = 1 ; - private static final int RC_AUTH_DRIBBBLE_USER_LIKES = 2 ; - private static final int RC_AUTH_DRIBBBLE_USER_SHOTS = 3 ; private static final int RC_NEW_DESIGNER_NEWS_STORY = 4 ; private static final int RC_NEW_DESIGNER_NEWS_LOGIN = [ CI ] Code formatting __EoT__ PRs are getting noisey due to formatting differences . We should check in a formatter and run over the entire project .
diff -- git a/app/src/main/java/io/plaidapp/ui/HomeActivity.java b/app/src/main/java/io/plaidapp/ui/HomeActivity.java index fbbdcd9..e023c02 100644 -- - a/app/src/main/java/io/plaidapp/ui/HomeActivity.java +++ b/app/src/main/java/io/plaidapp/ui/HomeActivity.java @ @ -69,42 +69,36 @ @ import android.widget.Toolbar ; import com.bumptech.glide.integration.recyclerview.RecyclerViewPreloader ; import com.bumptech.glide.util.ViewPreloadSizeProvider ; -import java.security.InvalidParameterException ; import java.util.ArrayList ; import java.util.Collections ; import java.util.List ; import io.plaidapp.R ; -import io.plaidapp.base.ui.FeedAdapter ; -import io.plaidapp.base.ui.FilterAdapter ; -import io.plaidapp.base.ui.HomeGridItemAnimator ; -import io.plaidapp.base.util.ActivityHelper ; import io.plaidapp.base.data.DataManager ; import io.plaidapp.base.data.PlaidItem ; import io.plaidapp.base.data.Source ; -import io.plaidapp.base.util.DrawableUtils ; -import io.plaidapp.base.designernews.data.api.PostStoryService ; -import io.plaidapp.base.designernews.data.api.model.Story ; import io.plaidapp.base.data.api.dribbble.model.Shot ; import io.plaidapp.base.data.pocket.PocketUtils ; -import io.plaidapp.base.designernews.DesignerNewsPrefs ; -import io.plaidapp.base.data.prefs.DribbblePrefs ; import io.plaidapp.base.data.prefs.SourceManager ; -import io.plaidapp.ui.recyclerview.FilterTouchHelperCallback ; -import io.plaidapp.ui.recyclerview.GridItemDividerDecoration ; +import io.plaidapp.base.designernews.DesignerNewsPrefs ; +import io.plaidapp.base.designernews.data.api.PostStoryService ; +import io.plaidapp.base.designernews.data.api.model.Story ; +import io.plaidapp.base.ui.FeedAdapter ; +import io.plaidapp.base.ui.FilterAdapter ; +import io.plaidapp.base.ui.HomeGridItemAnimator ; import io.plaidapp.base.ui.recyclerview.InfiniteScrollListener ; -import io.plaidapp.ui.transitions.FabTransform ; -import io.plaidapp.ui.transitions.MorphTransform ; import io.plaidapp.base.util.Activities ; +import io.plaidapp.base.util.ActivityHelper ; import io.plaidapp.base.util.AnimUtils ; +import io.plaidapp.base.util.DrawableUtils ; import io.plaidapp.base.util.ViewUtils ; +import io.plaidapp.ui.recyclerview.FilterTouchHelperCallback ; +import io.plaidapp.ui.recyclerview.GridItemDividerDecoration ; +import io.plaidapp.ui.transitions.FabTransform ; public class HomeActivity extends Activity { private static final int RC_SEARCH = 0 ; - private static final int RC_AUTH_DRIBBBLE_FOLLOWING = 1 ; - private static final int RC_AUTH_DRIBBBLE_USER_LIKES = 2 ; - private static final int RC_AUTH_DRIBBBLE_USER_SHOTS = 3 ; private static final int RC_NEW_DESIGNER_NEWS_STORY = 4 ; private static final int RC_NEW_DESIGNER_NEWS_LOGIN = [ CI ] Code formatting __EoT__ PRs are getting noisey due to formatting differences . We should check in a formatter and run over the entire project .
diff -- git a/app/src/main/java/io/plaidapp/ui/DribbbleShot.java b/app/src/main/java/io/plaidapp/ui/DribbbleShot.java index 6dcd411..0bf2dea 100644 -- - a/app/src/main/java/io/plaidapp/ui/DribbbleShot.java +++ b/app/src/main/java/io/plaidapp/ui/DribbbleShot.java @ @ -710,6 +710,15 @ @ public class DribbbleShot extends Activity { enterComment = ( EditText ) commentFooter.findViewById ( R.id.comment ) ; postComment = ( ImageButton ) commentFooter.findViewById ( R.id.post_comment ) ; enterComment.setOnFocusChangeListener ( enterCommentFocus ) ; + enterComment.setOnTouchListener ( new View.OnTouchListener ( ) { + @ Override + public boolean onTouch ( View view , MotionEvent motionEvent ) { + if ( enterComment.isFocusable ( ) ) return false ; + enterComment.setFocusableInTouchMode ( true ) ; + enterComment.setFocusable ( true ) ; + return false ; + } + } ) ; } else if ( ! allowComment & & commentFooter ! = null ) { adapter.removeCommentingFooter ( ) ; commentFooter = null ; diff -- git a/app/src/main/res/layout/dribbble_enter_comment.xml b/app/src/main/res/layout/dribbble_enter_comment.xml index a4779ec..0a2c50a 100644 -- - a/app/src/main/res/layout/dribbble_enter_comment.xml +++ b/app/src/main/res/layout/dribbble_enter_comment.xml @ @ -52,6 +52,7 @ @ android : layout_weight= '' 1 '' android : inputType= '' textCapSentences '' android : textSize= '' 16sp '' + android : focusable= '' false '' android : textColor= '' @ color/text_primary_dark '' / > < /android.support.design.widget.TextInputLayout > Layout issues when keyboard is shown __EoT__ If one opens a post , and the comment is automatically focused , making the keyboard appears , the layout gets `` broken '' and the position of items too . Issue seems to persist even after keyboard is hidden ... **Screenshots : ** ! [ cxlf7qjwiaawct0 ] ( https : //cloud.githubusercontent.com/assets/10360816/20307275/b5aceb6c-ab0c-11e6-8dc3-5b100f7f2a0d.jpg ) ! [ screenshot_20161115-081142 ] ( https : //cloud.githubusercontent.com/assets/10360816/20307276/b5afc3fa-ab0c-11e6-8cc8-5d21fc61f667.png ) ! [ screenshot_20161115-081148 ] ( https : //cloud.githubusercontent.com/assets/10360816/20307277/b5b441d2-ab0c-11e6-961a-cba002c4255e.png )
diff -- git a/app/src/main/java/io/plaidapp/ui/DribbbleShot.java b/app/src/main/java/io/plaidapp/ui/DribbbleShot.java index 6dcd411..0bf2dea 100644 -- - a/app/src/main/java/io/plaidapp/ui/DribbbleShot.java +++ b/app/src/main/java/io/plaidapp/ui/DribbbleShot.java @ @ -710,6 +710,15 @ @ public class DribbbleShot extends Activity { enterComment = ( EditText ) commentFooter.findViewById ( R.id.comment ) ; postComment = ( ImageButton ) commentFooter.findViewById ( R.id.post_comment ) ; enterComment.setOnFocusChangeListener ( enterCommentFocus ) ; + enterComment.setOnTouchListener ( new View.OnTouchListener ( ) { + @ Override + public boolean onTouch ( View view , MotionEvent motionEvent ) { + if ( enterComment.isFocusable ( ) ) return false ; + enterComment.setFocusableInTouchMode ( true ) ; + enterComment.setFocusable ( true ) ; + return false ; + } + } ) ; } else if ( ! allowComment & & commentFooter ! = null ) { adapter.removeCommentingFooter ( ) ; commentFooter = null ; diff -- git a/app/src/main/java/io/plaidapp/ui/PlayerActivity.java b/app/src/main/java/io/plaidapp/ui/PlayerActivity.java index b33afab..bcfd356 100644 -- - a/app/src/main/java/io/plaidapp/ui/PlayerActivity.java +++ b/app/src/main/java/io/plaidapp/ui/PlayerActivity.java @ @ -348,6 +348,9 @ @ public class PlayerActivity extends Activity { @ OnClick ( { R.id.shot_count , R.id.followers_count , R.id.likes_count } ) void playerActionClick ( TextView view ) { ( ( AnimatedVectorDrawable ) view.getCompoundDrawables ( ) [ 1 ] ) .start ( ) ; + + if ( followerCount < 1 ) return ; + switch ( view.getId ( Layout issues when keyboard is shown __EoT__ If one opens a post , and the comment is automatically focused , making the keyboard appears , the layout gets `` broken '' and the position of items too . Issue seems to persist even after keyboard is hidden ... **Screenshots : ** ! [ cxlf7qjwiaawct0 ] ( https : //cloud.githubusercontent.com/assets/10360816/20307275/b5aceb6c-ab0c-11e6-8dc3-5b100f7f2a0d.jpg ) ! [ screenshot_20161115-081142 ] ( https : //cloud.githubusercontent.com/assets/10360816/20307276/b5afc3fa-ab0c-11e6-8cc8-5d21fc61f667.png ) ! [ screenshot_20161115-081148 ] ( https : //cloud.githubusercontent.com/assets/10360816/20307277/b5b441d2-ab0c-11e6-961a-cba002c4255e.png )
diff -- git a/build.gradle b/build.gradle index 8363c9a..350600b 100644 -- - a/build.gradle +++ b/build.gradle @ @ -53,7 +53,7 @ @ buildscript { } dependencies { - classpath 'com.android.tools.build : gradle:3.3.0-alpha02' + classpath 'com.android.tools.build : gradle:3.3.0-alpha03' classpath `` org.jetbrains.kotlin : kotlin-gradle-plugin : $ { versions.kotlin } '' classpath `` com.google.gms : google-services : $ { versions.googleServices } '' classpath `` io.fabric.tools : gradle : $ { versions.fabric } '' Unhealthy in LoginViewModelTest __EoT__ Something not good in this test , please check , i.e not related tickets like # 491 , # 492 can not go through . 😢 . `` ` loginDataChanged_withValidLogin : java.lang.AssertionError : expected : < true > but was : < false > at org.junit.Assert.fail ( Assert.java:88 ) at org.junit.Assert.failNotEquals ( Assert.java:834 ) at org.junit.Assert.assertEquals ( Assert.java:118 ) at org.junit.Assert.assertEquals ( Assert.java:144 ) at io.plaidapp.designernews.ui.login.LoginViewModelTest $ loginDataChanged_withValidLogin $ 1.doResume ( LoginViewModelTest.kt:139 ) at kotlin.coroutines.experimental.jvm.internal.CoroutineImpl.resume ( CoroutineImpl.kt:42 ) at kotlinx.coroutines.experimental.DispatchedTask $ DefaultImpls.run ( Dispatched.kt:161 ) at kotlinx.coroutines.experimental.DispatchedContinuation.run ( Dispatched.kt:25 ) at kotlinx.coroutines.experimental.EventLoopBase.processNextEvent ( EventLoop.kt:147 ) at kotlinx.coroutines.experimental.BlockingCoroutine.joinBlocking ( Builders.kt:244 ) at kotlinx.coroutines.experimental.BuildersKt.runBlocking ( Builders.kt:185 ) at kotlinx.coroutines.experimental.BuildersKt.runBlocking $ default ( Builders.kt:175 ) at io.plaidapp.designernews.ui.login.LoginViewModelTest.loginDataChanged_withValidLogin ( LoginViewModelTest.kt:120 ) at sun.reflect.NativeMethodAccessorImpl.invoke0 ( Native Method ) at sun.reflect.NativeMethodAccessorImpl.invoke ( NativeMethodAccessorImpl.java:62 ) at sun.reflect.DelegatingMethodAccessorImpl.invoke ( DelegatingMethodAccessorImpl.java:43 ) at java.lang.reflect.Method.invoke ( Method.java:498 ) at org.junit.runners.model.FrameworkMethod $ 1.runReflectiveCall ( FrameworkMethod.java:50 ) at org.junit.internal.runners.model.ReflectiveCallable.run ( ReflectiveCallable.java:12 ) at org.junit.runners.model.FrameworkMethod.invokeExplosively ( FrameworkMethod.java:47 ) at org.junit.internal.runners.statements.InvokeMethod.evaluate ( InvokeMethod.java:17 ) at org.junit.rules.TestWatcher $ 1.evaluate ( TestWatcher.java:55 ) at org.junit.rules.RunRules.evaluate ( RunRules.java:20 ) at org.junit.runners.ParentRunner.runLeaf ( ParentRunner.java:325 ) at org.junit.runners.BlockJUnit4ClassRunner.runChild ( BlockJUnit4ClassRunner.java:78 ) at org.junit.runners.BlockJUnit4ClassRunner.runChild ( BlockJUnit4ClassRunner.java:57 ) at org.junit.runners.ParentRunner $ 3.run ( ParentRunner.java:290 ) at org.junit.runners.ParentRunner
diff -- git a/Dockerfile b/Dockerfile index 75c1f37..c449d8a 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -23,7 +23,7 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ build-essential \ openjdk-8-jdk-headless \ libc6 : i386 libstdc++6 : i386 libgcc1 : i386 libncurses5 : i386 libz1 : i386 \ - s3cmd \ + s3cmd nodejs\ & & apt-get clean # Install the Android SDK diff -- git a/Jenkinsfile b/Jenkinsfile index 65bb3bd..27e6295 100644 -- - a/Jenkinsfile +++ b/Jenkinsfile @ @ -12,9 +12,20 @ @ try { // Make sure not to delete the folder that Jenkins allocates to store scripts sh 'git clean -ffdx -e . ? ? ? ? ? ? ? ? ' + stage 'Collect info' + def dependencies = readProperties file : 'dependencies.list' + def syncVersion = dependencies.REALM_SYNC_VERSION + echo `` Sync Version : $ { syncVersion } '' + def currentDir = pwd ( ) + stage 'Docker build' def buildEnv = docker.build 'realm-java : snapshot' buildEnv.inside ( `` -- privileged -v /dev/bus/usb : /dev/bus/usb -v $ { env.HOME } /gradle-cache : /root/.gradle -v /root/adbkeys : /root/.android '' ) { + withCredentials ( [ [ $ class : 'FileBinding ' , credentialsId : 'c0cc8f9e-c3f1-4e22-b22f-6568392e26ae ' , variable : 'S3CFG Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/CHANGELOG.md b/CHANGELOG.md index bacad0d..1b60363 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -47,6 +47,7 @ @ # # # Internal * Updated Realm Core to 1.4.2 . +* Improved sorting speed . # # 1.1.0 diff -- git a/examples/objectServerExample/build.gradle b/examples/objectServerExample/build.gradle new file mode 100644 index 0000000..c102599 -- - /dev/null +++ b/examples/objectServerExample/build.gradle @ @ -0,0 +1,30 @ @ +apply plugin : 'com.android.application' +apply plugin : 'android-command' +apply plugin : 'com.neenbedankt.android-apt' +apply plugin : 'realm-android' + +android { + compileSdkVersion rootProject.sdkVersion + buildToolsVersion rootProject.buildTools + + defaultConfig { + applicationId 'io.realm.examples.objectserver' + targetSdkVersion rootProject.sdkVersion + minSdkVersion 15 + versionCode 1 + versionName `` 1.0 '' + } + + buildTypes { + release { + minifyEnabled false + } + } + + productFlavors { + } + + command { + events 2000 + } + } diff -- git a/examples/objectServerExample/lint.xml b/examples/objectServerExample/lint.xml new file mode 100644 index 0000000..3af2534 -- - /dev/null +++ b/examples/objectServerExample/lint.xml @ @ -0,0 +1,9 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < lint > + < ! -- Disable the given check in this project -- > + < issue id= '' AllowBackup '' severity= Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/CHANGELOG.md b/CHANGELOG.md index bacad0d..1b60363 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -47,6 +47,7 @ @ # # # Internal * Updated Realm Core to 1.4.2 . +* Improved sorting speed . # # 1.1.0 diff -- git a/examples/build.gradle b/examples/build.gradle index 47be4e4..744b9f3 100644 -- - a/examples/build.gradle +++ b/examples/build.gradle @ @ -16,7 +16,7 @ @ allprojects { maven { url 'https : //jitpack.io ' } } dependencies { - classpath 'com.android.tools.build : gradle:2.1.0' + classpath 'com.android.tools.build : gradle:2.1.3' classpath 'com.jfrog.bintray.gradle : gradle-bintray-plugin:1.6' classpath 'com.github.JakeWharton : sdk-manager-plugin:0ce4cdf08009d79223850a59959d9d6e774d0f77' classpath 'com.novoda : gradle-android-command-plugin:1.5.0' diff -- git a/examples/gradle/wrapper/gradle-wrapper.properties b/examples/gradle/wrapper/gradle-wrapper.properties index 4f6e35c..63bd740 100644 -- - a/examples/gradle/wrapper/gradle-wrapper.properties +++ b/examples/gradle/wrapper/gradle-wrapper.properties @ @ -1,6 +1,6 @ @ - # Tue Jan 05 14:18:17 CET 2016 + # Tue Aug 23 09:07:37 CEST 2016 distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists zipStoreBase=GRADLE_USER_HOME zipStorePath=wrapper/dists -distributionUrl=https\ : //services.gradle.org/distributions/gradle-2.14-all.zip +distributionUrl=https\ : //services.gradle.org/distributions/gradle-2.14.1-all.zip diff -- git a/examples/objectServerExample/build.gradle b/examples/objectServerExample/build.gradle new file mode 100644 index 0000000..c102599 -- - /dev/null +++ b/examples/objectServerExample/build.gradle @ @ -0,0 +1,30 @ @ +apply plugin : 'com.android.application' +apply plugin : 'android-command' +apply plugin : 'com.neenbedankt.android-apt' +apply plugin : 'realm-android' + +android { + compileSdkVersion rootProject.sdkVersion + buildToolsVersion rootProject.buildTools + + defaultConfig { + applicationId 'io.realm.examples.objectserver' + targetSdkVersion rootProject.sdkVersion + minSdkVersion 15 + versionCode 1 Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/.gitmodules b/.gitmodules index 35b419c..4e9399a 100644 -- - a/.gitmodules +++ b/.gitmodules @ @ -1,3 +1,3 @ @ [ submodule `` realm/realm-library/src/main/cpp/object-store '' ] path = realm/realm-library/src/main/cpp/object-store - url = https : //github.com/realm/realm-object-store.git + url = git @ github.com : realm/realm-object-store-private.git diff -- git a/Jenkinsfile b/Jenkinsfile index e00abd5..8adcc47 100644 -- - a/Jenkinsfile +++ b/Jenkinsfile @ @ -8,11 +8,19 @ @ try { // Allocate a custom workspace to avoid having % in the path ( it breaks ld ) ws ( '/tmp/realm-java ' ) { stage 'SCM' - checkout scm + checkout ( [ + $ class : 'GitSCM ' , + branches : scm.branches , + gitTool : 'native git ' , + extensions : scm.extensions + [ [ $ class : 'CleanCheckout ' ] ] , + userRemoteConfigs : scm.userRemoteConfigs + ] ) + sshagent ( [ 'realm-ci-ssh ' ] ) { + sh 'git submodule sync' + sh 'git submodule update -- init -- recursive' + } // Make sure not to delete the folder that Jenkins allocates to store scripts sh 'git clean -ffdx -e . ? ? ? ? ? ? ? ? ' - // Update submodule for object-store - sh 'git submodule Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/.gitmodules b/.gitmodules index 35b419c..e16913a 100644 -- - a/.gitmodules +++ b/.gitmodules @ @ -1,3 +1,3 @ @ [ submodule `` realm/realm-library/src/main/cpp/object-store '' ] path = realm/realm-library/src/main/cpp/object-store - url = https : //github.com/realm/realm-object-store.git + url = https : //github.com/realm/realm-object-store-private.git diff -- git a/CHANGELOG.md b/CHANGELOG.md index 678e476..2a1a946 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -67,6 +67,7 @ @ # # # Internal * Updated Realm Core to 1.4.2 . +* Improved sorting speed . # # 1.1.0 diff -- git a/Jenkinsfile b/Jenkinsfile index e00abd5..32ff155 100644 -- - a/Jenkinsfile +++ b/Jenkinsfile @ @ -8,11 +8,19 @ @ try { // Allocate a custom workspace to avoid having % in the path ( it breaks ld ) ws ( '/tmp/realm-java ' ) { stage 'SCM' - checkout scm + checkout ( [ + $ class : 'GitSCM ' , + branches : scm.branches , + gitTool : 'native git ' , + extensions : scm.extensions + [ [ $ class : 'CleanCheckout ' ] ] , + userRemoteConfigs : scm.userRemoteConfigs + ] ) + sshagent ( [ 'realm-ci-ssh ' ] ) { + sh 'git submodule sync' + sh 'git submodule update -- init -- recursive' + } // Make sure Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 79f3595..9da928f 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -74,6 +74,7 @ @ # # # Internal * Updated Realm Core to 1.4.2 . +* Improved sorting speed . # # 1.1.0 diff -- git a/Jenkinsfile b/Jenkinsfile index 8adcc47..32ff155 100644 -- - a/Jenkinsfile +++ b/Jenkinsfile @ @ -43,11 +43,11 @ @ try { publishHTML ( target : [ allowMissing : false , alwaysLinkToLastBuild : false , keepAll : true , reportDir : 'realm/realm-library/build/findbugs ' , reportFiles : 'findbugs-output.html ' , reportName : 'Findbugs issues ' ] ) publishHTML ( target : [ allowMissing : false , alwaysLinkToLastBuild : false , keepAll : true , reportDir : 'realm/realm-library/build/reports/pmd ' , reportFiles : 'pmd.html ' , reportName : 'PMD Issues ' ] ) step ( [ $ class : 'CheckStylePublisher ' , - canComputeNew : false , - defaultEncoding : `` , - healthy : `` , - pattern : 'realm/realm-library/build/reports/checkstyle/checkstyle.xml ' , - unHealthy : `` + canComputeNew : false , + defaultEncoding : `` , + healthy : `` , + pattern : 'realm/realm-library/build/reports/checkstyle/checkstyle.xml ' , + unHealthy : `` ] ) } @ @ -88,13 +88,13 @ @ try { node { withCredentials Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/.gitignore b/.gitignore index 22df2e0..28e1d01 100644 -- - a/.gitignore +++ b/.gitignore @ @ -6,7 +6,7 @ @ realm/build .gradle # Gradle local properties -local.properties + # local.properties # Core core diff -- git a/CHANGELOG.md b/CHANGELOG.md index 79f3595..9da928f 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -74,6 +74,7 @ @ # # # Internal * Updated Realm Core to 1.4.2 . +* Improved sorting speed . # # 1.1.0 diff -- git a/Dockerfile b/Dockerfile index b607664..8d44753 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -8,9 +8,9 @ @ ENV LC_ALL `` en_US.UTF-8 '' # Set the environment variables ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 -ENV ANDROID_HOME /opt/android-sdk-linux - # Need by cmake -ENV ANDROID_NDK_HOME /opt/android-ndk +ENV ANDROID_HOME /tmp/opt/android-sdk-linux +ENV NDK_HOME /tmp/opt/android-ndk +ENV ANDROID_NDK_HOME /tmp/opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -24,11 +24,14 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ build-essential \ openjdk-8-jdk-headless \ libc6 : i386 libstdc++6 : i386 libgcc1 : i386 libncurses5 : i386 libz1 : i386 \ - s3cmd \ + s3cmd nodejs libconfig++9v5\ & & apt-get clean + # Install writable dir Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 79f3595..9da928f 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -74,6 +74,7 @ @ # # # Internal * Updated Realm Core to 1.4.2 . +* Improved sorting speed . # # 1.1.0 diff -- git a/examples/build.gradle b/examples/build.gradle index 47be4e4..c7ab4ca 100644 -- - a/examples/build.gradle +++ b/examples/build.gradle @ @ -16,7 +16,7 @ @ allprojects { maven { url 'https : //jitpack.io ' } } dependencies { - classpath 'com.android.tools.build : gradle:2.1.0' + classpath 'com.android.tools.build : gradle:2.2.0-rc1' classpath 'com.jfrog.bintray.gradle : gradle-bintray-plugin:1.6' classpath 'com.github.JakeWharton : sdk-manager-plugin:0ce4cdf08009d79223850a59959d9d6e774d0f77' classpath 'com.novoda : gradle-android-command-plugin:1.5.0' diff -- git a/examples/encryptionExample/lint.xml b/examples/encryptionExample/lint.xml index 0666c54..6793b07 100644 -- - a/examples/encryptionExample/lint.xml +++ b/examples/encryptionExample/lint.xml @ @ -6,4 +6,5 @ @ < issue id= '' TrulyRandom '' severity= '' ignore '' / > < issue id= '' PrngFix '' severity= '' ignore '' / > < issue id= '' LogNotTimber '' severity= '' ignore '' / > + < issue id= '' InvalidPackage '' severity= '' ignore '' / > < /lint > diff -- git a/examples/gradle.properties b/examples/gradle.properties new file mode 100644 index 0000000..4a9594a -- - /dev/null +++ b/examples/gradle.properties @ @ -0,0 +1 @ @ +org.gradle.jvmargs=-Xmx2048M \ No newline at end of file diff -- git a/examples/gradle/wrapper/gradle-wrapper.properties b/examples/gradle/wrapper/gradle-wrapper.properties index 4f6e35c..63bd740 Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/Dockerfile b/Dockerfile index b607664..fc5f1e8 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -60,3 +60,14 @ @ RUN mkdir /opt/cmake-tmp & & \ # Make the SDK universally readable RUN chmod -R a+rX $ { ANDROID_HOME } + + # # # # Install Testing Realm Object Server + # Add realm repo +RUN apt-get update -qq \ + & & apt-get install -y curl npm \ + & & curl -s https : //packagecloud.io/install/repositories/realm/realm/script.deb.sh | bash \ + & & npm install winston temp httpdispatcher +COPY tools/sync_test_server/keys/private.pem keys/public.pem / +COPY tools/sync_test_server/ros-testing-server /usr/bin/ + # Install realm object server +RUN apt-get install -y realm-object-server-de=1.0.0-beta-18.0-203 diff -- git a/Jenkinsfile b/Jenkinsfile index 03c31f7..24abc74 100644 -- - a/Jenkinsfile +++ b/Jenkinsfile @ @ -53,13 +53,14 @ @ try { stage 'Run instrumented tests' boolean archiveLog = true - String backgroundPid + String backgroundPids = [ ] try { - backgroundPid = startLogCatCollector ( ) + backgroundPid.add ( startLogCatCollector ( ) ) + backgroundPid.add ( startSyncTestingServer ( ) ) gradle ( 'realm ' , 'connectedUnitTests ' ) archiveLog = false ; } finally { - stopLogCatCollector ( backgroundPid , archiveLog ) + stopBgProcAndSaveLog ( backgroundPid , archiveLog ) storeJunitResults 'realm/realm-library/build/outputs/androidTest-results/connected/**/TEST-*.xml' } @ @ Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/Dockerfile b/Dockerfile index b607664..112a9b9 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -60,3 +60,14 @ @ RUN mkdir /opt/cmake-tmp & & \ # Make the SDK universally readable RUN chmod -R a+rX $ { ANDROID_HOME } + + # # # # Install Testing Realm Object Server + # Add realm repo +RUN apt-get update -qq \ + & & apt-get install -y curl npm \ + & & curl -s https : //packagecloud.io/install/repositories/realm/realm/script.deb.sh | bash \ + & & npm install winston temp httpdispatcher +COPY tools/sync_test_server/keys/private.pem tools/sync_test_server/keys/public.pem / +COPY tools/sync_test_server/ros-testing-server /usr/bin/ + # Install realm object server +RUN apt-get install -y realm-object-server-de=1.0.0-beta-18.0-203 diff -- git a/Jenkinsfile b/Jenkinsfile index c54298a..5910d68 100644 -- - a/Jenkinsfile +++ b/Jenkinsfile @ @ -53,13 +53,14 @ @ try { stage 'Run instrumented tests' boolean archiveLog = true - String backgroundPid + String backgroundPids = [ ] try { - backgroundPid = startLogCatCollector ( ) + backgroundPids.add ( startLogCatCollector ( ) ) + backgroundPids.add ( startSyncTestingServer ( ) ) gradle ( 'realm ' , 'connectedUnitTests ' ) archiveLog = false ; } finally { - stopLogCatCollector ( backgroundPid , archiveLog ) + stopBgProcAndSaveLog ( backgroundPids , archiveLog ) storeJunitResults 'realm/realm-library/build/outputs/androidTest-results/connected/**/TEST-*.xml' } @ @ Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/Dockerfile b/Dockerfile index a632ba6..d30d407 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -71,3 +71,15 @ @ RUN mkdir /opt/cmake-tmp & & \ # Make the SDK universally readable RUN chmod -R a+rX $ { ANDROID_HOME } + + # # # # Install Testing Realm Object Server + # Add realm repo +RUN apt-get update -qq \ + & & apt-get install -y curl npm \ + & & curl -s https : //packagecloud.io/install/repositories/realm/realm/script.deb.sh | bash \ + & & npm install winston temp httpdispatcher +COPY tools/sync_test_server/keys/private.pem tools/sync_test_server/keys/public.pem tools/sync_test_server/configuration.yml / +COPY tools/sync_test_server/ros-testing-server.js /usr/bin/ + # Install realm object server +RUN apt-get update -qq \ + & & apt-get install -y realm-object-server-de=1.0.0-BETA-2.1-271 diff -- git a/Jenkinsfile b/Jenkinsfile index 5c3dfe4..e3631ae 100644 -- - a/Jenkinsfile +++ b/Jenkinsfile @ @ -55,17 +55,17 @ @ try { } } - stage ( 'Run instrumented tests ' ) { - boolean archiveLog = true - String backgroundPid - try { - backgroundPid = startLogCatCollector ( ) - gradle ( 'realm ' , 'connectedUnitTests ' ) - archiveLog = false ; - } finally { - stopLogCatCollector ( backgroundPid , archiveLog ) - storeJunitResults 'realm/realm-library/build/outputs/androidTest-results/connected/**/TEST-*.xml' - } + stage 'Run instrumented tests' + boolean Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/Jenkinsfile b/Jenkinsfile index 5c3dfe4..9681871 100644 -- - a/Jenkinsfile +++ b/Jenkinsfile @ @ -3,6 +3,7 @ @ import groovy.json.JsonOutput def buildSuccess = false +def rosContainer try { node ( 'android ' ) { // Allocate a custom workspace to avoid having % in the path ( it breaks ld ) @ @ -22,11 +23,27 @ @ try { } def buildEnv + def rosEnv stage ( 'Docker build ' ) { + // Docker image for build buildEnv = docker.build 'realm-java : snapshot' + // Docker image for testing Realm Object Server + def dependProperties = readProperties file : 'dependencies.list' + def rosDeVersion = dependProperties [ `` REALM_OBJECT_SERVER_DE_VERSION '' ] + rosEnv = docker.build 'ros : snapshot ' , `` -- build-arg ROS_DE_VERSION= $ { rosDeVersion } tools/sync_test_server '' } - buildEnv.inside ( `` -e HOME=/tmp -e _JAVA_OPTIONS=-Duser.home=/tmp -- privileged -v /dev/bus/usb : /dev/bus/usb -v $ { env.HOME } /gradle-cache : /tmp/.gradle -v $ { env.HOME } /.android : /tmp/.android -v $ { env.HOME } /ccache : /tmp/.ccache '' ) { + rosContainer = rosEnv.run ( `` -v /tmp=/tmp/.ros `` + + `` -- name ros '' ) + + buildEnv.inside ( `` -e HOME=/tmp `` + + Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/Dockerfile b/Dockerfile index a632ba6..ab4e10f 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -26,6 +26,7 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ curl \ file \ git \ + iptables \ libc6 : i386 \ libgcc1 : i386 \ libncurses5 : i386 \ diff -- git a/Jenkinsfile b/Jenkinsfile index 5c3dfe4..22a9102 100644 -- - a/Jenkinsfile +++ b/Jenkinsfile @ @ -3,6 +3,7 @ @ import groovy.json.JsonOutput def buildSuccess = false +def rosContainer try { node ( 'android ' ) { // Allocate a custom workspace to avoid having % in the path ( it breaks ld ) @ @ -22,65 +23,86 @ @ try { } def buildEnv + def rosEnv stage ( 'Docker build ' ) { + // Docker image for build buildEnv = docker.build 'realm-java : snapshot' + // Docker image for testing Realm Object Server + def dependProperties = readProperties file : 'dependencies.list' + def rosDeVersion = dependProperties [ `` REALM_OBJECT_SERVER_DE_VERSION '' ] + rosEnv = docker.build 'ros : snapshot ' , `` -- build-arg ROS_DE_VERSION= $ { rosDeVersion } tools/sync_test_server '' } - buildEnv.inside ( `` -e HOME=/tmp -e _JAVA_OPTIONS=-Duser.home=/tmp -- privileged -v /dev/bus/usb : /dev/bus/usb -v $ { env.HOME } /gradle-cache : Make an independent task for integration tests __EoT__ Now the integration tests is running as a part of normal unit test suites . However it is better we split it into a different task which can be executed separately on CI . I failed with trying to make it in the similar way the benchmarks does since the integration tests is only for the ` ObjectServer ` flavor . See details : https : //github.com/realm/realm-java/pull/3601 # issuecomment-253734769
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 20b6569..c05dcc3 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -3,7 +3,11 @ @ # # # Breaking changes * ` RealmResults.distinct ( ) ` returns a new ` RealmResults ` object instead of filtering on the original object ( # 2947 ) . -* ` RealmResults ` is auto-updated continuously . Any transaction on the current thread which may have an impact on the order or elements of the ` RealmResults ` will change the ` RealmResults ` immediately instead of change it in the next event loop . The standard ` RealmResults.iterator ( ) ` will continue to work as normal , which means that you can still delete or modify elements without impacting the iterator . The same is not true for simple for-loops . In some cases a simple for-loop will not work ( https : //realm.io/docs/java/2.3.1/api/io/realm/OrderedRealmCollection.html # loops ) , and you must use the new createSnapshot ( ) method . +* ` RealmResults ` is auto-updated continuously . Any transaction on the current thread which may have an impact on the order or elements of the ` RealmResults ` will change the ` RealmResults ` immediately instead of change Finegrained notifications __EoT__ Hi Realm devs , we now have the RealmChangeListener to listen for changes if some background thread updates the Realm instance , which is great . But i 'd like to put a feature request forward for more fine grained control when a listener can be called . It would be nice if it were possible to add a RealmChangeListener that only fires if a certain class of RealmObject is updated . The issue i have now is that i have multiple fragments for multiple classes of RealmObject ( eg . RealmUser , RealmMessage , RealmBeer ) open at once , then a background services updates one of the RealmUser instances . Now all the RealmChangeListener are fired , and all fragments are updated individually . While ideally only the one that deals with RealmUser should be updating .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 20b6569..c05dcc3 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -3,7 +3,11 @ @ # # # Breaking changes * ` RealmResults.distinct ( ) ` returns a new ` RealmResults ` object instead of filtering on the original object ( # 2947 ) . -* ` RealmResults ` is auto-updated continuously . Any transaction on the current thread which may have an impact on the order or elements of the ` RealmResults ` will change the ` RealmResults ` immediately instead of change it in the next event loop . The standard ` RealmResults.iterator ( ) ` will continue to work as normal , which means that you can still delete or modify elements without impacting the iterator . The same is not true for simple for-loops . In some cases a simple for-loop will not work ( https : //realm.io/docs/java/2.3.1/api/io/realm/OrderedRealmCollection.html # loops ) , and you must use the new createSnapshot ( ) method . +* ` RealmResults ` is auto-updated continuously . Any transaction on the current thread which may have an impact on the order or elements of the ` RealmResults ` will change the ` RealmResults ` immediately instead of change Finegrained notifications __EoT__ Hi Realm devs , we now have the RealmChangeListener to listen for changes if some background thread updates the Realm instance , which is great . But i 'd like to put a feature request forward for more fine grained control when a listener can be called . It would be nice if it were possible to add a RealmChangeListener that only fires if a certain class of RealmObject is updated . The issue i have now is that i have multiple fragments for multiple classes of RealmObject ( eg . RealmUser , RealmMessage , RealmBeer ) open at once , then a background services updates one of the RealmUser instances . Now all the RealmChangeListener are fired , and all fragments are updated individually . While ideally only the one that deals with RealmUser should be updating .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be RealmList.delete* ( ) does not delete target object . __EoT__ ` RealmList.delete* ( ) ` must delete target objects in addition to removing them from the list . Due to a bug introduced our refactoring introduced in ` 3.7.1 ` , ` RealmList.delete* ( ) ` ( except for ` deleteAllFromRealm ( ) ` ) only remove the target objects from the list and target objects still remain in the database . Following test exposes the bug . `` ` @ Test public void deleteFromRealm ( ) { Owner owner = realm.where ( Owner.class ) .findFirst ( ) ; //noinspection ConstantConditions RealmList < Dog > dogs = owner.getDogs ( ) ; assertEquals ( TEST_SIZE , dogs.size ( ) ) ; int expectedSize = TEST_SIZE ; realm.beginTransaction ( ) ; dogs.deleteFromRealm ( TEST_SIZE / 2 ) ; expectedSize -- ; realm.commitTransaction ( ) ; assertEquals ( expectedSize , dogs.size ( ) ) ; assertEquals ( expectedSize , realm.where ( Dog.class ) .count ( ) ) ; realm.beginTransaction ( ) ; dogs.deleteFromRealm ( 0 ) ; expectedSize -- ; realm.commitTransaction ( ) ; assertEquals ( expectedSize , dogs.size ( ) ) ; assertEquals ( expectedSize , realm.where ( Dog.class ) .count (
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be RealmList.delete* ( ) does not delete target object . __EoT__ ` RealmList.delete* ( ) ` must delete target objects in addition to removing them from the list . Due to a bug introduced our refactoring introduced in ` 3.7.1 ` , ` RealmList.delete* ( ) ` ( except for ` deleteAllFromRealm ( ) ` ) only remove the target objects from the list and target objects still remain in the database . Following test exposes the bug . `` ` @ Test public void deleteFromRealm ( ) { Owner owner = realm.where ( Owner.class ) .findFirst ( ) ; //noinspection ConstantConditions RealmList < Dog > dogs = owner.getDogs ( ) ; assertEquals ( TEST_SIZE , dogs.size ( ) ) ; int expectedSize = TEST_SIZE ; realm.beginTransaction ( ) ; dogs.deleteFromRealm ( TEST_SIZE / 2 ) ; expectedSize -- ; realm.commitTransaction ( ) ; assertEquals ( expectedSize , dogs.size ( ) ) ; assertEquals ( expectedSize , realm.where ( Dog.class ) .count ( ) ) ; realm.beginTransaction ( ) ; dogs.deleteFromRealm ( 0 ) ; expectedSize -- ; realm.commitTransaction ( ) ; assertEquals ( expectedSize , dogs.size ( ) ) ; assertEquals ( expectedSize , realm.where ( Dog.class ) .count (
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be RealmList.delete* ( ) does not delete target object . __EoT__ ` RealmList.delete* ( ) ` must delete target objects in addition to removing them from the list . Due to a bug introduced our refactoring introduced in ` 3.7.1 ` , ` RealmList.delete* ( ) ` ( except for ` deleteAllFromRealm ( ) ` ) only remove the target objects from the list and target objects still remain in the database . Following test exposes the bug . `` ` @ Test public void deleteFromRealm ( ) { Owner owner = realm.where ( Owner.class ) .findFirst ( ) ; //noinspection ConstantConditions RealmList < Dog > dogs = owner.getDogs ( ) ; assertEquals ( TEST_SIZE , dogs.size ( ) ) ; int expectedSize = TEST_SIZE ; realm.beginTransaction ( ) ; dogs.deleteFromRealm ( TEST_SIZE / 2 ) ; expectedSize -- ; realm.commitTransaction ( ) ; assertEquals ( expectedSize , dogs.size ( ) ) ; assertEquals ( expectedSize , realm.where ( Dog.class ) .count ( ) ) ; realm.beginTransaction ( ) ; dogs.deleteFromRealm ( 0 ) ; expectedSize -- ; realm.commitTransaction ( ) ; assertEquals ( expectedSize , dogs.size ( ) ) ; assertEquals ( expectedSize , realm.where ( Dog.class ) .count (
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be RealmList.delete* ( ) does not delete target object . __EoT__ ` RealmList.delete* ( ) ` must delete target objects in addition to removing them from the list . Due to a bug introduced our refactoring introduced in ` 3.7.1 ` , ` RealmList.delete* ( ) ` ( except for ` deleteAllFromRealm ( ) ` ) only remove the target objects from the list and target objects still remain in the database . Following test exposes the bug . `` ` @ Test public void deleteFromRealm ( ) { Owner owner = realm.where ( Owner.class ) .findFirst ( ) ; //noinspection ConstantConditions RealmList < Dog > dogs = owner.getDogs ( ) ; assertEquals ( TEST_SIZE , dogs.size ( ) ) ; int expectedSize = TEST_SIZE ; realm.beginTransaction ( ) ; dogs.deleteFromRealm ( TEST_SIZE / 2 ) ; expectedSize -- ; realm.commitTransaction ( ) ; assertEquals ( expectedSize , dogs.size ( ) ) ; assertEquals ( expectedSize , realm.where ( Dog.class ) .count ( ) ) ; realm.beginTransaction ( ) ; dogs.deleteFromRealm ( 0 ) ; expectedSize -- ; realm.commitTransaction ( ) ; assertEquals ( expectedSize , dogs.size ( ) ) ; assertEquals ( expectedSize , realm.where ( Dog.class ) .count (
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be RealmList.delete* ( ) does not delete target object . __EoT__ ` RealmList.delete* ( ) ` must delete target objects in addition to removing them from the list . Due to a bug introduced our refactoring introduced in ` 3.7.1 ` , ` RealmList.delete* ( ) ` ( except for ` deleteAllFromRealm ( ) ` ) only remove the target objects from the list and target objects still remain in the database . Following test exposes the bug . `` ` @ Test public void deleteFromRealm ( ) { Owner owner = realm.where ( Owner.class ) .findFirst ( ) ; //noinspection ConstantConditions RealmList < Dog > dogs = owner.getDogs ( ) ; assertEquals ( TEST_SIZE , dogs.size ( ) ) ; int expectedSize = TEST_SIZE ; realm.beginTransaction ( ) ; dogs.deleteFromRealm ( TEST_SIZE / 2 ) ; expectedSize -- ; realm.commitTransaction ( ) ; assertEquals ( expectedSize , dogs.size ( ) ) ; assertEquals ( expectedSize , realm.where ( Dog.class ) .count ( ) ) ; realm.beginTransaction ( ) ; dogs.deleteFromRealm ( 0 ) ; expectedSize -- ; realm.commitTransaction ( ) ; assertEquals ( expectedSize , dogs.size ( ) ) ; assertEquals ( expectedSize , realm.where ( Dog.class ) .count (
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 54dd039..af7ba86 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -20,6 +20,7 @ @ # # # Breaking Changes * ` RealmResults.distinct ( ) ` / ` RealmResults.distinctAsync ( ) ` have been removed . Use ` RealmQuery.distinct ( ) ` / ` RealmQuery.distinctAsync ( ) ` instead . +* ` RealmQuery.createQuery ( Realm , Class ) ` , ` RealmQuery.createDynamicQuery ( DynamicRealm , String ) ` , ` RealmQuery.createQueryFromResult ( RealmResults ) ` and ` RealmQuery.createQueryFromList ( RealmList ) ` have been removed . Use ` Realm.where ( Class ) ` , ` DynamicRealm.where ( String ) ` , RealmResults.where ( ) ` and ` RealmList.where ( ) ` instead . # # # Enhancements diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` RealmList.delete* ( ) does not delete target object . __EoT__ ` RealmList.delete* ( ) ` must delete target objects in addition to removing them from the list . Due to a bug introduced our refactoring introduced in ` 3.7.1 ` , ` RealmList.delete* ( ) ` ( except for ` deleteAllFromRealm ( ) ` ) only remove the target objects from the list and target objects still remain in the database . Following test exposes the bug . `` ` @ Test public void deleteFromRealm ( ) { Owner owner = realm.where ( Owner.class ) .findFirst ( ) ; //noinspection ConstantConditions RealmList < Dog > dogs = owner.getDogs ( ) ; assertEquals ( TEST_SIZE , dogs.size ( ) ) ; int expectedSize = TEST_SIZE ; realm.beginTransaction ( ) ; dogs.deleteFromRealm ( TEST_SIZE / 2 ) ; expectedSize -- ; realm.commitTransaction ( ) ; assertEquals ( expectedSize , dogs.size ( ) ) ; assertEquals ( expectedSize , realm.where ( Dog.class ) .count ( ) ) ; realm.beginTransaction ( ) ; dogs.deleteFromRealm ( 0 ) ; expectedSize -- ; realm.commitTransaction ( ) ; assertEquals ( expectedSize , dogs.size ( ) ) ; assertEquals ( expectedSize , realm.where ( Dog.class ) .count (
diff -- git a/CHANGELOG.md b/CHANGELOG.md index e2fdb37..c3eef50 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -9,8 +9,10 @ @ * Added support for new data type ` MutableRealmIntegers ` . The new type behaves almost exactly as a reference to a Long ( mutable nullable , etc ) but supports ` increment ` and ` decrement ` methods , which implement a Conflict Free Replicated Data Type , whose value will converge even when changed across distributed devices with poor connections ( # 4266 ) . # # # Bug Fixes +* [ ObjectServer ] Added ` SyncUser.logout ( ) ` throw an exception now , when associated Realms are instances are not closed ( # 4962 ) . # # # Internal +* [ ObjectServer ] removed ` ObjectServerUser ` and it 's inner classes , in a step to reduce ` SyncUser ` complexity ( # 3741 ) . # # 3.5.1 ( YYYY-MM-DD ) diff -- git a/examples/build.gradle b/examples/build.gradle index 3822790..4f6a611 100644 -- - a/examples/build.gradle +++ b/examples/build.gradle @ @ -23,8 +23,8 @ @ allprojects { maven { url 'https : //jitpack.io ' } } dependencies { - classpath 'com.android.tools.build : gradle:3.0.0-alpha4' - classpath 'com.jfrog.bintray.gradle : gradle-bintray-plugin:1.6' + Logout and opend Realm instance __EoT__ From the ` SyncUser.logout ( ) ` document : `` ` * @ throws IllegalStateException if any Realms owned by this user is still open . They should be closed before * logging out . `` ` But this is not true . It is checking ` ObjectServerUser.sessions ` to determine if there is any Realm instance is still opened . But ` ObjectServerUser.sessions ` is used anymore after we moved session logic to Object Store . To solve this : - Do we really want to restrict user from logging out when Realm instance are still opened ? From my opinion . it is very difficult if there are realm instance in the background in user 's app . It the relevant Realm instance stops syncing , then it would be good enough for user . - If we allow this , we need to ensure user wo n't open a Realm instance with the same name for a different user even in **multi-processes** environment ! - If we disallow this , then needs to also consider the corner case for ` getInstanceAsync ( ) ` .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 0a56f72..322e371 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -4,8 +4,10 @ @ * Fixed a crash when calling ` Table.toString ( ) ` in debugger ( # 2429 ) . * Fixed a race condition which would cause some ` RealmResults ` to not be properly updated inside a ` RealmChangeListener ` . This could result in crashes when accessing items from those results ( # 2926/ # 2951 ) . -* Fixed a bug that could cause Realm to lose track of primary key when using ` RealmObjectSchema.removeField ( ) ` and ` RealmObjectSchema.renameField ( ) ` ( # 2829 ) .lts ( # 2926 ) . +* Fixed a bug that could cause Realm to lose track of primary key when using ` RealmObjectSchema.removeField ( ) ` and ` RealmObjectSchema.renameField ( ) ` ( # 2829/ # 2926 ) . * Updated ProGuard configuration in order not to depend on Android 's default configuration ( # 2972 ) . +* Fixed a race condition between Realms notifications and other UI events . This could e.g . cause ListView to crash . + # # # Enhancements diff -- git a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java Trying to access Realm Object from an interface __EoT__ am using Realm , and i created an interface to parse RealmObject in my Adapter to be implemented in an activity but i get this error **Object is no longer valid to operate on . Was it deleted by another thread ? ** **NewsAdapter.java** `` ` ` final NewsTrend postsData = getItem ( position ) ; holder.ivLike.setOnClickListener ( new View.OnClickListener ( ) { @ Override public void onClick ( View v ) { eventListener.onLikeClick ( v , postsData , holder.tvNewsCountLike , holder.ivLike ) ; } } ) ; ` `` ` Implementing the Listener in Fragment **Fragment.java** `` ` ` @ Override public void onLikeClick ( View view , NewsTrend postData , TextView tvNewsCountLike , ImageView ivLike ) { if ( ! postData.isChecked ( ) ) { realm.beginTransaction ( ) ; postData.setChecked ( true ) ; realm.commitTransaction ( ) ; tvNewsCountLike.setText ( `` '' + ( Integer.parseInt ( tvNewsCountLike.getText ( ) .toString ( ) ) + 1 ) ) ; ivLike.setImageResource ( R.drawable.kalp_dolu_kucuk ) ; } else { realm.beginTransaction ( ) ; postData.setChecked ( false ) ; realm.commitTransaction ( ) ; tvNewsCountLike.setText ( `` '' + ( Integer.parseInt ( tvNewsCountLike.getText (
diff -- git a/examples/multiProcessAExample/.gitignore b/examples/multiProcessAExample/.gitignore new file mode 100644 index 0000000..796b96d -- - /dev/null +++ b/examples/multiProcessAExample/.gitignore @ @ -0,0 +1 @ @ +/build diff -- git a/examples/multiProcessAExample/build.gradle b/examples/multiProcessAExample/build.gradle new file mode 100644 index 0000000..5ec8e22 -- - /dev/null +++ b/examples/multiProcessAExample/build.gradle @ @ -0,0 +1,27 @ @ +apply plugin : 'android-sdk-manager' +apply plugin : 'com.android.application' +apply plugin : 'android-command' +apply plugin : 'realm' + +android { + compileSdkVersion rootProject.sdkVersion + buildToolsVersion rootProject.buildTools + + defaultConfig { + applicationId `` io.realm.examples.realmmultiprocessaexample '' + targetSdkVersion rootProject.sdkVersion + minSdkVersion 9 + versionCode 1 + versionName `` 1.0 '' + } + buildTypes { + release { + minifyEnabled false + proguardFiles getDefaultProguardFile ( 'proguard-android.txt ' ) , 'proguard-rules.pro' + } + } + } + +dependencies { + compile 'com.android.support : appcompat-v7:23.1.1' + } diff -- git a/examples/multiProcessAExample/proguard-rules.pro b/examples/multiProcessAExample/proguard-rules.pro new file mode 100644 index 0000000..8456b3d -- - /dev/null +++ b/examples/multiProcessAExample/proguard-rules.pro @ @ -0,0 +1,17 @ @ + # Add project specific ProGuard rules here . + # By default , the flags in this file are appended to flags specified + # in /home/cc/.android-sdk/tools/proguard/proguard-android.txt + # You can edit the include path and order by changing the proguardFiles + # directive in build.gradle . + Access Realm from Background Service __EoT__ I am trying to get some data from Realm DB from ` IntentService ` class , which runs in background , and upload data to web service . I have ` RealmManager ` class which has ` Realm ` instance and does CRUD on database . So i create ` RealmManager ` intance inside my background ` IntentService ` and try to query . I am getting error : ** ` Realm access from incorrect thread . Realm objects can only be accessed on the thread they were created ` ** . I see ` Realm ` can not be shared across threads . So what might be solution for this ? Is there any way to make CRUD on Realm from background android service , thread ?
diff -- git a/examples/multiProcessAExample/.gitignore b/examples/multiProcessAExample/.gitignore new file mode 100644 index 0000000..796b96d -- - /dev/null +++ b/examples/multiProcessAExample/.gitignore @ @ -0,0 +1 @ @ +/build diff -- git a/examples/multiProcessAExample/build.gradle b/examples/multiProcessAExample/build.gradle new file mode 100644 index 0000000..5ec8e22 -- - /dev/null +++ b/examples/multiProcessAExample/build.gradle @ @ -0,0 +1,27 @ @ +apply plugin : 'android-sdk-manager' +apply plugin : 'com.android.application' +apply plugin : 'android-command' +apply plugin : 'realm' + +android { + compileSdkVersion rootProject.sdkVersion + buildToolsVersion rootProject.buildTools + + defaultConfig { + applicationId `` io.realm.examples.realmmultiprocessaexample '' + targetSdkVersion rootProject.sdkVersion + minSdkVersion 9 + versionCode 1 + versionName `` 1.0 '' + } + buildTypes { + release { + minifyEnabled false + proguardFiles getDefaultProguardFile ( 'proguard-android.txt ' ) , 'proguard-rules.pro' + } + } + } + +dependencies { + compile 'com.android.support : appcompat-v7:23.1.1' + } diff -- git a/examples/multiProcessAExample/proguard-rules.pro b/examples/multiProcessAExample/proguard-rules.pro new file mode 100644 index 0000000..8456b3d -- - /dev/null +++ b/examples/multiProcessAExample/proguard-rules.pro @ @ -0,0 +1,17 @ @ + # Add project specific ProGuard rules here . + # By default , the flags in this file are appended to flags specified + # in /home/cc/.android-sdk/tools/proguard/proguard-android.txt + # You can edit the include path and order by changing the proguardFiles + # directive in build.gradle . + Access Realm from Background Service __EoT__ I am trying to get some data from Realm DB from ` IntentService ` class , which runs in background , and upload data to web service . I have ` RealmManager ` class which has ` Realm ` instance and does CRUD on database . So i create ` RealmManager ` intance inside my background ` IntentService ` and try to query . I am getting error : ** ` Realm access from incorrect thread . Realm objects can only be accessed on the thread they were created ` ** . I see ` Realm ` can not be shared across threads . So what might be solution for this ? Is there any way to make CRUD on Realm from background android service , thread ?
diff -- git a/examples/multiProcessAExample/.gitignore b/examples/multiProcessAExample/.gitignore new file mode 100644 index 0000000..796b96d -- - /dev/null +++ b/examples/multiProcessAExample/.gitignore @ @ -0,0 +1 @ @ +/build diff -- git a/examples/multiProcessAExample/build.gradle b/examples/multiProcessAExample/build.gradle new file mode 100644 index 0000000..5ec8e22 -- - /dev/null +++ b/examples/multiProcessAExample/build.gradle @ @ -0,0 +1,27 @ @ +apply plugin : 'android-sdk-manager' +apply plugin : 'com.android.application' +apply plugin : 'android-command' +apply plugin : 'realm' + +android { + compileSdkVersion rootProject.sdkVersion + buildToolsVersion rootProject.buildTools + + defaultConfig { + applicationId `` io.realm.examples.realmmultiprocessaexample '' + targetSdkVersion rootProject.sdkVersion + minSdkVersion 9 + versionCode 1 + versionName `` 1.0 '' + } + buildTypes { + release { + minifyEnabled false + proguardFiles getDefaultProguardFile ( 'proguard-android.txt ' ) , 'proguard-rules.pro' + } + } + } + +dependencies { + compile 'com.android.support : appcompat-v7:23.1.1' + } diff -- git a/examples/multiProcessAExample/proguard-rules.pro b/examples/multiProcessAExample/proguard-rules.pro new file mode 100644 index 0000000..8456b3d -- - /dev/null +++ b/examples/multiProcessAExample/proguard-rules.pro @ @ -0,0 +1,17 @ @ + # Add project specific ProGuard rules here . + # By default , the flags in this file are appended to flags specified + # in /home/cc/.android-sdk/tools/proguard/proguard-android.txt + # You can edit the include path and order by changing the proguardFiles + # directive in build.gradle . + Access Realm from Background Service __EoT__ I am trying to get some data from Realm DB from ` IntentService ` class , which runs in background , and upload data to web service . I have ` RealmManager ` class which has ` Realm ` instance and does CRUD on database . So i create ` RealmManager ` intance inside my background ` IntentService ` and try to query . I am getting error : ** ` Realm access from incorrect thread . Realm objects can only be accessed on the thread they were created ` ** . I see ` Realm ` can not be shared across threads . So what might be solution for this ? Is there any way to make CRUD on Realm from background android service , thread ?
diff -- git a/CHANGELOG.md b/CHANGELOG.md index df4a908..7617d1b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,17 @ @ + # # 5.0.0 ( YYYY-MM-DD ) + + # # # Breaking Changes + +* The ` OrderedCollectionChangeSet ` parameter in ` OrderedRealmCollectionChangeListener.onChange ( ) ` is no longer nullable . Use ` changeSet.getState ( ) ` instead ( # 5619 ) . + + + # # # Enhancements + +* Added support for partial Realms . Read [ here ] ( https : //realm.io/docs/java/latest/ # partial-realms ) for more information . +* Added two new methods to ` OrderedCollectionChangeSet ` : ` getState ( ) ` and ` getError ( ) ` ( # 5619 ) . + + + # # 4.3.2 ( YYYY-MM-DD ) # # # Bug Fixes diff -- git a/realm/realm-library/src/main/cpp/collection_changeset_wrapper.hpp b/realm/realm-library/src/main/cpp/collection_changeset_wrapper.hpp new file mode 100644 index 0000000..e15cebb -- - /dev/null +++ b/realm/realm-library/src/main/cpp/collection_changeset_wrapper.hpp @ @ -0,0 +1,89 @ @ +/* + * Copyright 2017 Realm Inc. + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may Partial Sync : Unify Notification System __EoT__ See https : //github.com/realm/product/issues/392 for details . Note that this introduce a small breaking change to the Java API 's as ` OrderedChangeSet ` will no longer be ` @ Nullable ` in callbacks .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index df4a908..640d475 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,19 @ @ + # # 5.0.0 ( YYYY-MM-DD ) + + # # # Breaking Changes + +* The ` OrderedCollectionChangeSet ` parameter in ` OrderedRealmCollectionChangeListener.onChange ( ) ` is no longer nullable . Use ` changeSet.getState ( ) ` instead ( # 5619 ) . + + # # # Enhancements + +* Added support for partial Realms . Read [ here ] ( https : //realm.io/docs/java/latest/ # partial-realms ) for more information . +* Added two new methods to ` OrderedCollectionChangeSet ` : ` getState ( ) ` and ` getError ( ) ` ( # 5619 ) . + + # # # Internal + +* Upgraded to Realm Sync 2.2.1 . + + # # 4.3.2 ( YYYY-MM-DD ) # # # Bug Fixes diff -- git a/dependencies.list b/dependencies.list index 3703b72..2692489 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -1,7 +1,7 @ @ # Realm Sync Core release used by Realm Java # https : //github.com/realm/realm-sync/releases -REALM_SYNC_VERSION=2.1.8 -REALM_SYNC_SHA256=14e4aabe270638aa96f84396be27985b6809e532183035c5150dd2933d676248 +REALM_SYNC_VERSION=2.2.1 +REALM_SYNC_SHA256=47e29555cdb96beb1be75e13599e8d93c88f2a807c09f44b85a4286d81cb91b6 # Object Server Release used by Integration tests . Installed using NPM . # Use ` npm view realm-object-server Partial Sync : Unify Notification System __EoT__ See https : //github.com/realm/product/issues/392 for details . Note that this introduce a small breaking change to the Java API 's as ` OrderedChangeSet ` will no longer be ` @ Nullable ` in callbacks .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 3133d7f..32c0cea 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,19 @ @ + # # 5.0.0 ( YYYY-MM-DD ) + + # # # Breaking Changes + +* The ` OrderedCollectionChangeSet ` parameter in ` OrderedRealmCollectionChangeListener.onChange ( ) ` is no longer nullable . Use ` changeSet.getState ( ) ` instead ( # 5619 ) . + + # # # Enhancements + +* Added support for partial Realms . Read [ here ] ( https : //realm.io/docs/java/latest/ # partial-realms ) for more information . +* Added two new methods to ` OrderedCollectionChangeSet ` : ` getState ( ) ` and ` getError ( ) ` ( # 5619 ) . + + # # # Internal + +* Upgraded to Realm Sync 2.2.2 . + + # # 4.3.2 ( YYYY-MM-DD ) # # # Bug Fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/OrderedCollectionChangeSetTests.java b/realm/realm-library/src/androidTest/java/io/realm/OrderedCollectionChangeSetTests.java index a8e0b87..267860f 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/OrderedCollectionChangeSetTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/OrderedCollectionChangeSetTests.java @ @ -36,11 +36,11 @ @ import io.realm.rule.TestRealmConfigurationFactory ; import static junit.framework.Assert.assertEquals ; import static junit.framework.Assert.assertNotNull ; -import static junit.framework.Assert.assertNull ; import static junit.framework.Assert.assertSame ; import static junit.framework.Assert.fail ; import static org.junit.Assert.assertArrayEquals ; import static org.junit.Assert.assertNotEquals ; +import static org.junit.Assert.assertTrue ; // Partial Sync : Unify Notification System __EoT__ See https : //github.com/realm/product/issues/392 for details . Note that this introduce a small breaking change to the Java API 's as ` OrderedChangeSet ` will no longer be ` @ Nullable ` in callbacks .
diff -- git a/examples/multiProcessAExample/.gitignore b/examples/multiProcessAExample/.gitignore new file mode 100644 index 0000000..796b96d -- - /dev/null +++ b/examples/multiProcessAExample/.gitignore @ @ -0,0 +1 @ @ +/build diff -- git a/examples/multiProcessAExample/build.gradle b/examples/multiProcessAExample/build.gradle new file mode 100644 index 0000000..5ec8e22 -- - /dev/null +++ b/examples/multiProcessAExample/build.gradle @ @ -0,0 +1,27 @ @ +apply plugin : 'android-sdk-manager' +apply plugin : 'com.android.application' +apply plugin : 'android-command' +apply plugin : 'realm' + +android { + compileSdkVersion rootProject.sdkVersion + buildToolsVersion rootProject.buildTools + + defaultConfig { + applicationId `` io.realm.examples.realmmultiprocessaexample '' + targetSdkVersion rootProject.sdkVersion + minSdkVersion 9 + versionCode 1 + versionName `` 1.0 '' + } + buildTypes { + release { + minifyEnabled false + proguardFiles getDefaultProguardFile ( 'proguard-android.txt ' ) , 'proguard-rules.pro' + } + } + } + +dependencies { + compile 'com.android.support : appcompat-v7:23.1.1' + } diff -- git a/examples/multiProcessAExample/proguard-rules.pro b/examples/multiProcessAExample/proguard-rules.pro new file mode 100644 index 0000000..8456b3d -- - /dev/null +++ b/examples/multiProcessAExample/proguard-rules.pro @ @ -0,0 +1,17 @ @ + # Add project specific ProGuard rules here . + # By default , the flags in this file are appended to flags specified + # in /home/cc/.android-sdk/tools/proguard/proguard-android.txt + # You can edit the include path and order by changing the proguardFiles + # directive in build.gradle . + Realm with a SyncAdapter __EoT__ Is there a way to make Realm http : //realm.io/docs/java/latest/ and Syncadapters https : //developer.android.com/training/sync-adapters/creating-sync-adapter.html play nicely together ? I created a stub ContentProvider so that I could persist data with Realm . The problem is I do n't know how to communicate changes from the SyncAdapter back to my Fragment that kicks off the whole sync adapter process . From the onPerformSync ( ) method in the SyncAdapter I tried using an event bus like Otto to communicate these changes , however event buses do not work across multiple threads . Realm provides an OnChangeListener which detects any changes to the DB . This works well inside the Fragment but not across multiple threads . The alternative is to do away with Realm and just use a ContentProvider . But Realm is very simple to use and I would prefer a solution that includes Realm .
diff -- git a/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy b/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy index b9e388c..ce1fc39 100644 -- - a/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy +++ b/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy @ @ -57,7 +57,7 @ @ class BytecodeModifier { * @ param clazz The CtClass to modify * @ param managedFields List of fields whose access should be replaced */ - public static void useRealmAccessors ( CtClass clazz , List < CtField > managedFields , List < CtClass > modelClasses ) { + public static void useRealmAccessors ( CtClass clazz , List < CtField > managedFields ) { clazz.getDeclaredBehaviors ( ) .each { behavior - > logger.info `` Behavior : $ { behavior.name } '' if ( @ @ -69,7 +69,7 @ @ class BytecodeModifier { behavior instanceof CtConstructor ) ) { - behavior.instrument ( new FieldAccessToAccessorConverter ( managedFields , clazz , behavior , modelClasses.contains ( clazz ) ) ) + behavior.instrument ( new FieldAccessToAccessorConverter ( managedFields , clazz , behavior ) ) } } } @ @ -93,18 +93,13 @ @ class BytecodeModifier { final List < CtField > managedFields final CtClass ctClass final CtBehavior behavior - final boolean isModelClass - final boolean isInConstructor FieldAccessToAccessorConverter ( List < CtField > managedFields , CtClass ctClass , - CtBehavior behavior , - boolean isModelClass ) { + CtBehavior Default values for fields / assignment in default constructor __EoT__ Question/request : Will the java version have default values for fields similar to the iOS one ? i.e . +defaultPropertyValues can be overriden to provide default values every time an object is created . This might also helps to alleviate the lack of null support in the interim ( and with the standalone object support now , helps with gson deserialization a bunch ) Thanks for all the awesome work on this !
diff -- git a/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy b/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy index b9e388c..ce1fc39 100644 -- - a/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy +++ b/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy @ @ -57,7 +57,7 @ @ class BytecodeModifier { * @ param clazz The CtClass to modify * @ param managedFields List of fields whose access should be replaced */ - public static void useRealmAccessors ( CtClass clazz , List < CtField > managedFields , List < CtClass > modelClasses ) { + public static void useRealmAccessors ( CtClass clazz , List < CtField > managedFields ) { clazz.getDeclaredBehaviors ( ) .each { behavior - > logger.info `` Behavior : $ { behavior.name } '' if ( @ @ -69,7 +69,7 @ @ class BytecodeModifier { behavior instanceof CtConstructor ) ) { - behavior.instrument ( new FieldAccessToAccessorConverter ( managedFields , clazz , behavior , modelClasses.contains ( clazz ) ) ) + behavior.instrument ( new FieldAccessToAccessorConverter ( managedFields , clazz , behavior ) ) } } } @ @ -93,18 +93,13 @ @ class BytecodeModifier { final List < CtField > managedFields final CtClass ctClass final CtBehavior behavior - final boolean isModelClass - final boolean isInConstructor FieldAccessToAccessorConverter ( List < CtField > managedFields , CtClass ctClass , - CtBehavior behavior , - boolean isModelClass ) { + CtBehavior Default values for fields / assignment in default constructor __EoT__ Question/request : Will the java version have default values for fields similar to the iOS one ? i.e . +defaultPropertyValues can be overriden to provide default values every time an object is created . This might also helps to alleviate the lack of null support in the interim ( and with the standalone object support now , helps with gson deserialization a bunch ) Thanks for all the awesome work on this !
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 79f3595..c34cf77 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,5 +1,9 @ @ # # 2.0.0 + # # # Known issues + +* When create ` RealmObject ` from JSON stream , it will takes default values set by the non-managed ` RealmObject ` 's default constructor for those absent field in JSON object . This behaviour is different from other APIs when creating ` RealmObject ` ( # 3386 ) . + # # # Breaking Changes * ` isValid ( ) ` now always returns ` true ` instead of ` false ` for unmanaged ` RealmObject ` and ` RealmList ` . This puts it in line with the behaviour of the Cocoa and .NET API 's ( # 3101 ) . @ @ -9,6 +13,8 @ @ - ` RealmIOExcpetion ` has been removed and replaced by ` RealmFileException ` . * Removed ` RealmConfiguration.Builder ( Context , File ) ` and ` RealmConfiguration.Builder ( File ) ` constructors . * ` RealmConfiguration.Builder.assetFile ( Context , String ) ` has been renamed to ` RealmConfiguration.Builder.assetFile ( String ) ` . +* Object with primary key is now required to Default values for fields / assignment in default constructor __EoT__ Question/request : Will the java version have default values for fields similar to the iOS one ? i.e . +defaultPropertyValues can be overriden to provide default values every time an object is created . This might also helps to alleviate the lack of null support in the interim ( and with the standalone object support now , helps with gson deserialization a bunch ) Thanks for all the awesome work on this !
diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 5d55282..3f0cd84 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -15,7 +15,7 @ @ ext.stripSymbols = project.hasProperty ( 'stripSymbols ' ) ? project.getProperty ( 'st // core source code . ext.coreSourcePath = project.hasProperty ( 'coreSourcePath ' ) ? project.getProperty ( 'coreSourcePath ' ) : null -def commonCflags = [ '-Os ' , '-std=c++11 ' ] +def commonCflags = [ '-Os ' , '-std=c++14 ' ] // LTO and debugging do n't play well together if ( ! ext.debugBuild ) { commonCflags += [ '-fvisibility=hidden ' , '-ffunction-sections ' , '-fdata-sections ' , '-flto ' ] @ @ -284,7 +284,7 @ @ targets.each { target - > `` -l $ { Runtime.getRuntime ( ) .availableProcessors ( ) } '' , '-C ' , `` $ { projectDir } /src '' , `` CC_IS= $ { clang ? 'clang ' : 'gcc ' } '' , - `` REALM_CFLAGS_COMMON=-Wno-variadic-macros -DREALM_HAVE_CONFIG -DPIC -I $ { project.coreDir } /include '' , + `` REALM_CFLAGS_COMMON=-Wno-variadic-macros -DREALM_HAVE_CONFIG -DPIC -I $ { project.coreDir } /include -Iobject-store -Iobject-store/impl/android -Iobject-store/impl '' , `` CFLAGS_ARCH= $ { ( commonCflags + target.cflags ) .join ( ' ' ) } '' , `` BASE_DENOM= $ { target.name Migrate to ObjectStore __EoT__ - [ ] ` Realm ` - [ x ] ` RealmConfiguration ` - see # 2372 - [ ] ` RealmResults ` - [ ] ` RealmObject `
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..d211177 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp index b15798d..e037db6 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp @ @ -32,6 +32,8 @ @ # include `` sync/sync_manager.hpp '' # endif + # include `` jni_util/hack.hpp '' + using namespace realm ; using namespace realm : :_impl ; @ @ -57,6 +59,8 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_SharedRealm_nativeInit ( JNIEnv* env { TR_ENTER ( ) + hack_init ( ) ; + try { JStringAccessor path ( env , temporary_directory_path ) ; // throws SharedGroupOptions : :set_sys_tmp_dir ( std : :string ( path ) ) ; // throws diff -- git a/realm/realm-library/src/main/cpp/jni_util/hack.cpp b/realm/realm-library/src/main/cpp/jni_util/hack.cpp new file mode 100644 index 0000000..75aa1bd -- - /dev/null +++ b/realm/realm-library/src/main/cpp/jni_util/hack.cpp @ @ App crashing ( librealm-jni.so ) __EoT__ Realm is working flawlessly on almost devices in our user base but one user is unable to launch the app . The screen is white and then the app closes down . I was able to get the phone having the issue and check its logs . The issue seems to happen after or during the loading of librealm-jni.so # # # # Goal > Start app and use Realm normally # # # # Expected Results > App running # # # # Actual Results > App crash instantly when starting ( ANR ) # # # # Code Sample `` ` crash stack > 11-14 16:54:23.320 32150-32150/ ? D/dalvikvm : Trying to load lib /data/app-lib/com.myapp-1/librealm-jni.so 0x4175fe08 11-14 16:54:23.343 32150-32150/ ? D/dalvikvm : Added shared lib /data/app-lib/com.myapp-1/librealm-jni.so 0x4175fe08 11-14 16:54:23.437 32150-32150/ ? A/libc : Fatal signal 11 ( SIGSEGV ) at 0x5aa4cff0 ( code=2 ) , thread 32150 ( com.myapp ) 11-14 16:54:23.546 31669-31669/ ? I/DEBUG : pid : 32150 , tid : 32150 , name : com.myapp > > > com.myapp < < < 11-14 16:54:23.976 31669-31669/ ? I/DEBUG : # 00 pc 00082052 /data/app-lib/com.myapp-1/librealm-jni.so 11-14 16:54:23.976 31669-31669/ ? I/DEBUG : #
diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 93e83ca..78fd04b 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -65,12 +65,12 @ @ def toolchains = [ ] def targets = [ - new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , - new Target ( name : 'arm-v7a ' , jniFolder : 'armeabi-v7a ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' , '-march=armv7-a ' , '-mfloat-abi=softfp ' , '-mfpu=vfpv3-d16 ' ] ) , - new Target ( name : 'arm64 ' , jniFolder : 'arm64-v8a ' , toolchain : toolchains.find { it.name == 'arm64 ' } , cflags : [ ] ) , - new Target ( name : 'mips ' , jniFolder : 'mips ' , toolchain : toolchains.find { it.name == 'mips ' } , cflags : [ ] ) , +// new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , +// new Target ( name : 'arm-v7a ReLinker NoClassDefFoundError exception __EoT__ Using 8.8.0-SNAPSHOT : java.lang.NoClassDefFoundError : Failed resolution of : Lcom/getkeepsafe/relinker/ReLinker ; at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:90 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:307 ) at com.borg.forza.activities.Forza.setupRealm ( Forza.java:75 ) at com.borg.forza.activities.Forza.onCreate ( Forza.java:63 ) at android.app.Instrumentation.callApplicationOnCreate ( Instrumentation.java:1034 ) at android.app.ActivityThread.handleBindApplication ( ActivityThread.java:4605 ) at android.app.ActivityThread.access $ 1500 ( ActivityThread.java:148 ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1353 ) at android.os.Handler.dispatchMessage ( Handler.java:102 ) at android.os.Looper.loop ( Looper.java:135 ) at android.app.ActivityThread.main ( ActivityThread.java:5312 ) at java.lang.reflect.Method.invoke ( Native Method ) at java.lang.reflect.Method.invoke ( Method.java:372 ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:901 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:696 ) Caused by : java.lang.ClassNotFoundException : Did n't find class `` com.getkeepsafe.relinker.ReLinker '' on path : DexPathList [ [ zip file `` /mnt/asec/com.borg.forza-1/base.apk '' ] , nativeLibraryDirectories= [ /mnt/asec/com.borg.forza-1/lib/arm , /vendor/lib , /system/lib ] ] at dalvik.system.BaseDexClassLoader.findClass ( BaseDexClassLoader.java:56 ) at java.lang.ClassLoader.loadClass ( ClassLoader.java:511 ) at java.lang.ClassLoader.loadClass ( ClassLoader.java:469 ) at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:90 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:307 ) at com.borg.forza.activities.Forza.setupRealm ( Forza.java:75 ) at com.borg.forza.activities.Forza.onCreate ( Forza.java:63 ) at android.app.Instrumentation.callApplicationOnCreate ( Instrumentation.java:1034 ) `
diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 93e83ca..78fd04b 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -65,12 +65,12 @ @ def toolchains = [ ] def targets = [ - new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , - new Target ( name : 'arm-v7a ' , jniFolder : 'armeabi-v7a ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' , '-march=armv7-a ' , '-mfloat-abi=softfp ' , '-mfpu=vfpv3-d16 ' ] ) , - new Target ( name : 'arm64 ' , jniFolder : 'arm64-v8a ' , toolchain : toolchains.find { it.name == 'arm64 ' } , cflags : [ ] ) , - new Target ( name : 'mips ' , jniFolder : 'mips ' , toolchain : toolchains.find { it.name == 'mips ' } , cflags : [ ] ) , +// new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , +// new Target ( name : 'arm-v7a ReLinker NoClassDefFoundError exception __EoT__ Using 8.8.0-SNAPSHOT : java.lang.NoClassDefFoundError : Failed resolution of : Lcom/getkeepsafe/relinker/ReLinker ; at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:90 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:307 ) at com.borg.forza.activities.Forza.setupRealm ( Forza.java:75 ) at com.borg.forza.activities.Forza.onCreate ( Forza.java:63 ) at android.app.Instrumentation.callApplicationOnCreate ( Instrumentation.java:1034 ) at android.app.ActivityThread.handleBindApplication ( ActivityThread.java:4605 ) at android.app.ActivityThread.access $ 1500 ( ActivityThread.java:148 ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1353 ) at android.os.Handler.dispatchMessage ( Handler.java:102 ) at android.os.Looper.loop ( Looper.java:135 ) at android.app.ActivityThread.main ( ActivityThread.java:5312 ) at java.lang.reflect.Method.invoke ( Native Method ) at java.lang.reflect.Method.invoke ( Method.java:372 ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:901 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:696 ) Caused by : java.lang.ClassNotFoundException : Did n't find class `` com.getkeepsafe.relinker.ReLinker '' on path : DexPathList [ [ zip file `` /mnt/asec/com.borg.forza-1/base.apk '' ] , nativeLibraryDirectories= [ /mnt/asec/com.borg.forza-1/lib/arm , /vendor/lib , /system/lib ] ] at dalvik.system.BaseDexClassLoader.findClass ( BaseDexClassLoader.java:56 ) at java.lang.ClassLoader.loadClass ( ClassLoader.java:511 ) at java.lang.ClassLoader.loadClass ( ClassLoader.java:469 ) at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:90 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:307 ) at com.borg.forza.activities.Forza.setupRealm ( Forza.java:75 ) at com.borg.forza.activities.Forza.onCreate ( Forza.java:63 ) at android.app.Instrumentation.callApplicationOnCreate ( Instrumentation.java:1034 ) `
diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java index 6f00668..2e272cc 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java @ @ -2053,19 +2053,25 @ @ public class RealmTests { } } - // FIXME HandlerThread + // This test assure that calling refresh will not trigger local listeners + // after the Looper receives REALM_CHANGE message @ Test - public void processLocalListenersAfterRefresh ( ) throws InterruptedException { + public void processRefreshLocalListenersAfterLooperQueueStart ( ) throws Throwable { // Used to validate the result final AtomicBoolean listenerWasCalled = new AtomicBoolean ( false ) ; final AtomicBoolean typeListenerWasCalled = new AtomicBoolean ( false ) ; // Used by the background thread to wait for the main thread to do the write operation final CountDownLatch bgThreadLatch = new CountDownLatch ( 1 ) ; - final CountDownLatch bgClosedLatch = new CountDownLatch ( 1 ) ; + final CountDownLatch bgClosedLatch = new CountDownLatch ( 2 ) ; final CountDownLatch bgThreadReadyLatch = new CountDownLatch ( 1 ) ; + final CountDownLatch signalClosedRealm = new CountDownLatch ( 1 ) ; - Thread backgroundThread = new Thread ( ) { + final Looper [ ] looper = new Looper [ 1 ] ; + final Throwable [ ] throwable = new Throwable [ 1 ] ReLinker NoClassDefFoundError exception __EoT__ Using 8.8.0-SNAPSHOT : java.lang.NoClassDefFoundError : Failed resolution of : Lcom/getkeepsafe/relinker/ReLinker ; at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:90 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:307 ) at com.borg.forza.activities.Forza.setupRealm ( Forza.java:75 ) at com.borg.forza.activities.Forza.onCreate ( Forza.java:63 ) at android.app.Instrumentation.callApplicationOnCreate ( Instrumentation.java:1034 ) at android.app.ActivityThread.handleBindApplication ( ActivityThread.java:4605 ) at android.app.ActivityThread.access $ 1500 ( ActivityThread.java:148 ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1353 ) at android.os.Handler.dispatchMessage ( Handler.java:102 ) at android.os.Looper.loop ( Looper.java:135 ) at android.app.ActivityThread.main ( ActivityThread.java:5312 ) at java.lang.reflect.Method.invoke ( Native Method ) at java.lang.reflect.Method.invoke ( Method.java:372 ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:901 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:696 ) Caused by : java.lang.ClassNotFoundException : Did n't find class `` com.getkeepsafe.relinker.ReLinker '' on path : DexPathList [ [ zip file `` /mnt/asec/com.borg.forza-1/base.apk '' ] , nativeLibraryDirectories= [ /mnt/asec/com.borg.forza-1/lib/arm , /vendor/lib , /system/lib ] ] at dalvik.system.BaseDexClassLoader.findClass ( BaseDexClassLoader.java:56 ) at java.lang.ClassLoader.loadClass ( ClassLoader.java:511 ) at java.lang.ClassLoader.loadClass ( ClassLoader.java:469 ) at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:90 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:307 ) at com.borg.forza.activities.Forza.setupRealm ( Forza.java:75 ) at com.borg.forza.activities.Forza.onCreate ( Forza.java:63 ) at android.app.Instrumentation.callApplicationOnCreate ( Instrumentation.java:1034 ) `
diff -- git a/realm/realm-jni/src/io_realm_internal_TableView.h b/realm/realm-jni/src/io_realm_internal_TableView.h index 63c986e..4afb233 100644 -- - a/realm/realm-jni/src/io_realm_internal_TableView.h +++ b/realm/realm-jni/src/io_realm_internal_TableView.h @ @ -561,10 +561,10 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_TableView_nativePivot /* * Class : io_realm_internal_TableView - * Method : nativeSync + * Method : nativeSyncIfNeeded * Signature : ( J ) J */ -JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSync +JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSyncIfNeeded ( JNIEnv * , jobject , jlong ) ; /* diff -- git a/realm/realm-jni/src/io_realm_internal_tableview.cpp b/realm/realm-jni/src/io_realm_internal_tableview.cpp index 93d2fd0..0b3fb74 100644 -- - a/realm/realm-jni/src/io_realm_internal_tableview.cpp +++ b/realm/realm-jni/src/io_realm_internal_tableview.cpp @ @ -34,7 +34,12 @ @ inline bool view_valid_and_in_sync ( JNIEnv* env , jlong nativeViewPtr ) { ThrowException ( env , TableInvalid , `` The Realm has been closed and is no longer accessible . `` ) ; return false ; } - TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + if ( ! TV ( nativeViewPtr ) - > is_in_sync ( ) & & TV ( nativeViewPtr ) - > outside_version ( ) == std : :numeric_limits < uint64_t > : :max ( ) ) { + // This table view is no longer valid . By calling sync_if_needed we ensure it behaves + // properly as a 0-size TableView . + TV ( nativeViewPtr ) - > sync_if_needed ReLinker NoClassDefFoundError exception __EoT__ Using 8.8.0-SNAPSHOT : java.lang.NoClassDefFoundError : Failed resolution of : Lcom/getkeepsafe/relinker/ReLinker ; at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:90 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:307 ) at com.borg.forza.activities.Forza.setupRealm ( Forza.java:75 ) at com.borg.forza.activities.Forza.onCreate ( Forza.java:63 ) at android.app.Instrumentation.callApplicationOnCreate ( Instrumentation.java:1034 ) at android.app.ActivityThread.handleBindApplication ( ActivityThread.java:4605 ) at android.app.ActivityThread.access $ 1500 ( ActivityThread.java:148 ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1353 ) at android.os.Handler.dispatchMessage ( Handler.java:102 ) at android.os.Looper.loop ( Looper.java:135 ) at android.app.ActivityThread.main ( ActivityThread.java:5312 ) at java.lang.reflect.Method.invoke ( Native Method ) at java.lang.reflect.Method.invoke ( Method.java:372 ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:901 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:696 ) Caused by : java.lang.ClassNotFoundException : Did n't find class `` com.getkeepsafe.relinker.ReLinker '' on path : DexPathList [ [ zip file `` /mnt/asec/com.borg.forza-1/base.apk '' ] , nativeLibraryDirectories= [ /mnt/asec/com.borg.forza-1/lib/arm , /vendor/lib , /system/lib ] ] at dalvik.system.BaseDexClassLoader.findClass ( BaseDexClassLoader.java:56 ) at java.lang.ClassLoader.loadClass ( ClassLoader.java:511 ) at java.lang.ClassLoader.loadClass ( ClassLoader.java:469 ) at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:90 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:307 ) at com.borg.forza.activities.Forza.setupRealm ( Forza.java:75 ) at com.borg.forza.activities.Forza.onCreate ( Forza.java:63 ) at android.app.Instrumentation.callApplicationOnCreate ( Instrumentation.java:1034 ) `
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 21c5444..008b31b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,7 +1,19 @ @ # # 0.89.0 - # # # Enhancements + # # # Breaking changes +* RealmResults.clear ( ) now throws UnsupportedOperationException . Use RealmResults.deleteAllFromRealm ( ) instead . +* RealmResults.remove ( int ) now throws UnsupportedOperationException . Use RealmResults.deleteFromRealm ( ) instead . + + # # # Deprecated + +* RealmObject.removeFromRealm ( ) in place of RealmObject.deleteFromRealm ( ) +* Realm.clear ( Class ) in place of Realm.delete ( Class ) . +* DynamicRealm.clear ( Class ) in place of DynamicRealm.delete ( Class ) . + + # # # Enhancements +* RealmCollection and OrderedRealmCollection have been added . RealmList and RealmResults both implement these interfaces . +* RealmBaseAdapter now accept an OrderedRealmCollection instead of only RealmResults . * RealmObjectSchema.isPrimaryKey ( String ) ( # 2440 ) # # # Bug fixes diff -- git a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java index 69915fc..3a4afc8 100644 -- - a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java +++ b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java @ @ -54,7 +54,7 @ @ public class AdapterExampleActivity extends Activity { listView.setOnItemLongClickListener ( new AdapterView.OnItemLongClickListener ( ) { @ Override public boolean onItemLongClick ( AdapterView < ? > adapterView , View view , int ReLinker NoClassDefFoundError exception __EoT__ Using 8.8.0-SNAPSHOT : java.lang.NoClassDefFoundError : Failed resolution of : Lcom/getkeepsafe/relinker/ReLinker ; at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:90 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:307 ) at com.borg.forza.activities.Forza.setupRealm ( Forza.java:75 ) at com.borg.forza.activities.Forza.onCreate ( Forza.java:63 ) at android.app.Instrumentation.callApplicationOnCreate ( Instrumentation.java:1034 ) at android.app.ActivityThread.handleBindApplication ( ActivityThread.java:4605 ) at android.app.ActivityThread.access $ 1500 ( ActivityThread.java:148 ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1353 ) at android.os.Handler.dispatchMessage ( Handler.java:102 ) at android.os.Looper.loop ( Looper.java:135 ) at android.app.ActivityThread.main ( ActivityThread.java:5312 ) at java.lang.reflect.Method.invoke ( Native Method ) at java.lang.reflect.Method.invoke ( Method.java:372 ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:901 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:696 ) Caused by : java.lang.ClassNotFoundException : Did n't find class `` com.getkeepsafe.relinker.ReLinker '' on path : DexPathList [ [ zip file `` /mnt/asec/com.borg.forza-1/base.apk '' ] , nativeLibraryDirectories= [ /mnt/asec/com.borg.forza-1/lib/arm , /vendor/lib , /system/lib ] ] at dalvik.system.BaseDexClassLoader.findClass ( BaseDexClassLoader.java:56 ) at java.lang.ClassLoader.loadClass ( ClassLoader.java:511 ) at java.lang.ClassLoader.loadClass ( ClassLoader.java:469 ) at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:90 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:307 ) at com.borg.forza.activities.Forza.setupRealm ( Forza.java:75 ) at com.borg.forza.activities.Forza.onCreate ( Forza.java:63 ) at android.app.Instrumentation.callApplicationOnCreate ( Instrumentation.java:1034 ) `
diff -- git a/realm/realm-jni/src/io_realm_internal_TableView.h b/realm/realm-jni/src/io_realm_internal_TableView.h index 63c986e..4afb233 100644 -- - a/realm/realm-jni/src/io_realm_internal_TableView.h +++ b/realm/realm-jni/src/io_realm_internal_TableView.h @ @ -561,10 +561,10 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_TableView_nativePivot /* * Class : io_realm_internal_TableView - * Method : nativeSync + * Method : nativeSyncIfNeeded * Signature : ( J ) J */ -JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSync +JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSyncIfNeeded ( JNIEnv * , jobject , jlong ) ; /* diff -- git a/realm/realm-jni/src/io_realm_internal_tableview.cpp b/realm/realm-jni/src/io_realm_internal_tableview.cpp index 93d2fd0..e1f6ad2 100644 -- - a/realm/realm-jni/src/io_realm_internal_tableview.cpp +++ b/realm/realm-jni/src/io_realm_internal_tableview.cpp @ @ -34,7 +34,12 @ @ inline bool view_valid_and_in_sync ( JNIEnv* env , jlong nativeViewPtr ) { ThrowException ( env , TableInvalid , `` The Realm has been closed and is no longer accessible . `` ) ; return false ; } - TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + if ( ! TV ( nativeViewPtr ) - > is_in_sync ( ) & & TV ( nativeViewPtr ) - > depends_on_deleted_linklist ( ) ) { + // This table view is no longer valid . By calling sync_if_needed we ensure it behaves + // properly as a 0-size TableView . + TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + } + } return valid ; } ReLinker NoClassDefFoundError exception __EoT__ Using 8.8.0-SNAPSHOT : java.lang.NoClassDefFoundError : Failed resolution of : Lcom/getkeepsafe/relinker/ReLinker ; at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:90 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:307 ) at com.borg.forza.activities.Forza.setupRealm ( Forza.java:75 ) at com.borg.forza.activities.Forza.onCreate ( Forza.java:63 ) at android.app.Instrumentation.callApplicationOnCreate ( Instrumentation.java:1034 ) at android.app.ActivityThread.handleBindApplication ( ActivityThread.java:4605 ) at android.app.ActivityThread.access $ 1500 ( ActivityThread.java:148 ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1353 ) at android.os.Handler.dispatchMessage ( Handler.java:102 ) at android.os.Looper.loop ( Looper.java:135 ) at android.app.ActivityThread.main ( ActivityThread.java:5312 ) at java.lang.reflect.Method.invoke ( Native Method ) at java.lang.reflect.Method.invoke ( Method.java:372 ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:901 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:696 ) Caused by : java.lang.ClassNotFoundException : Did n't find class `` com.getkeepsafe.relinker.ReLinker '' on path : DexPathList [ [ zip file `` /mnt/asec/com.borg.forza-1/base.apk '' ] , nativeLibraryDirectories= [ /mnt/asec/com.borg.forza-1/lib/arm , /vendor/lib , /system/lib ] ] at dalvik.system.BaseDexClassLoader.findClass ( BaseDexClassLoader.java:56 ) at java.lang.ClassLoader.loadClass ( ClassLoader.java:511 ) at java.lang.ClassLoader.loadClass ( ClassLoader.java:469 ) at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:90 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:307 ) at com.borg.forza.activities.Forza.setupRealm ( Forza.java:75 ) at com.borg.forza.activities.Forza.onCreate ( Forza.java:63 ) at android.app.Instrumentation.callApplicationOnCreate ( Instrumentation.java:1034 ) `
diff -- git a/.gitignore b/.gitignore index a72b66b..b52f87b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -26,6 +26,7 @ @ realm_version_check.timestamp # Build artifacts *.so +*.dylib *.d *.o diff -- git a/build.gradle b/build.gradle index ea3c98d..ebe5b67 100644 -- - a/build.gradle +++ b/build.gradle @ @ -93,6 +93,16 @ @ task installRealmJava ( type : Task ) { description = 'Install the Realm library and Gradle plugin into mavenLocal ( ) ' } +task assembleRobolectric ( type : GradleBuild ) { + buildFile = file ( 'realm/build.gradle ' ) + tasks = [ 'assembleRobolectric ' ] + } + +task testRobolectric ( type : GradleBuild ) { + buildFile = file ( 'examples/robolectricExample/build.gradle ' ) + tasks = [ 'test ' ] + } + task assembleExamples ( type : GradleBuild ) { dependsOn installGradlePlugin dependsOn installRealm diff -- git a/examples/robolectricExample/build.gradle b/examples/robolectricExample/build.gradle new file mode 100644 index 0000000..28f4811 -- - /dev/null +++ b/examples/robolectricExample/build.gradle @ @ -0,0 +1,49 @ @ +buildscript { + repositories { + jcenter ( ) + } + dependencies { + classpath 'com.android.tools.build : gradle:1.3.0' + } + } + +repositories { + jcenter ( ) + } + +//apply plugin : 'android-sdk-manager' +apply plugin : 'com.android.application' +//apply plugin : 'android-command' java.lang.UnsatisfiedLinkError on tests running 0.88.2 with Kotlin __EoT__ Greetings , Upgrading from 0.87.5 to 0.88.2 produces a ` java.lang.UnsatisfiedLinkError ` when running Robolectric unit tests in a Kotlin project . Previously , I used the following dependency setup ( taken from # 509 ) , which worked fine : `` ` compile `` io.realm : realm-android-library:0.87.5 @ aar '' compile `` io.realm : realm-annotations:0.87.5 '' kapt `` io.realm : realm-annotations-processor:0.87.5 '' kapt `` io.realm : realm-annotations:0.87.5 '' `` ` Upgrading to version 0.88.2 produces the following error when running tests : `` ` java.lang.UnsatisfiedLinkError : Ca n't load library : /var/folders/mv/pfq8mc1j1kldmhvb600_09t40000gn/T/android-tmp-robolectric4118687178846717807/app_lib/librealm-jni.dylib at java.lang.ClassLoader.loadLibrary ( ClassLoader.java:1854 ) at java.lang.Runtime.load0 ( Runtime.java:795 ) at java.lang.System.load ( System.java:1062 ) at io.realm.internal.android.ReLinker.loadLibrary ( ReLinker.java:75 ) at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:89 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:338 ) at com.maxwellforest.safedome.util.database.RealmUtils.init ( RealmUtils.kt:21 ) at com.maxwellforest.safedome.SafedomeApplication.onCreate ( SafedomeApplication.kt:58 ) at org.robolectric.internal.ParallelUniverse.setUpApplicationState ( ParallelUniverse.java:140 ) at org.robolectric.RobolectricTestRunner.setUpApplicationState ( RobolectricTestRunner.java:433 ) at org.robolectric.RobolectricTestRunner $ 2.evaluate ( RobolectricTestRunner.java:240 ) at org.robolectric.RobolectricTestRunner.runChild ( RobolectricTestRunner.java:188 ) at org.robolectric.RobolectricTestRunner.runChild ( RobolectricTestRunner.java:54 ) at org.junit.runners.ParentRunner $ 3.run ( ParentRunner.java:290 ) at org.junit.runners.ParentRunner $ 1.schedule ( ParentRunner.java:71 ) at org.junit.runners.ParentRunner.runChildren ( ParentRunner.java:288 ) at org.junit.runners.ParentRunner.access $ 000 ( ParentRunner.java:58 ) at
diff -- git a/.gitignore b/.gitignore index a72b66b..b52f87b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -26,6 +26,7 @ @ realm_version_check.timestamp # Build artifacts *.so +*.dylib *.d *.o diff -- git a/build.gradle b/build.gradle index b086592..0bdd835 100644 -- - a/build.gradle +++ b/build.gradle @ @ -93,6 +93,21 @ @ task installRealmJava ( type : Task ) { description = 'Install the Realm library and Gradle plugin into mavenLocal ( ) ' } +task installRobolectric ( type : GradleBuild ) { + buildFile = file ( 'realm/build.gradle ' ) + tasks = [ 'installRobolectric ' ] + } + +task buildRobolectric ( type : GradleBuild ) { + buildFile = file ( 'realm/build.gradle ' ) + tasks = [ 'buildRobolectric ' ] + } + +task testRobolectric ( type : GradleBuild ) { + buildFile = file ( 'examples/robolectricExample/build.gradle ' ) + tasks = [ 'test ' ] + } + task assembleExamples ( type : GradleBuild ) { dependsOn installGradlePlugin dependsOn installRealm diff -- git a/examples/robolectricExample/build.gradle b/examples/robolectricExample/build.gradle new file mode 100644 index 0000000..c23775e -- - /dev/null +++ b/examples/robolectricExample/build.gradle @ @ -0,0 +1,41 @ @ +apply plugin : 'android-sdk-manager' +apply plugin : 'com.android.application' +apply plugin : 'android-command' +apply plugin : 'com.neenbedankt.android-apt' +apply plugin : java.lang.UnsatisfiedLinkError on tests running 0.88.2 with Kotlin __EoT__ Greetings , Upgrading from 0.87.5 to 0.88.2 produces a ` java.lang.UnsatisfiedLinkError ` when running Robolectric unit tests in a Kotlin project . Previously , I used the following dependency setup ( taken from # 509 ) , which worked fine : `` ` compile `` io.realm : realm-android-library:0.87.5 @ aar '' compile `` io.realm : realm-annotations:0.87.5 '' kapt `` io.realm : realm-annotations-processor:0.87.5 '' kapt `` io.realm : realm-annotations:0.87.5 '' `` ` Upgrading to version 0.88.2 produces the following error when running tests : `` ` java.lang.UnsatisfiedLinkError : Ca n't load library : /var/folders/mv/pfq8mc1j1kldmhvb600_09t40000gn/T/android-tmp-robolectric4118687178846717807/app_lib/librealm-jni.dylib at java.lang.ClassLoader.loadLibrary ( ClassLoader.java:1854 ) at java.lang.Runtime.load0 ( Runtime.java:795 ) at java.lang.System.load ( System.java:1062 ) at io.realm.internal.android.ReLinker.loadLibrary ( ReLinker.java:75 ) at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:89 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:338 ) at com.maxwellforest.safedome.util.database.RealmUtils.init ( RealmUtils.kt:21 ) at com.maxwellforest.safedome.SafedomeApplication.onCreate ( SafedomeApplication.kt:58 ) at org.robolectric.internal.ParallelUniverse.setUpApplicationState ( ParallelUniverse.java:140 ) at org.robolectric.RobolectricTestRunner.setUpApplicationState ( RobolectricTestRunner.java:433 ) at org.robolectric.RobolectricTestRunner $ 2.evaluate ( RobolectricTestRunner.java:240 ) at org.robolectric.RobolectricTestRunner.runChild ( RobolectricTestRunner.java:188 ) at org.robolectric.RobolectricTestRunner.runChild ( RobolectricTestRunner.java:54 ) at org.junit.runners.ParentRunner $ 3.run ( ParentRunner.java:290 ) at org.junit.runners.ParentRunner $ 1.schedule ( ParentRunner.java:71 ) at org.junit.runners.ParentRunner.runChildren ( ParentRunner.java:288 ) at org.junit.runners.ParentRunner.access $ 000 ( ParentRunner.java:58 ) at
diff -- git a/.gitignore b/.gitignore index a72b66b..b52f87b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -26,6 +26,7 @ @ realm_version_check.timestamp # Build artifacts *.so +*.dylib *.d *.o diff -- git a/build.gradle b/build.gradle index b086592..ed00b58 100644 -- - a/build.gradle +++ b/build.gradle @ @ -93,6 +93,18 @ @ task installRealmJava ( type : Task ) { description = 'Install the Realm library and Gradle plugin into mavenLocal ( ) ' } +task installRobolectric ( type : GradleBuild ) { + description = 'Install the Robolectric libary into example' + buildFile = file ( 'realm/build.gradle ' ) + tasks = [ 'installRobolectric ' ] + } + +task assembleRobolectric ( type : GradleBuild ) { + description = 'Assemble the Robolectric support' + buildFile = file ( 'realm/build.gradle ' ) + tasks = [ 'assembleRobolectric ' ] + } + task assembleExamples ( type : GradleBuild ) { dependsOn installGradlePlugin dependsOn installRealm diff -- git a/examples/robolectricExample/build.gradle b/examples/robolectricExample/build.gradle new file mode 100644 index 0000000..c23775e -- - /dev/null +++ b/examples/robolectricExample/build.gradle @ @ -0,0 +1,41 @ @ +apply plugin : 'android-sdk-manager' +apply plugin : 'com.android.application' +apply plugin : 'android-command' +apply plugin : 'com.neenbedankt.android-apt' +apply plugin : 'realm-android' + +def currentVersion = file ( `` $ { java.lang.UnsatisfiedLinkError on tests running 0.88.2 with Kotlin __EoT__ Greetings , Upgrading from 0.87.5 to 0.88.2 produces a ` java.lang.UnsatisfiedLinkError ` when running Robolectric unit tests in a Kotlin project . Previously , I used the following dependency setup ( taken from # 509 ) , which worked fine : `` ` compile `` io.realm : realm-android-library:0.87.5 @ aar '' compile `` io.realm : realm-annotations:0.87.5 '' kapt `` io.realm : realm-annotations-processor:0.87.5 '' kapt `` io.realm : realm-annotations:0.87.5 '' `` ` Upgrading to version 0.88.2 produces the following error when running tests : `` ` java.lang.UnsatisfiedLinkError : Ca n't load library : /var/folders/mv/pfq8mc1j1kldmhvb600_09t40000gn/T/android-tmp-robolectric4118687178846717807/app_lib/librealm-jni.dylib at java.lang.ClassLoader.loadLibrary ( ClassLoader.java:1854 ) at java.lang.Runtime.load0 ( Runtime.java:795 ) at java.lang.System.load ( System.java:1062 ) at io.realm.internal.android.ReLinker.loadLibrary ( ReLinker.java:75 ) at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:89 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:338 ) at com.maxwellforest.safedome.util.database.RealmUtils.init ( RealmUtils.kt:21 ) at com.maxwellforest.safedome.SafedomeApplication.onCreate ( SafedomeApplication.kt:58 ) at org.robolectric.internal.ParallelUniverse.setUpApplicationState ( ParallelUniverse.java:140 ) at org.robolectric.RobolectricTestRunner.setUpApplicationState ( RobolectricTestRunner.java:433 ) at org.robolectric.RobolectricTestRunner $ 2.evaluate ( RobolectricTestRunner.java:240 ) at org.robolectric.RobolectricTestRunner.runChild ( RobolectricTestRunner.java:188 ) at org.robolectric.RobolectricTestRunner.runChild ( RobolectricTestRunner.java:54 ) at org.junit.runners.ParentRunner $ 3.run ( ParentRunner.java:290 ) at org.junit.runners.ParentRunner $ 1.schedule ( ParentRunner.java:71 ) at org.junit.runners.ParentRunner.runChildren ( ParentRunner.java:288 ) at org.junit.runners.ParentRunner.access $ 000 ( ParentRunner.java:58 ) at
diff -- git a/.gitignore b/.gitignore index a72b66b..b52f87b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -26,6 +26,7 @ @ realm_version_check.timestamp # Build artifacts *.so +*.dylib *.d *.o diff -- git a/build.gradle b/build.gradle index b086592..56ccae3 100644 -- - a/build.gradle +++ b/build.gradle @ @ -93,6 +93,18 @ @ task installRealmJava ( type : Task ) { description = 'Install the Realm library and Gradle plugin into mavenLocal ( ) ' } +task installRobolectric ( type : GradleBuild ) { + description = 'Install the Robolectric libary into example' + buildFile = file ( 'realm/build.gradle ' ) + tasks = [ 'installRobolectric ' ] + } + +task assembleRobolectric ( type : GradleBuild ) { + description = 'Assemble the Robolectric support' + buildFile = file ( 'realm/build.gradle ' ) + tasks = [ 'assembleRobolectric ' ] + } + task assembleExamples ( type : GradleBuild ) { dependsOn installGradlePlugin dependsOn installRealm @ @ -195,6 +207,16 @ @ task distributionPackage ( type : Zip ) { } } +task createRobolectricDistributionPackages ( type : Zip ) { + description = 'Create the Robolectric distribution package' + dependsOn assembleRobolectric + + archiveName = `` realm-robolectric-darwin- $ { currentVersion } .zip '' + destinationDir = file java.lang.UnsatisfiedLinkError on tests running 0.88.2 with Kotlin __EoT__ Greetings , Upgrading from 0.87.5 to 0.88.2 produces a ` java.lang.UnsatisfiedLinkError ` when running Robolectric unit tests in a Kotlin project . Previously , I used the following dependency setup ( taken from # 509 ) , which worked fine : `` ` compile `` io.realm : realm-android-library:0.87.5 @ aar '' compile `` io.realm : realm-annotations:0.87.5 '' kapt `` io.realm : realm-annotations-processor:0.87.5 '' kapt `` io.realm : realm-annotations:0.87.5 '' `` ` Upgrading to version 0.88.2 produces the following error when running tests : `` ` java.lang.UnsatisfiedLinkError : Ca n't load library : /var/folders/mv/pfq8mc1j1kldmhvb600_09t40000gn/T/android-tmp-robolectric4118687178846717807/app_lib/librealm-jni.dylib at java.lang.ClassLoader.loadLibrary ( ClassLoader.java:1854 ) at java.lang.Runtime.load0 ( Runtime.java:795 ) at java.lang.System.load ( System.java:1062 ) at io.realm.internal.android.ReLinker.loadLibrary ( ReLinker.java:75 ) at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:89 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:338 ) at com.maxwellforest.safedome.util.database.RealmUtils.init ( RealmUtils.kt:21 ) at com.maxwellforest.safedome.SafedomeApplication.onCreate ( SafedomeApplication.kt:58 ) at org.robolectric.internal.ParallelUniverse.setUpApplicationState ( ParallelUniverse.java:140 ) at org.robolectric.RobolectricTestRunner.setUpApplicationState ( RobolectricTestRunner.java:433 ) at org.robolectric.RobolectricTestRunner $ 2.evaluate ( RobolectricTestRunner.java:240 ) at org.robolectric.RobolectricTestRunner.runChild ( RobolectricTestRunner.java:188 ) at org.robolectric.RobolectricTestRunner.runChild ( RobolectricTestRunner.java:54 ) at org.junit.runners.ParentRunner $ 3.run ( ParentRunner.java:290 ) at org.junit.runners.ParentRunner $ 1.schedule ( ParentRunner.java:71 ) at org.junit.runners.ParentRunner.runChildren ( ParentRunner.java:288 ) at org.junit.runners.ParentRunner.access $ 000 ( ParentRunner.java:58 ) at
diff -- git a/.gitignore b/.gitignore index a72b66b..b52f87b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -26,6 +26,7 @ @ realm_version_check.timestamp # Build artifacts *.so +*.dylib *.d *.o diff -- git a/build.gradle b/build.gradle index b086592..9c32da6 100644 -- - a/build.gradle +++ b/build.gradle @ @ -93,6 +93,18 @ @ task installRealmJava ( type : Task ) { description = 'Install the Realm library and Gradle plugin into mavenLocal ( ) ' } +task installRobolectric ( type : GradleBuild ) { + description = 'Install the Robolectric library into example' + buildFile = file ( 'realm/build.gradle ' ) + tasks = [ 'installRobolectric ' ] + } + +task assembleRobolectric ( type : GradleBuild ) { + description = 'Assemble the Robolectric support' + buildFile = file ( 'realm/build.gradle ' ) + tasks = [ 'assembleRobolectric ' ] + } + task assembleExamples ( type : GradleBuild ) { dependsOn installGradlePlugin dependsOn installRealm @ @ -195,6 +207,16 @ @ task distributionPackage ( type : Zip ) { } } +task createRobolectricDistributionPackages ( type : Zip ) { + description = 'Create the Robolectric distribution package' + dependsOn assembleRobolectric + + archiveName = `` realm-robolectric-darwin- $ { currentVersion } .zip '' + destinationDir = file java.lang.UnsatisfiedLinkError on tests running 0.88.2 with Kotlin __EoT__ Greetings , Upgrading from 0.87.5 to 0.88.2 produces a ` java.lang.UnsatisfiedLinkError ` when running Robolectric unit tests in a Kotlin project . Previously , I used the following dependency setup ( taken from # 509 ) , which worked fine : `` ` compile `` io.realm : realm-android-library:0.87.5 @ aar '' compile `` io.realm : realm-annotations:0.87.5 '' kapt `` io.realm : realm-annotations-processor:0.87.5 '' kapt `` io.realm : realm-annotations:0.87.5 '' `` ` Upgrading to version 0.88.2 produces the following error when running tests : `` ` java.lang.UnsatisfiedLinkError : Ca n't load library : /var/folders/mv/pfq8mc1j1kldmhvb600_09t40000gn/T/android-tmp-robolectric4118687178846717807/app_lib/librealm-jni.dylib at java.lang.ClassLoader.loadLibrary ( ClassLoader.java:1854 ) at java.lang.Runtime.load0 ( Runtime.java:795 ) at java.lang.System.load ( System.java:1062 ) at io.realm.internal.android.ReLinker.loadLibrary ( ReLinker.java:75 ) at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:89 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:338 ) at com.maxwellforest.safedome.util.database.RealmUtils.init ( RealmUtils.kt:21 ) at com.maxwellforest.safedome.SafedomeApplication.onCreate ( SafedomeApplication.kt:58 ) at org.robolectric.internal.ParallelUniverse.setUpApplicationState ( ParallelUniverse.java:140 ) at org.robolectric.RobolectricTestRunner.setUpApplicationState ( RobolectricTestRunner.java:433 ) at org.robolectric.RobolectricTestRunner $ 2.evaluate ( RobolectricTestRunner.java:240 ) at org.robolectric.RobolectricTestRunner.runChild ( RobolectricTestRunner.java:188 ) at org.robolectric.RobolectricTestRunner.runChild ( RobolectricTestRunner.java:54 ) at org.junit.runners.ParentRunner $ 3.run ( ParentRunner.java:290 ) at org.junit.runners.ParentRunner $ 1.schedule ( ParentRunner.java:71 ) at org.junit.runners.ParentRunner.runChildren ( ParentRunner.java:288 ) at org.junit.runners.ParentRunner.access $ 000 ( ParentRunner.java:58 ) at
diff -- git a/.gitignore b/.gitignore index a72b66b..b52f87b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -26,6 +26,7 @ @ realm_version_check.timestamp # Build artifacts *.so +*.dylib *.d *.o diff -- git a/build.gradle b/build.gradle index 4f756b4..45eabf5 100644 -- - a/build.gradle +++ b/build.gradle @ @ -69,6 +69,20 @ @ task installRealmJava ( type : Task ) { description = 'Install the Realm library and Gradle plugin into mavenLocal ( ) ' } +task installRobolectric ( type : GradleBuild ) { + description = 'Install the Robolectric library into example' + group = 'Install' + buildFile = file ( 'realm/build.gradle ' ) + tasks = [ 'installRobolectric ' ] + } + +task assembleRobolectric ( type : GradleBuild ) { + description = 'Assemble the Robolectric support' + group = 'Build' + buildFile = file ( 'realm/build.gradle ' ) + tasks = [ 'assembleRobolectric ' ] + } + task assembleExamples ( type : GradleBuild ) { dependsOn installGradlePlugin dependsOn installRealm @ @ -171,6 +185,16 @ @ task distributionPackage ( type : Zip ) { } } +task createRobolectricDistributionPackages ( type : Zip ) { + description = 'Create the Robolectric distribution package' + dependsOn assembleRobolectric + + archiveName = `` realm-robolectric-darwin- $ { java.lang.UnsatisfiedLinkError on tests running 0.88.2 with Kotlin __EoT__ Greetings , Upgrading from 0.87.5 to 0.88.2 produces a ` java.lang.UnsatisfiedLinkError ` when running Robolectric unit tests in a Kotlin project . Previously , I used the following dependency setup ( taken from # 509 ) , which worked fine : `` ` compile `` io.realm : realm-android-library:0.87.5 @ aar '' compile `` io.realm : realm-annotations:0.87.5 '' kapt `` io.realm : realm-annotations-processor:0.87.5 '' kapt `` io.realm : realm-annotations:0.87.5 '' `` ` Upgrading to version 0.88.2 produces the following error when running tests : `` ` java.lang.UnsatisfiedLinkError : Ca n't load library : /var/folders/mv/pfq8mc1j1kldmhvb600_09t40000gn/T/android-tmp-robolectric4118687178846717807/app_lib/librealm-jni.dylib at java.lang.ClassLoader.loadLibrary ( ClassLoader.java:1854 ) at java.lang.Runtime.load0 ( Runtime.java:795 ) at java.lang.System.load ( System.java:1062 ) at io.realm.internal.android.ReLinker.loadLibrary ( ReLinker.java:75 ) at io.realm.internal.RealmCore.loadLibrary ( RealmCore.java:89 ) at io.realm.RealmConfiguration $ Builder. < init > ( RealmConfiguration.java:338 ) at com.maxwellforest.safedome.util.database.RealmUtils.init ( RealmUtils.kt:21 ) at com.maxwellforest.safedome.SafedomeApplication.onCreate ( SafedomeApplication.kt:58 ) at org.robolectric.internal.ParallelUniverse.setUpApplicationState ( ParallelUniverse.java:140 ) at org.robolectric.RobolectricTestRunner.setUpApplicationState ( RobolectricTestRunner.java:433 ) at org.robolectric.RobolectricTestRunner $ 2.evaluate ( RobolectricTestRunner.java:240 ) at org.robolectric.RobolectricTestRunner.runChild ( RobolectricTestRunner.java:188 ) at org.robolectric.RobolectricTestRunner.runChild ( RobolectricTestRunner.java:54 ) at org.junit.runners.ParentRunner $ 3.run ( ParentRunner.java:290 ) at org.junit.runners.ParentRunner $ 1.schedule ( ParentRunner.java:71 ) at org.junit.runners.ParentRunner.runChildren ( ParentRunner.java:288 ) at org.junit.runners.ParentRunner.access $ 000 ( ParentRunner.java:58 ) at
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..d211177 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp index 168dd34..86e1733 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp @ @ -23,6 +23,7 @ @ # include `` util.hpp '' # include `` jni_util/jni_utils.hpp '' + # include `` jni_util/hack.hpp '' using std : :string ; using namespace realm : :jni_util ; @ @ -37,6 +38,9 @ @ const string TABLE_PREFIX ( `` class_ '' ) ; JNIEXPORT jint JNICALL JNI_OnLoad ( JavaVM* vm , void* ) { + // Workaround some known bugs of system calls on some special devices . + hack_init ( ) ; + JNIEnv* env ; if ( vm- > GetEnv ( ( void** ) & env , JNI_VERSION_1_6 ) ! Fatal signal 11 ( SIGSEGV ) at 0x5f244ff2 ( code=2 ) , thread 26259 ( pool-9-thread-1 ) __EoT__ App crashes when running the app in a Samsung Galaxy Tab 3 Lite ( SM-T110 ) API 17 . Crashes on any realm versions tested ( 2.2.1 , 2.2.0 , 2.1.1 ) On any other devices and emulators ( with APIs as low as 16 ) we tested the app runs fine . Unfortunately , we do n't have another Samsung device to test . Steps : - Initialize the Realm in application - getInstance anywhere in mainActivity ( currently testing onCreate ) - > CRASH
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 5913e18..11c3d43 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -17,6 +17,10 @ @ set ( CMAKE_VERBOSE_MAKEFILE ON ) # Generate compile_commands.json set ( CMAKE_EXPORT_COMPILE_COMMANDS ON ) + # Initialize common compile & link flags . +set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_COMMON_CXX_FLAGS `` '' ) + # Setup lcache if ( NDK_LCACHE ) set ( CMAKE_CXX_CREATE_SHARED_LIBRARY `` $ { NDK_LCACHE } $ { CMAKE_CXX_CREATE_SHARED_LIBRARY } '' ) @ @ -123,6 +127,14 @ @ elseif ( ARMEABI_V7A ) set ( ABI_CXX_FLAGS `` -mthumb -march=armv7-a -mfloat-abi=softfp -mfpu=vfpv3-d16 '' ) endif ( ) + # Hack the memmove bug on Samsung device . +if ( ARMEABI OR ARMEABI_V7A ) + set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -Wl , -- wrap , memmove -Wl , -- wrap , memcpy '' ) + set ( REALM_COMMON_CXX_FLAGS `` $ { REALM_COMMON_CXX_FLAGS } -DREALM_WRAP_MEMMOVE=1 '' ) +else ( ) + set ( REALM_COMMON_CXX_FLAGS `` $ { REALM_COMMON_CXX_FLAGS } -DREALM_WRAP_MEMMOVE=0 '' ) +endif ( ) + # FIXME uninitialized is reported by query_expression.hpp:1070 # d.init ( ValueBase : :m_from_link_list , ValueBase : :m_values , D { } ) ; # FIXME maybe-uninitialized is reported by table_view.cpp:272:15 : @ Fatal signal 11 ( SIGSEGV ) at 0x5f244ff2 ( code=2 ) , thread 26259 ( pool-9-thread-1 ) __EoT__ App crashes when running the app in a Samsung Galaxy Tab 3 Lite ( SM-T110 ) API 17 . Crashes on any realm versions tested ( 2.2.1 , 2.2.0 , 2.1.1 ) On any other devices and emulators ( with APIs as low as 16 ) we tested the app runs fine . Unfortunately , we do n't have another Samsung device to test . Steps : - Initialize the Realm in application - getInstance anywhere in mainActivity ( currently testing onCreate ) - > CRASH
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..387d290 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -126,7 +126,7 @ @ endif ( ) set ( WARNING_CXX_FLAGS `` -Werror -Wall -Wextra -pedantic -Wmissing-declarations \ -Wempty-body -Wparentheses -Wunknown-pragmas -Wunreachable-code \ -Wno-missing-field-initializers -Wno-maybe-uninitialized -Wno-uninitialized '' ) -set ( REALM_COMMON_CXX_FLAGS `` -DREALM_ANDROID -DREALM_HAVE_CONFIG -DPIC -pthread -fvisibility=hidden -std=c++14 -fsigned-char '' ) +set ( REALM_COMMON_CXX_FLAGS `` -DREALM_ANDROID -DREALM_HAVE_CONFIG -DPIC -pthread -fvisibility=hidden -std=c++14 -fsigned-char -fno-builtin-memcpy -fno-builtin-memmove '' ) if ( build_SYNC ) set ( REALM_COMMON_CXX_FLAGS `` $ { REALM_COMMON_CXX_FLAGS } -DREALM_ENABLE_SYNC=1 '' ) endif ( ) @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove -Wl , -- wrap , memcpy '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp index b15798d..e037db6 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp @ @ -32,6 +32,8 @ @ # include `` sync/sync_manager.hpp '' # endif + # include Fatal signal 11 ( SIGSEGV ) at 0x5f244ff2 ( code=2 ) , thread 26259 ( pool-9-thread-1 ) __EoT__ App crashes when running the app in a Samsung Galaxy Tab 3 Lite ( SM-T110 ) API 17 . Crashes on any realm versions tested ( 2.2.1 , 2.2.0 , 2.1.1 ) On any other devices and emulators ( with APIs as low as 16 ) we tested the app runs fine . Unfortunately , we do n't have another Samsung device to test . Steps : - Initialize the Realm in application - getInstance anywhere in mainActivity ( currently testing onCreate ) - > CRASH
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 68770d3..3de652c 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,10 @ @ + # # 4.4.0 ( YYYY-MM-DD ) + + # # # Enhancements + +* Added support for partial Realms . Read [ here ] ( https : //realm.io/docs/java/latest/ # partial-realms ) for more information . + + # # 4.3.0 ( YYYY-MM-DD ) # # # Deprecated diff -- git a/realm/realm-library/src/main/cpp/collection_changeset_wrapper.hpp b/realm/realm-library/src/main/cpp/collection_changeset_wrapper.hpp new file mode 100644 index 0000000..af5ac52 -- - /dev/null +++ b/realm/realm-library/src/main/cpp/collection_changeset_wrapper.hpp @ @ -0,0 +1,77 @ @ +/* + * Copyright 2017 Realm Inc. + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License Partial Sync : Support named queries __EoT__ See https : //github.com/realm/product/issues/390 for details
diff -- git a/CHANGELOG.md b/CHANGELOG.md index df4a908..640d475 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,19 @ @ + # # 5.0.0 ( YYYY-MM-DD ) + + # # # Breaking Changes + +* The ` OrderedCollectionChangeSet ` parameter in ` OrderedRealmCollectionChangeListener.onChange ( ) ` is no longer nullable . Use ` changeSet.getState ( ) ` instead ( # 5619 ) . + + # # # Enhancements + +* Added support for partial Realms . Read [ here ] ( https : //realm.io/docs/java/latest/ # partial-realms ) for more information . +* Added two new methods to ` OrderedCollectionChangeSet ` : ` getState ( ) ` and ` getError ( ) ` ( # 5619 ) . + + # # # Internal + +* Upgraded to Realm Sync 2.2.1 . + + # # 4.3.2 ( YYYY-MM-DD ) # # # Bug Fixes diff -- git a/dependencies.list b/dependencies.list index 3703b72..2692489 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -1,7 +1,7 @ @ # Realm Sync Core release used by Realm Java # https : //github.com/realm/realm-sync/releases -REALM_SYNC_VERSION=2.1.8 -REALM_SYNC_SHA256=14e4aabe270638aa96f84396be27985b6809e532183035c5150dd2933d676248 +REALM_SYNC_VERSION=2.2.1 +REALM_SYNC_SHA256=47e29555cdb96beb1be75e13599e8d93c88f2a807c09f44b85a4286d81cb91b6 # Object Server Release used by Integration tests . Installed using NPM . # Use ` npm view realm-object-server Partial Sync : Support named queries __EoT__ See https : //github.com/realm/product/issues/390 for details
diff -- git a/CHANGELOG.md b/CHANGELOG.md index df4a908..4d813e0 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,19 @ @ + # # 5.0.0 ( YYYY-MM-DD ) + + # # # Breaking Changes + +* The ` OrderedCollectionChangeSet ` parameter in ` OrderedRealmCollectionChangeListener.onChange ( ) ` is no longer nullable . Use ` changeSet.getState ( ) ` instead ( # 5619 ) . + + # # # Enhancements + +* Added support for partial Realms . Read [ here ] ( https : //realm.io/docs/java/latest/ # partial-realms ) for more information . +* Added two new methods to ` OrderedCollectionChangeSet ` : ` getState ( ) ` and ` getError ( ) ` ( # 5619 ) . + + # # # Internal + +* Upgraded to Realm Sync 2.2.2 . + + # # 4.3.2 ( YYYY-MM-DD ) # # # Bug Fixes diff -- git a/dependencies.list b/dependencies.list index 3703b72..50c9b62 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -1,7 +1,7 @ @ # Realm Sync Core release used by Realm Java # https : //github.com/realm/realm-sync/releases -REALM_SYNC_VERSION=2.1.8 -REALM_SYNC_SHA256=14e4aabe270638aa96f84396be27985b6809e532183035c5150dd2933d676248 +REALM_SYNC_VERSION=2.2.2 +REALM_SYNC_SHA256=0a8bafaa59becca10a9740e69291abd217ee1fe0b44cfc8ee7ac1d52968e6c3d # Object Server Release used by Integration tests . Installed using NPM . # Use ` npm view realm-object-server Partial Sync : Support named queries __EoT__ See https : //github.com/realm/product/issues/390 for details
diff -- git a/CHANGELOG.md b/CHANGELOG.md index df4a908..4d813e0 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,19 @ @ + # # 5.0.0 ( YYYY-MM-DD ) + + # # # Breaking Changes + +* The ` OrderedCollectionChangeSet ` parameter in ` OrderedRealmCollectionChangeListener.onChange ( ) ` is no longer nullable . Use ` changeSet.getState ( ) ` instead ( # 5619 ) . + + # # # Enhancements + +* Added support for partial Realms . Read [ here ] ( https : //realm.io/docs/java/latest/ # partial-realms ) for more information . +* Added two new methods to ` OrderedCollectionChangeSet ` : ` getState ( ) ` and ` getError ( ) ` ( # 5619 ) . + + # # # Internal + +* Upgraded to Realm Sync 2.2.2 . + + # # 4.3.2 ( YYYY-MM-DD ) # # # Bug Fixes diff -- git a/dependencies.list b/dependencies.list index 3703b72..50c9b62 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -1,7 +1,7 @ @ # Realm Sync Core release used by Realm Java # https : //github.com/realm/realm-sync/releases -REALM_SYNC_VERSION=2.1.8 -REALM_SYNC_SHA256=14e4aabe270638aa96f84396be27985b6809e532183035c5150dd2933d676248 +REALM_SYNC_VERSION=2.2.2 +REALM_SYNC_SHA256=0a8bafaa59becca10a9740e69291abd217ee1fe0b44cfc8ee7ac1d52968e6c3d # Object Server Release used by Integration tests . Installed using NPM . # Use ` npm view realm-object-server Partial Sync : Support named queries __EoT__ See https : //github.com/realm/product/issues/390 for details
diff -- git a/CHANGELOG.md b/CHANGELOG.md index df4a908..4d813e0 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,19 @ @ + # # 5.0.0 ( YYYY-MM-DD ) + + # # # Breaking Changes + +* The ` OrderedCollectionChangeSet ` parameter in ` OrderedRealmCollectionChangeListener.onChange ( ) ` is no longer nullable . Use ` changeSet.getState ( ) ` instead ( # 5619 ) . + + # # # Enhancements + +* Added support for partial Realms . Read [ here ] ( https : //realm.io/docs/java/latest/ # partial-realms ) for more information . +* Added two new methods to ` OrderedCollectionChangeSet ` : ` getState ( ) ` and ` getError ( ) ` ( # 5619 ) . + + # # # Internal + +* Upgraded to Realm Sync 2.2.2 . + + # # 4.3.2 ( YYYY-MM-DD ) # # # Bug Fixes diff -- git a/dependencies.list b/dependencies.list index 3703b72..50c9b62 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -1,7 +1,7 @ @ # Realm Sync Core release used by Realm Java # https : //github.com/realm/realm-sync/releases -REALM_SYNC_VERSION=2.1.8 -REALM_SYNC_SHA256=14e4aabe270638aa96f84396be27985b6809e532183035c5150dd2933d676248 +REALM_SYNC_VERSION=2.2.2 +REALM_SYNC_SHA256=0a8bafaa59becca10a9740e69291abd217ee1fe0b44cfc8ee7ac1d52968e6c3d # Object Server Release used by Integration tests . Installed using NPM . # Use ` npm view realm-object-server Partial Sync : Support named queries __EoT__ See https : //github.com/realm/product/issues/390 for details
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..d211177 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp index b15798d..e037db6 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp @ @ -32,6 +32,8 @ @ # include `` sync/sync_manager.hpp '' # endif + # include `` jni_util/hack.hpp '' + using namespace realm ; using namespace realm : :_impl ; @ @ -57,6 +59,8 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_SharedRealm_nativeInit ( JNIEnv* env { TR_ENTER ( ) + hack_init ( ) ; + try { JStringAccessor path ( env , temporary_directory_path ) ; // throws SharedGroupOptions : :set_sys_tmp_dir ( std : :string ( path ) ) ; // throws diff -- git a/realm/realm-library/src/main/cpp/jni_util/hack.cpp b/realm/realm-library/src/main/cpp/jni_util/hack.cpp new file mode 100644 index 0000000..a196e53 -- - /dev/null +++ b/realm/realm-library/src/main/cpp/jni_util/hack.cpp @ @ Fatal signal 11 ( SIGSEGV ) at 0x5bb29ffe ( code=2 ) on API 17 ( 4.2.2 ) __EoT__ When I try to use Realm realm = Realm.getDefaultInstance ( ) ; the app gives that error while it runs well on 4.4 and above
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..d211177 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp index b15798d..e037db6 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp @ @ -32,6 +32,8 @ @ # include `` sync/sync_manager.hpp '' # endif + # include `` jni_util/hack.hpp '' + using namespace realm ; using namespace realm : :_impl ; @ @ -57,6 +59,8 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_SharedRealm_nativeInit ( JNIEnv* env { TR_ENTER ( ) + hack_init ( ) ; + try { JStringAccessor path ( env , temporary_directory_path ) ; // throws SharedGroupOptions : :set_sys_tmp_dir ( std : :string ( path ) ) ; // throws diff -- git a/realm/realm-library/src/main/cpp/jni_util/hack.cpp b/realm/realm-library/src/main/cpp/jni_util/hack.cpp new file mode 100644 index 0000000..d519183 -- - /dev/null +++ b/realm/realm-library/src/main/cpp/jni_util/hack.cpp @ @ Fatal signal 11 ( SIGSEGV ) at 0x5bb29ffe ( code=2 ) on API 17 ( 4.2.2 ) __EoT__ When I try to use Realm realm = Realm.getDefaultInstance ( ) ; the app gives that error while it runs well on 4.4 and above
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..387d290 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -126,7 +126,7 @ @ endif ( ) set ( WARNING_CXX_FLAGS `` -Werror -Wall -Wextra -pedantic -Wmissing-declarations \ -Wempty-body -Wparentheses -Wunknown-pragmas -Wunreachable-code \ -Wno-missing-field-initializers -Wno-maybe-uninitialized -Wno-uninitialized '' ) -set ( REALM_COMMON_CXX_FLAGS `` -DREALM_ANDROID -DREALM_HAVE_CONFIG -DPIC -pthread -fvisibility=hidden -std=c++14 -fsigned-char '' ) +set ( REALM_COMMON_CXX_FLAGS `` -DREALM_ANDROID -DREALM_HAVE_CONFIG -DPIC -pthread -fvisibility=hidden -std=c++14 -fsigned-char -fno-builtin-memcpy -fno-builtin-memmove '' ) if ( build_SYNC ) set ( REALM_COMMON_CXX_FLAGS `` $ { REALM_COMMON_CXX_FLAGS } -DREALM_ENABLE_SYNC=1 '' ) endif ( ) @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove -Wl , -- wrap , memcpy '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp index b15798d..e037db6 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp @ @ -32,6 +32,8 @ @ # include `` sync/sync_manager.hpp '' # endif + # include Fatal signal 11 ( SIGSEGV ) at 0x5bb29ffe ( code=2 ) on API 17 ( 4.2.2 ) __EoT__ When I try to use Realm realm = Realm.getDefaultInstance ( ) ; the app gives that error while it runs well on 4.4 and above
diff -- git a/realm/realm-library/src/main/java/io/realm/Realm.java b/realm/realm-library/src/main/java/io/realm/Realm.java index ad06ce1..2cf7c28 100644 -- - a/realm/realm-library/src/main/java/io/realm/Realm.java +++ b/realm/realm-library/src/main/java/io/realm/Realm.java @ @ -840,7 +840,10 @ @ public final class Realm extends BaseRealm { * < p > * Please note : * < ul > - * < li > We do n't check if the provided objects are already managed or not , so inserting a managed object might duplicate it < /li > + * < li > + * We do n't check if the provided objects are already managed or not , so inserting a managed object might duplicate it . + * This will only happen if the object does n't have a primary key . Objects with primary keys will never get duplicated . + * < /li > * < li > We do n't create ( nor return ) a managed { @ link RealmObject } for each element < /li > * < li > Copying an object will copy all field values . Any unset field in the object and child objects will be set to their default value if not provided < /li > * < /ul > @ @ -871,7 +874,10 @ @ public final Fix insertOrUpdate Javadoc __EoT__ Feedback : > from the javadoc of ` insertOrUpdate ( ) ` We do n't check if the provided objects are already managed or not , so inserting a managed object might duplicate it ` ( https : //github.com/realm/realm-java/blob/master/realm/realm-library/src/main/java/io/realm/Realm.java # L863 ) this seems confusing in my opinion , it lead me to think that ` insertOrUpdate ( ) ` might duplicate objects . It is true that ` insertOrUpdate ` never duplicate objects with primary keys . We should clarify that .
diff -- git a/realm-annotations/src/main/java/io/realm/annotations/RealmClass.java b/realm-annotations/src/main/java/io/realm/annotations/RealmClass.java index 2211107..1f6d0d7 100644 -- - a/realm-annotations/src/main/java/io/realm/annotations/RealmClass.java +++ b/realm-annotations/src/main/java/io/realm/annotations/RealmClass.java @ @ -23,9 +23,28 @ @ import java.lang.annotation.Retention ; import java.lang.annotation.RetentionPolicy ; import java.lang.annotation.Target ; +/** + * Interface used to mark a class that can be persisted by Realm . + */ @ Retention ( RetentionPolicy.CLASS ) @ Target ( ElementType.TYPE ) @ Inherited public @ interface RealmClass { + /** + * Manually set the internal name used by Realm for this class . This will override any { @ link RealmNamingPolicy } + * otherwise set . + * + * @ see { @ link RealmNamingPolicy } for more information about what setting the name means . + */ + String name ( ) default `` '' ; + + /** + * The naming policy applied to all fields in this class . The default policy is { @ link RealmNamePolicy # NO_POLICY } . + * < p > + * It is possible to override the naming policy for each field by using the { @ link RealmField } annotation . + * + * @ see { @ link RealmNamingPolicy } for more information about what setting this policy realm can user annotation replace column name or table name __EoT__ realm can user annotation replace column name or table name ?
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 8712e45..27ff9ae 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,10 @ @ + # # 4.4.0 ( YYYY-MM-DD ) + + # # # Enhancements + +* Added support for mapping between a Java name and the underlying name in the Realm file using ` @ RealmModule ` , ` @ RealmClass ` and ` @ RealmField ` annotations ( # 5280 ) . + + # # 4.3.2 ( 2018-01-17 ) # # # Bug Fixes diff -- git a/realm-annotations/src/main/java/io/realm/annotations/RealmClass.java b/realm-annotations/src/main/java/io/realm/annotations/RealmClass.java index d0ab776..b4a3abb 100644 -- - a/realm-annotations/src/main/java/io/realm/annotations/RealmClass.java +++ b/realm-annotations/src/main/java/io/realm/annotations/RealmClass.java @ @ -23,9 +23,29 @ @ import java.lang.annotation.Retention ; import java.lang.annotation.RetentionPolicy ; import java.lang.annotation.Target ; +/** + * Interface used to mark a class that can be persisted by Realm . + */ @ Retention ( RetentionPolicy.RUNTIME ) @ Target ( ElementType.TYPE ) @ Inherited public @ interface RealmClass { + /** + * Manually set the internal name used by Realm for this class . If this class is part of + * any modules , this will also override any name policy set using + * { @ link RealmModule # classNamingPolicy ( ) } . + * + * @ realm can user annotation replace column name or table name __EoT__ realm can user annotation replace column name or table name ?
diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 93e83ca..78fd04b 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -65,12 +65,12 @ @ def toolchains = [ ] def targets = [ - new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , - new Target ( name : 'arm-v7a ' , jniFolder : 'armeabi-v7a ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' , '-march=armv7-a ' , '-mfloat-abi=softfp ' , '-mfpu=vfpv3-d16 ' ] ) , - new Target ( name : 'arm64 ' , jniFolder : 'arm64-v8a ' , toolchain : toolchains.find { it.name == 'arm64 ' } , cflags : [ ] ) , - new Target ( name : 'mips ' , jniFolder : 'mips ' , toolchain : toolchains.find { it.name == 'mips ' } , cflags : [ ] ) , +// new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , +// new Target ( name : 'arm-v7a Stable iterators for RealmCollection __EoT__ # # # Problem This has been discussed before https : //github.com/realm/realm-java/issues/640 https : //github.com/realm/realm-java/issues/602 https : //github.com/realm/realm-wiki/wiki/Java-Iterators ( Internal wiki page ) So # 2124 was introduced to solve below problem : `` ` java RealmResults < Person > persons = realm.allObjects ( Person.class ) ; realm.beginTransaction ( ) ; for ( int i = 0 ; persons.size ( ) ; i++ ) { // Will only delete half the elements due to size ( ) calling // sync_if_needed . persons.get ( i ) .removeFromRealm ( ) ; } realm.commitTransaction ( ) ; `` ` Then we added # 2990 to make sure the ` RealmResults ` gets updated in very next event loop by calling ` handler.postAtFrontOfQueue ( ) ` . Usually above works fine , this becomes a topic again for below reasons : # # # # 1 . However there are still corner cases which could trigger an exception : > java.lang.IllegalStateException : Object is no longer managed by Realm . Has it been deleted ? eg . : Delete an element in ` RealmResults ` then calling the corresponding ` ListView.measure ( ) ` method . ` measure (
diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 856e743..302a188 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -71,12 +71,12 @ @ def toolchains = [ ] def targets = [ - new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , - new Target ( name : 'arm-v7a ' , jniFolder : 'armeabi-v7a ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' , '-march=armv7-a ' , '-mfloat-abi=softfp ' , '-mfpu=vfpv3-d16 ' ] ) , - new Target ( name : 'arm64 ' , jniFolder : 'arm64-v8a ' , toolchain : toolchains.find { it.name == 'arm64 ' } , cflags : [ ] ) , - new Target ( name : 'mips ' , jniFolder : 'mips ' , toolchain : toolchains.find { it.name == 'mips ' } , cflags : [ ] ) , +// new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , +// new Target ( name : 'arm-v7a Stable iterators for RealmCollection __EoT__ # # # Problem This has been discussed before https : //github.com/realm/realm-java/issues/640 https : //github.com/realm/realm-java/issues/602 https : //github.com/realm/realm-wiki/wiki/Java-Iterators ( Internal wiki page ) So # 2124 was introduced to solve below problem : `` ` java RealmResults < Person > persons = realm.allObjects ( Person.class ) ; realm.beginTransaction ( ) ; for ( int i = 0 ; persons.size ( ) ; i++ ) { // Will only delete half the elements due to size ( ) calling // sync_if_needed . persons.get ( i ) .removeFromRealm ( ) ; } realm.commitTransaction ( ) ; `` ` Then we added # 2990 to make sure the ` RealmResults ` gets updated in very next event loop by calling ` handler.postAtFrontOfQueue ( ) ` . Usually above works fine , this becomes a topic again for below reasons : # # # # 1 . However there are still corner cases which could trigger an exception : > java.lang.IllegalStateException : Object is no longer managed by Realm . Has it been deleted ? eg . : Delete an element in ` RealmResults ` then calling the corresponding ` ListView.measure ( ) ` method . ` measure (
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 8937e5d..4fa429b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,12 @ @ + # # 0.89.0 +* BREAKING CHANGE : RealmResults.clear ( ) now throws UnsupportedOperationException . Use RealmResults.deleteAllFromRealm ( ) instead . +* BREAKING CHANGE : RealmResults.remove ( int ) now throws UnsupportedOperationException . Use RealmResults.deleteFromRealm ( ) instead . +* Added two new interfaces : RealmCollection and OrderedRealmCollection . RealmList and RealmResults both implement these interfaces . +* Deprecated RealmObject.removeFromRealm ( ) in place of RealmObject.deleteFromRealm ( ) +* Deprecated Realm.clear ( Class ) in place of Realm.delete ( Class ) . +* Deprecated DynamicRealm.clear ( Class ) in place of DynamicRealm.delete ( Class ) . +* RealmBaseAdapter now accept an OrderedRealmCollection instead of only RealmResults . + # # 0.88.0 * Updated Realm Core to 0.97.0. diff -- git a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java index 69915fc..3a4afc8 100644 -- - a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java +++ b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java @ @ -54,7 +54,7 @ @ public class AdapterExampleActivity extends Activity { listView.setOnItemLongClickListener ( new AdapterView.OnItemLongClickListener ( ) { @ Override public boolean onItemLongClick ( AdapterView < ? > adapterView , View view , int i , long l ) { - TimeStamp timeStamp = adapter.getRealmResults ( ) .get ( i Stable iterators for RealmCollection __EoT__ # # # Problem This has been discussed before https : //github.com/realm/realm-java/issues/640 https : //github.com/realm/realm-java/issues/602 https : //github.com/realm/realm-wiki/wiki/Java-Iterators ( Internal wiki page ) So # 2124 was introduced to solve below problem : `` ` java RealmResults < Person > persons = realm.allObjects ( Person.class ) ; realm.beginTransaction ( ) ; for ( int i = 0 ; persons.size ( ) ; i++ ) { // Will only delete half the elements due to size ( ) calling // sync_if_needed . persons.get ( i ) .removeFromRealm ( ) ; } realm.commitTransaction ( ) ; `` ` Then we added # 2990 to make sure the ` RealmResults ` gets updated in very next event loop by calling ` handler.postAtFrontOfQueue ( ) ` . Usually above works fine , this becomes a topic again for below reasons : # # # # 1 . However there are still corner cases which could trigger an exception : > java.lang.IllegalStateException : Object is no longer managed by Realm . Has it been deleted ? eg . : Delete an element in ` RealmResults ` then calling the corresponding ` ListView.measure ( ) ` method . ` measure (
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 8937e5d..4fa429b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,12 @ @ + # # 0.89.0 +* BREAKING CHANGE : RealmResults.clear ( ) now throws UnsupportedOperationException . Use RealmResults.deleteAllFromRealm ( ) instead . +* BREAKING CHANGE : RealmResults.remove ( int ) now throws UnsupportedOperationException . Use RealmResults.deleteFromRealm ( ) instead . +* Added two new interfaces : RealmCollection and OrderedRealmCollection . RealmList and RealmResults both implement these interfaces . +* Deprecated RealmObject.removeFromRealm ( ) in place of RealmObject.deleteFromRealm ( ) +* Deprecated Realm.clear ( Class ) in place of Realm.delete ( Class ) . +* Deprecated DynamicRealm.clear ( Class ) in place of DynamicRealm.delete ( Class ) . +* RealmBaseAdapter now accept an OrderedRealmCollection instead of only RealmResults . + # # 0.88.0 * Updated Realm Core to 0.97.0. diff -- git a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java index 69915fc..3a4afc8 100644 -- - a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java +++ b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java @ @ -54,7 +54,7 @ @ public class AdapterExampleActivity extends Activity { listView.setOnItemLongClickListener ( new AdapterView.OnItemLongClickListener ( ) { @ Override public boolean onItemLongClick ( AdapterView < ? > adapterView , View view , int i , long l ) { - TimeStamp timeStamp = adapter.getRealmResults ( ) .get ( i Stable iterators for RealmCollection __EoT__ # # # Problem This has been discussed before https : //github.com/realm/realm-java/issues/640 https : //github.com/realm/realm-java/issues/602 https : //github.com/realm/realm-wiki/wiki/Java-Iterators ( Internal wiki page ) So # 2124 was introduced to solve below problem : `` ` java RealmResults < Person > persons = realm.allObjects ( Person.class ) ; realm.beginTransaction ( ) ; for ( int i = 0 ; persons.size ( ) ; i++ ) { // Will only delete half the elements due to size ( ) calling // sync_if_needed . persons.get ( i ) .removeFromRealm ( ) ; } realm.commitTransaction ( ) ; `` ` Then we added # 2990 to make sure the ` RealmResults ` gets updated in very next event loop by calling ` handler.postAtFrontOfQueue ( ) ` . Usually above works fine , this becomes a topic again for below reasons : # # # # 1 . However there are still corner cases which could trigger an exception : > java.lang.IllegalStateException : Object is no longer managed by Realm . Has it been deleted ? eg . : Delete an element in ` RealmResults ` then calling the corresponding ` ListView.measure ( ) ` method . ` measure (
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 21c5444..008b31b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,7 +1,19 @ @ # # 0.89.0 - # # # Enhancements + # # # Breaking changes +* RealmResults.clear ( ) now throws UnsupportedOperationException . Use RealmResults.deleteAllFromRealm ( ) instead . +* RealmResults.remove ( int ) now throws UnsupportedOperationException . Use RealmResults.deleteFromRealm ( ) instead . + + # # # Deprecated + +* RealmObject.removeFromRealm ( ) in place of RealmObject.deleteFromRealm ( ) +* Realm.clear ( Class ) in place of Realm.delete ( Class ) . +* DynamicRealm.clear ( Class ) in place of DynamicRealm.delete ( Class ) . + + # # # Enhancements +* RealmCollection and OrderedRealmCollection have been added . RealmList and RealmResults both implement these interfaces . +* RealmBaseAdapter now accept an OrderedRealmCollection instead of only RealmResults . * RealmObjectSchema.isPrimaryKey ( String ) ( # 2440 ) # # # Bug fixes diff -- git a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java index 69915fc..3a4afc8 100644 -- - a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java +++ b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java @ @ -54,7 +54,7 @ @ public class AdapterExampleActivity extends Activity { listView.setOnItemLongClickListener ( new AdapterView.OnItemLongClickListener ( ) { @ Override public boolean onItemLongClick ( AdapterView < ? > adapterView , View view , int Stable iterators for RealmCollection __EoT__ # # # Problem This has been discussed before https : //github.com/realm/realm-java/issues/640 https : //github.com/realm/realm-java/issues/602 https : //github.com/realm/realm-wiki/wiki/Java-Iterators ( Internal wiki page ) So # 2124 was introduced to solve below problem : `` ` java RealmResults < Person > persons = realm.allObjects ( Person.class ) ; realm.beginTransaction ( ) ; for ( int i = 0 ; persons.size ( ) ; i++ ) { // Will only delete half the elements due to size ( ) calling // sync_if_needed . persons.get ( i ) .removeFromRealm ( ) ; } realm.commitTransaction ( ) ; `` ` Then we added # 2990 to make sure the ` RealmResults ` gets updated in very next event loop by calling ` handler.postAtFrontOfQueue ( ) ` . Usually above works fine , this becomes a topic again for below reasons : # # # # 1 . However there are still corner cases which could trigger an exception : > java.lang.IllegalStateException : Object is no longer managed by Realm . Has it been deleted ? eg . : Delete an element in ` RealmResults ` then calling the corresponding ` ListView.measure ( ) ` method . ` measure (
diff -- git a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java index c7766fa..515d058 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java +++ b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java @ @ -46,6 +46,7 @ @ import java.util.concurrent.TimeoutException ; import java.util.concurrent.atomic.AtomicBoolean ; import java.util.concurrent.atomic.AtomicInteger ; +import io.realm.entities.AllJavaTypes ; import io.realm.entities.AllTypes ; import io.realm.entities.Dog ; import io.realm.internal.log.Logger ; @ @ -946,20 +947,20 @ @ public class NotificationsTest { public void asyncRealmObjectShouldNotBlockBackgroundCommitNotification ( ) { final AtomicInteger numberOfRealmCallbackInvocation = new AtomicInteger ( 0 ) ; final CountDownLatch signalClosedRealm = new CountDownLatch ( 1 ) ; - looperThread.realm.addChangeListener ( new RealmChangeListener < Realm > ( ) { + final Realm realm = looperThread.realm ; + realm.addChangeListener ( new RealmChangeListener < Realm > ( ) { @ Override public void onChange ( Realm object ) { switch ( numberOfRealmCallbackInvocation.incrementAndGet ( ) ) { case 1 : { // first commit - Dog dog = looperThread.realm.where ( Dog.class ) .findFirstAsync ( ) ; + Dog dog = realm.where ( Dog.class ) .findFirstAsync ( ) ; assertTrue ( dog.load ( ) ) ; dog.addChangeListener ( new RealmChangeListener < Dog > ( ) { @ Override public void onChange ( Dog dog ) { } } ) ; - looperThread.keepStrongReference.add ( dog ) ; new Thread ( ) { @ Override @ @ -987,9 Stable iterators for RealmCollection __EoT__ # # # Problem This has been discussed before https : //github.com/realm/realm-java/issues/640 https : //github.com/realm/realm-java/issues/602 https : //github.com/realm/realm-wiki/wiki/Java-Iterators ( Internal wiki page ) So # 2124 was introduced to solve below problem : `` ` java RealmResults < Person > persons = realm.allObjects ( Person.class ) ; realm.beginTransaction ( ) ; for ( int i = 0 ; persons.size ( ) ; i++ ) { // Will only delete half the elements due to size ( ) calling // sync_if_needed . persons.get ( i ) .removeFromRealm ( ) ; } realm.commitTransaction ( ) ; `` ` Then we added # 2990 to make sure the ` RealmResults ` gets updated in very next event loop by calling ` handler.postAtFrontOfQueue ( ) ` . Usually above works fine , this becomes a topic again for below reasons : # # # # 1 . However there are still corner cases which could trigger an exception : > java.lang.IllegalStateException : Object is no longer managed by Realm . Has it been deleted ? eg . : Delete an element in ` RealmResults ` then calling the corresponding ` ListView.measure ( ) ` method . ` measure (
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 86d0863..4835634 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -4,6 +4,7 @ @ * Fixed a crash when calling Table.toString ( ) in debugger ( # 2429 ) . * Fixed a crash that RealmResults was not updated in Realm 's change listener by adjusting the calling orders of listeners on Realm , RealmObject and RealmResults ( # 2926 ) . +* Fixed a potential crash when accessing other RealmResults from inside a RealmResults ' RealmChangeListener ( # 2951 ) . # # # Enhancements diff -- git a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java index c7766fa..515d058 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java +++ b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java @ @ -46,6 +46,7 @ @ import java.util.concurrent.TimeoutException ; import java.util.concurrent.atomic.AtomicBoolean ; import java.util.concurrent.atomic.AtomicInteger ; +import io.realm.entities.AllJavaTypes ; import io.realm.entities.AllTypes ; import io.realm.entities.Dog ; import io.realm.internal.log.Logger ; @ @ -946,20 +947,20 @ @ public class NotificationsTest { public void asyncRealmObjectShouldNotBlockBackgroundCommitNotification ( ) { final AtomicInteger numberOfRealmCallbackInvocation = new AtomicInteger ( 0 ) ; final CountDownLatch signalClosedRealm = new CountDownLatch ( 1 ) ; - looperThread.realm.addChangeListener ( new RealmChangeListener < Realm > ( ) { + final Realm realm = looperThread.realm ; + realm.addChangeListener ( new RealmChangeListener < Realm > ( ) { @ Override public void Stable iterators for RealmCollection __EoT__ # # # Problem This has been discussed before https : //github.com/realm/realm-java/issues/640 https : //github.com/realm/realm-java/issues/602 https : //github.com/realm/realm-wiki/wiki/Java-Iterators ( Internal wiki page ) So # 2124 was introduced to solve below problem : `` ` java RealmResults < Person > persons = realm.allObjects ( Person.class ) ; realm.beginTransaction ( ) ; for ( int i = 0 ; persons.size ( ) ; i++ ) { // Will only delete half the elements due to size ( ) calling // sync_if_needed . persons.get ( i ) .removeFromRealm ( ) ; } realm.commitTransaction ( ) ; `` ` Then we added # 2990 to make sure the ` RealmResults ` gets updated in very next event loop by calling ` handler.postAtFrontOfQueue ( ) ` . Usually above works fine , this becomes a topic again for below reasons : # # # # 1 . However there are still corner cases which could trigger an exception : > java.lang.IllegalStateException : Object is no longer managed by Realm . Has it been deleted ? eg . : Delete an element in ` RealmResults ` then calling the corresponding ` ListView.measure ( ) ` method . ` measure (
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 86d0863..034329a 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -4,6 +4,8 @ @ * Fixed a crash when calling Table.toString ( ) in debugger ( # 2429 ) . * Fixed a crash that RealmResults was not updated in Realm 's change listener by adjusting the calling orders of listeners on Realm , RealmObject and RealmResults ( # 2926 ) . +* Fixed a race condition between Realms notifications and other UI events . This could e.g . cause ListView to crash . +* Fixed a potential crash when accessing other RealmResults from inside a RealmResults ' RealmChangeListener ( # 2951 ) . # # # Enhancements diff -- git a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java index c7766fa..b219978 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java +++ b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java @ @ -946,20 +946,20 @ @ public class NotificationsTest { public void asyncRealmObjectShouldNotBlockBackgroundCommitNotification ( ) { final AtomicInteger numberOfRealmCallbackInvocation = new AtomicInteger ( 0 ) ; final CountDownLatch signalClosedRealm = new CountDownLatch ( 1 ) ; - looperThread.realm.addChangeListener ( new RealmChangeListener < Realm > ( ) { + final Realm realm = looperThread.realm ; + realm.addChangeListener ( new RealmChangeListener < Realm > ( ) { @ Override public void onChange ( Realm object ) Stable iterators for RealmCollection __EoT__ # # # Problem This has been discussed before https : //github.com/realm/realm-java/issues/640 https : //github.com/realm/realm-java/issues/602 https : //github.com/realm/realm-wiki/wiki/Java-Iterators ( Internal wiki page ) So # 2124 was introduced to solve below problem : `` ` java RealmResults < Person > persons = realm.allObjects ( Person.class ) ; realm.beginTransaction ( ) ; for ( int i = 0 ; persons.size ( ) ; i++ ) { // Will only delete half the elements due to size ( ) calling // sync_if_needed . persons.get ( i ) .removeFromRealm ( ) ; } realm.commitTransaction ( ) ; `` ` Then we added # 2990 to make sure the ` RealmResults ` gets updated in very next event loop by calling ` handler.postAtFrontOfQueue ( ) ` . Usually above works fine , this becomes a topic again for below reasons : # # # # 1 . However there are still corner cases which could trigger an exception : > java.lang.IllegalStateException : Object is no longer managed by Realm . Has it been deleted ? eg . : Delete an element in ` RealmResults ` then calling the corresponding ` ListView.measure ( ) ` method . ` measure (
diff -- git a/CHANGELOG.md b/CHANGELOG.md index b057bbd..b8bc283 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -4,9 +4,10 @ @ * Fixed a crash when calling ` Table.toString ( ) ` in debugger ( # 2429 ) . * Fixed a race condition which would cause some ` RealmResults ` to not be properly updated inside a ` RealmChangeListener ` . This could result in crashes when accessing items from those results ( # 2926/ # 2951 ) . -* Fixed a bug that could cause Realm to lose track of primary key when using ` RealmObjectSchema.removeField ( ) ` and ` RealmObjectSchema.renameField ( ) ` ( # 2829 ) .lts ( # 2926 ) . +* Fixed a bug that could cause Realm to lose track of primary key when using ` RealmObjectSchema.removeField ( ) ` and ` RealmObjectSchema.renameField ( ) ` ( # 2829/ # 2926 ) . * Fixed a bug that prevented some devices from finding async related JNI methods correctly . * Updated ProGuard configuration in order not to depend on Android 's default configuration ( # 2972 ) . +* Fixed a race condition between Realms notifications and other UI events . This could e.g Stable iterators for RealmCollection __EoT__ # # # Problem This has been discussed before https : //github.com/realm/realm-java/issues/640 https : //github.com/realm/realm-java/issues/602 https : //github.com/realm/realm-wiki/wiki/Java-Iterators ( Internal wiki page ) So # 2124 was introduced to solve below problem : `` ` java RealmResults < Person > persons = realm.allObjects ( Person.class ) ; realm.beginTransaction ( ) ; for ( int i = 0 ; persons.size ( ) ; i++ ) { // Will only delete half the elements due to size ( ) calling // sync_if_needed . persons.get ( i ) .removeFromRealm ( ) ; } realm.commitTransaction ( ) ; `` ` Then we added # 2990 to make sure the ` RealmResults ` gets updated in very next event loop by calling ` handler.postAtFrontOfQueue ( ) ` . Usually above works fine , this becomes a topic again for below reasons : # # # # 1 . However there are still corner cases which could trigger an exception : > java.lang.IllegalStateException : Object is no longer managed by Realm . Has it been deleted ? eg . : Delete an element in ` RealmResults ` then calling the corresponding ` ListView.measure ( ) ` method . ` measure (
diff -- git a/realm/realm-jni/src/io_realm_internal_LinkView.cpp b/realm/realm-jni/src/io_realm_internal_LinkView.cpp index a2aaee6..2dcc0e1 100644 -- - a/realm/realm-jni/src/io_realm_internal_LinkView.cpp +++ b/realm/realm-jni/src/io_realm_internal_LinkView.cpp @ @ -19,10 +19,12 @ @ using namespace realm ; +static void finalize ( jlong ptr ) ; + JNIEXPORT void JNICALL Java_io_realm_internal_LinkView_nativeClose ( JNIEnv* , jclass , jlong nativeLinkViewPtr ) { - LangBindHelper : :unbind_linklist_ptr ( *LV ( nativeLinkViewPtr ) ) ; + finalize ( nativeLinkViewPtr ) ; } @ @ -248,3 +250,13 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_LinkView_nativeRemoveTargetRow return lvr- > remove_target_row ( S ( pos ) ) ; } CATCH_STD ( ) } + +static void finalize ( jlong ptr ) { + TR_ENTER_PTR ( ptr ) + LangBindHelper : :unbind_linklist_ptr ( *LV ( ptr ) ) ; + } + +JNIEXPORT jlong JNICALL Java_io_realm_internal_LinkView_nativeGetFinalizer + ( JNIEnv * , jclass ) { + return static_cast < jlong > ( reinterpret_cast < uintptr_t > ( & finalize ) ) ; + } diff -- git a/realm/realm-jni/src/io_realm_internal_LinkView.h b/realm/realm-jni/src/io_realm_internal_LinkView.h index 7c9e93e..7894819 100644 -- - a/realm/realm-jni/src/io_realm_internal_LinkView.h +++ b/realm/realm-jni/src/io_realm_internal_LinkView.h @ @ -143,6 +143,14 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_LinkView_nativeRemoveAllTargetRows JNIEXPORT jlong JNICALL Java_io_realm_internal_LinkView_nativeGetTargetTable ( JNIEnv * , jobject , jlong ) ; +/* + * Class : io_realm_internal_LinkView + * Method : nativeGetFinalizer + * Signature : ( io.realm.internal.Table.finalize ( ) timed out after 10 seconds __EoT__ Copy from # 1599 People are still seeing finalizer timeouts on 0.88.2 : http : //crashes.to/s/360245fd72a We should look into how hard it would be to get rid of finalizers completely IMO . /cc @ dalinaum
diff -- git a/realm/realm-jni/src/io_realm_internal_LinkView.cpp b/realm/realm-jni/src/io_realm_internal_LinkView.cpp index a2aaee6..2dcc0e1 100644 -- - a/realm/realm-jni/src/io_realm_internal_LinkView.cpp +++ b/realm/realm-jni/src/io_realm_internal_LinkView.cpp @ @ -19,10 +19,12 @ @ using namespace realm ; +static void finalize ( jlong ptr ) ; + JNIEXPORT void JNICALL Java_io_realm_internal_LinkView_nativeClose ( JNIEnv* , jclass , jlong nativeLinkViewPtr ) { - LangBindHelper : :unbind_linklist_ptr ( *LV ( nativeLinkViewPtr ) ) ; + finalize ( nativeLinkViewPtr ) ; } @ @ -248,3 +250,13 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_LinkView_nativeRemoveTargetRow return lvr- > remove_target_row ( S ( pos ) ) ; } CATCH_STD ( ) } + +static void finalize ( jlong ptr ) { + TR_ENTER_PTR ( ptr ) + LangBindHelper : :unbind_linklist_ptr ( *LV ( ptr ) ) ; + } + +JNIEXPORT jlong JNICALL Java_io_realm_internal_LinkView_nativeGetFinalizer + ( JNIEnv * , jclass ) { + return static_cast < jlong > ( reinterpret_cast < uintptr_t > ( & finalize ) ) ; + } diff -- git a/realm/realm-jni/src/io_realm_internal_LinkView.h b/realm/realm-jni/src/io_realm_internal_LinkView.h index 7c9e93e..7894819 100644 -- - a/realm/realm-jni/src/io_realm_internal_LinkView.h +++ b/realm/realm-jni/src/io_realm_internal_LinkView.h @ @ -143,6 +143,14 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_LinkView_nativeRemoveAllTargetRows JNIEXPORT jlong JNICALL Java_io_realm_internal_LinkView_nativeGetTargetTable ( JNIEnv * , jobject , jlong ) ; +/* + * Class : io_realm_internal_LinkView + * Method : nativeGetFinalizer + * Signature : ( io.realm.internal.Table.finalize ( ) timed out after 10 seconds __EoT__ Copy from # 1599 People are still seeing finalizer timeouts on 0.88.2 : http : //crashes.to/s/360245fd72a We should look into how hard it would be to get rid of finalizers completely IMO . /cc @ dalinaum
diff -- git a/realm/realm-jni/src/io_realm_internal_LinkView.cpp b/realm/realm-jni/src/io_realm_internal_LinkView.cpp index a2aaee6..8ad51fc 100644 -- - a/realm/realm-jni/src/io_realm_internal_LinkView.cpp +++ b/realm/realm-jni/src/io_realm_internal_LinkView.cpp @ @ -19,10 +19,12 @ @ using namespace realm ; +static void finalize_link_view ( jlong ptr ) ; + JNIEXPORT void JNICALL Java_io_realm_internal_LinkView_nativeClose ( JNIEnv* , jclass , jlong nativeLinkViewPtr ) { - LangBindHelper : :unbind_linklist_ptr ( *LV ( nativeLinkViewPtr ) ) ; + finalize_link_view ( nativeLinkViewPtr ) ; } @ @ -248,3 +250,15 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_LinkView_nativeRemoveTargetRow return lvr- > remove_target_row ( S ( pos ) ) ; } CATCH_STD ( ) } + +static void finalize_link_view ( jlong ptr ) + { + TR_ENTER_PTR ( ptr ) + LangBindHelper : :unbind_linklist_ptr ( *LV ( ptr ) ) ; + } + +JNIEXPORT jlong JNICALL Java_io_realm_internal_LinkView_nativeGetFinalizer + ( JNIEnv * , jclass ) + { + return static_cast < jlong > ( reinterpret_cast < uintptr_t > ( & finalize_link_view ) ) ; + } diff -- git a/realm/realm-jni/src/io_realm_internal_LinkView.h b/realm/realm-jni/src/io_realm_internal_LinkView.h index 7c9e93e..7894819 100644 -- - a/realm/realm-jni/src/io_realm_internal_LinkView.h +++ b/realm/realm-jni/src/io_realm_internal_LinkView.h @ @ -143,6 +143,14 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_LinkView_nativeRemoveAllTargetRows JNIEXPORT jlong JNICALL Java_io_realm_internal_LinkView_nativeGetTargetTable ( JNIEnv * , jobject , jlong ) ; +/* + * Class : io_realm_internal_LinkView + * Method : nativeGetFinalizer + * Signature io.realm.internal.Table.finalize ( ) timed out after 10 seconds __EoT__ Copy from # 1599 People are still seeing finalizer timeouts on 0.88.2 : http : //crashes.to/s/360245fd72a We should look into how hard it would be to get rid of finalizers completely IMO . /cc @ dalinaum
diff -- git a/realm/realm-library/src/androidTest/java/io/realm/GCTests.java b/realm/realm-library/src/androidTest/java/io/realm/GCTests.java new file mode 100644 index 0000000..8231171 -- - /dev/null +++ b/realm/realm-library/src/androidTest/java/io/realm/GCTests.java @ @ -0,0 +1,128 @ @ +/* + * Copyright 2016 Realm Inc. + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ + +package io.realm ; + + +import android.support.test.runner.AndroidJUnit4 ; + +import org.junit.After ; +import org.junit.Before ; +import org.junit.Rule ; +import org.junit.Test ; +import org.junit.runner.RunWith ; + +import io.realm.entities.AllTypes ; +import io.realm.entities.Dog ; +import io.realm.rule.TestRealmConfigurationFactory ; + +import static junit.framework.TestCase.assertNotNull ; + +// This test is for the fact we do n't io.realm.internal.Table.finalize ( ) timed out after 10 seconds __EoT__ Copy from # 1599 People are still seeing finalizer timeouts on 0.88.2 : http : //crashes.to/s/360245fd72a We should look into how hard it would be to get rid of finalizers completely IMO . /cc @ dalinaum
diff -- git a/Jenkinsfile b/Jenkinsfile index 51f0499..af3fd31 100644 -- - a/Jenkinsfile +++ b/Jenkinsfile @ @ -48,7 +48,7 @ @ try { stage ( 'JVM tests ' ) { try { withCredentials ( [ [ $ class : 'FileBinding ' , credentialsId : 'c0cc8f9e-c3f1-4e22-b22f-6568392e26ae ' , variable : 'S3CFG ' ] ] ) { - sh `` chmod +x gradlew & & ./gradlew assemble check javadoc -Ps3cfg= $ { env.S3CFG } '' + sh `` chmod +x gradlew & & ./gradlew -- console=plain assemble check javadoc -Ps3cfg= $ { env.S3CFG } '' } } finally { storeJunitResults 'realm/realm-annotations-processor/build/test-results/test/TEST-*.xml' @ @ -98,7 +98,7 @ @ try { stage ( 'Publish to OJO ' ) { withCredentials ( [ [ $ class : 'UsernamePasswordMultiBinding ' , credentialsId : 'bintray ' , passwordVariable : 'BINTRAY_KEY ' , usernameVariable : 'BINTRAY_USER ' ] ] ) { - sh `` chmod +x gradlew & & ./gradlew -PbintrayUser= $ { env.BINTRAY_USER } -PbintrayKey= $ { env.BINTRAY_KEY } assemble ojoUpload -- stacktrace '' + sh `` chmod +x gradlew & & ./gradlew -- console=plain -PbintrayUser= $ { env.BINTRAY_USER } -PbintrayKey= $ { env.BINTRAY_KEY } assemble ojoUpload -- stacktrace '' } } } @ @ -209,9 +209,9 @ @ Support android gradle plugin 3.0.0 __EoT__ Original title : < TableName > is not part of the schema for this realm when using gradle:3.0.0-alpha4 I 'm using the latest version of realm ( 3.4.0 ) but I 've also tried with an older project on 2.x If I create a build with com.android.tools.build : gradle:2.4.0-alpha7 the app builds fine and runs , but as soon as I upgrade to com.android.tools.build : gradle:3.0.0-alpha4 the app still builds fine , but as the app crashes straight away with < TableName > is not part of the schema for this realm . As far as config of the realm I 'm using the following ` RealmInspectorModulesProvider.builder ( this ) .withFolder ( getCacheDir ( ) ) .withMetaTables ( ) .withDescendingOrder ( ) .withLimit ( 1000 ) .databaseNamePattern ( Pattern.compile ( `` .+\\.realm '' ) ) .build ( ) ; Realm.init ( this ) ; RealmConfiguration config = new RealmConfiguration.Builder ( ) .deleteRealmIfMigrationNeeded ( ) .build ( ) ; Realm.setDefaultConfiguration ( config ) ; ` Is there anything that needs to change to get new gradle builds working ?
diff -- git a/examples/build.gradle b/examples/build.gradle index 6d5c61e..21767fd 100644 -- - a/examples/build.gradle +++ b/examples/build.gradle @ @ -17,12 +17,13 @ @ allprojects { buildscript { repositories { + maven { url 'https : //maven.google.com ' } mavenLocal ( ) jcenter ( ) maven { url 'https : //jitpack.io ' } } dependencies { - classpath 'com.android.tools.build : gradle:2.3.2' + classpath 'com.android.tools.build : gradle:3.0.0-alpha3' classpath 'com.jfrog.bintray.gradle : gradle-bintray-plugin:1.6' classpath 'com.github.JakeWharton : sdk-manager-plugin:0ce4cdf08009d79223850a59959d9d6e774d0f77' classpath 'com.novoda : gradle-android-command-plugin:1.5.0' @ @ -36,6 +37,7 @ @ allprojects { repositories { mavenLocal ( ) jcenter ( ) + maven { url 'https : //maven.google.com ' } } } diff -- git a/examples/gradle.properties b/examples/gradle.properties index 4a9594a..1020de8 100644 -- - a/examples/gradle.properties +++ b/examples/gradle.properties @ @ -1 +1,2 @ @ -org.gradle.jvmargs=-Xmx2048M \ No newline at end of file +org.gradle.jvmargs=-Xmx2048M +org.gradle.caching=true diff -- git a/examples/gradle/wrapper/gradle-wrapper.jar b/examples/gradle/wrapper/gradle-wrapper.jar index ccad502..7e450b7 100644 Binary files a/examples/gradle/wrapper/gradle-wrapper.jar and b/examples/gradle/wrapper/gradle-wrapper.jar differ diff -- git a/examples/gradle/wrapper/gradle-wrapper.properties b/examples/gradle/wrapper/gradle-wrapper.properties index 3e88d1e..7521fe1 100644 -- - a/examples/gradle/wrapper/gradle-wrapper.properties +++ b/examples/gradle/wrapper/gradle-wrapper.properties @ @ -1,6 +1,6 @ @ - # Tue May 16 03:12:59 PDT 2017 + # Thu Jun 15 01:47:40 JST 2017 distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists zipStoreBase=GRADLE_USER_HOME zipStorePath=wrapper/dists -distributionUrl=https\ : //services.gradle.org/distributions/gradle-3.5-all.zip +distributionUrl=https\ : //services.gradle.org/distributions/gradle-4.0-all.zip diff -- git a/examples/gradlew b/examples/gradlew index 4453cce..cccdd3d 100755 -- - a/examples/gradlew +++ Support android gradle plugin 3.0.0 __EoT__ Original title : < TableName > is not part of the schema for this realm when using gradle:3.0.0-alpha4 I 'm using the latest version of realm ( 3.4.0 ) but I 've also tried with an older project on 2.x If I create a build with com.android.tools.build : gradle:2.4.0-alpha7 the app builds fine and runs , but as soon as I upgrade to com.android.tools.build : gradle:3.0.0-alpha4 the app still builds fine , but as the app crashes straight away with < TableName > is not part of the schema for this realm . As far as config of the realm I 'm using the following ` RealmInspectorModulesProvider.builder ( this ) .withFolder ( getCacheDir ( ) ) .withMetaTables ( ) .withDescendingOrder ( ) .withLimit ( 1000 ) .databaseNamePattern ( Pattern.compile ( `` .+\\.realm '' ) ) .build ( ) ; Realm.init ( this ) ; RealmConfiguration config = new RealmConfiguration.Builder ( ) .deleteRealmIfMigrationNeeded ( ) .build ( ) ; Realm.setDefaultConfiguration ( config ) ; ` Is there anything that needs to change to get new gradle builds working ?
diff -- git a/examples/build.gradle b/examples/build.gradle index 6d5c61e..439a6ce 100644 -- - a/examples/build.gradle +++ b/examples/build.gradle @ @ -17,12 +17,13 @ @ allprojects { buildscript { repositories { + google ( ) mavenLocal ( ) jcenter ( ) maven { url 'https : //jitpack.io ' } } dependencies { - classpath 'com.android.tools.build : gradle:2.3.2' + classpath 'com.android.tools.build : gradle:3.0.0-alpha4' classpath 'com.jfrog.bintray.gradle : gradle-bintray-plugin:1.6' classpath 'com.github.JakeWharton : sdk-manager-plugin:0ce4cdf08009d79223850a59959d9d6e774d0f77' classpath 'com.novoda : gradle-android-command-plugin:1.5.0' @ @ -36,6 +37,7 @ @ allprojects { repositories { mavenLocal ( ) jcenter ( ) + google ( ) } } diff -- git a/examples/gradle.properties b/examples/gradle.properties index 4a9594a..1020de8 100644 -- - a/examples/gradle.properties +++ b/examples/gradle.properties @ @ -1 +1,2 @ @ -org.gradle.jvmargs=-Xmx2048M \ No newline at end of file +org.gradle.jvmargs=-Xmx2048M +org.gradle.caching=true diff -- git a/examples/gridViewExample/build.gradle b/examples/gridViewExample/build.gradle index 474e861..8d45e3a 100644 -- - a/examples/gridViewExample/build.gradle +++ b/examples/gridViewExample/build.gradle @ @ -37,5 +37,5 @ @ android { } dependencies { - compile 'com.google.code.gson : gson:2.5' + implementation 'com.google.code.gson : gson:2.5' } diff -- git a/examples/jsonExample/build.gradle b/examples/jsonExample/build.gradle index c46861f..cdd8b8a 100644 -- - a/examples/jsonExample/build.gradle +++ b/examples/jsonExample/build.gradle @ @ -12,6 +12,7 @ @ android { minSdkVersion 15 versionCode 1 versionName `` 1.0 '' + javaCompileOptions.annotationProcessorOptions.includeCompileClasspath = true } buildTypes { release { @ @ -27,6 +28,6 @ @ android { Support android gradle plugin 3.0.0 __EoT__ Original title : < TableName > is not part of the schema for this realm when using gradle:3.0.0-alpha4 I 'm using the latest version of realm ( 3.4.0 ) but I 've also tried with an older project on 2.x If I create a build with com.android.tools.build : gradle:2.4.0-alpha7 the app builds fine and runs , but as soon as I upgrade to com.android.tools.build : gradle:3.0.0-alpha4 the app still builds fine , but as the app crashes straight away with < TableName > is not part of the schema for this realm . As far as config of the realm I 'm using the following ` RealmInspectorModulesProvider.builder ( this ) .withFolder ( getCacheDir ( ) ) .withMetaTables ( ) .withDescendingOrder ( ) .withLimit ( 1000 ) .databaseNamePattern ( Pattern.compile ( `` .+\\.realm '' ) ) .build ( ) ; Realm.init ( this ) ; RealmConfiguration config = new RealmConfiguration.Builder ( ) .deleteRealmIfMigrationNeeded ( ) .build ( ) ; Realm.setDefaultConfiguration ( config ) ; ` Is there anything that needs to change to get new gradle builds working ?
diff -- git a/realm/src/androidTest/java/io/realm/RealmMigrationTests.java b/realm/src/androidTest/java/io/realm/RealmMigrationTests.java index 680965a..6b8cd25 100644 -- - a/realm/src/androidTest/java/io/realm/RealmMigrationTests.java +++ b/realm/src/androidTest/java/io/realm/RealmMigrationTests.java @ @ -2,9 +2,12 @ @ package io.realm ; import android.test.AndroidTestCase ; +import java.io.File ; import java.io.IOException ; +import io.realm.dynamic.RealmSpec ; import io.realm.entities.AllTypes ; +import io.realm.entities.Dog ; import io.realm.exceptions.RealmMigrationNeededException ; public class RealmMigrationTests extends AndroidTestCase { @ @ -25,4 +28,26 @ @ public class RealmMigrationTests extends AndroidTestCase { int result = realm.where ( AllTypes.class ) .equalTo ( `` columnString '' , `` Foo '' ) .findAll ( ) .size ( ) ; assertEquals ( 0 , result ) ; } + + // Create a Realm file with no Realm classes + private void createEmptyDefaultRealm ( ) { + Realm.setSchema ( AllTypes.class ) ; + Realm.deleteRealmFile ( getContext ( ) ) ; + Realm realm = Realm.getInstance ( getContext ( ) ) ; + realm.close ( ) ; + } + + private String getDefaultRealm ( ) { + return new File ( getContext ( ) .getFilesDir ( ) , `` default.realm '' ) .getAbsolutePath ( ) ; + } + + public void testAddClass ( ) { + createEmptyDefaultRealm ( ) ; + Realm.migrateRealmAtPath ( getDefaultRealm ( ) , new RealmMigration ( ) { + @ Migration script when changing model name __EoT__ Hello , In the migration examples , I can see that we have `` add new table '' , `` add new column '' and `` adjust a column '' , but there 's no example to demonstrate if we want to change the model name . What would be appropriate way to achieve this ? Thank you very much ,
diff -- git a/realm-jni/src/io_realm_internal_Group.cpp b/realm-jni/src/io_realm_internal_Group.cpp index f39edfa..440dff3 100644 -- - a/realm-jni/src/io_realm_internal_Group.cpp +++ b/realm-jni/src/io_realm_internal_Group.cpp @ @ -158,6 +158,27 @ @ JNIEXPORT jstring JNICALL Java_io_realm_internal_Group_nativeGetTableName ( return 0 ; } +JNIEXPORT void JNICALL Java_io_realm_internal_Group_nativeRemoveTable ( + JNIEnv* env , jobject , jlong nativeGroupPtr , jstring name ) + { + TR_ENTER_PTR ( nativeGroupPtr ) + try { + JStringAccessor table_name ( env , name ) ; + G ( nativeGroupPtr ) - > remove_table ( table_name ) ; + } CATCH_STD ( ) + } + +JNIEXPORT void JNICALL Java_io_realm_internal_Group_nativeRenameTable ( + JNIEnv* env , jobject , jlong nativeGroupPtr , jstring oldName , jstring newName ) + { + TR_ENTER_PTR ( nativeGroupPtr ) + try { + JStringAccessor old_name ( env , oldName ) ; + JStringAccessor new_name ( env , newName ) ; + G ( nativeGroupPtr ) - > rename_table ( old_name , new_name ) ; + } CATCH_STD ( ) + } + JNIEXPORT jlong JNICALL Java_io_realm_internal_Group_nativeGetTableNativePtr ( JNIEnv *env , jobject , jlong nativeGroupPtr , jstring name ) { diff -- git a/realm-jni/src/io_realm_internal_Group.h b/realm-jni/src/io_realm_internal_Group.h index 46ee4e7..4aa1180 100644 -- - a/realm-jni/src/io_realm_internal_Group.h +++ b/realm-jni/src/io_realm_internal_Group.h @ @ -73,6 +73,22 @ @ JNIEXPORT jstring JNICALL Java_io_realm_internal_Group_nativeGetTableName /* * Class : io_realm_internal_Group + Migration script when changing model name __EoT__ Hello , In the migration examples , I can see that we have `` add new table '' , `` add new column '' and `` adjust a column '' , but there 's no example to demonstrate if we want to change the model name . What would be appropriate way to achieve this ? Thank you very much ,
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 896e142..e61ba18 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -367,7 +367,11 @ @ public class ClassMetaData { * model classes . */ public boolean isModelClass ( ) { - return ( ! classType.toString ( ) .endsWith ( `` .RealmObject '' ) & & ! classType.toString ( ) .endsWith ( `` RealmProxy '' ) ) ; + String type = classType.toString ( ) ; + if ( type.equals ( `` io.realm.dynamic.DynamicRealmObject '' ) ) { + return false ; + } + return ( ! type.endsWith ( `` .RealmObject '' ) & & ! type.endsWith ( `` RealmProxy '' ) ) ; } public String getFullyQualifiedClassName ( ) { diff -- git a/realm-jni/src/io_realm_internal_CheckedRow.cpp b/realm-jni/src/io_realm_internal_CheckedRow.cpp index 4374a1d..031afa3 100644 -- - a/realm-jni/src/io_realm_internal_CheckedRow.cpp +++ b/realm-jni/src/io_realm_internal_CheckedRow.cpp @ @ -226,7 +226,7 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_CheckedRow_nativeSetString if ( ! ROW_AND_COL_INDEX_AND_TYPE_VALID ( env , ROW ( nativeRowPtr ) , columnIndex , type_String ) ) return ; - Java_io_realm_internal_CheckedRow_nativeSetString ( env , obj , nativeRowPtr , columnIndex , value ) ; + Java_io_realm_internal_UncheckedRow_nativeSetString ( env , obj , nativeRowPtr , columnIndex , value ) ; } JNIEXPORT void JNICALL Java_io_realm_internal_CheckedRow_nativeSetByteArray @ @ -263,4 +263,4 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_CheckedRow_nativeNullifyLink return Migration script when changing model name __EoT__ Hello , In the migration examples , I can see that we have `` add new table '' , `` add new column '' and `` adjust a column '' , but there 's no example to demonstrate if we want to change the model name . What would be appropriate way to achieve this ? Thank you very much ,
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 896e142..e61ba18 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -367,7 +367,11 @ @ public class ClassMetaData { * model classes . */ public boolean isModelClass ( ) { - return ( ! classType.toString ( ) .endsWith ( `` .RealmObject '' ) & & ! classType.toString ( ) .endsWith ( `` RealmProxy '' ) ) ; + String type = classType.toString ( ) ; + if ( type.equals ( `` io.realm.dynamic.DynamicRealmObject '' ) ) { + return false ; + } + return ( ! type.endsWith ( `` .RealmObject '' ) & & ! type.endsWith ( `` RealmProxy '' ) ) ; } public String getFullyQualifiedClassName ( ) { diff -- git a/realm-jni/src/io_realm_internal_CheckedRow.cpp b/realm-jni/src/io_realm_internal_CheckedRow.cpp index 4374a1d..031afa3 100644 -- - a/realm-jni/src/io_realm_internal_CheckedRow.cpp +++ b/realm-jni/src/io_realm_internal_CheckedRow.cpp @ @ -226,7 +226,7 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_CheckedRow_nativeSetString if ( ! ROW_AND_COL_INDEX_AND_TYPE_VALID ( env , ROW ( nativeRowPtr ) , columnIndex , type_String ) ) return ; - Java_io_realm_internal_CheckedRow_nativeSetString ( env , obj , nativeRowPtr , columnIndex , value ) ; + Java_io_realm_internal_UncheckedRow_nativeSetString ( env , obj , nativeRowPtr , columnIndex , value ) ; } JNIEXPORT void JNICALL Java_io_realm_internal_CheckedRow_nativeSetByteArray @ @ -263,4 +263,4 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_CheckedRow_nativeNullifyLink return Migration script when changing model name __EoT__ Hello , In the migration examples , I can see that we have `` add new table '' , `` add new column '' and `` adjust a column '' , but there 's no example to demonstrate if we want to change the model name . What would be appropriate way to achieve this ? Thank you very much ,
diff -- git a/realm-jni/src/io_realm_internal_Group.cpp b/realm-jni/src/io_realm_internal_Group.cpp index 9b85e9f..df804a4 100644 -- - a/realm-jni/src/io_realm_internal_Group.cpp +++ b/realm-jni/src/io_realm_internal_Group.cpp @ @ -158,6 +158,27 @ @ JNIEXPORT jstring JNICALL Java_io_realm_internal_Group_nativeGetTableName ( return 0 ; } +JNIEXPORT void JNICALL Java_io_realm_internal_Group_nativeRemoveTable ( + JNIEnv* env , jobject , jlong nativeGroupPtr , jstring name ) + { + TR_ENTER_PTR ( nativeGroupPtr ) + try { + JStringAccessor table_name ( env , name ) ; + G ( nativeGroupPtr ) - > remove_table ( table_name ) ; + } CATCH_STD ( ) + } + +JNIEXPORT void JNICALL Java_io_realm_internal_Group_nativeRenameTable ( + JNIEnv* env , jobject , jlong nativeGroupPtr , jstring oldName , jstring newName ) + { + TR_ENTER_PTR ( nativeGroupPtr ) + try { + JStringAccessor old_name ( env , oldName ) ; + JStringAccessor new_name ( env , newName ) ; + G ( nativeGroupPtr ) - > rename_table ( old_name , new_name ) ; + } CATCH_STD ( ) + } + JNIEXPORT jlong JNICALL Java_io_realm_internal_Group_nativeGetTableNativePtr ( JNIEnv *env , jobject , jlong nativeGroupPtr , jstring name ) { diff -- git a/realm-jni/src/io_realm_internal_Group.h b/realm-jni/src/io_realm_internal_Group.h index 5e95a00..c778e3d 100644 -- - a/realm-jni/src/io_realm_internal_Group.h +++ b/realm-jni/src/io_realm_internal_Group.h @ @ -73,6 +73,22 @ @ JNIEXPORT jstring JNICALL Java_io_realm_internal_Group_nativeGetTableName /* * Class : io_realm_internal_Group + Migration script when changing model name __EoT__ Hello , In the migration examples , I can see that we have `` add new table '' , `` add new column '' and `` adjust a column '' , but there 's no example to demonstrate if we want to change the model name . What would be appropriate way to achieve this ? Thank you very much ,
diff -- git a/realm-jni/src/io_realm_internal_Group.cpp b/realm-jni/src/io_realm_internal_Group.cpp index f39edfa..440dff3 100644 -- - a/realm-jni/src/io_realm_internal_Group.cpp +++ b/realm-jni/src/io_realm_internal_Group.cpp @ @ -158,6 +158,27 @ @ JNIEXPORT jstring JNICALL Java_io_realm_internal_Group_nativeGetTableName ( return 0 ; } +JNIEXPORT void JNICALL Java_io_realm_internal_Group_nativeRemoveTable ( + JNIEnv* env , jobject , jlong nativeGroupPtr , jstring name ) + { + TR_ENTER_PTR ( nativeGroupPtr ) + try { + JStringAccessor table_name ( env , name ) ; + G ( nativeGroupPtr ) - > remove_table ( table_name ) ; + } CATCH_STD ( ) + } + +JNIEXPORT void JNICALL Java_io_realm_internal_Group_nativeRenameTable ( + JNIEnv* env , jobject , jlong nativeGroupPtr , jstring oldName , jstring newName ) + { + TR_ENTER_PTR ( nativeGroupPtr ) + try { + JStringAccessor old_name ( env , oldName ) ; + JStringAccessor new_name ( env , newName ) ; + G ( nativeGroupPtr ) - > rename_table ( old_name , new_name ) ; + } CATCH_STD ( ) + } + JNIEXPORT jlong JNICALL Java_io_realm_internal_Group_nativeGetTableNativePtr ( JNIEnv *env , jobject , jlong nativeGroupPtr , jstring name ) { diff -- git a/realm-jni/src/io_realm_internal_Group.h b/realm-jni/src/io_realm_internal_Group.h index 46ee4e7..4aa1180 100644 -- - a/realm-jni/src/io_realm_internal_Group.h +++ b/realm-jni/src/io_realm_internal_Group.h @ @ -73,6 +73,22 @ @ JNIEXPORT jstring JNICALL Java_io_realm_internal_Group_nativeGetTableName /* * Class : io_realm_internal_Group + Migration script when changing model name __EoT__ Hello , In the migration examples , I can see that we have `` add new table '' , `` add new column '' and `` adjust a column '' , but there 's no example to demonstrate if we want to change the model name . What would be appropriate way to achieve this ? Thank you very much ,
diff -- git a/realm-jni/build.gradle b/realm-jni/build.gradle index 2f764dd..c75c29f 100644 -- - a/realm-jni/build.gradle +++ b/realm-jni/build.gradle @ @ -50,10 +50,10 @ @ def toolchains = [ ] def targets = [ - new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , - new Target ( name : 'arm-v7a ' , jniFolder : 'armeabi-v7a ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' , '-march=armv7-a ' , '-mfloat-abi=softfp ' , '-mfpu=vfpv3-d16 ' ] ) , - new Target ( name : 'arm64 ' , jniFolder : 'arm64-v8a ' , toolchain : toolchains.find { it.name == 'arm64 ' } , cflags : [ ] ) , - new Target ( name : 'mips ' , jniFolder : 'mips ' , toolchain : toolchains.find { it.name == 'mips ' } , cflags : [ ] ) , +// new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , +// new Target ( name : 'arm-v7a Migration script when changing model name __EoT__ Hello , In the migration examples , I can see that we have `` add new table '' , `` add new column '' and `` adjust a column '' , but there 's no example to demonstrate if we want to change the model name . What would be appropriate way to achieve this ? Thank you very much ,
diff -- git a/CHANGELOG.md b/CHANGELOG.md index f752828..3f88234 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -3,7 +3,8 @ @ # # # Bug fixes * Element type checking in ` DynamicRealmObject # setList ( ) ` ( # 4252 ) . -* Throws ` IllegalStateException ` instead of process crash when any of thread confined methods in ` RealmQuery ` is called from wrong thread ( # 4228 ) . +* Now throws ` IllegalStateException ` instead of process crash when any of thread confined methods in ` RealmQuery ` is called from wrong thread ( # 4228 ) . +* Now throws ` IllegalStateException ` when any of thread confined methods in ` DynamicRealmObject ` is called from wrong thread ( # 4258 ) . # # 2.3.2 ( 2017-02-27 ) diff -- git a/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java b/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java index ec865ce..c9449f5 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java @ @ -25,11 +25,13 @ @ import org.junit.Test ; import org.junit.rules.ExpectedException ; import org.junit.runner.RunWith ; +import java.lang.reflect.Field ; import java.text.ParseException ; import java.util.Arrays ; import java.util.Date ; import java.util.List ; import java.util.concurrent.CountDownLatch ; +import java.util.concurrent.atomic.AtomicReference ; import io.realm.entities.AllJavaTypes ; import io.realm.entities.AllTypes ; @ @ -112,6 +114,123 @ @ public class DynamicRealmObjectTests { BOOLEAN , SHORT Do thread checking in DynamicRealmObject __EoT__ Methods in ` DynamicRealmObject ` do n't have thread checks . I wrote following test to expose this bug . `` ` private enum ThreadConfinedMethods { GET_LONG , } private static void callThreadConfinedMethod ( DynamicRealmObject obj , ThreadConfinedMethods method ) { switch ( method ) { case GET_LONG : obj.getLong ( AllJavaTypes.FIELD_LONG ) ; break ; default : throw new AssertionError ( `` missing case for `` + method ) ; } } @ Test public void callThreadConfinedMethodsFromWrongThread ( ) throws Throwable { dynamicRealm.beginTransaction ( ) ; dynamicRealm.deleteAll ( ) ; final DynamicRealmObject obj = dynamicRealm.createObject ( AllJavaTypes.CLASS_NAME , 100L ) ; dynamicRealm.commitTransaction ( ) ; final AtomicReference < Throwable > throwableFromThread = new AtomicReference < Throwable > ( ) ; final CountDownLatch testFinished = new CountDownLatch ( 1 ) ; final String expectedMessage ; //noinspection TryWithIdenticalCatches try { final Field expectedMessageField = BaseRealm.class.getDeclaredField ( `` INCORRECT_THREAD_MESSAGE '' ) ; expectedMessageField.setAccessible ( true ) ; expectedMessage = ( String ) expectedMessageField.get ( null ) ; } catch ( NoSuchFieldException e ) { throw new AssertionError ( e ) ; } catch ( IllegalAccessException e ) { throw new AssertionError ( e ) ; }
diff -- git a/.github/ISSUE_TEMPLATE/bug_report.md b/.github/ISSUE_TEMPLATE/bug_report.md deleted file mode 100644 index b81b119..0000000 -- - a/.github/ISSUE_TEMPLATE/bug_report.md +++ /dev/null @ @ -1,30 +0,0 @ @ -- -- -name : Bug report -about : You think you have found a bug ! - -- -- - - # # # # Goal - < ! -- What do you want to achieve ? -- > - - # # # # Actual Results - < ! -- What happened ? If an exception was thrown please copy/paste the stack trace from Logcat . -- > - - # # # # Steps & Code to Reproduce - < ! -- What steps resulted in the crash ? Please show any relevant code or steps that can be used to -- > - < ! -- reproduce it , including any Realm model classes used . Even better is a full sample project -- > - < ! -- that can reproduce the crash . Code can be shared privately at help @ realm.io if needed . -- > - - # # # # Version of Realm and tooling - -Realm version ( s ) : ? - -Realm Sync feature enabled : Yes/No Info : Clarification on pr # 3370 and monitor threads __EoT__ @ beeender pr # 3370 Please clarify latest changelog regarding the below since the warning directly applies to us and may cause huge resource impact . We have 10+ realmConfigs . > The known problem is for every RealmConfiguration , a monitor thread will > be created which is not ideal for app which is using multiple > RealmConfiguration . - Monitor thread count : Is this monitor thread per realm , per thread ? If I open same realm in 2 different threads , how many monitor threads are there ? - Monitor thread life cycle : Is the thread created on first realm open and destroyed on last realm close ? Thanks
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk Info : Clarification on pr # 3370 and monitor threads __EoT__ @ beeender pr # 3370 Please clarify latest changelog regarding the below since the warning directly applies to us and may cause huge resource impact . We have 10+ realmConfigs . > The known problem is for every RealmConfiguration , a monitor thread will > be created which is not ideal for app which is using multiple > RealmConfiguration . - Monitor thread count : Is this monitor thread per realm , per thread ? If I open same realm in 2 different threads , how many monitor threads are there ? - Monitor thread life cycle : Is the thread created on first realm open and destroyed on last realm close ? Thanks
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index 80421d0..1cd1d11 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ updates tools to at least Info : Clarification on pr # 3370 and monitor threads __EoT__ @ beeender pr # 3370 Please clarify latest changelog regarding the below since the warning directly applies to us and may cause huge resource impact . We have 10+ realmConfigs . > The known problem is for every RealmConfiguration , a monitor thread will > be created which is not ideal for app which is using multiple > RealmConfiguration . - Monitor thread count : Is this monitor thread per realm , per thread ? If I open same realm in 2 different threads , how many monitor threads are there ? - Monitor thread life cycle : Is the thread created on first realm open and destroyed on last realm close ? Thanks
diff -- git a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java index 6de7246..b726878 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java +++ b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java @ @ -318,24 +318,6 @ @ public class NotificationsTest { } @ Test - @ UiThreadTest - public void handlerNotRemovedToSoon ( ) { - RealmConfiguration realmConfig = configFactory.createConfiguration ( `` private-realm '' ) ; - Realm.deleteRealm ( realmConfig ) ; - Realm instance1 = Realm.getInstance ( realmConfig ) ; - Realm instance2 = Realm.getInstance ( realmConfig ) ; - assertEquals ( instance1.getPath ( ) , instance2.getPath ( ) ) ; - assertNotNull ( instance1.handler ) ; - - // If multiple instances are open on the same thread , do n't remove handler on that thread - // until last instance is closed . - instance2.close ( ) ; - assertNotNull ( instance1.handler ) ; - instance1.close ( ) ; - assertNull ( instance1.handler ) ; - } - - @ Test @ RunTestInLooperThread public void commitTransaction_delayChangeListenerOnSameThread ( ) { final AtomicInteger success = new AtomicInteger ( 0 ) ; diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java index 816f4fb..03e4e15 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java @ @ -244,38 +244,6 @ @ public class RealmTests { } @ Test - @ UiThreadTest - public void internalRealmChangedHandlersRemoved ( ) { - Info : Clarification on pr # 3370 and monitor threads __EoT__ @ beeender pr # 3370 Please clarify latest changelog regarding the below since the warning directly applies to us and may cause huge resource impact . We have 10+ realmConfigs . > The known problem is for every RealmConfiguration , a monitor thread will > be created which is not ideal for app which is using multiple > RealmConfiguration . - Monitor thread count : Is this monitor thread per realm , per thread ? If I open same realm in 2 different threads , how many monitor threads are there ? - Monitor thread life cycle : Is the thread created on first realm open and destroyed on last realm close ? Thanks
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 41680d0..0095d53 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -4,6 +4,7 @ @ * ` equals ( ) ` and ` hashCode ( ) ` of managed ` RealmObject ` s that come from linking objects do n't work correctly ( # 4487 ) . * Field name was missing in exception message when ` null ` was set to required field ( # 4484 ) . +* Now throws ` IllegalStateException ` when a getter of linking objects is called against deleted or not yet loaded ` RealmObject ` s ( # 4499 ) . # # # Internal diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 0dc79ea..71427de 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -569,6 +569,7 @ @ public class RealmProxyClassGenerator { writer.beginMethod ( realmResultsType , metadata.getInternalGetter ( backlink.getTargetField ( ) ) , EnumSet.of ( Modifier.PUBLIC ) ) .emitStatement ( `` BaseRealm realm = proxyState.getRealm $ realm ( ) '' ) .emitStatement ( `` realm.checkIfValid ( ) '' ) + .emitStatement ( `` proxyState.getRow $ realm ( ) .checkIfBacklinkAvailable ( ) '' ) .beginControlFlow ( `` if ( `` + cacheFieldName + `` == null ) '' ) .emitStatement ( cacheFieldName + `` Accessing backlinks field should throw IllegalState instead of IllegalArgument if the object is deleted or not loaded __EoT__ accessing backlinks of deleted or not loaded object is now throwing ` IllegalArgumentException ` . This should be ` IllegalStateException ` .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 21c5444..956cd41 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 0.90.0 + + # # # Breaking changes + +* @ PrimaryKey field value can be null for String , Byte , Short , Integer , and Long types , and should be migrated by using RealmObjectSchema.setNullable ( ) for older version of Realm ( # 2515 ) . + # # 0.89.0 # # # Enhancements diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 8982081..f94d294 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -330,11 +330,9 @ @ public class ClassMetaData { } public boolean isNullable ( VariableElement variableElement ) { - // primary keys can not be nullable - if ( hasPrimaryKey ( ) ) { - if ( variableElement.equals ( getPrimaryKey ( ) ) ) { - return false ; - } + // a primary key can be nullable only if its type could be found in JAVA_TO_NULLABLE_PRIMARYKEY_TYPES + if ( hasPrimaryKey ( ) & & variableElement.equals ( getPrimaryKey ( ) ) ) { + return Utils.isNullablePrimaryKeyType ( variableElement ) ; } return nullableFields.contains ( variableElement ) ; } diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java index 8cb7ec6..c181426 100644 Realm .so problem __EoT__ > **Bugs** : Build fingerprint : 'google/volantis/flounder:6.0.1/MMB29S/2489379 : user/release-keys' Revision : '0' ABI : 'arm64' pid : 22511 , tid : 22511 , name : mycom.myapp > > > com.mycom.myapp < < < signal 11 ( SIGSEGV ) , code 1 ( SEGV_MAPERR ) , fault addr 0x155c52b8c7e x0 0000007f8236dbf0 x1 0000007f8236dc38 x2 00000055ab2bc000 x3 00000055ab5dddb0 x4 0000000000001012 x5 0000000000000000 x6 00000155c52b8c66 x7 0000000000000000 x8 00000155c52b8c55 x9 0000000000000000 x10 0000000000000003 x11 0000000000000960 x12 0000007f8236da70 x13 00000055ab8be8b0 x14 0000000000000000 x15 00000155c52b8c50 x16 00000155c52b9d20 x17 0000000000000030 x18 0000002ab8a5718a x19 00000055ab5dcce0 x20 0000007f8236d000 x21 00000055ab5c6e20 x22 00000055ab5dcce0 x23 0000000000000000 x24 0000000070548ac8 x25 00000055ab5d81d0 x26 00000055ab5d81e0 x27 0000000012d571c0 x28 00000000715fd7ca x29 0000007fddcf8580 x30 00000155c52b8c78 sp 0000007fddcf8580 pc 0000007f8230670c pstate 0000000020000000 backtrace : # 00 pc 000000000004770c /system/lib64/libc.so ( dlfree+1036 ) # 01 pc 00000000000194e8 /system/lib64/libc.so ( free+20 ) # 02 pc 00000000000754dc /data/app/com.mycom.myapp-1/lib/arm64/librealm-jni.so # 03 pc 00000000000503b0 /data/app/com.mycom.myapp-1/lib/arm64/librealm-jni.so ( Java_io_realm_internal_SharedGroup_nativeClose+544 ) # 04 pc 000000000077b130 /data/app/com.mycom.myapp-1/oat/arm64/base.odex ( offset 0x47c000 ) ( void io.realm.internal.SharedGroup.nativeClose ( long ) +132 ) # 05 pc 000000000077c774 /data/app/com.mycom.myapp-1/oat/arm64/base.odex ( offset 0x47c000 ) ( void io.realm.internal.SharedGroup.close ( ) +168 ) # 06 pc 0000000000752e2c /data/app/com.mycom.myapp-1/oat/arm64/base.odex ( offset 0x47c000 ) ( void io.realm.Realm.close ( ) +848 )
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 21c5444..956cd41 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 0.90.0 + + # # # Breaking changes + +* @ PrimaryKey field value can be null for String , Byte , Short , Integer , and Long types , and should be migrated by using RealmObjectSchema.setNullable ( ) for older version of Realm ( # 2515 ) . + # # 0.89.0 # # # Enhancements diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 8982081..f94d294 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -330,11 +330,9 @ @ public class ClassMetaData { } public boolean isNullable ( VariableElement variableElement ) { - // primary keys can not be nullable - if ( hasPrimaryKey ( ) ) { - if ( variableElement.equals ( getPrimaryKey ( ) ) ) { - return false ; - } + // a primary key can be nullable only if its type could be found in JAVA_TO_NULLABLE_PRIMARYKEY_TYPES + if ( hasPrimaryKey ( ) & & variableElement.equals ( getPrimaryKey ( ) ) ) { + return Utils.isNullablePrimaryKeyType ( variableElement ) ; } return nullableFields.contains ( variableElement ) ; } diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java index 8cb7ec6..c181426 100644 Realm .so problem __EoT__ > **Bugs** : Build fingerprint : 'google/volantis/flounder:6.0.1/MMB29S/2489379 : user/release-keys' Revision : '0' ABI : 'arm64' pid : 22511 , tid : 22511 , name : mycom.myapp > > > com.mycom.myapp < < < signal 11 ( SIGSEGV ) , code 1 ( SEGV_MAPERR ) , fault addr 0x155c52b8c7e x0 0000007f8236dbf0 x1 0000007f8236dc38 x2 00000055ab2bc000 x3 00000055ab5dddb0 x4 0000000000001012 x5 0000000000000000 x6 00000155c52b8c66 x7 0000000000000000 x8 00000155c52b8c55 x9 0000000000000000 x10 0000000000000003 x11 0000000000000960 x12 0000007f8236da70 x13 00000055ab8be8b0 x14 0000000000000000 x15 00000155c52b8c50 x16 00000155c52b9d20 x17 0000000000000030 x18 0000002ab8a5718a x19 00000055ab5dcce0 x20 0000007f8236d000 x21 00000055ab5c6e20 x22 00000055ab5dcce0 x23 0000000000000000 x24 0000000070548ac8 x25 00000055ab5d81d0 x26 00000055ab5d81e0 x27 0000000012d571c0 x28 00000000715fd7ca x29 0000007fddcf8580 x30 00000155c52b8c78 sp 0000007fddcf8580 pc 0000007f8230670c pstate 0000000020000000 backtrace : # 00 pc 000000000004770c /system/lib64/libc.so ( dlfree+1036 ) # 01 pc 00000000000194e8 /system/lib64/libc.so ( free+20 ) # 02 pc 00000000000754dc /data/app/com.mycom.myapp-1/lib/arm64/librealm-jni.so # 03 pc 00000000000503b0 /data/app/com.mycom.myapp-1/lib/arm64/librealm-jni.so ( Java_io_realm_internal_SharedGroup_nativeClose+544 ) # 04 pc 000000000077b130 /data/app/com.mycom.myapp-1/oat/arm64/base.odex ( offset 0x47c000 ) ( void io.realm.internal.SharedGroup.nativeClose ( long ) +132 ) # 05 pc 000000000077c774 /data/app/com.mycom.myapp-1/oat/arm64/base.odex ( offset 0x47c000 ) ( void io.realm.internal.SharedGroup.close ( ) +168 ) # 06 pc 0000000000752e2c /data/app/com.mycom.myapp-1/oat/arm64/base.odex ( offset 0x47c000 ) ( void io.realm.Realm.close ( ) +848 )
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 21c5444..956cd41 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 0.90.0 + + # # # Breaking changes + +* @ PrimaryKey field value can be null for String , Byte , Short , Integer , and Long types , and should be migrated by using RealmObjectSchema.setNullable ( ) for older version of Realm ( # 2515 ) . + # # 0.89.0 # # # Enhancements diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 8982081..575c095 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -329,12 +329,15 @ @ public class ClassMetaData { return getGetter ( primaryKey.getSimpleName ( ) .toString ( ) ) ; } + /** + * Check if a VariableElement is nullable . In case of PrimaryKey field , such field can be + * nullable only if its type could be found in Constants # JAVA_TO_NULLABLE_PRIMARYKEY_TYPES . + * + * @ return { @ code true } if a VariableElement is nullable type , { @ code false } otherwise . + */ public boolean isNullable ( VariableElement variableElement ) { - // primary keys can not be nullable - if ( hasPrimaryKey ( ) ) Realm .so problem __EoT__ > **Bugs** : Build fingerprint : 'google/volantis/flounder:6.0.1/MMB29S/2489379 : user/release-keys' Revision : '0' ABI : 'arm64' pid : 22511 , tid : 22511 , name : mycom.myapp > > > com.mycom.myapp < < < signal 11 ( SIGSEGV ) , code 1 ( SEGV_MAPERR ) , fault addr 0x155c52b8c7e x0 0000007f8236dbf0 x1 0000007f8236dc38 x2 00000055ab2bc000 x3 00000055ab5dddb0 x4 0000000000001012 x5 0000000000000000 x6 00000155c52b8c66 x7 0000000000000000 x8 00000155c52b8c55 x9 0000000000000000 x10 0000000000000003 x11 0000000000000960 x12 0000007f8236da70 x13 00000055ab8be8b0 x14 0000000000000000 x15 00000155c52b8c50 x16 00000155c52b9d20 x17 0000000000000030 x18 0000002ab8a5718a x19 00000055ab5dcce0 x20 0000007f8236d000 x21 00000055ab5c6e20 x22 00000055ab5dcce0 x23 0000000000000000 x24 0000000070548ac8 x25 00000055ab5d81d0 x26 00000055ab5d81e0 x27 0000000012d571c0 x28 00000000715fd7ca x29 0000007fddcf8580 x30 00000155c52b8c78 sp 0000007fddcf8580 pc 0000007f8230670c pstate 0000000020000000 backtrace : # 00 pc 000000000004770c /system/lib64/libc.so ( dlfree+1036 ) # 01 pc 00000000000194e8 /system/lib64/libc.so ( free+20 ) # 02 pc 00000000000754dc /data/app/com.mycom.myapp-1/lib/arm64/librealm-jni.so # 03 pc 00000000000503b0 /data/app/com.mycom.myapp-1/lib/arm64/librealm-jni.so ( Java_io_realm_internal_SharedGroup_nativeClose+544 ) # 04 pc 000000000077b130 /data/app/com.mycom.myapp-1/oat/arm64/base.odex ( offset 0x47c000 ) ( void io.realm.internal.SharedGroup.nativeClose ( long ) +132 ) # 05 pc 000000000077c774 /data/app/com.mycom.myapp-1/oat/arm64/base.odex ( offset 0x47c000 ) ( void io.realm.internal.SharedGroup.close ( ) +168 ) # 06 pc 0000000000752e2c /data/app/com.mycom.myapp-1/oat/arm64/base.odex ( offset 0x47c000 ) ( void io.realm.Realm.close ( ) +848 )
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 5e07758..b4917e5 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -6,6 +6,7 @ @ * Added support for querying inverse relationships ( # 2904 ) . * Moved inverse relationships out of beta stage . +* Added ` Realm.getDefaultConfiguration ( ) ` ( # 4725 ) . # # # Bug Fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmConfigurationTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmConfigurationTests.java index 4064615..9889750 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmConfigurationTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmConfigurationTests.java @ @ -59,6 +59,7 @ @ import static org.junit.Assert.assertNotEquals ; import static org.junit.Assert.assertNotNull ; import static org.junit.Assert.assertNotSame ; import static org.junit.Assert.assertNull ; +import static org.junit.Assert.assertSame ; import static org.junit.Assert.assertTrue ; import static org.junit.Assert.fail ; import static org.mockito.Mockito.mock ; @ @ -91,15 +92,8 @ @ public class RealmConfigurationTests { } } - private void clearDefaultConfiguration ( ) throws NoSuchFieldException , IllegalAccessException { - final Field field = Realm.class.getDeclaredField ( `` defaultConfiguration '' ) ; - field.setAccessible ( true ) ; - field.set ( null , null ) ; - } - @ Test - public void setDefaultConfiguration_nullThrows ( ) throws NoSuchFieldException , IllegalAccessException { - clearDefaultConfiguration ( ) ; + public void setDefaultConfiguration_nullThrows ( ) { try { Realm.setDefaultConfiguration ( null ) ; fail ( ) ; @ @ -108,6 +102,26 Add Realm.getDefaultConfiguration ( ) __EoT__ We added ` Realm.getInstanceAsync ( ) ` and ` DynamicRealm.getInstanceAsync ( ) ` and those always required ` RealmConfiguration ` ( or ` SyncConfiguration ` ) . In order to pass default configuration to those methods , it 's better to have ` Realm.getDefaultConfiguration ( ) ` . What do you think ? @ realm/java
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 4e5ecf2..0cbc1be 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -69,18 +69,17 @ @ public class RealmProxyClassGenerator { imports.add ( `` io.realm.internal.ImplicitTransaction '' ) ; imports.add ( `` io.realm.internal.LinkView '' ) ; imports.add ( `` io.realm.internal.android.JsonUtils '' ) ; - imports.add ( `` io.realm.internal.Row '' ) ; imports.add ( `` java.io.IOException '' ) ; imports.add ( `` java.util.ArrayList '' ) ; imports.add ( `` java.util.Collections '' ) ; imports.add ( `` java.util.List '' ) ; + imports.add ( `` java.util.Iterator '' ) ; imports.add ( `` java.util.Date '' ) ; imports.add ( `` java.util.Map '' ) ; imports.add ( `` java.util.HashMap '' ) ; imports.add ( `` org.json.JSONObject '' ) ; imports.add ( `` org.json.JSONException '' ) ; imports.add ( `` org.json.JSONArray '' ) ; - imports.add ( `` java.util.concurrent.Future '' ) ; imports.add ( metadata.getFullyQualifiedClassName ( ) ) ; @ @ -122,6 +121,10 @ @ public class RealmProxyClassGenerator { emitCreateUsingJsonStream ( writer ) ; emitCopyOrUpdateMethod ( writer ) ; emitCopyMethod ( writer ) ; + emitInsertMethod ( writer ) ; + emitInsertListMethod ( writer ) ; + emitInsertOrUpdateMethod ( writer ) ; + emitInsertOrUpdateListMethod ( writer ) ; emitCreateDetachedCopyMethod ( writer ) ; emitUpdateMethod insertOrUpdate ( T t ) fails on RealmList < Persons > field __EoT__ # # # # Goal > What do you want to achieve ? Save a ` RentalProgram ` object that contains a ` RealmList < Persons > ` object # # # # Expected Results It should work just like when I used ` copyToRealmOrUpdate ( ) ` , which works # # # # Actual Results Using ` insertOrUpdate ( ) ` , the ` rentalProgram.getCast ( ) ` is empty ! # # # # Steps & Code to Reproduce > Describe your current debugging efforts . Frickin ' ProGuard eats my debug efforts , but it 's quite clear that the ` cast ` list is empty if I use ` insertOrUpdate ( ) ` , while it works as intended with ` copyToRealmOrUpdate ( ) ` . # # # # Code Sample `` ` java public class RentalProgram extends RealmObject { @ PrimaryKey private long id ; private RealmList < RentalProgramVersion > versions ; private String title ; private String href ; private String imageSrc ; private String baseInfoText ; private String originalTitle ; private String trailerUrl ; private String description ;
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 4e5ecf2..8fb4803 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -69,18 +69,17 @ @ public class RealmProxyClassGenerator { imports.add ( `` io.realm.internal.ImplicitTransaction '' ) ; imports.add ( `` io.realm.internal.LinkView '' ) ; imports.add ( `` io.realm.internal.android.JsonUtils '' ) ; - imports.add ( `` io.realm.internal.Row '' ) ; imports.add ( `` java.io.IOException '' ) ; imports.add ( `` java.util.ArrayList '' ) ; imports.add ( `` java.util.Collections '' ) ; imports.add ( `` java.util.List '' ) ; + imports.add ( `` java.util.Iterator '' ) ; imports.add ( `` java.util.Date '' ) ; imports.add ( `` java.util.Map '' ) ; imports.add ( `` java.util.HashMap '' ) ; imports.add ( `` org.json.JSONObject '' ) ; imports.add ( `` org.json.JSONException '' ) ; imports.add ( `` org.json.JSONArray '' ) ; - imports.add ( `` java.util.concurrent.Future '' ) ; imports.add ( metadata.getFullyQualifiedClassName ( ) ) ; @ @ -122,6 +121,10 @ @ public class RealmProxyClassGenerator { emitCreateUsingJsonStream ( writer ) ; emitCopyOrUpdateMethod ( writer ) ; emitCopyMethod ( writer ) ; + emitInsertMethod ( writer ) ; + emitInsertListMethod ( writer ) ; + emitInsertOrUpdateMethod ( writer ) ; + emitInsertOrUpdateListMethod ( writer ) ; emitCreateDetachedCopyMethod ( writer ) ; emitUpdateMethod insertOrUpdate ( T t ) fails on RealmList < Persons > field __EoT__ # # # # Goal > What do you want to achieve ? Save a ` RentalProgram ` object that contains a ` RealmList < Persons > ` object # # # # Expected Results It should work just like when I used ` copyToRealmOrUpdate ( ) ` , which works # # # # Actual Results Using ` insertOrUpdate ( ) ` , the ` rentalProgram.getCast ( ) ` is empty ! # # # # Steps & Code to Reproduce > Describe your current debugging efforts . Frickin ' ProGuard eats my debug efforts , but it 's quite clear that the ` cast ` list is empty if I use ` insertOrUpdate ( ) ` , while it works as intended with ` copyToRealmOrUpdate ( ) ` . # # # # Code Sample `` ` java public class RentalProgram extends RealmObject { @ PrimaryKey private long id ; private RealmList < RentalProgramVersion > versions ; private String title ; private String href ; private String imageSrc ; private String baseInfoText ; private String originalTitle ; private String trailerUrl ; private String description ;
diff -- git a/examples/encryptionExample/src/main/AndroidManifest.xml b/examples/encryptionExample/src/main/AndroidManifest.xml index 28d1c60..b3bb0e1 100644 -- - a/examples/encryptionExample/src/main/AndroidManifest.xml +++ b/examples/encryptionExample/src/main/AndroidManifest.xml @ @ -4,7 +4,7 @ @ < application android : allowBackup= '' true '' - android : icon= '' @ drawable/ic_launcher '' + android : icon= '' @ mipmap/ic_launcher '' android : label= '' @ string/app_name '' android : theme= '' @ style/AppTheme '' > < activity diff -- git a/examples/encryptionExample/src/main/res/drawable-xxhdpi/ic_launcher.png b/examples/encryptionExample/src/main/res/drawable-xxhdpi/ic_launcher.png deleted file mode 100644 index 4330211..0000000 Binary files a/examples/encryptionExample/src/main/res/drawable-xxhdpi/ic_launcher.png and /dev/null differ diff -- git a/examples/encryptionExample/src/main/res/mipmap-hdpi/ic_launcher.png b/examples/encryptionExample/src/main/res/mipmap-hdpi/ic_launcher.png new file mode 100755 index 0000000..58303af Binary files /dev/null and b/examples/encryptionExample/src/main/res/mipmap-hdpi/ic_launcher.png differ diff -- git a/examples/encryptionExample/src/main/res/mipmap-mdpi/ic_launcher.png b/examples/encryptionExample/src/main/res/mipmap-mdpi/ic_launcher.png new file mode 100755 index 0000000..9b29cae Binary files /dev/null and b/examples/encryptionExample/src/main/res/mipmap-mdpi/ic_launcher.png differ diff -- git a/examples/encryptionExample/src/main/res/mipmap-xhdpi/ic_launcher.png b/examples/encryptionExample/src/main/res/mipmap-xhdpi/ic_launcher.png new file mode 100755 index 0000000..15527b1 Binary files /dev/null and b/examples/encryptionExample/src/main/res/mipmap-xhdpi/ic_launcher.png differ diff -- git a/examples/encryptionExample/src/main/res/mipmap-xxhdpi/ic_launcher.png b/examples/encryptionExample/src/main/res/mipmap-xxhdpi/ic_launcher.png new file mode 100755 index 0000000..eb9ece0 Binary files /dev/null and b/examples/encryptionExample/src/main/res/mipmap-xxhdpi/ic_launcher.png differ diff -- git a/examples/encryptionExample/src/main/res/mipmap-xxxhdpi/ic_launcher.png b/examples/encryptionExample/src/main/res/mipmap-xxxhdpi/ic_launcher.png new file mode 100755 index 0000000..91826a7 Binary files /dev/null and b/examples/encryptionExample/src/main/res/mipmap-xxxhdpi/ic_launcher.png differ diff -- git a/examples/gridViewExample/src/main/AndroidManifest.xml b/examples/gridViewExample/src/main/AndroidManifest.xml index d7f791e..1bf1d87 100644 -- - a/examples/gridViewExample/src/main/AndroidManifest.xml +++ b/examples/gridViewExample/src/main/AndroidManifest.xml @ @ -4,7 +4,7 @ @ < application android : allowBackup= '' true '' - android : icon= '' @ drawable/ic_launcher '' + android : insertOrUpdate ( T t ) fails on RealmList < Persons > field __EoT__ # # # # Goal > What do you want to achieve ? Save a ` RentalProgram ` object that contains a ` RealmList < Persons > ` object # # # # Expected Results It should work just like when I used ` copyToRealmOrUpdate ( ) ` , which works # # # # Actual Results Using ` insertOrUpdate ( ) ` , the ` rentalProgram.getCast ( ) ` is empty ! # # # # Steps & Code to Reproduce > Describe your current debugging efforts . Frickin ' ProGuard eats my debug efforts , but it 's quite clear that the ` cast ` list is empty if I use ` insertOrUpdate ( ) ` , while it works as intended with ` copyToRealmOrUpdate ( ) ` . # # # # Code Sample `` ` java public class RentalProgram extends RealmObject { @ PrimaryKey private long id ; private RealmList < RentalProgramVersion > versions ; private String title ; private String href ; private String imageSrc ; private String baseInfoText ; private String originalTitle ; private String trailerUrl ; private String description ;
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 4e5ecf2..0cbc1be 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -69,18 +69,17 @ @ public class RealmProxyClassGenerator { imports.add ( `` io.realm.internal.ImplicitTransaction '' ) ; imports.add ( `` io.realm.internal.LinkView '' ) ; imports.add ( `` io.realm.internal.android.JsonUtils '' ) ; - imports.add ( `` io.realm.internal.Row '' ) ; imports.add ( `` java.io.IOException '' ) ; imports.add ( `` java.util.ArrayList '' ) ; imports.add ( `` java.util.Collections '' ) ; imports.add ( `` java.util.List '' ) ; + imports.add ( `` java.util.Iterator '' ) ; imports.add ( `` java.util.Date '' ) ; imports.add ( `` java.util.Map '' ) ; imports.add ( `` java.util.HashMap '' ) ; imports.add ( `` org.json.JSONObject '' ) ; imports.add ( `` org.json.JSONException '' ) ; imports.add ( `` org.json.JSONArray '' ) ; - imports.add ( `` java.util.concurrent.Future '' ) ; imports.add ( metadata.getFullyQualifiedClassName ( ) ) ; @ @ -122,6 +121,10 @ @ public class RealmProxyClassGenerator { emitCreateUsingJsonStream ( writer ) ; emitCopyOrUpdateMethod ( writer ) ; emitCopyMethod ( writer ) ; + emitInsertMethod ( writer ) ; + emitInsertListMethod ( writer ) ; + emitInsertOrUpdateMethod ( writer ) ; + emitInsertOrUpdateListMethod ( writer ) ; emitCreateDetachedCopyMethod ( writer ) ; emitUpdateMethod insertOrUpdate ( T t ) fails on RealmList < Persons > field __EoT__ # # # # Goal > What do you want to achieve ? Save a ` RentalProgram ` object that contains a ` RealmList < Persons > ` object # # # # Expected Results It should work just like when I used ` copyToRealmOrUpdate ( ) ` , which works # # # # Actual Results Using ` insertOrUpdate ( ) ` , the ` rentalProgram.getCast ( ) ` is empty ! # # # # Steps & Code to Reproduce > Describe your current debugging efforts . Frickin ' ProGuard eats my debug efforts , but it 's quite clear that the ` cast ` list is empty if I use ` insertOrUpdate ( ) ` , while it works as intended with ` copyToRealmOrUpdate ( ) ` . # # # # Code Sample `` ` java public class RentalProgram extends RealmObject { @ PrimaryKey private long id ; private RealmList < RentalProgramVersion > versions ; private String title ; private String href ; private String imageSrc ; private String baseInfoText ; private String originalTitle ; private String trailerUrl ; private String description ;
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 484ca34..f2c660c 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -9,6 +9,7 @ @ * Fixed a wrong JNI method declaration which might cause `` method not found '' crash on some devices . * Fixed a bug that ` Error ` in the background async thread is not forwared to the caller thread . * Fixed a crash when an empty ` Collection ` is passed to ` insert ( ) ` / ` insertOrUpdate ( ) ` ( # 3103 ) . +* Fixed bug in ` Realm.insert ` and ` Realm.insertOrUpdate ` methods causing a ` RealmList ` to be cleared when inserting a managed ` RealmModel ` ( # 3105 ) . * Fixed a concurrency allocation bug in storage engine which might lead to some random crashes . # # # Internal diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index fde869e..4a94341 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -780,6 +780,12 @ @ public class RealmProxyClassGenerator { `` Realm '' , `` realm '' , qualifiedClassName , `` object '' , `` Map < RealmModel , Long > '' , `` cache '' // Argument type & argument name ) ; + insertOrUpdate ( T t ) fails on RealmList < Persons > field __EoT__ # # # # Goal > What do you want to achieve ? Save a ` RentalProgram ` object that contains a ` RealmList < Persons > ` object # # # # Expected Results It should work just like when I used ` copyToRealmOrUpdate ( ) ` , which works # # # # Actual Results Using ` insertOrUpdate ( ) ` , the ` rentalProgram.getCast ( ) ` is empty ! # # # # Steps & Code to Reproduce > Describe your current debugging efforts . Frickin ' ProGuard eats my debug efforts , but it 's quite clear that the ` cast ` list is empty if I use ` insertOrUpdate ( ) ` , while it works as intended with ` copyToRealmOrUpdate ( ) ` . # # # # Code Sample `` ` java public class RentalProgram extends RealmObject { @ PrimaryKey private long id ; private RealmList < RentalProgramVersion > versions ; private String title ; private String href ; private String imageSrc ; private String baseInfoText ; private String originalTitle ; private String trailerUrl ; private String description ;
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 472c8f6..3c2caf9 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -16,6 +16,7 @ @ * Fixed a bug that ` Error ` in the background async thread is not forwarded to the caller thread . * Fixed a crash when an empty ` Collection ` is passed to ` insert ( ) ` / ` insertOrUpdate ( ) ` ( # 3103 ) . * Fixed a bug that does not transfer the primary key when ` RealmSchemaObject.setClassName ( ) ` is called to rename a class ( # 3118 ) . +* Fixed bug in ` Realm.insert ` and ` Realm.insertOrUpdate ` methods causing a ` RealmList ` to be cleared when inserting a managed ` RealmModel ` ( # 3105 ) . * Fixed a concurrency allocation bug in storage engine which might lead to some random crashes . * Bulk insertion now throws if it is not called in a transaction ( # 3173 ) . * The IllegalStateException thrown when accessing an empty RealmObject is now more meaningful ( # 3200 ) . diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index a860958..28472af 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -780,6 +780,12 @ insertOrUpdate ( T t ) fails on RealmList < Persons > field __EoT__ # # # # Goal > What do you want to achieve ? Save a ` RentalProgram ` object that contains a ` RealmList < Persons > ` object # # # # Expected Results It should work just like when I used ` copyToRealmOrUpdate ( ) ` , which works # # # # Actual Results Using ` insertOrUpdate ( ) ` , the ` rentalProgram.getCast ( ) ` is empty ! # # # # Steps & Code to Reproduce > Describe your current debugging efforts . Frickin ' ProGuard eats my debug efforts , but it 's quite clear that the ` cast ` list is empty if I use ` insertOrUpdate ( ) ` , while it works as intended with ` copyToRealmOrUpdate ( ) ` . # # # # Code Sample `` ` java public class RentalProgram extends RealmObject { @ PrimaryKey private long id ; private RealmList < RentalProgramVersion > versions ; private String title ; private String href ; private String imageSrc ; private String baseInfoText ; private String originalTitle ; private String trailerUrl ; private String description ;
diff -- git a/realm/src/androidTest/java/io/realm/RealmMigrationTests.java b/realm/src/androidTest/java/io/realm/RealmMigrationTests.java index 680965a..6b8cd25 100644 -- - a/realm/src/androidTest/java/io/realm/RealmMigrationTests.java +++ b/realm/src/androidTest/java/io/realm/RealmMigrationTests.java @ @ -2,9 +2,12 @ @ package io.realm ; import android.test.AndroidTestCase ; +import java.io.File ; import java.io.IOException ; +import io.realm.dynamic.RealmSpec ; import io.realm.entities.AllTypes ; +import io.realm.entities.Dog ; import io.realm.exceptions.RealmMigrationNeededException ; public class RealmMigrationTests extends AndroidTestCase { @ @ -25,4 +28,26 @ @ public class RealmMigrationTests extends AndroidTestCase { int result = realm.where ( AllTypes.class ) .equalTo ( `` columnString '' , `` Foo '' ) .findAll ( ) .size ( ) ; assertEquals ( 0 , result ) ; } + + // Create a Realm file with no Realm classes + private void createEmptyDefaultRealm ( ) { + Realm.setSchema ( AllTypes.class ) ; + Realm.deleteRealmFile ( getContext ( ) ) ; + Realm realm = Realm.getInstance ( getContext ( ) ) ; + realm.close ( ) ; + } + + private String getDefaultRealm ( ) { + return new File ( getContext ( ) .getFilesDir ( ) , `` default.realm '' ) .getAbsolutePath ( ) ; + } + + public void testAddClass ( ) { + createEmptyDefaultRealm ( ) ; + Realm.migrateRealmAtPath ( getDefaultRealm ( ) , new RealmMigration ( ) { + @ Remove a table from a previous Realm scheme __EoT__ Hi , With the introduction of Modules ( Realm 0.82.0 ) , I have splitted a part of my scheme into another Realm . However , the old database ( which is now a core Module ) still contains tables that are no longer needed ( and data as well ) . Example : Old scheme contained **A , B , C** into ` main.realm ` . New scheme is now splitted in two Modules **A , B** into ` main.realm ` **C** into ` second.realm ` Following the app update , ` main.realm ` still contains a table **C** and I 'm unable to clean nor delete the table manually ( error like 'this entity is not part of this module ' ) . Is there a way I did not find ? Thanks .
diff -- git a/realm-jni/src/io_realm_internal_Group.cpp b/realm-jni/src/io_realm_internal_Group.cpp index f39edfa..440dff3 100644 -- - a/realm-jni/src/io_realm_internal_Group.cpp +++ b/realm-jni/src/io_realm_internal_Group.cpp @ @ -158,6 +158,27 @ @ JNIEXPORT jstring JNICALL Java_io_realm_internal_Group_nativeGetTableName ( return 0 ; } +JNIEXPORT void JNICALL Java_io_realm_internal_Group_nativeRemoveTable ( + JNIEnv* env , jobject , jlong nativeGroupPtr , jstring name ) + { + TR_ENTER_PTR ( nativeGroupPtr ) + try { + JStringAccessor table_name ( env , name ) ; + G ( nativeGroupPtr ) - > remove_table ( table_name ) ; + } CATCH_STD ( ) + } + +JNIEXPORT void JNICALL Java_io_realm_internal_Group_nativeRenameTable ( + JNIEnv* env , jobject , jlong nativeGroupPtr , jstring oldName , jstring newName ) + { + TR_ENTER_PTR ( nativeGroupPtr ) + try { + JStringAccessor old_name ( env , oldName ) ; + JStringAccessor new_name ( env , newName ) ; + G ( nativeGroupPtr ) - > rename_table ( old_name , new_name ) ; + } CATCH_STD ( ) + } + JNIEXPORT jlong JNICALL Java_io_realm_internal_Group_nativeGetTableNativePtr ( JNIEnv *env , jobject , jlong nativeGroupPtr , jstring name ) { diff -- git a/realm-jni/src/io_realm_internal_Group.h b/realm-jni/src/io_realm_internal_Group.h index 46ee4e7..4aa1180 100644 -- - a/realm-jni/src/io_realm_internal_Group.h +++ b/realm-jni/src/io_realm_internal_Group.h @ @ -73,6 +73,22 @ @ JNIEXPORT jstring JNICALL Java_io_realm_internal_Group_nativeGetTableName /* * Class : io_realm_internal_Group + Remove a table from a previous Realm scheme __EoT__ Hi , With the introduction of Modules ( Realm 0.82.0 ) , I have splitted a part of my scheme into another Realm . However , the old database ( which is now a core Module ) still contains tables that are no longer needed ( and data as well ) . Example : Old scheme contained **A , B , C** into ` main.realm ` . New scheme is now splitted in two Modules **A , B** into ` main.realm ` **C** into ` second.realm ` Following the app update , ` main.realm ` still contains a table **C** and I 'm unable to clean nor delete the table manually ( error like 'this entity is not part of this module ' ) . Is there a way I did not find ? Thanks .
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 896e142..e61ba18 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -367,7 +367,11 @ @ public class ClassMetaData { * model classes . */ public boolean isModelClass ( ) { - return ( ! classType.toString ( ) .endsWith ( `` .RealmObject '' ) & & ! classType.toString ( ) .endsWith ( `` RealmProxy '' ) ) ; + String type = classType.toString ( ) ; + if ( type.equals ( `` io.realm.dynamic.DynamicRealmObject '' ) ) { + return false ; + } + return ( ! type.endsWith ( `` .RealmObject '' ) & & ! type.endsWith ( `` RealmProxy '' ) ) ; } public String getFullyQualifiedClassName ( ) { diff -- git a/realm-jni/src/io_realm_internal_CheckedRow.cpp b/realm-jni/src/io_realm_internal_CheckedRow.cpp index 4374a1d..031afa3 100644 -- - a/realm-jni/src/io_realm_internal_CheckedRow.cpp +++ b/realm-jni/src/io_realm_internal_CheckedRow.cpp @ @ -226,7 +226,7 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_CheckedRow_nativeSetString if ( ! ROW_AND_COL_INDEX_AND_TYPE_VALID ( env , ROW ( nativeRowPtr ) , columnIndex , type_String ) ) return ; - Java_io_realm_internal_CheckedRow_nativeSetString ( env , obj , nativeRowPtr , columnIndex , value ) ; + Java_io_realm_internal_UncheckedRow_nativeSetString ( env , obj , nativeRowPtr , columnIndex , value ) ; } JNIEXPORT void JNICALL Java_io_realm_internal_CheckedRow_nativeSetByteArray @ @ -263,4 +263,4 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_CheckedRow_nativeNullifyLink return Remove a table from a previous Realm scheme __EoT__ Hi , With the introduction of Modules ( Realm 0.82.0 ) , I have splitted a part of my scheme into another Realm . However , the old database ( which is now a core Module ) still contains tables that are no longer needed ( and data as well ) . Example : Old scheme contained **A , B , C** into ` main.realm ` . New scheme is now splitted in two Modules **A , B** into ` main.realm ` **C** into ` second.realm ` Following the app update , ` main.realm ` still contains a table **C** and I 'm unable to clean nor delete the table manually ( error like 'this entity is not part of this module ' ) . Is there a way I did not find ? Thanks .
diff -- git a/realm/src/androidTest/java/io/realm/RealmTest.java b/realm/src/androidTest/java/io/realm/RealmTest.java index 8b9fd14..cc11ea5 100644 -- - a/realm/src/androidTest/java/io/realm/RealmTest.java +++ b/realm/src/androidTest/java/io/realm/RealmTest.java @ @ -62,6 +62,8 @ @ import io.realm.entities.PrimaryKeyMix ; import io.realm.entities.StringOnly ; import io.realm.exceptions.RealmException ; import io.realm.exceptions.RealmIOException ; +import io.realm.internal.SharedGroupManager ; +import io.realm.base.RealmBase ; import io.realm.internal.SharedGroup ; import io.realm.internal.Table ; @ @ -1686,43 +1688,53 @ @ public class RealmTest extends AndroidTestCase { // Check that FinalizerRunnable can free native resources ( phantom refs ) public void testReferenceCleaning ( ) throws NoSuchFieldException , IllegalAccessException { - Field sharedGroupReference = Realm.class.getDeclaredField ( `` sharedGroup '' ) ; - sharedGroupReference.setAccessible ( true ) ; - SharedGroup sharedGroup = ( SharedGroup ) sharedGroupReference.get ( testRealm ) ; - assertNotNull ( sharedGroup ) ; + RealmConfiguration config = new RealmConfiguration.Builder ( getContext ( ) ) .name ( `` myown '' ) .build ( ) ; + Realm.deleteRealm ( config ) ; + testRealm = Realm.getInstance ( config ) ; + + // Manipulate field accessibility to facilitate testing + Field realmFileReference = RealmBase.class.getDeclaredField ( `` sharedGroup '' ) ; + realmFileReference.setAccessible ( true ) ; Field contextField = SharedGroup.class.getDeclaredField ( `` context '' ) ; contextField.setAccessible ( true ) ; - io.realm.internal.Context context = ( io.realm.internal.Context ) contextField.get ( sharedGroup ) ; Remove a table from a previous Realm scheme __EoT__ Hi , With the introduction of Modules ( Realm 0.82.0 ) , I have splitted a part of my scheme into another Realm . However , the old database ( which is now a core Module ) still contains tables that are no longer needed ( and data as well ) . Example : Old scheme contained **A , B , C** into ` main.realm ` . New scheme is now splitted in two Modules **A , B** into ` main.realm ` **C** into ` second.realm ` Following the app update , ` main.realm ` still contains a table **C** and I 'm unable to clean nor delete the table manually ( error like 'this entity is not part of this module ' ) . Is there a way I did not find ? Thanks .
diff -- git a/realm/src/androidTest/java/io/realm/RealmTest.java b/realm/src/androidTest/java/io/realm/RealmTest.java index 7526947..8c8917f 100644 -- - a/realm/src/androidTest/java/io/realm/RealmTest.java +++ b/realm/src/androidTest/java/io/realm/RealmTest.java @ @ -16,12 +16,9 @ @ package io.realm ; import android.content.Context ; -import android.os.SystemClock ; import android.test.AndroidTestCase ; -import android.util.Log ; import junit.framework.AssertionFailedError ; -import junit.framework.Test ; import org.json.JSONArray ; import org.json.JSONException ; @ @ -30,8 +27,6 @ @ import org.json.JSONObject ; import java.io.File ; import java.io.IOException ; import java.io.InputStream ; -import java.lang.ref.Reference ; -import java.lang.reflect.Field ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Date ; @ @ -44,7 +39,6 @ @ import java.util.concurrent.ExecutionException ; import java.util.concurrent.ExecutorService ; import java.util.concurrent.Executors ; import java.util.concurrent.Future ; -import java.util.concurrent.TimeUnit ; import io.realm.dynamic.DynamicRealmObject ; import io.realm.entities.AllTypes ; @ @ -63,7 +57,6 @ @ import io.realm.entities.PrimaryKeyMix ; import io.realm.entities.StringOnly ; import io.realm.exceptions.RealmException ; import io.realm.exceptions.RealmIOException ; -import io.realm.internal.SharedGroup ; import io.realm.internal.Table ; import static io.realm.internal.test.ExtraTests.assertArrayEquals ; @ @ -197,21 +190,21 @ @ public class RealmTest extends AndroidTestCase { final String REALM_NAME = `` test-internalhandlers '' ; RealmConfiguration realmConfig = TestHelper.createConfiguration ( getContext ( ) , REALM_NAME ) ; Realm.deleteRealm ( realmConfig ) ; - Realm.handlers.clear ( ) ; // Make sure that handlers from other unit tests does n't interfere . + Realm.getHandlers ( ) .clear ( ) ; // Make sure Remove a table from a previous Realm scheme __EoT__ Hi , With the introduction of Modules ( Realm 0.82.0 ) , I have splitted a part of my scheme into another Realm . However , the old database ( which is now a core Module ) still contains tables that are no longer needed ( and data as well ) . Example : Old scheme contained **A , B , C** into ` main.realm ` . New scheme is now splitted in two Modules **A , B** into ` main.realm ` **C** into ` second.realm ` Following the app update , ` main.realm ` still contains a table **C** and I 'm unable to clean nor delete the table manually ( error like 'this entity is not part of this module ' ) . Is there a way I did not find ? Thanks .
diff -- git a/.idea/codeStyleSettings.xml b/.idea/codeStyleSettings.xml deleted file mode 100644 index 163bd73..0000000 -- - a/.idea/codeStyleSettings.xml +++ /dev/null @ @ -1,218 +0,0 @ @ - < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > - < project version= '' 4 '' > - < component name= '' ProjectCodeStyleSettingsManager '' > - < option name= '' PER_PROJECT_SETTINGS '' > - < value > - < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 99 '' / > - < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 99 '' / > - < option name= '' PACKAGES_TO_USE_IMPORT_ON_DEMAND '' > - < value / > - < /option > - < option name= '' IMPORT_LAYOUT_TABLE '' > - < value > - < package name= '' android '' withSubpackages= '' true '' static= '' false '' / > - < emptyLine / > - < package name= '' com '' withSubpackages= '' true '' static= '' false '' / > - < emptyLine / > - < package name= '' junit '' withSubpackages= '' true '' static= '' false '' / > - < emptyLine / > - < package name= '' net '' withSubpackages= '' true '' static= '' false '' Remove a table from a previous Realm scheme __EoT__ Hi , With the introduction of Modules ( Realm 0.82.0 ) , I have splitted a part of my scheme into another Realm . However , the old database ( which is now a core Module ) still contains tables that are no longer needed ( and data as well ) . Example : Old scheme contained **A , B , C** into ` main.realm ` . New scheme is now splitted in two Modules **A , B** into ` main.realm ` **C** into ` second.realm ` Following the app update , ` main.realm ` still contains a table **C** and I 'm unable to clean nor delete the table manually ( error like 'this entity is not part of this module ' ) . Is there a way I did not find ? Thanks .
diff -- git a/changelog.txt b/changelog.txt index 0a887c3..eff2cdc 100644 -- - a/changelog.txt +++ b/changelog.txt @ @ -1,4 +1,8 @ @ 0.83 + * BREAKING CHANGE : RealmResults.SORT_ORDER_ASCENDING and RealmResults.SORT_ORDER_DESCENDING constants + has been replaced by Sort.ASCENDING and Sort.DESCENDING enums . + * BREAKING CHANGE : RealmQuery.CASE_SENSITIVE and RealmQuery.CASE_INSENSITIVE constants has been + replaced by Case.SENSITIVE and Case.INSENSITIVE enums . * BREAKING CHANGE : Database file format update . The Realm file created by this version can not be used by previous versions of Realm . * BREAKING CHANGE : Removed deprecated methods and constructors from the Realm class . * Added support for x86_64 . diff -- git a/examples/introExample/src/main/java/io/realm/examples/intro/IntroExampleActivity.java b/examples/introExample/src/main/java/io/realm/examples/intro/IntroExampleActivity.java index 3fa8476..5b61942 100644 -- - a/examples/introExample/src/main/java/io/realm/examples/intro/IntroExampleActivity.java +++ b/examples/introExample/src/main/java/io/realm/examples/intro/IntroExampleActivity.java @ @ -25,11 +25,11 @ @ import android.widget.TextView ; import io.realm.Realm ; import io.realm.RealmResults ; +import io.realm.Sort ; import io.realm.examples.intro.model.Cat ; import io.realm.examples.intro.model.Dog ; import io.realm.examples.intro.model.Person ; - public class IntroExampleActivity extends Activity { public static final String TAG = IntroExampleActivity.class.getName ( ) ; @ @ -187,7 +187,7 @ @ public class IntroExampleActivity extends Activity { // Sorting RealmResults < Person > sortedPersons = realm.allObjects ( Person.class ) ; - sortedPersons.sort ( `` age '' , false ) ; + sortedPersons.sort ( `` Remove a table from a previous Realm scheme __EoT__ Hi , With the introduction of Modules ( Realm 0.82.0 ) , I have splitted a part of my scheme into another Realm . However , the old database ( which is now a core Module ) still contains tables that are no longer needed ( and data as well ) . Example : Old scheme contained **A , B , C** into ` main.realm ` . New scheme is now splitted in two Modules **A , B** into ` main.realm ` **C** into ` second.realm ` Following the app update , ` main.realm ` still contains a table **C** and I 'm unable to clean nor delete the table manually ( error like 'this entity is not part of this module ' ) . Is there a way I did not find ? Thanks .
diff -- git a/.idea/codeStyleSettings.xml b/.idea/codeStyleSettings.xml deleted file mode 100644 index 163bd73..0000000 -- - a/.idea/codeStyleSettings.xml +++ /dev/null @ @ -1,218 +0,0 @ @ - < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > - < project version= '' 4 '' > - < component name= '' ProjectCodeStyleSettingsManager '' > - < option name= '' PER_PROJECT_SETTINGS '' > - < value > - < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 99 '' / > - < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 99 '' / > - < option name= '' PACKAGES_TO_USE_IMPORT_ON_DEMAND '' > - < value / > - < /option > - < option name= '' IMPORT_LAYOUT_TABLE '' > - < value > - < package name= '' android '' withSubpackages= '' true '' static= '' false '' / > - < emptyLine / > - < package name= '' com '' withSubpackages= '' true '' static= '' false '' / > - < emptyLine / > - < package name= '' junit '' withSubpackages= '' true '' static= '' false '' / > - < emptyLine / > - < package name= '' net '' withSubpackages= '' true '' static= '' false '' Remove a table from a previous Realm scheme __EoT__ Hi , With the introduction of Modules ( Realm 0.82.0 ) , I have splitted a part of my scheme into another Realm . However , the old database ( which is now a core Module ) still contains tables that are no longer needed ( and data as well ) . Example : Old scheme contained **A , B , C** into ` main.realm ` . New scheme is now splitted in two Modules **A , B** into ` main.realm ` **C** into ` second.realm ` Following the app update , ` main.realm ` still contains a table **C** and I 'm unable to clean nor delete the table manually ( error like 'this entity is not part of this module ' ) . Is there a way I did not find ? Thanks .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 9134f56..5e9654f 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -5,6 +5,7 @ @ # # # Enhancements * [ ObjectServer ] Added support for ` SyncUser.isAdmin ( ) ` ( # 4353 ) . +* [ ObjectServer ] Added support for changing passwords through ` SyncUser.changePassword ( ) ` ( # 4423 ) . * Transient fields are now allowed in model classes , but are implicitly treated as having the ` @ Ignore ` annotation ( # 4279 ) . * Added ` Realm.refresh ( ) ` and ` DynamicRealm.refresh ( ) ` ( # 3476 ) . diff -- git a/dependencies.list b/dependencies.list index 06db1ee..7a9a094 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -10,4 +10,4 @ @ REALM_SYNC_SHA256=e8a973dbe6ab33ac49d3d0e45d6b63d69cec8d1d87d9a2311fcdd02767f76c # /tools/sync_test_server/Dockerfile specify which repo ( apt ) we should # install/use between 'realm ' and 'realm-testing ' , the version below should # correspond to an existing version on the *specified* repo . -REALM_OBJECT_SERVER_DE_VERSION=1.3.0-294 +REALM_OBJECT_SERVER_DE_VERSION=1.4.0-302 diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SyncUserTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SyncUserTests.java index fe69cff..dbcdb05 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SyncUserTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SyncUserTests.java @ @ -268,4 +268,34 @ @ public class SyncUserTests { SyncManager.setAuthServerImpl ( originalServer ) ; } } + + @ Test + public void changePassword_nullThrows ( Change Password API for Admin Users __EoT__ Fallout from # 4538 We need to implement admin support for changing a user 's password once support for this has been released by ROS . It has been merged but is awaiting a release : https : //github.com/realm/realm-object-server/pull/1061 API : `` ` // Should only work for ` admin ` users user.changePasswordAsync ( `` userID '' , `` newPassword '' , new Callback ( ) { @ Override public void onSuccess ( SyncUser user ) { // This standard callback might be a bit weird since we would return the admin user instead of the user that got his password changed , } @ Override public void onError ( ObjectServerError error ) { // Something went wrong } } ) ; public interface RequestCallback < T > { onSuccess ( T result ) ; onError ( ObjectServerError ) ; } new RequestCallback < Void > ( ) { public void onSuccess ( Void result ) { ... } } `` ` Some alternatives : - New ` AdminCallback ` with ` onSuccess ( String userId ) ` method instead . Might be handy if we start adding multiple admin API 's .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 966045e..55576c1 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -15,6 +15,8 @ @ * Migration for linking objects is not yet supported . * Backlink verification is incomplete . Evil code can cause native crashes . * [ ObjectServer ] In case of a Client Reset , information about the location of the backed up Realm file is now reported through the ` ErrorHandler ` interface ( # 4080 ) . +* The listener on ` RealmObject ` will only be triggered if the object changes ( # 3894 ) . +* Added ` RealmObjectChangeListener ` to get detailed information about ` RealmObejct ` changes . # # # Bug Fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java index 8e3f499..6bd270b 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java +++ b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java @ @ -28,7 +28,6 @ @ import junit.framework.AssertionFailedError ; import org.junit.After ; import org.junit.Before ; -import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -799,28 +798,6 @ @ public class NotificationsTest { } ) ; } - // TODO : Fix or delete this test after integration of object notification from Object Store - @ Test - @ RunTestInLooperThread - @ Ignore - public void Single Object Notifications __EoT__ **Motivation** https : //github.com/realm/realm-object-store/pull/324 added support for single object notifications to the Object Store https : //github.com/realm/realm-cocoa/pull/4537 is adding the public API 's on the Cocoa side . We should add similar capabilities to Android . **Use cases** 1 ) Object change listeners will now only be called if the object actually changed . It should reduce the number of unnecessary updates which is happening right now due to the change notification being table based . 2 ) It should make it possible to register listeners for a single field value , e.g . if the UI should only be refreshed if a single field changed . 3 ) It should be possible to register a listener on an object and be give the old and new values , e.g . useful if you only need to refresh the UI if a String changed in a particular way . 3 ) It should now be possible to be notified when an object is deleted . See https : //github.com/realm/realm-java/issues/3138 . Realm classes only implementing `` RealmModel '' might be tricky to support . 4 ) We should strive for easy integration with Databinding https : //developer.android.com/topic/libraries/data-binding/index.html
diff -- git a/CHANGELOG.md b/CHANGELOG.md index db45345..01c404f 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -15,6 +15,8 @ @ * Migration for linking objects is not yet supported . * Backlink verification is incomplete . Evil code can cause native crashes . * [ ObjectServer ] In case of a Client Reset , information about the location of the backed up Realm file is now reported through the ` ErrorHandler ` interface ( # 4080 ) . +* The listener on ` RealmObject ` will only be triggered if the object changes ( # 3894 ) . +* Added ` RealmObjectChangeListener ` to get detailed information about ` RealmObject ` changes . # # # Bug Fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/LinkingObjectsManagedTests.java b/realm/realm-library/src/androidTest/java/io/realm/LinkingObjectsManagedTests.java index 302c395..9c75ee8 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/LinkingObjectsManagedTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/LinkingObjectsManagedTests.java @ @ -151,44 +151,6 @ @ public class LinkingObjectsManagedTests { assertEquals ( parent , child.getListParents ( ) .last ( ) ) ; } - // A listener registered on the backlinked object should be called when a commit adds a backlink - @ Test - @ RunTestInLooperThread - public void notification_onCommitModelObject ( ) { - final Realm looperThreadRealm = looperThread.realm ; - - looperThreadRealm.beginTransaction ( ) ; - AllJavaTypes child Single Object Notifications __EoT__ **Motivation** https : //github.com/realm/realm-object-store/pull/324 added support for single object notifications to the Object Store https : //github.com/realm/realm-cocoa/pull/4537 is adding the public API 's on the Cocoa side . We should add similar capabilities to Android . **Use cases** 1 ) Object change listeners will now only be called if the object actually changed . It should reduce the number of unnecessary updates which is happening right now due to the change notification being table based . 2 ) It should make it possible to register listeners for a single field value , e.g . if the UI should only be refreshed if a single field changed . 3 ) It should be possible to register a listener on an object and be give the old and new values , e.g . useful if you only need to refresh the UI if a String changed in a particular way . 3 ) It should now be possible to be notified when an object is deleted . See https : //github.com/realm/realm-java/issues/3138 . Realm classes only implementing `` RealmModel '' might be tricky to support . 4 ) We should strive for easy integration with Databinding https : //developer.android.com/topic/libraries/data-binding/index.html
diff -- git a/CHANGELOG.md b/CHANGELOG.md index db45345..01c404f 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -15,6 +15,8 @ @ * Migration for linking objects is not yet supported . * Backlink verification is incomplete . Evil code can cause native crashes . * [ ObjectServer ] In case of a Client Reset , information about the location of the backed up Realm file is now reported through the ` ErrorHandler ` interface ( # 4080 ) . +* The listener on ` RealmObject ` will only be triggered if the object changes ( # 3894 ) . +* Added ` RealmObjectChangeListener ` to get detailed information about ` RealmObject ` changes . # # # Bug Fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/LinkingObjectsManagedTests.java b/realm/realm-library/src/androidTest/java/io/realm/LinkingObjectsManagedTests.java index 302c395..9c75ee8 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/LinkingObjectsManagedTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/LinkingObjectsManagedTests.java @ @ -151,44 +151,6 @ @ public class LinkingObjectsManagedTests { assertEquals ( parent , child.getListParents ( ) .last ( ) ) ; } - // A listener registered on the backlinked object should be called when a commit adds a backlink - @ Test - @ RunTestInLooperThread - public void notification_onCommitModelObject ( ) { - final Realm looperThreadRealm = looperThread.realm ; - - looperThreadRealm.beginTransaction ( ) ; - AllJavaTypes child Single Object Notifications __EoT__ **Motivation** https : //github.com/realm/realm-object-store/pull/324 added support for single object notifications to the Object Store https : //github.com/realm/realm-cocoa/pull/4537 is adding the public API 's on the Cocoa side . We should add similar capabilities to Android . **Use cases** 1 ) Object change listeners will now only be called if the object actually changed . It should reduce the number of unnecessary updates which is happening right now due to the change notification being table based . 2 ) It should make it possible to register listeners for a single field value , e.g . if the UI should only be refreshed if a single field changed . 3 ) It should be possible to register a listener on an object and be give the old and new values , e.g . useful if you only need to refresh the UI if a String changed in a particular way . 3 ) It should now be possible to be notified when an object is deleted . See https : //github.com/realm/realm-java/issues/3138 . Realm classes only implementing `` RealmModel '' might be tricky to support . 4 ) We should strive for easy integration with Databinding https : //developer.android.com/topic/libraries/data-binding/index.html
diff -- git a/realm/gradle.properties b/realm/gradle.properties index 0be17a4..b9c4198 100644 -- - a/realm/gradle.properties +++ b/realm/gradle.properties @ @ -1,2 +1,3 @ @ org.gradle.jvmargs=-Xms512m -Xmx2048m org.gradle.caching=true +kotlin.incremental=false ; diff -- git a/realm/kotlin-extensions/.gitignore b/realm/kotlin-extensions/.gitignore new file mode 100644 index 0000000..796b96d -- - /dev/null +++ b/realm/kotlin-extensions/.gitignore @ @ -0,0 +1 @ @ +/build diff -- git a/realm/kotlin-extensions/build.gradle b/realm/kotlin-extensions/build.gradle new file mode 100644 index 0000000..82c8126 -- - /dev/null +++ b/realm/kotlin-extensions/build.gradle @ @ -0,0 +1,61 @ @ +apply plugin : 'com.android.library' +apply plugin : 'kotlin-android' +apply plugin : 'kotlin-kapt' +import io.realm.transformer.RealmTransformer +android.registerTransform ( new RealmTransformer ( ) ) + +android { + compileSdkVersion 26 + buildToolsVersion `` 26.0.1 '' + + defaultConfig { + minSdkVersion 9 + targetSdkVersion 25 + versionCode 1 + versionName `` 1.0 '' + + testInstrumentationRunner `` android.support.test.runner.AndroidJUnitRunner '' + + flavorSelection 'api ' , 'base' + // flavorSelection is replaced by missingDimensionStrategy in beta4 . Use following line instead on beta4 or later . + // https : //androidstudio.googleblog.com/2017/09/android-studio-30-beta-4-is-now.html + //missingDimensionStrategy 'api ' , 'base' + } + buildTypes { + debug { + // https : //youtrack.jetbrains.com/issue/KT-11333 + // Until this is resolved , enabling code coverage will break extension functions + // during instrumentation testing . + testCoverageEnabled = false + Request for community comments : Better Kotlin support __EoT__ With an awesome I/O17 being over , one of the big announcements were official support for [ Kotlin ] ( https : //blog.jetbrains.com/kotlin/2017/05/kotlin-on-android-now-official/ ) . Realm is already fully interoperable with Kotlin and we have a [ Kotlin example here ] ( https : //github.com/realm/realm-java/tree/master/examples/kotlinExample ) and [ here ] ( https : //github.com/realm-demos/realm-surveys/tree/master/Kotlin ) that demonstrates how it works . But we want to make that support even better and In order to do that , we are looking for feedback on what you would most like to see changed so Realm works even better with Kotlin We have a few ideas ourselves : 1 ) ** ( DONE ) ** : Add extension functions for all classes with methods that currently accept ` Class < ? extends RealmModel > ` so ` KClass ` can be used directly , e.g . ` realm.where ( Person : :class ) ` instead of ` realm.where ( Person : :class.java ) ` . 2 ) ** ( DONE ) ** Detect nullability automatically in model classes . Right now you are required to use the Realm ` @ Required ` annotation ,
diff -- git a/realm/build.gradle b/realm/build.gradle index 9e16444..8d801e3 100644 -- - a/realm/build.gradle +++ b/realm/build.gradle @ @ -1,3 +1,6 @ @ +project.ext.compileSdkVersion = 26 +project.ext.buildToolsVersion = '26.0.2' + buildscript { ext.kotlin_version = '1.1.4-3' repositories { diff -- git a/realm/gradle.properties b/realm/gradle.properties index 0be17a4..b9c4198 100644 -- - a/realm/gradle.properties +++ b/realm/gradle.properties @ @ -1,2 +1,3 @ @ org.gradle.jvmargs=-Xms512m -Xmx2048m org.gradle.caching=true +kotlin.incremental=false ; diff -- git a/realm/kotlin-extensions/.gitignore b/realm/kotlin-extensions/.gitignore new file mode 100644 index 0000000..796b96d -- - /dev/null +++ b/realm/kotlin-extensions/.gitignore @ @ -0,0 +1 @ @ +/build diff -- git a/realm/kotlin-extensions/build.gradle b/realm/kotlin-extensions/build.gradle new file mode 100644 index 0000000..1763302 -- - /dev/null +++ b/realm/kotlin-extensions/build.gradle @ @ -0,0 +1,62 @ @ +apply plugin : 'com.android.library' +apply plugin : 'kotlin-android' +apply plugin : 'kotlin-kapt' +import io.realm.transformer.RealmTransformer +android.registerTransform ( new RealmTransformer ( ) ) + +android { + compileSdkVersion rootProject.compileSdkVersion + buildToolsVersion rootProject.buildToolsVersion + + defaultConfig { + minSdkVersion 9 + targetSdkVersion 25 + versionCode 1 + versionName `` 1.0 '' + + testInstrumentationRunner `` android.support.test.runner.AndroidJUnitRunner '' + + flavorSelection 'api ' , 'base' + // flavorSelection is replaced by missingDimensionStrategy in beta4 . Use following line instead on beta4 or later . + // https : //androidstudio.googleblog.com/2017/09/android-studio-30-beta-4-is-now.html + //missingDimensionStrategy 'api ' , 'base' + } + buildTypes { + debug Request for community comments : Better Kotlin support __EoT__ With an awesome I/O17 being over , one of the big announcements were official support for [ Kotlin ] ( https : //blog.jetbrains.com/kotlin/2017/05/kotlin-on-android-now-official/ ) . Realm is already fully interoperable with Kotlin and we have a [ Kotlin example here ] ( https : //github.com/realm/realm-java/tree/master/examples/kotlinExample ) and [ here ] ( https : //github.com/realm-demos/realm-surveys/tree/master/Kotlin ) that demonstrates how it works . But we want to make that support even better and In order to do that , we are looking for feedback on what you would most like to see changed so Realm works even better with Kotlin We have a few ideas ourselves : 1 ) ** ( DONE ) ** : Add extension functions for all classes with methods that currently accept ` Class < ? extends RealmModel > ` so ` KClass ` can be used directly , e.g . ` realm.where ( Person : :class ) ` instead of ` realm.where ( Person : :class.java ) ` . 2 ) ** ( DONE ) ** Detect nullability automatically in model classes . Right now you are required to use the Realm ` @ Required ` annotation ,
diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/AuthenticateRequestTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/AuthenticateRequestTests.java index 54a87b4..bdadf62 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/AuthenticateRequestTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/AuthenticateRequestTests.java @ @ -39,7 +39,7 @ @ public class AuthenticateRequestTests { @ Test public void realmLogin ( ) throws URISyntaxException , JSONException { - Token t = SyncTestUtils.createTestUser ( ) .getSyncUser ( ) .getUserToken ( ) ; + Token t = SyncTestUtils.createTestUser ( ) .getAccessToken ( ) ; AuthenticateRequest request = AuthenticateRequest.realmLogin ( t , new URI ( `` realm : //objectserver/ '' + t.identity ( ) + `` /default '' ) ) ; JSONObject obj = new JSONObject ( request.toJson ( ) ) ; @ @ -60,7 +60,7 @ @ public class AuthenticateRequestTests { @ Test public void userRefresh ( ) throws URISyntaxException , JSONException { - Token t = SyncTestUtils.createTestUser ( ) .getSyncUser ( ) .getUserToken ( ) ; + Token t = SyncTestUtils.createTestUser ( ) .getAccessToken ( ) ; AuthenticateRequest request = AuthenticateRequest.userRefresh ( t , new URI ( `` realm : //objectserver/ '' + t.identity ( ) + `` /default '' ) ) ; JSONObject obj = new JSONObject ( request.toJson ( ) ) ; diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SyncUserTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SyncUserTests.java index 32f8b61..44cd909 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SyncUserTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SyncUserTests.java @ @ -31,6 +31,9 @ @ Migrate SyncUser to the ObjectStore __EoT__ SyncUser class should use the ObjectStore SyncUser .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index e2fdb37..c3eef50 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -9,8 +9,10 @ @ * Added support for new data type ` MutableRealmIntegers ` . The new type behaves almost exactly as a reference to a Long ( mutable nullable , etc ) but supports ` increment ` and ` decrement ` methods , which implement a Conflict Free Replicated Data Type , whose value will converge even when changed across distributed devices with poor connections ( # 4266 ) . # # # Bug Fixes +* [ ObjectServer ] Added ` SyncUser.logout ( ) ` throw an exception now , when associated Realms are instances are not closed ( # 4962 ) . # # # Internal +* [ ObjectServer ] removed ` ObjectServerUser ` and it 's inner classes , in a step to reduce ` SyncUser ` complexity ( # 3741 ) . # # 3.5.1 ( YYYY-MM-DD ) diff -- git a/examples/build.gradle b/examples/build.gradle index 3822790..4f6a611 100644 -- - a/examples/build.gradle +++ b/examples/build.gradle @ @ -23,8 +23,8 @ @ allprojects { maven { url 'https : //jitpack.io ' } } dependencies { - classpath 'com.android.tools.build : gradle:3.0.0-alpha4' - classpath 'com.jfrog.bintray.gradle : gradle-bintray-plugin:1.6' + Migrate SyncUser to the ObjectStore __EoT__ SyncUser class should use the ObjectStore SyncUser .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 48f5b5d..b6466dc 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -47,6 +47,7 @ @ * Fixed a JNI memory issue when doing queries which might potentially cause various native crashes . * Fixed a bug that ` RealmList.deleteFromRealm ( int ) ` , ` RealmList.deleteFirstFromRealm ( ) ` and ` RealmList.deleteLastFromRealm ( ) ` did not remove target objects from Realm . This bug was introduced in ` 3.7.1 ` ( # 5233 ) . * Crash with `` 'xxx ' does n't exist in current schema . '' when ProGuard is enabled ( # 5211 ) . +* Exposing a ` RealmConfiguration ` that allows a user to open the backup Realm after the client reset ( # 4759 ) . # # 3.7.1 ( 2017-09-07 ) diff -- git a/dependencies.list b/dependencies.list index 2187414..404a4e0 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -1,7 +1,7 @ @ # Realm Sync Core release used by Realm Java # https : //github.com/realm/realm-sync/releases -REALM_SYNC_VERSION=2.0.0-rc16 -REALM_SYNC_SHA256=c20c4e7333f01a3a4ea350cb20b9b7feba95ad4e52d612368b6187b72d518aa1 +REALM_SYNC_VERSION=2.0.0-rc18 +REALM_SYNC_SHA256=73cb89c1a04cafa871444aa91d93eb9df16af088bcb7d3ede73bb815d53a06e5 # Object Server Release used by Integration tests # Stable releases : https : //packagecloud.io/realm/realm ? filter=debs diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java index 5dc2af0..dae5155 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java @ Sync - Verify certificate using TrustManager __EoT__ Sync is working on a [ PR ] ( https : //github.com/realm/realm-sync/pull/1312 ) that will perform a series of callback to validate the certificate chain , in order to complete the SSL Handshake using the trusted root CA configured with Android . We need to handle the callback from the Java binding , and use the default ` TrustManager ` in order to validate the certificate . The C++ need to pass as an argument the certificate that we should transform into a ` X509Certificate ` format , so it can be usable with the ` JSSE ` API
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 48f5b5d..b6466dc 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -47,6 +47,7 @ @ * Fixed a JNI memory issue when doing queries which might potentially cause various native crashes . * Fixed a bug that ` RealmList.deleteFromRealm ( int ) ` , ` RealmList.deleteFirstFromRealm ( ) ` and ` RealmList.deleteLastFromRealm ( ) ` did not remove target objects from Realm . This bug was introduced in ` 3.7.1 ` ( # 5233 ) . * Crash with `` 'xxx ' does n't exist in current schema . '' when ProGuard is enabled ( # 5211 ) . +* Exposing a ` RealmConfiguration ` that allows a user to open the backup Realm after the client reset ( # 4759 ) . # # 3.7.1 ( 2017-09-07 ) diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java index 5dc2af0..dae5155 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java @ @ -28,6 +28,10 @ @ import org.junit.runner.RunWith ; import java.util.concurrent.atomic.AtomicReference ; +import io.realm.entities.StringOnly ; +import io.realm.exceptions.RealmFileException ; +import io.realm.exceptions.RealmMigrationNeededException ; +import io.realm.objectserver.utils.StringOnlyModule ; import io.realm.rule.RunInLooperThread ; import io.realm.rule.RunTestInLooperThread ; import io.realm.rule.TestSyncConfigurationFactory ; @ @ -35,6 +39,7 @ @ import io.realm.rule.TestSyncConfigurationFactory ; import static io.realm.util.SyncTestUtils.createTestUser ; import static org.junit.Assert.assertEquals ; import static org.junit.Assert.assertFalse ; Sync - Verify certificate using TrustManager __EoT__ Sync is working on a [ PR ] ( https : //github.com/realm/realm-sync/pull/1312 ) that will perform a series of callback to validate the certificate chain , in order to complete the SSL Handshake using the trusted root CA configured with Android . We need to handle the callback from the Java binding , and use the default ` TrustManager ` in order to validate the certificate . The C++ need to pass as an argument the certificate that we should transform into a ` X509Certificate ` format , so it can be usable with the ` JSSE ` API
diff -- git a/dependencies.list b/dependencies.list index 404a4e0..b41577c 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -3,11 +3,6 @ @ REALM_SYNC_VERSION=2.0.0-rc18 REALM_SYNC_SHA256=73cb89c1a04cafa871444aa91d93eb9df16af088bcb7d3ede73bb815d53a06e5 - # Object Server Release used by Integration tests - # Stable releases : https : //packagecloud.io/realm/realm ? filter=debs - # Beta releases : https : //packagecloud.io/realm/realm-beta ? filter=debs - # Developer builds : https : //packagecloud.io/realm/realm-testing ? filter=debs - # /tools/sync_test_server/Dockerfile specify which repo ( apt ) we should - # install/use between 'realm ' , 'realm-beta ' and 'realm-testing ' , the version below should - # correspond to an existing version on the *specified* repo . -REALM_OBJECT_SERVER_DE_VERSION=2.0.0-rc2-285 + # Object Server Release used by Integration tests . Installed using NPM . + # Use ` npm view realm-object-server versions ` to get a list of available versions . +REALM_OBJECT_SERVER_DE_VERSION=2.0.0-alpha.28 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java index 1b9152b..b63e45d 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java @ @ -21,6 +21,7 @ @ import android.support.test.runner.AndroidJUnit4 ; import org.junit.After ; import org.junit.Before ; +import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -29,8 +30,14 @ @ import java.io.IOException ; import java.util.Arrays ; import java.util.List ; +import io.realm.DynamicRealm ; +import io.realm.DynamicRealmObject ; +import io.realm.FieldAttribute ; +import io.realm.Realm ; Sync - Verify certificate using TrustManager __EoT__ Sync is working on a [ PR ] ( https : //github.com/realm/realm-sync/pull/1312 ) that will perform a series of callback to validate the certificate chain , in order to complete the SSL Handshake using the trusted root CA configured with Android . We need to handle the callback from the Java binding , and use the default ` TrustManager ` in order to validate the certificate . The C++ need to pass as an argument the certificate that we should transform into a ` X509Certificate ` format , so it can be usable with the ` JSSE ` API
diff -- git a/dependencies.list b/dependencies.list index 404a4e0..b41577c 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -3,11 +3,6 @ @ REALM_SYNC_VERSION=2.0.0-rc18 REALM_SYNC_SHA256=73cb89c1a04cafa871444aa91d93eb9df16af088bcb7d3ede73bb815d53a06e5 - # Object Server Release used by Integration tests - # Stable releases : https : //packagecloud.io/realm/realm ? filter=debs - # Beta releases : https : //packagecloud.io/realm/realm-beta ? filter=debs - # Developer builds : https : //packagecloud.io/realm/realm-testing ? filter=debs - # /tools/sync_test_server/Dockerfile specify which repo ( apt ) we should - # install/use between 'realm ' , 'realm-beta ' and 'realm-testing ' , the version below should - # correspond to an existing version on the *specified* repo . -REALM_OBJECT_SERVER_DE_VERSION=2.0.0-rc2-285 + # Object Server Release used by Integration tests . Installed using NPM . + # Use ` npm view realm-object-server versions ` to get a list of available versions . +REALM_OBJECT_SERVER_DE_VERSION=2.0.0-alpha.28 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java index 1b9152b..b63e45d 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java @ @ -21,6 +21,7 @ @ import android.support.test.runner.AndroidJUnit4 ; import org.junit.After ; import org.junit.Before ; +import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -29,8 +30,14 @ @ import java.io.IOException ; import java.util.Arrays ; import java.util.List ; +import io.realm.DynamicRealm ; +import io.realm.DynamicRealmObject ; +import io.realm.FieldAttribute ; +import io.realm.Realm ; Sync - Verify certificate using TrustManager __EoT__ Sync is working on a [ PR ] ( https : //github.com/realm/realm-sync/pull/1312 ) that will perform a series of callback to validate the certificate chain , in order to complete the SSL Handshake using the trusted root CA configured with Android . We need to handle the callback from the Java binding , and use the default ` TrustManager ` in order to validate the certificate . The C++ need to pass as an argument the certificate that we should transform into a ` X509Certificate ` format , so it can be usable with the ` JSSE ` API
diff -- git a/dependencies.list b/dependencies.list index 404a4e0..1398418 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -3,11 +3,6 @ @ REALM_SYNC_VERSION=2.0.0-rc18 REALM_SYNC_SHA256=73cb89c1a04cafa871444aa91d93eb9df16af088bcb7d3ede73bb815d53a06e5 - # Object Server Release used by Integration tests - # Stable releases : https : //packagecloud.io/realm/realm ? filter=debs - # Beta releases : https : //packagecloud.io/realm/realm-beta ? filter=debs - # Developer builds : https : //packagecloud.io/realm/realm-testing ? filter=debs - # /tools/sync_test_server/Dockerfile specify which repo ( apt ) we should - # install/use between 'realm ' , 'realm-beta ' and 'realm-testing ' , the version below should - # correspond to an existing version on the *specified* repo . -REALM_OBJECT_SERVER_DE_VERSION=2.0.0-rc2-285 + # Object Server Release used by Integration tests . Installed using NPM . + # Use ` npm view realm-object-server versions ` to get a list of available versions . +REALM_OBJECT_SERVER_DE_VERSION=2.0.0-alpha.30 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java index 1b9152b..b63e45d 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java @ @ -21,6 +21,7 @ @ import android.support.test.runner.AndroidJUnit4 ; import org.junit.After ; import org.junit.Before ; +import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -29,8 +30,14 @ @ import java.io.IOException ; import java.util.Arrays ; import java.util.List ; +import io.realm.DynamicRealm ; +import io.realm.DynamicRealmObject ; +import io.realm.FieldAttribute ; +import io.realm.Realm ; Sync - Verify certificate using TrustManager __EoT__ Sync is working on a [ PR ] ( https : //github.com/realm/realm-sync/pull/1312 ) that will perform a series of callback to validate the certificate chain , in order to complete the SSL Handshake using the trusted root CA configured with Android . We need to handle the callback from the Java binding , and use the default ` TrustManager ` in order to validate the certificate . The C++ need to pass as an argument the certificate that we should transform into a ` X509Certificate ` format , so it can be usable with the ` JSSE ` API
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 45696ba..fdc8762 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -7,6 +7,7 @ @ * ` RealmSchema.create ( String ) ` and ` RealmObjectSchema.setClassName ( String ) ` did not accept class name whose length was 51 to 57 . * Workaround for an Android JVM crash when using ` compactOnLaunch ( ) ` ( # 4964 ) . * Class name in exception message from link query is wrong ( # 5096 ) . +* Exposing a ` SyncConfiguration ` that allows a user to open the backup Realm after the client reset ( # 4759 ) . # # # Internal diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java index acf65b4..30c0c26 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java @ @ -23,6 +23,8 @ @ import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; +import io.realm.entities.StringOnly ; +import io.realm.objectserver.utils.StringOnlyModule ; import io.realm.rule.RunInLooperThread ; import io.realm.rule.RunTestInLooperThread ; import io.realm.rule.TestSyncConfigurationFactory ; @ @ -30,6 +32,7 @ @ import io.realm.rule.TestSyncConfigurationFactory ; import static io.realm.util.SyncTestUtils.createTestUser ; import static org.junit.Assert.assertEquals ; import static org.junit.Assert.assertFalse ; +import static org.junit.Assert.assertNotNull ; import static org.junit.Assert.assertTrue ; import static org.junit.Assert.fail ; @ @ -125,12 +128,17 @ @ public class SessionTests { } final ClientResetRequiredError handler = ( Sync - Verify certificate using TrustManager __EoT__ Sync is working on a [ PR ] ( https : //github.com/realm/realm-sync/pull/1312 ) that will perform a series of callback to validate the certificate chain , in order to complete the SSL Handshake using the trusted root CA configured with Android . We need to handle the callback from the Java binding , and use the default ` TrustManager ` in order to validate the certificate . The C++ need to pass as an argument the certificate that we should transform into a ` X509Certificate ` format , so it can be usable with the ` JSSE ` API
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 7bb4e15..9c3dfbf 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -40,6 +40,7 @ @ and ` SyncUser # retrieveInfoForUserAsync ` which returns a ` SyncUserInfo ` with mode * ` RealmSchema.create ( String ) ` and ` RealmObjectSchema.setClassName ( String ) ` did not accept class name whose length was 51 to 57 . * Workaround for an Android JVM crash when using ` compactOnLaunch ( ) ` ( # 4964 ) . * Class name in exception message from link query is wrong ( # 5096 ) . +* Exposing a ` SyncConfiguration ` that allows a user to open the backup Realm after the client reset ( # 4759 ) . # # # Internal diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java index ee9b216..cd2ebe1 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java @ @ -25,6 +25,9 @ @ import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; +import io.realm.entities.StringOnly ; +import io.realm.exceptions.RealmMigrationNeededException ; +import io.realm.objectserver.utils.StringOnlyModule ; import io.realm.rule.RunInLooperThread ; import io.realm.rule.RunTestInLooperThread ; import io.realm.rule.TestSyncConfigurationFactory ; @ @ -32,6 +35,7 @ @ import io.realm.rule.TestSyncConfigurationFactory ; import static io.realm.util.SyncTestUtils.createTestUser ; import static org.junit.Assert.assertEquals ; import static org.junit.Assert.assertFalse ; +import static org.junit.Assert.assertNotNull ; import static org.junit.Assert.assertTrue ; import static org.junit.Assert.fail Sync - Verify certificate using TrustManager __EoT__ Sync is working on a [ PR ] ( https : //github.com/realm/realm-sync/pull/1312 ) that will perform a series of callback to validate the certificate chain , in order to complete the SSL Handshake using the trusted root CA configured with Android . We need to handle the callback from the Java binding , and use the default ` TrustManager ` in order to validate the certificate . The C++ need to pass as an argument the certificate that we should transform into a ` X509Certificate ` format , so it can be usable with the ` JSSE ` API
diff -- git a/dependencies.list b/dependencies.list index 404a4e0..b41577c 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -3,11 +3,6 @ @ REALM_SYNC_VERSION=2.0.0-rc18 REALM_SYNC_SHA256=73cb89c1a04cafa871444aa91d93eb9df16af088bcb7d3ede73bb815d53a06e5 - # Object Server Release used by Integration tests - # Stable releases : https : //packagecloud.io/realm/realm ? filter=debs - # Beta releases : https : //packagecloud.io/realm/realm-beta ? filter=debs - # Developer builds : https : //packagecloud.io/realm/realm-testing ? filter=debs - # /tools/sync_test_server/Dockerfile specify which repo ( apt ) we should - # install/use between 'realm ' , 'realm-beta ' and 'realm-testing ' , the version below should - # correspond to an existing version on the *specified* repo . -REALM_OBJECT_SERVER_DE_VERSION=2.0.0-rc2-285 + # Object Server Release used by Integration tests . Installed using NPM . + # Use ` npm view realm-object-server versions ` to get a list of available versions . +REALM_OBJECT_SERVER_DE_VERSION=2.0.0-alpha.28 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java index 1b9152b..b63e45d 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java @ @ -21,6 +21,7 @ @ import android.support.test.runner.AndroidJUnit4 ; import org.junit.After ; import org.junit.Before ; +import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -29,8 +30,14 @ @ import java.io.IOException ; import java.util.Arrays ; import java.util.List ; +import io.realm.DynamicRealm ; +import io.realm.DynamicRealmObject ; +import io.realm.FieldAttribute ; +import io.realm.Realm ; Sync - Verify certificate using TrustManager __EoT__ Sync is working on a [ PR ] ( https : //github.com/realm/realm-sync/pull/1312 ) that will perform a series of callback to validate the certificate chain , in order to complete the SSL Handshake using the trusted root CA configured with Android . We need to handle the callback from the Java binding , and use the default ` TrustManager ` in order to validate the certificate . The C++ need to pass as an argument the certificate that we should transform into a ` X509Certificate ` format , so it can be usable with the ` JSSE ` API
diff -- git a/dependencies.list b/dependencies.list index 404a4e0..b41577c 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -3,11 +3,6 @ @ REALM_SYNC_VERSION=2.0.0-rc18 REALM_SYNC_SHA256=73cb89c1a04cafa871444aa91d93eb9df16af088bcb7d3ede73bb815d53a06e5 - # Object Server Release used by Integration tests - # Stable releases : https : //packagecloud.io/realm/realm ? filter=debs - # Beta releases : https : //packagecloud.io/realm/realm-beta ? filter=debs - # Developer builds : https : //packagecloud.io/realm/realm-testing ? filter=debs - # /tools/sync_test_server/Dockerfile specify which repo ( apt ) we should - # install/use between 'realm ' , 'realm-beta ' and 'realm-testing ' , the version below should - # correspond to an existing version on the *specified* repo . -REALM_OBJECT_SERVER_DE_VERSION=2.0.0-rc2-285 + # Object Server Release used by Integration tests . Installed using NPM . + # Use ` npm view realm-object-server versions ` to get a list of available versions . +REALM_OBJECT_SERVER_DE_VERSION=2.0.0-alpha.28 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java index 1b9152b..b63e45d 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java @ @ -21,6 +21,7 @ @ import android.support.test.runner.AndroidJUnit4 ; import org.junit.After ; import org.junit.Before ; +import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -29,8 +30,14 @ @ import java.io.IOException ; import java.util.Arrays ; import java.util.List ; +import io.realm.DynamicRealm ; +import io.realm.DynamicRealmObject ; +import io.realm.FieldAttribute ; +import io.realm.Realm ; Sync - Verify certificate using TrustManager __EoT__ Sync is working on a [ PR ] ( https : //github.com/realm/realm-sync/pull/1312 ) that will perform a series of callback to validate the certificate chain , in order to complete the SSL Handshake using the trusted root CA configured with Android . We need to handle the callback from the Java binding , and use the default ` TrustManager ` in order to validate the certificate . The C++ need to pass as an argument the certificate that we should transform into a ` X509Certificate ` format , so it can be usable with the ` JSSE ` API
diff -- git a/dependencies.list b/dependencies.list index 404a4e0..1398418 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -3,11 +3,6 @ @ REALM_SYNC_VERSION=2.0.0-rc18 REALM_SYNC_SHA256=73cb89c1a04cafa871444aa91d93eb9df16af088bcb7d3ede73bb815d53a06e5 - # Object Server Release used by Integration tests - # Stable releases : https : //packagecloud.io/realm/realm ? filter=debs - # Beta releases : https : //packagecloud.io/realm/realm-beta ? filter=debs - # Developer builds : https : //packagecloud.io/realm/realm-testing ? filter=debs - # /tools/sync_test_server/Dockerfile specify which repo ( apt ) we should - # install/use between 'realm ' , 'realm-beta ' and 'realm-testing ' , the version below should - # correspond to an existing version on the *specified* repo . -REALM_OBJECT_SERVER_DE_VERSION=2.0.0-rc2-285 + # Object Server Release used by Integration tests . Installed using NPM . + # Use ` npm view realm-object-server versions ` to get a list of available versions . +REALM_OBJECT_SERVER_DE_VERSION=2.0.0-alpha.30 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java index 1b9152b..b63e45d 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java @ @ -21,6 +21,7 @ @ import android.support.test.runner.AndroidJUnit4 ; import org.junit.After ; import org.junit.Before ; +import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -29,8 +30,14 @ @ import java.io.IOException ; import java.util.Arrays ; import java.util.List ; +import io.realm.DynamicRealm ; +import io.realm.DynamicRealmObject ; +import io.realm.FieldAttribute ; +import io.realm.Realm ; Sync - Verify certificate using TrustManager __EoT__ Sync is working on a [ PR ] ( https : //github.com/realm/realm-sync/pull/1312 ) that will perform a series of callback to validate the certificate chain , in order to complete the SSL Handshake using the trusted root CA configured with Android . We need to handle the callback from the Java binding , and use the default ` TrustManager ` in order to validate the certificate . The C++ need to pass as an argument the certificate that we should transform into a ` X509Certificate ` format , so it can be usable with the ` JSSE ` API
diff -- git a/dependencies.list b/dependencies.list index 404a4e0..1398418 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -3,11 +3,6 @ @ REALM_SYNC_VERSION=2.0.0-rc18 REALM_SYNC_SHA256=73cb89c1a04cafa871444aa91d93eb9df16af088bcb7d3ede73bb815d53a06e5 - # Object Server Release used by Integration tests - # Stable releases : https : //packagecloud.io/realm/realm ? filter=debs - # Beta releases : https : //packagecloud.io/realm/realm-beta ? filter=debs - # Developer builds : https : //packagecloud.io/realm/realm-testing ? filter=debs - # /tools/sync_test_server/Dockerfile specify which repo ( apt ) we should - # install/use between 'realm ' , 'realm-beta ' and 'realm-testing ' , the version below should - # correspond to an existing version on the *specified* repo . -REALM_OBJECT_SERVER_DE_VERSION=2.0.0-rc2-285 + # Object Server Release used by Integration tests . Installed using NPM . + # Use ` npm view realm-object-server versions ` to get a list of available versions . +REALM_OBJECT_SERVER_DE_VERSION=2.0.0-alpha.30 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java index 1b9152b..b63e45d 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java @ @ -21,6 +21,7 @ @ import android.support.test.runner.AndroidJUnit4 ; import org.junit.After ; import org.junit.Before ; +import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -29,8 +30,14 @ @ import java.io.IOException ; import java.util.Arrays ; import java.util.List ; +import io.realm.DynamicRealm ; +import io.realm.DynamicRealmObject ; +import io.realm.FieldAttribute ; +import io.realm.Realm ; Sync - Verify certificate using TrustManager __EoT__ Sync is working on a [ PR ] ( https : //github.com/realm/realm-sync/pull/1312 ) that will perform a series of callback to validate the certificate chain , in order to complete the SSL Handshake using the trusted root CA configured with Android . We need to handle the callback from the Java binding , and use the default ` TrustManager ` in order to validate the certificate . The C++ need to pass as an argument the certificate that we should transform into a ` X509Certificate ` format , so it can be usable with the ` JSSE ` API
diff -- git a/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy b/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy index b9e388c..ce1fc39 100644 -- - a/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy +++ b/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy @ @ -57,7 +57,7 @ @ class BytecodeModifier { * @ param clazz The CtClass to modify * @ param managedFields List of fields whose access should be replaced */ - public static void useRealmAccessors ( CtClass clazz , List < CtField > managedFields , List < CtClass > modelClasses ) { + public static void useRealmAccessors ( CtClass clazz , List < CtField > managedFields ) { clazz.getDeclaredBehaviors ( ) .each { behavior - > logger.info `` Behavior : $ { behavior.name } '' if ( @ @ -69,7 +69,7 @ @ class BytecodeModifier { behavior instanceof CtConstructor ) ) { - behavior.instrument ( new FieldAccessToAccessorConverter ( managedFields , clazz , behavior , modelClasses.contains ( clazz ) ) ) + behavior.instrument ( new FieldAccessToAccessorConverter ( managedFields , clazz , behavior ) ) } } } @ @ -93,18 +93,13 @ @ class BytecodeModifier { final List < CtField > managedFields final CtClass ctClass final CtBehavior behavior - final boolean isModelClass - final boolean isInConstructor FieldAccessToAccessorConverter ( List < CtField > managedFields , CtClass ctClass , - CtBehavior behavior , - boolean isModelClass ) { + CtBehavior Regression issue after # 3379 merged . Different default values when create with JSON Stream __EoT__ This is a regression issue after # 3379 merged . The APIs to create ` RealmObject ` from JSON stream will have different behaviours from other APIs . Underneath , it is using the non-managed object 's default constructor to create an object , then set its fields from JSON . Those absent field in JSON will have the default value set by the default non-managed object 's constructor . See comments from https : //github.com/realm/realm-java/pull/3379 # discussion_r77316752 It looks like it only effect the ` create ` part , not the ` update ` part right ? I see 3 choices : 1 ) Accept the current solution and document the breaking change 2 ) Rewrite ` createFromJsonStream ` to create JSONObject instead and return the result from ` createObjectFromJson ( jsonObj ) ` 3 ) Add support for # 777 For expendiency , I would probably just go with 1 ) now and make an issue for looking into 2/3 in th next week or two , because we need a better solution before releasing anything publically . If 3 ) is
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 79f3595..b9e84b4 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -9,6 +9,8 @ @ - ` RealmIOExcpetion ` has been removed and replaced by ` RealmFileException ` . * Removed ` RealmConfiguration.Builder ( Context , File ) ` and ` RealmConfiguration.Builder ( File ) ` constructors . * ` RealmConfiguration.Builder.assetFile ( Context , String ) ` has been renamed to ` RealmConfiguration.Builder.assetFile ( String ) ` . +* ` Realm.createObject ( Class < E > ) ` and ` DynamicRealm.createObjec ( String ) ` throws ` RealmException ` if they are called to create an object with a primary key defined . +* Importing from JSON without the primary key field defined in the JSON object now throws ` IllegalArgumentException ` . # # # Enhancements diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java index 68b2f11..592aec9 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java @ @ -28,6 +28,8 @ @ public class Constants { public static final String DEFAULT_MODULE_CLASS_NAME = `` DefaultRealmModule '' ; static final String STATEMENT_EXCEPTION_ILLEGAL_NULL_VALUE = `` throw new IllegalArgumentException ( \ '' Trying to set non-nullable field ' % s ' to null.\ '' ) '' ; + static final String STATEMENT_EXCEPTION_NO_PRIMARY_KEY_IN_JSON = + `` throw Regression issue after # 3379 merged . Different default values when create with JSON Stream __EoT__ This is a regression issue after # 3379 merged . The APIs to create ` RealmObject ` from JSON stream will have different behaviours from other APIs . Underneath , it is using the non-managed object 's default constructor to create an object , then set its fields from JSON . Those absent field in JSON will have the default value set by the default non-managed object 's constructor . See comments from https : //github.com/realm/realm-java/pull/3379 # discussion_r77316752 It looks like it only effect the ` create ` part , not the ` update ` part right ? I see 3 choices : 1 ) Accept the current solution and document the breaking change 2 ) Rewrite ` createFromJsonStream ` to create JSONObject instead and return the result from ` createObjectFromJson ( jsonObj ) ` 3 ) Add support for # 777 For expendiency , I would probably just go with 1 ) now and make an issue for looking into 2/3 in th next week or two , because we need a better solution before releasing anything publically . If 3 ) is
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 0231535..d0fe29c 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -2,6 +2,7 @ @ # # # Enhancements +* Add ` insert ( RealmModel obj ) ` , ` insertOrUpdate ( RealmModel obj ) ` , ` insert ( Collection < RealmModel > collection ) ` and ` insertOrUpdate ( Collection < RealmModel > collection ) ` to perform batch inserts ( # 1684 ) * Enhanced ` Table.toString ( ) ` to show a PrimaryKey field details ( # 2903 ) . * Enabled ReLinker when loading a Realm from a custom path by adding a ` RealmConfiguration.Builder ( Context , File ) ` constructor ( # 2900 ) . @ @ -43,7 +44,7 @ @ No changes since 0.91.1 . # # # Bug fixes -* Fixed a bug when opening a Realm cause a staled memory mapping . Symptoms are error messages like `` Bad or incompatible history type '' , `` File format version does n't match '' , and `` Encrypted interprocess sharing is currently unsupported '' . +* Fixed a bug when opening a Realm cause a staled memory mapping . Symptoms are error messages like `` Bad or All fields are empty after bulk insert __EoT__ # # # # Goal I am trying to bulk insert to my db after network operation is completed . For network operation I am using retrofit and response of network operation is successful and all json fields are non-empty or not null . Bulk insert operation is successful and all fields are non-empty on LG G3 ( Android 5.0.0 ) however same operation and same code have not successful result on Samsung Galaxy S4 Mini ( GT-I9190 Android 4.4.2 ) . # # # # Expected Results > After bulk insert operation , all fields must be filled on both phones . # # # # Code Sample I am trying to add items with following codes . I also tried insertOrUpdate ( listOfData ) but after operation all fields are empty again . `` ` java dbRealm.beginTransaction ( ) ; dbRealm.copyToRealmOrUpdate ( institutionList ) ; dbRealm.commitTransaction ( ) ; or dbRealm.executeTransaction ( new Realm.Transaction ( ) { @ Override public void execute ( Realm realm ) { realm.copyToRealmOrUpdate ( listOfData ) ; } } ) ; `` ` # # # # Version of Realm and tooling Realm version (
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk Add multi process support __EoT__ Currently Realm for Java only support multi threading but not multi process .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk Add multi process support __EoT__ Currently Realm for Java only support multi threading but not multi process .
diff -- git a/.gitignore b/.gitignore index a72b66b..9153b3b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/Dockerfile b/Dockerfile index 0029aae..7aee9b3 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +28,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ Add multi process support __EoT__ Currently Realm for Java only support multi threading but not multi process .
diff -- git a/examples/multiProcessAExample/.gitignore b/examples/multiProcessAExample/.gitignore new file mode 100644 index 0000000..796b96d -- - /dev/null +++ b/examples/multiProcessAExample/.gitignore @ @ -0,0 +1 @ @ +/build diff -- git a/examples/multiProcessAExample/build.gradle b/examples/multiProcessAExample/build.gradle new file mode 100644 index 0000000..5ec8e22 -- - /dev/null +++ b/examples/multiProcessAExample/build.gradle @ @ -0,0 +1,27 @ @ +apply plugin : 'android-sdk-manager' +apply plugin : 'com.android.application' +apply plugin : 'android-command' +apply plugin : 'realm' + +android { + compileSdkVersion rootProject.sdkVersion + buildToolsVersion rootProject.buildTools + + defaultConfig { + applicationId `` io.realm.examples.realmmultiprocessaexample '' + targetSdkVersion rootProject.sdkVersion + minSdkVersion 9 + versionCode 1 + versionName `` 1.0 '' + } + buildTypes { + release { + minifyEnabled false + proguardFiles getDefaultProguardFile ( 'proguard-android.txt ' ) , 'proguard-rules.pro' + } + } + } + +dependencies { + compile 'com.android.support : appcompat-v7:23.1.1' + } diff -- git a/examples/multiProcessAExample/proguard-rules.pro b/examples/multiProcessAExample/proguard-rules.pro new file mode 100644 index 0000000..8456b3d -- - /dev/null +++ b/examples/multiProcessAExample/proguard-rules.pro @ @ -0,0 +1,17 @ @ + # Add project specific ProGuard rules here . + # By default , the flags in this file are appended to flags specified + # in /home/cc/.android-sdk/tools/proguard/proguard-android.txt + # You can edit the include path and order by changing the proguardFiles + # directive in build.gradle . + Add multi process support __EoT__ Currently Realm for Java only support multi threading but not multi process .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 984d063..ffc6532 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 2.3.0 + + # # # Object Server API Changes ( In Beta ) + +* Add a default ` UserStore ` based on the Realm Object Store ( ` ObjectStoreUserStore ` ) . + # # 2.2.3 # # # Bug fixes diff -- git a/examples/unitTestExample/src/test/java/io/realm/examples/unittesting/ExampleRealmTest.java b/examples/unitTestExample/src/test/java/io/realm/examples/unittesting/ExampleRealmTest.java index 1c12d41..147c9aa 100644 -- - a/examples/unitTestExample/src/test/java/io/realm/examples/unittesting/ExampleRealmTest.java +++ b/examples/unitTestExample/src/test/java/io/realm/examples/unittesting/ExampleRealmTest.java @ @ -107,7 +107,7 @ @ public class ExampleRealmTest { dogRepo.createDog ( `` Spot '' ) ; // Attempting to verify that a method was called ( executeTransaction ) on a partial - // mock will return unexpected resultes due to the partial mock . For example , + // mock will return unexpected results due to the partial mock . For example , // verifying that ` executeTransaction ` was called only once will fail as Powermock // actually calls the method 3 times for some reason . I can not determine why at this // point . diff -- git a/realm/realm-annotations-processor/build.gradle b/realm/realm-annotations-processor/build.gradle index d8dc054..ac1e0ba 100644 -- - a/realm/realm-annotations-processor/build.gradle +++ b/realm/realm-annotations-processor/build.gradle @ @ -40,6 +40,11 @ @ sourceSets { compileJava.dependsOn generateVersionClass Memory leak ( Row ) in Java_io_realm_internal_Table_nativeSetPrimaryKey __EoT__ I just stumbled across this while investigating a Core crash seems we 're allocating a Row on the heap https : //github.com/realm/realm-java/blob/d547fde64271229cb6bb98df30deda05faeba9ce/realm/realm-library/src/main/cpp/io_realm_internal_Table.cpp # L1508
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 44d2937..6a23398 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,16 @ @ + # # 5.7.0 ( YYYY-MM-DD ) + + # # # Enhancements +* Added new ` ImportFlag ` class that is used to specify additional behaviour when importing + data into Realm [ X # # # ] ( XXXX ) . +* Added support for ` ImportFlag ` to ` Realm.copyToRealm ( ) ` , ` Realm.copyToRealmOrUpdate ( ) ` , + ` Realm.insert ( ) ` , ` Realm.insertOrUpdate ( ) ` , ` Realm.createFromJson* ( ) ` methods [ X # # # ] ( XXXX ) . + + # # # Internal + +* Optimized generated code from the annotation processor to bulk send data across JNI when using ` Realm.copyToRealm ` . + + # # 5.7.0 ( 2017-09-24 ) # # Enhancements diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 03f3fa5..4eba7a2 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -63,6 +63,8 @ @ public class ClassMetaData { private final String javaClassName ; // Model class simple name as defined in Java . private final List < RealmFieldElement > fields = new ArrayList < > ( Batch or bulk updates __EoT__ Feature request following this discussion : https : //groups.google.com/forum/ # ! topic/realm-java/6NeywfWmCA4 Basically it allows setting a property on many objects in one operation just like this SQL : `` ` UPDATE Foo SET isDeleted = 1 WHERE name = `` 123 '' `` ` One option could be `` ` RealmResults < Foo > foos = realm.where ( Foo.class ) .equalsTo ( `` name '' , `` 123 '' ) ; realm.beginTransaction ( ) ; foos.updateAllObjects ( `` isDeleted '' , 1 ) ; realm.commitTransaction ( ) ; `` `
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 44d2937..11de22a 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,14 @ @ + # # 5.8.0-RC1 ( YYYY-MM-DD ) + + # # # Enhancements +* Added new ` ImportFlag ` class that is used to specify additional behaviour when importing + data into Realm [ # 6224 ] ( https : //github.com/realm/realm-java/pull/6224 ) . +* Added support for ` ImportFlag ` to ` Realm.copyToRealm ( ) ` and ` Realm.copyToRealmOrUpdate ( ) ` [ # 6224 ] ( https : //github.com/realm/realm-java/pull/6224 ) . + + # # # Known Bugs +* ` Realm.copyToRealm ( ) ` and ` Realm.copyToRealmOrUpdate ` has been rewritten to support import flags . It is currently 2x slower than in 5.7.0 . +* IllegalStateException thrown when trying to create an object with a primary key that already exists when using ` Realm.copyToRealm ` , will always report `` null '' instead of the correct primary key value . + # # 5.7.0 ( 2017-09-24 ) # # Enhancements diff -- git a/library-benchmarks/src/androidTest/java/io/realm/benchmarks/CopyToRealmBenchmarks.java b/library-benchmarks/src/androidTest/java/io/realm/benchmarks/CopyToRealmBenchmarks.java new file mode 100644 index 0000000..c441b5e -- - /dev/null +++ b/library-benchmarks/src/androidTest/java/io/realm/benchmarks/CopyToRealmBenchmarks.java @ @ -0,0 +1,124 @ @ +/* + * Copyright 2017 Realm Inc. Batch or bulk updates __EoT__ Feature request following this discussion : https : //groups.google.com/forum/ # ! topic/realm-java/6NeywfWmCA4 Basically it allows setting a property on many objects in one operation just like this SQL : `` ` UPDATE Foo SET isDeleted = 1 WHERE name = `` 123 '' `` ` One option could be `` ` RealmResults < Foo > foos = realm.where ( Foo.class ) .equalsTo ( `` name '' , `` 123 '' ) ; realm.beginTransaction ( ) ; foos.updateAllObjects ( `` isDeleted '' , 1 ) ; realm.commitTransaction ( ) ; `` `
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 44d2937..f9a6082 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,15 @ @ + # # 5.8.0-BETA1 ( YYYY-MM-DD ) + + # # # Enhancements +* Added new ` ImportFlag ` class that is used to specify additional behaviour when importing + data into Realm [ # 6224 ] ( https : //github.com/realm/realm-java/pull/6224 ) . +* Added support for ` ImportFlag ` to ` Realm.copyToRealm ( ) ` and ` Realm.copyToRealmOrUpdate ( ) ` [ # 6224 ] ( https : //github.com/realm/realm-java/pull/6224 ) . + + # # # Known Bugs +* ` Realm.copyToRealm ( ) ` and ` Realm.copyToRealmOrUpdate ` has been rewritten to support import flags . It is currently ~30 % slower than in 5.7.0 . +* IllegalStateException thrown when trying to create an object with a primary key that already exists when using ` Realm.copyToRealm ` , will always report `` null '' instead of the correct primary key value . +* When using ` ImportFlag.DO_NOT_SET_SAME_VALUES ` , lists and object references will still written and reported as changed , even if they did n't . + # # 5.7.0 ( 2017-09-24 ) # # Enhancements diff -- git Batch or bulk updates __EoT__ Feature request following this discussion : https : //groups.google.com/forum/ # ! topic/realm-java/6NeywfWmCA4 Basically it allows setting a property on many objects in one operation just like this SQL : `` ` UPDATE Foo SET isDeleted = 1 WHERE name = `` 123 '' `` ` One option could be `` ` RealmResults < Foo > foos = realm.where ( Foo.class ) .equalsTo ( `` name '' , `` 123 '' ) ; realm.beginTransaction ( ) ; foos.updateAllObjects ( `` isDeleted '' , 1 ) ; realm.commitTransaction ( ) ; `` `
diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_OsResults.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_OsResults.cpp index 47254d1..87dd9c2 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_OsResults.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_OsResults.cpp @ @ -323,6 +323,56 @ @ JNIEXPORT jboolean JNICALL Java_io_realm_internal_OsResults_nativeDeleteFirst ( JN return JNI_FALSE ; } +JNIEXPORT void JNICALL Java_io_realm_internal_OsResults_nativeSetNull ( JNIEnv* /*env*/ , jclass , jlong /*native_ptr*/ , jstring /*j_field_name*/ ) + { + // FIXME + } + +JNIEXPORT void JNICALL Java_io_realm_internal_OsResults_nativeSetBoolean ( JNIEnv* /*env*/ , jclass , jlong /*native_ptr*/ , jstring /*j_field_name*/ , jboolean /*value*/ ) + { + // FIXME + } + +JNIEXPORT void JNICALL Java_io_realm_internal_OsResults_nativeSetInt ( JNIEnv* /*env*/ , jclass , jlong /*native_ptr*/ , jstring /*j_field_name*/ , jlong /*value*/ ) + { + // FIXME + } + +JNIEXPORT void JNICALL Java_io_realm_internal_OsResults_nativeSetFloat ( JNIEnv* /*env*/ , jclass , jlong /*native_ptr*/ , jstring /*j_field_name*/ , jfloat /*value*/ ) + { + // FIXME + } + +JNIEXPORT void JNICALL Java_io_realm_internal_OsResults_nativeSetDouble ( JNIEnv* /*env*/ , jclass , jlong /*native_ptr*/ , jstring /*j_field_name*/ , jdouble /*value*/ ) + { + // FIXME + } + +JNIEXPORT void JNICALL Java_io_realm_internal_OsResults_nativeSetString ( JNIEnv* /*env*/ , jclass , jlong /*native_ptr*/ , jstring /*j_field_name*/ , jstring /*value*/ ) + { + // FIXME + } + +JNIEXPORT void JNICALL Java_io_realm_internal_OsResults_nativeSetBinary ( JNIEnv* /*env*/ , jclass , jlong /*native_ptr*/ Batch or bulk updates __EoT__ Feature request following this discussion : https : //groups.google.com/forum/ # ! topic/realm-java/6NeywfWmCA4 Basically it allows setting a property on many objects in one operation just like this SQL : `` ` UPDATE Foo SET isDeleted = 1 WHERE name = `` 123 '' `` ` One option could be `` ` RealmResults < Foo > foos = realm.where ( Foo.class ) .equalsTo ( `` name '' , `` 123 '' ) ; realm.beginTransaction ( ) ; foos.updateAllObjects ( `` isDeleted '' , 1 ) ; realm.commitTransaction ( ) ; `` `
diff -- git a/CHANGELOG.md b/CHANGELOG.md index abbd226..958f738 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,4 +1,4 @ @ - # # 5. ? . ? ( 2018-MM-DD ) + # # X.Y.Z ( YYYY-MM-DD ) # # # Enhancements * None @ @ -17,14 +17,64 @ @ # # 5.8.0 ( YYYY-MM-DD ) +This release also contains all changes in 5.8.0-BETA1 and 5.8.0-BETA2 . + # # # Enhancements * [ ObjectServer ] Added Subscription class available to Query-based Realms . This exposes a Subscription more directly . This class is in beta . [ # 6231 ] ( https : //github.com/realm/realm-java/pull/6231 ) . * [ ObjectServer ] Added ` Realm.getSubscriptions ( ) ` , ` Realm.getSubscriptions ( String pattern ) ` and ` Realm.getSubscription ` to make it easier to find existing subscriptions . These API 's are in beta . [ # 6231 ] ( https : //github.com/realm/realm-java/pull/6231 ) . * [ ObjectServer ] Added ` RealmQuery.subscribe ( ) ` and ` RealmQuery.subscribe ( String name ) ` to subscribe immediately inside a transaction . These API 's are in beta . [ # 6231 ] ( https : //github.com/realm/realm-java/pull/6231 ) . * [ ObjectServer ] Added Batch or bulk updates __EoT__ Feature request following this discussion : https : //groups.google.com/forum/ # ! topic/realm-java/6NeywfWmCA4 Basically it allows setting a property on many objects in one operation just like this SQL : `` ` UPDATE Foo SET isDeleted = 1 WHERE name = `` 123 '' `` ` One option could be `` ` RealmResults < Foo > foos = realm.where ( Foo.class ) .equalsTo ( `` name '' , `` 123 '' ) ; realm.beginTransaction ( ) ; foos.updateAllObjects ( `` isDeleted '' , 1 ) ; realm.commitTransaction ( ) ; `` `
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 21c5444..956cd41 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 0.90.0 + + # # # Breaking changes + +* @ PrimaryKey field value can be null for String , Byte , Short , Integer , and Long types , and should be migrated by using RealmObjectSchema.setNullable ( ) for older version of Realm ( # 2515 ) . + # # 0.89.0 # # # Enhancements diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 8982081..f94d294 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -330,11 +330,9 @ @ public class ClassMetaData { } public boolean isNullable ( VariableElement variableElement ) { - // primary keys can not be nullable - if ( hasPrimaryKey ( ) ) { - if ( variableElement.equals ( getPrimaryKey ( ) ) ) { - return false ; - } + // a primary key can be nullable only if its type could be found in JAVA_TO_NULLABLE_PRIMARYKEY_TYPES + if ( hasPrimaryKey ( ) & & variableElement.equals ( getPrimaryKey ( ) ) ) { + return Utils.isNullablePrimaryKeyType ( variableElement ) ; } return nullableFields.contains ( variableElement ) ; } diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java index 8cb7ec6..c181426 100644 io.realm.exceptions.RealmMigrationNeededException : RealmMigration must be provided __EoT__ # # # # Goal > What do you want to achieve ? Update an existing Android application using the old ( pre January 2016 ) method for including Realm in our grade file . ( https : //realm.io/news/android-installation-change/ ) without crashes # # # # Expected Results > We expected Realm would update without crashing when we changed the way we included Realm in our application to the new way ( in the article above ) # # # # Actual Results > When users update the app from the Google Play Store , the app crashes upon opening . This is occurring when users have an old version already on their phones ( with the old way of including Realm ) . This is the stack trace we see when we re-create this crash : ` 11-22 09:02:49.356 4836-4836/com. < company-name > . < client-name > E/AndroidRuntime : FATAL EXCEPTION : main Process : com. < company-name > . < client-name > , PID : 4836 java.lang.RuntimeException : Unable to start activity ComponentInfo { com. < company-name > . < client-name > /com. < company-name > . < client-name > .SplashScreen
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 4e5ecf2..8a3ac2d 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -69,18 +69,17 @ @ public class RealmProxyClassGenerator { imports.add ( `` io.realm.internal.ImplicitTransaction '' ) ; imports.add ( `` io.realm.internal.LinkView '' ) ; imports.add ( `` io.realm.internal.android.JsonUtils '' ) ; - imports.add ( `` io.realm.internal.Row '' ) ; imports.add ( `` java.io.IOException '' ) ; imports.add ( `` java.util.ArrayList '' ) ; imports.add ( `` java.util.Collections '' ) ; imports.add ( `` java.util.List '' ) ; + imports.add ( `` java.util.Iterator '' ) ; imports.add ( `` java.util.Date '' ) ; imports.add ( `` java.util.Map '' ) ; imports.add ( `` java.util.HashMap '' ) ; imports.add ( `` org.json.JSONObject '' ) ; imports.add ( `` org.json.JSONException '' ) ; imports.add ( `` org.json.JSONArray '' ) ; - imports.add ( `` java.util.concurrent.Future '' ) ; imports.add ( metadata.getFullyQualifiedClassName ( ) ) ; @ @ -122,6 +121,10 @ @ public class RealmProxyClassGenerator { emitCreateUsingJsonStream ( writer ) ; emitCopyOrUpdateMethod ( writer ) ; emitCopyMethod ( writer ) ; + emitInsertMethod ( writer ) ; + emitInsertListMethod ( writer ) ; + emitInsertOrUpdateMethod ( writer ) ; + emitInsertOrUpdateListMethod ( writer ) ; emitCreateDetachedCopyMethod ( writer ) ; emitUpdateMethod Bulk insert __EoT__ This is feature requested by http : //stackoverflow.com/questions/33358880/realm-java-fastest-bulk-write-methodology Most SQL database support `` batch insert '' like ` INSERT INTO tbl ( col1 , col2 ) VALUES ( 'val1 ' , 'val2 ' ) , ( 'val3 ' , 'val4 ' ) , ... ` Our current bottle neck would be when inserting lots of data , lots of duplicated checking are made , and lots or jni calls are made . We should find a way to pass a batch of different types of data to JNI and insert them through one JNI call .
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 4e5ecf2..93916e0 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -69,18 +69,17 @ @ public class RealmProxyClassGenerator { imports.add ( `` io.realm.internal.ImplicitTransaction '' ) ; imports.add ( `` io.realm.internal.LinkView '' ) ; imports.add ( `` io.realm.internal.android.JsonUtils '' ) ; - imports.add ( `` io.realm.internal.Row '' ) ; imports.add ( `` java.io.IOException '' ) ; imports.add ( `` java.util.ArrayList '' ) ; imports.add ( `` java.util.Collections '' ) ; imports.add ( `` java.util.List '' ) ; + imports.add ( `` java.util.Iterator '' ) ; imports.add ( `` java.util.Date '' ) ; imports.add ( `` java.util.Map '' ) ; imports.add ( `` java.util.HashMap '' ) ; imports.add ( `` org.json.JSONObject '' ) ; imports.add ( `` org.json.JSONException '' ) ; imports.add ( `` org.json.JSONArray '' ) ; - imports.add ( `` java.util.concurrent.Future '' ) ; imports.add ( metadata.getFullyQualifiedClassName ( ) ) ; @ @ -122,6 +121,10 @ @ public class RealmProxyClassGenerator { emitCreateUsingJsonStream ( writer ) ; emitCopyOrUpdateMethod ( writer ) ; emitCopyMethod ( writer ) ; + emitInsertMethod ( writer ) ; + emitInsertListMethod ( writer ) ; + emitInsertOrUpdateMethod ( writer ) ; + emitInsertOrUpdateListMethod ( writer ) ; emitCreateDetachedCopyMethod ( writer ) ; emitUpdateMethod Bulk insert __EoT__ This is feature requested by http : //stackoverflow.com/questions/33358880/realm-java-fastest-bulk-write-methodology Most SQL database support `` batch insert '' like ` INSERT INTO tbl ( col1 , col2 ) VALUES ( 'val1 ' , 'val2 ' ) , ( 'val3 ' , 'val4 ' ) , ... ` Our current bottle neck would be when inserting lots of data , lots of duplicated checking are made , and lots or jni calls are made . We should find a way to pass a batch of different types of data to JNI and insert them through one JNI call .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 0231535..6e97731 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -2,6 +2,7 @ @ # # # Enhancements +* Added ` insert ( RealmModel obj ) ` , ` insertOrUpdate ( RealmModel obj ) ` , ` insert ( Collection < RealmModel > collection ) ` and ` insertOrUpdate ( Collection < RealmModel > collection ) ` to perform batch inserts ( # 1684 ) * Enhanced ` Table.toString ( ) ` to show a PrimaryKey field details ( # 2903 ) . * Enabled ReLinker when loading a Realm from a custom path by adding a ` RealmConfiguration.Builder ( Context , File ) ` constructor ( # 2900 ) . @ @ -14,6 +15,7 @ @ # # # Bug fixes * Disabled the optional API transformer since it has problems with DexGuard ( 3022 ) . +* Fixed a bug in ` copyToRealm ` causing a cyclic dependency objects being duplicated . # # 1.0.1 @ @ -43,7 +45,7 @ @ No changes since 0.91.1 . # # # Bug fixes -* Fixed a bug when opening a Realm cause a staled memory mapping . Symptoms are error messages like `` Bad or Bulk insert __EoT__ This is feature requested by http : //stackoverflow.com/questions/33358880/realm-java-fastest-bulk-write-methodology Most SQL database support `` batch insert '' like ` INSERT INTO tbl ( col1 , col2 ) VALUES ( 'val1 ' , 'val2 ' ) , ( 'val3 ' , 'val4 ' ) , ... ` Our current bottle neck would be when inserting lots of data , lots of duplicated checking are made , and lots or jni calls are made . We should find a way to pass a batch of different types of data to JNI and insert them through one JNI call .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 RealmList < Integer / String / ... > __EoT__ Dear realm-Team , I 'm really impressed by Realm and I do like the way you 're providing support and solutions on github , SO and gGroups ! I like working with Realm - however there are three really big drawbacks for me : 1 ) No model-instantiation by ` = new ... ` - I know you 're on it . I ca n't wait for this ! Do we have to wait for the `` whole '' JSON-Upgrade or will there be an earlier release providing this feature ? 2 ) No model-passing across threads . That 's hindering all the great benefits of EventBus and Android Priority Job Queue . But I read that it will be possible in the further versions and I 'm looking forward on this . 3 ) **The reason for this issue : ** In my model class I 'm allowed to have primitive fields as well as object fields of objects that extend ` RealmObject ` . But I 'm not allowed to have a field type like ` RealmList < Integer > ` or ` RealmList < String > ` .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be RealmList < Integer / String / ... > __EoT__ Dear realm-Team , I 'm really impressed by Realm and I do like the way you 're providing support and solutions on github , SO and gGroups ! I like working with Realm - however there are three really big drawbacks for me : 1 ) No model-instantiation by ` = new ... ` - I know you 're on it . I ca n't wait for this ! Do we have to wait for the `` whole '' JSON-Upgrade or will there be an earlier release providing this feature ? 2 ) No model-passing across threads . That 's hindering all the great benefits of EventBus and Android Priority Job Queue . But I read that it will be possible in the further versions and I 'm looking forward on this . 3 ) **The reason for this issue : ** In my model class I 'm allowed to have primitive fields as well as object fields of objects that extend ` RealmObject ` . But I 'm not allowed to have a field type like ` RealmList < Integer > ` or ` RealmList < String > ` .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 RealmList < Integer / String / ... > __EoT__ Dear realm-Team , I 'm really impressed by Realm and I do like the way you 're providing support and solutions on github , SO and gGroups ! I like working with Realm - however there are three really big drawbacks for me : 1 ) No model-instantiation by ` = new ... ` - I know you 're on it . I ca n't wait for this ! Do we have to wait for the `` whole '' JSON-Upgrade or will there be an earlier release providing this feature ? 2 ) No model-passing across threads . That 's hindering all the great benefits of EventBus and Android Priority Job Queue . But I read that it will be possible in the further versions and I 'm looking forward on this . 3 ) **The reason for this issue : ** In my model class I 'm allowed to have primitive fields as well as object fields of objects that extend ` RealmObject ` . But I 'm not allowed to have a field type like ` RealmList < Integer > ` or ` RealmList < String > ` .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 RealmList < Integer / String / ... > __EoT__ Dear realm-Team , I 'm really impressed by Realm and I do like the way you 're providing support and solutions on github , SO and gGroups ! I like working with Realm - however there are three really big drawbacks for me : 1 ) No model-instantiation by ` = new ... ` - I know you 're on it . I ca n't wait for this ! Do we have to wait for the `` whole '' JSON-Upgrade or will there be an earlier release providing this feature ? 2 ) No model-passing across threads . That 's hindering all the great benefits of EventBus and Android Priority Job Queue . But I read that it will be possible in the further versions and I 'm looking forward on this . 3 ) **The reason for this issue : ** In my model class I 'm allowed to have primitive fields as well as object fields of objects that extend ` RealmObject ` . But I 'm not allowed to have a field type like ` RealmList < Integer > ` or ` RealmList < String > ` .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 RealmList < Integer / String / ... > __EoT__ Dear realm-Team , I 'm really impressed by Realm and I do like the way you 're providing support and solutions on github , SO and gGroups ! I like working with Realm - however there are three really big drawbacks for me : 1 ) No model-instantiation by ` = new ... ` - I know you 're on it . I ca n't wait for this ! Do we have to wait for the `` whole '' JSON-Upgrade or will there be an earlier release providing this feature ? 2 ) No model-passing across threads . That 's hindering all the great benefits of EventBus and Android Priority Job Queue . But I read that it will be possible in the further versions and I 'm looking forward on this . 3 ) **The reason for this issue : ** In my model class I 'm allowed to have primitive fields as well as object fields of objects that extend ` RealmObject ` . But I 'm not allowed to have a field type like ` RealmList < Integer > ` or ` RealmList < String > ` .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be RealmList < Integer / String / ... > __EoT__ Dear realm-Team , I 'm really impressed by Realm and I do like the way you 're providing support and solutions on github , SO and gGroups ! I like working with Realm - however there are three really big drawbacks for me : 1 ) No model-instantiation by ` = new ... ` - I know you 're on it . I ca n't wait for this ! Do we have to wait for the `` whole '' JSON-Upgrade or will there be an earlier release providing this feature ? 2 ) No model-passing across threads . That 's hindering all the great benefits of EventBus and Android Priority Job Queue . But I read that it will be possible in the further versions and I 'm looking forward on this . 3 ) **The reason for this issue : ** In my model class I 'm allowed to have primitive fields as well as object fields of objects that extend ` RealmObject ` . But I 'm not allowed to have a field type like ` RealmList < Integer > ` or ` RealmList < String > ` .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 RealmList < Integer / String / ... > __EoT__ Dear realm-Team , I 'm really impressed by Realm and I do like the way you 're providing support and solutions on github , SO and gGroups ! I like working with Realm - however there are three really big drawbacks for me : 1 ) No model-instantiation by ` = new ... ` - I know you 're on it . I ca n't wait for this ! Do we have to wait for the `` whole '' JSON-Upgrade or will there be an earlier release providing this feature ? 2 ) No model-passing across threads . That 's hindering all the great benefits of EventBus and Android Priority Job Queue . But I read that it will be possible in the further versions and I 'm looking forward on this . 3 ) **The reason for this issue : ** In my model class I 'm allowed to have primitive fields as well as object fields of objects that extend ` RealmObject ` . But I 'm not allowed to have a field type like ` RealmList < Integer > ` or ` RealmList < String > ` .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..3f9cae0 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be RealmList < Integer / String / ... > __EoT__ Dear realm-Team , I 'm really impressed by Realm and I do like the way you 're providing support and solutions on github , SO and gGroups ! I like working with Realm - however there are three really big drawbacks for me : 1 ) No model-instantiation by ` = new ... ` - I know you 're on it . I ca n't wait for this ! Do we have to wait for the `` whole '' JSON-Upgrade or will there be an earlier release providing this feature ? 2 ) No model-passing across threads . That 's hindering all the great benefits of EventBus and Android Priority Job Queue . But I read that it will be possible in the further versions and I 'm looking forward on this . 3 ) **The reason for this issue : ** In my model class I 'm allowed to have primitive fields as well as object fields of objects that extend ` RealmObject ` . But I 'm not allowed to have a field type like ` RealmList < Integer > ` or ` RealmList < String > ` .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 2fe5b41..f4df7d8 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -7,6 +7,8 @ @ # # # Breaking Changes * ` RealmResults.distinct ( ) ` / ` RealmResults.distinctAsync ( ) ` have been removed . Use ` RealmQuery.distinct ( ) ` / ` RealmQuery.distinctAsync ( ) ` instead . +* ` RealmQuery.createQuery ( Realm , Class ) ` , ` RealmQuery.createDynamicQuery ( DynamicRealm , String ) ` , ` RealmQuery.createQueryFromResult ( RealmResults ) ` and ` RealmQuery.createQueryFromList ( RealmList ) ` have been removed . Use ` Realm.where ( Class ) ` , ` DynamicRealm.where ( String ) ` , RealmResults.where ( ) ` and ` RealmList.where ( ) ` instead . +* Some exception messages are revised . # # # Internal diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) RealmList < Integer / String / ... > __EoT__ Dear realm-Team , I 'm really impressed by Realm and I do like the way you 're providing support and solutions on github , SO and gGroups ! I like working with Realm - however there are three really big drawbacks for me : 1 ) No model-instantiation by ` = new ... ` - I know you 're on it . I ca n't wait for this ! Do we have to wait for the `` whole '' JSON-Upgrade or will there be an earlier release providing this feature ? 2 ) No model-passing across threads . That 's hindering all the great benefits of EventBus and Android Priority Job Queue . But I read that it will be possible in the further versions and I 'm looking forward on this . 3 ) **The reason for this issue : ** In my model class I 'm allowed to have primitive fields as well as object fields of objects that extend ` RealmObject ` . But I 'm not allowed to have a field type like ` RealmList < Integer > ` or ` RealmList < String > ` .
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 55eafb9..9235411 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -927,6 +927,11 @ @ public class RealmProxyClassGenerator { writer.emitEmptyLine ( ) ; } + /** + * Currently , the hash value emitted from this could suddenly change as an object 's index might + * alternate due to Realm Java using { @ code Table # moveLastOver ( ) } . Hash codes should therefore not + * be considered stable , i.e . do n't save them in a HashSet or use them as a key in a HashMap . + */ private void emitHashcodeMethod ( JavaWriter writer ) throws IOException { if ( metadata.containsHashCode ( ) ) { return ; diff -- git a/realm/realm-library/src/main/java/io/realm/DynamicRealmObject.java b/realm/realm-library/src/main/java/io/realm/DynamicRealmObject.java index 591722a..e9bab17 100644 -- - a/realm/realm-library/src/main/java/io/realm/DynamicRealmObject.java +++ b/realm/realm-library/src/main/java/io/realm/DynamicRealmObject.java @ @ -641,6 +641,19 @ @ public final class DynamicRealmObject extends RealmObject implements RealmObject return proxyState.getRow $ realm ( ) .getColumnType ( columnIndex ) ; } + /** + * Returns a hash code value for the { @ link DynamicRealmObject } object . + * < p > + * By the general contract of { @ link Object # hashCode ( ) } , any two objects HashCode not working correctly __EoT__ Right now we use the following for ` hashCode ` : `` ` String realmName = realm.getPath ( ) ; String tableName = row.getTable ( ) .getName ( ) ; long rowIndex = row.getIndex ( ) ; int result = 17 ; result = 31 * result + ( ( realmName ! = null ) ? realmName.hashCode ( ) : 0 ) ; result = 31 * result + ( ( tableName ! = null ) ? tableName.hashCode ( ) : 0 ) ; result = 31 * result + ( int ) ( rowIndex ^ ( rowIndex > > > 32 ) ) ; return result ; `` ` The problem is ` rowIndex ` might suddenly change through the use of ` moveLastOver ` . This will change the hashCode unexpectedly and break things like Set : https : //docs.oracle.com/javase/7/docs/api/java/util/Set.html Cocoa currently uses the PrimaryKey value ( which is not allowed to change ) if possible , otherwise fallback to the default hashcode implementation . This has the downside that ` result.get ( 0 ) .equals ( result.get ( 0 ) ) == false ` . Without persistent identifiers we have to accept
diff -- git a/CHANGELOG.md b/CHANGELOG.md index b5552cb..4096af8 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -4,6 +4,7 @ @ * Those were not kept by ProGuard : names of native methods not in the ` io.realm.internal ` package , names of classes used in method signature ( # 3596 ) . * Missing ProGuard configuration for libraries used by Sync extension ( # 3596 ) . +* Permission error when a database file is located at external storage ( # 3140 ) . # # 2.0.2 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java index a920574..da268f9 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java @ @ -3811,4 +3811,34 @ @ public class RealmTests { realm.close ( ) ; assertEquals ( 0 , Realm.getGlobalInstanceCount ( config ) ) ; } + + @ Test + public void testExternalStorage ( ) { + // test for https : //github.com/realm/realm-java/issues/3140 + realm.close ( ) ; + realm = null ; + + final File namedPipeDir = SharedRealm.getNamedPipeDirectory ( ) ; + assertTrue ( namedPipeDir.isDirectory ( ) ) ; + TestHelper.deleteRecursively ( namedPipeDir ) ; + //noinspection ResultOfMethodCallIgnored + namedPipeDir.mkdirs ( ) ; + + final File externalFilesDir = context.getExternalFilesDir ( null ) ; + final RealmConfiguration config = Error : Operation not permitted in io_realm_internal_SharedGroup.cpp __EoT__ # # # # Goal > What do you want to achieve ? # # # # Actual Results io.realm.exceptions.RealmError : Unrecoverable error . Operation not permitted in io_realm_internal_SharedGroup.cpp line 113 at io.realm.internal.SharedGroup.createNativeWithImplicitTransactions ( Native Method ) at io.realm.internal.SharedGroup.openSharedGroupOrFail ( SharedGroup.java:95 ) at io.realm.internal.SharedGroup. & lt ; init & gt ; ( SharedGroup.java:74 ) at io.realm.internal.SharedGroupManager. & lt ; init & gt ; ( SharedGroupManager.java:49 ) at io.realm.BaseRealm. & lt ; init & gt ; ( BaseRealm.java:81 ) at io.realm.Realm. & lt ; init & gt ; ( Realm.java:140 ) at io.realm.Realm.createAndValidate ( Realm.java:240 ) at io.realm.Realm.createInstance ( Realm.java:220 ) at io.realm.RealmCache.createRealmOrGetFromCache ( RealmCache.java:126 ) at io.realm.Realm.getDefaultInstance ( Realm.java:166 ) at br.com.jbsoft.mobile.di.modules.ProviderModule.provideRealm ( ProviderModule.java:28 ) at br.com.jbsoft.mobile.di.modules.ProviderModule_ProvideRealmFactory.get ( ProviderModule_ProvideRealmFactory.java:19 ) at br.com.jbsoft.mobile.di.modules.ProviderModule_ProvideRealmFactory.get ( ProviderModule_ProvideRealmFactory.java:8 ) at br.com.jbsoft.mobile.models.ControleUsuario_MembersInjector.injectMembers ( ControleUsuario_MembersInjector.java:33 ) at br.com.jbsoft.mobile.models.ControleUsuario_MembersInjector.injectMembers ( ControleUsuario_MembersInjector.java:9 ) at br.com.jbsoft.mobile.di.components.DaggerProviderComponent.inject ( DaggerProviderComponent.java:243 ) at br.com.jbsoft.mobile.models.ControleUsuario.inject ( ControleUsuario.java:31 ) at br.com.jbsoft.mobile.models.ControleUsuario.getUsuario ( ControleUsuario.java:35 ) at br.com.jbsoft.mobile.views.Main.onCreate ( Main.java:59 ) at br.com.jbsoft.mobile.componentes.BaseActivity.onCreate ( BaseActivity.java:86 ) at android.app.Activity.performCreate ( Activity.java:6500 ) at android.app.Instrumentation.callActivityOnCreate ( Instrumentation.java:1120 ) at android.app.ActivityThread.performLaunchActivity ( ActivityThread.java:3072 ) at android.app.ActivityThread.handleLaunchActivity ( ActivityThread.java:3218 ) at android.app.ActivityThread.access $ 1000 ( ActivityThread.java:198 ) at android.app.ActivityThread $ H.handleMessage (
diff -- git a/README.md b/README.md index ee52154..268af42 100644 -- - a/README.md +++ b/README.md @ @ -220,6 +220,9 @ @ To run a testing server locally : ./gradlew connectedObjectServerDebugAndroidTest `` ` +Note that if using VirtualBox ( Genymotion ) , the network needs to be bridged for the tests to work . +This is done in ` VirtualBox > Network ` . Set `` Adapter 2 '' to `` Bridged Adapter '' . + These tests may take as much as half an hour to complete . # # Contributing diff -- git a/realm/config/findbugs/findbugs-filter.xml b/realm/config/findbugs/findbugs-filter.xml index 10553d8..e2573eb 100644 -- - a/realm/config/findbugs/findbugs-filter.xml +++ b/realm/config/findbugs/findbugs-filter.xml @ @ -109,4 +109,9 @ @ < Class name= '' io.realm.PermissionChangeRealmProxy '' / > < Bug pattern= '' BC_IMPOSSIBLE_CAST '' / > < /Match > + < Match > + < Class name= '' io.realm.internal.objectserver.Token $ Permission '' / > + < Field name= '' ALL '' / > + < Bug pattern= '' MS_MUTABLE_ARRAY '' / > + < /Match > < /FindBugsFilter > diff -- git a/realm/realm-library/src/androidTest/AndroidManifest.xml b/realm/realm-library/src/androidTest/AndroidManifest.xml index c7741a6..d9e252d 100644 -- - a/realm/realm-library/src/androidTest/AndroidManifest.xml +++ b/realm/realm-library/src/androidTest/AndroidManifest.xml @ @ -21,6 +21,23 @ @ android : exported= '' true '' android : process= '' : remote '' > Credentials.usernamePassword with multiple options __EoT__ Pr . internal discussion on API alignment on Sync API 's , we need to supply a ` createAccountIfNeeded ` or ` createUser|useExistingAccount ` option . `` ` // Current Credentials.usernamePassword ( `` username '' , `` password '' , true ) ; // Last parameters should be a flag supporting the following : // createUser , useExistingAccount and createUser|useExistingAccount ~ createUserIfNeeded // Natural suggestion would either be enum or bitwise flags , but I think just having another constructor could be simpler : Credentials.usernamePassword ( `` user '' , `` password '' ) ; // no boolean param = createifNeeded Credentials.usernamePassword ( `` user '' , `` password '' , false ) ; // Choose to create or not // Alternatives Credentials.usernamePassword ( `` user '' , `` password '' , Credentials.Options.CREATE_IF_NEEDED ) ; Credentials.usernamePassword ( `` user '' , `` password '' , Credentials.CREATE_ACCOUNT | Credentials.USE_EXISITING_ACCOUNT ) ; `` ` Thoughts @ realm/java ?
diff -- git a/README.md b/README.md index ee52154..268af42 100644 -- - a/README.md +++ b/README.md @ @ -220,6 +220,9 @ @ To run a testing server locally : ./gradlew connectedObjectServerDebugAndroidTest `` ` +Note that if using VirtualBox ( Genymotion ) , the network needs to be bridged for the tests to work . +This is done in ` VirtualBox > Network ` . Set `` Adapter 2 '' to `` Bridged Adapter '' . + These tests may take as much as half an hour to complete . # # Contributing diff -- git a/realm/config/findbugs/findbugs-filter.xml b/realm/config/findbugs/findbugs-filter.xml index 10553d8..e2573eb 100644 -- - a/realm/config/findbugs/findbugs-filter.xml +++ b/realm/config/findbugs/findbugs-filter.xml @ @ -109,4 +109,9 @ @ < Class name= '' io.realm.PermissionChangeRealmProxy '' / > < Bug pattern= '' BC_IMPOSSIBLE_CAST '' / > < /Match > + < Match > + < Class name= '' io.realm.internal.objectserver.Token $ Permission '' / > + < Field name= '' ALL '' / > + < Bug pattern= '' MS_MUTABLE_ARRAY '' / > + < /Match > < /FindBugsFilter > diff -- git a/realm/realm-library/src/androidTest/AndroidManifest.xml b/realm/realm-library/src/androidTest/AndroidManifest.xml index c7741a6..d9e252d 100644 -- - a/realm/realm-library/src/androidTest/AndroidManifest.xml +++ b/realm/realm-library/src/androidTest/AndroidManifest.xml @ @ -21,6 +21,23 @ @ android : exported= '' true '' android : process= '' : remote '' > Credentials.usernamePassword with multiple options __EoT__ Pr . internal discussion on API alignment on Sync API 's , we need to supply a ` createAccountIfNeeded ` or ` createUser|useExistingAccount ` option . `` ` // Current Credentials.usernamePassword ( `` username '' , `` password '' , true ) ; // Last parameters should be a flag supporting the following : // createUser , useExistingAccount and createUser|useExistingAccount ~ createUserIfNeeded // Natural suggestion would either be enum or bitwise flags , but I think just having another constructor could be simpler : Credentials.usernamePassword ( `` user '' , `` password '' ) ; // no boolean param = createifNeeded Credentials.usernamePassword ( `` user '' , `` password '' , false ) ; // Choose to create or not // Alternatives Credentials.usernamePassword ( `` user '' , `` password '' , Credentials.Options.CREATE_IF_NEEDED ) ; Credentials.usernamePassword ( `` user '' , `` password '' , Credentials.CREATE_ACCOUNT | Credentials.USE_EXISITING_ACCOUNT ) ; `` ` Thoughts @ realm/java ?
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 79948b3..272e78e 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 1.2.0 + + # # # Enhancements + +* Added ` RealmQuery.in ( ) ` for a comparison against multiple values . + # # 1.1.1 # # # Bug fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java index 5dcce6c..1aae60e 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java @ @ -100,6 +100,9 @ @ public class RealmQueryTests { allTypes.setColumnDouble ( 3.1415 ) ; allTypes.setColumnFloat ( 1.234567f + i ) ; allTypes.setColumnString ( `` test data `` + i ) ; + allTypes.setColumnByte ( ( byte ) i ) ; + allTypes.setColumnShort ( ( short ) i ) ; + allTypes.setColumnInt ( i ) ; allTypes.setColumnLong ( i ) ; NonLatinFieldNames nonLatinFieldNames = testRealm.createObject ( NonLatinFieldNames.class ) ; nonLatinFieldNames.set델타 ( i ) ; @ @ -405,6 +408,196 @ @ public class RealmQueryTests { } @ Test + public void in_string ( ) { + populateTestRealm ( realm , 200 ) ; + try { + realm.where ( AllTypes.class ) .in ( AllTypes.FIELD_STRING , ( String [ ] ) null ) .findAll ( ) ; + } catch ( IllegalArgumentException ignored ) { + equalToAny ( ) / equalToAll ( ) / In ( ) — query for list membership __EoT__ How can I achieve a query like this in Realm ? Is there a way to pass ` RealmResults ` as a parameter for the queries ? `` ` sql SELECT * FROM users WHERE id IN ( SELECT * FROM banned_user_ids ) ; `` `
diff -- git a/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy b/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy index b9e388c..ce1fc39 100644 -- - a/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy +++ b/realm-transformer/src/main/groovy/io/realm/transformer/BytecodeModifier.groovy @ @ -57,7 +57,7 @ @ class BytecodeModifier { * @ param clazz The CtClass to modify * @ param managedFields List of fields whose access should be replaced */ - public static void useRealmAccessors ( CtClass clazz , List < CtField > managedFields , List < CtClass > modelClasses ) { + public static void useRealmAccessors ( CtClass clazz , List < CtField > managedFields ) { clazz.getDeclaredBehaviors ( ) .each { behavior - > logger.info `` Behavior : $ { behavior.name } '' if ( @ @ -69,7 +69,7 @ @ class BytecodeModifier { behavior instanceof CtConstructor ) ) { - behavior.instrument ( new FieldAccessToAccessorConverter ( managedFields , clazz , behavior , modelClasses.contains ( clazz ) ) ) + behavior.instrument ( new FieldAccessToAccessorConverter ( managedFields , clazz , behavior ) ) } } } @ @ -93,18 +93,13 @ @ class BytecodeModifier { final List < CtField > managedFields final CtClass ctClass final CtBehavior behavior - final boolean isModelClass - final boolean isInConstructor FieldAccessToAccessorConverter ( List < CtField > managedFields , CtClass ctClass , - CtBehavior behavior , - boolean isModelClass ) { + CtBehavior Calling setter method in no argument constructor results in NPE __EoT__ # # # # Goal Be able to use setter methods in the no arguments constructor . # # # # Expected Results No NPE and field set to the given value . # # # # Actual Results `` ` Caused by : java.lang.NullPointerException : Attempt to invoke virtual method 'void io.realm.BaseRealm.checkIfValid ( ) ' on a null object reference at io.realm.ModelRealmProxy.realmSet $ string ( ModelRealmProxy.java:62 ) at de.jonasrottmann.realmtest.Model.setString ( Model.java:13 ) at de.jonasrottmann.realmtest.Model. < init > ( Model.java:19 ) at io.realm.ModelRealmProxy. < init > ( ModelRealmProxy.java:51 ) at io.realm.DefaultRealmModuleMediator.newInstance ( DefaultRealmModuleMediator.java:80 ) at io.realm.BaseRealm.get ( BaseRealm.java:521 ) at io.realm.Realm.createObject ( Realm.java:709 ) `` ` # # # # Code Sample `` ` java public class Model extends RealmObject { public String string ; public void setString ( String string ) { this.string = string ; } public Model ( ) { setString ( `` Success ! `` ) ; } } `` ` # # # # Version of Realm and tooling Realm version ( s ) : 0.88.2 Android Studio version : 2.1 Preview 4 Which Android version and device : 6.0.1 ( MHC19J ) on
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 68fbc27..fda2b14 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -21,6 +21,7 @ @ * Added ` realmObject.isManaged ( ) ` , ` RealmObject.isManaged ( obj ) ` and ` RealmCollection.isManaged ( ) ` ( # 3101 ) . * Added ` RealmConfiguration.Builder.directory ( File ) ` . * ` RealmLog ` has been moved to the public API . It is now possible to control which events Realm emit to Logcat . See the ` RealmLog ` class for more details . +* Typed ` RealmObject ` s can now continue to access their fields properly even though the schema was changed while the Realm was open ( # 3409 ) . # # # Bug fixes diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 83c2d43..56e1ff7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -66,7 +66,6 @ @ public class RealmProxyClassGenerator { imports.add ( `` android.os.Build '' ) ; imports.add ( `` android.util.JsonReader '' ) ; imports.add ( `` android.util.JsonToken '' ) ; - imports.add ( `` io.realm.RealmFieldType '' ) ; imports.add ( `` io.realm.exceptions.RealmMigrationNeededException '' ) ; imports.add ( `` io.realm.internal.ColumnInfo '' ) ; imports.add ( `` io.realm.internal.RealmObjectProxy '' ) ; @ @ -141,7 +140,7 Use ObjectStore functions for creating meta tables __EoT__ To ensure full and stable compatibility between platforms we need to use Object Store functionality for creating the ` meta ` and ` pk ` tables . See e.g https : //github.com/realm/realm-java/pull/3409 # discussion-diff-78084779
diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java index 6f00668..2e272cc 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java @ @ -2053,19 +2053,25 @ @ public class RealmTests { } } - // FIXME HandlerThread + // This test assure that calling refresh will not trigger local listeners + // after the Looper receives REALM_CHANGE message @ Test - public void processLocalListenersAfterRefresh ( ) throws InterruptedException { + public void processRefreshLocalListenersAfterLooperQueueStart ( ) throws Throwable { // Used to validate the result final AtomicBoolean listenerWasCalled = new AtomicBoolean ( false ) ; final AtomicBoolean typeListenerWasCalled = new AtomicBoolean ( false ) ; // Used by the background thread to wait for the main thread to do the write operation final CountDownLatch bgThreadLatch = new CountDownLatch ( 1 ) ; - final CountDownLatch bgClosedLatch = new CountDownLatch ( 1 ) ; + final CountDownLatch bgClosedLatch = new CountDownLatch ( 2 ) ; final CountDownLatch bgThreadReadyLatch = new CountDownLatch ( 1 ) ; + final CountDownLatch signalClosedRealm = new CountDownLatch ( 1 ) ; - Thread backgroundThread = new Thread ( ) { + final Looper [ ] looper = new Looper [ 1 ] ; + final Throwable [ ] throwable = new Throwable [ 1 ] Feature Request : Manual `` Refresh '' ( synchronization of Realm instance to latest version on background thread ) __EoT__ # # # # Goal > What do you want to achieve ? I feel a certain set of de-ja-vu , but I 'd like to execute a periodic task in an ` IntentService ` and ensure that the Realm is always up to date for querying data without having to execute a transaction on non-looper ( or IntentService ) background thread . # # # # Expected Results Call ` realm.refresh ( ) ` on a background non-looper ( or IntentService ) thread , and the Realm instance should be synchronized to its latest version . # # # # Actual Results This method was removed in 0.89.0 in favor of ` waitForChange ( ) ` , but that method is difficult to work with [ waitForChange ( ) /stopWaitForChange ( ) ] ( https : //gist.github.com/cmelchior/8786ec511f7e1f47673935a26f568106 ) because you need to use your own thread , and you can not wake it up periodically while it waits for a Realm change . # # # # Code Sample http : //stackoverflow.com/questions/39600315/realm-not-fetching-data or http : //stackoverflow.com/questions/38833163/realmchangelistener-does-not-get-called-when-realm-gets-updated-in-notificationl or http :
diff -- git a/realm/realm-jni/src/io_realm_internal_SharedGroup.cpp b/realm/realm-jni/src/io_realm_internal_SharedGroup.cpp index 1092df9..4960f0c 100644 -- - a/realm/realm-jni/src/io_realm_internal_SharedGroup.cpp +++ b/realm/realm-jni/src/io_realm_internal_SharedGroup.cpp @ @ -323,4 +323,35 @ @ JNIEXPORT jlongArray JNICALL Java_io_realm_internal_SharedGroup_nativeGetVersion env- > SetLongArrayRegion ( version_data , 0 , 2 , version_array ) ; return version_data ; - } \ No newline at end of file + } + +JNIEXPORT jboolean JNICALL Java_io_realm_internal_SharedGroup_nativeWaitForChange + ( JNIEnv *env , jobject , jlong native_ptr ) + { + TR_ENTER_PTR ( native_ptr ) + try { + return SG ( native_ptr ) - > wait_for_change ( ) ; + } + CATCH_STD ( ) + return false ; + } + +JNIEXPORT void JNICALL Java_io_realm_internal_SharedGroup_nativeWaitForChangeRelease + ( JNIEnv *env , jobject , jlong native_ptr ) + { + TR_ENTER_PTR ( native_ptr ) + try { + SG ( native_ptr ) - > wait_for_change_release ( ) ; + } + CATCH_STD ( ) + } + +JNIEXPORT void JNICALL Java_io_realm_internal_SharedGroup_nativeEnableWaitForChange + ( JNIEnv *env , jobject , jlong native_ptr ) + { + TR_ENTER_PTR ( native_ptr ) + try { + SG ( native_ptr ) - > enable_wait_for_change ( ) ; + } + CATCH_STD ( ) + } diff -- git a/realm/realm-jni/src/io_realm_internal_SharedGroup.h b/realm/realm-jni/src/io_realm_internal_SharedGroup.h index 57acdd8..9d68a4f 100644 -- - a/realm/realm-jni/src/io_realm_internal_SharedGroup.h +++ b/realm/realm-jni/src/io_realm_internal_SharedGroup.h Feature Request : Manual `` Refresh '' ( synchronization of Realm instance to latest version on background thread ) __EoT__ # # # # Goal > What do you want to achieve ? I feel a certain set of de-ja-vu , but I 'd like to execute a periodic task in an ` IntentService ` and ensure that the Realm is always up to date for querying data without having to execute a transaction on non-looper ( or IntentService ) background thread . # # # # Expected Results Call ` realm.refresh ( ) ` on a background non-looper ( or IntentService ) thread , and the Realm instance should be synchronized to its latest version . # # # # Actual Results This method was removed in 0.89.0 in favor of ` waitForChange ( ) ` , but that method is difficult to work with [ waitForChange ( ) /stopWaitForChange ( ) ] ( https : //gist.github.com/cmelchior/8786ec511f7e1f47673935a26f568106 ) because you need to use your own thread , and you can not wake it up periodically while it waits for a Realm change . # # # # Code Sample http : //stackoverflow.com/questions/39600315/realm-not-fetching-data or http : //stackoverflow.com/questions/38833163/realmchangelistener-does-not-get-called-when-realm-gets-updated-in-notificationl or http :
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 57d77ac..d8e6d2f 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -13,6 +13,7 @ @ * Deprecated methods : Realm.getInstance ( Context ) . Use Realm.getInstance ( RealmConfiguration ) or Realm.getDefaultInstance ( ) instead . * Deprecated methods : Realm.getTable ( Class ) which was public because of the old migration API . Use Realm.getSchema ( ) or DynamicRealm.getSchema ( ) instead . * Deprecated Realm.executeTransaction ( Transaction , Callback ) and replaced it with Realm.executeTransactionAsync ( Transaction ) , Realm.executeTransactionAsync ( Transaction , OnSuccess ) , Realm.executeTransactionAsync ( Transaction , OnError ) and Realm.executeTransactionAsync ( Transaction , OnSuccess , OnError ) . +* Deprecated methods : Realm.refresh ( ) and DynamicRealm.refresh ( ) . Use Realm.waitForChange ( ) /stopWaitForChange ( ) or DynamicRealm.waitForChange ( ) /stopWaitForChange ( ) instead . * Fixed an error occurring during test and connectedCheck of unit test example ( # 1934 ) . * Fixed bug in jsonExample ( # 2092 ) . * Fixed bug when multiple calls of RealmResults.distinct ( ) causes to return wrong results ( # 2198 ) . @ @ -28,6 +29,7 @ @ * Removed allowBackup from AndroidManifest ( # 2307 ) . * Feature Request : Manual `` Refresh '' ( synchronization of Realm instance to latest version on background thread ) __EoT__ # # # # Goal > What do you want to achieve ? I feel a certain set of de-ja-vu , but I 'd like to execute a periodic task in an ` IntentService ` and ensure that the Realm is always up to date for querying data without having to execute a transaction on non-looper ( or IntentService ) background thread . # # # # Expected Results Call ` realm.refresh ( ) ` on a background non-looper ( or IntentService ) thread , and the Realm instance should be synchronized to its latest version . # # # # Actual Results This method was removed in 0.89.0 in favor of ` waitForChange ( ) ` , but that method is difficult to work with [ waitForChange ( ) /stopWaitForChange ( ) ] ( https : //gist.github.com/cmelchior/8786ec511f7e1f47673935a26f568106 ) because you need to use your own thread , and you can not wake it up periodically while it waits for a Realm change . # # # # Code Sample http : //stackoverflow.com/questions/39600315/realm-not-fetching-data or http : //stackoverflow.com/questions/38833163/realmchangelistener-does-not-get-called-when-realm-gets-updated-in-notificationl or http :
diff -- git a/CHANGELOG.md b/CHANGELOG.md index de8c50f..4be5163 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -21,12 +21,14 @ @ * ` RealmQuery.findAllSorted ( field , sort , field , sort , field , sort ) ` . Use ` RealmQuery.findAllSorted ( field [ ] , sort [ ] ) `` instead . * ` RealmQuery.findAllSortedAsync ( field , sort , field , sort , field , sort ) ` . Use ` RealmQuery.findAllSortedAsync ( field [ ] , sort [ ] ) `` instead . * ` RealmConfiguration.setModules ( ) ` . Use ` RealmConfiguration.modules ( ) ` instead . +* ` Realm.refresh ( ) ` and ` DynamicRealm.refresh ( ) ` . Use ` Realm.waitForChange ( ) ` / ` stopWaitForChange ( ) ` or ` DynamicRealm.waitForChange ( ) ` / ` stopWaitForChange ( ) ` instead . # # # Enhancements * ` RealmObjectSchema.getPrimaryKey ( ) ` . ( # 2636 ) * ` Realm.createObject ( Class , Object ) ` for creating objects with a primary key directly . * Unit tests in Android library projects now detect Realm model classes . +* ` Realm.waitForChange ( ) ` / ` stopWaitForChange ( ) ` and ` DynamicRealm.waitForChange Feature Request : Manual `` Refresh '' ( synchronization of Realm instance to latest version on background thread ) __EoT__ # # # # Goal > What do you want to achieve ? I feel a certain set of de-ja-vu , but I 'd like to execute a periodic task in an ` IntentService ` and ensure that the Realm is always up to date for querying data without having to execute a transaction on non-looper ( or IntentService ) background thread . # # # # Expected Results Call ` realm.refresh ( ) ` on a background non-looper ( or IntentService ) thread , and the Realm instance should be synchronized to its latest version . # # # # Actual Results This method was removed in 0.89.0 in favor of ` waitForChange ( ) ` , but that method is difficult to work with [ waitForChange ( ) /stopWaitForChange ( ) ] ( https : //gist.github.com/cmelchior/8786ec511f7e1f47673935a26f568106 ) because you need to use your own thread , and you can not wake it up periodically while it waits for a Realm change . # # # # Code Sample http : //stackoverflow.com/questions/39600315/realm-not-fetching-data or http : //stackoverflow.com/questions/38833163/realmchangelistener-does-not-get-called-when-realm-gets-updated-in-notificationl or http :
diff -- git a/realm/realm-library/src/androidTest/java/io/realm/ObjectChangeSetTests.java b/realm/realm-library/src/androidTest/java/io/realm/ObjectChangeSetTests.java index 942e7cb..c36aef4 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/ObjectChangeSetTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/ObjectChangeSetTests.java @ @ -337,4 +337,38 @ @ public class ObjectChangeSetTests { allTypes.deleteFromRealm ( ) ; realm.commitTransaction ( ) ; } + + // When there are more than 512 fields change , the JNI local ref table size limitation may be reached . + @ Test + @ RunTestInLooperThread + public void moreFieldsChangedThanLocalRefTableSize ( ) { + final String CLASS_NAME = `` ManyFields '' ; + final int FIELD_COUNT = 1024 ; + RealmConfiguration config = looperThread.createConfiguration ( `` many_fields '' ) ; + final DynamicRealm realm = DynamicRealm.getInstance ( config ) ; + + realm.beginTransaction ( ) ; + RealmSchema schema = realm.getSchema ( ) ; + RealmObjectSchema objectSchema = schema.create ( CLASS_NAME ) ; + for ( int i = 0 ; i < FIELD_COUNT ; i++ ) { + objectSchema.addField ( `` field '' + i , int.class ) ; + } + DynamicRealmObject obj = realm.createObject ( CLASS_NAME ) ; + realm.commitTransaction ( ) ; + + obj.addChangeListener ( new RealmObjectChangeListener < DynamicRealmObject > ( ) { + @ Override + public void onChange ( DynamicRealmObject object , ObjectChangeSet changeSet ) { + assertEquals Reach the Local Ref Table size limit when 512+ fields changes for the same object . __EoT__ Currently the ` String ` array of changed field names are created from JNI which may reach the local ref table size limits . Idea to fix it is creating ` JavaString ` class and acquire a global ref then release the local ref . Test to reproduce it : `` ` java @ Test @ RunTestInLooperThread public void moreFieldsChangedThanLocalRefTableSize ( ) { final String CLASS_NAME = `` ManyFields '' ; final int FIELD_COUNT = 1024 ; RealmConfiguration config = looperThread.createConfiguration ( `` many_fields '' ) ; DynamicRealm realm = DynamicRealm.getInstance ( config ) ; realm.beginTransaction ( ) ; RealmSchema schema = realm.getSchema ( ) ; RealmObjectSchema objectSchema = schema.create ( CLASS_NAME ) ; for ( int i = 0 ; i < FIELD_COUNT ; i++ ) { objectSchema.addField ( `` field '' + i , int.class ) ; } DynamicRealmObject obj = realm.createObject ( CLASS_NAME ) ; realm.commitTransaction ( ) ; obj.addChangeListener ( new RealmObjectChangeListener < DynamicRealmObject > ( ) { @ Override public void onChange ( DynamicRealmObject object , ObjectChangeSet changeSet ) { assertEquals ( FIELD_COUNT , changeSet.getChangedFields ( ) .length
diff -- git a/CHANGELOG.md b/CHANGELOG.md index bdd9e91..b9cf8c1 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -7,6 +7,7 @ @ # # # Bug fixes * `` operation not permitted '' issue when creating Realm file on some devices ' external storage ( # 3629 ) . +* Crash on API 10 devices ( # 3726 ) . # # # Enhancements diff -- git a/realm/realm-library/src/main/cpp/io_realm_SyncManager.cpp b/realm/realm-library/src/main/cpp/io_realm_SyncManager.cpp index e7da1e4..1567862 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_SyncManager.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_SyncManager.cpp @ @ -30,6 +30,7 @ @ # include `` io_realm_SyncManager.h '' # include `` jni_util/log.hpp '' + # include `` jni_util/jni_utils.hpp '' using namespace realm ; using namespace realm : :sync ; @ @ -42,10 +43,7 @ @ static jmethodID sync_manager_notify_error_handler = nullptr ; static void error_handler ( int error_code , std : :string message ) { - JNIEnv* env ; - if ( g_vm- > GetEnv ( ( void ** ) & env , JNI_VERSION_1_6 ) ! = JNI_OK ) { - throw std : :runtime_error ( `` JVM is not attached to this thread . Called in error_handler . `` ) ; - } + JNIEnv* env = JniUtils : :get_env ( ) ; env- > CallStaticVoidMethod ( sync_manager , sync_manager_notify_error_handler , error_code , Realm crashes on Android 2.3 device __EoT__ This issue is reported by @ takke on twitter ( http : //twitter.com/takke/status/798782520749801472 ) . # # # # Goal Works on Android 2.3.x devices . # # # # Expected Results no crash # # # # Actual Results When executing ` Realm.getDefaultInstance ( ) ` , the app crash with following dump in logcat . `` ` 01-06 10:32:12.689 I/DEBUG ( 747 ) : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** 01-06 10:32:12.689 I/DEBUG ( 747 ) : Build fingerprint : 'google/passion/passion:2.3.6/GRK39F/189904 : user/release-keys' 01-06 10:32:12.689 I/DEBUG ( 747 ) : pid : 845 , tid : 845 > > > jp.takke.realmandroid23issuesample < < < 01-06 10:32:12.689 I/DEBUG ( 747 ) : signal 11 ( SIGSEGV ) , code 1 ( SEGV_MAPERR ) , fault addr de5685a7 01-06 10:32:12.689 I/DEBUG ( 747 ) : r0 00000007 r1 00000001 r2 800a3d68 r3 00000000 01-06 10:32:12.689 I/DEBUG ( 747 ) : r4 0000ce60 r5 0000abe0 r6 de5685a7 r7 00000000 01-06 10:32:12.689 I/DEBUG ( 747 ) : r8 0000abe0 r9 4214cb28 10 0000abe0 fp 800a5368 01-06 10:32:12.689 I/DEBUG ( 747 ) : ip 800a56cc sp
diff -- git a/CHANGELOG.md b/CHANGELOG.md index bdd9e91..b9cf8c1 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -7,6 +7,7 @ @ # # # Bug fixes * `` operation not permitted '' issue when creating Realm file on some devices ' external storage ( # 3629 ) . +* Crash on API 10 devices ( # 3726 ) . # # # Enhancements diff -- git a/realm/realm-library/src/main/cpp/io_realm_SyncManager.cpp b/realm/realm-library/src/main/cpp/io_realm_SyncManager.cpp index e7da1e4..1567862 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_SyncManager.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_SyncManager.cpp @ @ -30,6 +30,7 @ @ # include `` io_realm_SyncManager.h '' # include `` jni_util/log.hpp '' + # include `` jni_util/jni_utils.hpp '' using namespace realm ; using namespace realm : :sync ; @ @ -42,10 +43,7 @ @ static jmethodID sync_manager_notify_error_handler = nullptr ; static void error_handler ( int error_code , std : :string message ) { - JNIEnv* env ; - if ( g_vm- > GetEnv ( ( void ** ) & env , JNI_VERSION_1_6 ) ! = JNI_OK ) { - throw std : :runtime_error ( `` JVM is not attached to this thread . Called in error_handler . `` ) ; - } + JNIEnv* env = JniUtils : :get_env ( ) ; env- > CallStaticVoidMethod ( sync_manager , sync_manager_notify_error_handler , error_code , Realm crashes on Android 2.3 device __EoT__ This issue is reported by @ takke on twitter ( http : //twitter.com/takke/status/798782520749801472 ) . # # # # Goal Works on Android 2.3.x devices . # # # # Expected Results no crash # # # # Actual Results When executing ` Realm.getDefaultInstance ( ) ` , the app crash with following dump in logcat . `` ` 01-06 10:32:12.689 I/DEBUG ( 747 ) : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** 01-06 10:32:12.689 I/DEBUG ( 747 ) : Build fingerprint : 'google/passion/passion:2.3.6/GRK39F/189904 : user/release-keys' 01-06 10:32:12.689 I/DEBUG ( 747 ) : pid : 845 , tid : 845 > > > jp.takke.realmandroid23issuesample < < < 01-06 10:32:12.689 I/DEBUG ( 747 ) : signal 11 ( SIGSEGV ) , code 1 ( SEGV_MAPERR ) , fault addr de5685a7 01-06 10:32:12.689 I/DEBUG ( 747 ) : r0 00000007 r1 00000001 r2 800a3d68 r3 00000000 01-06 10:32:12.689 I/DEBUG ( 747 ) : r4 0000ce60 r5 0000abe0 r6 de5685a7 r7 00000000 01-06 10:32:12.689 I/DEBUG ( 747 ) : r8 0000abe0 r9 4214cb28 10 0000abe0 fp 800a5368 01-06 10:32:12.689 I/DEBUG ( 747 ) : ip 800a56cc sp
diff -- git a/realm/src/androidTest/java/io/realm/DynamicRealmTest.java b/realm/src/androidTest/java/io/realm/DynamicRealmTest.java new file mode 100644 index 0000000..101d887 -- - /dev/null +++ b/realm/src/androidTest/java/io/realm/DynamicRealmTest.java @ @ -0,0 +1,78 @ @ +/* + * Copyright 2015 Realm Inc. + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + * + */ + +package io.realm ; + +import android.test.AndroidTestCase ; + +import io.realm.dynamic.DynamicRealm ; + +public class DynamicRealmTest extends AndroidTestCase { + + private Realm testRealm ; + + @ Override + protected void setUp ( ) throws Exception { + super.setUp ( ) ; + RealmConfiguration realmConfig = new RealmConfiguration.Builder Make Realm class to implement an interface __EoT__ Please could you make the Realm class to implement an interface with standard methods ? It is impossible to mock final singleton . So it is almost impossible to unit test anything using Realm . Thank you M .
diff -- git a/realm/src/androidTest/java/io/realm/RealmTest.java b/realm/src/androidTest/java/io/realm/RealmTest.java index 7526947..8c8917f 100644 -- - a/realm/src/androidTest/java/io/realm/RealmTest.java +++ b/realm/src/androidTest/java/io/realm/RealmTest.java @ @ -16,12 +16,9 @ @ package io.realm ; import android.content.Context ; -import android.os.SystemClock ; import android.test.AndroidTestCase ; -import android.util.Log ; import junit.framework.AssertionFailedError ; -import junit.framework.Test ; import org.json.JSONArray ; import org.json.JSONException ; @ @ -30,8 +27,6 @ @ import org.json.JSONObject ; import java.io.File ; import java.io.IOException ; import java.io.InputStream ; -import java.lang.ref.Reference ; -import java.lang.reflect.Field ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Date ; @ @ -44,7 +39,6 @ @ import java.util.concurrent.ExecutionException ; import java.util.concurrent.ExecutorService ; import java.util.concurrent.Executors ; import java.util.concurrent.Future ; -import java.util.concurrent.TimeUnit ; import io.realm.dynamic.DynamicRealmObject ; import io.realm.entities.AllTypes ; @ @ -63,7 +57,6 @ @ import io.realm.entities.PrimaryKeyMix ; import io.realm.entities.StringOnly ; import io.realm.exceptions.RealmException ; import io.realm.exceptions.RealmIOException ; -import io.realm.internal.SharedGroup ; import io.realm.internal.Table ; import static io.realm.internal.test.ExtraTests.assertArrayEquals ; @ @ -197,21 +190,21 @ @ public class RealmTest extends AndroidTestCase { final String REALM_NAME = `` test-internalhandlers '' ; RealmConfiguration realmConfig = TestHelper.createConfiguration ( getContext ( ) , REALM_NAME ) ; Realm.deleteRealm ( realmConfig ) ; - Realm.handlers.clear ( ) ; // Make sure that handlers from other unit tests does n't interfere . + Realm.getHandlers ( ) .clear ( ) ; // Make sure Make Realm class to implement an interface __EoT__ Please could you make the Realm class to implement an interface with standard methods ? It is impossible to mock final singleton . So it is almost impossible to unit test anything using Realm . Thank you M .
diff -- git a/realm/src/androidTest/java/io/realm/RealmTest.java b/realm/src/androidTest/java/io/realm/RealmTest.java index 976bbd3..1bc5e30 100644 -- - a/realm/src/androidTest/java/io/realm/RealmTest.java +++ b/realm/src/androidTest/java/io/realm/RealmTest.java @ @ -190,21 +190,21 @ @ public class RealmTest extends AndroidTestCase { final String REALM_NAME = `` test-internalhandlers '' ; RealmConfiguration realmConfig = TestHelper.createConfiguration ( getContext ( ) , REALM_NAME ) ; Realm.deleteRealm ( realmConfig ) ; - Realm.handlers.clear ( ) ; // Make sure that handlers from other unit tests does n't interfere . + Realm.getHandlers ( ) .clear ( ) ; // Make sure that handlers from other unit tests does n't interfere . // Open and close first instance of a Realm Realm realm = null ; try { realm = Realm.getInstance ( realmConfig ) ; - assertEquals ( 1 , Realm.handlers.size ( ) ) ; + assertEquals ( 1 , Realm.getHandlers ( ) .size ( ) ) ; realm.close ( ) ; // All Realms closed . No handlers should be alive . - assertEquals ( 0 , Realm.handlers.size ( ) ) ; + assertEquals ( 0 , Realm.getHandlers ( ) .size ( ) ) ; // Open instance the 2nd time . Old handler should now be gone realm = Realm.getInstance ( realmConfig ) ; - assertEquals ( 1 , Realm.handlers.size ( Make Realm class to implement an interface __EoT__ Please could you make the Realm class to implement an interface with standard methods ? It is impossible to mock final singleton . So it is almost impossible to unit test anything using Realm . Thank you M .
diff -- git a/.idea/codeStyleSettings.xml b/.idea/codeStyleSettings.xml deleted file mode 100644 index 163bd73..0000000 -- - a/.idea/codeStyleSettings.xml +++ /dev/null @ @ -1,218 +0,0 @ @ - < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > - < project version= '' 4 '' > - < component name= '' ProjectCodeStyleSettingsManager '' > - < option name= '' PER_PROJECT_SETTINGS '' > - < value > - < option name= '' CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 99 '' / > - < option name= '' NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND '' value= '' 99 '' / > - < option name= '' PACKAGES_TO_USE_IMPORT_ON_DEMAND '' > - < value / > - < /option > - < option name= '' IMPORT_LAYOUT_TABLE '' > - < value > - < package name= '' android '' withSubpackages= '' true '' static= '' false '' / > - < emptyLine / > - < package name= '' com '' withSubpackages= '' true '' static= '' false '' / > - < emptyLine / > - < package name= '' junit '' withSubpackages= '' true '' static= '' false '' / > - < emptyLine / > - < package name= '' net '' withSubpackages= '' true '' static= '' false '' Make Realm class to implement an interface __EoT__ Please could you make the Realm class to implement an interface with standard methods ? It is impossible to mock final singleton . So it is almost impossible to unit test anything using Realm . Thank you M .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Lists Of Primitives for Kotlin-types ( String , Int etc . ) __EoT__ # # # # Goal I want to use the new **Lists Of Primitives**-Feature with **Kotlin** . So it needs to support Kotlin-types as well ( e.g . ` kotlin.String ` instead of only ` java.lang.String ` ) . See https : //realm.io/docs/java/latest/ # lists-of-primitives Refs https : //github.com/realm/realm-java/pull/5031 # issuecomment-346624558 # # # # Expected Results A ` RealmList ` with a Kotlin-type should be possible . `` ` kotlin open class Foo ( var bar : RealmList < kotlin.String > ? = null ) : RealmObject ( ) `` ` # # # # Actual Results The compiler gives the following error : > Error : Element type of RealmList must be a class implementing 'RealmModel ' or one of the 'java.lang.String ' , 'byte [ ] ' , 'java.lang.Boolean ' , 'java.lang.Long ' , 'java.lang.Integer ' , 'java.lang.Short ' , 'java.lang.Byte ' , 'java.lang.Double ' , 'java.lang.Float ' , 'java.util.Date ' . Using ` RealmList < java.lang.String > ` produces the same error . # # # # Steps & Code to Reproduce Just create a new Kotlin-class with the code above and try
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Lists Of Primitives for Kotlin-types ( String , Int etc . ) __EoT__ # # # # Goal I want to use the new **Lists Of Primitives**-Feature with **Kotlin** . So it needs to support Kotlin-types as well ( e.g . ` kotlin.String ` instead of only ` java.lang.String ` ) . See https : //realm.io/docs/java/latest/ # lists-of-primitives Refs https : //github.com/realm/realm-java/pull/5031 # issuecomment-346624558 # # # # Expected Results A ` RealmList ` with a Kotlin-type should be possible . `` ` kotlin open class Foo ( var bar : RealmList < kotlin.String > ? = null ) : RealmObject ( ) `` ` # # # # Actual Results The compiler gives the following error : > Error : Element type of RealmList must be a class implementing 'RealmModel ' or one of the 'java.lang.String ' , 'byte [ ] ' , 'java.lang.Boolean ' , 'java.lang.Long ' , 'java.lang.Integer ' , 'java.lang.Short ' , 'java.lang.Byte ' , 'java.lang.Double ' , 'java.lang.Float ' , 'java.util.Date ' . Using ` RealmList < java.lang.String > ` produces the same error . # # # # Steps & Code to Reproduce Just create a new Kotlin-class with the code above and try
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Lists Of Primitives for Kotlin-types ( String , Int etc . ) __EoT__ # # # # Goal I want to use the new **Lists Of Primitives**-Feature with **Kotlin** . So it needs to support Kotlin-types as well ( e.g . ` kotlin.String ` instead of only ` java.lang.String ` ) . See https : //realm.io/docs/java/latest/ # lists-of-primitives Refs https : //github.com/realm/realm-java/pull/5031 # issuecomment-346624558 # # # # Expected Results A ` RealmList ` with a Kotlin-type should be possible . `` ` kotlin open class Foo ( var bar : RealmList < kotlin.String > ? = null ) : RealmObject ( ) `` ` # # # # Actual Results The compiler gives the following error : > Error : Element type of RealmList must be a class implementing 'RealmModel ' or one of the 'java.lang.String ' , 'byte [ ] ' , 'java.lang.Boolean ' , 'java.lang.Long ' , 'java.lang.Integer ' , 'java.lang.Short ' , 'java.lang.Byte ' , 'java.lang.Double ' , 'java.lang.Float ' , 'java.util.Date ' . Using ` RealmList < java.lang.String > ` produces the same error . # # # # Steps & Code to Reproduce Just create a new Kotlin-class with the code above and try
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Lists Of Primitives for Kotlin-types ( String , Int etc . ) __EoT__ # # # # Goal I want to use the new **Lists Of Primitives**-Feature with **Kotlin** . So it needs to support Kotlin-types as well ( e.g . ` kotlin.String ` instead of only ` java.lang.String ` ) . See https : //realm.io/docs/java/latest/ # lists-of-primitives Refs https : //github.com/realm/realm-java/pull/5031 # issuecomment-346624558 # # # # Expected Results A ` RealmList ` with a Kotlin-type should be possible . `` ` kotlin open class Foo ( var bar : RealmList < kotlin.String > ? = null ) : RealmObject ( ) `` ` # # # # Actual Results The compiler gives the following error : > Error : Element type of RealmList must be a class implementing 'RealmModel ' or one of the 'java.lang.String ' , 'byte [ ] ' , 'java.lang.Boolean ' , 'java.lang.Long ' , 'java.lang.Integer ' , 'java.lang.Short ' , 'java.lang.Byte ' , 'java.lang.Double ' , 'java.lang.Float ' , 'java.util.Date ' . Using ` RealmList < java.lang.String > ` produces the same error . # # # # Steps & Code to Reproduce Just create a new Kotlin-class with the code above and try
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Lists Of Primitives for Kotlin-types ( String , Int etc . ) __EoT__ # # # # Goal I want to use the new **Lists Of Primitives**-Feature with **Kotlin** . So it needs to support Kotlin-types as well ( e.g . ` kotlin.String ` instead of only ` java.lang.String ` ) . See https : //realm.io/docs/java/latest/ # lists-of-primitives Refs https : //github.com/realm/realm-java/pull/5031 # issuecomment-346624558 # # # # Expected Results A ` RealmList ` with a Kotlin-type should be possible . `` ` kotlin open class Foo ( var bar : RealmList < kotlin.String > ? = null ) : RealmObject ( ) `` ` # # # # Actual Results The compiler gives the following error : > Error : Element type of RealmList must be a class implementing 'RealmModel ' or one of the 'java.lang.String ' , 'byte [ ] ' , 'java.lang.Boolean ' , 'java.lang.Long ' , 'java.lang.Integer ' , 'java.lang.Short ' , 'java.lang.Byte ' , 'java.lang.Double ' , 'java.lang.Float ' , 'java.util.Date ' . Using ` RealmList < java.lang.String > ` produces the same error . # # # # Steps & Code to Reproduce Just create a new Kotlin-class with the code above and try
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Lists Of Primitives for Kotlin-types ( String , Int etc . ) __EoT__ # # # # Goal I want to use the new **Lists Of Primitives**-Feature with **Kotlin** . So it needs to support Kotlin-types as well ( e.g . ` kotlin.String ` instead of only ` java.lang.String ` ) . See https : //realm.io/docs/java/latest/ # lists-of-primitives Refs https : //github.com/realm/realm-java/pull/5031 # issuecomment-346624558 # # # # Expected Results A ` RealmList ` with a Kotlin-type should be possible . `` ` kotlin open class Foo ( var bar : RealmList < kotlin.String > ? = null ) : RealmObject ( ) `` ` # # # # Actual Results The compiler gives the following error : > Error : Element type of RealmList must be a class implementing 'RealmModel ' or one of the 'java.lang.String ' , 'byte [ ] ' , 'java.lang.Boolean ' , 'java.lang.Long ' , 'java.lang.Integer ' , 'java.lang.Short ' , 'java.lang.Byte ' , 'java.lang.Double ' , 'java.lang.Float ' , 'java.util.Date ' . Using ` RealmList < java.lang.String > ` produces the same error . # # # # Steps & Code to Reproduce Just create a new Kotlin-class with the code above and try
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Lists Of Primitives for Kotlin-types ( String , Int etc . ) __EoT__ # # # # Goal I want to use the new **Lists Of Primitives**-Feature with **Kotlin** . So it needs to support Kotlin-types as well ( e.g . ` kotlin.String ` instead of only ` java.lang.String ` ) . See https : //realm.io/docs/java/latest/ # lists-of-primitives Refs https : //github.com/realm/realm-java/pull/5031 # issuecomment-346624558 # # # # Expected Results A ` RealmList ` with a Kotlin-type should be possible . `` ` kotlin open class Foo ( var bar : RealmList < kotlin.String > ? = null ) : RealmObject ( ) `` ` # # # # Actual Results The compiler gives the following error : > Error : Element type of RealmList must be a class implementing 'RealmModel ' or one of the 'java.lang.String ' , 'byte [ ] ' , 'java.lang.Boolean ' , 'java.lang.Long ' , 'java.lang.Integer ' , 'java.lang.Short ' , 'java.lang.Byte ' , 'java.lang.Double ' , 'java.lang.Float ' , 'java.util.Date ' . Using ` RealmList < java.lang.String > ` produces the same error . # # # # Steps & Code to Reproduce Just create a new Kotlin-class with the code above and try
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Lists Of Primitives for Kotlin-types ( String , Int etc . ) __EoT__ # # # # Goal I want to use the new **Lists Of Primitives**-Feature with **Kotlin** . So it needs to support Kotlin-types as well ( e.g . ` kotlin.String ` instead of only ` java.lang.String ` ) . See https : //realm.io/docs/java/latest/ # lists-of-primitives Refs https : //github.com/realm/realm-java/pull/5031 # issuecomment-346624558 # # # # Expected Results A ` RealmList ` with a Kotlin-type should be possible . `` ` kotlin open class Foo ( var bar : RealmList < kotlin.String > ? = null ) : RealmObject ( ) `` ` # # # # Actual Results The compiler gives the following error : > Error : Element type of RealmList must be a class implementing 'RealmModel ' or one of the 'java.lang.String ' , 'byte [ ] ' , 'java.lang.Boolean ' , 'java.lang.Long ' , 'java.lang.Integer ' , 'java.lang.Short ' , 'java.lang.Byte ' , 'java.lang.Double ' , 'java.lang.Float ' , 'java.util.Date ' . Using ` RealmList < java.lang.String > ` produces the same error . # # # # Steps & Code to Reproduce Just create a new Kotlin-class with the code above and try
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Lists Of Primitives for Kotlin-types ( String , Int etc . ) __EoT__ # # # # Goal I want to use the new **Lists Of Primitives**-Feature with **Kotlin** . So it needs to support Kotlin-types as well ( e.g . ` kotlin.String ` instead of only ` java.lang.String ` ) . See https : //realm.io/docs/java/latest/ # lists-of-primitives Refs https : //github.com/realm/realm-java/pull/5031 # issuecomment-346624558 # # # # Expected Results A ` RealmList ` with a Kotlin-type should be possible . `` ` kotlin open class Foo ( var bar : RealmList < kotlin.String > ? = null ) : RealmObject ( ) `` ` # # # # Actual Results The compiler gives the following error : > Error : Element type of RealmList must be a class implementing 'RealmModel ' or one of the 'java.lang.String ' , 'byte [ ] ' , 'java.lang.Boolean ' , 'java.lang.Long ' , 'java.lang.Integer ' , 'java.lang.Short ' , 'java.lang.Byte ' , 'java.lang.Double ' , 'java.lang.Float ' , 'java.util.Date ' . Using ` RealmList < java.lang.String > ` produces the same error . # # # # Steps & Code to Reproduce Just create a new Kotlin-class with the code above and try
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 2fe5b41..2400e9e 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -7,6 +7,7 @ @ # # # Breaking Changes * ` RealmResults.distinct ( ) ` / ` RealmResults.distinctAsync ( ) ` have been removed . Use ` RealmQuery.distinct ( ) ` / ` RealmQuery.distinctAsync ( ) ` instead . +* ` RealmQuery.createQuery ( Realm , Class ) ` , ` RealmQuery.createDynamicQuery ( DynamicRealm , String ) ` , ` RealmQuery.createQueryFromResult ( RealmResults ) ` and ` RealmQuery.createQueryFromList ( RealmList ) ` have been removed . Use ` Realm.where ( Class ) ` , ` DynamicRealm.where ( String ) ` , RealmResults.where ( ) ` and ` RealmList.where ( ) ` instead . # # # Internal diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` Lists Of Primitives for Kotlin-types ( String , Int etc . ) __EoT__ # # # # Goal I want to use the new **Lists Of Primitives**-Feature with **Kotlin** . So it needs to support Kotlin-types as well ( e.g . ` kotlin.String ` instead of only ` java.lang.String ` ) . See https : //realm.io/docs/java/latest/ # lists-of-primitives Refs https : //github.com/realm/realm-java/pull/5031 # issuecomment-346624558 # # # # Expected Results A ` RealmList ` with a Kotlin-type should be possible . `` ` kotlin open class Foo ( var bar : RealmList < kotlin.String > ? = null ) : RealmObject ( ) `` ` # # # # Actual Results The compiler gives the following error : > Error : Element type of RealmList must be a class implementing 'RealmModel ' or one of the 'java.lang.String ' , 'byte [ ] ' , 'java.lang.Boolean ' , 'java.lang.Long ' , 'java.lang.Integer ' , 'java.lang.Short ' , 'java.lang.Byte ' , 'java.lang.Double ' , 'java.lang.Float ' , 'java.util.Date ' . Using ` RealmList < java.lang.String > ` produces the same error . # # # # Steps & Code to Reproduce Just create a new Kotlin-class with the code above and try
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 2fe5b41..2400e9e 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -7,6 +7,7 @ @ # # # Breaking Changes * ` RealmResults.distinct ( ) ` / ` RealmResults.distinctAsync ( ) ` have been removed . Use ` RealmQuery.distinct ( ) ` / ` RealmQuery.distinctAsync ( ) ` instead . +* ` RealmQuery.createQuery ( Realm , Class ) ` , ` RealmQuery.createDynamicQuery ( DynamicRealm , String ) ` , ` RealmQuery.createQueryFromResult ( RealmResults ) ` and ` RealmQuery.createQueryFromList ( RealmList ) ` have been removed . Use ` Realm.where ( Class ) ` , ` DynamicRealm.where ( String ) ` , RealmResults.where ( ) ` and ` RealmList.where ( ) ` instead . # # # Internal diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` Lists Of Primitives for Kotlin-types ( String , Int etc . ) __EoT__ # # # # Goal I want to use the new **Lists Of Primitives**-Feature with **Kotlin** . So it needs to support Kotlin-types as well ( e.g . ` kotlin.String ` instead of only ` java.lang.String ` ) . See https : //realm.io/docs/java/latest/ # lists-of-primitives Refs https : //github.com/realm/realm-java/pull/5031 # issuecomment-346624558 # # # # Expected Results A ` RealmList ` with a Kotlin-type should be possible . `` ` kotlin open class Foo ( var bar : RealmList < kotlin.String > ? = null ) : RealmObject ( ) `` ` # # # # Actual Results The compiler gives the following error : > Error : Element type of RealmList must be a class implementing 'RealmModel ' or one of the 'java.lang.String ' , 'byte [ ] ' , 'java.lang.Boolean ' , 'java.lang.Long ' , 'java.lang.Integer ' , 'java.lang.Short ' , 'java.lang.Byte ' , 'java.lang.Double ' , 'java.lang.Float ' , 'java.util.Date ' . Using ` RealmList < java.lang.String > ` produces the same error . # # # # Steps & Code to Reproduce Just create a new Kotlin-class with the code above and try
diff -- git a/examples/multiProcessAExample/.gitignore b/examples/multiProcessAExample/.gitignore new file mode 100644 index 0000000..796b96d -- - /dev/null +++ b/examples/multiProcessAExample/.gitignore @ @ -0,0 +1 @ @ +/build diff -- git a/examples/multiProcessAExample/build.gradle b/examples/multiProcessAExample/build.gradle new file mode 100644 index 0000000..5ec8e22 -- - /dev/null +++ b/examples/multiProcessAExample/build.gradle @ @ -0,0 +1,27 @ @ +apply plugin : 'android-sdk-manager' +apply plugin : 'com.android.application' +apply plugin : 'android-command' +apply plugin : 'realm' + +android { + compileSdkVersion rootProject.sdkVersion + buildToolsVersion rootProject.buildTools + + defaultConfig { + applicationId `` io.realm.examples.realmmultiprocessaexample '' + targetSdkVersion rootProject.sdkVersion + minSdkVersion 9 + versionCode 1 + versionName `` 1.0 '' + } + buildTypes { + release { + minifyEnabled false + proguardFiles getDefaultProguardFile ( 'proguard-android.txt ' ) , 'proguard-rules.pro' + } + } + } + +dependencies { + compile 'com.android.support : appcompat-v7:23.1.1' + } diff -- git a/examples/multiProcessAExample/proguard-rules.pro b/examples/multiProcessAExample/proguard-rules.pro new file mode 100644 index 0000000..8456b3d -- - /dev/null +++ b/examples/multiProcessAExample/proguard-rules.pro @ @ -0,0 +1,17 @ @ + # Add project specific ProGuard rules here . + # By default , the flags in this file are appended to flags specified + # in /home/cc/.android-sdk/tools/proguard/proguard-android.txt + # You can edit the include path and order by changing the proguardFiles + # directive in build.gradle . + Detect when adding a ChangeListener on an IntentService __EoT__ IntentServices are Looper Threads , which means that Realm currently allow you to register change listeners there . However since every invocation of ` onHandleIntent ` is a single event . Registering a change listener will not work , since the Realm should be closed when exiting ` onHandleIntent ` . We might be able to implement a heuristic that checks if the current thread is named ` IntentServicer [ XXX ] ` the same way we test for Looper threads now , and throw an exception in that case : https : //android.googlesource.com/platform/frameworks/base/+/master/core/java/android/app/IntentService.java # 108
diff -- git a/realm/realm-library/src/main/java/io/realm/internal/OsResults.java b/realm/realm-library/src/main/java/io/realm/internal/OsResults.java index 73e7e7e..045472c 100644 -- - a/realm/realm-library/src/main/java/io/realm/internal/OsResults.java +++ b/realm/realm-library/src/main/java/io/realm/internal/OsResults.java @ @ -199,7 +199,7 @ @ public class OsResults implements NativeObject , ObservableCollection { @ Override @ Deprecated public void set ( @ Nullable T object ) { - throw new UnsupportedOperationException ( `` Replacing and element is not supported . `` ) ; + throw new UnsupportedOperationException ( `` Replacing an element is not supported . `` ) ; } } 'and ' instead of 'an ' __EoT__ Hi , It seems to me there is a mistake in error message ` Replacing and element is not supported. ` This message appear in my release at io.realm.internal.Collection $ ListIterator.set ( Collection.java:257 ) `` ` public void set ( T object ) { throw new UnsupportedOperationException ( `` Replacing and element is not supported . `` ) ; } `` ` Best regards , Pierre
diff -- git a/CHANGELOG.md b/CHANGELOG.md index df4a908..3133d7f 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -5,6 +5,10 @ @ * Throws a better exception message when calling ` RealmObjectSchema.addField ( ) ` with a ` RealmModel ` class ( # 3388 ) . * Use https for Realm version checker ( # 4043 ) . + # # # Internal + +* Upgraded to Realm Sync 2.2.9 +* Upgraded to Realm Core 5.1.2 # # 4.3.1 ( 2017-12-06 ) diff -- git a/dependencies.list b/dependencies.list index 3703b72..e137ca9 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -1,9 +1,9 @ @ # Realm Sync Core release used by Realm Java # https : //github.com/realm/realm-sync/releases -REALM_SYNC_VERSION=2.1.8 -REALM_SYNC_SHA256=14e4aabe270638aa96f84396be27985b6809e532183035c5150dd2933d676248 +REALM_SYNC_VERSION=2.2.9 +REALM_SYNC_SHA256=d770d639d2b187c15e6d0bc798b909f5b424d61444f1f83f9e56f5be43e96afc # Object Server Release used by Integration tests . Installed using NPM . # Use ` npm view realm-object-server versions ` to get a list of available versions . -REALM_OBJECT_SERVER_DE_VERSION=2.1.0 +REALM_OBJECT_SERVER_DE_VERSION=2.5.1 diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_OsObject.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_OsObject.cpp index 3099c70..d7e8811 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_OsObject.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_OsObject.cpp @ @ -23,7 +23,7 @ @ # include < object_schema.hpp > # include < object.hpp > # include < shared_realm.hpp > - # include < util/format.hpp > + # include < realm/util/to_string.hpp > # include `` util.hpp '' # include `` Cascade Deletes or Deleting RealmList Items from RealmObject __EoT__ I have a case where I 'm calling a copyToRealmOrUpdate ( List < MyObject > ) and I have noticed that the RealmList that is a property on MyObject gets updated to the new list for MyObject but old objects get orphaned and not deleted . My guess is that there is no support for cascading deletes . Since they do n't have primary keys , I have no identifiable way to query them and remove them after the fact . What would be the best possible solution for this ? Would MyObject 's property need to also have MyObject 's primary key in order to query and delete those old orphaned objects ? I could try some sort of app processing to remove them before the copyToRealmOrUpdate but it seems really heavy and only grows as the number of MyObjects grows . Get a List < MyObject > For each MyObject , query for the stored Realm MyObject . Get RealmList from stored Realm MyObject Loop through RealmList object and removeFromRealm Thoughts ?
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 79f3595..3832c92 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -9,6 +9,8 @ @ - ` RealmIOExcpetion ` has been removed and replaced by ` RealmFileException ` . * Removed ` RealmConfiguration.Builder ( Context , File ) ` and ` RealmConfiguration.Builder ( File ) ` constructors . * ` RealmConfiguration.Builder.assetFile ( Context , String ) ` has been renamed to ` RealmConfiguration.Builder.assetFile ( String ) ` . +* ` Realm.createObject ( Class < E > ) ` and ` DynamicRealm.createObjec ( String ) ` throws a ` RealmException ` if they are called to create an object with a primary key defined . +* Importing from JSON without the primary key field defined in the JSON object now throws an exception . # # # Enhancements diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java index 68b2f11..592aec9 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/Constants.java @ @ -28,6 +28,8 @ @ public class Constants { public static final String DEFAULT_MODULE_CLASS_NAME = `` DefaultRealmModule '' ; static final String STATEMENT_EXCEPTION_ILLEGAL_NULL_VALUE = `` throw new IllegalArgumentException ( \ '' Trying to set non-nullable field ' % s ' to null.\ '' ) '' ; + static final String STATEMENT_EXCEPTION_NO_PRIMARY_KEY_IN_JSON = + `` throw Realm 1.2.0 : createAllFromJson fails on objects with @ PrimaryKey __EoT__ # # # # Goal > What do you want to achieve ? Use ` createAllFromJson ( ) ` # # # # Expected Results It should read the data . # # # # Actual Results FATAL EXCEPTION : IntentService [ LoadRealmDBIntentService ] io.realm.exceptions.RealmPrimaryKeyConstraintException : Value already exists : 0 at io.realm.internal.Table.throwDuplicatePrimaryKeyException ( Table.java:727 ) at io.realm.internal.Table.addEmptyRow ( Table.java:414 ) at io.realm.Realm.createObject ( Realm.java:681 ) at io.realm.IngredientsRealmProxy.createUsingJsonStream ( IngredientsRealmProxy.java:168 ) at io.realm.DefaultRealmModuleMediator.createUsingJsonStream ( DefaultRealmModuleMediator.java:754 ) at io.realm.Realm.createAllFromJson ( Realm.java:428 ) # # # # Version of Realm and tooling Realm version ( s ) : 1.2.0 Realm sync feature enabled : no Android Studio version : . Which Android version and device : .
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..d211177 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp index b15798d..e037db6 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp @ @ -32,6 +32,8 @ @ # include `` sync/sync_manager.hpp '' # endif + # include `` jni_util/hack.hpp '' + using namespace realm ; using namespace realm : :_impl ; @ @ -57,6 +59,8 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_SharedRealm_nativeInit ( JNIEnv* env { TR_ENTER ( ) + hack_init ( ) ; + try { JStringAccessor path ( env , temporary_directory_path ) ; // throws SharedGroupOptions : :set_sys_tmp_dir ( std : :string ( path ) ) ; // throws diff -- git a/realm/realm-library/src/main/cpp/jni_util/hack.cpp b/realm/realm-library/src/main/cpp/jni_util/hack.cpp new file mode 100644 index 0000000..d519183 -- - /dev/null +++ b/realm/realm-library/src/main/cpp/jni_util/hack.cpp @ @ Crash In Android 4.2.1 & Android 4.2.2 With Realm 3.0 __EoT__ please help me . I use realm 3.0. and collect crash in android 4.2.1 & android 4.2.2 ( level 17 ) . It looks like only crash in level 17 . # # This is crash log : main ( 1 ) SIGSEGV ( SEGV_ACCERR ) # 00 pc 00018b6c /system/lib/libc.so ( memcpy+1324 ) [ armeabi-v7a ] java : io.realm.internal.SharedRealm.long nativeGetTable ( long , java.lang.String ) ( Native Method ) io.realm.internal.SharedRealm.io.realm.internal.Table getTable ( java.lang.String ) ( ProGuard:271 ) io.realm.MasteryRealmBeanRealmProxy.io.realm.internal.Table initTable ( io.realm.internal.SharedRealm ) ( ProGuard:149 ) io.realm.PersonSchemaMediator.io.realm.internal.Table createTable ( java.lang.Class , io.realm.internal.SharedRealm ) ( ProGuard:58 ) io.realm.Realm.void initializeRealm ( io.realm.Realm ) ( ProGuard:347 ) io.realm.Realm.io.realm.Realm createAndValidate ( io.realm.RealmConfiguration , io.realm.internal.ColumnIndices [ ] ) ( ProGuard:314 ) io.realm.Realm.io.realm.Realm createInstance ( io.realm.RealmConfiguration , io.realm.internal.ColumnIndices [ ] ) ( ProGuard:265 ) io.realm.RealmCache.io.realm.BaseRealm createRealmOrGetFromCache ( io.realm.RealmConfiguration , java.lang.Class ) ( ProGuard:143 ) io.realm.Realm.io.realm.Realm getInstance ( io.realm.RealmConfiguration ) ( ProGuard:228 ) com.shensz.student.service.storage.StorageService.io.realm.Realm getPersonRealm ( ) ( ProGuard:120 ) # # This is my code : private static final String REALM_NAME_PREFIX = `` person . `` ; private static final String REALM = `` .realm '' ; private RealmConfiguration getPersonRealmConfiguration ( String uid ) {
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..387d290 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -126,7 +126,7 @ @ endif ( ) set ( WARNING_CXX_FLAGS `` -Werror -Wall -Wextra -pedantic -Wmissing-declarations \ -Wempty-body -Wparentheses -Wunknown-pragmas -Wunreachable-code \ -Wno-missing-field-initializers -Wno-maybe-uninitialized -Wno-uninitialized '' ) -set ( REALM_COMMON_CXX_FLAGS `` -DREALM_ANDROID -DREALM_HAVE_CONFIG -DPIC -pthread -fvisibility=hidden -std=c++14 -fsigned-char '' ) +set ( REALM_COMMON_CXX_FLAGS `` -DREALM_ANDROID -DREALM_HAVE_CONFIG -DPIC -pthread -fvisibility=hidden -std=c++14 -fsigned-char -fno-builtin-memcpy -fno-builtin-memmove '' ) if ( build_SYNC ) set ( REALM_COMMON_CXX_FLAGS `` $ { REALM_COMMON_CXX_FLAGS } -DREALM_ENABLE_SYNC=1 '' ) endif ( ) @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove -Wl , -- wrap , memcpy '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp index b15798d..e037db6 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp @ @ -32,6 +32,8 @ @ # include `` sync/sync_manager.hpp '' # endif + # include Crash In Android 4.2.1 & Android 4.2.2 With Realm 3.0 __EoT__ please help me . I use realm 3.0. and collect crash in android 4.2.1 & android 4.2.2 ( level 17 ) . It looks like only crash in level 17 . # # This is crash log : main ( 1 ) SIGSEGV ( SEGV_ACCERR ) # 00 pc 00018b6c /system/lib/libc.so ( memcpy+1324 ) [ armeabi-v7a ] java : io.realm.internal.SharedRealm.long nativeGetTable ( long , java.lang.String ) ( Native Method ) io.realm.internal.SharedRealm.io.realm.internal.Table getTable ( java.lang.String ) ( ProGuard:271 ) io.realm.MasteryRealmBeanRealmProxy.io.realm.internal.Table initTable ( io.realm.internal.SharedRealm ) ( ProGuard:149 ) io.realm.PersonSchemaMediator.io.realm.internal.Table createTable ( java.lang.Class , io.realm.internal.SharedRealm ) ( ProGuard:58 ) io.realm.Realm.void initializeRealm ( io.realm.Realm ) ( ProGuard:347 ) io.realm.Realm.io.realm.Realm createAndValidate ( io.realm.RealmConfiguration , io.realm.internal.ColumnIndices [ ] ) ( ProGuard:314 ) io.realm.Realm.io.realm.Realm createInstance ( io.realm.RealmConfiguration , io.realm.internal.ColumnIndices [ ] ) ( ProGuard:265 ) io.realm.RealmCache.io.realm.BaseRealm createRealmOrGetFromCache ( io.realm.RealmConfiguration , java.lang.Class ) ( ProGuard:143 ) io.realm.Realm.io.realm.Realm getInstance ( io.realm.RealmConfiguration ) ( ProGuard:228 ) com.shensz.student.service.storage.StorageService.io.realm.Realm getPersonRealm ( ) ( ProGuard:120 ) # # This is my code : private static final String REALM_NAME_PREFIX = `` person . `` ; private static final String REALM = `` .realm '' ; private RealmConfiguration getPersonRealmConfiguration ( String uid ) {
diff -- git a/realm/realm-jni/object-store/.gitignore b/realm/realm-jni/object-store/.gitignore new file mode 100644 index 0000000..3ea88b2 -- - /dev/null +++ b/realm/realm-jni/object-store/.gitignore @ @ -0,0 +1,14 @ @ + # CMake +.ninja_deps +.ninja_log +CMakeCache.txt +CMakeFiles/ +Makefile +build.ninja +cmake_install.cmake +rules.ninja + + # Build products +src/librealm-object-store.dylib +src/librealm-object-store-static.a +tests/tests diff -- git a/realm/realm-jni/object-store/.gitmodules b/realm/realm-jni/object-store/.gitmodules new file mode 100644 index 0000000..44b8f2a -- - /dev/null +++ b/realm/realm-jni/object-store/.gitmodules @ @ -0,0 +1,6 @ @ + [ submodule `` external/pegtl '' ] + path = external/pegtl + url = https : //github.com/ColinH/PEGTL + [ submodule `` external/catch '' ] + path = external/catch + url = https : //github.com/philsquared/Catch diff -- git a/realm/realm-jni/object-store/CMake/CodeCoverage.cmake b/realm/realm-jni/object-store/CMake/CodeCoverage.cmake new file mode 100644 index 0000000..b830828 -- - /dev/null +++ b/realm/realm-jni/object-store/CMake/CodeCoverage.cmake @ @ -0,0 +1,49 @ @ +find_program ( LCOV_PATH lcov ) +find_program ( GENHTML_PATH genhtml ) +find_program ( GCOVR_PATH gcovr PATHS $ { CMAKE_SOURCE_DIR } /tests ) + +set ( CMAKE_CXX_FLAGS_COVERAGE `` -g -O0 -fprofile-arcs -ftest-coverage '' + CACHE STRING `` Flags used by the C++ compiler during coverage builds . '' ) +mark_as_advanced ( CMAKE_CXX_FLAGS_COVERAGE ) + +if ( CMAKE_BUILD_TYPE STREQUAL `` Coverage '' ) + if ( NOT ( LCOV_PATH AND GENHTML_PATH AND GCOVR_PATH ) ) + message ( FATAL_ERROR `` Generating a coverage report Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/build.gradle b/build.gradle index cef0f4b..f605a25 100644 -- - a/build.gradle +++ b/build.gradle @ @ -196,7 +196,7 @ @ task distributionJniUnstrippedPackage ( type : Zip ) { archiveName = `` realm-java-jni-libs-unstripped- $ { currentVersion } .zip '' destinationDir = file ( `` $ { buildDir } /outputs/distribution '' ) - from ( `` realm/realm-jni/build/outputs/jniLibs-unstripped '' ) { + from ( `` realm/realm-library/build/outputs/jniLibs-unstripped '' ) { include '**/*.so' } } diff -- git a/realm/build.gradle b/realm/build.gradle index 44d2ab9..580dfbd 100644 -- - a/realm/build.gradle +++ b/realm/build.gradle @ @ -6,7 +6,7 @ @ buildscript { } dependencies { - classpath 'com.android.tools.build : gradle:2.1.0' + classpath 'com.android.tools.build : gradle:2.2.0-alpha3' classpath 'de.undercouch : gradle-download-task:2.0.0' classpath 'com.neenbedankt.gradle.plugins : android-apt:1.8' classpath 'com.github.dcendents : android-maven-gradle-plugin:1.3' diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 9565009..535021d 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -20,7 +20,7 @ @ ext.coreArchiveDir = System.getenv ( `` REALM_CORE_DOWNLOAD_DIR '' ) // To obtain the ABI of the connected device , execute `` adb shell getprop ro.product.cpu.abi '' ext.buildTargetAbis = project.hasProperty ( 'buildTargetABIs ' ) ? Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index 0029aae..7aee9b3 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +28,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ updates tools to at least Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index 80421d0..1cd1d11 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ updates tools to at least Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9153b3b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/Dockerfile b/Dockerfile index 0029aae..7aee9b3 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +28,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitmodules b/.gitmodules new file mode 100644 index 0000000..50b6ce8 -- - /dev/null +++ b/.gitmodules @ @ -0,0 +1,3 @ @ + [ submodule `` realm/realm-library/src/main/cpp/object-store '' ] + path = realm/realm-library/src/main/cpp/object-store + url = git @ github.com : realm/realm-object-store.git diff -- git a/realm/realm-library/build.gradle b/realm/realm-library/build.gradle index 502601c..2e122d0 100644 -- - a/realm/realm-library/build.gradle +++ b/realm/realm-library/build.gradle @ @ -48,7 +48,8 @ @ android { // JNI build currently ( lack of lto linking support ) . // This file should be removed and use the one from Android SDK cmake package when it supports lto . `` -DCMAKE_TOOLCHAIN_FILE= $ { project.file ( 'src/main/cpp/android.toolchain.cmake ' ) .path } '' - abiFilters 'x86 ' , 'x86_64 ' , 'armeabi ' , 'armeabi-v7a ' , 'arm64-v8a ' , 'mips' + // armeabi is not supported anymore . + abiFilters 'x86 ' , 'x86_64 ' , 'armeabi-v7a ' , 'arm64-v8a ' , 'mips' } } } diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 23ee4bf..c0ca1a6 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -62,9 +62,9 @ @ set_target_properties ( lib_realm_core PROPERTIES IMPORTED_LOCATION $ { core_lib_PAT # build application 's shared lib include_directories ( $ { REALM_CORE_DIST_DIR } /include $ { CMAKE_SOURCE_DIR } - $ { CMAKE_SOURCE_DIR } /jni_include Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitmodules b/.gitmodules new file mode 100644 index 0000000..50b6ce8 -- - /dev/null +++ b/.gitmodules @ @ -0,0 +1,3 @ @ + [ submodule `` realm/realm-library/src/main/cpp/object-store '' ] + path = realm/realm-library/src/main/cpp/object-store + url = git @ github.com : realm/realm-object-store.git diff -- git a/realm/config/findbugs/findbugs-filter.xml b/realm/config/findbugs/findbugs-filter.xml index 37ab1ae..b6503d5 100644 -- - a/realm/config/findbugs/findbugs-filter.xml +++ b/realm/config/findbugs/findbugs-filter.xml @ @ -8,21 +8,6 @ @ < Class name= '' ~.*\.Manifest\ $ . * '' / > < /Match > < Match > - < Class name= '' io.realm.internal.ImplicitTransaction '' / > - < Method name= '' finalize '' / > - < Bug pattern= '' FI_NULLIFY_SUPER '' / > - < /Match > - < Match > - < Class name= '' io.realm.internal.ReadTransaction '' / > - < Method name= '' finalize '' / > - < Bug pattern= '' FI_NULLIFY_SUPER '' / > - < /Match > - < Match > - < Class name= '' io.realm.internal.WriteTransaction '' / > - < Method name= '' finalize '' / > - < Bug pattern= '' FI_NULLIFY_SUPER '' / > - < /Match > - < Match > < Class name= '' io.realm.Realm '' / > < Method name= '' checkHasPrimaryKey '' / > < Bug Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 9565009..535021d 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -20,7 +20,7 @ @ ext.coreArchiveDir = System.getenv ( `` REALM_CORE_DOWNLOAD_DIR '' ) // To obtain the ABI of the connected device , execute `` adb shell getprop ro.product.cpu.abi '' ext.buildTargetAbis = project.hasProperty ( 'buildTargetABIs ' ) ? project.getProperty ( 'buildTargetABIs ' ) .split ( ' , ' ) .collect { it.trim ( ) } : null -def commonCflags = [ '-Os ' , '-std=c++11 ' ] +def commonCflags = [ '-Os ' , '-std=c++14 ' ] // LTO and debugging do n't play well together if ( ! ext.debugBuild ) { commonCflags += [ '-fvisibility=hidden ' , '-ffunction-sections ' , '-fdata-sections ' , '-flto ' ] @ @ -75,7 +75,8 @ @ def toolchains = [ ] def allTargets = [ - new Target ( name : 'arm ' , abi : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , + // gcc for armeabi has problem to compile std : :excpetion_ptr . Disable this ABI for now . We might drop it or use the new NDK clang to compile it Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/build.gradle b/build.gradle index cef0f4b..f605a25 100644 -- - a/build.gradle +++ b/build.gradle @ @ -196,7 +196,7 @ @ task distributionJniUnstrippedPackage ( type : Zip ) { archiveName = `` realm-java-jni-libs-unstripped- $ { currentVersion } .zip '' destinationDir = file ( `` $ { buildDir } /outputs/distribution '' ) - from ( `` realm/realm-jni/build/outputs/jniLibs-unstripped '' ) { + from ( `` realm/realm-library/build/outputs/jniLibs-unstripped '' ) { include '**/*.so' } } diff -- git a/realm/build.gradle b/realm/build.gradle index 44d2ab9..580dfbd 100644 -- - a/realm/build.gradle +++ b/realm/build.gradle @ @ -6,7 +6,7 @ @ buildscript { } dependencies { - classpath 'com.android.tools.build : gradle:2.1.0' + classpath 'com.android.tools.build : gradle:2.2.0-alpha3' classpath 'de.undercouch : gradle-download-task:2.0.0' classpath 'com.neenbedankt.gradle.plugins : android-apt:1.8' classpath 'com.github.dcendents : android-maven-gradle-plugin:1.3' diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 9565009..535021d 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -20,7 +20,7 @ @ ext.coreArchiveDir = System.getenv ( `` REALM_CORE_DOWNLOAD_DIR '' ) // To obtain the ABI of the connected device , execute `` adb shell getprop ro.product.cpu.abi '' ext.buildTargetAbis = project.hasProperty ( 'buildTargetABIs ' ) ? Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/build.gradle b/build.gradle index cef0f4b..f605a25 100644 -- - a/build.gradle +++ b/build.gradle @ @ -196,7 +196,7 @ @ task distributionJniUnstrippedPackage ( type : Zip ) { archiveName = `` realm-java-jni-libs-unstripped- $ { currentVersion } .zip '' destinationDir = file ( `` $ { buildDir } /outputs/distribution '' ) - from ( `` realm/realm-jni/build/outputs/jniLibs-unstripped '' ) { + from ( `` realm/realm-library/build/outputs/jniLibs-unstripped '' ) { include '**/*.so' } } diff -- git a/realm/build.gradle b/realm/build.gradle index 44d2ab9..580dfbd 100644 -- - a/realm/build.gradle +++ b/realm/build.gradle @ @ -6,7 +6,7 @ @ buildscript { } dependencies { - classpath 'com.android.tools.build : gradle:2.1.0' + classpath 'com.android.tools.build : gradle:2.2.0-alpha3' classpath 'de.undercouch : gradle-download-task:2.0.0' classpath 'com.neenbedankt.gradle.plugins : android-apt:1.8' classpath 'com.github.dcendents : android-maven-gradle-plugin:1.3' diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 9565009..535021d 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -20,7 +20,7 @ @ ext.coreArchiveDir = System.getenv ( `` REALM_CORE_DOWNLOAD_DIR '' ) // To obtain the ABI of the connected device , execute `` adb shell getprop ro.product.cpu.abi '' ext.buildTargetAbis = project.hasProperty ( 'buildTargetABIs ' ) ? Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index 80421d0..1cd1d11 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ updates tools to at least Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index 80421d0..1cd1d11 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ updates tools to at least Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index 80421d0..1cd1d11 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ updates tools to at least Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9153b3b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/.gitmodules b/.gitmodules new file mode 100644 index 0000000..50b6ce8 -- - /dev/null +++ b/.gitmodules @ @ -0,0 +1,3 @ @ + [ submodule `` realm/realm-library/src/main/cpp/object-store '' ] + path = realm/realm-library/src/main/cpp/object-store + url = git @ github.com : realm/realm-object-store.git diff -- git a/Dockerfile b/Dockerfile index 0029aae..7aee9b3 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +28,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java index 816f4fb..03e4e15 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java @ @ -244,38 +244,6 @ @ public class RealmTests { } @ Test - @ UiThreadTest - public void internalRealmChangedHandlersRemoved ( ) { - realm.close ( ) ; // Clear handler created by testRealm in setUp ( ) - assertEquals ( 0 , Realm.getHandlers ( ) .size ( ) ) ; - final String REALM_NAME = `` test-internalhandlers '' ; - RealmConfiguration realmConfig = configFactory.createConfiguration ( REALM_NAME ) ; - Realm.deleteRealm ( realmConfig ) ; - - // Open and close first instance of a Realm - Realm realm = null ; - try { - realm = Realm.getInstance ( realmConfig ) ; - assertFalse ( this.realm == realm ) ; - assertEquals ( 1 , Realm.getHandlers ( ) .size ( ) ) ; - realm.close ( ) ; - - // All Realms closed . No handlers should be alive . - assertEquals ( 0 , Realm.getHandlers ( ) .size ( ) ) ; - - // Open instance the 2nd time . Old handler should now be gone - realm = Realm.getInstance ( realmConfig ) ; - assertEquals ( 1 , Realm.getHandlers ( ) .size Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.github/ISSUE_TEMPLATE/bug_report.md b/.github/ISSUE_TEMPLATE/bug_report.md deleted file mode 100644 index b81b119..0000000 -- - a/.github/ISSUE_TEMPLATE/bug_report.md +++ /dev/null @ @ -1,30 +0,0 @ @ -- -- -name : Bug report -about : You think you have found a bug ! - -- -- - - # # # # Goal - < ! -- What do you want to achieve ? -- > - - # # # # Actual Results - < ! -- What happened ? If an exception was thrown please copy/paste the stack trace from Logcat . -- > - - # # # # Steps & Code to Reproduce - < ! -- What steps resulted in the crash ? Please show any relevant code or steps that can be used to -- > - < ! -- reproduce it , including any Realm model classes used . Even better is a full sample project -- > - < ! -- that can reproduce the crash . Code can be shared privately at help @ realm.io if needed . -- > - - # # # # Version of Realm and tooling - -Realm version ( s ) : ? - -Realm Sync feature enabled : Yes/No Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/build.gradle b/build.gradle index a5770bd..fd4ce60 100644 -- - a/build.gradle +++ b/build.gradle @ @ -205,7 +205,7 @ @ task distributionJniUnstrippedPackage ( type : Zip ) { archiveName = `` realm-java-jni-libs-unstripped- $ { currentVersion } .zip '' destinationDir = file ( `` $ { buildDir } /outputs/distribution '' ) - from ( `` realm/realm-jni/build/outputs/jniLibs-unstripped '' ) { + from ( `` realm/realm-library/build/outputs/jniLibs-unstripped '' ) { include '**/*.so' } } diff -- git a/realm/build.gradle b/realm/build.gradle index 44d2ab9..580dfbd 100644 -- - a/realm/build.gradle +++ b/realm/build.gradle @ @ -6,7 +6,7 @ @ buildscript { } dependencies { - classpath 'com.android.tools.build : gradle:2.1.0' + classpath 'com.android.tools.build : gradle:2.2.0-alpha3' classpath 'de.undercouch : gradle-download-task:2.0.0' classpath 'com.neenbedankt.gradle.plugins : android-apt:1.8' classpath 'com.github.dcendents : android-maven-gradle-plugin:1.3' diff -- git a/realm/config/findbugs/findbugs-filter.xml b/realm/config/findbugs/findbugs-filter.xml index 37ab1ae..c774f7d 100644 -- - a/realm/config/findbugs/findbugs-filter.xml +++ b/realm/config/findbugs/findbugs-filter.xml @ @ -8,21 +8,6 @ @ < Class name= '' ~.*\.Manifest\ $ . * '' / > < /Match > < Match > - < Class name= '' io.realm.internal.ImplicitTransaction '' / > - < Method name= '' finalize '' Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/build.gradle b/build.gradle index a5770bd..fd4ce60 100644 -- - a/build.gradle +++ b/build.gradle @ @ -205,7 +205,7 @ @ task distributionJniUnstrippedPackage ( type : Zip ) { archiveName = `` realm-java-jni-libs-unstripped- $ { currentVersion } .zip '' destinationDir = file ( `` $ { buildDir } /outputs/distribution '' ) - from ( `` realm/realm-jni/build/outputs/jniLibs-unstripped '' ) { + from ( `` realm/realm-library/build/outputs/jniLibs-unstripped '' ) { include '**/*.so' } } diff -- git a/realm/build.gradle b/realm/build.gradle index 44d2ab9..580dfbd 100644 -- - a/realm/build.gradle +++ b/realm/build.gradle @ @ -6,7 +6,7 @ @ buildscript { } dependencies { - classpath 'com.android.tools.build : gradle:2.1.0' + classpath 'com.android.tools.build : gradle:2.2.0-alpha3' classpath 'de.undercouch : gradle-download-task:2.0.0' classpath 'com.neenbedankt.gradle.plugins : android-apt:1.8' classpath 'com.github.dcendents : android-maven-gradle-plugin:1.3' diff -- git a/realm/config/findbugs/findbugs-filter.xml b/realm/config/findbugs/findbugs-filter.xml index 37ab1ae..c774f7d 100644 -- - a/realm/config/findbugs/findbugs-filter.xml +++ b/realm/config/findbugs/findbugs-filter.xml @ @ -8,21 +8,6 @ @ < Class name= '' ~.*\.Manifest\ $ . * '' / > < /Match > < Match > - < Class name= '' io.realm.internal.ImplicitTransaction '' / > - < Method name= '' finalize '' Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9153b3b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/.gitmodules b/.gitmodules new file mode 100644 index 0000000..50b6ce8 -- - /dev/null +++ b/.gitmodules @ @ -0,0 +1,3 @ @ + [ submodule `` realm/realm-library/src/main/cpp/object-store '' ] + path = realm/realm-library/src/main/cpp/object-store + url = git @ github.com : realm/realm-object-store.git diff -- git a/Dockerfile b/Dockerfile index 0029aae..7aee9b3 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +28,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index e13bbc4..94fed80 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -373,6 +373,23 @ @ public class ClassMetaData { return nullableFields.contains ( variableElement ) ; } + /** + * Checks if a VariableElement is indexed . + * + * @ param variableElement the element/field + * @ return { @ code true } if a VariableElement is indexed , { @ code false } otherwise . + */ + public boolean isIndexed ( VariableElement variableElement ) { + return indexedFields.contains ( variableElement ) ; + } + + public boolean isPrimaryKey ( VariableElement variableElement ) { + if ( primaryKey == null ) { + return false ; + } + return primaryKey.equals ( variableElement ) ; + } + private boolean isValidPrimaryKeyType ( TypeMirror type ) { for ( TypeMirror validType : validPrimaryKeyTypes ) { if ( typeUtils.isAssignable ( type , validType ) ) { diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 8d1e445..cb6b49c 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -107,6 +107,7 @ @ public class RealmProxyClassGenerator { emitConstructor ( writer ) ; emitAccessors ( writer ) ; emitInitTableMethod ( writer ) ; + emitCreateRealmObjectSchemaMethod ( writer ) ; emitValidateTableMethod ( writer ) Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index e13bbc4..94fed80 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -373,6 +373,23 @ @ public class ClassMetaData { return nullableFields.contains ( variableElement ) ; } + /** + * Checks if a VariableElement is indexed . + * + * @ param variableElement the element/field + * @ return { @ code true } if a VariableElement is indexed , { @ code false } otherwise . + */ + public boolean isIndexed ( VariableElement variableElement ) { + return indexedFields.contains ( variableElement ) ; + } + + public boolean isPrimaryKey ( VariableElement variableElement ) { + if ( primaryKey == null ) { + return false ; + } + return primaryKey.equals ( variableElement ) ; + } + private boolean isValidPrimaryKeyType ( TypeMirror type ) { for ( TypeMirror validType : validPrimaryKeyTypes ) { if ( typeUtils.isAssignable ( type , validType ) ) { diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 8d1e445..394a243 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -107,6 +107,7 @ @ public class RealmProxyClassGenerator { emitConstructor ( writer ) ; emitAccessors ( writer ) ; emitInitTableMethod ( writer ) ; + emitCreateRealmObjectSchemaMethod ( writer ) ; emitValidateTableMethod ( writer ) Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index e13bbc4..94fed80 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -373,6 +373,23 @ @ public class ClassMetaData { return nullableFields.contains ( variableElement ) ; } + /** + * Checks if a VariableElement is indexed . + * + * @ param variableElement the element/field + * @ return { @ code true } if a VariableElement is indexed , { @ code false } otherwise . + */ + public boolean isIndexed ( VariableElement variableElement ) { + return indexedFields.contains ( variableElement ) ; + } + + public boolean isPrimaryKey ( VariableElement variableElement ) { + if ( primaryKey == null ) { + return false ; + } + return primaryKey.equals ( variableElement ) ; + } + private boolean isValidPrimaryKeyType ( TypeMirror type ) { for ( TypeMirror validType : validPrimaryKeyTypes ) { if ( typeUtils.isAssignable ( type , validType ) ) { diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 8d1e445..394a243 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -107,6 +107,7 @ @ public class RealmProxyClassGenerator { emitConstructor ( writer ) ; emitAccessors ( writer ) ; emitInitTableMethod ( writer ) ; + emitCreateRealmObjectSchemaMethod ( writer ) ; emitValidateTableMethod ( writer ) Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index 80421d0..1cd1d11 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ updates tools to at least Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9153b3b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/Dockerfile b/Dockerfile index 0029aae..c792350 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -9,7 +9,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' # Set the environment variables ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux -ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/.gitignore b/.gitignore index a72b66b..9153b3b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/Dockerfile b/Dockerfile index 0029aae..c792350 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -9,7 +9,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' # Set the environment variables ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux -ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed Integrate Object Store __EoT__ - [ x ] Base PR for making build work . See # 3102 - Enable cmake with our build system . - Enable cmake on CI . - Use git ~~subtree~~ submodule to integrate OS repo . - Use clang to compile since gcc 4.9 has problems with OS compiling . - Removing ` realm-jni ` wo n't be part of this to avoid conflicts . They can be remove after this merged to master . - [ x ] Integrate SharedRealm from OS . See # 3031 - Replace ` SharedGroup ` / ` Group ` by ` SharedRealm ` . - More details see # 3031 . - [ ] Integrate ` Property ` / ` Schema ` / ` ObjectSchema ` . ( # 3066 ) - [ x ] Integrate OS notification ( # 3370 ) - [ x ] Integrate ` Results ` for the future fine grained notification . ( # 3834 ) - [ x ] Clean up finalizers ? It is a good time to start it right now . ( # 3144 ) Reviewing and merging # 3102 is the basis of the integration .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 176394b..e6a2720 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -6,6 +6,7 @ @ * [ ObjectServer ] Added support for ` SyncUser.isAdmin ( ) ` ( # 4353 ) . * [ ObjectServer ] Added support for changing passwords through ` SyncUser.changePassword ( ) ` ( # 4423 ) . +* [ ObjectServer ] Added support for ` SyncConfigration.Builder.waitForServerChanges ( ) ` ( # 4270 ) . * Transient fields are now allowed in model classes , but are implicitly treated as having the ` @ Ignore ` annotation ( # 4279 ) . * Added ` Realm.refresh ( ) ` and ` DynamicRealm.refresh ( ) ` ( # 3476 ) . * Added ` Realm.getInstanceAsync ( ) ` and ` DynamicRealm.getInstanceAsync ( ) ` ( # 2299 ) . diff -- git a/realm/realm-library/src/androidTest/java/io/realm/internal/RealmNotifierTests.java b/realm/realm-library/src/androidTest/java/io/realm/internal/RealmNotifierTests.java index 0516f0e..ace2f24 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/internal/RealmNotifierTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/internal/RealmNotifierTests.java @ @ -54,6 +54,11 @ @ public class RealmNotifierTests { @ Override public void checkCanDeliverNotification ( String exceptionMessage ) { } + + @ Override + public boolean isMainThread ( ) { + return false ; + } } ; @ Before diff -- git a/realm/realm-library/src/main/cpp/io_realm_SyncSession.cpp b/realm/realm-library/src/main/cpp/io_realm_SyncSession.cpp index e3a58bb..f8f28bb 100644 -- Realm.getInstanceAsync ( ) __EoT__ **Edit by CM** : Changing the focus slightly of this issue . Discussions around exposing info and callbacks for custom migrations have been moved to # 4083 -- - As described in # 4270 we need to expose a ` Realm.getInstanceAsync ( config ) ` in order to allow synced Realms to be downloaded first . **Usage** `` ` java // Create configuration RealmConfiguration config = new RealmConfiguration.Builder ( ) .migration ( new MyMigration ( ) ) .schemaVersion ( 42 ) .build ( ) ; // Get instance on a Looper thread Realm.getInstanceAsync ( config , new Realm.Callback ( ) { public void OnSuccess ( Realm realm ) { // Use Realm } // Do we really want to force both onSuccess and onError ? // Perhaps make Realm.Callback abstract and provide default impl for this ? // Should we instead provide ` getInstanceAsync ( config , onSuccess , onError ) ` ? public void onError ( Exception e ) { // Something went wrong ? Migration failed , problems opening file ? } } ) `` ` **TODO** This issue is therefore now about the following : - [ x ] Add new API `
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 0ed3af7..d2b1dcc 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -6,6 +6,7 @ @ * [ ObjectServer ] Added support for ` SyncUser.isAdmin ( ) ` ( # 4353 ) . * [ ObjectServer ] Added support for changing passwords through ` SyncUser.changePassword ( ) ` ( # 4423 ) . +* [ ObjectServer ] Added support for ` SyncConfigration.Builder.waitForInitialRemoteData ( ) ` ( # 4270 ) . * Transient fields are now allowed in model classes , but are implicitly treated as having the ` @ Ignore ` annotation ( # 4279 ) . * Added ` Realm.refresh ( ) ` and ` DynamicRealm.refresh ( ) ` ( # 3476 ) . * Added ` Realm.getInstanceAsync ( ) ` and ` DynamicRealm.getInstanceAsync ( ) ` ( # 2299 ) . diff -- git a/realm/realm-library/src/androidTest/java/io/realm/internal/RealmNotifierTests.java b/realm/realm-library/src/androidTest/java/io/realm/internal/RealmNotifierTests.java index 0516f0e..ace2f24 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/internal/RealmNotifierTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/internal/RealmNotifierTests.java @ @ -54,6 +54,11 @ @ public class RealmNotifierTests { @ Override public void checkCanDeliverNotification ( String exceptionMessage ) { } + + @ Override + public boolean isMainThread ( ) { + return false ; + } } ; @ Before diff -- git a/realm/realm-library/src/main/cpp/io_realm_SyncSession.cpp b/realm/realm-library/src/main/cpp/io_realm_SyncSession.cpp index e3a58bb..8165ea5 100644 -- Realm.getInstanceAsync ( ) __EoT__ **Edit by CM** : Changing the focus slightly of this issue . Discussions around exposing info and callbacks for custom migrations have been moved to # 4083 -- - As described in # 4270 we need to expose a ` Realm.getInstanceAsync ( config ) ` in order to allow synced Realms to be downloaded first . **Usage** `` ` java // Create configuration RealmConfiguration config = new RealmConfiguration.Builder ( ) .migration ( new MyMigration ( ) ) .schemaVersion ( 42 ) .build ( ) ; // Get instance on a Looper thread Realm.getInstanceAsync ( config , new Realm.Callback ( ) { public void OnSuccess ( Realm realm ) { // Use Realm } // Do we really want to force both onSuccess and onError ? // Perhaps make Realm.Callback abstract and provide default impl for this ? // Should we instead provide ` getInstanceAsync ( config , onSuccess , onError ) ` ? public void onError ( Exception e ) { // Something went wrong ? Migration failed , problems opening file ? } } ) `` ` **TODO** This issue is therefore now about the following : - [ x ] Add new API `
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 90ee485..c4e34bf 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -8,6 +8,7 @ @ * `` operation not permitted '' issue when creating Realm file on some devices ' external storage ( # 3629 ) . * Crash on API 10 devices ( # 3726 ) . +* Realm migration is triggered , when the primary key definition is altered ( # 3966 ) . # # # Enhancements diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index a29b69d..87c76ca 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -668,6 +668,25 @ @ public class RealmProxyClassGenerator { writer.emitStatement ( `` final % 1 $ s columnInfo = new % 1 $ s ( sharedRealm.getPath ( ) , table ) '' , columnInfoClassName ( ) ) ; writer.emitEmptyLine ( ) ; + // verify primary key definition was not altered + if ( metadata.hasPrimaryKey ( ) ) { + // the current model defines a PK , make sure it 's defined in the Realm schema + String fieldName = metadata.getPrimaryKey ( ) .getSimpleName ( ) .toString ( ) ; + writer.beginControlFlow ( `` if ( ! table.hasPrimaryKey ( ) ) '' ) + .emitStatement ( `` throw new RealmMigrationNeededException ( Realm 1.2.0 : removing @ PrimaryKey constraint does not trigger RealmMigrationNeededException __EoT__ I like the whole issue template thing , but this one really does n't need one . ` deleteIfMigrationNeeded ( ) ` did not delete Realm after removing ` @ PrimaryKey ` annotation . # # # # Version of Realm and tooling Realm version ( s ) : 1.2.0 Realm sync feature enabled : no Android Studio version : . Which Android version and device : .
diff -- git a/realm/src/androidTest/java/io/realm/RealmTest.java b/realm/src/androidTest/java/io/realm/RealmTest.java index 8b9fd14..680f8b9 100644 -- - a/realm/src/androidTest/java/io/realm/RealmTest.java +++ b/realm/src/androidTest/java/io/realm/RealmTest.java @ @ -62,6 +62,7 @ @ import io.realm.entities.PrimaryKeyMix ; import io.realm.entities.StringOnly ; import io.realm.exceptions.RealmException ; import io.realm.exceptions.RealmIOException ; +import io.realm.internal.RealmFileWrapper ; import io.realm.internal.SharedGroup ; import io.realm.internal.Table ; @ @ -1686,21 +1687,21 @ @ public class RealmTest extends AndroidTestCase { // Check that FinalizerRunnable can free native resources ( phantom refs ) public void testReferenceCleaning ( ) throws NoSuchFieldException , IllegalAccessException { - Field sharedGroupReference = Realm.class.getDeclaredField ( `` sharedGroup '' ) ; - sharedGroupReference.setAccessible ( true ) ; - SharedGroup sharedGroup = ( SharedGroup ) sharedGroupReference.get ( testRealm ) ; - assertNotNull ( sharedGroup ) ; + Field realmFileReference = Realm.class.getDeclaredField ( `` realmFile '' ) ; + realmFileReference.setAccessible ( true ) ; + RealmFileWrapper realmFile = ( RealmFileWrapper ) realmFileReference.get ( testRealm ) ; + assertNotNull ( realmFile ) ; Field contextField = SharedGroup.class.getDeclaredField ( `` context '' ) ; contextField.setAccessible ( true ) ; - io.realm.internal.Context context = ( io.realm.internal.Context ) contextField.get ( sharedGroup ) ; + io.realm.internal.Context context = ( io.realm.internal.Context ) contextField.get ( realmFile.sharedGroup ) ; assertNotNull ( context ) ; Field rowReferencesField = io.realm.internal.Context.class.getDeclaredField ( `` rowReferences '' ) ; rowReferencesField.setAccessible ( missing field type getter of DynamicRealmObject __EoT__ In order to access model object by generic way , we have to know the type of each field . I 'd like to write as follows . `` ` DynamicRealmObject obj = ... ; for ( String fieldName : obj.getFieldNames ( ) ) { switch ( obj.getFieldType ( fieldName ) ) { // getFieldType ( String ) is missing case BOOLEAN : boolean b = obj.getBoolean ( fieldName ) ; // do something break ; case STRING : String str = obj.getString ( fieldName ) ; // do something break ; ... } } `` `
diff -- git a/realm/src/androidTest/java/io/realm/RealmTest.java b/realm/src/androidTest/java/io/realm/RealmTest.java index 8b9fd14..50348ff 100644 -- - a/realm/src/androidTest/java/io/realm/RealmTest.java +++ b/realm/src/androidTest/java/io/realm/RealmTest.java @ @ -62,6 +62,8 @ @ import io.realm.entities.PrimaryKeyMix ; import io.realm.entities.StringOnly ; import io.realm.exceptions.RealmException ; import io.realm.exceptions.RealmIOException ; +import io.realm.internal.SharedGroupManager ; +import io.realm.internal.RealmBase ; import io.realm.internal.SharedGroup ; import io.realm.internal.Table ; @ @ -1686,43 +1688,56 @ @ public class RealmTest extends AndroidTestCase { // Check that FinalizerRunnable can free native resources ( phantom refs ) public void testReferenceCleaning ( ) throws NoSuchFieldException , IllegalAccessException { - Field sharedGroupReference = Realm.class.getDeclaredField ( `` sharedGroup '' ) ; - sharedGroupReference.setAccessible ( true ) ; - SharedGroup sharedGroup = ( SharedGroup ) sharedGroupReference.get ( testRealm ) ; - assertNotNull ( sharedGroup ) ; + RealmConfiguration config = new RealmConfiguration.Builder ( getContext ( ) ) .name ( `` myown '' ) .build ( ) ; + Realm.deleteRealm ( config ) ; + testRealm = Realm.getInstance ( config ) ; + + // Manipulate field accessibility to facilitate testing + Field realmFileReference = RealmBase.class.getDeclaredField ( `` sharedGroup '' ) ; + realmFileReference.setAccessible ( true ) ; Field contextField = SharedGroup.class.getDeclaredField ( `` context '' ) ; contextField.setAccessible ( true ) ; + Field rowReferencesField = io.realm.internal.Context.class.getDeclaredField ( `` rowReferences '' ) ; + missing field type getter of DynamicRealmObject __EoT__ In order to access model object by generic way , we have to know the type of each field . I 'd like to write as follows . `` ` DynamicRealmObject obj = ... ; for ( String fieldName : obj.getFieldNames ( ) ) { switch ( obj.getFieldType ( fieldName ) ) { // getFieldType ( String ) is missing case BOOLEAN : boolean b = obj.getBoolean ( fieldName ) ; // do something break ; case STRING : String str = obj.getString ( fieldName ) ; // do something break ; ... } } `` `
diff -- git a/realm/src/androidTest/java/io/realm/RealmTest.java b/realm/src/androidTest/java/io/realm/RealmTest.java index 8b9fd14..cc11ea5 100644 -- - a/realm/src/androidTest/java/io/realm/RealmTest.java +++ b/realm/src/androidTest/java/io/realm/RealmTest.java @ @ -62,6 +62,8 @ @ import io.realm.entities.PrimaryKeyMix ; import io.realm.entities.StringOnly ; import io.realm.exceptions.RealmException ; import io.realm.exceptions.RealmIOException ; +import io.realm.internal.SharedGroupManager ; +import io.realm.base.RealmBase ; import io.realm.internal.SharedGroup ; import io.realm.internal.Table ; @ @ -1686,43 +1688,53 @ @ public class RealmTest extends AndroidTestCase { // Check that FinalizerRunnable can free native resources ( phantom refs ) public void testReferenceCleaning ( ) throws NoSuchFieldException , IllegalAccessException { - Field sharedGroupReference = Realm.class.getDeclaredField ( `` sharedGroup '' ) ; - sharedGroupReference.setAccessible ( true ) ; - SharedGroup sharedGroup = ( SharedGroup ) sharedGroupReference.get ( testRealm ) ; - assertNotNull ( sharedGroup ) ; + RealmConfiguration config = new RealmConfiguration.Builder ( getContext ( ) ) .name ( `` myown '' ) .build ( ) ; + Realm.deleteRealm ( config ) ; + testRealm = Realm.getInstance ( config ) ; + + // Manipulate field accessibility to facilitate testing + Field realmFileReference = RealmBase.class.getDeclaredField ( `` sharedGroup '' ) ; + realmFileReference.setAccessible ( true ) ; Field contextField = SharedGroup.class.getDeclaredField ( `` context '' ) ; contextField.setAccessible ( true ) ; - io.realm.internal.Context context = ( io.realm.internal.Context ) contextField.get ( sharedGroup ) ; missing field type getter of DynamicRealmObject __EoT__ In order to access model object by generic way , we have to know the type of each field . I 'd like to write as follows . `` ` DynamicRealmObject obj = ... ; for ( String fieldName : obj.getFieldNames ( ) ) { switch ( obj.getFieldType ( fieldName ) ) { // getFieldType ( String ) is missing case BOOLEAN : boolean b = obj.getBoolean ( fieldName ) ; // do something break ; case STRING : String str = obj.getString ( fieldName ) ; // do something break ; ... } } `` `
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 596e625..4d306c9 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -17,7 +17,8 @ @ # # # Internal * Removed ` Table # Table ( ) ` , ` Table # addEmptyRow ( ) ` , ` Table # addEmptyRows ( ) ` , ` Table # add ( Object ... ) ` , ` Table # pivot ( long , long , PivotType ) ` and ` Table # createnative ( ) ` . - +* Upgraded Realm Core to 2.8.6 +* Upgraded Realm Sync to 1.10.5 # # 3.4.0 ( 2017-06-22 ) diff -- git a/dependencies.list b/dependencies.list index 82afed2..11a2cd3 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -1,7 +1,7 @ @ # Realm Sync Core release used by Realm Java # https : //github.com/realm/realm-sync/releases -REALM_SYNC_VERSION=1.10.1 -REALM_SYNC_SHA256=b48fd48461b563e2a6b1605ec346aca48b64b64a12d42a0f5a61135906d49074 +REALM_SYNC_VERSION=1.10.5 +REALM_SYNC_SHA256=b7dd873feac88ec562a3940a799085b99bb8aed3013c36e141e40472837b7040 # Object Server Release used by Integration tests # ` realm ` is stable releases , ` realm-testing ` is developer builds . diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java index e12978c..2998dae 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java @ @ -34,6 +34,7 @ @ import io.realm.entities.AnnotationIndexTypes ; import io.realm.entities.Cat ; import io.realm.entities.CatOwner ; import io.realm.entities.Dog ; +import io.realm.entities.IndexedFields ; import io.realm.entities.NoPrimaryKeyNullTypes ; import io.realm.entities.NonLatinFieldNames ; import io.realm.entities.NullTypes Case.INSENSITIVE query broken at 3.1.3 __EoT__ It appears that case-insensitive queries are broken in some cases . It appears that if you have a field with the same string in different cases , querying on the field in a case-insensitive manner returns no results , rather than the expected two results . This behaviour was working in 3.1.2 but broke in 3.1.3 . I suspect this may have been due to a change to realm core . It is still broken as of 3.3.2 . See the Repo here with a failing test : https : //github.com/51systems/RealmBugs The following test fails : `` ` java realm.beginTransaction ( ) ; Dog dog1 = realm.copyToRealm ( Dog.create ( `` ROVER '' ) ) ; Dog dog2 = realm.copyToRealm ( Dog.create ( `` Rover '' ) ) ; realm.commitTransaction ( ) ; assertThat ( realm.where ( Dog.class ) .equalTo ( `` name '' , `` ROVER '' , Case.SENSITIVE ) .findAll ( ) , containsInAnyOrder ( dog1 ) ) ; assertThat ( realm.where ( Dog.class ) .equalTo ( `` name '' , `` Rover '' , Case.SENSITIVE ) .findAll ( ) , containsInAnyOrder ( dog2 ) ) ; //Fails here assertThat ( realm.where
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 67fdd9e..edef77f 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -3,6 +3,7 @ @ # # # Enhancements * Now ` targetSdkVersion ` is 25 . +* Listeners on ` RealmList ` and ` RealmResults ` will be triggered immediately when the transaction is committed on the same thread ( # 4245 ) . # # # Bug Fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmListTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmListTests.java index 78fdc0e..0e195f1 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmListTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmListTests.java @ @ -1053,17 +1053,24 @ @ public class RealmListTests extends CollectionTests { fail ( ) ; } } ) ; - realm.beginTransaction ( ) ; - collection.get ( 0 ) .setAge ( 42 ) ; - realm.commitTransaction ( ) ; collection.removeAllChangeListeners ( ) ; + // This one is added after removal , so it should be triggered . + collection.addChangeListener ( new RealmChangeListener < RealmList < Dog > > ( ) { + @ Override + public void onChange ( RealmList < Dog > element ) { + listenerCalledCount.incrementAndGet ( ) ; + looperThread.testComplete ( ) ; + } + } ) ; + // This should trigger the listener if there is any . realm.beginTransaction ( ) ; - realm.cancelTransaction ( Loading data into Realm is not persisting and/or updating a query __EoT__ # # # # Goal Actual data storage with Realm . # # # # Expected Results A non-zero value for a size ( ) call . # # # # Actual Results Zero ( 0 ) results for a size ( ) call . # # # # Steps & Code to Reproduce `` ` classpath `` io.realm : realm-gradle-plugin:1.0.0 '' `` ` I 'm not sure what steps are necessary except to have an application similar to the one below and a JSON array containing objects at a URL . The Log.d ( ) line outputs the expected names from the JSON feed , so item2 appears to have correct information . However , when the code in UpdateMenu ( ) goes to use the data , menuitems appears to not be updated since menuitems.size ( ) == 0 according to the Android Studio debugger as I stepped through line-by-line . Either the objects did n't write out or there 's a bug in updating menuitems in Realm or I missed something important somewhere else ( special permissions ? ) . # # # # Code
diff -- git a/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java b/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java index 14c9e27..bda0356 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java @ @ -151,7 +151,12 @ @ public class DynamicRealmObjectTests { // of failing values . Only difference is the wrong type column has to be different . List < String > args = ( type == SupportedType.STRING ) ? stringArguments : arguments ; try { - callGetter ( type , args ) ; + callGetter ( dObjTyped , type , args ) ; + fail ( ) ; + } catch ( IllegalArgumentException ignored ) { + } + try { + callGetter ( dObjDynamic , type , args ) ; fail ( ) ; } catch ( IllegalArgumentException ignored ) { } @ @ -164,9 +169,19 @ @ public class DynamicRealmObjectTests { try { // Make sure we hit the wrong underlying type for all types . if ( type == SupportedType.DOUBLE ) { - callGetter ( type , Arrays.asList ( AllJavaTypes.FIELD_STRING ) ) ; + callGetter ( dObjTyped , type , Arrays.asList ( AllJavaTypes.FIELD_STRING ) ) ; + } else { + callGetter ( dObjTyped , type , Arrays.asList ( AllJavaTypes.FIELD_DOUBLE ) ) ; + } + fail ( type + `` failed to throw DynamicRealmObject # setList ( ) causes native crash if the specified field is not a List __EoT__ Calling ` DynamicRealmObject # setList ( ) ` against an object from ` DynamicRealm ` causes a native crash if the field type is not a ` List ` .
diff -- git a/realm/realm-library/src/main/java/io/realm/AndroidNotifier.java b/realm/realm-library/src/main/java/io/realm/AndroidNotifier.java index b0f1c19..2ca296d 100644 -- - a/realm/realm-library/src/main/java/io/realm/AndroidNotifier.java +++ b/realm/realm-library/src/main/java/io/realm/AndroidNotifier.java @ @ -96,6 +96,10 @ @ class AndroidNotifier implements RealmNotifier { @ Override public void post ( Runnable runnable ) { + if ( handler == null ) { + return ; + } + Looper looper = handler.getLooper ( ) ; if ( looper.getThread ( ) .isAlive ( ) ) { // The receiving thread is alive handler.post ( runnable ) ; @ @ -117,6 +121,10 @ @ class AndroidNotifier implements RealmNotifier { @ Override public void completeAsyncResults ( QueryUpdateTask.Result result ) { + if ( handler == null ) { + return ; + } + Looper looper = handler.getLooper ( ) ; if ( looper.getThread ( ) .isAlive ( ) ) { // The receiving thread is alive handler.obtainMessage ( HandlerControllerConstants.COMPLETED_ASYNC_REALM_RESULTS , result ) .sendToTarget ( ) ; @ @ -125,6 +133,10 @ @ class AndroidNotifier implements RealmNotifier { @ Override public void completeAsyncObject ( QueryUpdateTask.Result result ) { + if ( handler == null ) { + return ; + } + Looper looper = handler.getLooper ( ) ; if ( looper.getThread ( ) .isAlive ( ) ) { // The receiving thread Realm receives NPE when updating async queries after Realm is closed __EoT__ # # # # Goal > What do you want to achieve ? Write into Realm periodically and also run async queries . # # # # Expected Results No exceptions in the log # # # # Actual Results 2-01 09:53:49.315 4201-4229/com.zhuinden.realmbreak E/REALM_JAVA : java.lang.NullPointerException at io.realm.AndroidNotifier.completeAsyncResults ( AndroidNotifier.java:120 ) at io.realm.RealmQuery.closeSharedRealmAndSendEventToNotifier ( RealmQuery.java:2233 ) at io.realm.RealmQuery.access $ 000 ( RealmQuery.java:62 ) at io.realm.RealmQuery $ 3.call ( RealmQuery.java:1863 ) at io.realm.RealmQuery $ 3.call ( RealmQuery.java:1845 ) at io.realm.internal.async.BgPriorityCallable.call ( BgPriorityCallable.java:36 ) at java.util.concurrent.FutureTask.run ( FutureTask.java:234 ) at java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1080 ) at java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:573 ) at java.lang.Thread.run ( Thread.java:856 ) 02-01 09:53:53.735 4201-4229/com.zhuinden.realmbreak E/REALM_JAVA : java.lang.NullPointerException at io.realm.AndroidNotifier.completeUpdateAsyncQueries ( AndroidNotifier.java:145 ) at io.realm.internal.async.QueryUpdateTask.run ( QueryUpdateTask.java:112 ) at io.realm.internal.async.BgPriorityRunnable.run ( BgPriorityRunnable.java:34 ) at java.util.concurrent.Executors $ RunnableAdapter.call ( Executors.java:390 ) at java.util.concurrent.FutureTask.run ( FutureTask.java:234 ) at java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1080 ) at java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:573 ) at java.lang.Thread.run ( Thread.java:856 ) # # # # Steps & Code to Reproduce > Describe your current debugging efforts . # # # # Code Sample ` Word ` table contains 440000 entries . `` ` java public
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 85b9354..7b88b7b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 1.0.1 + + # # # Enhancements + +* Removes RxJava related APIs during bytecode transforming to make RealmObject plays well with reflection when rx.Observable does n't exist . + # 1.0.0 No changes since 0.91.1. diff -- git a/build.gradle b/build.gradle index cef0f4b..a5770bd 100644 -- - a/build.gradle +++ b/build.gradle @ @ -69,10 +69,19 @ @ task check ( type : GradleBuild ) { } } +task integrationTestsConnectedCheck ( type : GradleBuild ) { + group = 'Test' + description = 'Run the integration tests of the Realm project' + dependsOn installTransformer + buildFile = file ( 'integration-tests/build.gradle ' ) + tasks = [ 'connectedCheck ' ] + } + task connectedUnitTests ( type : GradleBuild ) { group = 'Test' description = 'Run the Android unit tests of the Realm project' dependsOn installTransformer + dependsOn integrationTestsConnectedCheck buildFile = file ( 'realm/build.gradle ' ) tasks = [ 'connectedUnitTests ' ] if ( project.hasProperty ( 'buildTargetABIs ' ) ) { diff -- git a/gradle-plugin/src/main/groovy/io/realm/gradle/Realm.groovy b/gradle-plugin/src/main/groovy/io/realm/gradle/Realm.groovy index 0660016..7ecfe11 100644 -- - a/gradle-plugin/src/main/groovy/io/realm/gradle/Realm.groovy +++ b/gradle-plugin/src/main/groovy/io/realm/gradle/Realm.groovy @ @ -19,6 +19,7 @ @ package 'com.intellij : annotations ' lib included as generated code , causing DEX conflicts __EoT__ # # # # Goal Build an application that depends on Realm and an ` aar ` dependency that includes ` com.intellij : annotations ` as a dependency . # # # # Expected Results The application builds successfully . # # # # Actual Results When assembling the application , I get this error . `` ` FAILURE : Build failed with an exception . * What went wrong : Execution failed for task ' : apps : questionnaire : app : transformClassesWithDexForDebug ' . > com.android.build.api.transform.TransformException : com.android.ide.common.process.ProcessException : java.util.concurrent.ExecutionException : com.android.dex.DexException : Multiple dex files define Lorg/jetbrains/annotations/NotNull ; `` ` # # # # Steps & Code to Reproduce App build file contains the following : `` ` buildscript { repositories { classpath 'io.realm : realm-gradle-plugin:1.1.0' } } dependencies { compile project ( ' : path : to : library : project ' ) } `` ` Library build file contains : `` ` dependencies { compile 'com.intellij : annotations:12.0' } `` ` # # # # Workaround Since Realm generates the annotations library into the ` build/intermediates/transforms/RealmOptionalAPITransformer/debug/folders/1/10/realm-optional-api/org/jetbrains ` , there is no
diff -- git a/CHANGELOG.md b/CHANGELOG.md index afd128c..bdd9e91 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -4,11 +4,18 @ @ * Disabled ` Realm.compactRealm ( ) ` when sync is enabled as it might corrupt the Realm ( https : //github.com/realm/realm-core/issues/2345 ) . + # # # Bug fixes + +* `` operation not permitted '' issue when creating Realm file on some devices ' external storage ( # 3629 ) . + # # # Enhancements -* All major public classes are now non-final . This is mostly a compromise to - support Mockito . All protected fields/methods are still not considered part of - the public API and can change without notice ( # 3869 ) . +* All major public classes are now non-final . This is mostly a compromise to support Mockito . All protected fields/methods are still not considered part of the public API and can change without notice ( # 3869 ) . + + # # # Internal + +* Upgraded Realm Core to 2.1.0 . +* Upgraded Realm Sync to 1.0.0-BETA-5.0 . # # 2.2.1 diff -- git a/dependencies.list b/dependencies.list index de35027..e1ea9c6 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -1,8 +1,8 @ RealmFileException when call Realm.getDefaultInstance ( ) __EoT__ I 'm called Realm.init ( context ) on Application onCreate . Then RealmFileException when call Realm.getDefaultInstance ( ) ， but default.realm is exists . The following log： 12-25 02:11:29.940 29972-29972/com.linchaolong.android.app E/AndroidRuntime : FATAL EXCEPTION : main Process : com.linchaolong.android.app , PID : 29972 io.realm.exceptions.RealmFileException : Unable to open a realm at path '/data/data/com.linchaolong.android.app/files/default.realm ' : Not a Realm file . in /Users/cm/Realm/realm-java/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp line 92 Kind : ACCESS_ERROR . at io.realm.internal.SharedRealm.nativeGetSharedRealm ( Native Method ) at io.realm.internal.SharedRealm.getInstance ( SharedRealm.java:205 ) at io.realm.internal.SharedRealm.getInstance ( SharedRealm.java:182 ) at io.realm.RealmCache.createRealmOrGetFromCache ( RealmCache.java:124 ) at io.realm.Realm.getDefaultInstance ( Realm.java:209 ) at com.linchaolong.android.library.orm.RealmUtils.get ( RealmUtils.java:72 ) at com.linchaolong.android.app.home.DatabaseFragment.onCreate ( DatabaseFragment.java:39 ) at android.support.v4.app.Fragment.performCreate ( Fragment.java:2075 ) at android.support.v4.app.FragmentManagerImpl.moveToState ( FragmentManager.java:1060 ) at android.support.v4.app.FragmentManagerImpl.moveToState ( FragmentManager.java:1295 ) at android.support.v4.app.BackStackRecord.run ( BackStackRecord.java:801 ) at android.support.v4.app.FragmentManagerImpl.execPendingActions ( FragmentManager.java:1682 ) at android.support.v4.app.FragmentManagerImpl $ 1.run ( FragmentManager.java:541 ) at android.os.Handler.handleCallback ( Handler.java:733 ) at android.os.Handler.dispatchMessage ( Handler.java:95 ) at android.os.Looper.loop ( Looper.java:136 ) at android.app.ActivityThread.main ( ActivityThread.java:5016 ) at java.lang.reflect.Method.invokeNative ( Native Method ) at java.lang.reflect.Method.invoke ( Method.java:515 ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:795 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:611 ) at dalvik.system.NativeStart.main ( Native Method ) 12-25 02:11:30.014 2591-2591/ ? E/octvm : open /sys/class/power_supply/battery/status
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..3f9cae0 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 54dd039..530e8ee 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -20,6 +20,8 @ @ # # # Breaking Changes * ` RealmResults.distinct ( ) ` / ` RealmResults.distinctAsync ( ) ` have been removed . Use ` RealmQuery.distinct ( ) ` / ` RealmQuery.distinctAsync ( ) ` instead . +* ` RealmQuery.createQuery ( Realm , Class ) ` , ` RealmQuery.createDynamicQuery ( DynamicRealm , String ) ` , ` RealmQuery.createQueryFromResult ( RealmResults ) ` and ` RealmQuery.createQueryFromList ( RealmList ) ` have been removed . Use ` Realm.where ( Class ) ` , ` DynamicRealm.where ( String ) ` , RealmResults.where ( ) ` and ` RealmList.where ( ) ` instead . +* Some exception messages are revised . # # # Enhancements diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 218a261..6c47ad3 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -9,11 +9,14 @ @ * Removed deprecated API ` RealmObject.removeChangeListeners ( ) ` . Use ` RealmObject.removeAllChangeListeners ( ) ` instead . * ` SyncUser.Callback ` to becomes generic . * Removed ` SyncUser.getAccessToken ` method from public API , and rename it to ` getRefreshToken ` . +* Relaxed upper bound of type parameter of ` RealmList ` , ` RealmQuery ` , ` RealmResults ` , ` RealmCollection ` , ` OrderedRealmCollection ` and ` OrderedRealmCollectionSnapshot ` . # # Deprecated # # Enhancements +* Now users can use ` String ` , ` byte [ ] ` , ` Boolean ` , ` Long ` , ` Integer ` , ` Short ` , ` Byte ` , ` Double ` , ` Float ` and ` Date ` as a type parameter of ` RealmList ` . + # # Bug Fixes # # Internal @ @ -26,6 +29,7 @ @ # # # Breaking Changes * ` RealmResults.distinct ( ) ` / ` RealmResults.distinctAsync ( ) ` have been removed . Use ` RealmQuery.distinct ( ) ` / ` RealmQuery.distinctAsync Array of primitives : Support JSON methods __EoT__ Split from https : //github.com/realm/realm-java/pull/5031 All our ` realm.create*FromJSON ( ) ` methods should support arrays of primitives .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index e3fee3b..0a65e65 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -7,6 +7,8 @ @ * Removed deprecated APIs ` RealmSchema.close ( ) ` and ` RealmObjectSchema.close ( ) ` . Those do n't have to be called anymore . * Removed deprecated API ` RealmResults.removeChangeListeners ( ) ` . Use ` RealmResults.removeAllChangeListeners ( ) ` instead . * Removed deprecated API ` RealmObject.removeChangeListeners ( ) ` . Use ` RealmObject.removeAllChangeListeners ( ) ` instead . +* ` SyncUser.Callback ` to becomes generic . +* Removed ` SyncUser.getAccessToken ` method from public API , and rename it to ` getRefreshToken ` . # # Deprecated diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/AuthenticateRequestTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/AuthenticateRequestTests.java index bdadf62..a7fff7a 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/AuthenticateRequestTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/AuthenticateRequestTests.java @ @ -39,7 +39,7 @ @ public class AuthenticateRequestTests { @ Test public void realmLogin ( ) throws URISyntaxException , JSONException { - Token t = SyncTestUtils.createTestUser ( ) .getAccessToken ( ) ; + Token t = SyncTestUtils.createTestUser ( ) .getRefreshToken ( ) ; AuthenticateRequest request = AuthenticateRequest.realmLogin ( t , new URI ( `` realm : //objectserver/ '' + t.identity ( ) + `` /default '' ) ) ; JSONObject obj = new JSONObject ( request.toJson ( SyncUser.getRefreshToken ( ) is package-local , should n't it be public ? __EoT__ # # # # Goal > What do you want to achieve ? Login with a previous non-expired session . # # # # Expected Results > Successful login and synchronization # # # # Actual Results > Can not login with previous token since SyncUser does not expose ` getRefreshToken ( ) ` anymore . I managed to find [ some code that uses reflection ] ( https : //github.com/realm/realm-java/blob/3f6844a3cc82859d746437b4c4106c13601222f4/realm/realm-library/src/androidTestObjectServer/java/io/realm/util/SyncTestUtils.java # L112 ) to access this method , but I do n't believe this should be the way . # # # # Steps code to reproduce `` ` SyncCredentials creds = SyncCredentials.usernamePassword ( `` xxxxxxxxxx '' , `` xxxxxxxxxxx '' ) ; SyncUser.Callback callback = new SyncUser.Callback < SyncUser > ( ) { @ Override public void onSuccess ( SyncUser user ) { SyncConfiguration build = new SyncConfiguration.Builder ( user , REALM_URL ) .waitForInitialRemoteData ( ) .modules ( new CnaRealmModule ( ) ) .build ( ) ; Realm.setDefaultConfiguration ( build ) ; Token refreshToken = getRefreshToken ( user ) ; // prefs.realmRefreshToken ( ) } public void onError ( ObjectServerError error ) { String errorMsg
diff -- git a/CHANGELOG.md b/CHANGELOG.md index f81aeb9..390b1d6 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -3,6 +3,7 @ @ # # # Bug fixes * Disabled the optional API transformer since it has problems with DexGuard ( 3022 ) . +* ` OnSuccess.OnSuccess ( ) ` might not be called with the correct Realm version for async transaction ( # 1893 ) . # # 1.0.1 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmAsyncQueryTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmAsyncQueryTests.java index 142bf01..fb2e09b 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmAsyncQueryTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmAsyncQueryTests.java @ @ -50,6 +50,8 @ @ import io.realm.rule.RunTestInLooperThread ; import io.realm.rule.TestRealmConfigurationFactory ; import io.realm.util.RealmBackgroundTask ; +import static org.hamcrest.MatcherAssert.assertThat ; +import static org.hamcrest.core.StringContains.containsString ; import static org.junit.Assert.assertEquals ; import static org.junit.Assert.assertFalse ; import static org.junit.Assert.assertNotNull ; @ @ -281,6 +283,34 @ @ public class RealmAsyncQueryTests { } , transactionCallback ) ; } + // Test case for https : //github.com/realm/realm-java/issues/1893 + // Ensure that onSuccess is called with the correct Realm version for async transaction . + @ Test + @ RunTestInLooperThread + public void executeTransactionAsync_asyncQuery ( ) { + final Realm realm = looperThread.realm ; + RealmResults < AllTypes > results = realm.where ( AllTypes.class ) .findAllAsync ( ) ; + assertEquals ( 0 , results.size ( ) ) ; + onSuccess might not be called with the right Realm version for async transaction __EoT__ Now the ` onSuccess ` relies on the ` REALM_CHANGED ` triggers the ` advance_read ` first . If it is running with a unfinished async query , the ` REALM_CHANGED ` might be swallowed by ` updateAsyncQueries ` and the Realm does n't make a ` andvance_read ` . In above case , the next message in the handler queue is to run ` onSuccess ` , but it the function will be called in a wrong earlier Realm version which the changes in the async transaction is not in . -- -- -- -- -- -- -- -- -- -- - Update Jan. 25th 2016 -- -- -- -- -- -- -- -- -- -- -- -- - http : //stackoverflow.com/questions/34938152/callback-never-be-invoked-when-i-excute-a-asynchronous-transaction-with-realm See above question on SO . We need to discuss of the user case of ` onSuccess ` . Currently if the Realm instance is closed , then the ` onSuccess ` wo n't be called depends on the timing . But it might not be what user expect . Shall we just let ` onSuccess ` be delivered whenever the transaction is
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 0b86fcc..0529e35 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,4 +1,4 @ @ - # # 4.1.1 ( YYYY-MM-DD ) + # # 4.1.1 ( 2017-10-26 ) # # # Breaking Changes diff -- git a/version.txt b/version.txt index 2f81801..2582ddd 100644 -- - a/version.txt +++ b/version.txt @ @ -1 +1 @ @ -4.1.1-SNAPSHOT \ No newline at end of file +4.1.1 \ No newline at end of file release step failed at monkeyDebug __EoT__ I got a COULD_NOT_FIND_MATCHING_ABI error when running ` monkeyDebug ` against our GridViewExample that uses APK Split . We need to figure out why
diff -- git a/CHANGELOG.md b/CHANGELOG.md index e2fdb37..c3eef50 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -9,8 +9,10 @ @ * Added support for new data type ` MutableRealmIntegers ` . The new type behaves almost exactly as a reference to a Long ( mutable nullable , etc ) but supports ` increment ` and ` decrement ` methods , which implement a Conflict Free Replicated Data Type , whose value will converge even when changed across distributed devices with poor connections ( # 4266 ) . # # # Bug Fixes +* [ ObjectServer ] Added ` SyncUser.logout ( ) ` throw an exception now , when associated Realms are instances are not closed ( # 4962 ) . # # # Internal +* [ ObjectServer ] removed ` ObjectServerUser ` and it 's inner classes , in a step to reduce ` SyncUser ` complexity ( # 3741 ) . # # 3.5.1 ( YYYY-MM-DD ) diff -- git a/examples/build.gradle b/examples/build.gradle index 3822790..4f6a611 100644 -- - a/examples/build.gradle +++ b/examples/build.gradle @ @ -23,8 +23,8 @ @ allprojects { maven { url 'https : //jitpack.io ' } } dependencies { - classpath 'com.android.tools.build : gradle:3.0.0-alpha4' - classpath 'com.jfrog.bintray.gradle : gradle-bintray-plugin:1.6' + [ Sync ] Change stop policy to SyncSessionStopPolicy : : __EoT__ Current policy for the session is ` SyncSessionStopPolicy : :Immediately ` we should change it to ` SyncSessionStopPolicy : : AfterChangesUploaded ` to align with other binding and to prevent use cases where the Realm might be deleted before the last changes get synchronised . This can happen when using ` logout ` which will mark the ` SyncUser ` and associated Realms to be deleted on the next app launch . https : //github.com/realm/realm-object-store/blob/master/src/sync/sync_user.cpp # L177-L182 https : //github.com/realm/realm-object-store/blob/master/src/sync/sync_manager.cpp # L123-L140
diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/util/SyncTestUtils.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/util/SyncTestUtils.java index 2022869..8d0a12d 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/util/SyncTestUtils.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/util/SyncTestUtils.java @ @ -20,10 +20,13 @ @ import org.json.JSONArray ; import org.json.JSONException ; import org.json.JSONObject ; +import java.lang.reflect.InvocationTargetException ; +import java.lang.reflect.Method ; import java.util.UUID ; import io.realm.ErrorCode ; import io.realm.ObjectServerError ; +import io.realm.SyncManager ; import io.realm.SyncUser ; import io.realm.internal.network.AuthenticateResponse ; import io.realm.internal.objectserver.ObjectServerUser ; @ @ -36,6 +39,16 @ @ public class SyncTestUtils { public static final String DEFAULT_AUTH_URL = `` http : //objectserver.realm.io/auth '' ; public static final String DEFAULT_USER_IDENTIFIER = `` JohnDoe '' ; + private final static Method SYNC_MANAGER_RESET_METHOD ; + static { + try { + SYNC_MANAGER_RESET_METHOD = SyncManager.class.getDeclaredMethod ( `` reset '' ) ; + SYNC_MANAGER_RESET_METHOD.setAccessible ( true ) ; + } catch ( NoSuchMethodException e ) { + throw new AssertionError ( e ) ; + } + } + public static SyncUser createRandomTestUser ( ) { return createTestUser ( UUID.randomUUID ( ) .toString ( ) , UUID.randomUUID ( ) .toString ( ) , @ @ -116,4 +129,14 @ @ public class SyncTestUtils { public static AuthenticateResponse createErrorResponse ( ErrorCode code ) { return AuthenticateResponse.from ( new ObjectServerError ( code , `` dummy '' ) ) ; } + + public static void Enable encryption with Sync __EoT__ We ’ re not using the encryption key for Synced Realm https : //github.com/realm/realm-java/blob/fef417cb35a9920838a07f1ab93c8a84645b4d6f/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp # L134 this is because the ObjectStore has a different ` realm_encryption_key ` https : //github.com/realm/realm-object-store/blob/3eada170f380174992b47b6023f375f3f372a9d2/src/sync/sync_config.hpp # L108 parameter that we need to set ( as opposed to the non sync encryption param ` encryption_key ` https : //github.com/realm/realm-object-store/blob/563f2e9993ae4f4a8ab6f524a1ba71e707ebe78f/src/shared_realm.hpp # L145 ) https : //github.com/realm/realm-object-store/pull/414
diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 93e83ca..78fd04b 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -65,12 +65,12 @ @ def toolchains = [ ] def targets = [ - new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , - new Target ( name : 'arm-v7a ' , jniFolder : 'armeabi-v7a ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' , '-march=armv7-a ' , '-mfloat-abi=softfp ' , '-mfpu=vfpv3-d16 ' ] ) , - new Target ( name : 'arm64 ' , jniFolder : 'arm64-v8a ' , toolchain : toolchains.find { it.name == 'arm64 ' } , cflags : [ ] ) , - new Target ( name : 'mips ' , jniFolder : 'mips ' , toolchain : toolchains.find { it.name == 'mips ' } , cflags : [ ] ) , +// new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , +// new Target ( name : 'arm-v7a Realm just update half of search result __EoT__ `` ` Realm realm = Realm.getDefaultInstance ( ) ; RealmResults < Message > messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; realm.beginTransaction ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; for ( int i=0 ; i < messages.size ( ) ; i++ ) { messages.get ( i ) .setRead ( true ) ; } realm.commitTransaction ( ) ; messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; realm.close ( ) ; `` ` Console : I/Total : 42 I/Total : 21
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 8be2ac2..9b041fb 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,8 +1,9 @ @ # # 0.88.0 * BREAKING CHANGE : DynamicRealm.executeTransaction ( ) now directly throws any RuntimeException instead of wrapping it in a RealmException ( # 1682 ) . * BREAKING CHANGE : DynamicRealm.executeTransaction ( ) now throws IllegalArgumentException instead of silently accepting a null Transaction object . -* BREAKING CHANGE : String setters now throws IllegalArgumentException instead of RealmError for invalid surrogates . +* BREAKING CHANGE : String setters now throw IllegalArgumentException instead of RealmError for invalid surrogates . * BREAKING CHANGE : DynamicRealm.distinct ( ) /distinctAsync ( ) and Realm.distinct ( ) /distinctAsync ( ) now throw IllegalArgumentException instead of UnsupportedOperationException for invalid type or unindexed field . +* BREAKING CHANGE : All thread local change listeners are now delayed until the next Looper event instead of being triggered when committing . * Fixed an error occurring during test and connectedCheck of unit test example ( # 1934 ) . * Fixed bug in jsonExample ( # 2092 ) . * Added RealmQuery.isNotEmpty ( ) ( # 2025 ) . ( Thank you @ stk1m1 ) diff -- git a/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmTests.java Realm just update half of search result __EoT__ `` ` Realm realm = Realm.getDefaultInstance ( ) ; RealmResults < Message > messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; realm.beginTransaction ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; for ( int i=0 ; i < messages.size ( ) ; i++ ) { messages.get ( i ) .setRead ( true ) ; } realm.commitTransaction ( ) ; messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; realm.close ( ) ; `` ` Console : I/Total : 42 I/Total : 21
diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java index 6f00668..2e272cc 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java @ @ -2053,19 +2053,25 @ @ public class RealmTests { } } - // FIXME HandlerThread + // This test assure that calling refresh will not trigger local listeners + // after the Looper receives REALM_CHANGE message @ Test - public void processLocalListenersAfterRefresh ( ) throws InterruptedException { + public void processRefreshLocalListenersAfterLooperQueueStart ( ) throws Throwable { // Used to validate the result final AtomicBoolean listenerWasCalled = new AtomicBoolean ( false ) ; final AtomicBoolean typeListenerWasCalled = new AtomicBoolean ( false ) ; // Used by the background thread to wait for the main thread to do the write operation final CountDownLatch bgThreadLatch = new CountDownLatch ( 1 ) ; - final CountDownLatch bgClosedLatch = new CountDownLatch ( 1 ) ; + final CountDownLatch bgClosedLatch = new CountDownLatch ( 2 ) ; final CountDownLatch bgThreadReadyLatch = new CountDownLatch ( 1 ) ; + final CountDownLatch signalClosedRealm = new CountDownLatch ( 1 ) ; - Thread backgroundThread = new Thread ( ) { + final Looper [ ] looper = new Looper [ 1 ] ; + final Throwable [ ] throwable = new Throwable [ 1 ] Realm just update half of search result __EoT__ `` ` Realm realm = Realm.getDefaultInstance ( ) ; RealmResults < Message > messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; realm.beginTransaction ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; for ( int i=0 ; i < messages.size ( ) ; i++ ) { messages.get ( i ) .setRead ( true ) ; } realm.commitTransaction ( ) ; messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; realm.close ( ) ; `` ` Console : I/Total : 42 I/Total : 21
diff -- git a/realm/realm-jni/src/io_realm_internal_TableView.h b/realm/realm-jni/src/io_realm_internal_TableView.h index 63c986e..4afb233 100644 -- - a/realm/realm-jni/src/io_realm_internal_TableView.h +++ b/realm/realm-jni/src/io_realm_internal_TableView.h @ @ -561,10 +561,10 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_TableView_nativePivot /* * Class : io_realm_internal_TableView - * Method : nativeSync + * Method : nativeSyncIfNeeded * Signature : ( J ) J */ -JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSync +JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSyncIfNeeded ( JNIEnv * , jobject , jlong ) ; /* diff -- git a/realm/realm-jni/src/io_realm_internal_tableview.cpp b/realm/realm-jni/src/io_realm_internal_tableview.cpp index 93d2fd0..0b3fb74 100644 -- - a/realm/realm-jni/src/io_realm_internal_tableview.cpp +++ b/realm/realm-jni/src/io_realm_internal_tableview.cpp @ @ -34,7 +34,12 @ @ inline bool view_valid_and_in_sync ( JNIEnv* env , jlong nativeViewPtr ) { ThrowException ( env , TableInvalid , `` The Realm has been closed and is no longer accessible . `` ) ; return false ; } - TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + if ( ! TV ( nativeViewPtr ) - > is_in_sync ( ) & & TV ( nativeViewPtr ) - > outside_version ( ) == std : :numeric_limits < uint64_t > : :max ( ) ) { + // This table view is no longer valid . By calling sync_if_needed we ensure it behaves + // properly as a 0-size TableView . + TV ( nativeViewPtr ) - > sync_if_needed Realm just update half of search result __EoT__ `` ` Realm realm = Realm.getDefaultInstance ( ) ; RealmResults < Message > messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; realm.beginTransaction ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; for ( int i=0 ; i < messages.size ( ) ; i++ ) { messages.get ( i ) .setRead ( true ) ; } realm.commitTransaction ( ) ; messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; realm.close ( ) ; `` ` Console : I/Total : 42 I/Total : 21
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 21c5444..008b31b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,7 +1,19 @ @ # # 0.89.0 - # # # Enhancements + # # # Breaking changes +* RealmResults.clear ( ) now throws UnsupportedOperationException . Use RealmResults.deleteAllFromRealm ( ) instead . +* RealmResults.remove ( int ) now throws UnsupportedOperationException . Use RealmResults.deleteFromRealm ( ) instead . + + # # # Deprecated + +* RealmObject.removeFromRealm ( ) in place of RealmObject.deleteFromRealm ( ) +* Realm.clear ( Class ) in place of Realm.delete ( Class ) . +* DynamicRealm.clear ( Class ) in place of DynamicRealm.delete ( Class ) . + + # # # Enhancements +* RealmCollection and OrderedRealmCollection have been added . RealmList and RealmResults both implement these interfaces . +* RealmBaseAdapter now accept an OrderedRealmCollection instead of only RealmResults . * RealmObjectSchema.isPrimaryKey ( String ) ( # 2440 ) # # # Bug fixes diff -- git a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java index 69915fc..3a4afc8 100644 -- - a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java +++ b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java @ @ -54,7 +54,7 @ @ public class AdapterExampleActivity extends Activity { listView.setOnItemLongClickListener ( new AdapterView.OnItemLongClickListener ( ) { @ Override public boolean onItemLongClick ( AdapterView < ? > adapterView , View view , int Realm just update half of search result __EoT__ `` ` Realm realm = Realm.getDefaultInstance ( ) ; RealmResults < Message > messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; realm.beginTransaction ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; for ( int i=0 ; i < messages.size ( ) ; i++ ) { messages.get ( i ) .setRead ( true ) ; } realm.commitTransaction ( ) ; messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; realm.close ( ) ; `` ` Console : I/Total : 42 I/Total : 21
diff -- git a/realm/realm-jni/src/io_realm_internal_TableView.h b/realm/realm-jni/src/io_realm_internal_TableView.h index 63c986e..4afb233 100644 -- - a/realm/realm-jni/src/io_realm_internal_TableView.h +++ b/realm/realm-jni/src/io_realm_internal_TableView.h @ @ -561,10 +561,10 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_TableView_nativePivot /* * Class : io_realm_internal_TableView - * Method : nativeSync + * Method : nativeSyncIfNeeded * Signature : ( J ) J */ -JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSync +JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSyncIfNeeded ( JNIEnv * , jobject , jlong ) ; /* diff -- git a/realm/realm-jni/src/io_realm_internal_tableview.cpp b/realm/realm-jni/src/io_realm_internal_tableview.cpp index 93d2fd0..e1f6ad2 100644 -- - a/realm/realm-jni/src/io_realm_internal_tableview.cpp +++ b/realm/realm-jni/src/io_realm_internal_tableview.cpp @ @ -34,7 +34,12 @ @ inline bool view_valid_and_in_sync ( JNIEnv* env , jlong nativeViewPtr ) { ThrowException ( env , TableInvalid , `` The Realm has been closed and is no longer accessible . `` ) ; return false ; } - TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + if ( ! TV ( nativeViewPtr ) - > is_in_sync ( ) & & TV ( nativeViewPtr ) - > depends_on_deleted_linklist ( ) ) { + // This table view is no longer valid . By calling sync_if_needed we ensure it behaves + // properly as a 0-size TableView . + TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + } + } return valid ; } Realm just update half of search result __EoT__ `` ` Realm realm = Realm.getDefaultInstance ( ) ; RealmResults < Message > messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; realm.beginTransaction ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; for ( int i=0 ; i < messages.size ( ) ; i++ ) { messages.get ( i ) .setRead ( true ) ; } realm.commitTransaction ( ) ; messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; realm.close ( ) ; `` ` Console : I/Total : 42 I/Total : 21
diff -- git a/realm/realm-jni/src/io_realm_internal_TableView.h b/realm/realm-jni/src/io_realm_internal_TableView.h index 63c986e..4afb233 100644 -- - a/realm/realm-jni/src/io_realm_internal_TableView.h +++ b/realm/realm-jni/src/io_realm_internal_TableView.h @ @ -561,10 +561,10 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_TableView_nativePivot /* * Class : io_realm_internal_TableView - * Method : nativeSync + * Method : nativeSyncIfNeeded * Signature : ( J ) J */ -JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSync +JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSyncIfNeeded ( JNIEnv * , jobject , jlong ) ; /* diff -- git a/realm/realm-jni/src/io_realm_internal_tableview.cpp b/realm/realm-jni/src/io_realm_internal_tableview.cpp index 93d2fd0..e1f6ad2 100644 -- - a/realm/realm-jni/src/io_realm_internal_tableview.cpp +++ b/realm/realm-jni/src/io_realm_internal_tableview.cpp @ @ -34,7 +34,12 @ @ inline bool view_valid_and_in_sync ( JNIEnv* env , jlong nativeViewPtr ) { ThrowException ( env , TableInvalid , `` The Realm has been closed and is no longer accessible . `` ) ; return false ; } - TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + if ( ! TV ( nativeViewPtr ) - > is_in_sync ( ) & & TV ( nativeViewPtr ) - > depends_on_deleted_linklist ( ) ) { + // This table view is no longer valid . By calling sync_if_needed we ensure it behaves + // properly as a 0-size TableView . + TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + } + } return valid ; } Realm just update half of search result __EoT__ `` ` Realm realm = Realm.getDefaultInstance ( ) ; RealmResults < Message > messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; realm.beginTransaction ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; for ( int i=0 ; i < messages.size ( ) ; i++ ) { messages.get ( i ) .setRead ( true ) ; } realm.commitTransaction ( ) ; messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; realm.close ( ) ; `` ` Console : I/Total : 42 I/Total : 21
diff -- git a/realm/realm-jni/src/io_realm_internal_TableView.h b/realm/realm-jni/src/io_realm_internal_TableView.h index 63c986e..4afb233 100644 -- - a/realm/realm-jni/src/io_realm_internal_TableView.h +++ b/realm/realm-jni/src/io_realm_internal_TableView.h @ @ -561,10 +561,10 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_TableView_nativePivot /* * Class : io_realm_internal_TableView - * Method : nativeSync + * Method : nativeSyncIfNeeded * Signature : ( J ) J */ -JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSync +JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSyncIfNeeded ( JNIEnv * , jobject , jlong ) ; /* diff -- git a/realm/realm-jni/src/io_realm_internal_tableview.cpp b/realm/realm-jni/src/io_realm_internal_tableview.cpp index 93d2fd0..8cc132a 100644 -- - a/realm/realm-jni/src/io_realm_internal_tableview.cpp +++ b/realm/realm-jni/src/io_realm_internal_tableview.cpp @ @ -34,7 +34,13 @ @ inline bool view_valid_and_in_sync ( JNIEnv* env , jlong nativeViewPtr ) { ThrowException ( env , TableInvalid , `` The Realm has been closed and is no longer accessible . `` ) ; return false ; } - TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + // depends_on_deleted_linklist ( ) will return true if and only if the current TableView was created from a + // query on a RealmList and that RealmList was then deleted ( as a result of the object being deleted ) . + if ( ! TV ( nativeViewPtr ) - > is_in_sync ( ) & & TV ( nativeViewPtr ) - > depends_on_deleted_linklist ( ) ) { + // Realm just update half of search result __EoT__ `` ` Realm realm = Realm.getDefaultInstance ( ) ; RealmResults < Message > messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; realm.beginTransaction ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; for ( int i=0 ; i < messages.size ( ) ; i++ ) { messages.get ( i ) .setRead ( true ) ; } realm.commitTransaction ( ) ; messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; realm.close ( ) ; `` ` Console : I/Total : 42 I/Total : 21
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 6474da9..37fe8e1 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -2,32 +2,32 @ @ # # # Breaking changes -* @ PrimaryKey field value can be null for String , Byte , Short , Integer , and Long types . Older Realms should be migrated , using RealmObjectSchema.setNullable ( ) , or by adding the @ Required annotation . ( # 2515 ) . -* RealmResults.clear ( ) now throws UnsupportedOperationException . Use RealmResults.deleteAllFromRealm ( ) instead . -* RealmResults.remove ( int ) now throws UnsupportedOperationException . Use RealmResults.deleteFromRealm ( ) instead . -* Removed deprecated methods Realm.getTable ( ) from public API . +* @ PrimaryKey field value can now be null for String , Byte , Short , Integer , and Long types . Older Realms should be migrated , using RealmObjectSchema.setNullable ( ) , or by adding the @ Required annotation . ( # 2515 ) . +* ` RealmResults.clear ( ) ` now throws UnsupportedOperationException . Use ` RealmResults.deleteAllFromRealm ( ) ` instead . +* ` RealmResults.remove ( int ) ` now throws UnsupportedOperationException . Use ` RealmResults.deleteFromRealm ( int ) ` instead . +* Removed deprecated method ` Realm.getTable ( Realm just update half of search result __EoT__ `` ` Realm realm = Realm.getDefaultInstance ( ) ; RealmResults < Message > messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; realm.beginTransaction ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; for ( int i=0 ; i < messages.size ( ) ; i++ ) { messages.get ( i ) .setRead ( true ) ; } realm.commitTransaction ( ) ; messages = realm.where ( Message.class ) .equalTo ( `` read '' , false ) .findAll ( ) ; Log.i ( `` Total '' , messages.size ( ) + `` '' ) ; realm.close ( ) ; `` ` Console : I/Total : 42 I/Total : 21
diff -- git a/CHANGELOG.md b/CHANGELOG.md index b5552cb..4096af8 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -4,6 +4,7 @ @ * Those were not kept by ProGuard : names of native methods not in the ` io.realm.internal ` package , names of classes used in method signature ( # 3596 ) . * Missing ProGuard configuration for libraries used by Sync extension ( # 3596 ) . +* Permission error when a database file is located at external storage ( # 3140 ) . # # 2.0.2 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java index a920574..da268f9 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java @ @ -3811,4 +3811,34 @ @ public class RealmTests { realm.close ( ) ; assertEquals ( 0 , Realm.getGlobalInstanceCount ( config ) ) ; } + + @ Test + public void testExternalStorage ( ) { + // test for https : //github.com/realm/realm-java/issues/3140 + realm.close ( ) ; + realm = null ; + + final File namedPipeDir = SharedRealm.getNamedPipeDirectory ( ) ; + assertTrue ( namedPipeDir.isDirectory ( ) ) ; + TestHelper.deleteRecursively ( namedPipeDir ) ; + //noinspection ResultOfMethodCallIgnored + namedPipeDir.mkdirs ( ) ; + + final File externalFilesDir = context.getExternalFilesDir ( null ) ; + final RealmConfiguration config = Permission denied in io_realm_internal_SharedGroup.cpp line 113 __EoT__ io.realm.exceptions.RealmError : Unrecoverable error . Permission denied in io_realm_internal_SharedGroup.cpp line 113 at io.realm.internal.SharedGroup.createNativeWithImplicitTransactions ( Native Method ) at io.realm.internal.SharedGroup.openSharedGroupOrFail ( SharedGroup.java:95 ) at io.realm.internal.SharedGroup. < init > ( SharedGroup.java:74 ) at io.realm.internal.SharedGroupManager. < init > ( SharedGroupManager.java:49 ) at io.realm.BaseRealm. < init > ( BaseRealm.java:86 ) at io.realm.Realm. < init > ( Realm.java:135 ) at io.realm.Realm.createAndValidate ( Realm.java:233 ) at io.realm.Realm.createInstance ( Realm.java:214 ) at io.realm.RealmCache.createRealmOrGetFromCache ( RealmCache.java:126 ) at io.realm.Realm.getDefaultInstance ( Realm.java:160 ) at com.example.ouxch.myrealmdemo.MainActivity.onCreate ( MainActivity.java:43 ) at android.app.Activity.performCreate ( Activity.java:6303 ) at android.app.Instrumentation.callActivityOnCreate ( Instrumentation.java:1108 ) at android.app.ActivityThread.performLaunchActivity ( ActivityThread.java:2376 ) at android.app.ActivityThread.handleLaunchActivity ( ActivityThread.java:2483 ) at android.app.ActivityThread.access $ 900 ( ActivityThread.java:153 ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1349 ) at android.os.Handler.dispatchMessage ( Handler.java:102 ) at android.os.Looper.loop ( Looper.java:148 ) at android.app.ActivityThread.main ( ActivityThread.java:5438 ) at java.lang.reflect.Method.invoke ( Native Method ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:739 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:629 ) # # # # Version of Realm and tooling Realm version ( s ) : 1.2.0 Android Studio version : 2.2 Which Android version and device : Android 4.4.3 device is PDA I am learning to use Realm database , I want modify Realm file path ,
diff -- git a/CHANGELOG.md b/CHANGELOG.md index a7fd677..1d3b0ce 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -5,6 +5,7 @ @ * Those were not kept by ProGuard : names of native methods not in the ` io.realm.internal ` package , names of classes used in method signature ( # 3596 ) . * Missing ProGuard configuration for libraries used by Sync extension ( # 3596 ) . * Error handler was not called when sync session failed ( # 3597 ) . +* Permission error when a database file is located at external storage ( # 3140 ) . # # # Enhancements diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java index a920574..14e27c6 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java @ @ -31,6 +31,7 @ @ import org.json.JSONArray ; import org.json.JSONException ; import org.json.JSONObject ; import org.junit.After ; +import org.junit.Assume ; import org.junit.Before ; import org.junit.Ignore ; import org.junit.Rule ; @ @ -3811,4 +3812,38 @ @ public class RealmTests { realm.close ( ) ; assertEquals ( 0 , Realm.getGlobalInstanceCount ( config ) ) ; } + + @ Test + public void namedPipeDirForExternalStorage ( ) { + + // test for https : //github.com/realm/realm-java/issues/3140 + realm.close ( ) ; + realm = null ; + Permission denied in io_realm_internal_SharedGroup.cpp line 113 __EoT__ io.realm.exceptions.RealmError : Unrecoverable error . Permission denied in io_realm_internal_SharedGroup.cpp line 113 at io.realm.internal.SharedGroup.createNativeWithImplicitTransactions ( Native Method ) at io.realm.internal.SharedGroup.openSharedGroupOrFail ( SharedGroup.java:95 ) at io.realm.internal.SharedGroup. < init > ( SharedGroup.java:74 ) at io.realm.internal.SharedGroupManager. < init > ( SharedGroupManager.java:49 ) at io.realm.BaseRealm. < init > ( BaseRealm.java:86 ) at io.realm.Realm. < init > ( Realm.java:135 ) at io.realm.Realm.createAndValidate ( Realm.java:233 ) at io.realm.Realm.createInstance ( Realm.java:214 ) at io.realm.RealmCache.createRealmOrGetFromCache ( RealmCache.java:126 ) at io.realm.Realm.getDefaultInstance ( Realm.java:160 ) at com.example.ouxch.myrealmdemo.MainActivity.onCreate ( MainActivity.java:43 ) at android.app.Activity.performCreate ( Activity.java:6303 ) at android.app.Instrumentation.callActivityOnCreate ( Instrumentation.java:1108 ) at android.app.ActivityThread.performLaunchActivity ( ActivityThread.java:2376 ) at android.app.ActivityThread.handleLaunchActivity ( ActivityThread.java:2483 ) at android.app.ActivityThread.access $ 900 ( ActivityThread.java:153 ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1349 ) at android.os.Handler.dispatchMessage ( Handler.java:102 ) at android.os.Looper.loop ( Looper.java:148 ) at android.app.ActivityThread.main ( ActivityThread.java:5438 ) at java.lang.reflect.Method.invoke ( Native Method ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:739 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:629 ) # # # # Version of Realm and tooling Realm version ( s ) : 1.2.0 Android Studio version : 2.2 Which Android version and device : Android 4.4.3 device is PDA I am learning to use Realm database , I want modify Realm file path ,
diff -- git a/CHANGELOG.md b/CHANGELOG.md index a7fd677..1d3b0ce 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -5,6 +5,7 @ @ * Those were not kept by ProGuard : names of native methods not in the ` io.realm.internal ` package , names of classes used in method signature ( # 3596 ) . * Missing ProGuard configuration for libraries used by Sync extension ( # 3596 ) . * Error handler was not called when sync session failed ( # 3597 ) . +* Permission error when a database file is located at external storage ( # 3140 ) . # # # Enhancements diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java index a920574..14e27c6 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java @ @ -31,6 +31,7 @ @ import org.json.JSONArray ; import org.json.JSONException ; import org.json.JSONObject ; import org.junit.After ; +import org.junit.Assume ; import org.junit.Before ; import org.junit.Ignore ; import org.junit.Rule ; @ @ -3811,4 +3812,38 @ @ public class RealmTests { realm.close ( ) ; assertEquals ( 0 , Realm.getGlobalInstanceCount ( config ) ) ; } + + @ Test + public void namedPipeDirForExternalStorage ( ) { + + // test for https : //github.com/realm/realm-java/issues/3140 + realm.close ( ) ; + realm = null ; + Permission denied in io_realm_internal_SharedGroup.cpp line 113 __EoT__ io.realm.exceptions.RealmError : Unrecoverable error . Permission denied in io_realm_internal_SharedGroup.cpp line 113 at io.realm.internal.SharedGroup.createNativeWithImplicitTransactions ( Native Method ) at io.realm.internal.SharedGroup.openSharedGroupOrFail ( SharedGroup.java:95 ) at io.realm.internal.SharedGroup. < init > ( SharedGroup.java:74 ) at io.realm.internal.SharedGroupManager. < init > ( SharedGroupManager.java:49 ) at io.realm.BaseRealm. < init > ( BaseRealm.java:86 ) at io.realm.Realm. < init > ( Realm.java:135 ) at io.realm.Realm.createAndValidate ( Realm.java:233 ) at io.realm.Realm.createInstance ( Realm.java:214 ) at io.realm.RealmCache.createRealmOrGetFromCache ( RealmCache.java:126 ) at io.realm.Realm.getDefaultInstance ( Realm.java:160 ) at com.example.ouxch.myrealmdemo.MainActivity.onCreate ( MainActivity.java:43 ) at android.app.Activity.performCreate ( Activity.java:6303 ) at android.app.Instrumentation.callActivityOnCreate ( Instrumentation.java:1108 ) at android.app.ActivityThread.performLaunchActivity ( ActivityThread.java:2376 ) at android.app.ActivityThread.handleLaunchActivity ( ActivityThread.java:2483 ) at android.app.ActivityThread.access $ 900 ( ActivityThread.java:153 ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1349 ) at android.os.Handler.dispatchMessage ( Handler.java:102 ) at android.os.Looper.loop ( Looper.java:148 ) at android.app.ActivityThread.main ( ActivityThread.java:5438 ) at java.lang.reflect.Method.invoke ( Native Method ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:739 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:629 ) # # # # Version of Realm and tooling Realm version ( s ) : 1.2.0 Android Studio version : 2.2 Which Android version and device : Android 4.4.3 device is PDA I am learning to use Realm database , I want modify Realm file path ,
diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java index 5dcce6c..43a048b 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java @ @ -405,6 +405,128 @ @ public class RealmQueryTests { } @ Test + public void in_string ( ) { + populateTestRealm ( realm , 200 ) ; + + RealmResults < AllTypes > resultList = realm.where ( AllTypes.class ) .findAll ( ) ; + assertEquals ( 200 , resultList.size ( ) ) ; + try { + realm.where ( AllTypes.class ) .in ( AllTypes.FIELD_STRING , ( String [ ] ) null ) .findAll ( ) ; + } catch ( IllegalArgumentException ignored ) { + } + try { + realm.where ( AllTypes.class ) .in ( AllTypes.FIELD_STRING , new String [ ] { } ) .findAll ( ) ; + } catch ( IllegalArgumentException ignored ) { + } + resultList = realm.where ( AllTypes.class ) .in ( AllTypes.FIELD_STRING , new String [ ] { `` test data 15 '' } ) .findAll ( ) ; + assertEquals ( 1 , resultList.size ( ) ) ; + resultList = realm.where ( AllTypes.class ) .in ( AllTypes.FIELD_STRING , new String [ ] { `` test data 15 '' , `` test data 117 '' , `` test Allow 0-length values array on RealmQuery.in ( ) __EoT__ Allow 0-length values array on RealmQuery.in ( ) > cmelchior : Should we allow the 0-length values array ? It would basically default to the query always returning the empty set , but I would imagine that this values array in most cases will be generated in a loop based on some other input , so I think that this array in a lot of cases will actually be empty , making it a hassle for the user to work around . > > bdash : In Cocoa we have [ ` TrueExpression ` and ` FalseExpression ` ] ( https : //github.com/realm/realm-cocoa/blob/30947f35a115db9e62e208a2ee2c2b75a3009e9b/Realm/RLMQueryUtil.mm # L88-L114 ) that we use for cases like [ handling an ` or ` group containing zero elements ] ( https : //github.com/realm/realm-cocoa/blob/30947f35a115db9e62e208a2ee2c2b75a3009e9b/Realm/RLMQueryUtil.mm # L727-L732 ) . from [ previous discussion ] ( https : //github.com/realm/realm-java/pull/3133 # discussion_r73099630 )
diff -- git a/CHANGELOG.md b/CHANGELOG.md index ef54a97..339513b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,5 +1,9 @ @ # # 3.2.0 ( YYYY-MM-DD ) + # # # Enhancements + +* Transient fields are now allowed in model classes , but are implicitly treated as having the ` @ Ignore ' annotation ( # 4279 ) . + # # 3.1.0 ( 2017-04-05 ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 02b1e46..474c39c 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -248,7 +248,6 @ @ public class ClassMetaData { if ( ! checkReferenceTypes ( ) ) { return false ; } if ( ! checkDefaultConstructor ( ) ) { return false ; } if ( ! checkForFinalFields ( ) ) { return false ; } - if ( ! checkForTransientFields ( ) ) { return false ; } if ( ! checkForVolatileFields ( ) ) { return false ; } return true ; // Meta data was successfully generated @ @ -347,19 +346,6 @ @ public class ClassMetaData { return true ; } - private boolean checkForTransientFields ( ) { - for ( VariableElement field : fields ) { - if ( field.getModifiers ( ) .contains ( Modifier.TRANSIENT ) ) { Support transient keyword __EoT__ From this article https : //medium.com/ @ ffvanderlaan/realm-auto-updated-objects-what-you-need-to-know-b2d769d12d76 # .hzmdv62a9 Would it make sense to allow the ` transient ` keyword and just treat any field with ` transient ` as having ` @ Ignore ` ? On the top of my head I can not come with any negatives , but plenty of positives : * ` transitive ` literally means `` do n't serialize this '' = `` Do n't save to disk '' = `` @ Ignore '' * Better support for GSON . * Closer to language semantics instead of using custom annotations . * Open question : Should we deprecate/remove ` @ Ignore ` ? Some good counter points here http : //stackoverflow.com/questions/2154622/why-does-jpa-have-a-transient-annotation , but I 'm not entirely convinced they apply to the Android world . `` ` public class Person extends RealmObject { // Today @ Ignore public String foo ; // With change public transient String foo ; } `` ` Thoughts @ realm/java ? **TODO** - [ ] Decide if ` @ Ignore ` should be deprecated - [ ] Modify annotation processor so ` transient ` are treated as ` @ Ignore ` - [ ]
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 370ea45..7d23fc9 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 2.2.0 + + # # # Enhancements + +* Supported ` annotationProcessor ` configuration provided by Android Gradle Plugin 2.2.0 or later . Realm plugin adds its annotation processor to ` annotationProcessor ` configuration instead of ` apt ` configuration if ` annotationProcessor ` configuration is provided and ` com.neenbedankt.android-apt ` plugin is not applied . In Kotlin project , ` annotationProcessor ` configuration is never used for now ( # 3026 ) . + # # 2.1.1 # # # Object Server API Changes ( In Beta ) @ @ -37,7 +43,7 @ @ * Permission error when a database file was located on external storage ( # 3140 ) . * Memory leak when unsubscribing from a RealmResults/RealmObject RxJava Observable ( # 3552 ) . - # # # Enhancement + # # # Enhancements * ` Realm.compactRealm ( ) ` now works for encrypted Realms . * Added ` first ( E defaultValue ) ` and ` last ( E defaultValue ) ` methods to ` RealmList ` and ` RealmResult ` . These methods `` Object '' is not part of the schema for this Realm after upgrading from 2.1.1 to 2.2.0 __EoT__ # # # # Goal I want to upgrade to Realm 2.2.0 . # # # # Expected Results All my Realm Objects should work the same way as they did in 2.1.1 . # # # # Actual Results > When I try to do a simple Query : `` ` java public AccessToken getAccessToken ( ) { return realm.where ( AccessToken.class ) .equalTo ( AccessToken.PRIMARY_KEY , AccessToken.PRIMARY_KEY_VALUE ) .findFirst ( ) ; } `` ` > I get this Crash : `` ` 11-12 23:37:15.172 26922-26922/com.plzjoinus.plzjoinus E/AndroidRuntime : FATAL EXCEPTION : main Process : com.plzjoinus.plzjoinus , PID : 26922 java.lang.RuntimeException : Unable to start activity ComponentInfo { com.plzjoinus.plzjoinus/com.plzjoinus.plzjoinus.Activities.LoginActivity } : java.lang.IllegalArgumentException : AccessToken is not part of the schema for this Realm at android.app.ActivityThread.performLaunchActivity ( ActivityThread.java:2646 ) at android.app.ActivityThread.handleLaunchActivity ( ActivityThread.java:2707 ) at android.app.ActivityThread.-wrap12 ( ActivityThread.java ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1460 ) at android.os.Handler.dispatchMessage ( Handler.java:102 ) at android.os.Looper.loop ( Looper.java:154 ) at android.app.ActivityThread.main ( ActivityThread.java:6077 ) at java.lang.reflect.Method.invoke ( Native Method ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:865 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:755 ) Caused by
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 370ea45..eb57581 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 2.2.0 + + # # # Enhancements + +* Added support for the ` annotationProcessor ` configuration provided by Android Gradle Plugin 2.2.0 or later . Realm plugin adds its annotation processor to the ` annotationProcessor ` configuration instead of ` apt ` configuration if it is available and the ` com.neenbedankt.android-apt ` plugin is not used . In Kotlin projects , ` kapt ` is used instead of the ` annotationProcessor ` configurationi ( # 3026 ) . + # # 2.1.1 # # # Object Server API Changes ( In Beta ) @ @ -37,7 +43,7 @ @ * Permission error when a database file was located on external storage ( # 3140 ) . * Memory leak when unsubscribing from a RealmResults/RealmObject RxJava Observable ( # 3552 ) . - # # # Enhancement + # # # Enhancements * ` Realm.compactRealm ( ) ` now works for encrypted Realms . * Added ` first ( E defaultValue ) ` and ` last ( E defaultValue ) ` methods to ` RealmList ` and ` `` Object '' is not part of the schema for this Realm after upgrading from 2.1.1 to 2.2.0 __EoT__ # # # # Goal I want to upgrade to Realm 2.2.0 . # # # # Expected Results All my Realm Objects should work the same way as they did in 2.1.1 . # # # # Actual Results > When I try to do a simple Query : `` ` java public AccessToken getAccessToken ( ) { return realm.where ( AccessToken.class ) .equalTo ( AccessToken.PRIMARY_KEY , AccessToken.PRIMARY_KEY_VALUE ) .findFirst ( ) ; } `` ` > I get this Crash : `` ` 11-12 23:37:15.172 26922-26922/com.plzjoinus.plzjoinus E/AndroidRuntime : FATAL EXCEPTION : main Process : com.plzjoinus.plzjoinus , PID : 26922 java.lang.RuntimeException : Unable to start activity ComponentInfo { com.plzjoinus.plzjoinus/com.plzjoinus.plzjoinus.Activities.LoginActivity } : java.lang.IllegalArgumentException : AccessToken is not part of the schema for this Realm at android.app.ActivityThread.performLaunchActivity ( ActivityThread.java:2646 ) at android.app.ActivityThread.handleLaunchActivity ( ActivityThread.java:2707 ) at android.app.ActivityThread.-wrap12 ( ActivityThread.java ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1460 ) at android.os.Handler.dispatchMessage ( Handler.java:102 ) at android.os.Looper.loop ( Looper.java:154 ) at android.app.ActivityThread.main ( ActivityThread.java:6077 ) at java.lang.reflect.Method.invoke ( Native Method ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:865 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:755 ) Caused by
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 378bf42..4c03858 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -40,6 +40,7 @ @ import javax.lang.model.util.Types ; import io.realm.annotations.Ignore ; import io.realm.annotations.Index ; import io.realm.annotations.PrimaryKey ; +import io.realm.annotations.NotNullable ; /** * Utility class for holding metadata for RealmProxy classes . @ @ -55,6 +56,7 @ @ public class ClassMetaData { private List < String > fieldNames = new ArrayList < String > ( ) ; private List < String > ignoreFieldNames = new ArrayList < String > ( ) ; private List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private List < String > nullableFieldNames = new ArrayList < String > ( ) ; // list of all fields marked @ Nullable private Set < String > expectedGetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a getter private Set < String > expectedSetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a setter private Set < ExecutableElement > methods = new HashSet < ExecutableElement > ( ) ; Native crash after upgrading from 0.79.0 to 0.80.0 __EoT__ Hi , I am experiencing a native crash after a library upgrade from ` 0.79.0 ` to ` 0.80.0 ` . ( the data from ` 0.79.0 ` is present in the phone ) Unfortunately , I ca n't say at what line of my code it crashes but I can reproduce it . Everytime I start my app with the new library I get a crash . This is what I get in the logcat . `` ` 03-21 12:15:31.545 : A/libc ( 28764 ) : Fatal signal 11 ( SIGSEGV ) at 0x5d4bc000 ( code=1 ) , thread 28764 ( com.example ) *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** Build fingerprint : 'samsung/m0xx/m0:4.1.2/JZO54K/I9300XXEMF6 : user/release-keys' pid : 28764 , tid : 28764 , name : com.example > > > com.example < < < signal 11 ( SIGSEGV ) , code 1 ( SEGV_MAPERR ) , fault addr 5d4bc000 03-21 12:15:31.710 : W/PowerManagerService ( 2263 ) : Timer 0x3- > 0x3|0x0 r0 bedd7474 r1 00000030 r2 0000002c r3 bedd74a0 r4 bedd7474 r5 0008ed60 r6 bedd7620 r7 bedd7570 r8 5d42d2a0 r9 5d42d2a0
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index a06158f..7aeb086 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -40,6 +40,7 @ @ import javax.lang.model.util.Types ; import io.realm.annotations.Ignore ; import io.realm.annotations.Index ; import io.realm.annotations.PrimaryKey ; +import io.realm.annotations.NotNullable ; /** * Utility class for holding metadata for RealmProxy classes . @ @ -55,6 +56,7 @ @ public class ClassMetaData { private List < String > fieldNames = new ArrayList < String > ( ) ; private List < String > ignoreFieldNames = new ArrayList < String > ( ) ; private List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private Set < VariableElement > nullableElements = new HashSet < VariableElement > ( ) ; // Set of fields which can be nullable private Set < String > expectedGetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a getter private Set < String > expectedSetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a setter private Set < ExecutableElement > methods = new HashSet < ExecutableElement > ( ) ; Native crash after upgrading from 0.79.0 to 0.80.0 __EoT__ Hi , I am experiencing a native crash after a library upgrade from ` 0.79.0 ` to ` 0.80.0 ` . ( the data from ` 0.79.0 ` is present in the phone ) Unfortunately , I ca n't say at what line of my code it crashes but I can reproduce it . Everytime I start my app with the new library I get a crash . This is what I get in the logcat . `` ` 03-21 12:15:31.545 : A/libc ( 28764 ) : Fatal signal 11 ( SIGSEGV ) at 0x5d4bc000 ( code=1 ) , thread 28764 ( com.example ) *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** Build fingerprint : 'samsung/m0xx/m0:4.1.2/JZO54K/I9300XXEMF6 : user/release-keys' pid : 28764 , tid : 28764 , name : com.example > > > com.example < < < signal 11 ( SIGSEGV ) , code 1 ( SEGV_MAPERR ) , fault addr 5d4bc000 03-21 12:15:31.710 : W/PowerManagerService ( 2263 ) : Timer 0x3- > 0x3|0x0 r0 bedd7474 r1 00000030 r2 0000002c r3 bedd74a0 r4 bedd7474 r5 0008ed60 r6 bedd7620 r7 bedd7570 r8 5d42d2a0 r9 5d42d2a0
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index bc7fc4e..154dc16 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -40,6 +40,7 @ @ import javax.lang.model.util.Types ; import io.realm.annotations.Ignore ; import io.realm.annotations.Index ; import io.realm.annotations.PrimaryKey ; +import io.realm.annotations.NotNullable ; /** * Utility class for holding metadata for RealmProxy classes . @ @ -55,6 +56,7 @ @ public class ClassMetaData { private List < String > fieldNames = new ArrayList < String > ( ) ; private List < String > ignoreFieldNames = new ArrayList < String > ( ) ; private List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private Set < VariableElement > nullableElements = new HashSet < VariableElement > ( ) ; // Set of fields which can be nullable private Set < String > expectedGetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a getter private Set < String > expectedSetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a setter private Set < ExecutableElement > methods = new HashSet < ExecutableElement > ( ) ; Native crash after upgrading from 0.79.0 to 0.80.0 __EoT__ Hi , I am experiencing a native crash after a library upgrade from ` 0.79.0 ` to ` 0.80.0 ` . ( the data from ` 0.79.0 ` is present in the phone ) Unfortunately , I ca n't say at what line of my code it crashes but I can reproduce it . Everytime I start my app with the new library I get a crash . This is what I get in the logcat . `` ` 03-21 12:15:31.545 : A/libc ( 28764 ) : Fatal signal 11 ( SIGSEGV ) at 0x5d4bc000 ( code=1 ) , thread 28764 ( com.example ) *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** Build fingerprint : 'samsung/m0xx/m0:4.1.2/JZO54K/I9300XXEMF6 : user/release-keys' pid : 28764 , tid : 28764 , name : com.example > > > com.example < < < signal 11 ( SIGSEGV ) , code 1 ( SEGV_MAPERR ) , fault addr 5d4bc000 03-21 12:15:31.710 : W/PowerManagerService ( 2263 ) : Timer 0x3- > 0x3|0x0 r0 bedd7474 r1 00000030 r2 0000002c r3 bedd74a0 r4 bedd7474 r5 0008ed60 r6 bedd7620 r7 bedd7570 r8 5d42d2a0 r9 5d42d2a0
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 429999e..f87f679 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -1076,7 +1076,6 @ @ public class RealmProxyClassGenerator { .endControlFlow ( ) .emitStatement ( `` LinkView.nativeAdd ( % 1 $ sNativeLinkViewPtr , cacheItemIndex % 1 $ s ) '' , fieldName ) .endControlFlow ( ) - .emitStatement ( `` LinkView.nativeClose ( % sNativeLinkViewPtr ) '' , fieldName ) .endControlFlow ( ) .emitEmptyLine ( ) ; @ @ -1154,7 +1153,6 @ @ public class RealmProxyClassGenerator { .endControlFlow ( ) .emitStatement ( `` LinkView.nativeAdd ( % 1 $ sNativeLinkViewPtr , cacheItemIndex % 1 $ s ) '' , fieldName ) .endControlFlow ( ) - .emitStatement ( `` LinkView.nativeClose ( % sNativeLinkViewPtr ) '' , fieldName ) .endControlFlow ( ) .emitEmptyLine ( ) ; @ @ -1233,7 +1231,6 @ @ public class RealmProxyClassGenerator { .emitStatement ( `` LinkView.nativeAdd ( % 1 $ sNativeLinkViewPtr , cacheItemIndex % 1 $ s ) '' , fieldName ) .endControlFlow ( ) .endControlFlow ( ) - .emitStatement ( `` LinkView.nativeClose ( % sNativeLinkViewPtr ) '' , fieldName ) .emitEmptyLine ( ) ; } else { @ @ -1314,7 +1311,6 @ @ public class RealmProxyClassGenerator { .emitStatement ( `` LinkView.nativeAdd ( % 1 $ sNativeLinkViewPtr OutOfMemoryError : std : :bad_alloc in io_realm_internal_TableQuery.cpp line 1285 __EoT__ # # # # Goal > Our app logs metrics from a wearable ( sent via BTLE ) . Metrics are sent and saved to Realm every second . The Realm is observed to display the metrics back to the user . Other metrics are periodically sent to a backend ( and then removed from the Realm ) . The app operates for about 5 hours before getting closed due to an OoM . The Realms all seem to be closed correctly ( no warnings about about open Realms ) . # # # # Expected Results > I 'm expecting uninterrupted periods of use . # # # # Actual Results Logcat reveals the following at the point that the app is closed : > 11-21 05:15:33.808 27702-28621/com.snuza.picoconnect E/REALM_JNI : jni : ThrowingException 4 , std : :bad_alloc in /Users/cm/Realm/realm-java/realm/realm-library/src/main/cpp/io_realm_internal_TableQuery.cpp line 1285 , . 11-21 05:15:33.809 27702-28655/com.snuza.picoconnect E/REALM_JNI : jni : ThrowingException 4 , std : :bad_alloc in /Users/cm/Realm/realm-java/realm/realm-library/src/main/cpp/io_realm_internal_TableQuery.cpp line 1285 , . 11-21 05:15:33.841 27702-28621/com.snuza.picoconnect E/REALM_JNI : Exception has been throw : std : :bad_alloc in /Users/cm/Realm/realm-java/realm/realm-library/src/main/cpp/io_realm_internal_TableQuery.cpp line 1285 11-21 05:15:33.841 27702-28655/com.snuza.picoconnect E/REALM_JNI : Exception has been throw
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..94a56f7 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..92a819f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -19,6 +19,7 @ @ package io.realm.processor ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Collections ; +import java.util.Date ; import java.util.HashSet ; import java.util.List ; import java.util.Locale ; @ @ -66,6 +67,7 @ @ public class ClassMetaData { private boolean containsHashCode ; private final List < TypeMirror > validPrimaryKeyTypes ; + private final List < TypeMirror > validListValueTypes ; private final Types typeUtils ; private final Elements elements ; @ @ -74,7 Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) .name } '' + status += `` \nSorting $ { sortedPersons.last ( ) ? .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) ? .name } '' } finally { realm.close ( ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index d58b0bc..3f9cae0 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -57,6 +57,7 @ @ public class ClassMetaData { private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 2fe5b41..f4df7d8 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -7,6 +7,8 @ @ # # # Breaking Changes * ` RealmResults.distinct ( ) ` / ` RealmResults.distinctAsync ( ) ` have been removed . Use ` RealmQuery.distinct ( ) ` / ` RealmQuery.distinctAsync ( ) ` instead . +* ` RealmQuery.createQuery ( Realm , Class ) ` , ` RealmQuery.createDynamicQuery ( DynamicRealm , String ) ` , ` RealmQuery.createQueryFromResult ( RealmResults ) ` and ` RealmQuery.createQueryFromList ( RealmList ) ` have been removed . Use ` Realm.where ( Class ) ` , ` DynamicRealm.where ( String ) ` , RealmResults.where ( ) ` and ` RealmList.where ( ) ` instead . +* Some exception messages are revised . # # # Internal diff -- git a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt index bc4d648..643704a 100644 -- - a/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt +++ b/examples/kotlinExample/src/main/kotlin/io/realm/examples/kotlin/KotlinExampleActivity.kt @ @ -174,7 +174,7 @ @ class KotlinExampleActivity : Activity ( ) { // Sorting val sortedPersons = realm.where ( Person : :class.java ) .findAllSorted ( `` age '' , Sort.DESCENDING ) - status += `` \nSorting $ { sortedPersons.last ( ) .name } == $ { realm.where ( Person : :class.java ) .findAll ( ) .first ( ) Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 771001e..ebb49d0 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -16,6 +16,7 @ @ # # Enhancements +* Added support for primitive lists in migrations using ` RealmObjectSchema.addRealmListField ( String name , Class < ? > type ) ` ( # 5329 ) . * Now users can use ` String ` , ` byte [ ] ` , ` Boolean ` , ` Long ` , ` Integer ` , ` Short ` , ` Byte ` , ` Double ` , ` Float ` and ` Date ` as a type parameter of ` RealmList ` . # # Bug Fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java b/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java index c87b63b..5622d2d 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java @ @ -95,6 +95,13 @ @ public class DynamicRealmObjectTests { typedObj.setFieldDate ( new Date ( 1000 ) ) ; typedObj.setFieldObject ( typedObj ) ; typedObj.getFieldList ( ) .add ( typedObj ) ; + typedObj.getFieldIntegerList ( ) .add ( 1 ) ; + typedObj.getFieldStringList ( ) .add ( `` str '' ) ; + typedObj.getFieldBooleanList ( ) .add ( true ) ; + typedObj.getFieldFloatList ( ) .add ( 1.23F ) ; + typedObj.getFieldDoubleList ( ) .add ( 1.234D ) ; Realm Java 4.0 Doc updates __EoT__ We need to update the website docs for the breaking changes gone into 4.0 : - Array of Primitives + be really explicit about what is missing and will come in 4.1 - RxJava 2 - Other things ?
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..d211177 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp index 168dd34..86e1733 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp @ @ -23,6 +23,7 @ @ # include `` util.hpp '' # include `` jni_util/jni_utils.hpp '' + # include `` jni_util/hack.hpp '' using std : :string ; using namespace realm : :jni_util ; @ @ -37,6 +38,9 @ @ const string TABLE_PREFIX ( `` class_ '' ) ; JNIEXPORT jint JNICALL JNI_OnLoad ( JavaVM* vm , void* ) { + // Workaround some known bugs of system calls on some special devices . + hack_init ( ) ; + JNIEnv* env ; if ( vm- > GetEnv ( ( void** ) & env , JNI_VERSION_1_6 ) ! SIGSEGV ( SEGV_MAPERR ) SIGSEGV ( SEGV_ACCERR ) __EoT__ 1 # 00 pc 00086598 /data/app-lib/com.netease.ntespm-1/librealm-jni.so [ armeabi-v7a ] 2 # 01 pc 000a9d37 /data/app-lib/com.netease.ntespm-1/librealm-jni.so [ armeabi-v7a ] 3 # 02 pc 0005ec8d /data/app-lib/com.netease.ntespm-1/librealm-jni.so [ armeabi-v7a ] 4 java : 5 io.realm.internal.SharedRealm.void nativeSetVersion ( long , long ) ( Native Method ) 6 io.realm.internal.SharedRealm.void setSchemaVersion ( long ) ( SharedRealm.java:236 ) 7 io.realm.BaseRealm.void setVersion ( long ) ( BaseRealm.java:496 ) 8 io.realm.Realm.void initializeRealm ( io.realm.Realm ) ( Realm.java:323 ) 9 io.realm.Realm.io.realm.Realm createAndValidate ( io.realm.RealmConfiguration , io.realm.internal.ColumnIndices [ ] ) ( Realm.java:299 ) 10 io.realm.Realm.io.realm.Realm createInstance ( io.realm.RealmConfiguration , io.realm.internal.ColumnIndices [ ] ) ( Realm.java:264 ) 11 io.realm.RealmCache.io.realm.BaseRealm createRealmOrGetFromCache ( io.realm.RealmConfiguration , java.lang.Class ) ( RealmCache.java:143 ) 12 io.realm.Realm.io.realm.Realm getDefaultInstance ( ) ( Realm.java:209 ) ! [ image ] ( https : //cloud.githubusercontent.com/assets/4246885/21756641/b2d90d9e-d65e-11e6-84df-501c09dfd998.png )
diff -- git a/realm/realm-jni/object-store/.gitignore b/realm/realm-jni/object-store/.gitignore new file mode 100644 index 0000000..3ea88b2 -- - /dev/null +++ b/realm/realm-jni/object-store/.gitignore @ @ -0,0 +1,14 @ @ + # CMake +.ninja_deps +.ninja_log +CMakeCache.txt +CMakeFiles/ +Makefile +build.ninja +cmake_install.cmake +rules.ninja + + # Build products +src/librealm-object-store.dylib +src/librealm-object-store-static.a +tests/tests diff -- git a/realm/realm-jni/object-store/.gitmodules b/realm/realm-jni/object-store/.gitmodules new file mode 100644 index 0000000..44b8f2a -- - /dev/null +++ b/realm/realm-jni/object-store/.gitmodules @ @ -0,0 +1,6 @ @ + [ submodule `` external/pegtl '' ] + path = external/pegtl + url = https : //github.com/ColinH/PEGTL + [ submodule `` external/catch '' ] + path = external/catch + url = https : //github.com/philsquared/Catch diff -- git a/realm/realm-jni/object-store/CMake/CodeCoverage.cmake b/realm/realm-jni/object-store/CMake/CodeCoverage.cmake new file mode 100644 index 0000000..b830828 -- - /dev/null +++ b/realm/realm-jni/object-store/CMake/CodeCoverage.cmake @ @ -0,0 +1,49 @ @ +find_program ( LCOV_PATH lcov ) +find_program ( GENHTML_PATH genhtml ) +find_program ( GCOVR_PATH gcovr PATHS $ { CMAKE_SOURCE_DIR } /tests ) + +set ( CMAKE_CXX_FLAGS_COVERAGE `` -g -O0 -fprofile-arcs -ftest-coverage '' + CACHE STRING `` Flags used by the C++ compiler during coverage builds . '' ) +mark_as_advanced ( CMAKE_CXX_FLAGS_COVERAGE ) + +if ( CMAKE_BUILD_TYPE STREQUAL `` Coverage '' ) + if ( NOT ( LCOV_PATH AND GENHTML_PATH AND GCOVR_PATH ) ) + message ( FATAL_ERROR `` Generating a coverage report A subtle change in timing in Realm 2.0.0-SNAPSHOT with handlers __EoT__ # # # # Goal > What do you want to achieve ? When a transaction is committed , a message was sent to the handler . I 'd like to send an event through event bus after Realm transaction is committed . # # # # Expected Results If I sent a message ( event ) of my own through the handler , then considering it was sent after the transaction , it ought to be received after the transaction 's notification # # # # Actual Results _Sometimes_ the Realm updates later than the event through the event bus finishes , so ` findFirst ( ) ` still returns ` null ` when event is received through the bus # # # # Steps & Code to Reproduce > Describe your current debugging efforts . # # # # Code Sample `` ` java realm.commitTransaction ( ) ; handler.post ( new Runnable ( ) { @ Override public void run ( ) { bus.post ( event ) ; } } ) ; `` ` ( obviously the solution is to use ` RealmChangeListener ` instead of relying
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/build.gradle b/build.gradle index cef0f4b..f605a25 100644 -- - a/build.gradle +++ b/build.gradle @ @ -196,7 +196,7 @ @ task distributionJniUnstrippedPackage ( type : Zip ) { archiveName = `` realm-java-jni-libs-unstripped- $ { currentVersion } .zip '' destinationDir = file ( `` $ { buildDir } /outputs/distribution '' ) - from ( `` realm/realm-jni/build/outputs/jniLibs-unstripped '' ) { + from ( `` realm/realm-library/build/outputs/jniLibs-unstripped '' ) { include '**/*.so' } } diff -- git a/realm/build.gradle b/realm/build.gradle index 44d2ab9..580dfbd 100644 -- - a/realm/build.gradle +++ b/realm/build.gradle @ @ -6,7 +6,7 @ @ buildscript { } dependencies { - classpath 'com.android.tools.build : gradle:2.1.0' + classpath 'com.android.tools.build : gradle:2.2.0-alpha3' classpath 'de.undercouch : gradle-download-task:2.0.0' classpath 'com.neenbedankt.gradle.plugins : android-apt:1.8' classpath 'com.github.dcendents : android-maven-gradle-plugin:1.3' diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 9565009..535021d 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -20,7 +20,7 @ @ ext.coreArchiveDir = System.getenv ( `` REALM_CORE_DOWNLOAD_DIR '' ) // To obtain the ABI of the connected device , execute `` adb shell getprop ro.product.cpu.abi '' ext.buildTargetAbis = project.hasProperty ( 'buildTargetABIs ' ) ? A subtle change in timing in Realm 2.0.0-SNAPSHOT with handlers __EoT__ # # # # Goal > What do you want to achieve ? When a transaction is committed , a message was sent to the handler . I 'd like to send an event through event bus after Realm transaction is committed . # # # # Expected Results If I sent a message ( event ) of my own through the handler , then considering it was sent after the transaction , it ought to be received after the transaction 's notification # # # # Actual Results _Sometimes_ the Realm updates later than the event through the event bus finishes , so ` findFirst ( ) ` still returns ` null ` when event is received through the bus # # # # Steps & Code to Reproduce > Describe your current debugging efforts . # # # # Code Sample `` ` java realm.commitTransaction ( ) ; handler.post ( new Runnable ( ) { @ Override public void run ( ) { bus.post ( event ) ; } } ) ; `` ` ( obviously the solution is to use ` RealmChangeListener ` instead of relying
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/build.gradle b/build.gradle index cef0f4b..f605a25 100644 -- - a/build.gradle +++ b/build.gradle @ @ -196,7 +196,7 @ @ task distributionJniUnstrippedPackage ( type : Zip ) { archiveName = `` realm-java-jni-libs-unstripped- $ { currentVersion } .zip '' destinationDir = file ( `` $ { buildDir } /outputs/distribution '' ) - from ( `` realm/realm-jni/build/outputs/jniLibs-unstripped '' ) { + from ( `` realm/realm-library/build/outputs/jniLibs-unstripped '' ) { include '**/*.so' } } diff -- git a/realm/build.gradle b/realm/build.gradle index 44d2ab9..580dfbd 100644 -- - a/realm/build.gradle +++ b/realm/build.gradle @ @ -6,7 +6,7 @ @ buildscript { } dependencies { - classpath 'com.android.tools.build : gradle:2.1.0' + classpath 'com.android.tools.build : gradle:2.2.0-alpha3' classpath 'de.undercouch : gradle-download-task:2.0.0' classpath 'com.neenbedankt.gradle.plugins : android-apt:1.8' classpath 'com.github.dcendents : android-maven-gradle-plugin:1.3' diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 9565009..535021d 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -20,7 +20,7 @ @ ext.coreArchiveDir = System.getenv ( `` REALM_CORE_DOWNLOAD_DIR '' ) // To obtain the ABI of the connected device , execute `` adb shell getprop ro.product.cpu.abi '' ext.buildTargetAbis = project.hasProperty ( 'buildTargetABIs ' ) ? A subtle change in timing in Realm 2.0.0-SNAPSHOT with handlers __EoT__ # # # # Goal > What do you want to achieve ? When a transaction is committed , a message was sent to the handler . I 'd like to send an event through event bus after Realm transaction is committed . # # # # Expected Results If I sent a message ( event ) of my own through the handler , then considering it was sent after the transaction , it ought to be received after the transaction 's notification # # # # Actual Results _Sometimes_ the Realm updates later than the event through the event bus finishes , so ` findFirst ( ) ` still returns ` null ` when event is received through the bus # # # # Steps & Code to Reproduce > Describe your current debugging efforts . # # # # Code Sample `` ` java realm.commitTransaction ( ) ; handler.post ( new Runnable ( ) { @ Override public void run ( ) { bus.post ( event ) ; } } ) ; `` ` ( obviously the solution is to use ` RealmChangeListener ` instead of relying
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/build.gradle b/build.gradle index a5770bd..fd4ce60 100644 -- - a/build.gradle +++ b/build.gradle @ @ -205,7 +205,7 @ @ task distributionJniUnstrippedPackage ( type : Zip ) { archiveName = `` realm-java-jni-libs-unstripped- $ { currentVersion } .zip '' destinationDir = file ( `` $ { buildDir } /outputs/distribution '' ) - from ( `` realm/realm-jni/build/outputs/jniLibs-unstripped '' ) { + from ( `` realm/realm-library/build/outputs/jniLibs-unstripped '' ) { include '**/*.so' } } diff -- git a/realm/build.gradle b/realm/build.gradle index 44d2ab9..580dfbd 100644 -- - a/realm/build.gradle +++ b/realm/build.gradle @ @ -6,7 +6,7 @ @ buildscript { } dependencies { - classpath 'com.android.tools.build : gradle:2.1.0' + classpath 'com.android.tools.build : gradle:2.2.0-alpha3' classpath 'de.undercouch : gradle-download-task:2.0.0' classpath 'com.neenbedankt.gradle.plugins : android-apt:1.8' classpath 'com.github.dcendents : android-maven-gradle-plugin:1.3' diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 05b439a..1218811 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -20,7 +20,7 @ @ ext.coreArchiveDir = System.getenv ( `` REALM_CORE_DOWNLOAD_DIR '' ) // To obtain the ABI of the connected device , execute `` adb shell getprop ro.product.cpu.abi '' ext.buildTargetAbis = project.hasProperty ( 'buildTargetABIs ' ) ? A subtle change in timing in Realm 2.0.0-SNAPSHOT with handlers __EoT__ # # # # Goal > What do you want to achieve ? When a transaction is committed , a message was sent to the handler . I 'd like to send an event through event bus after Realm transaction is committed . # # # # Expected Results If I sent a message ( event ) of my own through the handler , then considering it was sent after the transaction , it ought to be received after the transaction 's notification # # # # Actual Results _Sometimes_ the Realm updates later than the event through the event bus finishes , so ` findFirst ( ) ` still returns ` null ` when event is received through the bus # # # # Steps & Code to Reproduce > Describe your current debugging efforts . # # # # Code Sample `` ` java realm.commitTransaction ( ) ; handler.post ( new Runnable ( ) { @ Override public void run ( ) { bus.post ( event ) ; } } ) ; `` ` ( obviously the solution is to use ` RealmChangeListener ` instead of relying
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk A subtle change in timing in Realm 2.0.0-SNAPSHOT with handlers __EoT__ # # # # Goal > What do you want to achieve ? When a transaction is committed , a message was sent to the handler . I 'd like to send an event through event bus after Realm transaction is committed . # # # # Expected Results If I sent a message ( event ) of my own through the handler , then considering it was sent after the transaction , it ought to be received after the transaction 's notification # # # # Actual Results _Sometimes_ the Realm updates later than the event through the event bus finishes , so ` findFirst ( ) ` still returns ` null ` when event is received through the bus # # # # Steps & Code to Reproduce > Describe your current debugging efforts . # # # # Code Sample `` ` java realm.commitTransaction ( ) ; handler.post ( new Runnable ( ) { @ Override public void run ( ) { bus.post ( event ) ; } } ) ; `` ` ( obviously the solution is to use ` RealmChangeListener ` instead of relying
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index 80421d0..1cd1d11 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ updates tools to at least A subtle change in timing in Realm 2.0.0-SNAPSHOT with handlers __EoT__ # # # # Goal > What do you want to achieve ? When a transaction is committed , a message was sent to the handler . I 'd like to send an event through event bus after Realm transaction is committed . # # # # Expected Results If I sent a message ( event ) of my own through the handler , then considering it was sent after the transaction , it ought to be received after the transaction 's notification # # # # Actual Results _Sometimes_ the Realm updates later than the event through the event bus finishes , so ` findFirst ( ) ` still returns ` null ` when event is received through the bus # # # # Steps & Code to Reproduce > Describe your current debugging efforts . # # # # Code Sample `` ` java realm.commitTransaction ( ) ; handler.post ( new Runnable ( ) { @ Override public void run ( ) { bus.post ( event ) ; } } ) ; `` ` ( obviously the solution is to use ` RealmChangeListener ` instead of relying
diff -- git a/.gitignore b/.gitignore index a72b66b..9153b3b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/.gitmodules b/.gitmodules new file mode 100644 index 0000000..50b6ce8 -- - /dev/null +++ b/.gitmodules @ @ -0,0 +1,3 @ @ + [ submodule `` realm/realm-library/src/main/cpp/object-store '' ] + path = realm/realm-library/src/main/cpp/object-store + url = git @ github.com : realm/realm-object-store.git diff -- git a/Dockerfile b/Dockerfile index 0029aae..7aee9b3 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +28,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN A subtle change in timing in Realm 2.0.0-SNAPSHOT with handlers __EoT__ # # # # Goal > What do you want to achieve ? When a transaction is committed , a message was sent to the handler . I 'd like to send an event through event bus after Realm transaction is committed . # # # # Expected Results If I sent a message ( event ) of my own through the handler , then considering it was sent after the transaction , it ought to be received after the transaction 's notification # # # # Actual Results _Sometimes_ the Realm updates later than the event through the event bus finishes , so ` findFirst ( ) ` still returns ` null ` when event is received through the bus # # # # Steps & Code to Reproduce > Describe your current debugging efforts . # # # # Code Sample `` ` java realm.commitTransaction ( ) ; handler.post ( new Runnable ( ) { @ Override public void run ( ) { bus.post ( event ) ; } } ) ; `` ` ( obviously the solution is to use ` RealmChangeListener ` instead of relying
diff -- git a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java index 6de7246..b726878 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java +++ b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java @ @ -318,24 +318,6 @ @ public class NotificationsTest { } @ Test - @ UiThreadTest - public void handlerNotRemovedToSoon ( ) { - RealmConfiguration realmConfig = configFactory.createConfiguration ( `` private-realm '' ) ; - Realm.deleteRealm ( realmConfig ) ; - Realm instance1 = Realm.getInstance ( realmConfig ) ; - Realm instance2 = Realm.getInstance ( realmConfig ) ; - assertEquals ( instance1.getPath ( ) , instance2.getPath ( ) ) ; - assertNotNull ( instance1.handler ) ; - - // If multiple instances are open on the same thread , do n't remove handler on that thread - // until last instance is closed . - instance2.close ( ) ; - assertNotNull ( instance1.handler ) ; - instance1.close ( ) ; - assertNull ( instance1.handler ) ; - } - - @ Test @ RunTestInLooperThread public void commitTransaction_delayChangeListenerOnSameThread ( ) { final AtomicInteger success = new AtomicInteger ( 0 ) ; diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java index 816f4fb..03e4e15 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java @ @ -244,38 +244,6 @ @ public class RealmTests { } @ Test - @ UiThreadTest - public void internalRealmChangedHandlersRemoved ( ) { - A subtle change in timing in Realm 2.0.0-SNAPSHOT with handlers __EoT__ # # # # Goal > What do you want to achieve ? When a transaction is committed , a message was sent to the handler . I 'd like to send an event through event bus after Realm transaction is committed . # # # # Expected Results If I sent a message ( event ) of my own through the handler , then considering it was sent after the transaction , it ought to be received after the transaction 's notification # # # # Actual Results _Sometimes_ the Realm updates later than the event through the event bus finishes , so ` findFirst ( ) ` still returns ` null ` when event is received through the bus # # # # Steps & Code to Reproduce > Describe your current debugging efforts . # # # # Code Sample `` ` java realm.commitTransaction ( ) ; handler.post ( new Runnable ( ) { @ Override public void run ( ) { bus.post ( event ) ; } } ) ; `` ` ( obviously the solution is to use ` RealmChangeListener ` instead of relying
diff -- git a/.github/ISSUE_TEMPLATE/bug_report.md b/.github/ISSUE_TEMPLATE/bug_report.md deleted file mode 100644 index b81b119..0000000 -- - a/.github/ISSUE_TEMPLATE/bug_report.md +++ /dev/null @ @ -1,30 +0,0 @ @ -- -- -name : Bug report -about : You think you have found a bug ! - -- -- - - # # # # Goal - < ! -- What do you want to achieve ? -- > - - # # # # Actual Results - < ! -- What happened ? If an exception was thrown please copy/paste the stack trace from Logcat . -- > - - # # # # Steps & Code to Reproduce - < ! -- What steps resulted in the crash ? Please show any relevant code or steps that can be used to -- > - < ! -- reproduce it , including any Realm model classes used . Even better is a full sample project -- > - < ! -- that can reproduce the crash . Code can be shared privately at help @ realm.io if needed . -- > - - # # # # Version of Realm and tooling - -Realm version ( s ) : ? - -Realm Sync feature enabled : Yes/No Remove ARM support __EoT__ With the upcoming integration of the Object Store , ARM will no longer be supported . Google moved to ARMv7a support as well as practically no devices support this anymore , so it should be safe to do so . It will also reduce the overall size of the AAR distribution package . Note , this is a breaking change so should only happen as part of 2.0
diff -- git a/.github/ISSUE_TEMPLATE/bug_report.md b/.github/ISSUE_TEMPLATE/bug_report.md deleted file mode 100644 index b81b119..0000000 -- - a/.github/ISSUE_TEMPLATE/bug_report.md +++ /dev/null @ @ -1,30 +0,0 @ @ -- -- -name : Bug report -about : You think you have found a bug ! - -- -- - - # # # # Goal - < ! -- What do you want to achieve ? -- > - - # # # # Actual Results - < ! -- What happened ? If an exception was thrown please copy/paste the stack trace from Logcat . -- > - - # # # # Steps & Code to Reproduce - < ! -- What steps resulted in the crash ? Please show any relevant code or steps that can be used to -- > - < ! -- reproduce it , including any Realm model classes used . Even better is a full sample project -- > - < ! -- that can reproduce the crash . Code can be shared privately at help @ realm.io if needed . -- > - - # # # # Version of Realm and tooling - -Realm version ( s ) : ? - -Realm Sync feature enabled : Yes/No Remove ARM support __EoT__ With the upcoming integration of the Object Store , ARM will no longer be supported . Google moved to ARMv7a support as well as practically no devices support this anymore , so it should be safe to do so . It will also reduce the overall size of the AAR distribution package . Note , this is a breaking change so should only happen as part of 2.0
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/build.gradle b/build.gradle index cef0f4b..f605a25 100644 -- - a/build.gradle +++ b/build.gradle @ @ -196,7 +196,7 @ @ task distributionJniUnstrippedPackage ( type : Zip ) { archiveName = `` realm-java-jni-libs-unstripped- $ { currentVersion } .zip '' destinationDir = file ( `` $ { buildDir } /outputs/distribution '' ) - from ( `` realm/realm-jni/build/outputs/jniLibs-unstripped '' ) { + from ( `` realm/realm-library/build/outputs/jniLibs-unstripped '' ) { include '**/*.so' } } diff -- git a/realm/build.gradle b/realm/build.gradle index 44d2ab9..580dfbd 100644 -- - a/realm/build.gradle +++ b/realm/build.gradle @ @ -6,7 +6,7 @ @ buildscript { } dependencies { - classpath 'com.android.tools.build : gradle:2.1.0' + classpath 'com.android.tools.build : gradle:2.2.0-alpha3' classpath 'de.undercouch : gradle-download-task:2.0.0' classpath 'com.neenbedankt.gradle.plugins : android-apt:1.8' classpath 'com.github.dcendents : android-maven-gradle-plugin:1.3' diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 9565009..535021d 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -20,7 +20,7 @ @ ext.coreArchiveDir = System.getenv ( `` REALM_CORE_DOWNLOAD_DIR '' ) // To obtain the ABI of the connected device , execute `` adb shell getprop ro.product.cpu.abi '' ext.buildTargetAbis = project.hasProperty ( 'buildTargetABIs ' ) ? Remove ARM support __EoT__ With the upcoming integration of the Object Store , ARM will no longer be supported . Google moved to ARMv7a support as well as practically no devices support this anymore , so it should be safe to do so . It will also reduce the overall size of the AAR distribution package . Note , this is a breaking change so should only happen as part of 2.0
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/build.gradle b/build.gradle index a5770bd..fd4ce60 100644 -- - a/build.gradle +++ b/build.gradle @ @ -205,7 +205,7 @ @ task distributionJniUnstrippedPackage ( type : Zip ) { archiveName = `` realm-java-jni-libs-unstripped- $ { currentVersion } .zip '' destinationDir = file ( `` $ { buildDir } /outputs/distribution '' ) - from ( `` realm/realm-jni/build/outputs/jniLibs-unstripped '' ) { + from ( `` realm/realm-library/build/outputs/jniLibs-unstripped '' ) { include '**/*.so' } } diff -- git a/realm/build.gradle b/realm/build.gradle index 44d2ab9..580dfbd 100644 -- - a/realm/build.gradle +++ b/realm/build.gradle @ @ -6,7 +6,7 @ @ buildscript { } dependencies { - classpath 'com.android.tools.build : gradle:2.1.0' + classpath 'com.android.tools.build : gradle:2.2.0-alpha3' classpath 'de.undercouch : gradle-download-task:2.0.0' classpath 'com.neenbedankt.gradle.plugins : android-apt:1.8' classpath 'com.github.dcendents : android-maven-gradle-plugin:1.3' diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 05b439a..1218811 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -20,7 +20,7 @ @ ext.coreArchiveDir = System.getenv ( `` REALM_CORE_DOWNLOAD_DIR '' ) // To obtain the ABI of the connected device , execute `` adb shell getprop ro.product.cpu.abi '' ext.buildTargetAbis = project.hasProperty ( 'buildTargetABIs ' ) ? Remove ARM support __EoT__ With the upcoming integration of the Object Store , ARM will no longer be supported . Google moved to ARMv7a support as well as practically no devices support this anymore , so it should be safe to do so . It will also reduce the overall size of the AAR distribution package . Note , this is a breaking change so should only happen as part of 2.0
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk Remove ARM support __EoT__ With the upcoming integration of the Object Store , ARM will no longer be supported . Google moved to ARMv7a support as well as practically no devices support this anymore , so it should be safe to do so . It will also reduce the overall size of the AAR distribution package . Note , this is a breaking change so should only happen as part of 2.0
diff -- git a/.gitignore b/.gitignore index a72b66b..9153b3b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/Dockerfile b/Dockerfile index 0029aae..7aee9b3 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +28,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ Remove ARM support __EoT__ With the upcoming integration of the Object Store , ARM will no longer be supported . Google moved to ARMv7a support as well as practically no devices support this anymore , so it should be safe to do so . It will also reduce the overall size of the AAR distribution package . Note , this is a breaking change so should only happen as part of 2.0
diff -- git a/.gitignore b/.gitignore index a72b66b..9153b3b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/Dockerfile b/Dockerfile index 0029aae..c792350 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -9,7 +9,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' # Set the environment variables ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux -ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed Remove ARM support __EoT__ With the upcoming integration of the Object Store , ARM will no longer be supported . Google moved to ARMv7a support as well as practically no devices support this anymore , so it should be safe to do so . It will also reduce the overall size of the AAR distribution package . Note , this is a breaking change so should only happen as part of 2.0
diff -- git a/.gitmodules b/.gitmodules new file mode 100644 index 0000000..35b419c -- - /dev/null +++ b/.gitmodules @ @ -0,0 +1,3 @ @ + [ submodule `` realm/realm-library/src/main/cpp/object-store '' ] + path = realm/realm-library/src/main/cpp/object-store + url = https : //github.com/realm/realm-object-store.git diff -- git a/CHANGELOG.md b/CHANGELOG.md index b0adb80..c8c06ef 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 2.0.0 + + # # # Breaking changes + +* armeabi is not supported anymore . + # # 1.2.1 # # # Internal diff -- git a/Jenkinsfile b/Jenkinsfile index 291c183..4c10941 100644 -- - a/Jenkinsfile +++ b/Jenkinsfile @ @ -11,6 +11,8 @ @ try { checkout scm // Make sure not to delete the folder that Jenkins allocates to store scripts sh 'git clean -ffdx -e . ? ? ? ? ? ? ? ? ' + // Update submodule for object-store + sh 'git submodule update -- init -- force' stage 'Docker build' def buildEnv = docker.build 'realm-java : snapshot' diff -- git a/realm/config/findbugs/findbugs-filter.xml b/realm/config/findbugs/findbugs-filter.xml index 37ab1ae..b6503d5 100644 -- - a/realm/config/findbugs/findbugs-filter.xml +++ b/realm/config/findbugs/findbugs-filter.xml @ @ -8,21 +8,6 @ @ < Class name= '' ~.*\.Manifest\ $ . * '' / > < /Match > < Match > - < Remove ARM support __EoT__ With the upcoming integration of the Object Store , ARM will no longer be supported . Google moved to ARMv7a support as well as practically no devices support this anymore , so it should be safe to do so . It will also reduce the overall size of the AAR distribution package . Note , this is a breaking change so should only happen as part of 2.0
diff -- git a/.gitignore b/.gitignore index 7d38506..483d1a7 100644 -- - a/.gitignore +++ b/.gitignore @ @ -1,6 +1,7 @ @ # Gradle build artifacts build realm/build + ! realm-transformer/src/main/kotlin/io/realm/transformer/build # Gradle cache .gradle diff -- git a/CHANGELOG.md b/CHANGELOG.md index c645665..049c619 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,18 @ @ + # # 5.2.0 ( YYYY-MM-DD ) + + # # # Enhancements + +* The Realm Transformer now supports incremental builds ( # 3034 ) . + + # # # Bug Fixes + +* Having files that ends with ` RealmProxy ` will no longer break the Realm Transformer ( # 3709 ) . + + # # # Internal + +* Module mediator classes being generated now produces a stable output enabling better support for incremental builds ( # 3034 ) . + + # # 5.1.0 ( 2018-04-25 ) # # # Enhancements diff -- git a/Jenkinsfile b/Jenkinsfile index 8412e67..52d8559 100644 -- - a/Jenkinsfile +++ b/Jenkinsfile @ @ -22,6 +22,8 @ @ try { ] ) } + sh `` Building branch : echo $ { getCurrentBranch ( ) } '' + // Toggles for PR vs. Master builds . // For PR 's , Accelarate Realm transformer __EoT__ We got some complains ( http : //stackoverflow.com/questions/37928953/realm-gradle-tasks ) about the speed of transformers and there is always space to improve it , like : - Replace slow groovy with kotlin - ...
diff -- git a/CHANGELOG.md b/CHANGELOG.md index ec87830..67fdd9e 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -9,6 +9,7 @ @ * ` Realm.migrateRealm ( RealmConfiguration ) ` now fails correctly with an ` IllegalArgumentException ` if a ` SyncConfiguration ` is provided ( # 4075 ) . * Fixed a potential cause for Realm file corruptions ( never reported ) . * Add ` @ Override ` annotation to proxy class accessors and stop using raw type in proxy classes in order to remove warnings from javac ( # 4329 ) . +* ` findFirstAsync ( ) ` now returns an invalid object if there is no object matches the query condition instead of running the query repeatedly until it can find one ( # 4352 ) . # # # Deprecated diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmAsyncQueryTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmAsyncQueryTests.java index ee1c90b..a960825 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmAsyncQueryTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmAsyncQueryTests.java @ @ -551,34 +551,26 @ @ public class RealmAsyncQueryTests { } ) ; } + // When there is no object match the query condition , findFirstAsync should return with an invalid row . @ Test @ RunTestInLooperThread - public void findFirstAsync_initalEmptyRow ( ) throws Throwable { + public void findFirstAsync_initialEmptyRow ( ) throws Throwable { No Longer Receiving Object Creation Notification __EoT__ I was using `` ` java realm.where ( Item.class ) .equalTo ( `` id '' , id ) .findFirstAsync ( ) .asObservable ( ) .filter ( new Func1 < item , Boolean > ( ) { @ Override public Boolean call ( Item item ) { return item.isLoaded ( ) & & item.isValid ( ) ; } } ) .subscribe ( new Action1 < Item > ( ) { @ Override public void call ( Item item ) { // Do stuff } } ) `` ` to listen to changes to the Item with the id . Before 3.1.0 , if the item with the specified id is not in Realm yet , the observable would be triggered when the item is created . This is no longer the case .
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 545013b..5077ec4 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -40,6 +40,7 @ @ import javax.lang.model.util.Types ; import io.realm.annotations.Ignore ; import io.realm.annotations.Index ; import io.realm.annotations.PrimaryKey ; +import io.realm.annotations.Nullable ; /** * Utility class for holding metadata for RealmProxy classes . @ @ -55,6 +56,7 @ @ public class ClassMetaData { private List < String > fieldNames = new ArrayList < String > ( ) ; private List < String > ignoreFieldNames = new ArrayList < String > ( ) ; private List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private List < String > nullableFieldNames = new ArrayList < String > ( ) ; // list of all fields marked @ Nullable private Set < String > expectedGetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a getter private Set < String > expectedSetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a setter private Set < ExecutableElement > methods = new HashSet < ExecutableElement > ( ) ; Support for Null values __EoT__ I want to be able to soft-delete items with a created and a deleted field , both of which being Date fields . When I tried creating an object ( with no deleted flag ) , I received this error message : `` ` java.lang.IllegalArgumentException : Null Date is not allowed . at io.realm.internal.Row.setDate ( Row.java:195 ) at io.realm.RealmDataFileRealmProxy.setEnd ( RealmDataFileRealmProxy.java:53 ) `` ` Soft deletes like this are very common in databases , so it seems reasonable to support them . Are there any plans to support this already in the works ?
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 378bf42..8d77058 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -40,6 +40,7 @ @ import javax.lang.model.util.Types ; import io.realm.annotations.Ignore ; import io.realm.annotations.Index ; import io.realm.annotations.PrimaryKey ; +import io.realm.annotations.NotNullable ; /** * Utility class for holding metadata for RealmProxy classes . @ @ -55,6 +56,7 @ @ public class ClassMetaData { private List < String > fieldNames = new ArrayList < String > ( ) ; private List < String > ignoreFieldNames = new ArrayList < String > ( ) ; private List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private Set < VariableElement > nullableFieldNames = new HashSet < VariableElement > ( ) ; // Set of fields which can be nullable private Set < String > expectedGetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a getter private Set < String > expectedSetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a setter private Set < ExecutableElement > methods = new HashSet < ExecutableElement > ( ) ; Support for Null values __EoT__ I want to be able to soft-delete items with a created and a deleted field , both of which being Date fields . When I tried creating an object ( with no deleted flag ) , I received this error message : `` ` java.lang.IllegalArgumentException : Null Date is not allowed . at io.realm.internal.Row.setDate ( Row.java:195 ) at io.realm.RealmDataFileRealmProxy.setEnd ( RealmDataFileRealmProxy.java:53 ) `` ` Soft deletes like this are very common in databases , so it seems reasonable to support them . Are there any plans to support this already in the works ?
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 378bf42..13562d9 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -24,7 +24,6 @ @ import java.util.List ; import java.util.Map ; import java.util.Set ; -import javax.annotation.processing.Messager ; import javax.annotation.processing.ProcessingEnvironment ; import javax.lang.model.element.Element ; import javax.lang.model.element.ElementKind ; @ @ -40,6 +39,7 @ @ import javax.lang.model.util.Types ; import io.realm.annotations.Ignore ; import io.realm.annotations.Index ; import io.realm.annotations.PrimaryKey ; +import io.realm.annotations.NotNullable ; /** * Utility class for holding metadata for RealmProxy classes . @ @ -55,6 +55,7 @ @ public class ClassMetaData { private List < String > fieldNames = new ArrayList < String > ( ) ; private List < String > ignoreFieldNames = new ArrayList < String > ( ) ; private List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private Set < VariableElement > nullableElements = new HashSet < VariableElement > ( ) ; // Set of fields which can be nullable private Set < String > expectedGetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a getter private Set < String > expectedSetters = new HashSet < String > ( ) Support for Null values __EoT__ I want to be able to soft-delete items with a created and a deleted field , both of which being Date fields . When I tried creating an object ( with no deleted flag ) , I received this error message : `` ` java.lang.IllegalArgumentException : Null Date is not allowed . at io.realm.internal.Row.setDate ( Row.java:195 ) at io.realm.RealmDataFileRealmProxy.setEnd ( RealmDataFileRealmProxy.java:53 ) `` ` Soft deletes like this are very common in databases , so it seems reasonable to support them . Are there any plans to support this already in the works ?
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 896e142..7967b05 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -24,7 +24,6 @ @ import java.util.List ; import java.util.Map ; import java.util.Set ; -import javax.annotation.processing.Messager ; import javax.annotation.processing.ProcessingEnvironment ; import javax.lang.model.element.Element ; import javax.lang.model.element.ElementKind ; @ @ -41,6 +40,7 @ @ import javax.lang.model.util.Types ; import io.realm.annotations.Ignore ; import io.realm.annotations.Index ; import io.realm.annotations.PrimaryKey ; +import io.realm.annotations.NotNullable ; /** * Utility class for holding metadata for RealmProxy classes . @ @ -56,6 +56,7 @ @ public class ClassMetaData { private List < String > fieldNames = new ArrayList < String > ( ) ; private List < String > ignoreFieldNames = new ArrayList < String > ( ) ; private List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private Set < VariableElement > nullableElements = new HashSet < VariableElement > ( ) ; // Set of fields which can be nullable private Set < String > expectedGetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a getter private Set < String > expectedSetters = new HashSet < String > ( ) Support for Null values __EoT__ I want to be able to soft-delete items with a created and a deleted field , both of which being Date fields . When I tried creating an object ( with no deleted flag ) , I received this error message : `` ` java.lang.IllegalArgumentException : Null Date is not allowed . at io.realm.internal.Row.setDate ( Row.java:195 ) at io.realm.RealmDataFileRealmProxy.setEnd ( RealmDataFileRealmProxy.java:53 ) `` ` Soft deletes like this are very common in databases , so it seems reasonable to support them . Are there any plans to support this already in the works ?
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 374bb64..8d9238e 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -40,6 +40,11 @ @ import java.util.List ; import java.util.Map ; import java.util.Set ; +import io.realm.annotations.Ignore ; +import io.realm.annotations.Index ; +import io.realm.annotations.PrimaryKey ; +import io.realm.annotations.Required ; + /** * Utility class for holding metadata for RealmProxy classes . */ @ @ -54,6 +59,7 @ @ public class ClassMetaData { private List < String > fieldNames = new ArrayList < String > ( ) ; private List < String > ignoreFieldNames = new ArrayList < String > ( ) ; private List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private Set < VariableElement > nullableElements = new HashSet < VariableElement > ( ) ; // Set of fields which can be nullable private Set < String > expectedGetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a getter private Set < String > expectedSetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a setter private Set < ExecutableElement > methods = Support for Null values __EoT__ I want to be able to soft-delete items with a created and a deleted field , both of which being Date fields . When I tried creating an object ( with no deleted flag ) , I received this error message : `` ` java.lang.IllegalArgumentException : Null Date is not allowed . at io.realm.internal.Row.setDate ( Row.java:195 ) at io.realm.RealmDataFileRealmProxy.setEnd ( RealmDataFileRealmProxy.java:53 ) `` ` Soft deletes like this are very common in databases , so it seems reasonable to support them . Are there any plans to support this already in the works ?
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 374bb64..add406c 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -40,6 +40,11 @ @ import java.util.List ; import java.util.Map ; import java.util.Set ; +import io.realm.annotations.Ignore ; +import io.realm.annotations.Index ; +import io.realm.annotations.PrimaryKey ; +import io.realm.annotations.Required ; + /** * Utility class for holding metadata for RealmProxy classes . */ @ @ -54,6 +59,7 @ @ public class ClassMetaData { private List < String > fieldNames = new ArrayList < String > ( ) ; private List < String > ignoreFieldNames = new ArrayList < String > ( ) ; private List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private Set < VariableElement > nullableElements = new HashSet < VariableElement > ( ) ; // Set of fields which can be nullable private Set < String > expectedGetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a getter private Set < String > expectedSetters = new HashSet < String > ( ) ; // Set of fieldnames that are expected to have a setter private Set < ExecutableElement > methods = Support for Null values __EoT__ I want to be able to soft-delete items with a created and a deleted field , both of which being Date fields . When I tried creating an object ( with no deleted flag ) , I received this error message : `` ` java.lang.IllegalArgumentException : Null Date is not allowed . at io.realm.internal.Row.setDate ( Row.java:195 ) at io.realm.RealmDataFileRealmProxy.setEnd ( RealmDataFileRealmProxy.java:53 ) `` ` Soft deletes like this are very common in databases , so it seems reasonable to support them . Are there any plans to support this already in the works ?
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 374bb64..4922966 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -16,9 +16,13 @ @ package io.realm.processor ; -import io.realm.annotations.Ignore ; -import io.realm.annotations.Index ; -import io.realm.annotations.PrimaryKey ; +import java.util.ArrayList ; +import java.util.Arrays ; +import java.util.HashMap ; +import java.util.HashSet ; +import java.util.List ; +import java.util.Map ; +import java.util.Set ; import javax.annotation.processing.ProcessingEnvironment ; import javax.lang.model.element.Element ; @ @ -28,17 +32,14 @ @ import javax.lang.model.element.Modifier ; import javax.lang.model.element.PackageElement ; import javax.lang.model.element.TypeElement ; import javax.lang.model.element.VariableElement ; -import javax.lang.model.type.DeclaredType ; import javax.lang.model.type.TypeKind ; import javax.lang.model.type.TypeMirror ; import javax.lang.model.util.Types ; -import java.util.ArrayList ; -import java.util.Arrays ; -import java.util.HashMap ; -import java.util.HashSet ; -import java.util.List ; -import java.util.Map ; -import java.util.Set ; + +import io.realm.annotations.Ignore ; +import io.realm.annotations.Index ; +import io.realm.annotations.PrimaryKey ; +import io.realm.annotations.Required ; /** * Utility class for holding metadata for RealmProxy classes . @ @ -54,6 +55,7 @ @ public class ClassMetaData { private List < String > fieldNames = new ArrayList < String > ( ) ; private List < String > ignoreFieldNames = new ArrayList < String > ( ) ; private List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private Set Support for Null values __EoT__ I want to be able to soft-delete items with a created and a deleted field , both of which being Date fields . When I tried creating an object ( with no deleted flag ) , I received this error message : `` ` java.lang.IllegalArgumentException : Null Date is not allowed . at io.realm.internal.Row.setDate ( Row.java:195 ) at io.realm.RealmDataFileRealmProxy.setEnd ( RealmDataFileRealmProxy.java:53 ) `` ` Soft deletes like this are very common in databases , so it seems reasonable to support them . Are there any plans to support this already in the works ?
diff -- git a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 374bb64..d709f35 100644 -- - a/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -16,9 +16,13 @ @ package io.realm.processor ; -import io.realm.annotations.Ignore ; -import io.realm.annotations.Index ; -import io.realm.annotations.PrimaryKey ; +import java.util.ArrayList ; +import java.util.Arrays ; +import java.util.HashMap ; +import java.util.HashSet ; +import java.util.List ; +import java.util.Map ; +import java.util.Set ; import javax.annotation.processing.ProcessingEnvironment ; import javax.lang.model.element.Element ; @ @ -28,17 +32,14 @ @ import javax.lang.model.element.Modifier ; import javax.lang.model.element.PackageElement ; import javax.lang.model.element.TypeElement ; import javax.lang.model.element.VariableElement ; -import javax.lang.model.type.DeclaredType ; import javax.lang.model.type.TypeKind ; import javax.lang.model.type.TypeMirror ; import javax.lang.model.util.Types ; -import java.util.ArrayList ; -import java.util.Arrays ; -import java.util.HashMap ; -import java.util.HashSet ; -import java.util.List ; -import java.util.Map ; -import java.util.Set ; + +import io.realm.annotations.Ignore ; +import io.realm.annotations.Index ; +import io.realm.annotations.PrimaryKey ; +import io.realm.annotations.Required ; /** * Utility class for holding metadata for RealmProxy classes . @ @ -54,6 +55,7 @ @ public class ClassMetaData { private List < String > fieldNames = new ArrayList < String > ( ) ; private List < String > ignoreFieldNames = new ArrayList < String > ( ) ; private List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private Set Support for Null values __EoT__ I want to be able to soft-delete items with a created and a deleted field , both of which being Date fields . When I tried creating an object ( with no deleted flag ) , I received this error message : `` ` java.lang.IllegalArgumentException : Null Date is not allowed . at io.realm.internal.Row.setDate ( Row.java:195 ) at io.realm.RealmDataFileRealmProxy.setEnd ( RealmDataFileRealmProxy.java:53 ) `` ` Soft deletes like this are very common in databases , so it seems reasonable to support them . Are there any plans to support this already in the works ?
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 42942e6..ed83c17 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -15,6 +15,8 @ @ * Migration for linking objects is not yet supported . * Backlink verification is incomplete . Evil code can cause native crashes . * [ ObjectServer ] In case of a Client Reset , information about the location of the backed up Realm file is now reported through the ` ErrorHandler ` interface ( # 4080 ) . +* The listener on ` RealmObject ` will only be triggered if the object changes ( # 3894 ) . +* Added ` RealmObjectChangeListener ` to get detailed information about ` RealmObejct ` changes . # # # Bug Fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java index fd7d5d8..890c9e6 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java +++ b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java @ @ -28,7 +28,6 @ @ import junit.framework.AssertionFailedError ; import org.junit.After ; import org.junit.Before ; -import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -798,28 +797,6 @ @ public class NotificationsTest { } ) ; } - // TODO : Fix or delete this test after integration of object notification from Object Store - @ Test - @ RunTestInLooperThread - @ Ignore - public void Predictive UI animations and local transactions __EoT__ Without https : //github.com/realm/realm-java/issues/4225 , user will still meets the un-synced list views when doing local commit . Take below sequences for example : list - 10 items local commit delete the 1st item touch event comes , since the list is always live , list.size ( ) return 9 and did a refresh ( ) , everything is up to date fine grained notification comes , with deletion = [ 0 ] , 0 should be the index in the old collection , but now , since the list has been updated already , it will delete the 1st in the updated view , which is wrong The cocoa 's solution about this : https : //realm.io/docs/objc/latest/ # interface-driven-writes My thoughts , the current cocoa solution ( suppress the next chosen listener ) is still the best option : 1 . It avoids the overhead to trigger all other listeners on the same thread , which is not necessary when other list view is not in the front 2 . Not too complex to users , user just need to update the view according to what he changed in the local transaction
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 8d9ce2b..fd19f1c 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -120,7 +120,7 @ @ set ( WARNING_CXX_FLAGS `` -Wall -Wextra -pedantic -Wno-long-long -Wno-variadic-macr -Wno-missing-field-initializers -Wmissing-declarations -Wno-error=uninitialized -Wno-error=maybe-uninitialized '' ) set ( REALM_COMMON_CXX_FLAGS `` -DREALM_ANDROID -DREALM_HAVE_CONFIG -DPIC -pthread -fvisibility=hidden -std=c++14 -fsigned-char '' ) if ( build_SYNC ) - set ( REALM_COMMON_CXX_FLAGS `` $ { REALM_COMMON_CXX_FLAGS } -DREALM_SYNC '' ) + set ( REALM_COMMON_CXX_FLAGS `` $ { REALM_COMMON_CXX_FLAGS } -DREALM_SYNC -DREALM_ENABLE_SYNC '' ) endif ( ) # There might be an issue with -Os of ndk gcc 4.9 . It will hang the encryption related tests . # And this issue does n't seem to impact the core compiling . @ @ -162,13 +162,13 @ @ file ( GLOB objectstore_SRC `` object-store/src/impl/collection_change_builder.cpp '' `` object-store/src/impl/transact_log_handler.cpp '' `` object-store/src/impl/weak_realm_notifier.cpp '' - `` object-store/src/impl/android/*.cpp '' + `` object-store/src/impl/generic/*.cpp '' `` object-store/src/util/*.cpp '' ) + # Sync needed Object Store files if ( build_SYNC ) file ( GLOB objectstore_sync_SRC - `` object-store/src/sync_manager.cpp '' - `` object-store/src/sync_session.cpp '' ) + `` object-store/src/sync/*.cpp '' ) endif ( ) add_library ( realm-jni SHARED $ { jni_SRC } $ { objectstore_SRC } $ { objectstore_sync_SRC } ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_RealmSchema.cpp b/realm/realm-library/src/main/cpp/io_realm_RealmSchema.cpp index 98649ca..9c6f199 Access token should be refreshed before the current one expires __EoT__ I tested the 2.3.0 release with RealmTasks for Android and ROS 1.0.0 with the expiration time set to 60s . Right now , when the Android binding tries to send an UPLOAD message with and expired token , the server sends an error ( ` Sending : ERROR ( error_code=202 , message_size=20 , try_again=0 , session_ident=1 ) ` ) and closes the session . The client then connects to the auth server and gets a new token . **This behaviour is incorrect , the client should request an access token before the current access token expires and send a REFRESH message to the server , so that the session does not get disconnected . ** Not sure how much of this behaviour should be in object-store and how much in the binding . cc @ austinzheng @ mrackwitz
diff -- git a/realm/realm-library/proguard-rules-base.pro b/realm/realm-library/proguard-rules-base.pro index 26e4170..19a3b8d 100644 -- - a/realm/realm-library/proguard-rules-base.pro +++ b/realm/realm-library/proguard-rules-base.pro @ @ -1,2 +1,2 @ @ # It 's OK not to exist SyncObjectServerFacade in base library . -- dontnote io.realm.internal.objectserver.SyncObjectServerFacade +-dontnote io.realm.internal.SyncObjectServerFacade diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java index 66a072e..baa1828 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java @ @ -28,7 +28,6 @ @ import org.junit.runner.RunWith ; import io.realm.internal.network.AuthenticationServer ; import io.realm.internal.network.OkHttpAuthenticationServer ; -import io.realm.internal.objectserver.ObjectServerSession ; import io.realm.rule.TestRealmConfigurationFactory ; import static io.realm.util.SyncTestUtils.createTestUser ; @ @ -62,15 +61,7 @ @ public class SessionTests { @ Test public void get_syncValues ( ) { - ObjectServerSession internalSession = new ObjectServerSession ( - configuration , - authServer , - configuration.getUser ( ) .getSyncUser ( ) , - configuration.getSyncPolicy ( ) , - configuration.getErrorHandler ( ) - ) ; - SyncSession session = new SyncSession ( internalSession ) ; - + SyncSession session = new SyncSession ( configuration ) ; assertEquals ( `` realm : //objectserver.realm.io/JohnDoe/default '' , session.getServerUrl ( ) .toString ( ) ) ; assertEquals ( user , session.getUser ( ) ) ; assertEquals ( configuration , session.getConfiguration ( ) ) ; diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SyncConfigurationTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SyncConfigurationTests.java index a95159a..1a09220 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SyncConfigurationTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SyncConfigurationTests.java @ @ -34,6 +34,8 @ @ import Access token should be refreshed before the current one expires __EoT__ I tested the 2.3.0 release with RealmTasks for Android and ROS 1.0.0 with the expiration time set to 60s . Right now , when the Android binding tries to send an UPLOAD message with and expired token , the server sends an error ( ` Sending : ERROR ( error_code=202 , message_size=20 , try_again=0 , session_ident=1 ) ` ) and closes the session . The client then connects to the auth server and gets a new token . **This behaviour is incorrect , the client should request an access token before the current access token expires and send a REFRESH message to the server , so that the session does not get disconnected . ** Not sure how much of this behaviour should be in object-store and how much in the binding . cc @ austinzheng @ mrackwitz
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 88818ba..2da24ae 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -10,6 +10,7 @ @ # # # Internal +* Using the Object Store 's Session and SyncManager . # # 3.0.0 ( 2017-02-28 ) @ @ -31,7 +32,7 @ @ * Added support for sorting by link 's field ( # 672 ) . * Added ` OrderedRealmCollectionSnapshot ` class and ` OrderedRealmCollection.createSnapshot ( ) ` method . ` OrderedRealmCollectionSnapshot ` is useful when changing ` RealmResults ` or ` RealmList ` in simple loops . -* Added ` OrderedRealmCollectionChangeListener ` interface for supporting fine-grained collection notifications . +* Added ` OrderedRealmCollectionChangeListener ` interface for supporting fine-grained collection notifications . * Added support for ChangeListeners on ` RealmList ` . * Added ` RealmList.asObservable ( ) ` . diff -- git a/dependencies.list b/dependencies.list index f22053b..538519a 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -1,10 +1,13 @ @ # Realm Sync Core release used by Realm Java # https : //github.com/realm/realm-sync/releases -REALM_SYNC_VERSION=1.2.1 -REALM_SYNC_SHA256=b796433319e2574ea3cdb1b3dcda4e2311a2080f8e1563ea68a59b2cdac1d0a7 +REALM_SYNC_VERSION=1.3.0 +REALM_SYNC_SHA256=0572417435b92e3a9f7de5bd71ed00ca5d4ed24813afeffc7e4e7b7510a9f449 # Object Server Release used by Integration tests # ` realm ` is stable releases , ` realm-testing ` is developer builds . # https : //packagecloud.io/realm/realm ? filter=debs # https Access token should be refreshed before the current one expires __EoT__ I tested the 2.3.0 release with RealmTasks for Android and ROS 1.0.0 with the expiration time set to 60s . Right now , when the Android binding tries to send an UPLOAD message with and expired token , the server sends an error ( ` Sending : ERROR ( error_code=202 , message_size=20 , try_again=0 , session_ident=1 ) ` ) and closes the session . The client then connects to the auth server and gets a new token . **This behaviour is incorrect , the client should request an access token before the current access token expires and send a REFRESH message to the server , so that the session does not get disconnected . ** Not sure how much of this behaviour should be in object-store and how much in the binding . cc @ austinzheng @ mrackwitz
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 559e9a4..4bc3f4e 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 2.3.3 ( YY-MM-DD ) + + # # # Bug fixes + +* Throws ` IllegalStateException ` instead of process crash when any of thread confined methods in ` RealmQuery ` is called from wrong thread ( # 4228 ) . + # # 2.3.2 ( 2017-02-27 ) # # # Bug fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java index b1dbf6c..86793cf 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmQueryTests.java @ @ -26,6 +26,7 @ @ import org.junit.Test ; import org.junit.rules.ExpectedException ; import org.junit.runner.RunWith ; +import java.lang.reflect.Field ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Date ; @ @ -35,6 +36,7 @ @ import java.util.concurrent.ExecutorService ; import java.util.concurrent.Executors ; import java.util.concurrent.TimeUnit ; import java.util.concurrent.atomic.AtomicInteger ; +import java.util.concurrent.atomic.AtomicReference ; import io.realm.entities.AllJavaTypes ; import io.realm.entities.AllTypes ; @ @ -147,6 +149,291 @ @ public class RealmQueryTests { populateNoPrimaryKeyNullTypesRows ( realm , TEST_NO_PRIMARY_KEY_NULL_TYPES_SIZE ) ; } + private enum ThreadConfinedMethods { + EQUAL_TO_STRING , + EQUAL_TO_STRING_WITH_CASE , + EQUAL_TO_BYTE , + EQUAL_TO_BYTE_ARRAY , + EQUAL_TO_SHORT , + EQUAL_TO_INTEGER , + EQUAL_TO_LONG , + EQUAL_TO_DOUBLE , + EQUAL_TO_FLOAT , + EQUAL_TO_BOOLEAN , + EQUAL_TO_DATE , + + Do thread checking in ` RealmQuery ` __EoT__ Somehow most APIs in ` RealmQuery ` do n't do thread checking , so user can : ` RealmQuery q1 = realm.where ( ) ` in thread1 , then do ` q2.equalTo ( ) ` in thread2 .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 67fdd9e..edef77f 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -3,6 +3,7 @ @ # # # Enhancements * Now ` targetSdkVersion ` is 25 . +* Listeners on ` RealmList ` and ` RealmResults ` will be triggered immediately when the transaction is committed on the same thread ( # 4245 ) . # # # Bug Fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmListTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmListTests.java index 78fdc0e..0e195f1 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmListTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmListTests.java @ @ -1053,17 +1053,24 @ @ public class RealmListTests extends CollectionTests { fail ( ) ; } } ) ; - realm.beginTransaction ( ) ; - collection.get ( 0 ) .setAge ( 42 ) ; - realm.commitTransaction ( ) ; collection.removeAllChangeListeners ( ) ; + // This one is added after removal , so it should be triggered . + collection.addChangeListener ( new RealmChangeListener < RealmList < Dog > > ( ) { + @ Override + public void onChange ( RealmList < Dog > element ) { + listenerCalledCount.incrementAndGet ( ) ; + looperThread.testComplete ( ) ; + } + } ) ; + // This should trigger the listener if there is any . realm.beginTransaction ( ) ; - realm.cancelTransaction ( Support for suppressing specific listeners from writes __EoT__ Similar issue from cocoa : https : //github.com/realm/realm-cocoa/issues/3665 > The current fine-grained notifications approach makes it challenging to support scenarios where the UI is updated before the data model , rather than the reactive approach of the model being the canonical source of truth that the UI merely displays . The simplest motivating use-case is UITableView reordering ; when using the built-in functionality for dragging rows around the delegate is merely notified of changes already displayed in the UI , and re-applying those changes in the collection notification block after the Realm is committed will corrupt the order to the UITV . Because notifications are coalesced , users ca n't reasonably filter out these redundant updates themselves . and even if they could it would be very easy to get wrong . > We should expose a variant of ` Realm.write ( _ : ) ` that would specify that the transaction should not produce notifications on the current thread , as the things they want to update with the notifications are already up-to-date . In addition , this variant of write transactions would block until all async notifications are ready and
diff -- git a/.gitignore b/.gitignore index a72b66b..9153b3b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/CHANGELOG.md b/CHANGELOG.md index bacad0d..8f2f822 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 1.2.1 + + # # # Internal + +* Move JNI build to cmake . + # # 1.2.0 # # # Bug fixes diff -- git a/Dockerfile b/Dockerfile index 0029aae..c792350 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -9,7 +9,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' # Set the environment variables ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux -ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf Support android experimental plugin __EoT__ Question from SO : http : //stackoverflow.com/questions/36341822/run-realm-with-android-experimental-plugin What could be fixed in our side : in 'gradle-plugin/Realm.groovy ` check through the plugin name instead of the class . `` ` def isAndroidApp = project.plugins.hasPlugin ( `` com.android.application '' ) || project.plugins.hasPlugin ( `` com.android.model.application '' ) // Android experimental plugin def isAndroidLib = project.plugins.hasPlugin ( `` com.android.library '' ) || project.plugins.hasPlugin ( `` com.android.model.library '' ) // Android experimental plugin `` ` However , it will still fail because of the ` AndroidAptPlugin ` does n't support Android experimental plugin yet , see issue https : //bitbucket.org/hvisser/android-apt/issues/46/support-for-experimental-plugin
diff -- git a/.gitignore b/.gitignore index a72b66b..22df2e0 100644 -- - a/.gitignore +++ b/.gitignore @ @ -1,7 +1,6 @ @ # Gradle build artifacts build realm/build -realm-jni/build # Gradle cache .gradle @ @ -46,3 +45,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/CHANGELOG.md b/CHANGELOG.md index bacad0d..b0adb80 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,9 @ @ + # # 1.2.1 + + # # # Internal + +* Move JNI build to CMake . + # # 1.2.0 # # # Bug fixes diff -- git a/Dockerfile b/Dockerfile index 0029aae..43e0958 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -9,7 +9,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' # Set the environment variables ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux -ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd Support android experimental plugin __EoT__ Question from SO : http : //stackoverflow.com/questions/36341822/run-realm-with-android-experimental-plugin What could be fixed in our side : in 'gradle-plugin/Realm.groovy ` check through the plugin name instead of the class . `` ` def isAndroidApp = project.plugins.hasPlugin ( `` com.android.application '' ) || project.plugins.hasPlugin ( `` com.android.model.application '' ) // Android experimental plugin def isAndroidLib = project.plugins.hasPlugin ( `` com.android.library '' ) || project.plugins.hasPlugin ( `` com.android.model.library '' ) // Android experimental plugin `` ` However , it will still fail because of the ` AndroidAptPlugin ` does n't support Android experimental plugin yet , see issue https : //bitbucket.org/hvisser/android-apt/issues/46/support-for-experimental-plugin
diff -- git a/realm/src/androidTest/java/io/realm/RealmCursorTest.java b/realm/src/androidTest/java/io/realm/RealmCursorTest.java new file mode 100644 index 0000000..f108600 -- - /dev/null +++ b/realm/src/androidTest/java/io/realm/RealmCursorTest.java @ @ -0,0 +1,472 @ @ +/* + * Copyright 2014 Realm Inc. + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ + +package io.realm ; + +import android.database.CharArrayBuffer ; +import android.database.Cursor ; +import android.test.AndroidTestCase ; + +import java.util.Date ; + +import io.realm.android.RealmCursor ; +import io.realm.annotations.Index ; +import io.realm.entities.AllTypes ; +import io.realm.entities.Dog ; + +import static io.realm.internal.test.ExtraTests.assertArrayEquals ; + +public class RealmCursorTest extends AndroidTestCase { + + private static final int SIZE = Android component : RealmCursor __EoT__ Realm for Android looks awesome ; however there are some Android specific use cases where certain elements work better when backed by a Cursor ( http : //developer.android.com/reference/android/database/Cursor.html ) and when using a CursorLoader ( http : //developer.android.com/reference/android/content/CursorLoader.html ) . Is there any plans for supporting this interface ?
diff -- git a/CHANGELOG.md b/CHANGELOG.md index db45345..01c404f 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -15,6 +15,8 @ @ * Migration for linking objects is not yet supported . * Backlink verification is incomplete . Evil code can cause native crashes . * [ ObjectServer ] In case of a Client Reset , information about the location of the backed up Realm file is now reported through the ` ErrorHandler ` interface ( # 4080 ) . +* The listener on ` RealmObject ` will only be triggered if the object changes ( # 3894 ) . +* Added ` RealmObjectChangeListener ` to get detailed information about ` RealmObject ` changes . # # # Bug Fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java index 8e3f499..6bd270b 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java +++ b/realm/realm-library/src/androidTest/java/io/realm/NotificationsTest.java @ @ -28,7 +28,6 @ @ import junit.framework.AssertionFailedError ; import org.junit.After ; import org.junit.Before ; -import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -799,28 +798,6 @ @ public class NotificationsTest { } ) ; } - // TODO : Fix or delete this test after integration of object notification from Object Store - @ Test - @ RunTestInLooperThread - @ Ignore - public void Get a notification about deleted RealmObject __EoT__ `` ` java Realm realm = Realm.getDefaultInstance ( ) ; RealmResults < Item > items = realm.where ( Item.class ) .findAllAsync ( ) ; // items contain item with id = 1 items.addChangeListener ( new OrderedRealmCollectionChangeListener < RealmResults < Item > > ( ) { @ Override public void onChange ( RealmResults < Item > collection , OrderedCollectionChangeSet changeSet ) { OrderedCollectionChangeSet.Range [ ] deletions = changeSet.getDeletionRanges ( ) ; // deletions array contains item with id = 1 in range , but collection does not have this item } } ) ; realm.executeTransaction ( new Realm.Transaction ( ) { @ Override public void execute ( Realm realm ) { Item item = realm.where ( Item.class ) .equalTo ( Item.ID , 1 ) .findFirst ( ) ; item.deleteFromRealm ( ) ; } } ) ; `` ` The question is how to get deleted ` RealmObject ` ? ` collection ` does not have it , only index is received in ` getDeletionRanges ` ( it is ok for ` RecyclerView ` adapter , ` collection ` represents current db state ) . But how to get a notification about deleted ` RealmObject
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..d211177 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp index b15798d..e037db6 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp @ @ -32,6 +32,8 @ @ # include `` sync/sync_manager.hpp '' # endif + # include `` jni_util/hack.hpp '' + using namespace realm ; using namespace realm : :_impl ; @ @ -57,6 +59,8 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_SharedRealm_nativeInit ( JNIEnv* env { TR_ENTER ( ) + hack_init ( ) ; + try { JStringAccessor path ( env , temporary_directory_path ) ; // throws SharedGroupOptions : :set_sys_tmp_dir ( std : :string ( path ) ) ; // throws diff -- git a/realm/realm-library/src/main/cpp/jni_util/hack.cpp b/realm/realm-library/src/main/cpp/jni_util/hack.cpp new file mode 100644 index 0000000..d519183 -- - /dev/null +++ b/realm/realm-library/src/main/cpp/jni_util/hack.cpp @ @ Crash at Realm.getDefaultInstance ( ) __EoT__ I 'm using Realm in one of my projects . It works great on almost all the phones I tested except for **Samsung GT-I8200 ( Android 4.2.2 ) . ** The app crashes when requesting the default realm instance . Please note that I have n't encountered this crash on any other phones . My concern is that the same crash may exist on many other android devices that we have n't tested . I 'm using realm 2.2.1 . I also tested this use case against realm 2.0.2 . The same issue exist on both versions . Further , I ran a couple of Realm sample apps ( introExample and gridViewExample ) on the same device . Both apps crash at the same line ( Realm.getDefaultInstance ( ) ) . While debugging , I found out that actual crash happens inside SharedRealm.java file - line 236 - nativeSetVersion ( nativePtr , schemaVersion ) . Can you please any solution for this ? Thanks , Iranga
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 5913e18..0d2e955 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -143,7 +143,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove -Wl , -- wrap , memcpy '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp index 48e47cf..ab772f4 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp @ @ -17,6 +17,7 @ @ # include < jni.h > # include `` jni_util/jni_utils.hpp '' + # include `` jni_util/hack.hpp '' # include < realm/string_data.hpp > # include < realm/unicode.hpp > @ @ -37,6 +38,9 @ @ const string TABLE_PREFIX ( `` class_ '' ) ; JNIEXPORT jint JNICALL JNI_OnLoad ( JavaVM* vm , void* ) { + // Workaround for some known bugs in system calls on specific devices . + hack_init ( ) ; + JNIEnv* env ; if ( vm- > GetEnv ( ( void** ) & Crash at Realm.getDefaultInstance ( ) __EoT__ I 'm using Realm in one of my projects . It works great on almost all the phones I tested except for **Samsung GT-I8200 ( Android 4.2.2 ) . ** The app crashes when requesting the default realm instance . Please note that I have n't encountered this crash on any other phones . My concern is that the same crash may exist on many other android devices that we have n't tested . I 'm using realm 2.2.1 . I also tested this use case against realm 2.0.2 . The same issue exist on both versions . Further , I ran a couple of Realm sample apps ( introExample and gridViewExample ) on the same device . Both apps crash at the same line ( Realm.getDefaultInstance ( ) ) . While debugging , I found out that actual crash happens inside SharedRealm.java file - line 236 - nativeSetVersion ( nativePtr , schemaVersion ) . Can you please any solution for this ? Thanks , Iranga
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index e1ea070..1fa205f 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -1714,23 +1714,33 @ @ public class RealmProxyClassGenerator { } else if ( Utils.isRealmModelList ( field ) ) { final String genericType = Utils.getGenericTypeQualifiedName ( field ) ; writer - .emitStatement ( `` RealmList < % s > % sList = realmObjectSource. % s ( ) '' , genericType , fieldName , getter ) - .emitStatement ( `` RealmList < % s > % sRealmList = realmObjectTarget. % s ( ) '' , - genericType , fieldName , getter ) - .emitStatement ( `` % sRealmList.clear ( ) '' , fieldName ) - .beginControlFlow ( `` if ( % sList ! = null ) '' , fieldName ) + .emitStatement ( `` RealmList < % s > % sList = realmObjectSource. % s ( ) '' , genericType , fieldName , getter ) + .emitStatement ( `` RealmList < % s > % sRealmList = realmObjectTarget. % s ( ) '' , genericType , fieldName , getter ) + .beginControlFlow ( `` if ( % 1 $ sList ! = null & & % 1 $ sList.size ( ) == % 1 $ sRealmList.size ( ) Assigning own list unintentionally clears the list items . __EoT__ # # # # Goal ` model.setColumnRealmList ( model.getColumnRealmList ( ) ) ; ` should be no-op . # # # # Expected Results The list keeps its contents . # # # # Actual Results The items in the list is cleared . # # # # Steps & Code to Reproduce `` ` java @ Test public void assignOwnList ( ) { RealmList < AllTypesRealmModel > allTypesRealmModels = new RealmList < AllTypesRealmModel > ( ) ; AllTypesRealmModel allTypePojo ; for ( int i = 0 ; i < 2 ; i++ ) { allTypePojo = new AllTypesRealmModel ( ) ; allTypePojo.columnLong = i ; allTypesRealmModels.add ( allTypePojo ) ; } RealmModelWithRealmListOfRealmModel model = new RealmModelWithRealmListOfRealmModel ( ) ; model.setColumnRealmList ( allTypesRealmModels ) ; realm.beginTransaction ( ) ; model = realm.copyToRealm ( model ) ; realm.commitTransaction ( ) ; assertEquals ( 2 , model.getColumnRealmList ( ) .size ( ) ) ; realm.beginTransaction ( ) ; model.setColumnRealmList ( model.getColumnRealmList ( ) ) ; realm.commitTransaction ( ) ; assertEquals ( 2 , model.getColumnRealmList ( ) .size ( ) ) ; } `` ` # # # # Version of Realm and
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index e1ea070..a3e36f2 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -1287,21 +1287,32 @ @ public class RealmProxyClassGenerator { } else if ( Utils.isRealmModelList ( field ) ) { final String genericType = Utils.getGenericTypeQualifiedName ( field ) ; writer - .emitEmptyLine ( ) - .emitStatement ( `` OsList % 1 $ sOsList = new OsList ( table.getUncheckedRow ( rowIndex ) , columnInfo. % 1 $ sIndex ) '' , fieldName ) + .emitEmptyLine ( ) + .emitStatement ( `` OsList % 1 $ sOsList = new OsList ( table.getUncheckedRow ( rowIndex ) , columnInfo. % 1 $ sIndex ) '' , fieldName ) + .emitStatement ( `` RealmList < % s > % sList = ( ( % s ) object ) . % s ( ) '' , genericType , fieldName , interfaceName , getter ) + .beginControlFlow ( `` if ( % 1 $ sList ! = null & & % 1 $ sList.size ( ) == % 1 $ OssList.size ( ) ) '' , fieldName ) + .emitSingleLineComment ( `` For lists of equal lengths , we need to set each element directly as clearing the receiver list can be wrong if Assigning own list unintentionally clears the list items . __EoT__ # # # # Goal ` model.setColumnRealmList ( model.getColumnRealmList ( ) ) ; ` should be no-op . # # # # Expected Results The list keeps its contents . # # # # Actual Results The items in the list is cleared . # # # # Steps & Code to Reproduce `` ` java @ Test public void assignOwnList ( ) { RealmList < AllTypesRealmModel > allTypesRealmModels = new RealmList < AllTypesRealmModel > ( ) ; AllTypesRealmModel allTypePojo ; for ( int i = 0 ; i < 2 ; i++ ) { allTypePojo = new AllTypesRealmModel ( ) ; allTypePojo.columnLong = i ; allTypesRealmModels.add ( allTypePojo ) ; } RealmModelWithRealmListOfRealmModel model = new RealmModelWithRealmListOfRealmModel ( ) ; model.setColumnRealmList ( allTypesRealmModels ) ; realm.beginTransaction ( ) ; model = realm.copyToRealm ( model ) ; realm.commitTransaction ( ) ; assertEquals ( 2 , model.getColumnRealmList ( ) .size ( ) ) ; realm.beginTransaction ( ) ; model.setColumnRealmList ( model.getColumnRealmList ( ) ) ; realm.commitTransaction ( ) ; assertEquals ( 2 , model.getColumnRealmList ( ) .size ( ) ) ; } `` ` # # # # Version of Realm and
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 4b0c80c..7c9955b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -8,6 +8,8 @ @ # # Bug Fixes +* Assigning a managed object 's own list to itself would accidentally clear it ( # 5395 ) . + # # Internal # # Credits diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index e1ea070..8f289f2 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -477,12 +477,7 @ @ public class RealmProxyClassGenerator { .emitStatement ( `` row.nullifyLink ( % s ) '' , fieldIndexVariableReference ( field ) ) .emitStatement ( `` return '' ) .endControlFlow ( ) ; - writer.beginControlFlow ( `` if ( ! RealmObject.isValid ( value ) ) '' ) - .emitStatement ( `` throw new IllegalArgumentException ( \ '' 'value ' is not a valid managed object.\ '' ) '' ) - .endControlFlow ( ) ; - writer.beginControlFlow ( `` if ( ( ( RealmObjectProxy ) value ) .realmGet $ proxyState ( ) .getRealm $ realm ( ) ! = proxyState.getRealm $ realm ( ) ) '' ) - .emitStatement ( `` throw new IllegalArgumentException ( \ '' 'value ' belongs to a different Realm.\ '' ) '' ) - .endControlFlow ( ) ; + writer.emitStatement ( `` Assigning own list unintentionally clears the list items . __EoT__ # # # # Goal ` model.setColumnRealmList ( model.getColumnRealmList ( ) ) ; ` should be no-op . # # # # Expected Results The list keeps its contents . # # # # Actual Results The items in the list is cleared . # # # # Steps & Code to Reproduce `` ` java @ Test public void assignOwnList ( ) { RealmList < AllTypesRealmModel > allTypesRealmModels = new RealmList < AllTypesRealmModel > ( ) ; AllTypesRealmModel allTypePojo ; for ( int i = 0 ; i < 2 ; i++ ) { allTypePojo = new AllTypesRealmModel ( ) ; allTypePojo.columnLong = i ; allTypesRealmModels.add ( allTypePojo ) ; } RealmModelWithRealmListOfRealmModel model = new RealmModelWithRealmListOfRealmModel ( ) ; model.setColumnRealmList ( allTypesRealmModels ) ; realm.beginTransaction ( ) ; model = realm.copyToRealm ( model ) ; realm.commitTransaction ( ) ; assertEquals ( 2 , model.getColumnRealmList ( ) .size ( ) ) ; realm.beginTransaction ( ) ; model.setColumnRealmList ( model.getColumnRealmList ( ) ) ; realm.commitTransaction ( ) ; assertEquals ( 2 , model.getColumnRealmList ( ) .size ( ) ) ; } `` ` # # # # Version of Realm and
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 4b0c80c..7c9955b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -8,6 +8,8 @ @ # # Bug Fixes +* Assigning a managed object 's own list to itself would accidentally clear it ( # 5395 ) . + # # Internal # # Credits diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index e1ea070..8f289f2 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -477,12 +477,7 @ @ public class RealmProxyClassGenerator { .emitStatement ( `` row.nullifyLink ( % s ) '' , fieldIndexVariableReference ( field ) ) .emitStatement ( `` return '' ) .endControlFlow ( ) ; - writer.beginControlFlow ( `` if ( ! RealmObject.isValid ( value ) ) '' ) - .emitStatement ( `` throw new IllegalArgumentException ( \ '' 'value ' is not a valid managed object.\ '' ) '' ) - .endControlFlow ( ) ; - writer.beginControlFlow ( `` if ( ( ( RealmObjectProxy ) value ) .realmGet $ proxyState ( ) .getRealm $ realm ( ) ! = proxyState.getRealm $ realm ( ) ) '' ) - .emitStatement ( `` throw new IllegalArgumentException ( \ '' 'value ' belongs to a different Realm.\ '' ) '' ) - .endControlFlow ( ) ; + writer.emitStatement ( `` Assigning own list unintentionally clears the list items . __EoT__ # # # # Goal ` model.setColumnRealmList ( model.getColumnRealmList ( ) ) ; ` should be no-op . # # # # Expected Results The list keeps its contents . # # # # Actual Results The items in the list is cleared . # # # # Steps & Code to Reproduce `` ` java @ Test public void assignOwnList ( ) { RealmList < AllTypesRealmModel > allTypesRealmModels = new RealmList < AllTypesRealmModel > ( ) ; AllTypesRealmModel allTypePojo ; for ( int i = 0 ; i < 2 ; i++ ) { allTypePojo = new AllTypesRealmModel ( ) ; allTypePojo.columnLong = i ; allTypesRealmModels.add ( allTypePojo ) ; } RealmModelWithRealmListOfRealmModel model = new RealmModelWithRealmListOfRealmModel ( ) ; model.setColumnRealmList ( allTypesRealmModels ) ; realm.beginTransaction ( ) ; model = realm.copyToRealm ( model ) ; realm.commitTransaction ( ) ; assertEquals ( 2 , model.getColumnRealmList ( ) .size ( ) ) ; realm.beginTransaction ( ) ; model.setColumnRealmList ( model.getColumnRealmList ( ) ) ; realm.commitTransaction ( ) ; assertEquals ( 2 , model.getColumnRealmList ( ) .size ( ) ) ; } `` ` # # # # Version of Realm and
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 4b0c80c..7c9955b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -8,6 +8,8 @ @ # # Bug Fixes +* Assigning a managed object 's own list to itself would accidentally clear it ( # 5395 ) . + # # Internal # # Credits diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index e1ea070..6e76c2e 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -477,12 +477,7 @ @ public class RealmProxyClassGenerator { .emitStatement ( `` row.nullifyLink ( % s ) '' , fieldIndexVariableReference ( field ) ) .emitStatement ( `` return '' ) .endControlFlow ( ) ; - writer.beginControlFlow ( `` if ( ! RealmObject.isValid ( value ) ) '' ) - .emitStatement ( `` throw new IllegalArgumentException ( \ '' 'value ' is not a valid managed object.\ '' ) '' ) - .endControlFlow ( ) ; - writer.beginControlFlow ( `` if ( ( ( RealmObjectProxy ) value ) .realmGet $ proxyState ( ) .getRealm $ realm ( ) ! = proxyState.getRealm $ realm ( ) ) '' ) - .emitStatement ( `` throw new IllegalArgumentException ( \ '' 'value ' belongs to a different Realm.\ '' ) '' ) - .endControlFlow ( ) ; + writer.emitStatement ( `` Assigning own list unintentionally clears the list items . __EoT__ # # # # Goal ` model.setColumnRealmList ( model.getColumnRealmList ( ) ) ; ` should be no-op . # # # # Expected Results The list keeps its contents . # # # # Actual Results The items in the list is cleared . # # # # Steps & Code to Reproduce `` ` java @ Test public void assignOwnList ( ) { RealmList < AllTypesRealmModel > allTypesRealmModels = new RealmList < AllTypesRealmModel > ( ) ; AllTypesRealmModel allTypePojo ; for ( int i = 0 ; i < 2 ; i++ ) { allTypePojo = new AllTypesRealmModel ( ) ; allTypePojo.columnLong = i ; allTypesRealmModels.add ( allTypePojo ) ; } RealmModelWithRealmListOfRealmModel model = new RealmModelWithRealmListOfRealmModel ( ) ; model.setColumnRealmList ( allTypesRealmModels ) ; realm.beginTransaction ( ) ; model = realm.copyToRealm ( model ) ; realm.commitTransaction ( ) ; assertEquals ( 2 , model.getColumnRealmList ( ) .size ( ) ) ; realm.beginTransaction ( ) ; model.setColumnRealmList ( model.getColumnRealmList ( ) ) ; realm.commitTransaction ( ) ; assertEquals ( 2 , model.getColumnRealmList ( ) .size ( ) ) ; } `` ` # # # # Version of Realm and
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 70fa458..1629abd 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -2,6 +2,8 @ @ # # # Breaking Changes +* An ` IllegalStateException ` will be thrown if the given ` RealmModule ` does n't include all required object schemas ( # 3398 ) . + # # # Enhancements * Added support for querying inverse relationships ( # 2904 ) . @ @ -15,7 +17,8 @ @ # # # Internal -* Factor out internal interface ManagedObject +* Factor out internal interface ManagedObject . +* Use Object Store to do table initialization . # # 3.3.1 ( 2017-05-26 ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index b22fc4f..d4093ae 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -70,14 +70,14 @ @ public class RealmProxyClassGenerator { imports.add ( `` android.os.Build '' ) ; imports.add ( `` android.util.JsonReader '' ) ; imports.add ( `` android.util.JsonToken '' ) ; - imports.add ( `` io.realm.RealmObjectSchema '' ) ; - imports.add ( `` io.realm.RealmSchema '' ) ; imports.add ( `` io.realm.exceptions.RealmMigrationNeededException '' ) ; imports.add ( `` io.realm.internal.ColumnInfo '' ) ; imports.add ( `` io.realm.internal.RealmObjectProxy '' ) ; imports.add ( `` io.realm.internal.Row '' ) ; imports.add ( `` io.realm.internal.Table '' ) ; Move the Java bindings to use ObjectStore schema __EoT__ This will allow removing boatloads of code from Proxy table initialization and verification .
diff -- git a/realm/realm-jni/object-store/.gitignore b/realm/realm-jni/object-store/.gitignore new file mode 100644 index 0000000..3ea88b2 -- - /dev/null +++ b/realm/realm-jni/object-store/.gitignore @ @ -0,0 +1,14 @ @ + # CMake +.ninja_deps +.ninja_log +CMakeCache.txt +CMakeFiles/ +Makefile +build.ninja +cmake_install.cmake +rules.ninja + + # Build products +src/librealm-object-store.dylib +src/librealm-object-store-static.a +tests/tests diff -- git a/realm/realm-jni/object-store/.gitmodules b/realm/realm-jni/object-store/.gitmodules new file mode 100644 index 0000000..44b8f2a -- - /dev/null +++ b/realm/realm-jni/object-store/.gitmodules @ @ -0,0 +1,6 @ @ + [ submodule `` external/pegtl '' ] + path = external/pegtl + url = https : //github.com/ColinH/PEGTL + [ submodule `` external/catch '' ] + path = external/catch + url = https : //github.com/philsquared/Catch diff -- git a/realm/realm-jni/object-store/CMake/CodeCoverage.cmake b/realm/realm-jni/object-store/CMake/CodeCoverage.cmake new file mode 100644 index 0000000..b830828 -- - /dev/null +++ b/realm/realm-jni/object-store/CMake/CodeCoverage.cmake @ @ -0,0 +1,49 @ @ +find_program ( LCOV_PATH lcov ) +find_program ( GENHTML_PATH genhtml ) +find_program ( GCOVR_PATH gcovr PATHS $ { CMAKE_SOURCE_DIR } /tests ) + +set ( CMAKE_CXX_FLAGS_COVERAGE `` -g -O0 -fprofile-arcs -ftest-coverage '' + CACHE STRING `` Flags used by the C++ compiler during coverage builds . '' ) +mark_as_advanced ( CMAKE_CXX_FLAGS_COVERAGE ) + +if ( CMAKE_BUILD_TYPE STREQUAL `` Coverage '' ) + if ( NOT ( LCOV_PATH AND GENHTML_PATH AND GCOVR_PATH ) ) + message ( FATAL_ERROR `` Generating a coverage report Move the Java bindings to use ObjectStore schema __EoT__ This will allow removing boatloads of code from Proxy table initialization and verification .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index b19667c..3c85108 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK RUN echo y | android update sdk Move the Java bindings to use ObjectStore schema __EoT__ This will allow removing boatloads of code from Proxy table initialization and verification .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index 80421d0..1cd1d11 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ updates tools to at least Move the Java bindings to use ObjectStore schema __EoT__ This will allow removing boatloads of code from Proxy table initialization and verification .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index 80421d0..1cd1d11 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ updates tools to at least Move the Java bindings to use ObjectStore schema __EoT__ This will allow removing boatloads of code from Proxy table initialization and verification .
diff -- git a/.gitignore b/.gitignore index a72b66b..9b8aa3c 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,7 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution diff -- git a/Dockerfile b/Dockerfile index 80421d0..1cd1d11 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -25,9 +27,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN cd /opt & & wget -q https : //dl.google.com/android/repository/tools_r25.1.7-linux.zip -O android-tools-linux.zip +RUN cd /opt & & unzip android-tools-linux.zip -d $ { ANDROID_HOME } +RUN cd /opt & & rm -f android-tools-linux.zip # Grab what 's needed in the SDK # ↓ updates tools to at least Move the Java bindings to use ObjectStore schema __EoT__ This will allow removing boatloads of code from Proxy table initialization and verification .
diff -- git a/.gitignore b/.gitignore index a72b66b..9153b3b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/.gitmodules b/.gitmodules new file mode 100644 index 0000000..50b6ce8 -- - /dev/null +++ b/.gitmodules @ @ -0,0 +1,3 @ @ + [ submodule `` realm/realm-library/src/main/cpp/object-store '' ] + path = realm/realm-library/src/main/cpp/object-store + url = git @ github.com : realm/realm-object-store.git diff -- git a/Dockerfile b/Dockerfile index 0029aae..7aee9b3 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +28,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN Move the Java bindings to use ObjectStore schema __EoT__ This will allow removing boatloads of code from Proxy table initialization and verification .
diff -- git a/.gitignore b/.gitignore index a72b66b..9153b3b 100644 -- - a/.gitignore +++ b/.gitignore @ @ -46,3 +46,9 @ @ distribution/RealmGridViewExample/app/src distribution/RealmIntroExample/app/src distribution/RealmMigrationExample/app/src + # Generated JNI headers +realm/realm-library/src/main/cpp/jni_include + # Downloaded core +realm/realm-library/distribution + # Cmake output +realm/realm-library/.externalNativeBuild diff -- git a/.gitmodules b/.gitmodules new file mode 100644 index 0000000..50b6ce8 -- - /dev/null +++ b/.gitmodules @ @ -0,0 +1,3 @ @ + [ submodule `` realm/realm-library/src/main/cpp/object-store '' ] + path = realm/realm-library/src/main/cpp/object-store + url = git @ github.com : realm/realm-object-store.git diff -- git a/Dockerfile b/Dockerfile index 0029aae..7aee9b3 100644 -- - a/Dockerfile +++ b/Dockerfile @ @ -10,6 +10,8 @ @ ENV LC_ALL `` en_US.UTF-8 '' ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64 ENV ANDROID_HOME /opt/android-sdk-linux ENV NDK_HOME /opt/android-ndk + # Need by cmake +ENV ANDROID_NDK_HOME /opt/android-ndk ENV PATH $ { PATH } : $ { ANDROID_HOME } /tools : $ { ANDROID_HOME } /platform-tools ENV PATH $ { PATH } : $ { NDK_HOME } @ @ -26,9 +28,9 @ @ RUN DEBIAN_FRONTEND=noninteractive dpkg -- add-architecture i386 \ & & apt-get clean # Install the Android SDK -RUN cd /opt & & wget -q https : //dl.google.com/android/android-sdk_r24.4.1-linux.tgz -O android-sdk.tgz -RUN cd /opt & & tar -xvzf android-sdk.tgz -RUN cd /opt & & rm -f android-sdk.tgz +RUN Move the Java bindings to use ObjectStore schema __EoT__ This will allow removing boatloads of code from Proxy table initialization and verification .
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index e13bbc4..94fed80 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -373,6 +373,23 @ @ public class ClassMetaData { return nullableFields.contains ( variableElement ) ; } + /** + * Checks if a VariableElement is indexed . + * + * @ param variableElement the element/field + * @ return { @ code true } if a VariableElement is indexed , { @ code false } otherwise . + */ + public boolean isIndexed ( VariableElement variableElement ) { + return indexedFields.contains ( variableElement ) ; + } + + public boolean isPrimaryKey ( VariableElement variableElement ) { + if ( primaryKey == null ) { + return false ; + } + return primaryKey.equals ( variableElement ) ; + } + private boolean isValidPrimaryKeyType ( TypeMirror type ) { for ( TypeMirror validType : validPrimaryKeyTypes ) { if ( typeUtils.isAssignable ( type , validType ) ) { diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index 8d1e445..394a243 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -107,6 +107,7 @ @ public class RealmProxyClassGenerator { emitConstructor ( writer ) ; emitAccessors ( writer ) ; emitInitTableMethod ( writer ) ; + emitCreateRealmObjectSchemaMethod ( writer ) ; emitValidateTableMethod ( writer ) Move the Java bindings to use ObjectStore schema __EoT__ This will allow removing boatloads of code from Proxy table initialization and verification .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 3133d7f..58261d0 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,19 @ @ + # # 5.0.0 ( YYYY-MM-DD ) + + # # # Breaking Changes + +* The ` OrderedCollectionChangeSet ` parameter in ` OrderedRealmCollectionChangeListener.onChange ( ) ` is no longer nullable . Use ` changeSet.getState ( ) ` instead ( # 5619 ) . + + # # # Enhancements + +* [ ObjectServer ] Added support for partial Realms . Read [ here ] ( https : //realm.io/docs/java/latest/ # partial-realms ) for more information . +* Added two new methods to ` OrderedCollectionChangeSet ` : ` getState ( ) ` and ` getError ( ) ` ( # 5619 ) . + + # # # Internal + +* Upgraded to Realm Sync 2.2.2 . + + # # 4.3.2 ( YYYY-MM-DD ) # # # Bug Fixes diff -- git a/realm/realm-library/src/androidTest/java/io/realm/OrderedCollectionChangeSetTests.java b/realm/realm-library/src/androidTest/java/io/realm/OrderedCollectionChangeSetTests.java index a8e0b87..267860f 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/OrderedCollectionChangeSetTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/OrderedCollectionChangeSetTests.java @ @ -36,11 +36,11 @ @ import io.realm.rule.TestRealmConfigurationFactory ; import static junit.framework.Assert.assertEquals ; import static junit.framework.Assert.assertNotNull ; -import static junit.framework.Assert.assertNull ; import static junit.framework.Assert.assertSame ; import static junit.framework.Assert.fail ; import static org.junit.Assert.assertArrayEquals ; import static org.junit.Assert.assertNotEquals ; +import static Partial Sync : Unsubscribe named queries __EoT__ See https : //github.com/realm/product/issues/391 for details
diff -- git a/README.md b/README.md index 0665c1e..9d29fd3 100644 -- - a/README.md +++ b/README.md @ @ -38,7 +38,7 @ @ If you want to test recent bugfixes or features that have not been packaged in a } dependencies { - compile 'io.realm : realm-android:0.83.0-SNAPSHOT' + compile 'io.realm : realm-android:0.82.1-SNAPSHOT' } # # Building Realm diff -- git a/changelog.txt b/changelog.txt index 661e2bb..1ee1792 100644 -- - a/changelog.txt +++ b/changelog.txt @ @ -1,5 +1,4 @ @ -0.83 - * BREAKING CHANGE : Removed deprecated methods and constructors from the Realm class . +0.82.2 * Fixed a bug which might cause failure when loading the native library . * Fixed a bug which might trigger a timeout in Context.finalize ( ) . * Fixed a bug which might cause RealmObject.isValid ( ) to throw an exception if the object is deleted . @ @ -16,7 +15,7 @ @ * Closing realm on another thread different from where it was created now throws an exception . * Realm will now throw a RealmError when Realm 's underlying storage engine encounters an unrecoverable error . * @ Index annotation can also be applied to byte/short/int/long/boolean/Date now . - * BREAKING CHANGE : Fields with annotation @ PrimaryKey Crash on 2database access with encryption enabled __EoT__ Taking my comment from # 810 and making it its own issue - On one of my test devices , running realm with encryption enabled produces a SIGSERV in libc . The line causing the crash is ` validateMethod = generatedClass.getMethod ( `` validateTable '' , new Class [ ] { ImplicitTransaction.class } ) ; ` , in initializeRealm in Realm.java ( line 606 in 0.79.1 ) . Notably the crash is not happening on the first initializeRealm is called , only on any subsequent time . The device with the issue is a Droid X running Android 4.4.4 - notable in that it is a [ Low Ram ] ( https : //source.android.com/devices/tech/low-ram.html ) device . The issue does not happen if encryption is disabled ( so I 've only tested its presence on 0.78 and 0.79.1 ) .
diff -- git a/README.md b/README.md index 0665c1e..9d29fd3 100644 -- - a/README.md +++ b/README.md @ @ -38,7 +38,7 @ @ If you want to test recent bugfixes or features that have not been packaged in a } dependencies { - compile 'io.realm : realm-android:0.83.0-SNAPSHOT' + compile 'io.realm : realm-android:0.82.1-SNAPSHOT' } # # Building Realm diff -- git a/changelog.txt b/changelog.txt index 661e2bb..49c42cf 100644 -- - a/changelog.txt +++ b/changelog.txt @ @ -1,8 +1,11 @ @ -0.83 - * BREAKING CHANGE : Removed deprecated methods and constructors from the Realm class . +0.82.2 * Fixed a bug which might cause failure when loading the native library . * Fixed a bug which might trigger a timeout in Context.finalize ( ) . * Fixed a bug which might cause RealmObject.isValid ( ) to throw an exception if the object is deleted . + * Updated Realm core to version 0.89.9 + - Fixed a potential stack overflow issue which might cause a crash when encryption was used . + - Embedded crypto functions into Realm dynamic lib to avoid random issues on some devices . + - Throw RealmEncryptionNotSupportedException if the device does n't support Realm encryption . At least one device type ( HTX Crash on 2database access with encryption enabled __EoT__ Taking my comment from # 810 and making it its own issue - On one of my test devices , running realm with encryption enabled produces a SIGSERV in libc . The line causing the crash is ` validateMethod = generatedClass.getMethod ( `` validateTable '' , new Class [ ] { ImplicitTransaction.class } ) ; ` , in initializeRealm in Realm.java ( line 606 in 0.79.1 ) . Notably the crash is not happening on the first initializeRealm is called , only on any subsequent time . The device with the issue is a Droid X running Android 4.4.4 - notable in that it is a [ Low Ram ] ( https : //source.android.com/devices/tech/low-ram.html ) device . The issue does not happen if encryption is disabled ( so I 've only tested its presence on 0.78 and 0.79.1 ) .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 0499dde..06f5b81 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,5 +1,9 @ @ # # 2.3.2 + # # # Bug fixes + +* Fixed log levelis in JNI layer ( # 4204 ) . + # # # Internal * Updated to Realm Sync v1.0.4 . diff -- git a/realm/realm-library/src/main/cpp/jni_util/log.hpp b/realm/realm-library/src/main/cpp/jni_util/log.hpp index ad29c6e..930fe81 100644 -- - a/realm/realm-library/src/main/cpp/jni_util/log.hpp +++ b/realm/realm-library/src/main/cpp/jni_util/log.hpp @ @ -87,19 +87,19 @ @ public : // Helper functions for logging with REALM_JNI tag . inline static void t ( const char* message ) { - shared ( ) .log ( error , REALM_JNI_TAG , nullptr , message ) ; + shared ( ) .log ( trace , REALM_JNI_TAG , nullptr , message ) ; } inline static void d ( const char* message ) { - shared ( ) .log ( error , REALM_JNI_TAG , nullptr , message ) ; + shared ( ) .log ( debug , REALM_JNI_TAG , nullptr , message ) ; } inline static void i ( const char* message ) { - shared ( ) .log ( error , REALM_JNI_TAG , nullptr , message ) ; + shared ( ) .log ( info , REALM_JNI_TAG , Fix JNI logging method level __EoT__ Currently all method uses the same level ` io_realm_log_LogLevel_ERROR ` https : //github.com/realm/realm-java/blob/fb677d98bd0c329115295d139d3fe44f3b5e5ac5/realm/realm-library/src/main/cpp/jni_util/log.hpp # L88-L108
diff -- git a/rfcs/import-export-api.md b/rfcs/import-export-api.md new file mode 100644 index 0000000..0d97d70 -- - /dev/null +++ b/rfcs/import-export-api.md @ @ -0,0 +1,243 @ @ + # Import / Export API + +This document describe a possible new Import/Export API that is more generalized +than our current JSON support and is intended to replace it . + + # # Motivation + +Currently Realm Java exposes a number of JSON methods ( 12 ) for importing JSON +data into Realm . These works fine , but are limited in functionality plus they +bloat our public API quite considerably as well as adding a fair amount of code +to our proxy classes . + +There is general agreement internally that Realm Java should not be a full JSON +parser . Other JSON libraries are much more focused , better tested and with more +features . The tipping point was https : //github.com/realm/realm-java/issues/1470 , +which we all agree is a very useful feature , but also a slippery slope for +turning into a full-fledged JSON library . + +So instead of just keep piling features onto our JSON support we would much +rather look at this from a broader perspective of getting data in and JSON API v2 __EoT__ Design and implement a more complete solution for our JSON API . Current design doc is here : https : //github.com/cmelchior/realm-java/blob/29ab93bf7aeaa5cd048cbf468a228046496ecb13/json_api.md Other features : **Strict mode : ** We should probably consider adding something like STRICT mode to our JSON parser which could throw an exception when encountering JSON properties it did n't recognise . At least for debugging it could save a lot of time . **Json export** It should also be possible to convert any RealmObjects to JSON .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index a7fd677..1d3b0ce 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -5,6 +5,7 @ @ * Those were not kept by ProGuard : names of native methods not in the ` io.realm.internal ` package , names of classes used in method signature ( # 3596 ) . * Missing ProGuard configuration for libraries used by Sync extension ( # 3596 ) . * Error handler was not called when sync session failed ( # 3597 ) . +* Permission error when a database file is located at external storage ( # 3140 ) . # # # Enhancements diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java index a920574..00c34de 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java @ @ -31,6 +31,7 @ @ import org.json.JSONArray ; import org.json.JSONException ; import org.json.JSONObject ; import org.junit.After ; +import org.junit.Assume ; import org.junit.Before ; import org.junit.Ignore ; import org.junit.Rule ; @ @ -3811,4 +3812,38 @ @ public class RealmTests { realm.close ( ) ; assertEquals ( 0 , Realm.getGlobalInstanceCount ( config ) ) ; } + + @ Test + public void namedPipeDirForExternalStorage ( ) { + + // test for https : //github.com/realm/realm-java/issues/3140 + realm.close ( ) ; + realm = null ; + List < CustomObject > or List < List.. < CsuomObj > > convert to string using Gson and DB migration __EoT__ Hello , We are trying to migrate our DB from DB40 to Realm as we see many procs and support . Here are the observations that we found in migration , then will talk about issue that we are facing . `` ` - DB40 will have a plain models where the serialization and de-serialization is straight forward with the Gson or Jackson etc.. - We have to createObj for every instance to save in DB . - Nested ReleamList and List are bit confused . - JSON Serialization and De-serialization is not straight forward ( using Gson ) using Gson.toJson ( ) , Gson.fromJson ( ) . - Our DB modules are Plain Models , changing to Releam is bit difficult . Though its called as Migration : ) ... we have to have a considerable amount of efforts for the migration ( fingers crossed ) . `` ` The common Gson builder will not work in our case we have to have a Gson module to avoid StackOverflow . I am using `` gson:2.7 '' and here
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 165b014..d6fd7b3 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -2,11 +2,12 @ @ # # # Breaking changes +* All JSON methods on Realm now only wraps JSONException in RealmException . All other Exceptions are thrown as they are . * Removed ` HandlerController ` from the public API . # # # Deprecated -* ` RealmConfiguration.setModules ( ) ` . Use ` RealmConfiguration.modules ( ) ` instead . +* ` RealmConfiguration.setModules ( ) ` . Use ` RealmConfiguration.modules ( ) ` insteasd . # # # Enhancements diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmJsonTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmJsonTests.java index 1d44baa..6aec097 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmJsonTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmJsonTests.java @ @ -1171,71 +1171,90 @ @ public class RealmJsonTests { try { realm.createObjectFromJson ( NullTypes.class , array.getJSONObject ( 0 ) ) ; fail ( ) ; - } catch ( RealmException expected ) { - assertTrue ( expected.getCause ( ) instanceof IllegalArgumentException ) ; + } catch ( IllegalArgumentException ignored ) { + } catch ( Exception e ) { + fail ( `` Unexpected exception : `` + e ) ; } + // 2 Bytes try { realm.createObjectFromJson ( NullTypes.class , array.getJSONObject ( 1 ) ) ; fail ( ) ; API review & cleanup for 1.0 __EoT__ The following things should be implemented : - [ x ] JSON methods currently wrap all runtime exceptions in a RealmException . Consider removing this as it makes it hard to know exactly what failed - > Remove RealmException where possible . ( # 2618 ) - [ x ] Cleanup sorted\* methods . Remove all sort methods accepting 3 fields . Multiarg should be used instead . ( # 2619 ) - [ x ] Remove ` allObjects ` and friends from Realm so all query options are in RealmQuery . ( # 2620 ) - [ x ] RealmConfiguration ` setModules ( ) ` rename to ` modules ( ) ` ( # 2621 ) - [ X ] All lists methods should automatically do ` copyToRealm ` or ` copyToRealmOrUpdate ` ( mc Checked , all methods which could add/change object in the list , will call ` copyToRealmIfNeeded ` ) - [ x ] RealmChangeListener should provide the changes object/realm/collection as well ( # 2705 ) - [ x ] realm.createObject ( class , primaryKey ) should be public ( # 2622 ) - [ x ] All methods
diff -- git a/realm/realm-jni/src/io_realm_internal_TableView.h b/realm/realm-jni/src/io_realm_internal_TableView.h index 63c986e..4afb233 100644 -- - a/realm/realm-jni/src/io_realm_internal_TableView.h +++ b/realm/realm-jni/src/io_realm_internal_TableView.h @ @ -561,10 +561,10 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_TableView_nativePivot /* * Class : io_realm_internal_TableView - * Method : nativeSync + * Method : nativeSyncIfNeeded * Signature : ( J ) J */ -JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSync +JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSyncIfNeeded ( JNIEnv * , jobject , jlong ) ; /* diff -- git a/realm/realm-jni/src/io_realm_internal_tableview.cpp b/realm/realm-jni/src/io_realm_internal_tableview.cpp index 93d2fd0..0b3fb74 100644 -- - a/realm/realm-jni/src/io_realm_internal_tableview.cpp +++ b/realm/realm-jni/src/io_realm_internal_tableview.cpp @ @ -34,7 +34,12 @ @ inline bool view_valid_and_in_sync ( JNIEnv* env , jlong nativeViewPtr ) { ThrowException ( env , TableInvalid , `` The Realm has been closed and is no longer accessible . `` ) ; return false ; } - TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + if ( ! TV ( nativeViewPtr ) - > is_in_sync ( ) & & TV ( nativeViewPtr ) - > outside_version ( ) == std : :numeric_limits < uint64_t > : :max ( ) ) { + // This table view is no longer valid . By calling sync_if_needed we ensure it behaves + // properly as a 0-size TableView . + TV ( nativeViewPtr ) - > sync_if_needed API review & cleanup for 1.0 __EoT__ The following things should be implemented : - [ x ] JSON methods currently wrap all runtime exceptions in a RealmException . Consider removing this as it makes it hard to know exactly what failed - > Remove RealmException where possible . ( # 2618 ) - [ x ] Cleanup sorted\* methods . Remove all sort methods accepting 3 fields . Multiarg should be used instead . ( # 2619 ) - [ x ] Remove ` allObjects ` and friends from Realm so all query options are in RealmQuery . ( # 2620 ) - [ x ] RealmConfiguration ` setModules ( ) ` rename to ` modules ( ) ` ( # 2621 ) - [ X ] All lists methods should automatically do ` copyToRealm ` or ` copyToRealmOrUpdate ` ( mc Checked , all methods which could add/change object in the list , will call ` copyToRealmIfNeeded ` ) - [ x ] RealmChangeListener should provide the changes object/realm/collection as well ( # 2705 ) - [ x ] realm.createObject ( class , primaryKey ) should be public ( # 2622 ) - [ x ] All methods
diff -- git a/CHANGELOG.md b/CHANGELOG.md index cf8eb79..994a0e7 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,12 @ @ + # # 0.89.0 +* BREAKING CHANGE : RealmResults.clear ( ) now throws UnsupportedOperationException . Use RealmResults.deleteAllFromRealm ( ) instead . +* BREAKING CHANGE : RealmResults.remove ( int ) now throws UnsupportedOperationException . Use RealmResults.deleteFromRealm ( ) instead . +* Added two new interfaces : RealmCollection and OrderedRealmCollection . RealmList and RealmResults both implement these interfaces . +* Deprecated RealmObject.removeFromRealm ( ) in place of RealmObject.deleteFromRealm ( ) +* Deprecated Realm.clear ( Class ) in place of Realm.delete ( Class ) . +* Deprecated DynamicRealm.clear ( Class ) in place of DynamicRealm.delete ( Class ) . +* RealmBaseAdapter now accept an OrderedRealmCollection instead of only RealmResults . + # # 0.88.0 * Updated Realm Core to 0.97.0. diff -- git a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java index 69915fc..3a4afc8 100644 -- - a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java +++ b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java @ @ -54,7 +54,7 @ @ public class AdapterExampleActivity extends Activity { listView.setOnItemLongClickListener ( new AdapterView.OnItemLongClickListener ( ) { @ Override public boolean onItemLongClick ( AdapterView < ? > adapterView , View view , int i , long l ) { - TimeStamp timeStamp = adapter.getRealmResults ( ) .get ( i API review & cleanup for 1.0 __EoT__ The following things should be implemented : - [ x ] JSON methods currently wrap all runtime exceptions in a RealmException . Consider removing this as it makes it hard to know exactly what failed - > Remove RealmException where possible . ( # 2618 ) - [ x ] Cleanup sorted\* methods . Remove all sort methods accepting 3 fields . Multiarg should be used instead . ( # 2619 ) - [ x ] Remove ` allObjects ` and friends from Realm so all query options are in RealmQuery . ( # 2620 ) - [ x ] RealmConfiguration ` setModules ( ) ` rename to ` modules ( ) ` ( # 2621 ) - [ X ] All lists methods should automatically do ` copyToRealm ` or ` copyToRealmOrUpdate ` ( mc Checked , all methods which could add/change object in the list , will call ` copyToRealmIfNeeded ` ) - [ x ] RealmChangeListener should provide the changes object/realm/collection as well ( # 2705 ) - [ x ] realm.createObject ( class , primaryKey ) should be public ( # 2622 ) - [ x ] All methods
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 21c5444..008b31b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,7 +1,19 @ @ # # 0.89.0 - # # # Enhancements + # # # Breaking changes +* RealmResults.clear ( ) now throws UnsupportedOperationException . Use RealmResults.deleteAllFromRealm ( ) instead . +* RealmResults.remove ( int ) now throws UnsupportedOperationException . Use RealmResults.deleteFromRealm ( ) instead . + + # # # Deprecated + +* RealmObject.removeFromRealm ( ) in place of RealmObject.deleteFromRealm ( ) +* Realm.clear ( Class ) in place of Realm.delete ( Class ) . +* DynamicRealm.clear ( Class ) in place of DynamicRealm.delete ( Class ) . + + # # # Enhancements +* RealmCollection and OrderedRealmCollection have been added . RealmList and RealmResults both implement these interfaces . +* RealmBaseAdapter now accept an OrderedRealmCollection instead of only RealmResults . * RealmObjectSchema.isPrimaryKey ( String ) ( # 2440 ) # # # Bug fixes diff -- git a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java index 69915fc..3a4afc8 100644 -- - a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java +++ b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java @ @ -54,7 +54,7 @ @ public class AdapterExampleActivity extends Activity { listView.setOnItemLongClickListener ( new AdapterView.OnItemLongClickListener ( ) { @ Override public boolean onItemLongClick ( AdapterView < ? > adapterView , View view , int API review & cleanup for 1.0 __EoT__ The following things should be implemented : - [ x ] JSON methods currently wrap all runtime exceptions in a RealmException . Consider removing this as it makes it hard to know exactly what failed - > Remove RealmException where possible . ( # 2618 ) - [ x ] Cleanup sorted\* methods . Remove all sort methods accepting 3 fields . Multiarg should be used instead . ( # 2619 ) - [ x ] Remove ` allObjects ` and friends from Realm so all query options are in RealmQuery . ( # 2620 ) - [ x ] RealmConfiguration ` setModules ( ) ` rename to ` modules ( ) ` ( # 2621 ) - [ X ] All lists methods should automatically do ` copyToRealm ` or ` copyToRealmOrUpdate ` ( mc Checked , all methods which could add/change object in the list , will call ` copyToRealmIfNeeded ` ) - [ x ] RealmChangeListener should provide the changes object/realm/collection as well ( # 2705 ) - [ x ] realm.createObject ( class , primaryKey ) should be public ( # 2622 ) - [ x ] All methods
diff -- git a/realm/realm-library/src/main/java/io/realm/BaseRealm.java b/realm/realm-library/src/main/java/io/realm/BaseRealm.java index 2714cd7..739107e 100644 -- - a/realm/realm-library/src/main/java/io/realm/BaseRealm.java +++ b/realm/realm-library/src/main/java/io/realm/BaseRealm.java @ @ -47,7 +47,7 @ @ import rx.Observable ; * @ see io.realm.Realm * @ see io.realm.DynamicRealm */ -public abstract class BaseRealm implements Closeable { +abstract class BaseRealm implements Closeable { protected static final long UNVERSIONED = -1 ; private static final String INCORRECT_THREAD_CLOSE_MESSAGE = `` Realm access from incorrect thread . Realm instance can only be closed on the thread it was created . `` ; private static final String INCORRECT_THREAD_MESSAGE = `` Realm access from incorrect thread . Realm objects can only be accessed on the thread they were created . `` ; API review & cleanup for 1.0 __EoT__ The following things should be implemented : - [ x ] JSON methods currently wrap all runtime exceptions in a RealmException . Consider removing this as it makes it hard to know exactly what failed - > Remove RealmException where possible . ( # 2618 ) - [ x ] Cleanup sorted\* methods . Remove all sort methods accepting 3 fields . Multiarg should be used instead . ( # 2619 ) - [ x ] Remove ` allObjects ` and friends from Realm so all query options are in RealmQuery . ( # 2620 ) - [ x ] RealmConfiguration ` setModules ( ) ` rename to ` modules ( ) ` ( # 2621 ) - [ X ] All lists methods should automatically do ` copyToRealm ` or ` copyToRealmOrUpdate ` ( mc Checked , all methods which could add/change object in the list , will call ` copyToRealmIfNeeded ` ) - [ x ] RealmChangeListener should provide the changes object/realm/collection as well ( # 2705 ) - [ x ] realm.createObject ( class , primaryKey ) should be public ( # 2622 ) - [ x ] All methods
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 7bb4e15..91168d6 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -40,6 +40,7 @ @ and ` SyncUser # retrieveInfoForUserAsync ` which returns a ` SyncUserInfo ` with mode * ` RealmSchema.create ( String ) ` and ` RealmObjectSchema.setClassName ( String ) ` did not accept class name whose length was 51 to 57 . * Workaround for an Android JVM crash when using ` compactOnLaunch ( ) ` ( # 4964 ) . * Class name in exception message from link query is wrong ( # 5096 ) . +* Exposing a ` RealmConfiguration ` that allows a user to open the backup Realm after the client reset ( # 4759 ) . # # # Internal diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java index ee9b216..9e7b94d 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java @ @ -25,6 +25,9 @ @ import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; +import io.realm.entities.StringOnly ; +import io.realm.exceptions.RealmMigrationNeededException ; +import io.realm.objectserver.utils.StringOnlyModule ; import io.realm.rule.RunInLooperThread ; import io.realm.rule.RunTestInLooperThread ; import io.realm.rule.TestSyncConfigurationFactory ; @ @ -32,6 +35,7 @ @ import io.realm.rule.TestSyncConfigurationFactory ; import static io.realm.util.SyncTestUtils.createTestUser ; import static org.junit.Assert.assertEquals ; import static org.junit.Assert.assertFalse ; +import static org.junit.Assert.assertNotNull ; import static org.junit.Assert.assertTrue ; import static org.junit.Assert.fail downloadProgressListener_indefinitely worker thread does n't terminate __EoT__ As per the discussion [ here ] ( https : //github.com/realm/realm-java/pull/5159 # discussion_r136507434 ) , we need to investigate why the ` downloadProgressListener_indefinitely ` test fails . Removing the [ join ] ( https : //github.com/realm/realm-java/pull/5159/files/69aa8f2d39fce182485c34767d6249cd7d8173f3 # diff-98189d61fc029709ddad095607a8590eL193 ) seems to fix the issue , which indicates that the ` worker ` thread did n't terminate , which causes the test thread to wait indefinitely until it times out
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 7bb4e15..91168d6 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -40,6 +40,7 @ @ and ` SyncUser # retrieveInfoForUserAsync ` which returns a ` SyncUserInfo ` with mode * ` RealmSchema.create ( String ) ` and ` RealmObjectSchema.setClassName ( String ) ` did not accept class name whose length was 51 to 57 . * Workaround for an Android JVM crash when using ` compactOnLaunch ( ) ` ( # 4964 ) . * Class name in exception message from link query is wrong ( # 5096 ) . +* Exposing a ` RealmConfiguration ` that allows a user to open the backup Realm after the client reset ( # 4759 ) . # # # Internal diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java index ee9b216..9e7b94d 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java @ @ -25,6 +25,9 @ @ import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; +import io.realm.entities.StringOnly ; +import io.realm.exceptions.RealmMigrationNeededException ; +import io.realm.objectserver.utils.StringOnlyModule ; import io.realm.rule.RunInLooperThread ; import io.realm.rule.RunTestInLooperThread ; import io.realm.rule.TestSyncConfigurationFactory ; @ @ -32,6 +35,7 @ @ import io.realm.rule.TestSyncConfigurationFactory ; import static io.realm.util.SyncTestUtils.createTestUser ; import static org.junit.Assert.assertEquals ; import static org.junit.Assert.assertFalse ; +import static org.junit.Assert.assertNotNull ; import static org.junit.Assert.assertTrue ; import static org.junit.Assert.fail downloadProgressListener_indefinitely worker thread does n't terminate __EoT__ As per the discussion [ here ] ( https : //github.com/realm/realm-java/pull/5159 # discussion_r136507434 ) , we need to investigate why the ` downloadProgressListener_indefinitely ` test fails . Removing the [ join ] ( https : //github.com/realm/realm-java/pull/5159/files/69aa8f2d39fce182485c34767d6249cd7d8173f3 # diff-98189d61fc029709ddad095607a8590eL193 ) seems to fix the issue , which indicates that the ` worker ` thread did n't terminate , which causes the test thread to wait indefinitely until it times out
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 7bb4e15..91168d6 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -40,6 +40,7 @ @ and ` SyncUser # retrieveInfoForUserAsync ` which returns a ` SyncUserInfo ` with mode * ` RealmSchema.create ( String ) ` and ` RealmObjectSchema.setClassName ( String ) ` did not accept class name whose length was 51 to 57 . * Workaround for an Android JVM crash when using ` compactOnLaunch ( ) ` ( # 4964 ) . * Class name in exception message from link query is wrong ( # 5096 ) . +* Exposing a ` RealmConfiguration ` that allows a user to open the backup Realm after the client reset ( # 4759 ) . # # # Internal diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java index ee9b216..9e7b94d 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java @ @ -25,6 +25,9 @ @ import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; +import io.realm.entities.StringOnly ; +import io.realm.exceptions.RealmMigrationNeededException ; +import io.realm.objectserver.utils.StringOnlyModule ; import io.realm.rule.RunInLooperThread ; import io.realm.rule.RunTestInLooperThread ; import io.realm.rule.TestSyncConfigurationFactory ; @ @ -32,6 +35,7 @ @ import io.realm.rule.TestSyncConfigurationFactory ; import static io.realm.util.SyncTestUtils.createTestUser ; import static org.junit.Assert.assertEquals ; import static org.junit.Assert.assertFalse ; +import static org.junit.Assert.assertNotNull ; import static org.junit.Assert.assertTrue ; import static org.junit.Assert.fail downloadProgressListener_indefinitely worker thread does n't terminate __EoT__ As per the discussion [ here ] ( https : //github.com/realm/realm-java/pull/5159 # discussion_r136507434 ) , we need to investigate why the ` downloadProgressListener_indefinitely ` test fails . Removing the [ join ] ( https : //github.com/realm/realm-java/pull/5159/files/69aa8f2d39fce182485c34767d6249cd7d8173f3 # diff-98189d61fc029709ddad095607a8590eL193 ) seems to fix the issue , which indicates that the ` worker ` thread did n't terminate , which causes the test thread to wait indefinitely until it times out
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 48f5b5d..b6466dc 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -47,6 +47,7 @ @ * Fixed a JNI memory issue when doing queries which might potentially cause various native crashes . * Fixed a bug that ` RealmList.deleteFromRealm ( int ) ` , ` RealmList.deleteFirstFromRealm ( ) ` and ` RealmList.deleteLastFromRealm ( ) ` did not remove target objects from Realm . This bug was introduced in ` 3.7.1 ` ( # 5233 ) . * Crash with `` 'xxx ' does n't exist in current schema . '' when ProGuard is enabled ( # 5211 ) . +* Exposing a ` RealmConfiguration ` that allows a user to open the backup Realm after the client reset ( # 4759 ) . # # 3.7.1 ( 2017-09-07 ) diff -- git a/dependencies.list b/dependencies.list index 2187414..404a4e0 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -1,7 +1,7 @ @ # Realm Sync Core release used by Realm Java # https : //github.com/realm/realm-sync/releases -REALM_SYNC_VERSION=2.0.0-rc16 -REALM_SYNC_SHA256=c20c4e7333f01a3a4ea350cb20b9b7feba95ad4e52d612368b6187b72d518aa1 +REALM_SYNC_VERSION=2.0.0-rc18 +REALM_SYNC_SHA256=73cb89c1a04cafa871444aa91d93eb9df16af088bcb7d3ede73bb815d53a06e5 # Object Server Release used by Integration tests # Stable releases : https : //packagecloud.io/realm/realm ? filter=debs diff -- git a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java index 5dc2af0..dae5155 100644 -- - a/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java +++ b/realm/realm-library/src/androidTestObjectServer/java/io/realm/SessionTests.java @ downloadProgressListener_indefinitely worker thread does n't terminate __EoT__ As per the discussion [ here ] ( https : //github.com/realm/realm-java/pull/5159 # discussion_r136507434 ) , we need to investigate why the ` downloadProgressListener_indefinitely ` test fails . Removing the [ join ] ( https : //github.com/realm/realm-java/pull/5159/files/69aa8f2d39fce182485c34767d6249cd7d8173f3 # diff-98189d61fc029709ddad095607a8590eL193 ) seems to fix the issue , which indicates that the ` worker ` thread did n't terminate , which causes the test thread to wait indefinitely until it times out
diff -- git a/dependencies.list b/dependencies.list index 404a4e0..b41577c 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -3,11 +3,6 @ @ REALM_SYNC_VERSION=2.0.0-rc18 REALM_SYNC_SHA256=73cb89c1a04cafa871444aa91d93eb9df16af088bcb7d3ede73bb815d53a06e5 - # Object Server Release used by Integration tests - # Stable releases : https : //packagecloud.io/realm/realm ? filter=debs - # Beta releases : https : //packagecloud.io/realm/realm-beta ? filter=debs - # Developer builds : https : //packagecloud.io/realm/realm-testing ? filter=debs - # /tools/sync_test_server/Dockerfile specify which repo ( apt ) we should - # install/use between 'realm ' , 'realm-beta ' and 'realm-testing ' , the version below should - # correspond to an existing version on the *specified* repo . -REALM_OBJECT_SERVER_DE_VERSION=2.0.0-rc2-285 + # Object Server Release used by Integration tests . Installed using NPM . + # Use ` npm view realm-object-server versions ` to get a list of available versions . +REALM_OBJECT_SERVER_DE_VERSION=2.0.0-alpha.28 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java index 1b9152b..b63e45d 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java @ @ -21,6 +21,7 @ @ import android.support.test.runner.AndroidJUnit4 ; import org.junit.After ; import org.junit.Before ; +import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -29,8 +30,14 @ @ import java.io.IOException ; import java.util.Arrays ; import java.util.List ; +import io.realm.DynamicRealm ; +import io.realm.DynamicRealmObject ; +import io.realm.FieldAttribute ; +import io.realm.Realm ; downloadProgressListener_indefinitely worker thread does n't terminate __EoT__ As per the discussion [ here ] ( https : //github.com/realm/realm-java/pull/5159 # discussion_r136507434 ) , we need to investigate why the ` downloadProgressListener_indefinitely ` test fails . Removing the [ join ] ( https : //github.com/realm/realm-java/pull/5159/files/69aa8f2d39fce182485c34767d6249cd7d8173f3 # diff-98189d61fc029709ddad095607a8590eL193 ) seems to fix the issue , which indicates that the ` worker ` thread did n't terminate , which causes the test thread to wait indefinitely until it times out
diff -- git a/dependencies.list b/dependencies.list index 404a4e0..1398418 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -3,11 +3,6 @ @ REALM_SYNC_VERSION=2.0.0-rc18 REALM_SYNC_SHA256=73cb89c1a04cafa871444aa91d93eb9df16af088bcb7d3ede73bb815d53a06e5 - # Object Server Release used by Integration tests - # Stable releases : https : //packagecloud.io/realm/realm ? filter=debs - # Beta releases : https : //packagecloud.io/realm/realm-beta ? filter=debs - # Developer builds : https : //packagecloud.io/realm/realm-testing ? filter=debs - # /tools/sync_test_server/Dockerfile specify which repo ( apt ) we should - # install/use between 'realm ' , 'realm-beta ' and 'realm-testing ' , the version below should - # correspond to an existing version on the *specified* repo . -REALM_OBJECT_SERVER_DE_VERSION=2.0.0-rc2-285 + # Object Server Release used by Integration tests . Installed using NPM . + # Use ` npm view realm-object-server versions ` to get a list of available versions . +REALM_OBJECT_SERVER_DE_VERSION=2.0.0-alpha.30 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java index 1b9152b..b63e45d 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java @ @ -21,6 +21,7 @ @ import android.support.test.runner.AndroidJUnit4 ; import org.junit.After ; import org.junit.Before ; +import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -29,8 +30,14 @ @ import java.io.IOException ; import java.util.Arrays ; import java.util.List ; +import io.realm.DynamicRealm ; +import io.realm.DynamicRealmObject ; +import io.realm.FieldAttribute ; +import io.realm.Realm ; downloadProgressListener_indefinitely worker thread does n't terminate __EoT__ As per the discussion [ here ] ( https : //github.com/realm/realm-java/pull/5159 # discussion_r136507434 ) , we need to investigate why the ` downloadProgressListener_indefinitely ` test fails . Removing the [ join ] ( https : //github.com/realm/realm-java/pull/5159/files/69aa8f2d39fce182485c34767d6249cd7d8173f3 # diff-98189d61fc029709ddad095607a8590eL193 ) seems to fix the issue , which indicates that the ` worker ` thread did n't terminate , which causes the test thread to wait indefinitely until it times out
diff -- git a/dependencies.list b/dependencies.list index 404a4e0..1398418 100644 -- - a/dependencies.list +++ b/dependencies.list @ @ -3,11 +3,6 @ @ REALM_SYNC_VERSION=2.0.0-rc18 REALM_SYNC_SHA256=73cb89c1a04cafa871444aa91d93eb9df16af088bcb7d3ede73bb815d53a06e5 - # Object Server Release used by Integration tests - # Stable releases : https : //packagecloud.io/realm/realm ? filter=debs - # Beta releases : https : //packagecloud.io/realm/realm-beta ? filter=debs - # Developer builds : https : //packagecloud.io/realm/realm-testing ? filter=debs - # /tools/sync_test_server/Dockerfile specify which repo ( apt ) we should - # install/use between 'realm ' , 'realm-beta ' and 'realm-testing ' , the version below should - # correspond to an existing version on the *specified* repo . -REALM_OBJECT_SERVER_DE_VERSION=2.0.0-rc2-285 + # Object Server Release used by Integration tests . Installed using NPM . + # Use ` npm view realm-object-server versions ` to get a list of available versions . +REALM_OBJECT_SERVER_DE_VERSION=2.0.0-alpha.30 diff -- git a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java index 1b9152b..b63e45d 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/internal/PrimaryKeyTests.java @ @ -21,6 +21,7 @ @ import android.support.test.runner.AndroidJUnit4 ; import org.junit.After ; import org.junit.Before ; +import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -29,8 +30,14 @ @ import java.io.IOException ; import java.util.Arrays ; import java.util.List ; +import io.realm.DynamicRealm ; +import io.realm.DynamicRealmObject ; +import io.realm.FieldAttribute ; +import io.realm.Realm ; downloadProgressListener_indefinitely worker thread does n't terminate __EoT__ As per the discussion [ here ] ( https : //github.com/realm/realm-java/pull/5159 # discussion_r136507434 ) , we need to investigate why the ` downloadProgressListener_indefinitely ` test fails . Removing the [ join ] ( https : //github.com/realm/realm-java/pull/5159/files/69aa8f2d39fce182485c34767d6249cd7d8173f3 # diff-98189d61fc029709ddad095607a8590eL193 ) seems to fix the issue , which indicates that the ` worker ` thread did n't terminate , which causes the test thread to wait indefinitely until it times out
diff -- git a/realm-annotations/src/main/java/io/realm/annotations/LinkingObjects.java b/realm-annotations/src/main/java/io/realm/annotations/LinkingObjects.java index 3eb4afa..7489303 100644 -- - a/realm-annotations/src/main/java/io/realm/annotations/LinkingObjects.java +++ b/realm-annotations/src/main/java/io/realm/annotations/LinkingObjects.java @ @ -91,6 +91,11 @ @ import java.lang.annotation.Target ; * assert john.dogs.size ( ) == 2 ; * assert fido.owners.size ( ) == 2 ; * } + * < p > + * Querying inverse relationship is like querying any { @ code RealmResults } . This means that ain inverse relationship + * can not be { @ code null } but it can be empty ( length is 0 ) . It is possible to query field in the source class . This is + * equivalent to link queries . Please read { @ link https : //realm.io/docs/java/latest/ # link-queries } for more + * information . */ @ Retention ( RetentionPolicy.CLASS ) @ Target ( ElementType.FIELD ) diff -- git a/realm/realm-library/src/androidTest/java/io/realm/LinkingObjectsQueryTests.java b/realm/realm-library/src/androidTest/java/io/realm/LinkingObjectsQueryTests.java index 70d5218..91155ee 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/LinkingObjectsQueryTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/LinkingObjectsQueryTests.java @ @ -17,7 +17,6 @ @ package io.realm ; import android.support.test.runner.AndroidJUnit4 ; -import org.junit.Ignore ; import org.junit.Test ; import org.junit.runner.RunWith ; @ @ -30,7 +29,6 @ @ import static org.junit.Assert.assertEquals ; import static org.junit.Assert.assertTrue ; import static org.junit.Assert.fail ; - @ Ignore @ RunWith ( AndroidJUnit4.class ) public class LinkingObjectsQueryTests extends QueryTests Support LinkingObjects in native glue code __EoT__ There is a lot of code in the binding , now , to support queries on LinkingObjects . The native code needs a few further fixes in order to make them work . - [ ] Fix the getTableByArray method to support backlink queries - [ ] Re-enable the backlink query unit tests , make sure they are clear and that they pass . - [ ] Address @ kneth 's comments , captured here . - [ ] Add new unit tests as necessary to get good coverage This issues follows # 2904 , # 4529 , # 4323 , # 4321 , # 4519 , and # 4576
diff -- git a/CHANGELOG.md b/CHANGELOG.md index aa00936..361f928 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -4,6 +4,8 @ @ # # # Enhancements +* Added support for inverse relationships which can be declared by the ` @ LinkingObjects ` annotation ( # 607 ) . + # # # Bug Fixes * [ ObjectServer ] Fixed a crash when an authentication error happend ( # 4726 ) . diff -- git a/realm-annotations/src/main/java/io/realm/annotations/LinkingObjects.java b/realm-annotations/src/main/java/io/realm/annotations/LinkingObjects.java index 3eb4afa..3ccd9c4 100644 -- - a/realm-annotations/src/main/java/io/realm/annotations/LinkingObjects.java +++ b/realm-annotations/src/main/java/io/realm/annotations/LinkingObjects.java @ @ -91,10 +91,14 @ @ import java.lang.annotation.Target ; * assert john.dogs.size ( ) == 2 ; * assert fido.owners.size ( ) == 2 ; * } + * < p > + * Querying inverse relationship is like querying any { @ code RealmResults } . This means that an inverse relationship + * can not be { @ code null } but it can be empty ( length is 0 ) . It is possible to query fields in the source class . This is + * equivalent to link queries . Please read { @ link https : //realm.io/docs/java/latest/ # link-queries } for more + * information . */ @ Retention ( RetentionPolicy.CLASS ) @ Target Support LinkingObjects in native glue code __EoT__ There is a lot of code in the binding , now , to support queries on LinkingObjects . The native code needs a few further fixes in order to make them work . - [ ] Fix the getTableByArray method to support backlink queries - [ ] Re-enable the backlink query unit tests , make sure they are clear and that they pass . - [ ] Address @ kneth 's comments , captured here . - [ ] Add new unit tests as necessary to get good coverage This issues follows # 2904 , # 4529 , # 4323 , # 4321 , # 4519 , and # 4576
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 474c39c..96b5c8e 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -51,14 +51,14 @ @ import io.realm.annotations.Required ; public class ClassMetaData { private final TypeElement classType ; // Reference to model class . - private String className ; // Model class simple name . + private final String className ; // Model class simple name . + private final List < VariableElement > fields = new ArrayList < VariableElement > ( ) ; // List of all fields in the class except those @ Ignored . + private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; + private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be nullable private String packageName ; // package name for model class . private boolean hasDefaultConstructor ; // True if model has a public no-arg constructor . private VariableElement primaryKey ; // Reference to field used as primary key , if any . - Support LinkingObjects in native glue code __EoT__ There is a lot of code in the binding , now , to support queries on LinkingObjects . The native code needs a few further fixes in order to make them work . - [ ] Fix the getTableByArray method to support backlink queries - [ ] Re-enable the backlink query unit tests , make sure they are clear and that they pass . - [ ] Address @ kneth 's comments , captured here . - [ ] Add new unit tests as necessary to get good coverage This issues follows # 2904 , # 4529 , # 4323 , # 4321 , # 4519 , and # 4576
diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java index 474c39c..96b5c8e 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/ClassMetaData.java @ @ -51,14 +51,14 @ @ import io.realm.annotations.Required ; public class ClassMetaData { private final TypeElement classType ; // Reference to model class . - private String className ; // Model class simple name . + private final String className ; // Model class simple name . + private final List < VariableElement > fields = new ArrayList < VariableElement > ( ) ; // List of all fields in the class except those @ Ignored . + private final List < VariableElement > indexedFields = new ArrayList < VariableElement > ( ) ; // list of all fields marked @ Index . + private final Set < Backlink > backlinks = new HashSet < Backlink > ( ) ; + private final Set < VariableElement > nullableFields = new HashSet < VariableElement > ( ) ; // Set of fields which can be nullable private String packageName ; // package name for model class . private boolean hasDefaultConstructor ; // True if model has a public no-arg constructor . private VariableElement primaryKey ; // Reference to field used as primary key , if any . - Support LinkingObjects in native glue code __EoT__ There is a lot of code in the binding , now , to support queries on LinkingObjects . The native code needs a few further fixes in order to make them work . - [ ] Fix the getTableByArray method to support backlink queries - [ ] Re-enable the backlink query unit tests , make sure they are clear and that they pass . - [ ] Address @ kneth 's comments , captured here . - [ ] Add new unit tests as necessary to get good coverage This issues follows # 2904 , # 4529 , # 4323 , # 4321 , # 4519 , and # 4576
diff -- git a/CHANGELOG.md b/CHANGELOG.md index c3e2b69..66dc302 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -3,6 +3,7 @ @ # # Bug fixes * Added missing row validation check in certain cases on invalidated/deleted objects ( # 4540 ) . +* Initializing Realm is now more resilient if ` Context.getFilesDir ( ) ` is n't working correctly ( # 4493 ) . # # 3.1.3 ( 2017-04-20 ) diff -- git a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java index f95147a..4953c8a 100644 -- - a/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java +++ b/realm/realm-library/src/androidTest/java/io/realm/RealmTests.java @ @ -38,12 +38,17 @ @ import org.junit.Ignore ; import org.junit.Rule ; import org.junit.Test ; import org.junit.rules.ExpectedException ; +import org.junit.rules.TemporaryFolder ; import org.junit.runner.RunWith ; +import org.mockito.invocation.InvocationOnMock ; +import org.mockito.stubbing.Answer ; import java.io.File ; import java.io.FilenameFilter ; import java.io.IOException ; import java.io.InputStream ; +import java.lang.reflect.InvocationTargetException ; +import java.lang.reflect.Method ; import java.util.ArrayList ; import java.util.Arrays ; import java.util.Date ; @ @ -116,6 +121,9 @ @ import static org.junit.Assert.assertNotSame ; import static org.junit.Assert.assertNull ; import static org.junit.Assert.assertTrue ; import static org.junit.Assert.fail ; +import static org.mockito.Mockito.mock ; +import static org.mockito.Mockito.when ; + @ RunWith ( AndroidJUnit4.class ) public class RealmTests { @ @ -128,6 +136,8 @ @ public class RealmTests { @ Rule public final TestRealmConfigurationFactory configFactory = new TestRealmConfigurationFactory ( ) ; Can not get Realm instance : io.realm.exceptions.RealmFileException : Unable to open a realm at path __EoT__ # # # # Goal Call ` Realm realm = Realm.getInstance ( mRealmConfig ) ; ` where ` mRealmConfig = RealmConfiguration.Builder ( ) .schemaVersion ( 2 ) .deleteRealmIfMigrationNeeded ( ) .build ( ) ; ` # # # # Expected Results Get a Realm without exception . # # # # Actual Results The following exception is thrown : ` io.realm.exceptions.RealmFileException : Unable to open a realm at path '/data/data/com.dropbox.paper/files/default.realm.management ' : make_dir ( ) failed : No such file or directory . ( make_dir ( ) failed : No such file or directory ) ( /data/data/com.dropbox.paper/files/default.realm.management ) in /home/cc/repo/realm/release/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp line 217 Kind : ACCESS_ERROR. ` More here : [ realm-exception.txt ] ( https : //github.com/realm/realm-java/files/920336/realm-exception.txt ) # # # # Steps & Code to Reproduce This happens on first launch of the app . # # # # Version of Realm and tooling Realm version ( s ) : 2.2.1 Tried upgrading to 3.1.2 but still seeing the same issue . Realm sync feature enabled : unsure . Would this affect this ? How can I turn this on/off ? Android Studio version
diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp index 6d200de..4b1039b 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp @ @ -430,12 +430,13 @ @ Java_io_realm_internal_SharedRealm_nativeGetSnapshotVersion ( JNIEnv *env , jclass , JNIEXPORT void JNICALL Java_io_realm_internal_SharedRealm_nativeUpdateSchema ( JNIEnv *env , jclass , jlong nativePtr , - jlong nativeSchemaPtr , jlong version ) { + jlong nativeSchemaPtr , jlong version , + jboolean inTransaction ) { TR_ENTER ( ) try { auto shared_realm = * ( reinterpret_cast < SharedRealm* > ( nativePtr ) ) ; auto *schema = reinterpret_cast < Schema* > ( nativeSchemaPtr ) ; - shared_realm- > update_schema ( *schema , static_cast < uint64_t > ( version ) ) ; + shared_realm- > update_schema ( *schema , static_cast < uint64_t > ( version ) , nullptr , to_bool ( inTransaction ) ) ; } CATCH_STD ( ) } diff -- git a/realm/realm-library/src/main/java/io/realm/Realm.java b/realm/realm-library/src/main/java/io/realm/Realm.java index 506266a..733f6e2 100644 -- - a/realm/realm-library/src/main/java/io/realm/Realm.java +++ b/realm/realm-library/src/main/java/io/realm/Realm.java @ @ -316,12 +316,10 @ @ public final class Realm extends BaseRealm { boolean syncAvailable = realm.configuration.isSyncConfiguration ( ) ; try { - if ( ! syncAvailable ) { - realm.beginTransaction ( ) ; - if ( version == UNVERSIONED ) { - commitNeeded = true ; - realm.setVersion ( realm.configuration.getSchemaVersion ( ) ) Cache fieldType alongside fieldIndex __EoT__ Copy from # 1610 `` ` RealmQuery.java Line 161 columns.get ( fieldName ) called potentially 3 times . if ( columns.get ( fieldName ) == null ) { throw new IllegalArgumentException ( String.format ( `` Field ' % s ' does not exist . `` , fieldName ) ) ; } ColumnType tableColumnType = table.getColumnType ( columns.get ( fieldName ) ) ; if ( fieldType ! = null & & fieldType ! = tableColumnType ) { throw new IllegalArgumentException ( String.format ( `` Field ' % s ' : type mismatch . Was % s , expected % s . `` , fieldName , fieldType , tableColumnType ) ) ; } return new long [ ] { columns.get ( fieldName ) } ; `` ` Also , why does getColumnType need to call native jni to get column type every single time and not cached ? Strange this has to be done every time since column index is cached but column data type is not .
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..d211177 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp index b15798d..e037db6 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp @ @ -32,6 +32,8 @ @ # include `` sync/sync_manager.hpp '' # endif + # include `` jni_util/hack.hpp '' + using namespace realm ; using namespace realm : :_impl ; @ @ -57,6 +59,8 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_SharedRealm_nativeInit ( JNIEnv* env { TR_ENTER ( ) + hack_init ( ) ; + try { JStringAccessor path ( env , temporary_directory_path ) ; // throws SharedGroupOptions : :set_sys_tmp_dir ( std : :string ( path ) ) ; // throws diff -- git a/realm/realm-library/src/main/cpp/jni_util/hack.cpp b/realm/realm-library/src/main/cpp/jni_util/hack.cpp new file mode 100644 index 0000000..75aa1bd -- - /dev/null +++ b/realm/realm-library/src/main/cpp/jni_util/hack.cpp @ @ Samsung Galaxy S3 mini : Heap memory corruption __EoT__ Samsung Galaxy S3 mini ( i8200N ) Trying to use Realm v2 we 're getting the following crash : `` ` [ 02-10 16:15:02.593 10641-10641/link.thismo.app A/libc : Fatal signal 11 ( SIGSEGV ) at 0x5ab96ff6 ( code=2 ) , thread 10641 ( link.thismo.app ) 02-10 16:15:02.601 10641-10713/link.thismo.app I/dalvikvm : JNI ERROR ( app bug ) : accessed deleted local reference 0x23400005 02-10 16:15:02.601 10641-10713/link.thismo.app E/dalvikvm : VM aborting 02-10 16:15:02.601 10641-10713/link.thismo.app A/libc : Fatal signal 11 ( SIGSEGV ) at 0xdeadd00d ( code=1 ) , thread 10713 ( AnalyticsWorker ) 02-10 16:15:10.054 10641-10647/link.thismo.app A/libc : @ @ @ ABORTING : LIBC : HEAP MEMORY CORRUPTION IN dlmalloc ] `` ` A more complete crash log that happened on version 2.4.0-SNAPSHOT : https : //gist.github.com/jonasbark/26fbd60062ed9af981a3d0b19f91c62d It does not happen with e.g . 0.90.1 .
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..d211177 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp index b15798d..e037db6 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp @ @ -32,6 +32,8 @ @ # include `` sync/sync_manager.hpp '' # endif + # include `` jni_util/hack.hpp '' + using namespace realm ; using namespace realm : :_impl ; @ @ -57,6 +59,8 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_SharedRealm_nativeInit ( JNIEnv* env { TR_ENTER ( ) + hack_init ( ) ; + try { JStringAccessor path ( env , temporary_directory_path ) ; // throws SharedGroupOptions : :set_sys_tmp_dir ( std : :string ( path ) ) ; // throws diff -- git a/realm/realm-library/src/main/cpp/jni_util/hack.cpp b/realm/realm-library/src/main/cpp/jni_util/hack.cpp new file mode 100644 index 0000000..d519183 -- - /dev/null +++ b/realm/realm-library/src/main/cpp/jni_util/hack.cpp @ @ Samsung Galaxy S3 mini : Heap memory corruption __EoT__ Samsung Galaxy S3 mini ( i8200N ) Trying to use Realm v2 we 're getting the following crash : `` ` [ 02-10 16:15:02.593 10641-10641/link.thismo.app A/libc : Fatal signal 11 ( SIGSEGV ) at 0x5ab96ff6 ( code=2 ) , thread 10641 ( link.thismo.app ) 02-10 16:15:02.601 10641-10713/link.thismo.app I/dalvikvm : JNI ERROR ( app bug ) : accessed deleted local reference 0x23400005 02-10 16:15:02.601 10641-10713/link.thismo.app E/dalvikvm : VM aborting 02-10 16:15:02.601 10641-10713/link.thismo.app A/libc : Fatal signal 11 ( SIGSEGV ) at 0xdeadd00d ( code=1 ) , thread 10713 ( AnalyticsWorker ) 02-10 16:15:10.054 10641-10647/link.thismo.app A/libc : @ @ @ ABORTING : LIBC : HEAP MEMORY CORRUPTION IN dlmalloc ] `` ` A more complete crash log that happened on version 2.4.0-SNAPSHOT : https : //gist.github.com/jonasbark/26fbd60062ed9af981a3d0b19f91c62d It does not happen with e.g . 0.90.1 .
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 5913e18..11c3d43 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -17,6 +17,10 @ @ set ( CMAKE_VERBOSE_MAKEFILE ON ) # Generate compile_commands.json set ( CMAKE_EXPORT_COMPILE_COMMANDS ON ) + # Initialize common compile & link flags . +set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_COMMON_CXX_FLAGS `` '' ) + # Setup lcache if ( NDK_LCACHE ) set ( CMAKE_CXX_CREATE_SHARED_LIBRARY `` $ { NDK_LCACHE } $ { CMAKE_CXX_CREATE_SHARED_LIBRARY } '' ) @ @ -123,6 +127,14 @ @ elseif ( ARMEABI_V7A ) set ( ABI_CXX_FLAGS `` -mthumb -march=armv7-a -mfloat-abi=softfp -mfpu=vfpv3-d16 '' ) endif ( ) + # Hack the memmove bug on Samsung device . +if ( ARMEABI OR ARMEABI_V7A ) + set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -Wl , -- wrap , memmove -Wl , -- wrap , memcpy '' ) + set ( REALM_COMMON_CXX_FLAGS `` $ { REALM_COMMON_CXX_FLAGS } -DREALM_WRAP_MEMMOVE=1 '' ) +else ( ) + set ( REALM_COMMON_CXX_FLAGS `` $ { REALM_COMMON_CXX_FLAGS } -DREALM_WRAP_MEMMOVE=0 '' ) +endif ( ) + # FIXME uninitialized is reported by query_expression.hpp:1070 # d.init ( ValueBase : :m_from_link_list , ValueBase : :m_values , D { } ) ; # FIXME maybe-uninitialized is reported by table_view.cpp:272:15 : @ Samsung Galaxy S3 mini : Heap memory corruption __EoT__ Samsung Galaxy S3 mini ( i8200N ) Trying to use Realm v2 we 're getting the following crash : `` ` [ 02-10 16:15:02.593 10641-10641/link.thismo.app A/libc : Fatal signal 11 ( SIGSEGV ) at 0x5ab96ff6 ( code=2 ) , thread 10641 ( link.thismo.app ) 02-10 16:15:02.601 10641-10713/link.thismo.app I/dalvikvm : JNI ERROR ( app bug ) : accessed deleted local reference 0x23400005 02-10 16:15:02.601 10641-10713/link.thismo.app E/dalvikvm : VM aborting 02-10 16:15:02.601 10641-10713/link.thismo.app A/libc : Fatal signal 11 ( SIGSEGV ) at 0xdeadd00d ( code=1 ) , thread 10713 ( AnalyticsWorker ) 02-10 16:15:10.054 10641-10647/link.thismo.app A/libc : @ @ @ ABORTING : LIBC : HEAP MEMORY CORRUPTION IN dlmalloc ] `` ` A more complete crash log that happened on version 2.4.0-SNAPSHOT : https : //gist.github.com/jonasbark/26fbd60062ed9af981a3d0b19f91c62d It does not happen with e.g . 0.90.1 .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index f570361..37ad075 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -4,6 +4,10 @ @ * Fixed native memory leak setting the value of a primary key ( # 3993 ) . + # # # Object Server API Changes ( In Beta ) + +* Exceptions thrown in error handlers are ignored but logged ( # 3559 ) . + # # # Internal * Updated Realm Sync to 1.0.0-BETA-7.0 . diff -- git a/realm/realm-library/src/objectServer/java/io/realm/SyncSession.java b/realm/realm-library/src/objectServer/java/io/realm/SyncSession.java index 0aabe1e..046295c 100644 -- - a/realm/realm-library/src/objectServer/java/io/realm/SyncSession.java +++ b/realm/realm-library/src/objectServer/java/io/realm/SyncSession.java @ @ -107,7 +107,10 @ @ public class SyncSession { */ public interface ErrorHandler { /** - * Callback for errors on a session object . + * Callback for errors on a session object . It is not allowed to throw an exception inside an error handler . + * If the operations in an error handler can throw , it is safer to catch any exception in the error handler . + * When an exception is thrown in the error handler , the occurrence will be logged and the exception + * will be ignored . * * @ param session { @ link SyncSession } this error [ Sync ] Crashes in the error handler is swallowed by JNI __EoT__ If the SyncClients error handler is called , it will call back to Java , but if there is an exception in the Java code for whatever reason , that error gets completely swallowed . We need to fix that somehow , so some error information surface somewhere .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 8a3f6ca..ed9bad7 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -34,6 +34,7 @ @ # # # Breaking Changes * [ ObjectServer ] Updated protocol version to 18 which is only compatible with ROS > 1.6.0 . +* An ` IllegalStateException ` will be thrown if the given ` RealmModule ` does n't include all required model classes ( # 3398 ) . # # # Deprecated @ @ -74,7 +75,8 @ @ # # # Internal -* Factor out internal interface ManagedObject +* Factor out internal interface ManagedObject . +* Use Object Store to do table initialization . # # 3.3.1 ( 2017-05-26 ) diff -- git a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java index bc16c86..0e68b14 100644 -- - a/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java +++ b/realm/realm-annotations-processor/src/main/java/io/realm/processor/RealmProxyClassGenerator.java @ @ -51,6 +51,8 @ @ public class RealmProxyClassGenerator { `` io.realm.internal.ColumnInfo '' , `` io.realm.internal.LinkView '' , `` io.realm.internal.OsObject '' , + `` io.realm.internal.OsObjectSchemaInfo '' , + `` io.realm.internal.Property '' , `` io.realm.internal.RealmObjectProxy '' , `` io.realm.internal.Row '' , `` io.realm.internal.SharedRealm '' , @ @ -132,7 +134,8 @ @ public class RealmProxyClassGenerator { emitInjectContextMethod ( writer ) ; emitPersistedFieldAccessors ( writer ) ; emitBacklinkFieldAccessors ( writer ) ; - emitCreateRealmObjectSchemaMethod ( writer ) ; + emitCreateExpectedObjectSchemaInfo A module/schema must include all required classes __EoT__ If class ` A ` links to class ` B ` but a module/schema does not include ` B ` , object store will crash during validation ( calling ` update_schema ` ) . We must ensure that all required classes ( direct and indirect ) are included in the module/schema . If a class is missing , an exception must be thrown .
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 4aefd1f..d211177 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -138,7 +138,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp index b15798d..e037db6 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_SharedRealm.cpp @ @ -32,6 +32,8 @ @ # include `` sync/sync_manager.hpp '' # endif + # include `` jni_util/hack.hpp '' + using namespace realm ; using namespace realm : :_impl ; @ @ -57,6 +59,8 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_SharedRealm_nativeInit ( JNIEnv* env { TR_ENTER ( ) + hack_init ( ) ; + try { JStringAccessor path ( env , temporary_directory_path ) ; // throws SharedGroupOptions : :set_sys_tmp_dir ( std : :string ( path ) ) ; // throws diff -- git a/realm/realm-library/src/main/cpp/jni_util/hack.cpp b/realm/realm-library/src/main/cpp/jni_util/hack.cpp new file mode 100644 index 0000000..80f3ac5 -- - /dev/null +++ b/realm/realm-library/src/main/cpp/jni_util/hack.cpp @ @ RealmMigrationNeededException only on Android 4.2.2 and Samsung Galaxy S3 Mini __EoT__ Our crash logs just start showing up this crash . It only affects Android version 4.2.2 and Samsung GT-I8200N phone . Realm version 2.3.1 `` ` java.lang.RuntimeException : Unable to start activity ComponentInfo { MainActivity } : io.realm.exceptions.RealmMigrationNeededException : The 'RealmPumpBasalRateConfig ' class is missing from the schema for this Realm . at android.app.ActivityThread.performLaunchActivity ( ActivityThread.java:2262 ) at android.app.ActivityThread.handleLaunchActivity ( ActivityThread.java:2316 ) at android.app.ActivityThread.access $ 700 ( ActivityThread.java:158 ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1296 ) at android.os.Handler.dispatchMessage ( Handler.java:99 ) at android.os.Looper.loop ( Looper.java:176 ) at android.app.ActivityThread.main ( ActivityThread.java:5365 ) at java.lang.reflect.Method.invokeNative ( Native Method ) at java.lang.reflect.Method.invoke ( Method.java:511 ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:1102 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:869 ) at dalvik.system.NativeStart.main ( Native Method ) Caused by : io.realm.exceptions.RealmMigrationNeededException : The 'RealmPumpBasalRateConfig ' class is missing from the schema for this Realm . at io.realm.RealmPumpBasalRateConfigRealmProxy.validateTable ( RealmPumpBasalRateConfigRealmProxy.java:495 ) at io.realm.DefaultRealmModuleMediator.validateTable ( DefaultRealmModuleMediator.java:66 ) at io.realm.Realm.initializeRealm ( Realm.java:348 ) at io.realm.Realm.createAndValidate ( Realm.java:313 ) at io.realm.Realm.createInstance ( Realm.java:278 ) at io.realm.RealmCache.createRealmOrGetFromCache ( RealmCache.java:143 ) at io.realm.Realm.getDefaultInstance ( Realm.java:209 ) `` `
diff -- git a/realm/realm-library/src/main/cpp/CMakeLists.txt b/realm/realm-library/src/main/cpp/CMakeLists.txt index 5913e18..0d2e955 100644 -- - a/realm/realm-library/src/main/cpp/CMakeLists.txt +++ b/realm/realm-library/src/main/cpp/CMakeLists.txt @ @ -143,7 +143,7 @ @ set ( CMAKE_CXX_FLAGS_DEBUG `` -ggdb -Og -DNDEBUG '' ) set ( CMAKE_CXX_FLAGS `` $ { CMAKE_CXX_FLAGS } $ { REALM_COMMON_CXX_FLAGS } $ { WARNING_CXX_FLAGS } $ { ABI_CXX_FLAGS } '' ) # Set link flags -set ( REALM_LINKER_FLAGS `` '' ) +set ( REALM_LINKER_FLAGS `` -Wl , -- wrap , memmove -Wl , -- wrap , memcpy '' ) if ( build_SYNC ) set ( REALM_LINKER_FLAGS `` $ { REALM_LINKER_FLAGS } -lz '' ) endif ( ) diff -- git a/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp b/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp index 48e47cf..ab772f4 100644 -- - a/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp +++ b/realm/realm-library/src/main/cpp/io_realm_internal_Util.cpp @ @ -17,6 +17,7 @ @ # include < jni.h > # include `` jni_util/jni_utils.hpp '' + # include `` jni_util/hack.hpp '' # include < realm/string_data.hpp > # include < realm/unicode.hpp > @ @ -37,6 +38,9 @ @ const string TABLE_PREFIX ( `` class_ '' ) ; JNIEXPORT jint JNICALL JNI_OnLoad ( JavaVM* vm , void* ) { + // Workaround for some known bugs in system calls on specific devices . + hack_init ( ) ; + JNIEnv* env ; if ( vm- > GetEnv ( ( void** ) & RealmMigrationNeededException only on Android 4.2.2 and Samsung Galaxy S3 Mini __EoT__ Our crash logs just start showing up this crash . It only affects Android version 4.2.2 and Samsung GT-I8200N phone . Realm version 2.3.1 `` ` java.lang.RuntimeException : Unable to start activity ComponentInfo { MainActivity } : io.realm.exceptions.RealmMigrationNeededException : The 'RealmPumpBasalRateConfig ' class is missing from the schema for this Realm . at android.app.ActivityThread.performLaunchActivity ( ActivityThread.java:2262 ) at android.app.ActivityThread.handleLaunchActivity ( ActivityThread.java:2316 ) at android.app.ActivityThread.access $ 700 ( ActivityThread.java:158 ) at android.app.ActivityThread $ H.handleMessage ( ActivityThread.java:1296 ) at android.os.Handler.dispatchMessage ( Handler.java:99 ) at android.os.Looper.loop ( Looper.java:176 ) at android.app.ActivityThread.main ( ActivityThread.java:5365 ) at java.lang.reflect.Method.invokeNative ( Native Method ) at java.lang.reflect.Method.invoke ( Method.java:511 ) at com.android.internal.os.ZygoteInit $ MethodAndArgsCaller.run ( ZygoteInit.java:1102 ) at com.android.internal.os.ZygoteInit.main ( ZygoteInit.java:869 ) at dalvik.system.NativeStart.main ( Native Method ) Caused by : io.realm.exceptions.RealmMigrationNeededException : The 'RealmPumpBasalRateConfig ' class is missing from the schema for this Realm . at io.realm.RealmPumpBasalRateConfigRealmProxy.validateTable ( RealmPumpBasalRateConfigRealmProxy.java:495 ) at io.realm.DefaultRealmModuleMediator.validateTable ( DefaultRealmModuleMediator.java:66 ) at io.realm.Realm.initializeRealm ( Realm.java:348 ) at io.realm.Realm.createAndValidate ( Realm.java:313 ) at io.realm.Realm.createInstance ( Realm.java:278 ) at io.realm.RealmCache.createRealmOrGetFromCache ( RealmCache.java:143 ) at io.realm.Realm.getDefaultInstance ( Realm.java:209 ) `` `
diff -- git a/realm/realm-jni/build.gradle b/realm/realm-jni/build.gradle index 93e83ca..78fd04b 100644 -- - a/realm/realm-jni/build.gradle +++ b/realm/realm-jni/build.gradle @ @ -65,12 +65,12 @ @ def toolchains = [ ] def targets = [ - new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , - new Target ( name : 'arm-v7a ' , jniFolder : 'armeabi-v7a ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' , '-march=armv7-a ' , '-mfloat-abi=softfp ' , '-mfpu=vfpv3-d16 ' ] ) , - new Target ( name : 'arm64 ' , jniFolder : 'arm64-v8a ' , toolchain : toolchains.find { it.name == 'arm64 ' } , cflags : [ ] ) , - new Target ( name : 'mips ' , jniFolder : 'mips ' , toolchain : toolchains.find { it.name == 'mips ' } , cflags : [ ] ) , +// new Target ( name : 'arm ' , jniFolder : 'armeabi ' , toolchain : toolchains.find { it.name == 'arm ' } , cflags : [ '-mthumb ' ] ) , +// new Target ( name : 'arm-v7a ConcurrentModificationException when using iterators methods __EoT__ Hi , I have such exception even I using iterators methods : Realm version 0.75.1 , Android studio 1.0rc2 `` ` Caused by : java.util.ConcurrentModificationException : No outside changes to a Realm is allowed while iterating a RealmResults . Use iterators methods instead . at io.realm.RealmResults.assertRealmIsStable ( RealmResults.java:405 ) at io.realm.RealmResults.access $ 200 ( RealmResults.java:44 ) at io.realm.RealmResults $ RealmResultsIterator.hasNext ( RealmResults.java:422 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:360 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:347 ) at android.os.AsyncTask $ 2.call ( AsyncTask.java:288 ) at java.util.concurrent.FutureTask.run ( FutureTask.java:237 ) at android.os.AsyncTask $ SerialExecutor $ 1.run ( AsyncTask.java:231 ) at java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1112 ) at java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:587 ) at java.lang.Thread.run ( Thread.java:818 ) `` ` Here is part of my code : `` ` ****AsyncTask***** List < SchoolResult > favoriteSchools = params [ 0 ] ; Realm realm = Realm.getInstance ( context ) ; realm.beginTransaction ( ) ; // Set all schools to remove RealmResults < RealmSchoolResult > markToRemove = realm.where ( RealmSchoolResult.class ) .equalTo ( `` userAccountId '' , userId ) .findAll ( ) ; Iterator < RealmSchoolResult > schoolResultIterator = markToRemove.iterator ( ) ; while ( schoolResultIterator.hasNext ( ) )
diff -- git a/realm/realm-jni/src/io_realm_internal_TableView.h b/realm/realm-jni/src/io_realm_internal_TableView.h index 63c986e..4afb233 100644 -- - a/realm/realm-jni/src/io_realm_internal_TableView.h +++ b/realm/realm-jni/src/io_realm_internal_TableView.h @ @ -561,10 +561,10 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_TableView_nativePivot /* * Class : io_realm_internal_TableView - * Method : nativeSync + * Method : nativeSyncIfNeeded * Signature : ( J ) J */ -JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSync +JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSyncIfNeeded ( JNIEnv * , jobject , jlong ) ; /* diff -- git a/realm/realm-jni/src/io_realm_internal_tableview.cpp b/realm/realm-jni/src/io_realm_internal_tableview.cpp index 93d2fd0..0b3fb74 100644 -- - a/realm/realm-jni/src/io_realm_internal_tableview.cpp +++ b/realm/realm-jni/src/io_realm_internal_tableview.cpp @ @ -34,7 +34,12 @ @ inline bool view_valid_and_in_sync ( JNIEnv* env , jlong nativeViewPtr ) { ThrowException ( env , TableInvalid , `` The Realm has been closed and is no longer accessible . `` ) ; return false ; } - TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + if ( ! TV ( nativeViewPtr ) - > is_in_sync ( ) & & TV ( nativeViewPtr ) - > outside_version ( ) == std : :numeric_limits < uint64_t > : :max ( ) ) { + // This table view is no longer valid . By calling sync_if_needed we ensure it behaves + // properly as a 0-size TableView . + TV ( nativeViewPtr ) - > sync_if_needed ConcurrentModificationException when using iterators methods __EoT__ Hi , I have such exception even I using iterators methods : Realm version 0.75.1 , Android studio 1.0rc2 `` ` Caused by : java.util.ConcurrentModificationException : No outside changes to a Realm is allowed while iterating a RealmResults . Use iterators methods instead . at io.realm.RealmResults.assertRealmIsStable ( RealmResults.java:405 ) at io.realm.RealmResults.access $ 200 ( RealmResults.java:44 ) at io.realm.RealmResults $ RealmResultsIterator.hasNext ( RealmResults.java:422 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:360 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:347 ) at android.os.AsyncTask $ 2.call ( AsyncTask.java:288 ) at java.util.concurrent.FutureTask.run ( FutureTask.java:237 ) at android.os.AsyncTask $ SerialExecutor $ 1.run ( AsyncTask.java:231 ) at java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1112 ) at java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:587 ) at java.lang.Thread.run ( Thread.java:818 ) `` ` Here is part of my code : `` ` ****AsyncTask***** List < SchoolResult > favoriteSchools = params [ 0 ] ; Realm realm = Realm.getInstance ( context ) ; realm.beginTransaction ( ) ; // Set all schools to remove RealmResults < RealmSchoolResult > markToRemove = realm.where ( RealmSchoolResult.class ) .equalTo ( `` userAccountId '' , userId ) .findAll ( ) ; Iterator < RealmSchoolResult > schoolResultIterator = markToRemove.iterator ( ) ; while ( schoolResultIterator.hasNext ( ) )
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 8937e5d..4fa429b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,3 +1,12 @ @ + # # 0.89.0 +* BREAKING CHANGE : RealmResults.clear ( ) now throws UnsupportedOperationException . Use RealmResults.deleteAllFromRealm ( ) instead . +* BREAKING CHANGE : RealmResults.remove ( int ) now throws UnsupportedOperationException . Use RealmResults.deleteFromRealm ( ) instead . +* Added two new interfaces : RealmCollection and OrderedRealmCollection . RealmList and RealmResults both implement these interfaces . +* Deprecated RealmObject.removeFromRealm ( ) in place of RealmObject.deleteFromRealm ( ) +* Deprecated Realm.clear ( Class ) in place of Realm.delete ( Class ) . +* Deprecated DynamicRealm.clear ( Class ) in place of DynamicRealm.delete ( Class ) . +* RealmBaseAdapter now accept an OrderedRealmCollection instead of only RealmResults . + # # 0.88.0 * Updated Realm Core to 0.97.0. diff -- git a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java index 69915fc..3a4afc8 100644 -- - a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java +++ b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java @ @ -54,7 +54,7 @ @ public class AdapterExampleActivity extends Activity { listView.setOnItemLongClickListener ( new AdapterView.OnItemLongClickListener ( ) { @ Override public boolean onItemLongClick ( AdapterView < ? > adapterView , View view , int i , long l ) { - TimeStamp timeStamp = adapter.getRealmResults ( ) .get ( i ConcurrentModificationException when using iterators methods __EoT__ Hi , I have such exception even I using iterators methods : Realm version 0.75.1 , Android studio 1.0rc2 `` ` Caused by : java.util.ConcurrentModificationException : No outside changes to a Realm is allowed while iterating a RealmResults . Use iterators methods instead . at io.realm.RealmResults.assertRealmIsStable ( RealmResults.java:405 ) at io.realm.RealmResults.access $ 200 ( RealmResults.java:44 ) at io.realm.RealmResults $ RealmResultsIterator.hasNext ( RealmResults.java:422 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:360 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:347 ) at android.os.AsyncTask $ 2.call ( AsyncTask.java:288 ) at java.util.concurrent.FutureTask.run ( FutureTask.java:237 ) at android.os.AsyncTask $ SerialExecutor $ 1.run ( AsyncTask.java:231 ) at java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1112 ) at java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:587 ) at java.lang.Thread.run ( Thread.java:818 ) `` ` Here is part of my code : `` ` ****AsyncTask***** List < SchoolResult > favoriteSchools = params [ 0 ] ; Realm realm = Realm.getInstance ( context ) ; realm.beginTransaction ( ) ; // Set all schools to remove RealmResults < RealmSchoolResult > markToRemove = realm.where ( RealmSchoolResult.class ) .equalTo ( `` userAccountId '' , userId ) .findAll ( ) ; Iterator < RealmSchoolResult > schoolResultIterator = markToRemove.iterator ( ) ; while ( schoolResultIterator.hasNext ( ) )
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 21c5444..008b31b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,7 +1,19 @ @ # # 0.89.0 - # # # Enhancements + # # # Breaking changes +* RealmResults.clear ( ) now throws UnsupportedOperationException . Use RealmResults.deleteAllFromRealm ( ) instead . +* RealmResults.remove ( int ) now throws UnsupportedOperationException . Use RealmResults.deleteFromRealm ( ) instead . + + # # # Deprecated + +* RealmObject.removeFromRealm ( ) in place of RealmObject.deleteFromRealm ( ) +* Realm.clear ( Class ) in place of Realm.delete ( Class ) . +* DynamicRealm.clear ( Class ) in place of DynamicRealm.delete ( Class ) . + + # # # Enhancements +* RealmCollection and OrderedRealmCollection have been added . RealmList and RealmResults both implement these interfaces . +* RealmBaseAdapter now accept an OrderedRealmCollection instead of only RealmResults . * RealmObjectSchema.isPrimaryKey ( String ) ( # 2440 ) # # # Bug fixes diff -- git a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java index 69915fc..3a4afc8 100644 -- - a/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java +++ b/examples/adapterExample/src/main/java/io/realm/examples/realmadapters/AdapterExampleActivity.java @ @ -54,7 +54,7 @ @ public class AdapterExampleActivity extends Activity { listView.setOnItemLongClickListener ( new AdapterView.OnItemLongClickListener ( ) { @ Override public boolean onItemLongClick ( AdapterView < ? > adapterView , View view , int ConcurrentModificationException when using iterators methods __EoT__ Hi , I have such exception even I using iterators methods : Realm version 0.75.1 , Android studio 1.0rc2 `` ` Caused by : java.util.ConcurrentModificationException : No outside changes to a Realm is allowed while iterating a RealmResults . Use iterators methods instead . at io.realm.RealmResults.assertRealmIsStable ( RealmResults.java:405 ) at io.realm.RealmResults.access $ 200 ( RealmResults.java:44 ) at io.realm.RealmResults $ RealmResultsIterator.hasNext ( RealmResults.java:422 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:360 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:347 ) at android.os.AsyncTask $ 2.call ( AsyncTask.java:288 ) at java.util.concurrent.FutureTask.run ( FutureTask.java:237 ) at android.os.AsyncTask $ SerialExecutor $ 1.run ( AsyncTask.java:231 ) at java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1112 ) at java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:587 ) at java.lang.Thread.run ( Thread.java:818 ) `` ` Here is part of my code : `` ` ****AsyncTask***** List < SchoolResult > favoriteSchools = params [ 0 ] ; Realm realm = Realm.getInstance ( context ) ; realm.beginTransaction ( ) ; // Set all schools to remove RealmResults < RealmSchoolResult > markToRemove = realm.where ( RealmSchoolResult.class ) .equalTo ( `` userAccountId '' , userId ) .findAll ( ) ; Iterator < RealmSchoolResult > schoolResultIterator = markToRemove.iterator ( ) ; while ( schoolResultIterator.hasNext ( ) )
diff -- git a/realm/realm-jni/src/io_realm_internal_TableView.h b/realm/realm-jni/src/io_realm_internal_TableView.h index 63c986e..4afb233 100644 -- - a/realm/realm-jni/src/io_realm_internal_TableView.h +++ b/realm/realm-jni/src/io_realm_internal_TableView.h @ @ -561,10 +561,10 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_TableView_nativePivot /* * Class : io_realm_internal_TableView - * Method : nativeSync + * Method : nativeSyncIfNeeded * Signature : ( J ) J */ -JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSync +JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSyncIfNeeded ( JNIEnv * , jobject , jlong ) ; /* diff -- git a/realm/realm-jni/src/io_realm_internal_tableview.cpp b/realm/realm-jni/src/io_realm_internal_tableview.cpp index 93d2fd0..e1f6ad2 100644 -- - a/realm/realm-jni/src/io_realm_internal_tableview.cpp +++ b/realm/realm-jni/src/io_realm_internal_tableview.cpp @ @ -34,7 +34,12 @ @ inline bool view_valid_and_in_sync ( JNIEnv* env , jlong nativeViewPtr ) { ThrowException ( env , TableInvalid , `` The Realm has been closed and is no longer accessible . `` ) ; return false ; } - TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + if ( ! TV ( nativeViewPtr ) - > is_in_sync ( ) & & TV ( nativeViewPtr ) - > depends_on_deleted_linklist ( ) ) { + // This table view is no longer valid . By calling sync_if_needed we ensure it behaves + // properly as a 0-size TableView . + TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + } + } return valid ; } ConcurrentModificationException when using iterators methods __EoT__ Hi , I have such exception even I using iterators methods : Realm version 0.75.1 , Android studio 1.0rc2 `` ` Caused by : java.util.ConcurrentModificationException : No outside changes to a Realm is allowed while iterating a RealmResults . Use iterators methods instead . at io.realm.RealmResults.assertRealmIsStable ( RealmResults.java:405 ) at io.realm.RealmResults.access $ 200 ( RealmResults.java:44 ) at io.realm.RealmResults $ RealmResultsIterator.hasNext ( RealmResults.java:422 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:360 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:347 ) at android.os.AsyncTask $ 2.call ( AsyncTask.java:288 ) at java.util.concurrent.FutureTask.run ( FutureTask.java:237 ) at android.os.AsyncTask $ SerialExecutor $ 1.run ( AsyncTask.java:231 ) at java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1112 ) at java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:587 ) at java.lang.Thread.run ( Thread.java:818 ) `` ` Here is part of my code : `` ` ****AsyncTask***** List < SchoolResult > favoriteSchools = params [ 0 ] ; Realm realm = Realm.getInstance ( context ) ; realm.beginTransaction ( ) ; // Set all schools to remove RealmResults < RealmSchoolResult > markToRemove = realm.where ( RealmSchoolResult.class ) .equalTo ( `` userAccountId '' , userId ) .findAll ( ) ; Iterator < RealmSchoolResult > schoolResultIterator = markToRemove.iterator ( ) ; while ( schoolResultIterator.hasNext ( ) )
diff -- git a/realm/realm-jni/src/io_realm_internal_TableView.h b/realm/realm-jni/src/io_realm_internal_TableView.h index 63c986e..4afb233 100644 -- - a/realm/realm-jni/src/io_realm_internal_TableView.h +++ b/realm/realm-jni/src/io_realm_internal_TableView.h @ @ -561,10 +561,10 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_TableView_nativePivot /* * Class : io_realm_internal_TableView - * Method : nativeSync + * Method : nativeSyncIfNeeded * Signature : ( J ) J */ -JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSync +JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSyncIfNeeded ( JNIEnv * , jobject , jlong ) ; /* diff -- git a/realm/realm-jni/src/io_realm_internal_tableview.cpp b/realm/realm-jni/src/io_realm_internal_tableview.cpp index 93d2fd0..8cc132a 100644 -- - a/realm/realm-jni/src/io_realm_internal_tableview.cpp +++ b/realm/realm-jni/src/io_realm_internal_tableview.cpp @ @ -34,7 +34,13 @ @ inline bool view_valid_and_in_sync ( JNIEnv* env , jlong nativeViewPtr ) { ThrowException ( env , TableInvalid , `` The Realm has been closed and is no longer accessible . `` ) ; return false ; } - TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + // depends_on_deleted_linklist ( ) will return true if and only if the current TableView was created from a + // query on a RealmList and that RealmList was then deleted ( as a result of the object being deleted ) . + if ( ! TV ( nativeViewPtr ) - > is_in_sync ( ) & & TV ( nativeViewPtr ) - > depends_on_deleted_linklist ( ) ) { + // ConcurrentModificationException when using iterators methods __EoT__ Hi , I have such exception even I using iterators methods : Realm version 0.75.1 , Android studio 1.0rc2 `` ` Caused by : java.util.ConcurrentModificationException : No outside changes to a Realm is allowed while iterating a RealmResults . Use iterators methods instead . at io.realm.RealmResults.assertRealmIsStable ( RealmResults.java:405 ) at io.realm.RealmResults.access $ 200 ( RealmResults.java:44 ) at io.realm.RealmResults $ RealmResultsIterator.hasNext ( RealmResults.java:422 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:360 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:347 ) at android.os.AsyncTask $ 2.call ( AsyncTask.java:288 ) at java.util.concurrent.FutureTask.run ( FutureTask.java:237 ) at android.os.AsyncTask $ SerialExecutor $ 1.run ( AsyncTask.java:231 ) at java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1112 ) at java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:587 ) at java.lang.Thread.run ( Thread.java:818 ) `` ` Here is part of my code : `` ` ****AsyncTask***** List < SchoolResult > favoriteSchools = params [ 0 ] ; Realm realm = Realm.getInstance ( context ) ; realm.beginTransaction ( ) ; // Set all schools to remove RealmResults < RealmSchoolResult > markToRemove = realm.where ( RealmSchoolResult.class ) .equalTo ( `` userAccountId '' , userId ) .findAll ( ) ; Iterator < RealmSchoolResult > schoolResultIterator = markToRemove.iterator ( ) ; while ( schoolResultIterator.hasNext ( ) )
diff -- git a/realm/realm-jni/src/io_realm_internal_TableView.h b/realm/realm-jni/src/io_realm_internal_TableView.h index 63c986e..4afb233 100644 -- - a/realm/realm-jni/src/io_realm_internal_TableView.h +++ b/realm/realm-jni/src/io_realm_internal_TableView.h @ @ -561,10 +561,10 @ @ JNIEXPORT void JNICALL Java_io_realm_internal_TableView_nativePivot /* * Class : io_realm_internal_TableView - * Method : nativeSync + * Method : nativeSyncIfNeeded * Signature : ( J ) J */ -JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSync +JNIEXPORT jlong JNICALL Java_io_realm_internal_TableView_nativeSyncIfNeeded ( JNIEnv * , jobject , jlong ) ; /* diff -- git a/realm/realm-jni/src/io_realm_internal_tableview.cpp b/realm/realm-jni/src/io_realm_internal_tableview.cpp index 93d2fd0..6a7e887 100644 -- - a/realm/realm-jni/src/io_realm_internal_tableview.cpp +++ b/realm/realm-jni/src/io_realm_internal_tableview.cpp @ @ -34,7 +34,13 @ @ inline bool view_valid_and_in_sync ( JNIEnv* env , jlong nativeViewPtr ) { ThrowException ( env , TableInvalid , `` The Realm has been closed and is no longer accessible . `` ) ; return false ; } - TV ( nativeViewPtr ) - > sync_if_needed ( ) ; + // depends_on_deleted_linklist ( ) will return true if and only if the current TableView was created from a + // query on a RealmList and that RealmList was then deleted ( as a result of the object being deleted ) . + if ( ! TV ( nativeViewPtr ) - > is_in_sync ( ) & & TV ( nativeViewPtr ) - > depends_on_deleted_linklist ( ) ) { + // ConcurrentModificationException when using iterators methods __EoT__ Hi , I have such exception even I using iterators methods : Realm version 0.75.1 , Android studio 1.0rc2 `` ` Caused by : java.util.ConcurrentModificationException : No outside changes to a Realm is allowed while iterating a RealmResults . Use iterators methods instead . at io.realm.RealmResults.assertRealmIsStable ( RealmResults.java:405 ) at io.realm.RealmResults.access $ 200 ( RealmResults.java:44 ) at io.realm.RealmResults $ RealmResultsIterator.hasNext ( RealmResults.java:422 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:360 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:347 ) at android.os.AsyncTask $ 2.call ( AsyncTask.java:288 ) at java.util.concurrent.FutureTask.run ( FutureTask.java:237 ) at android.os.AsyncTask $ SerialExecutor $ 1.run ( AsyncTask.java:231 ) at java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1112 ) at java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:587 ) at java.lang.Thread.run ( Thread.java:818 ) `` ` Here is part of my code : `` ` ****AsyncTask***** List < SchoolResult > favoriteSchools = params [ 0 ] ; Realm realm = Realm.getInstance ( context ) ; realm.beginTransaction ( ) ; // Set all schools to remove RealmResults < RealmSchoolResult > markToRemove = realm.where ( RealmSchoolResult.class ) .equalTo ( `` userAccountId '' , userId ) .findAll ( ) ; Iterator < RealmSchoolResult > schoolResultIterator = markToRemove.iterator ( ) ; while ( schoolResultIterator.hasNext ( ) )
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 6474da9..37fe8e1 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -2,32 +2,32 @ @ # # # Breaking changes -* @ PrimaryKey field value can be null for String , Byte , Short , Integer , and Long types . Older Realms should be migrated , using RealmObjectSchema.setNullable ( ) , or by adding the @ Required annotation . ( # 2515 ) . -* RealmResults.clear ( ) now throws UnsupportedOperationException . Use RealmResults.deleteAllFromRealm ( ) instead . -* RealmResults.remove ( int ) now throws UnsupportedOperationException . Use RealmResults.deleteFromRealm ( ) instead . -* Removed deprecated methods Realm.getTable ( ) from public API . +* @ PrimaryKey field value can now be null for String , Byte , Short , Integer , and Long types . Older Realms should be migrated , using RealmObjectSchema.setNullable ( ) , or by adding the @ Required annotation . ( # 2515 ) . +* ` RealmResults.clear ( ) ` now throws UnsupportedOperationException . Use ` RealmResults.deleteAllFromRealm ( ) ` instead . +* ` RealmResults.remove ( int ) ` now throws UnsupportedOperationException . Use ` RealmResults.deleteFromRealm ( int ) ` instead . +* Removed deprecated method ` Realm.getTable ( ConcurrentModificationException when using iterators methods __EoT__ Hi , I have such exception even I using iterators methods : Realm version 0.75.1 , Android studio 1.0rc2 `` ` Caused by : java.util.ConcurrentModificationException : No outside changes to a Realm is allowed while iterating a RealmResults . Use iterators methods instead . at io.realm.RealmResults.assertRealmIsStable ( RealmResults.java:405 ) at io.realm.RealmResults.access $ 200 ( RealmResults.java:44 ) at io.realm.RealmResults $ RealmResultsIterator.hasNext ( RealmResults.java:422 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:360 ) at com.coachesdirectory.coach.db.RealmHelper $ 5.doInBackground ( RealmHelper.java:347 ) at android.os.AsyncTask $ 2.call ( AsyncTask.java:288 ) at java.util.concurrent.FutureTask.run ( FutureTask.java:237 ) at android.os.AsyncTask $ SerialExecutor $ 1.run ( AsyncTask.java:231 ) at java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1112 ) at java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:587 ) at java.lang.Thread.run ( Thread.java:818 ) `` ` Here is part of my code : `` ` ****AsyncTask***** List < SchoolResult > favoriteSchools = params [ 0 ] ; Realm realm = Realm.getInstance ( context ) ; realm.beginTransaction ( ) ; // Set all schools to remove RealmResults < RealmSchoolResult > markToRemove = realm.where ( RealmSchoolResult.class ) .equalTo ( `` userAccountId '' , userId ) .findAll ( ) ; Iterator < RealmSchoolResult > schoolResultIterator = markToRemove.iterator ( ) ; while ( schoolResultIterator.hasNext ( ) )
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Upgrade to Finatra 1.1.1 __EoT__ 1.1.1 has a bunch of goodies over 0.2.4 and is available on Maven Central .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Update gradle-bintray-plugin to 1.3 when its released __EoT__ See https : //github.com/bintray/gradle-bintray-plugin/issues/68 We need update the plugin when it is released . This should solve the problem , when jars are bintrayUpload'ed they are not published and you need to bintray.com to click the publish link .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Javascript library updates __EoT__ It would be great if someone can update our javascript libraries . They are all pretty old .
diff -- git a/zipkin-collector/kafka/src/main/java/zipkin2/collector/kafka/KafkaCollector.java b/zipkin-collector/kafka/src/main/java/zipkin2/collector/kafka/KafkaCollector.java index 01a25d6..3e95877 100644 -- - a/zipkin-collector/kafka/src/main/java/zipkin2/collector/kafka/KafkaCollector.java +++ b/zipkin-collector/kafka/src/main/java/zipkin2/collector/kafka/KafkaCollector.java @ @ -15,12 +15,12 @ @ package zipkin2.collector.kafka ; import java.util.Map ; import java.util.Properties ; -import java.util.concurrent.CopyOnWriteArrayList ; -import java.util.concurrent.ExecutorService ; -import java.util.concurrent.Executors ; -import java.util.concurrent.TimeUnit ; +import java.util.concurrent . * ; import java.util.concurrent.atomic.AtomicReference ; + +import org.apache.kafka.clients.admin.AdminClient ; import org.apache.kafka.common.KafkaException ; +import org.apache.kafka.common.KafkaFuture ; import org.apache.kafka.common.config.ConfigException ; import org.apache.kafka.common.errors.InterruptException ; import org.apache.kafka.common.serialization.ByteArrayDeserializer ; @ @ -148,9 +148,11 @ @ public final class KafkaCollector extends CollectorComponent { } final LazyKafkaWorkers kafkaWorkers ; + private final AdminClient adminClient ; KafkaCollector ( Builder builder ) { kafkaWorkers = new LazyKafkaWorkers ( builder ) ; + adminClient = AdminClient.create ( builder.properties ) ; } @ Override @ @ -164,8 +166,10 @ @ public final class KafkaCollector extends CollectorComponent { try { CheckResult failure = kafkaWorkers.failure.get ( ) ; // check the kafka workers did n't quit if ( failure ! = null ) return failure ; + KafkaFuture < String > maybeClusterId = adminClient.describeCluster ( ) .clusterId ( ) ; + maybeClusterId.get ( 1 , TimeUnit.SECONDS ) ; return CheckResult.OK ; - } catch ( RuntimeException e ) { + } catch ( RuntimeException | TimeoutException | ExecutionException | InterruptedException Make kafka health check meaningful __EoT__ Right now , the kafka health check returns ok eventhough it is not . Let 's improve that .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Make fetch.message.max.bytes configurable __EoT__ Recently , we migrate our transport from scribe to kafka , but our zipkin seems not accept any message . Our kafka server have a ` message.max.bytes ` that are greater than the default 1024*1024 byte , and it is not easily to change it . It seems ` KafkaSpanReceiver.receiverProps ` is the ConsumerConfig , but we can not pass ` fetch.message.max.bytes ` via environment variable , which is inconvenient .
diff -- git a/zipkin-storage/cassandra/src/main/java/zipkin/storage/cassandra/CassandraSpanConsumer.java b/zipkin-storage/cassandra/src/main/java/zipkin/storage/cassandra/CassandraSpanConsumer.java index 1bad77b..86cbd4a 100644 -- - a/zipkin-storage/cassandra/src/main/java/zipkin/storage/cassandra/CassandraSpanConsumer.java +++ b/zipkin-storage/cassandra/src/main/java/zipkin/storage/cassandra/CassandraSpanConsumer.java @ @ -19,6 +19,7 @ @ import com.datastax.driver.core.RegularStatement ; import com.datastax.driver.core.Session ; import com.datastax.driver.core.querybuilder.Insert ; import com.datastax.driver.core.querybuilder.QueryBuilder ; +import com.datastax.driver.core.utils.UUIDs ; import com.google.common.annotations.VisibleForTesting ; import com.google.common.base.Function ; import com.google.common.base.Functions ; @ @ -29,6 +30,7 @ @ import com.google.common.util.concurrent.Futures ; import com.google.common.util.concurrent.ListenableFuture ; import java.nio.ByteBuffer ; import java.util.List ; +import java.util.UUID ; import org.slf4j.Logger ; import org.slf4j.LoggerFactory ; import zipkin.Codec ; @ @ -207,9 +209,12 @ @ final class CassandraSpanConsumer implements GuavaSpanConsumer { .setInt ( `` bucket '' , bucket ) .setString ( `` service_name '' , serviceName ) .setString ( `` span_name '' , spanName ) - .setBytesUnsafe ( `` ts '' , timestampCodec.serialize ( timestamp ) ) + .setUUID ( `` ts '' , new UUID ( + UUIDs.startOf ( timestamp ) .getMostSignificantBits ( ) , + UUIDs.timeBased ( ) .getLeastSignificantBits ( ) ) ) .setLong ( `` duration '' , duration ) .setLong ( `` trace_id '' , traceId ) ; + if ( indexTtl ! = null ) bound.setInt ( `` ttl_ '' , indexTtl ) ; return session.executeAsync ( bound ) ; diff -- git a/zipkin-storage/cassandra/src/main/java/zipkin/storage/cassandra/CassandraSpanStore.java b/zipkin-storage/cassandra/src/main/java/zipkin/storage/cassandra/CassandraSpanStore.java index 7a68855..c6a765c 100644 -- - a/zipkin-storage/cassandra/src/main/java/zipkin/storage/cassandra/CassandraSpanStore.java Refactor duration query in cassandra __EoT__ _From @ adriancole on May 6 , 2016 0:59_ The duration query is the most expensive query in cassandra , as it turns into 1 request per hour of lookback , limited to indexTtl . The UI 's default lookback is a day , so this means 24 requests to the backend . If someone sets the ui to an early time , it limits at index TTL , which defaults to 7 days or 168 requests ! We should look into alternatives , perhaps doing a `` peek '' at the first bucket and only proceeding to fan out if that does n't meet the response limit . Since the response limit is often 10 , it might actually be fine . See # 199 cc @ eirslett @ yurishkuro @ danchia _Copied from original issue : openzipkin/zipkin-java # 200_
diff -- git a/zipkin-autoconfigure/ui/src/main/java/zipkin/autoconfigure/ui/ZipkinUiAutoConfiguration.java b/zipkin-autoconfigure/ui/src/main/java/zipkin/autoconfigure/ui/ZipkinUiAutoConfiguration.java index a7cecef..f2f4934 100644 -- - a/zipkin-autoconfigure/ui/src/main/java/zipkin/autoconfigure/ui/ZipkinUiAutoConfiguration.java +++ b/zipkin-autoconfigure/ui/src/main/java/zipkin/autoconfigure/ui/ZipkinUiAutoConfiguration.java @ @ -18,7 +18,6 @ @ import javax.servlet.http.HttpServletRequest ; import org.springframework.beans.factory.annotation.Autowired ; import org.springframework.beans.factory.annotation.Value ; import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty ; -import org.springframework.boot.autoconfigure.condition.ConditionalOnResource ; import org.springframework.boot.context.properties.EnableConfigurationProperties ; import org.springframework.context.annotation.Bean ; import org.springframework.context.annotation.Configuration ; @ @ -26,6 +25,7 @ @ import org.springframework.core.Ordered ; import org.springframework.core.annotation.Order ; import org.springframework.core.io.Resource ; import org.springframework.http.CacheControl ; +import org.springframework.http.MediaType ; import org.springframework.http.ResponseEntity ; import org.springframework.ui.ModelMap ; import org.springframework.web.bind.annotation.RequestMapping ; @ @ -35,11 +35,12 @ @ import org.springframework.web.servlet.ModelAndView ; import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry ; import org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter ; -import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE ; import static org.springframework.web.bind.annotation.RequestMethod.GET ; /** - * Zipkin-UI is a single-page application that reads configuration from /config.json . + * Zipkin-UI is a single-page application mounted at /zipkin . For simplicity , assume paths mentioned + * below are relative to that . For example , the UI reads config.json , from the absolute path + * /zipkin/config.json * * < p > When looking at a trace , the browser is sent to the path `` /traces/ { id } '' . For the single-page * app to serve that route , the server needs to forward the request to `` /index.html '' . The same @ Investigate custom context root __EoT__ _From @ adriancole on May 21 , 2016 13:47_ https : //github.com/openzipkin/docker-zipkin/issues/97 was opened about moving all zipkin things under the context root /zipkin ( directly vs via a reverse proxy ) . This might be possible with OOB spring boot . If so , we could consider this . Otherwise we can close it with explanation in case the question comes up again . _Copied from original issue : openzipkin/zipkin-java # 244_
diff -- git a/benchmarks/src/main/java/zipkin/benchmarks/MetricsBenchmarks.java b/benchmarks/src/main/java/zipkin/benchmarks/MetricsBenchmarks.java index c2b9cc3..d5b1397 100644 -- - a/benchmarks/src/main/java/zipkin/benchmarks/MetricsBenchmarks.java +++ b/benchmarks/src/main/java/zipkin/benchmarks/MetricsBenchmarks.java @ @ -16,6 +16,7 @ @ package zipkin.benchmarks ; import io.micrometer.core.instrument.MeterRegistry ; import io.micrometer.prometheus.PrometheusConfig ; import io.micrometer.prometheus.PrometheusMeterRegistry ; +import java.util.concurrent.TimeUnit ; import org.openjdk.jmh.annotations.Benchmark ; import org.openjdk.jmh.annotations.BenchmarkMode ; import org.openjdk.jmh.annotations.Fork ; @ @ -30,12 +31,9 @ @ import org.openjdk.jmh.runner.Runner ; import org.openjdk.jmh.runner.RunnerException ; import org.openjdk.jmh.runner.options.Options ; import org.openjdk.jmh.runner.options.OptionsBuilder ; -import org.springframework.beans.factory.annotation.Autowired ; -import zipkin.collector.CollectorMetrics ; -import zipkin.collector.InMemoryCollectorMetrics ; import zipkin.server.internal.ActuateCollectorMetrics ; - -import java.util.concurrent.TimeUnit ; +import zipkin2.collector.CollectorMetrics ; +import zipkin2.collector.InMemoryCollectorMetrics ; @ Measurement ( iterations = 80 , time = 1 ) @ Warmup ( iterations = 20 , time = 1 ) diff -- git a/pom.xml b/pom.xml index afff24a..34b7633 100755 -- - a/pom.xml +++ b/pom.xml @ @ -157,6 +157,12 @ @ < dependency > < groupId > io.zipkin.zipkin2 < /groupId > + < artifactId > zipkin-collector < /artifactId > + < version > $ { project.version } < /version > + < /dependency > + + < dependency > + < groupId > io.zipkin.zipkin2 < /groupId > < artifactId > zipkin-storage-elasticsearch < /artifactId > < version > $ { project.version } < /version > < /dependency > @ @ -247,49 +253,49 @ @ < /dependency > < Get rid of the v1 codebase __EoT__ We do n't have a lot of hands to do `` huge maintenance work '' . There was a lot of demand for a v2 format , so we released a v2 core library as soon as we could ( september 2017 ) . With this in place , we were able to decouple libraries from the v1 codebase . This included brave and zipkin-reporter , which no longer have mandatory dependencies on it . However , there 's still a large amount of work to do . This issue tracks that work : - [ x ] Port mysql ( as-is ) to the zipkin2 codebase , or redo it - [ x ] Port `` cassandra '' ( as-is ) to the zipkin2 codebase , or drop it - [ x ] Remove zipkin v1 dep from zipkin-junit and repackage under io.zipkin.zipkin2 namespace - [ x ] Make a new collector , which accepts even the old v1 thrift : make the server depend on it . - [ x ] redo all the storage tests to port to v2 codebase - [ x ] implement the zipkin UI in v2
diff -- git a/zipkin-autoconfigure/storage-elasticsearch-http/src/main/java/zipkin/autoconfigure/storage/elasticsearch/http/ZipkinElasticsearchHttpStorageAutoConfiguration.java b/zipkin-autoconfigure/storage-elasticsearch-http/src/main/java/zipkin/autoconfigure/storage/elasticsearch/http/ZipkinElasticsearchHttpStorageAutoConfiguration.java index 472a1c9..1500470 100644 -- - a/zipkin-autoconfigure/storage-elasticsearch-http/src/main/java/zipkin/autoconfigure/storage/elasticsearch/http/ZipkinElasticsearchHttpStorageAutoConfiguration.java +++ b/zipkin-autoconfigure/storage-elasticsearch-http/src/main/java/zipkin/autoconfigure/storage/elasticsearch/http/ZipkinElasticsearchHttpStorageAutoConfiguration.java @ @ -45,8 +45,11 @ @ public class ZipkinElasticsearchHttpStorageAutoConfiguration { ElasticsearchHttpStorage.Builder esHttpBuilder ( ZipkinElasticsearchHttpStorageProperties elasticsearch , @ Qualifier ( `` zipkinElasticsearchHttp '' ) OkHttpClient client , - @ Value ( `` $ { zipkin.storage.strict-trace-id : true } '' ) boolean strictTraceId ) { - return elasticsearch.toBuilder ( client ) .strictTraceId ( strictTraceId ) ; + @ Value ( `` $ { zipkin.storage.strict-trace-id : true } '' ) boolean strictTraceId , + @ Value ( `` $ { zipkin.query.lookback:86400000 } '' ) int namesLookback ) { + return elasticsearch.toBuilder ( client ) + .strictTraceId ( strictTraceId ) + .namesLookback ( namesLookback ) ; } /** cheap check to see if we are likely to include urls */ diff -- git a/zipkin-autoconfigure/storage-elasticsearch-http/src/test/java/zipkin/storage/elasticsearch/http/ZipkinElasticsearchHttpStorageAutoConfigurationTest.java b/zipkin-autoconfigure/storage-elasticsearch-http/src/test/java/zipkin/storage/elasticsearch/http/ZipkinElasticsearchHttpStorageAutoConfigurationTest.java index 09ec5ed..57f79eb 100644 -- - a/zipkin-autoconfigure/storage-elasticsearch-http/src/test/java/zipkin/storage/elasticsearch/http/ZipkinElasticsearchHttpStorageAutoConfigurationTest.java +++ b/zipkin-autoconfigure/storage-elasticsearch-http/src/test/java/zipkin/storage/elasticsearch/http/ZipkinElasticsearchHttpStorageAutoConfigurationTest.java @ @ -13,6 +13,7 @ @ */ package zipkin.storage.elasticsearch.http ; +import java.util.concurrent.TimeUnit ; import okhttp3.Interceptor ; import okhttp3.OkHttpClient ; import org.junit.After ; @ @ -243,6 +244,22 @ @ public class ZipkinElasticsearchHttpStorageAutoConfigurationTest { .isEqualTo ( `` zipkin-1970.01.01 '' ) ; } + @ Test + public void namesLookbackAssignedFromQueryLookback ( ) { + context = new AnnotationConfigApplicationContext ( ) ; Elasticsearch http slow on getting span names when there 's a lot of data __EoT__ from @ dragontree101 because of we have lots of data , service name and span name all time out , i remember store data in cassandra , have table only store service_name and span_name , but store in es , service_name and span_name get by es , so time is very long . ! [ image ] ( https : //cloud.githubusercontent.com/assets/1763935/21561603/a7a8d63c-cea9-11e6-93b0-0ef800b1f7df.png ) and chrome console have ! [ image ] ( https : //cloud.githubusercontent.com/assets/1763935/21561714/5254d35a-ceab-11e6-8fa2-caf5158fc269.png ) i found i set SELF_TRACING_ENABLED= '' true '' in environment ! [ image ] ( https : //cloud.githubusercontent.com/assets/1763935/21562108/a01478c0-ceb0-11e6-83fb-b25d98af937d.png ) and yestoday 's es index is `` ` health status index uuid pri rep docs.count docs.deleted store.size pri.store.size green open zipkin-2016-12-29 2_uXTThATbyoJ7khnXbo4g 5 1 609199726 0 140gb 70gb `` `
diff -- git a/benchmarks/src/main/java/zipkin/benchmarks/MetricsBenchmarks.java b/benchmarks/src/main/java/zipkin/benchmarks/MetricsBenchmarks.java index 18fc1d6..8f8ef80 100644 -- - a/benchmarks/src/main/java/zipkin/benchmarks/MetricsBenchmarks.java +++ b/benchmarks/src/main/java/zipkin/benchmarks/MetricsBenchmarks.java @ @ -1,5 +1,5 @ @ /** - * Copyright 2015-2017 The OpenZipkin Authors + * Copyright 2015-2018 The OpenZipkin Authors * * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except * in compliance with the License . You may obtain a copy of the License at @ @ -32,7 +32,7 @ @ import org.springframework.boot.actuate.metrics.buffer.CounterBuffers ; import org.springframework.boot.actuate.metrics.buffer.GaugeBuffers ; import zipkin.collector.CollectorMetrics ; import zipkin.collector.InMemoryCollectorMetrics ; -import zipkin.server.ActuateCollectorMetrics ; +import zipkin.server.internal.ActuateCollectorMetrics ; import java.io.IOException ; import java.util.concurrent.TimeUnit ; diff -- git a/zipkin-autoconfigure/README.md b/zipkin-autoconfigure/README.md new file mode 100644 index 0000000..1d07f75 -- - /dev/null +++ b/zipkin-autoconfigure/README.md @ @ -0,0 +1,4 @ @ + # zipkin-autoconfigure + +Modules in this directory are considered internal details to Zipkin's +server and are unsupported unless integrated with our [ server build ] ( ../zipkin-server ) . diff -- git a/zipkin-autoconfigure/collector-kafka/src/main/java/zipkin/autoconfigure/collector/kafka/ZipkinKafkaCollectorAutoConfiguration.java b/zipkin-autoconfigure/collector-kafka/src/main/java/zipkin/autoconfigure/collector/kafka/ZipkinKafkaCollectorAutoConfiguration.java index ab727ce..f91149c 100644 -- - a/zipkin-autoconfigure/collector-kafka/src/main/java/zipkin/autoconfigure/collector/kafka/ZipkinKafkaCollectorAutoConfiguration.java +++ b/zipkin-autoconfigure/collector-kafka/src/main/java/zipkin/autoconfigure/collector/kafka/ZipkinKafkaCollectorAutoConfiguration.java @ @ -1,5 +1,5 @ @ /** - * Copyright 2015-2016 The OpenZipkin Authors + * Copyright 2015-2018 The OpenZipkin Authors * * Licensed under the Apache License , Version 2.0 upgrade to Spring Boot 2.0 NoClassDefFoundError UndertowEmbeddedServletContainerFactory __EoT__ UndertowEmbeddedServletContainerFactory has been renamed in Spring Boot 2.0 . It 's now UndertowServletWebServerFactory .
diff -- git a/zipkin-storage/elasticsearch-http/src/main/java/zipkin/storage/elasticsearch/http/HttpBulkSpanIndexer.java b/zipkin-storage/elasticsearch-http/src/main/java/zipkin/storage/elasticsearch/http/HttpBulkSpanIndexer.java index 70461ec..3d4d424 100644 -- - a/zipkin-storage/elasticsearch-http/src/main/java/zipkin/storage/elasticsearch/http/HttpBulkSpanIndexer.java +++ b/zipkin-storage/elasticsearch-http/src/main/java/zipkin/storage/elasticsearch/http/HttpBulkSpanIndexer.java @ @ -29,10 +29,6 @ @ final class HttpBulkSpanIndexer extends HttpBulkIndexer < Span > implements @ Override public void add ( String index , Span span , Long timestampMillis ) throws IOException { String id = null ; // Allow ES to choose an ID - if ( timestampMillis == null ) { - super.add ( index , span , id ) ; - return ; - } writeIndexMetadata ( index , id ) ; body.write ( toSpanBytes ( span , timestampMillis ) ) ; body.writeByte ( '\n ' ) ; diff -- git a/zipkin-storage/elasticsearch-http/src/test/java/zipkin/storage/elasticsearch/ElasticsearchSpanConsumerTest.java b/zipkin-storage/elasticsearch-http/src/test/java/zipkin/storage/elasticsearch/ElasticsearchSpanConsumerTest.java index f7e745a..5415bba 100644 -- - a/zipkin-storage/elasticsearch-http/src/test/java/zipkin/storage/elasticsearch/ElasticsearchSpanConsumerTest.java +++ b/zipkin-storage/elasticsearch-http/src/test/java/zipkin/storage/elasticsearch/ElasticsearchSpanConsumerTest.java @ @ -21,7 +21,6 @ @ import java.util.concurrent.ExecutionException ; import org.junit.Before ; import org.junit.Test ; import zipkin.Annotation ; -import zipkin.Codec ; import zipkin.Span ; import zipkin.storage.elasticsearch.http.HttpElasticsearchTestGraph ; @ @ -121,22 +120,6 @ @ public class ElasticsearchSpanConsumerTest { .isEqualTo ( 1 ) ; } - @ Test - public void prefixWithTimestampMillis ( ) { - Span span = Span.builder ( ) .traceId ( 20L ) .id ( 20L ) .name ( `` get '' ) - .timestamp ( TODAY * 1000 ) .build ( Can we help uncover or explain span reporting lag ? __EoT__ from @ dan-tr > @ dan-tr Sep 28 23:09 > Is timestamp_millis created based on the timestamp field or is created based on the current time when the record is inserted into ES ? I 'm looking for away to discern if there is any lag time between the message being put on the Kafka queue ( client-side ) and the record being stored in ES ( server-side ) . We should add the description to the README here , but no . this timestamp is n't used for lag , it is based on the best timestamp . https : //github.com/openzipkin/zipkin/tree/master/zipkin-storage/elasticsearch timestamp + duration would be the time a span was recorded and eligible to be sent . In https : //github.com/openzipkin/zipkin-reporter-java , and other libraries , there would be up to a second before the span goes on the wire . We could look at our local endpoint vs one of the endpoints in the span and try to determine roughly the lag , based on limitations of clock skew guessing . If we did , we 'd likely record that as a stat vs put it
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Query by multiple key/value pairs __EoT__ Sometimes it 's useful to be able to search for multiple key/value pairs . For example in order to find traces with 500 errors for a particular url . key=http.uri , value=/i/discovery.json key=http.responsecode , value=500 Internal Server Error
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Query by multiple key/value pairs __EoT__ Sometimes it 's useful to be able to search for multiple key/value pairs . For example in order to find traces with 500 errors for a particular url . key=http.uri , value=/i/discovery.json key=http.responsecode , value=500 Internal Server Error
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Query by multiple key/value pairs __EoT__ Sometimes it 's useful to be able to search for multiple key/value pairs . For example in order to find traces with 500 errors for a particular url . key=http.uri , value=/i/discovery.json key=http.responsecode , value=500 Internal Server Error
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Lots of code duplication ? __EoT__ Looks like zipkin-common has lots of code duplication . Or is it just me not understanding the code ? E.g . https : //github.com/openzipkin/zipkin/blob/master/zipkin-common/src/main/scala/com/twitter/zipkin/storage/Storage.scala has many of the same methods as https : //github.com/openzipkin/zipkin/blob/master/zipkin-common/src/main/scala/com/twitter/zipkin/storage/SpanStore.scala I 'm wondering if it 's https : //github.com/openzipkin/zipkin/pull/321 that was merged with new interfaces , without removing the old ones . @ sprsquish @ bmdhacks @ franklinhu could that be right ?
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Replace Cassie with Datastax native driver __EoT__ Currently Zipkin is using a [ thrift-based means of talking with Cassandra ] ( https : //github.com/openzipkin/zipkin/tree/master/zipkin-cassandra/src/main/scala/com/twitter/cassie ) . Support for this [ Thrift interface ] ( https : //wiki.apache.org/cassandra/ThriftInterface ) will be removed in future versions of Cassandra . @ michaelsembwever has mentioned the desire to introduce support for the datastax-driver into ` zipkin-cassandra ` . This ticket is to capture that work
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - 'spanName ' filter should consider character case in zipkin web UI __EoT__ I 'm using finagle which might record it 's rpc method as span name , e.g . `` getResult '' , in the zipkin UI , there will be a lower case `` getresult '' show in the dropdown , when I select it I 'll find nothing , but if I manually change the url from like : http : //localhost/ ? serviceName=x & spanName=getresult ... . to http : //localhost/ ? serviceName=x & spanName=getResult ... . I could get the right answer . it looks like we should not transform the span name into lower case in UI for selection
diff -- git a/zipkin-ui/css/trace.css b/zipkin-ui/css/trace.css index a38a962..fd5eebc 100644 -- - a/zipkin-ui/css/trace.css +++ b/zipkin-ui/css/trace.css @ @ -125,6 +125,11 @ @ display : none ; } + # trace-container .span .duration .annotation [ data-value= '' error '' ] { + border : solid 1px # ff0000 ; + background : # ff0000 ; + } + # trace-container .span .duration .tooltip { white-space : normal ; } @ @ -136,6 +141,28 @ @ # trace-container .span.depth-4 .duration { background : rgba ( 66 , 146 , 198 , 0.80 ) ; } # trace-container .span.depth-5 .duration { background : rgba ( 66 , 146 , 198 , 1 ) ; } + # trace-container .span [ data-error-type= '' transient '' ] .handle .service-name { + background : # 8a6d3b ; + } + + # trace-container .span [ data-error-type= '' transient '' ] .depth-0 .duration { background : rgba ( 230 , 215 , 140 , 0.1 ) ; } + # trace-container .span [ data-error-type= '' transient '' ] .depth-1 .duration { background : rgba ( 230 , 215 , 140 , 0.20 ) ; } + # trace-container .span [ data-error-type= '' transient '' ] .depth-2 .duration { background : For exception changing the Color to Red __EoT__ Hi , Can we have some feature where , if I have a tag added Key as `` Exception '' or `` error '' the color changes to red , to have it highlighted
diff -- git a/zipkin-ui/js/component_data/default.js b/zipkin-ui/js/component_data/default.js index ffa3add..8d3aa27 100644 -- - a/zipkin-ui/js/component_data/default.js +++ b/zipkin-ui/js/component_data/default.js @ @ -13,21 +13,27 @ @ export function convertToApiQuery ( windowLocationSearch ) { } delete query.startTs ; } + if ( query.serviceName === 'all ' ) { + delete query.serviceName ; + } + if ( query.spanName === 'all ' ) { + delete query.spanName ; + } return query ; } export default component ( function DefaultData ( ) { this.after ( 'initialize ' , function ( ) { const query = convertToApiQuery ( window.location.search ) ; - const serviceName = query.serviceName ; - if ( serviceName ) { + const endTs = query.endTs ; + if ( endTs ) { const apiURL = ` api/v1/traces ? $ { queryString.stringify ( query ) } ` ; $ .ajax ( apiURL , { type : 'GET ' , dataType : 'json' } ) .done ( traces = > { const modelview = { - traces : traceSummariesToMustache ( serviceName , traces.map ( traceSummary ) ) , + traces : traceSummariesToMustache ( query.serviceName , traces.map ( traceSummary ) ) , apiURL , rawResponse : traces } ; diff -- git a/zipkin-ui/js/component_ui/serviceName.js b/zipkin-ui/js/component_ui/serviceName.js index e94c4dc..9c8487e 100644 -- - a/zipkin-ui/js/component_ui/serviceName.js zipkin-ui : slow meaningless request in home page __EoT__ Recently we upgraded to zipkin 2.4.5 and found that there is a request ( ` /api/v1/traces ` , without any params ) will be sent when opening the home page . This request is very slow ( about 10s ) , causing the page stuck for a while , and the front end will not render the result to the page , so it is meaningless . Before # 1789 , the request will be sent only when containing the ` serviceName ` param . But in # 1872 , which removed all constraints , an request would be sent even there is no params at all , and it will be very slow because there is no any filters in elasticsearch . The request can still get result , but in ` page/default.js ` , because ` serviceName ` does not exist , ` queryWasPerformed ` will be ` false ` , then traces will not be rendered to the page . I want bring the logic ( before # 1789 ) back ( revert part of # 1872 , re-add the ` serviceName ` constraints ) , but in
diff -- git a/zipkin-autoconfigure/collector-scribe/src/main/java/zipkin/autoconfigure/collector/scribe/ZipkinScribeCollectorAutoConfiguration.java b/zipkin-autoconfigure/collector-scribe/src/main/java/zipkin/autoconfigure/collector/scribe/ZipkinScribeCollectorAutoConfiguration.java index 2df7c45..db5392c 100644 -- - a/zipkin-autoconfigure/collector-scribe/src/main/java/zipkin/autoconfigure/collector/scribe/ZipkinScribeCollectorAutoConfiguration.java +++ b/zipkin-autoconfigure/collector-scribe/src/main/java/zipkin/autoconfigure/collector/scribe/ZipkinScribeCollectorAutoConfiguration.java @ @ -1,5 +1,5 @ @ /** - * Copyright 2015-2016 The OpenZipkin Authors + * Copyright 2015-2017 The OpenZipkin Authors * * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except * in compliance with the License . You may obtain a copy of the License at @ @ -29,7 +29,7 @ @ import zipkin.storage.StorageComponent ; */ @ Configuration @ EnableConfigurationProperties ( ZipkinScribeCollectorProperties.class ) - @ ConditionalOnProperty ( value = `` zipkin.collector.scribe.enabled '' , matchIfMissing = true ) + @ ConditionalOnProperty ( value = `` zipkin.collector.scribe.enabled '' , havingValue = `` true '' ) public class ZipkinScribeCollectorAutoConfiguration { /** The init method will block until the scribe port is listening , or crash on port conflict */ @ Bean ( initMethod = `` start '' ) ScribeCollector scribe ( ZipkinScribeCollectorProperties scribe , diff -- git a/zipkin-autoconfigure/collector-scribe/src/test/java/zipkin/autoconfigure/collector/scribe/ZipkinScribeCollectorAutoConfigurationTest.java b/zipkin-autoconfigure/collector-scribe/src/test/java/zipkin/autoconfigure/collector/scribe/ZipkinScribeCollectorAutoConfigurationTest.java index 459da73..e87afe3 100644 -- - a/zipkin-autoconfigure/collector-scribe/src/test/java/zipkin/autoconfigure/collector/scribe/ZipkinScribeCollectorAutoConfigurationTest.java +++ b/zipkin-autoconfigure/collector-scribe/src/test/java/zipkin/autoconfigure/collector/scribe/ZipkinScribeCollectorAutoConfigurationTest.java @ @ -1,5 +1,5 @ @ /** - * Copyright 2015-2016 The OpenZipkin Authors + * Copyright 2015-2017 The OpenZipkin Authors * * Licensed under the Apache License Quick-start error __EoT__ hi , I follow the quick-start and use java to run the zipkin , I get an error , and this error also occured when I use culr to post json data to the 9410 port with path /spans , anyone know what happens ? org.jboss.netty.handler.codec.frame.TooLongFrameException : Maximum frame size of 67108864 exceeded at com.facebook.nifty.codec.DefaultThriftFrameDecoder.tryDecodeFramedMessage ( DefaultThriftFrameDecoder.java:102 ) [ nifty-core-0.19.0.jar ! / : nifty-parent-0.19.0 ] at com.facebook.nifty.codec.DefaultThriftFrameDecoder.decode ( DefaultThriftFrameDecoder.java:68 ) [ nifty-core-0.19.0.jar ! / : nifty-parent-0.19.0 ] at com.facebook.nifty.codec.DefaultThriftFrameDecoder.decode ( DefaultThriftFrameDecoder.java:33 ) [ nifty-core-0.19.0.jar ! / : nifty-parent-0.19.0 ] at org.jboss.netty.handler.codec.frame.FrameDecoder.callDecode ( FrameDecoder.java:425 ) [ netty-3.10.5.Final.jar ! / : na ] at org.jboss.netty.handler.codec.frame.FrameDecoder.messageReceived ( FrameDecoder.java:303 ) [ netty-3.10.5.Final.jar ! / : na ] at org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream ( SimpleChannelUpstreamHandler.java:70 ) [ netty-3.10.5.Final.jar ! / : na ] at com.facebook.nifty.codec.DefaultThriftFrameCodec.handleUpstream ( DefaultThriftFrameCodec.java:42 ) [ nifty-core-0.19.0.jar ! / : nifty-parent-0.19.0 ] at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream ( DefaultChannelPipeline.java:564 ) [ netty-3.10.5.Final.jar ! / : na ] at org.jboss.netty.channel.DefaultChannelPipeline $ DefaultChannelHandlerContext.sendUpstream ( DefaultChannelPipeline.java:791 ) [ netty-3.10.5.Final.jar ! / : na ] at com.facebook.nifty.core.ChannelStatistics.handleUpstream ( ChannelStatistics.java:79 ) [ nifty-core-0.19.0.jar ! / : nifty-parent-0.19.0 ] at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream ( DefaultChannelPipeline.java:564 ) [ netty-3.10.5.Final.jar ! / : na ] at org.jboss.netty.channel.DefaultChannelPipeline $ DefaultChannelHandlerContext.sendUpstream ( DefaultChannelPipeline.java:791 ) [ netty-3.10.5.Final.jar !
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Future Zipkin architecture ( post-UI-refactoring ) __EoT__ The work on refactoring the UI is complete - it 's now just a bundle of assets , with client-side rendering , and it talks to Zipkin via the query HTTP API . Should we go ahead and move zipkin-web into zipkin-query ? It 's already been discussed , my impression is that most people want to go in that direction . In which case I suggest we change the zipkin-web gradle build ; delete all the Scala code , and produce a .zip file ( or .tar/tar.gz ) with the static assets . Gradle basically becomes a thin wrapper around npm/webpack . Then , zipkin-query can import that artifact as a dependency , and serve the static assets . This means zipkin-java can also import the same dependency . While we 're at it - we could also merge zipkin-collector and zipkin-web into one application . Possibly with a configuration option to only enable the `` collector '' role , the `` query '' role , or the `` all '' role . Zipkin is known to be hard to deploy , operations-wise ; if we could reduce the number of separate
diff -- git a/zipkin-autoconfigure/storage-elasticsearch-http/src/main/java/zipkin/autoconfigure/storage/elasticsearch/http/BasicAuthInterceptor.java b/zipkin-autoconfigure/storage-elasticsearch-http/src/main/java/zipkin/autoconfigure/storage/elasticsearch/http/BasicAuthInterceptor.java new file mode 100644 index 0000000..bcb3df3 -- - /dev/null +++ b/zipkin-autoconfigure/storage-elasticsearch-http/src/main/java/zipkin/autoconfigure/storage/elasticsearch/http/BasicAuthInterceptor.java @ @ -0,0 +1,59 @ @ + +/** + * Copyright 2015-2017 The OpenZipkin Authors + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except + * in compliance with the License . You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software distributed under the License + * is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express + * or implied . See the License for the specific language governing permissions and limitations under + * the License . + */ + +package zipkin.autoconfigure.storage.elasticsearch.http ; + +import com.squareup.moshi.JsonReader ; +import okhttp3.Credentials ; +import okhttp3.Interceptor ; +import okhttp3.Request ; +import okhttp3.Response ; +import okhttp3.ResponseBody ; + +import java.io.IOException ; + +import static zipkin.moshi.JsonReaders.enterPath ; + +public class BasicAuthInterceptor implements Interceptor { + + ZipkinElasticsearchHttpStorageProperties es ; + + BasicAuthInterceptor ( ZipkinElasticsearchHttpStorageProperties es ) { + Feature Request Elastic Search Authentication __EoT__ Feature request to allow to use authenticated elastic search clusters . Unable to use Zipkin with Elastic cloud as requires basic auth . Have tried using ES_HOSTS=HTTPS : //user : pass @ elasticcloud.url Had a quick browse of the source code and do not see any way to set username and password .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - scala-tools.org is gone __EoT__ With an empty ~/.ivy2 repo and a fresh git clone , I was having trouble getting all the dependencies . Noticed that on https : //github.com/twitter/zipkin/blob/master/project/ZipkinResolver.scala # L29 , it was trying to download from scala-tools.org , which appears to be gone . Replacing `` ` '' scala-tools.org '' at `` http : //scala-tools.org/repo-releases/ '' , '' testing.scala-tools.org '' at `` http : //scala-tools.org/repo-releases/testing/ '' , `` ` with `` ` '' sonatype-nexus '' at `` http : //scala-tools.org/repo-releases/testing/ '' , //replaced scala-tools.org `` ` seems to do the trick .
diff -- git a/README.md b/README.md index ce602b8..5bc1e06 100644 -- - a/README.md +++ b/README.md @ @ -71,9 +71,7 @ @ The [ MySQLStorage ] ( zipkin-storage/mysql ) component currently is only tested with The [ CassandraStorage ] ( zipkin-storage/cassandra ) component is tested against Cassandra 2.2+ . It stores spans as opaque thrifts which means you ca n't read them in cqlsh . However , it is designed for scale . For example , it has manually implemented indexes to make querying larger data more performant . This store requires a [ spark job ] ( https : //github.com/openzipkin/zipkin-dependencies ) to aggregate dependency links . # # # Elasticsearch -The [ ElasticsearchStorage ] ( zipkin-storage/elasticsearch ) component is tested against Elasticsearch 2.3 . It stores spans as json and has been designed for larger scale . This store requires a [ spark job ] ( https : //github.com/openzipkin/zipkin-dependencies ) to aggregate dependency links . - -Note : The storage type ` elasticsearch-http ` supports both 2.x and 5.x versions of Elasticsearch . +The [ ElasticsearchHttpStorage ] ( zipkin-storage/elasticsearch-http ) component is tested against Elasticsearch 2.x and 5.x . It stores spans as json and has been designed for larger scale . Should we drop the native elasticsearch transport ? __EoT__ Currently , the zipkin-server bundles a dep on elasticsearch 2.x drivers ( which themselves pull deps on guava ) . The 2.x drivers are incompatible with later versions of Elasticsearch , and can not coexist since the 2.x and 5.x libraries use the same class names . We need to decide what do do about it . The ES dependency is needed for the transport protocol . The transport protocol is only used by java clients or a `` tribe node '' . Incidentally , not all java clients support the transport protocol , either . For example , elasticsearch 's spark support uses http , and the elasticsearch rest client does as well . There are some advantages to the native protocol around multiplexing , but it adds a weight to the project I do n't think we can afford . We made `` elasticsearch-http '' to support amazon deployments which only support http . Incidentally we also use http in zipkin-dependencies , too , as that 's what spark supports . Recently ( 1.20 ) , we decoupled `` elasticsearch-http '' from the native elasticsearch driver . In doing
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - getTraceIdsByAnnotation __EoT__ [ test ] ( https : //github.com/twitter/zipkin/blob/master/zipkin-server/src/test/scala/com/twitter/zipkin/storage/cassandra/CassandraIndexSpec.scala # L187 ) in CassandraIndexSpec , why is `` ` scala // fetch by time based annotation , find trace var seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` custom '' , None , 0 , 3 ) ( ) //seq mustEqual Seq ( span1.traceId ) `` ` commented out ? It seems like it is n't time based ( the duration has n't been indexed ) but also like it should be found regardless . also , what does the test : `` ` scala // should not find any traces since the core annotation does n't exist in index seq = cassandraIndex.getTraceIdsByAnnotation ( `` service '' , `` cs '' , None , 0 , 3 ) ( ) seq.isEmpty mustBe true `` ` mean ? Why should n't the core annotation exist in index , and what does core annotation mean ? I 'm implementing this for redis , and it seems like the reverse should be true , that the second should be commented out , and the first should be uncommented .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Fix : verifyLicenses thinks subprojects do n't have a license __EoT__ The dependency license verification introduced in https : //github.com/openzipkin/zipkin/pull/852 fails to recognize that the subprojects ( like ` zipkin-common ` ) have a license . Not surprising , since there 's no POM file accompanying the jars . I see three options for attacking this : - Generating a POM file and making sure the license plugin reads it - Add metadata to the jars that the plugin reads - Hard-code ( or generate with gradle ) the license for each subproject into the configuration for the plugin via ` downloadLicenses.licenses ` ( https : //github.com/hierynomus/license-gradle-plugin # license-reporting )
diff -- git a/circle.yml b/circle.yml index 5d08ab1..146b598 100644 -- - a/circle.yml +++ b/circle.yml @ @ -56,7 +56,6 @ @ dependencies : database : override : - mysql -u ubuntu -e 'SET GLOBAL innodb_file_format=Barracuda' - - mysql -u ubuntu -e `` SET GLOBAL sql_mode= ( SELECT REPLACE ( @ @ sql_mode , 'ONLY_FULL_GROUP_BY ' , '' ) ) '' - mysql -u ubuntu circle_test < zipkin-storage/mysql/src/main/resources/mysql.sql test : diff -- git a/zipkin-storage/mysql/README.md b/zipkin-storage/mysql/README.md index 7491dda..5bfb679 100644 -- - a/zipkin-storage/mysql/README.md +++ b/zipkin-storage/mysql/README.md @ @ -46,8 +46,6 @ @ For example , all the below query the same trace using different tools : `` ` bash # Barracuda supports compression ( In AWS RDS , this must be assigned in a parameter group ) $ mysql -uroot -e `` SET GLOBAL innodb_file_format=Barracuda '' - # If using MySQL 5.7 , you 'll need to disable ONLY_FULL_GROUP_BY - $ mysql -uroot -e `` SET GLOBAL sql_mode= ( SELECT REPLACE ( @ @ sql_mode , 'ONLY_FULL_GROUP_BY ' , '' ) ) '' # This command should work even in RDS , and return `` Barracuda '' $ mysql -uroot -e `` show global variables like 'innodb_file_format ' '' diff -- git a/zipkin-storage/mysql/src/main/java/zipkin/storage/mysql/MySQLSpanStore.java b/zipkin-storage/mysql/src/main/java/zipkin/storage/mysql/MySQLSpanStore.java index 473f887..e09a6c1 Zipkin server does not work with MySQL 5.7 __EoT__ # # # Technical Details MySQL Server Version `` ` 5.7.14-8 - Percona Server ( GPL ) , Release '8 ' , Revision '1f84ccd ' `` ` Zipkin Server : `` ` 1.14.3 `` ` MySQL SQL Mode : `` ` ONLY_FULL_GROUP_BY , STRICT_TRANS_TABLES , NO_ZERO_IN_DATE , NO_ZERO_DATE , ERROR_FOR_DIVISION_BY_ZERO , NO_AUTO_CREATE_USER , NO_ENGINE_SUBSTITUTION `` ` ( Default for Percona distributed by Docker containers ) # # # Summary Running Zipkin with `` ` STORAGE_TYPE=mysql `` ` causes certain requests to fail with exceptions due to semantically invalid SQL queries . This is caused by SQL_MODE=ONLY_FULL_GROUP_BY . As per the [ MySQL 5.7 release notes ] ( http : //dev.mysql.com/doc/refman/5.7/en/sql-mode.html # sqlmode_only_full_group_by ) , `` [ ... ] the default SQL mode includes ONLY_FULL_GROUP_BY . [ ... ] '' # # # Exception Information # # # # Exhibit A `` ` 11/3/2016 10:00:56 PMorg.mariadb.jdbc.internal.util.dao.QueryException : Expression # 1 of ORDER BY clause is not in SELECT list , references column 'Zipkin.zipkin_spans.start_ts ' which is not in SELECT list ; this is incompatible with DISTINCT 11/3/2016 10:00:56 PMQuery is : select distinct ` zipkin_spans ` . ` trace_id ` from `
diff -- git a/zipkin-autoconfigure/ui/src/main/java/zipkin/autoconfigure/ui/ZipkinUiProperties.java b/zipkin-autoconfigure/ui/src/main/java/zipkin/autoconfigure/ui/ZipkinUiProperties.java index 56f42be..ae48698 100644 -- - a/zipkin-autoconfigure/ui/src/main/java/zipkin/autoconfigure/ui/ZipkinUiProperties.java +++ b/zipkin-autoconfigure/ui/src/main/java/zipkin/autoconfigure/ui/ZipkinUiProperties.java @ @ -1,5 +1,5 @ @ /** - * Copyright 2015-2016 The OpenZipkin Authors + * Copyright 2015-2017 The OpenZipkin Authors * * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except * in compliance with the License . You may obtain a copy of the License at @ @ -24,6 +24,7 @ @ public class ZipkinUiProperties { private int defaultLookback = ( int ) TimeUnit.DAYS.toMillis ( 7 ) ; private String instrumented = `` . * '' ; private String logsUrl = null ; + private Dependency dependency = new Dependency ( ) ; public int getDefaultLookback ( ) { return defaultLookback ; @ @ -66,4 +67,33 @ @ public class ZipkinUiProperties { this.logsUrl = logsUrl ; } } + + public Dependency getDependency ( ) { + return dependency ; + } + + public void setDependency ( Dependency dependency ) { + this.dependency = dependency ; + } + + public static class Dependency { + private float lowErrorRate = 0.5f ; // 50 % of calls in error turns line Add error count in api/v1/dependencies response __EoT__ It would be helpful to add more metadata to the current api/v1/dependencies response . Error count should be simple to add as @ adriancole mentioned .
diff -- git a/zipkin-storage/cassandra3/src/main/java/zipkin/storage/cassandra3/CassandraSpanConsumer.java b/zipkin-storage/cassandra3/src/main/java/zipkin/storage/cassandra3/CassandraSpanConsumer.java index 647b303..2ca48df 100644 -- - a/zipkin-storage/cassandra3/src/main/java/zipkin/storage/cassandra3/CassandraSpanConsumer.java +++ b/zipkin-storage/cassandra3/src/main/java/zipkin/storage/cassandra3/CassandraSpanConsumer.java @ @ -24,7 +24,6 @ @ import com.google.common.base.Joiner ; import com.google.common.collect.ImmutableSet ; import com.google.common.util.concurrent.Futures ; import com.google.common.util.concurrent.ListenableFuture ; -import java.math.BigInteger ; import java.util.ArrayList ; import java.util.List ; import java.util.Set ; @ @ -36,20 +35,18 @ @ import zipkin.BinaryAnnotation ; import zipkin.Span ; import zipkin.storage.cassandra3.Schema.AnnotationUDT ; import zipkin.storage.cassandra3.Schema.BinaryAnnotationUDT ; +import zipkin.storage.cassandra3.Schema.TraceIdUDT ; import zipkin.storage.guava.GuavaSpanConsumer ; +import static com.google.common.util.concurrent.Futures.transform ; import static zipkin.internal.ApplyTimestampAndDuration.guessTimestamp ; import static zipkin.storage.cassandra3.CassandraUtil.bindWithName ; import static zipkin.storage.cassandra3.CassandraUtil.durationIndexBucket ; -import static com.google.common.util.concurrent.Futures.transform ; final class CassandraSpanConsumer implements GuavaSpanConsumer { private static final Logger LOG = LoggerFactory.getLogger ( CassandraSpanConsumer.class ) ; private static final Function < Object , Void > TO_VOID = Functions. < Void > constant ( null ) ; - private static final long WRITTEN_NAMES_TTL - = Long.getLong ( `` zipkin.store.cassandra3.internal.writtenNamesTtl '' , 60 * 60 * 1000 ) ; - private final Session session ; private final PreparedStatement insertSpan ; private final PreparedStatement insertTraceServiceSpanName ; @ @ -102,7 +99,7 @ @ final class CassandraSpanConsumer implements GuavaSpanConsumer { for ( Span span : rawSpans ) { // indexing occurs by timestamp , so derive one if not present . Long timestamp = guessTimestamp ( span Support lookup of 128-bit traces by lower 64-bits in cassandra3 __EoT__ Currently , trace ids are stored as a variable-length number ( as opposed to a 2 part hi/lo 128bit id ) . In order to support query by low 64 bits , we need to split this up somehow or add a separate index . You 'll notice ` SpanStoreTest.getTrace_retrieves128bitTraceIdByLower64Bits ` is disabled due to this . cc @ openzipkin/cassandra
diff -- git a/zipkin-ui/js/page/default.js b/zipkin-ui/js/page/default.js index fbb0c39..59d35a6 100644 -- - a/zipkin-ui/js/page/default.js +++ b/zipkin-ui/js/page/default.js @ @ -17,6 +17,24 @ @ import BackToTop from '../component_ui/backToTop ' ; import { defaultTemplate } from '../templates ' ; const DefaultPageComponent = component ( function DefaultPage ( ) { + const sortOptions = [ + { value : 'service-percentage-desc ' , text : 'Service Percentage : Longest First ' } , + { value : 'service-percentage-asc ' , text : 'Service Percentage : Shortest First ' } , + { value : 'duration-desc ' , text : 'Longest First ' } , + { value : 'duration-asc ' , text : 'Shortest First ' } , + { value : 'timestamp-desc ' , text : 'Newest First ' } , + { value : 'timestamp-asc ' , text : 'Oldest First ' } + ] ; + + const sortSelected = function getSelector ( selectedSortValue ) { + return function selected ( ) { + if ( this.value === selectedSortValue ) { + return 'selected ' ; + } + return `` ; + } ; + } ; + this.after ( 'initialize ' , function ( ) { window.document.title = 'Zipkin - Index ' ; UI : Sort order is lost when going back to start screen __EoT__ If you sort by newest first , and then open up a trace and then go back to the start screen , the sort order is lost , making it somewhat confusing if you are trying to pinpoint a specific trace .
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - consider moving zipkin-ui assets under /static __EoT__ currently , zipkin-ui 's assets are included in the root directory . This has an interesting side-effect of making all contents of the zipkin-web jar fetchable by the static asset handler . For example , you can download classes and other properties in the jar via GET . If we packaged zipkin-ui 's assets under `` /static '' , then only those assets would be served . Also , it has a side-effect of being automatically exported in spring-boot apps . Alternatively , we could get fancier and make zipkin-ui a WebJar by moving the static assets under a path `` /META-INF/resources/webjars/zipkinui/1.37.0 '' ( or whatever version ) http : //www.webjars.org/
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Support local spans via a LOCAL_COMPONENT ( `` lc '' ) binary annotation __EoT__ Currently it is tribal knowledge that local ( in-process ) spans exist . We need a way to designate span as local , and offer insight into how to use them . This can lead us to answer what status quo could be on this , and how they might be tested . Firstly , local spans need to be annotated with a namespace that can be used like service . A discussion on github suggests using a LOCAL_COMPONENT ( `` lc '' ) binary annotation for this . Here 's a json view : `` ` json { `` key '' : `` lc '' , `` value '' : `` encryption-service '' , `` endpoint '' : { `` serviceName '' : `` proxy '' , `` ipv4 '' : `` 1.2.3.4 '' , `` port '' : 345 } } `` ` You 'll notice that the binary annotation holds almost all information needed to identify the context of the span . It contains a searchable annotation which contains its namespace , in this case ` encryption-service ` . Via the existing contract
diff -- git a/zipkin-autoconfigure/storage-elasticsearch-http/src/test/java/zipkin/storage/elasticsearch/http/ZipkinElasticsearchHttpStorageAutoConfigurationTest.java b/zipkin-autoconfigure/storage-elasticsearch-http/src/test/java/zipkin/storage/elasticsearch/http/ZipkinElasticsearchHttpStorageAutoConfigurationTest.java index d7e6fb5..112c731 100644 -- - a/zipkin-autoconfigure/storage-elasticsearch-http/src/test/java/zipkin/storage/elasticsearch/http/ZipkinElasticsearchHttpStorageAutoConfigurationTest.java +++ b/zipkin-autoconfigure/storage-elasticsearch-http/src/test/java/zipkin/storage/elasticsearch/http/ZipkinElasticsearchHttpStorageAutoConfigurationTest.java @ @ -34,6 +34,7 @ @ import java.util.concurrent.TimeUnit ; import static org.assertj.core.api.Assertions.assertThat ; import static org.springframework.boot.test.util.EnvironmentTestUtils.addEnvironment ; +import static zipkin.storage.elasticsearch.http.ElasticsearchHttpSpanStore.SPAN ; public class ZipkinElasticsearchHttpStorageAutoConfigurationTest { @ @ -246,8 +247,8 @ @ public class ZipkinElasticsearchHttpStorageAutoConfigurationTest { ZipkinElasticsearchHttpStorageAutoConfiguration.class ) ; context.refresh ( ) ; - assertThat ( es ( ) .indexNameFormatter ( ) .indexNameForTimestamp ( 0 ) ) - .isEqualTo ( `` zipkin-1970-01-01 '' ) ; + assertThat ( es ( ) .indexNameFormatter ( ) .formatTypeAndTimestamp ( SPAN , 0 ) ) + .isEqualTo ( `` zipkin : span-1970-01-01 '' ) ; } @ Test @ @ -262,8 +263,8 @ @ public class ZipkinElasticsearchHttpStorageAutoConfigurationTest { ZipkinElasticsearchHttpStorageAutoConfiguration.class ) ; context.refresh ( ) ; - assertThat ( es ( ) .indexNameFormatter ( ) .indexNameForTimestamp ( 0 ) ) - .isEqualTo ( `` zipkin_prod-1970-01-01 '' ) ; + assertThat ( es ( ) .indexNameFormatter ( ) .formatTypeAndTimestamp ( SPAN , 0 ) ) + .isEqualTo ( `` zipkin_prod : span-1970-01-01 '' ) ; } @ Test @ @ -278,8 +279,8 @ @ public class ZipkinElasticsearchHttpStorageAutoConfigurationTest { ZipkinElasticsearchHttpStorageAutoConfiguration.class ) ; context.refresh ( ) ; - assertThat ( es ( ) .indexNameFormatter ( ) Elasticsearch 6+ do n't like type __EoT__ So , according to this summary , types are not a great idea moving forward . https : //github.com/elastic/elasticsearch/issues/15613 # issuecomment-303727982 Currently , we use the following types : * span * servicespan - optimization due to expensive nested service name query from our v1 span format * dependencyLink Seems we need to split out the types now into indexes . First thought is to simply delimit them Ex . * zipkin-2017-08-01/span just removes the type ( as it is default ) * zipkin-2017-08-01/dependencyLink becomes zipkin-dependencyLink-2017-08-01 this is just an idea . anyone have a smarter one ? @ openzipkin/elasticsearch
diff -- git a/.circleci/config.yml b/.circleci/config.yml deleted file mode 100644 index 2858207..0000000 -- - a/.circleci/config.yml +++ /dev/null @ @ -1,62 +0,0 @ @ - # - # Copyright 2015-2018 The OpenZipkin Authors - # - # Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file except - # in compliance with the License . You may obtain a copy of the License at - # - # http : //www.apache.org/licenses/LICENSE-2.0 - # - # Unless required by applicable law or agreed to in writing , software distributed under the License - # is distributed on an `` AS IS '' BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express - # or implied . See the License for the specific language governing permissions and limitations under - # the License . - # - - # NOTE : Travis tests Elasticsearch and MySQL using Docker , and Kafka manually . We do n't redundantly test them here -version : 2 -jobs : - build : - environment : - # Quiet Maven invoker logs ( Downloading ... when running zipkin-server/src/it ) - MAVEN_OPTS : -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn - Cleanup modules __EoT__ Currently we have a confusing hierarchy of modules for the collector and query services including : - ` zipkin-common ` : common classes shared between the two - ` zipkin-thrift ` : Thrift structs and interfaces for both services - ` zipkin-scrooge ` : module to generate Scala from Thrift via Scrooge - ` zipkin-scribe ` : scribe specific classes for collector , including the service - ` zipkin-server ` : combination of code for collector and query , including the query service I think we can clean this up by breaking up the latter two modules and make things more composable . - ` zipkin-cassie ` : implementation of ` Aggregates ` , ` Index ` , and ` Storage ` interfaces that use Cassandra as the backing store - ` zipkin-collector-core ` : core code for the collector service - ` zipkin-collector-scribe ` : scribe specific classes - ` zipkin-collector-service ` : module to compose everything together - ` zipkin-query-core ` : core code for query service - ` zipkin-query-service ` : module to compose everything together
diff -- git a/pom.xml b/pom.xml index 59ad7e1..915fa3a 100755 -- - a/pom.xml +++ b/pom.xml @ @ -256,6 +256,18 @ @ < dependency > < groupId > $ { project.groupId } < /groupId > + < artifactId > zipkin-collector-kafka10 < /artifactId > + < version > $ { project.version } < /version > + < /dependency > + + < dependency > + < groupId > $ { project.groupId } < /groupId > + < artifactId > zipkin-autoconfigure-collector-kafka10 < /artifactId > + < version > $ { project.version } < /version > + < /dependency > + + < dependency > + < groupId > $ { project.groupId } < /groupId > < artifactId > zipkin-collector-scribe < /artifactId > < version > $ { project.version } < /version > < /dependency > diff -- git a/zipkin-autoconfigure/collector-kafka10/pom.xml b/zipkin-autoconfigure/collector-kafka10/pom.xml new file mode 100644 index 0000000..163ecc7 -- - /dev/null +++ b/zipkin-autoconfigure/collector-kafka10/pom.xml @ @ -0,0 +1,39 @ @ + < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > + < ! -- + + Copyright 2015-2017 The OpenZipkin Authors + + Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; you may not use this file Update Kafka ( to 0.10 ) __EoT__ Last year , we attempted to update Kafka to 0.9 , but had to revert it due to the ordering problem implied . https : //github.com/openzipkin/zipkin/pull/904 Unfortunately no one responded to the email asking about kafka update plans : https : //groups.google.com/forum/ # ! topic/zipkin-user/rQpecbvc6Y0 We should n't be pinned to 0.8 forever , and we are now getting requests for 0.10 support . I 'm wondering how we should address Kafka updates , particularly as the server includes an all-jar . Unless packaging is different , it might imply weird tricks to be able support multiple versions in the same binary , or a separate build . Can anyone share their current status wrt kafka and/or have ideas on how to support multiple versions simply ? cc @ prat0318 @ dgarson @ SimenB @ sveisvei @ eirslett @ kristofa @ NegatioN @ shakuzen
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 09f21be..109147b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -12,6 +12,7 @ @ List of closed issues is here [ https : //github.com/loopj/android-async-http/issue - Achieved API23 Compatibility , see # 830 for more info - Added HeadSample into sample application , to verify Head request works as it should - FileAsyncHttpResponseHandler now has constructor with ` usePoolThread ` param , which causes callbacks to be fired from ThreadPool instead of main looper + - **IMPORTANT** , Add ` -keep class com.loopj.android.http.HttpGet { * ; } ` to your proguard file # # 1.4.8 ( released 17 . 7 . 2015 ) 1.4.9 + proguard : not called onSuccess , onFailure __EoT__ I am sorry . my english is not good . I use 1.4.9. proguard off : work . proguard on : onSuccess , onFailure not called . my proguard . `` ` -optimizationpasses 5 -repackageclasses `` -allowaccessmodification -overloadaggressively -verbose `` ` but I add ` -keep class com.loopj.android.http.HttpGet { * ; } ` to proguard . this is work ( onSuccess , onFailure called ) .
diff -- git a/.classpath b/.classpath index 14fcf52..c42b9fa 100644 -- - a/.classpath +++ b/.classpath @ @ -1,8 +1,9 @ @ < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > < classpath > < classpathentry kind= '' con '' path= '' com.android.ide.eclipse.adt.ANDROID_FRAMEWORK '' / > + < classpathentry kind= '' src '' path= '' examples '' / > < classpathentry kind= '' src '' path= '' src '' / > < classpathentry kind= '' src '' path= '' gen '' / > - < classpathentry kind= '' src '' path= '' examples '' / > + < classpathentry kind= '' con '' path= '' com.android.ide.eclipse.adt.LIBRARIES '' / > < classpathentry kind= '' output '' path= '' bin/classes '' / > < /classpath > diff -- git a/src/com/loopj/android/http/AsyncHttpClient.java b/src/com/loopj/android/http/AsyncHttpClient.java index 5f0750d..746b139 100644 -- - a/src/com/loopj/android/http/AsyncHttpClient.java +++ b/src/com/loopj/android/http/AsyncHttpClient.java @ @ -18,18 +18,7 @ @ package com.loopj.android.http ; -import java.io.IOException ; -import java.io.InputStream ; -import java.lang.ref.WeakReference ; -import java.util.HashMap ; -import java.util.LinkedList ; -import java.util.List ; -import java.util.Map ; -import java.util.WeakHashMap ; -import java.util.concurrent.Executors ; -import java.util.concurrent.Future ; -import java.util.concurrent.ThreadPoolExecutor ; -import java.util.zip.GZIPInputStream ; +import android.content.Context ; import org.apache.http.Header ; import org.apache.http.HeaderElement ; @ @ -67,7 +56,18 @ @ import org.apache.http.protocol.BasicHttpContext Proxy Authentication __EoT__ setproxy function should also accept username password if requires
diff -- git a/src/com/loopj/android/http/AsyncHttpClient.java b/src/com/loopj/android/http/AsyncHttpClient.java index 5f0750d..e7cbfc3 100644 -- - a/src/com/loopj/android/http/AsyncHttpClient.java +++ b/src/com/loopj/android/http/AsyncHttpClient.java @ @ -218,7 +218,7 @ @ public class AsyncHttpClient { } /** - * Sets the connection time oout . By default , 10 seconds + * Sets the connection timeout . By default , 10 seconds * @ param timeout the connect/socket timeout in milliseconds */ public void setTimeout ( int timeout ) { @ @ -236,7 +236,15 @ @ public class AsyncHttpClient { public void setSSLSocketFactory ( SSLSocketFactory sslSocketFactory ) { this.httpClient.getConnectionManager ( ) .getSchemeRegistry ( ) .register ( new Scheme ( `` https '' , sslSocketFactory , 443 ) ) ; } - + + /** + * Sets the maximum number of retries for a particular Request . + * @ param retries maximum number of retries per request + */ + public void setMaxRetries ( int retries ) { + this.httpClient.setHttpRequestRetryHandler ( new RetryHandler ( retries ) ) ; + } + /** * Sets headers that will be added to all requests this client makes ( before sending ) . * @ param header the name of the header Additional Information in AsyncHttpResponseHandler __EoT__ It 's posible I 'm missing something , but I do n't see anyway to get any additional information bout the request 's response . I 'm specifically needing two things : - **HTTP Status Code in both onSuccess and onError** : Casting the throwable in onError to HttpResponseException will let me call getStatusCode ( ) , but this really is n't the cleanest way to go about it - **Response bodies in onError** : RESTful API 's frequently send back a response message , along with an HTTP error code . **Bonus** : A way to fetch HTTP Response headers in both methods .
diff -- git a/src/com/loopj/android/http/AsyncHttpClient.java b/src/com/loopj/android/http/AsyncHttpClient.java index 54e14b9..017a308 100644 -- - a/src/com/loopj/android/http/AsyncHttpClient.java +++ b/src/com/loopj/android/http/AsyncHttpClient.java @ @ -216,7 +216,7 @ @ public class AsyncHttpClient { } /** - * Sets the connection time oout . By default , 10 seconds + * Set the connection timeout . By default , 10 seconds . * @ param timeout the connect/socket timeout in milliseconds */ public void setTimeout ( int timeout ) { Additional Information in AsyncHttpResponseHandler __EoT__ It 's posible I 'm missing something , but I do n't see anyway to get any additional information bout the request 's response . I 'm specifically needing two things : - **HTTP Status Code in both onSuccess and onError** : Casting the throwable in onError to HttpResponseException will let me call getStatusCode ( ) , but this really is n't the cleanest way to go about it - **Response bodies in onError** : RESTful API 's frequently send back a response message , along with an HTTP error code . **Bonus** : A way to fetch HTTP Response headers in both methods .
diff -- git a/src/com/loopj/android/http/RequestParams.java b/src/com/loopj/android/http/RequestParams.java index cf5d1dc..02bcf8a 100644 -- - a/src/com/loopj/android/http/RequestParams.java +++ b/src/com/loopj/android/http/RequestParams.java @ @ -18,10 +18,16 @ @ package com.loopj.android.http ; -import java.io.InputStream ; +import org.apache.http.HttpEntity ; +import org.apache.http.client.entity.UrlEncodedFormEntity ; +import org.apache.http.client.utils.URLEncodedUtils ; +import org.apache.http.message.BasicNameValuePair ; +import org.apache.http.protocol.HTTP ; + import java.io.File ; import java.io.FileInputStream ; import java.io.FileNotFoundException ; +import java.io.InputStream ; import java.io.UnsupportedEncodingException ; import java.util.ArrayList ; import java.util.LinkedList ; @ @ -29,11 +35,6 @ @ import java.util.List ; import java.util.Map ; import java.util.concurrent.ConcurrentHashMap ; -import org.apache.http.HttpEntity ; -import org.apache.http.client.entity.UrlEncodedFormEntity ; -import org.apache.http.client.utils.URLEncodedUtils ; -import org.apache.http.message.BasicNameValuePair ; - /** * A collection of string request parameters or files to send along with * requests made from an { @ link AsyncHttpClient } instance . @ @ -54,7 +55,6 @ @ import org.apache.http.message.BasicNameValuePair ; * < /pre > */ public class RequestParams { - private static String ENCODING = `` UTF-8 '' ; protected ConcurrentHashMap < String , String > urlParams ; protected ConcurrentHashMap < String , FileWrapper > fileParams ; @ @ -226,46 +226,49 @ @ public class RequestParams { * Returns an HttpEntity containing all request parameters */ public HttpEntity getEntity ( ) { - HttpEntity entity = null ; - if ( ! fileParams.isEmpty ( ) Uploading progress __EoT__ Hey , When uploading files to the server , is there a way I can have a callback to see the progress of the upload ? Thanks
diff -- git a/.classpath b/.classpath index 14fcf52..51011ca 100644 -- - a/.classpath +++ b/.classpath @ @ -4,5 +4,6 @ @ < classpathentry kind= '' src '' path= '' src '' / > < classpathentry kind= '' src '' path= '' gen '' / > < classpathentry kind= '' src '' path= '' examples '' / > + < classpathentry exported= '' true '' kind= '' con '' path= '' com.android.ide.eclipse.adt.LIBRARIES '' / > < classpathentry kind= '' output '' path= '' bin/classes '' / > < /classpath > diff -- git a/.gitignore b/.gitignore index 0900c48..23a60b0 100644 -- - a/.gitignore +++ b/.gitignore @ @ -8,4 +8,5 @ @ bin/ gen/ _layouts .DS_Store -gh-pages \ No newline at end of file +gh-pages + ! httpclient-*.jar \ No newline at end of file diff -- git a/libs/httpclient-4.2.1.jar b/libs/httpclient-4.2.1.jar new file mode 100644 index 0000000..0e999fc Binary files /dev/null and b/libs/httpclient-4.2.1.jar differ diff -- git a/src/com/loopj/android/http/AsyncHttpClient.java b/src/com/loopj/android/http/AsyncHttpClient.java index 188fe73..c317a88 100644 -- - a/src/com/loopj/android/http/AsyncHttpClient.java +++ b/src/com/loopj/android/http/AsyncHttpClient.java @ @ -48,6 +48,7 @ @ import org.apache.http.client.methods.HttpEntityEnclosingRequestBase ; import org.apache.http.client.methods.HttpGet ; import org.apache.http.client.methods.HttpPost ; import org.apache.http.client.methods.HttpPut ; +import org.apache.http.client.methods.HttpPatch ; import org.apache.http.client.methods.HttpUriRequest ; import org.apache.http.client.protocol.ClientContext ; import org.apache.http.conn.params.ConnManagerParams ; @ @ -508,6 +509,96 @ @ public class AsyncHttpClient { if Including http PATCH method would be a nice enhancement __EoT__
diff -- git a/.gitignore b/.gitignore index ff8a6e5..00f3e58 100644 -- - a/.gitignore +++ b/.gitignore @ @ -8,4 +8,7 @ @ bin/ gen/ _layouts .DS_Store -gh-pages \ No newline at end of file +gh-pages +ant.properties +proguard-project.txt +res/ diff -- git a/src/com/loopj/android/http/AsyncHttpClient.java b/src/com/loopj/android/http/AsyncHttpClient.java index 6053a56..25fb763 100644 -- - a/src/com/loopj/android/http/AsyncHttpClient.java +++ b/src/com/loopj/android/http/AsyncHttpClient.java @ @ -57,7 +57,6 @ @ import org.apache.http.conn.scheme.Scheme ; import org.apache.http.conn.scheme.SchemeRegistry ; import org.apache.http.conn.ssl.SSLSocketFactory ; import org.apache.http.entity.HttpEntityWrapper ; -import org.apache.http.impl.client.DefaultHttpClient ; import org.apache.http.impl.conn.tsccm.ThreadSafeClientConnManager ; import org.apache.http.params.BasicHttpParams ; import org.apache.http.params.HttpParams ; @ @ -102,7 +101,7 @ @ public class AsyncHttpClient { private static int maxConnections = DEFAULT_MAX_CONNECTIONS ; private static int socketTimeout = DEFAULT_SOCKET_TIMEOUT ; - private final DefaultHttpClient httpClient ; + private final NoRedirectHttpClient httpClient ; private final HttpContext httpContext ; private ThreadPoolExecutor threadPool ; private final Map < Context , List < WeakReference < Future < ? > > > > requestMap ; @ @ -133,7 +132,7 @ @ public class AsyncHttpClient { ThreadSafeClientConnManager cm = new ThreadSafeClientConnManager ( httpParams , schemeRegistry ) ; httpContext = new SyncBasicHttpContext ( new BasicHttpContext ( ) ) ; - httpClient = new DefaultHttpClient ( cm , httpParams ) ; + httpClient = new NoRedirectHttpClient ( cm , httpParams ) ; httpClient.addRequestInterceptor ( new HttpRequestInterceptor How to solve the problem of CircularRedirectException __EoT__ How to solve the problem of callback about : org.apache.http.client.CircularRedirectException : Circular redirect to
diff -- git a/.classpath b/.classpath index 14fcf52..c42b9fa 100644 -- - a/.classpath +++ b/.classpath @ @ -1,8 +1,9 @ @ < ? xml version= '' 1.0 '' encoding= '' UTF-8 '' ? > < classpath > < classpathentry kind= '' con '' path= '' com.android.ide.eclipse.adt.ANDROID_FRAMEWORK '' / > + < classpathentry kind= '' src '' path= '' examples '' / > < classpathentry kind= '' src '' path= '' src '' / > < classpathentry kind= '' src '' path= '' gen '' / > - < classpathentry kind= '' src '' path= '' examples '' / > + < classpathentry kind= '' con '' path= '' com.android.ide.eclipse.adt.LIBRARIES '' / > < classpathentry kind= '' output '' path= '' bin/classes '' / > < /classpath > diff -- git a/src/com/loopj/android/http/AsyncHttpClient.java b/src/com/loopj/android/http/AsyncHttpClient.java index 5f0750d..222dc67 100644 -- - a/src/com/loopj/android/http/AsyncHttpClient.java +++ b/src/com/loopj/android/http/AsyncHttpClient.java @ @ -18,18 +18,7 @ @ package com.loopj.android.http ; -import java.io.IOException ; -import java.io.InputStream ; -import java.lang.ref.WeakReference ; -import java.util.HashMap ; -import java.util.LinkedList ; -import java.util.List ; -import java.util.Map ; -import java.util.WeakHashMap ; -import java.util.concurrent.Executors ; -import java.util.concurrent.Future ; -import java.util.concurrent.ThreadPoolExecutor ; -import java.util.zip.GZIPInputStream ; +import android.content.Context ; import org.apache.http.Header ; import org.apache.http.HeaderElement ; @ @ -67,7 +56,18 @ @ import org.apache.http.protocol.BasicHttpContext static field in __EoT__ I have a question that why define the `` mAllowedContentTypes '' with **static** modifier at BinaryHttpResponseHandler.java ？
diff -- git a/src/com/loopj/android/http/AsyncHttpResponseHandler.java b/src/com/loopj/android/http/AsyncHttpResponseHandler.java index 2030265..e409f70 100644 -- - a/src/com/loopj/android/http/AsyncHttpResponseHandler.java +++ b/src/com/loopj/android/http/AsyncHttpResponseHandler.java @ @ -30,10 +30,6 @ @ import org.apache.http.client.HttpResponseException ; import org.apache.http.entity.BufferedHttpEntity ; import org.apache.http.util.EntityUtils ; -import android.os.Handler ; -import android.os.Looper ; -import android.os.Message ; - /** * Used to intercept and handle the responses from requests made using * { @ link AsyncHttpClient } . The { @ link # onSuccess ( String ) } method is diff -- git a/src/com/loopj/android/http/SyncHttpClient.java b/src/com/loopj/android/http/SyncHttpClient.java index 1fd4441..8a06fde 100644 -- - a/src/com/loopj/android/http/SyncHttpClient.java +++ b/src/com/loopj/android/http/SyncHttpClient.java @ @ -1,5 +1,6 @ @ package com.loopj.android.http ; +import org.apache.http.HttpEntity ; import org.apache.http.client.methods.HttpUriRequest ; import org.apache.http.impl.client.DefaultHttpClient ; import org.apache.http.protocol.HttpContext ; @ @ -110,6 +111,11 @ @ public abstract class SyncHttpClient extends AsyncHttpClient { return result ; } + public String post ( String url , HttpEntity entity ) { + this.post ( null , url , entity , null , responseHandler ) ; + return result ; + } + public String delete ( String url , RequestParams params ) { this.delete ( url , params , responseHandler ) ; return result ; org.apache.http.NoHttpResponseException : The target server failed to respond __EoT__ `` ` [ org.apache.http.impl.conn.DefaultResponseParser.parseHead ( DefaultResponseParser.java:85 ) , org.apache.http.impl.io.AbstractMessageParser.parse ( AbstractMessageParser.java:174 ) , org.apache.http.impl.AbstractHttpClientConnection.receiveResponseHeader ( AbstractHttpClientConnection.java:179 ) , org.apache.http.impl.conn.DefaultClientConnection.receiveResponseHeader ( DefaultClientConnection.java:235 ) , org.apache.http.impl.conn.AbstractClientConnAdapter.receiveResponseHeader ( AbstractClientConnAdapter.java:259 ) , org.apache.http.protocol.HttpRequestExecutor.doReceiveResponse ( HttpRequestExecutor.java:279 ) , org.apache.http.protocol.HttpRequestExecutor.execute ( HttpRequestExecutor.java:121 ) , org.apache.http.impl.client.DefaultRequestDirector.execute ( DefaultRequestDirector.java:421 ) , org.apache.http.impl.client.AbstractHttpClient.execute ( AbstractHttpClient.java:555 ) , org.apache.http.impl.client.AbstractHttpClient.execute ( AbstractHttpClient.java:487 ) , com.loopj.android.http.AsyncHttpRequest.makeRequest ( AsyncHttpRequest.java:74 ) , com.loopj.android.http.AsyncHttpRequest.makeRequestWithRetries ( AsyncHttpRequest.java:93 ) , com.loopj.android.http.AsyncHttpRequest.run ( AsyncHttpRequest.java:55 ) , java.util.concurrent.Executors $ RunnableAdapter.call ( Executors.java:444 ) , java.util.concurrent.FutureTask $ Sync.innerRun ( FutureTask.java:306 ) , java.util.concurrent.FutureTask.run ( FutureTask.java:138 ) , java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1088 ) , java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:581 ) , java.lang.Thread.run ( Thread.java:1019 ) ] `` ` From time to time after the upgrade from 1.4.1 to 1.4.2 the emergence org.apache.http.NoHttpResponseException : The target server failed to respond
diff -- git a/animated-gif/src/main/jni/Application.mk b/animated-gif/src/main/jni/Application.mk index 33e3bc3..47ef370 100644 -- - a/animated-gif/src/main/jni/Application.mk +++ b/animated-gif/src/main/jni/Application.mk @ @ -1,7 +1,7 @ @ # Copyright 2004-present Facebook . All Rights Reserved . APP_BUILD_SCRIPT : = Android.mk -APP_ABI : = armeabi-v7a armeabi arm64-v8a x86 x86_64 +APP_ABI : = all APP_MK_DIR : = $ ( dir $ ( lastword $ ( MAKEFILE_LIST ) ) ) NDK_MODULE_PATH : = $ ( APP_MK_DIR ) $ ( HOST_DIRSEP ) $ ( APP_MK_DIR ) ../../../nativedeps/merge diff -- git a/circle.yml b/circle.yml index 893841a..8c75201 100644 -- - a/circle.yml +++ b/circle.yml @ @ -24,9 +24,9 @ @ jobs : - run : name : Setup NDK command : | - wget -- quiet https : //dl.google.com/android/repository/android-ndk-r16b-linux-x86_64.zip - unzip -q android-ndk-r16b-linux-x86_64.zip -d /home/circleci - echo `` ndk.dir=/home/circleci/android-ndk-r16b '' > > /home/circleci/fresco/local.properties + wget -- quiet https : //dl.google.com/android/repository/android-ndk-r17b-linux-x86_64.zip + unzip -q android-ndk-r17b-linux-x86_64.zip -d /home/circleci + echo `` ndk.dir=/home/circleci/android-ndk-r17b '' > > /home/circleci/fresco/local.properties - run : name : `` NDK Fix : https : //github.com/android-ndk/ndk/issues/188 '' command : sudo apt-get install file diff -- git a/docs/_docs/proguard.md b/docs/_docs/proguard.md index a849501..812927c 100644 -- - a/docs/_docs/proguard.md +++ b/docs/_docs/proguard.md @ @ -32,9 +32,8 @ @ Fresco is written mostly in Java , but there is some C++ as well Windows os How to build ? __EoT__ # # My Environment - os : WIndows 7 Ultimake - SET ANDROID_HOME=C : \android-sdk-windows - SET PATH=C : \android-ndk-r10d ; % PATH % # # Run - gradlew build # # Result FAILURE : Build failed with an exception . \* What went wrong : Execution failed for task ' : imagepipeline : ndk_build_gifimage ' . > A problem occurred starting process 'command 'ndk-build '' \* Try : Run with -- stacktrace option to get the stack trace . Run with -- info or -- debug option to get more log output . BUILD FAILED ... ... . ㅜ.ㅡ # # Retry - gradlew build -- stacktrace # # Result \* What went wrong : Execution failed for task ' : imagepipeline : ndk_build_gifimage ' . > A problem occurred starting process 'command 'ndk-build '' \* Try : Run with -- info or -- debug option to get more log output . \* Exception is : org.gradle.api.tasks.TaskExecutionException : Execution failed for task ' : imagepipeline : ndk_build_gifimage ' . at org.gradle.api.internal.tasks.execution.ExecuteActionsTaskExecuter.executeActions ( ExecuteActionsTaskExecuter.java:69 ) at org.gradle.api.internal.tasks.execution.ExecuteActionsTaskExecuter.execute ( ExecuteActionsTaskExecuter.java:46 ) at org.gradle.api.internal.tasks.execution.PostExecutionAnalysisTaskExecuter.execute ( PostExecutionAnalysisTaskExecuter.java:35 ) at org.gradle.api.internal.tasks.execution.SkipUpToDateTaskExecuter.execute ( SkipUpToDateTaskExecuter.java:64 ) at org.gradle.api.internal.tasks.execution.ValidatingTaskExecuter.execute (
diff -- git a/imagepipeline/src/main/java/com/facebook/imagepipeline/producers/EncodedMemoryCacheProducer.java b/imagepipeline/src/main/java/com/facebook/imagepipeline/producers/EncodedMemoryCacheProducer.java index 618074d..36167b5 100644 -- - a/imagepipeline/src/main/java/com/facebook/imagepipeline/producers/EncodedMemoryCacheProducer.java +++ b/imagepipeline/src/main/java/com/facebook/imagepipeline/producers/EncodedMemoryCacheProducer.java @ @ -11,6 +11,7 @ @ import com.facebook.cache.common.CacheKey ; import com.facebook.common.internal.ImmutableMap ; import com.facebook.common.memory.PooledByteBuffer ; import com.facebook.common.references.CloseableReference ; +import com.facebook.imageformat.ImageFormat ; import com.facebook.imagepipeline.cache.CacheKeyFactory ; import com.facebook.imagepipeline.cache.MemoryCache ; import com.facebook.imagepipeline.image.EncodedImage ; @ @ -126,9 +127,11 @ @ public class EncodedMemoryCacheProducer implements Producer < EncodedImage > { try { FrescoSystrace.beginSection ( `` EncodedMemoryCacheProducer # onNewResultImpl '' ) ; // intermediate , null or uncacheable results are not cached , so we just forward them + // as well as the images with unknown format which could be html response from the server if ( isNotLast ( status ) || newResult == null - || statusHasAnyFlag ( status , DO_NOT_CACHE_ENCODED | IS_PARTIAL_RESULT ) ) { + || statusHasAnyFlag ( status , DO_NOT_CACHE_ENCODED | IS_PARTIAL_RESULT ) + || newResult.getImageFormat ( ) == ImageFormat.UNKNOWN ) { getConsumer ( ) .onNewResult ( newResult , status ) ; return ; } Unknown image format exception __EoT__ Hello , this issue is mentioned earlier , but i created new bug to show pure example of how to reproduce it and why it happens . I noticed this issue when test my app on device with WiFi disabled and 4G enabled , but there is very important detail . I have negative balance on my phone account , so there is no actually internet on 4G . So how issue looks like : 1 . I turn off Wifi there is only 4G working 2 . I try to load image and got error 3 . I enable wifi and try again - image still not loading That happens , because my 4G internet provider in case of negative balance returns me html page like `` please add money to your account '' on every html request to show me it when i open some page in browser The bad thing is that Fresco save this page to cache ( I found it there ) and tries to decode it as image again and again so user will never see actual image event if internet available . So , maybe in case of
diff -- git a/animated-gif/src/main/jni/Application.mk b/animated-gif/src/main/jni/Application.mk index 33e3bc3..47ef370 100644 -- - a/animated-gif/src/main/jni/Application.mk +++ b/animated-gif/src/main/jni/Application.mk @ @ -1,7 +1,7 @ @ # Copyright 2004-present Facebook . All Rights Reserved . APP_BUILD_SCRIPT : = Android.mk -APP_ABI : = armeabi-v7a armeabi arm64-v8a x86 x86_64 +APP_ABI : = all APP_MK_DIR : = $ ( dir $ ( lastword $ ( MAKEFILE_LIST ) ) ) NDK_MODULE_PATH : = $ ( APP_MK_DIR ) $ ( HOST_DIRSEP ) $ ( APP_MK_DIR ) ../../../nativedeps/merge diff -- git a/circle.yml b/circle.yml index 893841a..8c75201 100644 -- - a/circle.yml +++ b/circle.yml @ @ -24,9 +24,9 @ @ jobs : - run : name : Setup NDK command : | - wget -- quiet https : //dl.google.com/android/repository/android-ndk-r16b-linux-x86_64.zip - unzip -q android-ndk-r16b-linux-x86_64.zip -d /home/circleci - echo `` ndk.dir=/home/circleci/android-ndk-r16b '' > > /home/circleci/fresco/local.properties + wget -- quiet https : //dl.google.com/android/repository/android-ndk-r17b-linux-x86_64.zip + unzip -q android-ndk-r17b-linux-x86_64.zip -d /home/circleci + echo `` ndk.dir=/home/circleci/android-ndk-r17b '' > > /home/circleci/fresco/local.properties - run : name : `` NDK Fix : https : //github.com/android-ndk/ndk/issues/188 '' command : sudo apt-get install file diff -- git a/docs/_docs/proguard.md b/docs/_docs/proguard.md index a849501..812927c 100644 -- - a/docs/_docs/proguard.md +++ b/docs/_docs/proguard.md @ @ -32,9 +32,8 @ @ Fresco is written mostly in Java , but there is some C++ as well Error : Execution failed for task ' : imagepipeline : ndk_build_bitmaps ' . __EoT__ OS： mac 10.10.3 Error : Execution failed for task ' : imagepipeline : ndk_build_bitmaps ' . > A problem occurred starting process 'command 'ndk-build '' # # help
diff -- git a/imagepipeline/src/main/java/com/facebook/imagepipeline/producers/LocalFetchProducer.java b/imagepipeline/src/main/java/com/facebook/imagepipeline/producers/LocalFetchProducer.java index 2ccb13f..0ca77a8 100644 -- - a/imagepipeline/src/main/java/com/facebook/imagepipeline/producers/LocalFetchProducer.java +++ b/imagepipeline/src/main/java/com/facebook/imagepipeline/producers/LocalFetchProducer.java @ @ -93,7 +93,7 @ @ public abstract class LocalFetchProducer implements Producer < EncodedImage > { int length ) throws IOException { CloseableReference < PooledByteBuffer > ref = null ; try { - if ( length < 0 ) { + if ( length < = 0 ) { ref = CloseableReference.of ( mPooledByteBufferFactory.newByteBuffer ( inputStream ) ) ; } else { ref = CloseableReference.of ( mPooledByteBufferFactory.newByteBuffer ( inputStream , length ) ) ; A IllegalArgumentException caused by file length 0 ( get filelength failed ! ) __EoT__ Back traces starts . java.lang.IllegalArgumentException at com.facebook.common.internal.Preconditions.checkArgument ( Preconditions.java:108 ) at com.facebook.imagepipeline.memory.NativePooledByteBufferOutputStream. < init > ( NativePooledByteBufferOutputStream.java:50 ) at com.facebook.imagepipeline.memory.NativePooledByteBufferFactory.newByteBuffer ( NativePooledByteBufferFactory.java:98 ) at com.facebook.imagepipeline.memory.NativePooledByteBufferFactory.newByteBuffer ( NativePooledByteBufferFactory.java:26 ) at com.facebook.imagepipeline.producers.LocalFetchProducer.getByteBufferBackedEncodedImage ( LocalFetchProducer.java:79 ) at com.facebook.imagepipeline.producers.LocalFetchProducer.getEncodedImage ( LocalFetchProducer.java:107 ) at com.facebook.imagepipeline.producers.LocalFileFetchProducer.getEncodedImage ( LocalFileFetchProducer.java:38 ) at com.facebook.imagepipeline.producers.LocalFetchProducer.produceResults ( LocalFetchProducer.java:56 )
diff -- git a/animated-gif/src/main/jni/Application.mk b/animated-gif/src/main/jni/Application.mk index 33e3bc3..47ef370 100644 -- - a/animated-gif/src/main/jni/Application.mk +++ b/animated-gif/src/main/jni/Application.mk @ @ -1,7 +1,7 @ @ # Copyright 2004-present Facebook . All Rights Reserved . APP_BUILD_SCRIPT : = Android.mk -APP_ABI : = armeabi-v7a armeabi arm64-v8a x86 x86_64 +APP_ABI : = all APP_MK_DIR : = $ ( dir $ ( lastword $ ( MAKEFILE_LIST ) ) ) NDK_MODULE_PATH : = $ ( APP_MK_DIR ) $ ( HOST_DIRSEP ) $ ( APP_MK_DIR ) ../../../nativedeps/merge diff -- git a/circle.yml b/circle.yml index 893841a..8c75201 100644 -- - a/circle.yml +++ b/circle.yml @ @ -24,9 +24,9 @ @ jobs : - run : name : Setup NDK command : | - wget -- quiet https : //dl.google.com/android/repository/android-ndk-r16b-linux-x86_64.zip - unzip -q android-ndk-r16b-linux-x86_64.zip -d /home/circleci - echo `` ndk.dir=/home/circleci/android-ndk-r16b '' > > /home/circleci/fresco/local.properties + wget -- quiet https : //dl.google.com/android/repository/android-ndk-r17b-linux-x86_64.zip + unzip -q android-ndk-r17b-linux-x86_64.zip -d /home/circleci + echo `` ndk.dir=/home/circleci/android-ndk-r17b '' > > /home/circleci/fresco/local.properties - run : name : `` NDK Fix : https : //github.com/android-ndk/ndk/issues/188 '' command : sudo apt-get install file diff -- git a/docs/_docs/proguard.md b/docs/_docs/proguard.md index a849501..812927c 100644 -- - a/docs/_docs/proguard.md +++ b/docs/_docs/proguard.md @ @ -32,9 +32,8 @ @ Fresco is written mostly in Java , but there is some C++ as well A problem occurred starting process 'command 'ndk-build.cmd '' __EoT__ When I try to build the project I get this error : Error : Execution failed for task ' : imagepipeline : ndk_clean_bitmaps ' . > A problem occurred starting process 'command 'ndk-build.cmd '' please advice . thank you
diff -- git a/imagepipeline-base/src/main/java/com/facebook/cache/disk/DefaultDiskStorage.java b/imagepipeline-base/src/main/java/com/facebook/cache/disk/DefaultDiskStorage.java index 1002b7b..b477281 100644 -- - a/imagepipeline-base/src/main/java/com/facebook/cache/disk/DefaultDiskStorage.java +++ b/imagepipeline-base/src/main/java/com/facebook/cache/disk/DefaultDiskStorage.java @ @ -9,6 +9,8 @ @ package com.facebook.cache.disk ; +import android.os.Environment ; + import java.io.File ; import java.io.FileNotFoundException ; import java.io.FileOutputStream ; @ @ -118,6 +120,24 @ @ public class DefaultDiskStorage implements DiskStorage { public boolean isEnabled ( ) { return true ; } + + @ Override + public boolean isExternal ( ) { + boolean state = false ; + String cacheDirPath = null ; + File extStoragePath = Environment.getExternalStorageDirectory ( ) ; + if ( extStoragePath ! = null ) { + cacheDirPath = extStoragePath.toString ( ) ; + try { + String appCacheDirPath = mRootDirectory.getCanonicalPath ( ) ; + if ( appCacheDirPath.contains ( cacheDirPath ) ) state = true ; + } catch ( IOException e ) { + e.printStackTrace ( ) ; + } + } else { + state = false ; } + return state ; + } /** * Checks if we have to recreate rootDirectory . diff -- git a/imagepipeline-base/src/main/java/com/facebook/cache/disk/DiskStorage.java b/imagepipeline-base/src/main/java/com/facebook/cache/disk/DiskStorage.java index 4d62a43..0213a57 100644 -- - a/imagepipeline-base/src/main/java/com/facebook/cache/disk/DiskStorage.java +++ b/imagepipeline-base/src/main/java/com/facebook/cache/disk/DiskStorage.java @ @ -52,6 +52,12 @ @ public interface DiskStorage { * @ return true , if enabled */ boolean testLowDiskSpace always checks internal storage __EoT__ DiskStorageCache testLowDiskSpace always pass StatFsHelper.StorageType.INTERNAL can not pass EXTERNAL `` ` java /** * Helper method that sets the cache size limit to be either a high , or a low limit . * If there is not enough free space to satisfy the high limit , it is set to the low limit . */ @ GuardedBy ( `` mLock '' ) private void updateFileCacheSizeLimit ( ) { // Test if mCacheSizeLimit can be set to the high limit boolean isAvailableSpaceLowerThanHighLimit = mStatFsHelper.testLowDiskSpace ( StatFsHelper.StorageType.INTERNAL , mDefaultCacheSizeLimit - mCacheStats.getSize ( ) ) ; if ( isAvailableSpaceLowerThanHighLimit ) { mCacheSizeLimit = mLowDiskSpaceCacheSizeLimit ; } else { mCacheSizeLimit = mDefaultCacheSizeLimit ; } } `` `
diff -- git a/imagepipeline-base/src/main/java/com/facebook/cache/disk/DefaultDiskStorage.java b/imagepipeline-base/src/main/java/com/facebook/cache/disk/DefaultDiskStorage.java index 4fe585f..3a77514 100644 -- - a/imagepipeline-base/src/main/java/com/facebook/cache/disk/DefaultDiskStorage.java +++ b/imagepipeline-base/src/main/java/com/facebook/cache/disk/DefaultDiskStorage.java @ @ -9,8 +9,11 @ @ package com.facebook.cache.disk ; + +import android.os.Environment ; import javax.annotation.Nullable ; + import java.io.File ; import java.io.FileNotFoundException ; import java.io.FileOutputStream ; @ @ -68,6 +71,11 @ @ public class DefaultDiskStorage implements DiskStorage { private final File mRootDirectory ; /** + * True if cache is external + */ + private final boolean mIsExternal ; + + /** * All the sharding occurs inside a version-directory . That allows for easy version upgrade . * When we find a base directory with no version-directory in it , it means that it 's a different * version and we should delete the whole directory ( including itself ) for both reasons : @ @ -96,6 +104,7 @ @ public class DefaultDiskStorage implements DiskStorage { Preconditions.checkNotNull ( rootDirectory ) ; mRootDirectory = rootDirectory ; + mIsExternal = isExternal ( rootDirectory ) ; // mVersionDirectory 's name identifies : // - the cache structure 's version ( sharded ) // - the content 's version ( version value ) @ @ -107,6 +116,25 @ @ public class DefaultDiskStorage implements DiskStorage { mClock = SystemClock.get ( ) testLowDiskSpace always checks internal storage __EoT__ DiskStorageCache testLowDiskSpace always pass StatFsHelper.StorageType.INTERNAL can not pass EXTERNAL `` ` java /** * Helper method that sets the cache size limit to be either a high , or a low limit . * If there is not enough free space to satisfy the high limit , it is set to the low limit . */ @ GuardedBy ( `` mLock '' ) private void updateFileCacheSizeLimit ( ) { // Test if mCacheSizeLimit can be set to the high limit boolean isAvailableSpaceLowerThanHighLimit = mStatFsHelper.testLowDiskSpace ( StatFsHelper.StorageType.INTERNAL , mDefaultCacheSizeLimit - mCacheStats.getSize ( ) ) ; if ( isAvailableSpaceLowerThanHighLimit ) { mCacheSizeLimit = mLowDiskSpaceCacheSizeLimit ; } else { mCacheSizeLimit = mDefaultCacheSizeLimit ; } } `` `
diff -- git a/animated-gif/src/main/jni/Application.mk b/animated-gif/src/main/jni/Application.mk index 33e3bc3..47ef370 100644 -- - a/animated-gif/src/main/jni/Application.mk +++ b/animated-gif/src/main/jni/Application.mk @ @ -1,7 +1,7 @ @ # Copyright 2004-present Facebook . All Rights Reserved . APP_BUILD_SCRIPT : = Android.mk -APP_ABI : = armeabi-v7a armeabi arm64-v8a x86 x86_64 +APP_ABI : = all APP_MK_DIR : = $ ( dir $ ( lastword $ ( MAKEFILE_LIST ) ) ) NDK_MODULE_PATH : = $ ( APP_MK_DIR ) $ ( HOST_DIRSEP ) $ ( APP_MK_DIR ) ../../../nativedeps/merge diff -- git a/circle.yml b/circle.yml index 893841a..8c75201 100644 -- - a/circle.yml +++ b/circle.yml @ @ -24,9 +24,9 @ @ jobs : - run : name : Setup NDK command : | - wget -- quiet https : //dl.google.com/android/repository/android-ndk-r16b-linux-x86_64.zip - unzip -q android-ndk-r16b-linux-x86_64.zip -d /home/circleci - echo `` ndk.dir=/home/circleci/android-ndk-r16b '' > > /home/circleci/fresco/local.properties + wget -- quiet https : //dl.google.com/android/repository/android-ndk-r17b-linux-x86_64.zip + unzip -q android-ndk-r17b-linux-x86_64.zip -d /home/circleci + echo `` ndk.dir=/home/circleci/android-ndk-r17b '' > > /home/circleci/fresco/local.properties - run : name : `` NDK Fix : https : //github.com/android-ndk/ndk/issues/188 '' command : sudo apt-get install file diff -- git a/docs/_docs/proguard.md b/docs/_docs/proguard.md index a849501..812927c 100644 -- - a/docs/_docs/proguard.md +++ b/docs/_docs/proguard.md @ @ -32,9 +32,8 @ @ Fresco is written mostly in Java , but there is some C++ as well Build issue ( Windows ) __EoT__ Hello , I just grabed the latest code and , I followed the steps to build the lib . I got the below JNI related error regarding the Bitmaps . Did someone know how to fix it ? Thanks , Cata `` ` : samples : uriapp : generateDebugAndroidTestAssets UP-TO-DATE : imagepipeline-base : extractReleaseAnnotations : samples : uriapp : mergeDebugAndroidTestAssets : samples : zoomable : copyDebugLint UP-TO-DATE : samples : zoomable : processDebugJavaRes UP-TO-DATE : samples : zoomable : mergeDebugProguardFiles Error : error : samples\fresco\imagepipeline\build\tmp\ndk_build_bitmaps/local/armeabi-v7a/objs/bitmaps/Bitmaps.o.d : No such file or directory Error : error : samples\fresco\imagepipeline\build\tmp\ndk_build_bitmaps/local/armeabi-v7a/objs/bitmaps/Bitmaps.o : No such file or directory Error : error : samples\fresco\imagepipeline\build\tmp\ndk_build_bitmaps/local/armeabi/objs/bitmaps/Bitmaps.o.d : No such file or directory Error : error : samples\fresco\imagepipeline\build\tmp\ndk_build_bitmaps/local/armeabi/objs/bitmaps/Bitmaps.o : No such file or directory make.exe : *** [ samples\fresco\imagepipeline\build\tmp\ndk_build_bitmaps/local/armeabi-v7a/objs/bitmaps/Bitmaps.o ] Error 1 make.exe : *** Waiting for unfinished jobs ... . make.exe : *** [ samples\fresco\imagepipeline\build\tmp\ndk_build_bitmaps/local/armeabi/objs/bitmaps/Bitmaps.o ] Error 1 [ x86_64 ] Compile : bitmaps < = Bitmaps.c : samples : zoomable : mergeDebugProguardFiles UP-TO-DATE Error : error : samples\fresco\imagepipeline\build\tmp\ndk_build_bitmaps/local/arm64-v8a/objs/bitmaps/Bitmaps.o.d : No such file or directory Error : error : samples\fresco\imagepipeline\build\tmp\ndk_build_bitmaps/local/arm64-v8a/objs/bitmaps/Bitmaps.o : No such file or directory : samples : uriapp : mergeDebugAndroidTestAssets UP-TO-DATE
diff -- git a/animated-gif/src/main/jni/Application.mk b/animated-gif/src/main/jni/Application.mk index 33e3bc3..47ef370 100644 -- - a/animated-gif/src/main/jni/Application.mk +++ b/animated-gif/src/main/jni/Application.mk @ @ -1,7 +1,7 @ @ # Copyright 2004-present Facebook . All Rights Reserved . APP_BUILD_SCRIPT : = Android.mk -APP_ABI : = armeabi-v7a armeabi arm64-v8a x86 x86_64 +APP_ABI : = all APP_MK_DIR : = $ ( dir $ ( lastword $ ( MAKEFILE_LIST ) ) ) NDK_MODULE_PATH : = $ ( APP_MK_DIR ) $ ( HOST_DIRSEP ) $ ( APP_MK_DIR ) ../../../nativedeps/merge diff -- git a/circle.yml b/circle.yml index 893841a..0724cae 100644 -- - a/circle.yml +++ b/circle.yml @ @ -24,9 +24,9 @ @ jobs : - run : name : Setup NDK command : | - wget -- quiet https : //dl.google.com/android/repository/android-ndk-r16b-linux-x86_64.zip - unzip -q android-ndk-r16b-linux-x86_64.zip -d /home/circleci - echo `` ndk.dir=/home/circleci/android-ndk-r16b '' > > /home/circleci/fresco/local.properties + wget -- quiet https : //dl.google.com/android/repository/android-ndk-r17-linux-x86_64.zip + unzip -q android-ndk-r17-linux-x86_64.zip -d /home/circleci + echo `` ndk.dir=/home/circleci/android-ndk-r17 '' > > /home/circleci/fresco/local.properties - run : name : `` NDK Fix : https : //github.com/android-ndk/ndk/issues/188 '' command : sudo apt-get install file diff -- git a/docs/_docs/proguard.md b/docs/_docs/proguard.md index a849501..812927c 100644 -- - a/docs/_docs/proguard.md +++ b/docs/_docs/proguard.md @ @ -32,9 +32,8 @ @ Fresco is written mostly in Java , but there is some C++ as well Execution failed for task ' : imagepipeline : ndk_build_bitmaps ' . __EoT__ i import the project but throw a gradle execution fail error . say my ndk-build.cmd finished with an exception error . but i was install the ndk . Please help me to solve this problem . `` ` Error : Execution failed for task ' : imagepipeline : ndk_build_bitmaps ' . > Process 'command 'X : \AndroidSDK\ndk-bundle\ndk-build.cmd '' finished with non-zero exit value 2 `` ` `` ` Error : error : ( 1 ) \fresco-master\imagepipeline\build\tmp\ndk_build_bitmaps/local/armeabi-v7a/objs/bitmaps/Bitmaps.o.d : No such file or directory Error : error : ( 1 ) \fresco-master\imagepipeline\build\tmp\ndk_build_bitmaps/local/armeabi-v7a/objs/bitmaps/Bitmaps.o : No such file or directory Error : error : ( 1 ) \fresco-master\imagepipeline\build\tmp\ndk_build_bitmaps/local/armeabi/objs/bitmaps/Bitmaps.o.d : No such file or directory Error : error : ( 1 ) \fresco-master\imagepipeline\build\tmp\ndk_build_bitmaps/local/armeabi/objs/bitmaps/Bitmaps.o : No such file or directory Error : error : ( 1 ) \fresco-master\imagepipeline\build\tmp\ndk_build_bitmaps/local/arm64-v8a/objs/bitmaps/Bitmaps.o.d : No such file or directory Error : error : ( 1 ) \fresco-master\imagepipeline\build\tmp\ndk_build_bitmaps/local/arm64-v8a/objs/bitmaps/Bitmaps.o : No such file or directory `` `
diff -- git a/drawee/src/main/java/com/facebook/drawee/generic/GenericDraweeHierarchy.java b/drawee/src/main/java/com/facebook/drawee/generic/GenericDraweeHierarchy.java index e55a2ff..2b23cd9 100644 -- - a/drawee/src/main/java/com/facebook/drawee/generic/GenericDraweeHierarchy.java +++ b/drawee/src/main/java/com/facebook/drawee/generic/GenericDraweeHierarchy.java @ @ -113,9 +113,10 @ @ public class GenericDraweeHierarchy implements SettableDraweeHierarchy { // array of layers Drawable [ ] layers = new Drawable [ numLayers ] ; layers [ BACKGROUND_IMAGE_INDEX ] = buildBranch ( builder.getBackground ( ) , null ) ; - layers [ PLACEHOLDER_IMAGE_INDEX ] = buildBranch ( + layers [ PLACEHOLDER_IMAGE_INDEX ] = buildPlaceHolderImageBranch ( builder.getPlaceholderImage ( ) , - builder.getPlaceholderImageScaleType ( ) ) ; + builder.getPlaceholderImageScaleType ( ) , + builder.getPlaceholderImageBorderDisable ( ) ) ; layers [ ACTUAL_IMAGE_INDEX ] = buildActualImageBranch ( mActualImageWrapper , builder.getActualImageScaleType ( ) , @ @ -160,6 +161,24 @ @ public class GenericDraweeHierarchy implements SettableDraweeHierarchy { } @ Nullable + private Drawable buildPlaceHolderImageBranch ( @ Nullable Drawable drawable , + @ Nullable ScalingUtils.ScaleType scaleType , + boolean placeHolderImageBorderDisable ) { + if ( ! placeHolderImageBorderDisable ) { + return buildBranch ( drawable , scaleType ) ; + } + int borderColor = mRoundingParams.getBorderColor ( ) ; + float borderWidth = mRoundingParams.getBorderWidth ( ) ; + + //if set the roundingBorderOnPlaceHolderDisable attributes , set the reset the border + mRoundingParams.setBorder ( Color.TRANSPARENT,0 ) ; + drawable = buildBranch ( drawable , roundingBorderColor cause the placeholder image display error __EoT__ `` ` < com.facebook.drawee.view.SimpleDraweeView android : layout_below= '' @ id/button '' android : id= '' @ +id/simple '' android : layout_centerHorizontal= '' true '' android : layout_width= '' match_parent '' android : layout_height= '' 600px '' fresco : placeholderImage= '' @ drawable/logo '' fresco : roundingBorderWidth= '' 10px '' fresco : roundingBorderColor= '' @ color/image_detail_help_background '' / > `` ` then ! [ qq20180719-1 ] ( https : //user-images.githubusercontent.com/18482342/42941365-1c51c57c-8b8f-11e8-88c8-a609a30fc3c4.png ) * Fresco version : all version * Platform version : all devices
diff -- git a/fbcore/src/main/java/com/facebook/common/memory/PooledByteBufferInputStream.java b/fbcore/src/main/java/com/facebook/common/memory/PooledByteBufferInputStream.java index 98beefe..946c9b1 100644 -- - a/fbcore/src/main/java/com/facebook/common/memory/PooledByteBufferInputStream.java +++ b/fbcore/src/main/java/com/facebook/common/memory/PooledByteBufferInputStream.java @ @ -28,6 +28,7 @ @ public class PooledByteBufferInputStream extends InputStream { @ VisibleForTesting int mOffset ; // current offset in the chunk + @ VisibleForTesting int mMark ; // position of 'mark ' if any diff -- git a/imagepipeline-base/src/main/java/com/facebook/imageformat/ImageFormatChecker.java b/imagepipeline-base/src/main/java/com/facebook/imageformat/ImageFormatChecker.java index d114af0..1588f3f 100644 -- - a/imagepipeline-base/src/main/java/com/facebook/imageformat/ImageFormatChecker.java +++ b/imagepipeline-base/src/main/java/com/facebook/imageformat/ImageFormatChecker.java @ @ -50,19 +50,18 @ @ public class ImageFormatChecker { final byte [ ] imageHeaderBytes = new byte [ mMaxHeaderLength ] ; final int headerSize = readHeaderFromStream ( mMaxHeaderLength , is , imageHeaderBytes ) ; + ImageFormat format = mDefaultFormatChecker.determineFormat ( imageHeaderBytes , headerSize ) ; + if ( format ! = null ) return format ; + if ( mCustomImageFormatCheckers ! = null ) { for ( ImageFormat.FormatChecker formatChecker : mCustomImageFormatCheckers ) { - ImageFormat format = formatChecker.determineFormat ( imageHeaderBytes , headerSize ) ; + format = formatChecker.determineFormat ( imageHeaderBytes , headerSize ) ; if ( format ! = null & & format ! = ImageFormat.UNKNOWN ) { return format ; } } } - ImageFormat format = mDefaultFormatChecker.determineFormat ( imageHeaderBytes , headerSize ) ; - if ( format == null ) { - format = ImageFormat.UNKNOWN SVG format not loading __EoT__ # # # Description When trying to load [ this ] ( https : //upload.wikimedia.org/wikipedia/commons/0/02/SVG_logo.svg ) SVG file , the image is not loaded and a ` java.lang.IllegalArgumentException ` is thrown . # # # Reproduction On [ ImageFormatSvgFragment.java class ] ( https : //github.com/facebook/fresco/blob/master/samples/showcase/src/main/java/com/facebook/fresco/samples/showcase/imageformat/svg/ImageFormatSvgFragment.java ) change ` URI_SVG_HALF_TRANSPARENT ` attribute from ` Uri.parse ( `` http : //frescolib.org/static/sample-images/fresco_logo_half_transparent.svg '' ) ; ` to ` Uri.parse ( `` https : //upload.wikimedia.org/wikipedia/commons/0/02/SVG_logo.svg '' ) ; ` run the showcase app , enable SVG support and restart the app . Looking at logcat we have the following : `` ` 07-17 15:20:19.855 13973 13973 V unknown : AbstractDraweeController : controller 2c6609d null - > 0 : initialize 07-17 15:20:19.857 13973 13973 V unknown : AbstractDraweeController : controller 2c6609d 0 : setHierarchy : com.facebook.drawee.generic.GenericDraweeHierarchy @ 6552912 07-17 15:20:19.892 13973 13973 V unknown : AbstractDraweeController : controller 2c6609d 0 : onAttach : request needs submit 07-17 15:20:19.922 13973 13973 V unknown : RequestLoggingListener : time 6584062 : onRequestSubmit : { requestId : 0 , callerContext : null , isPrefetch : false } 07-17 15:20:19.930 13973 13973 V unknown : RequestLoggingListener : time 6584069 : onProducerStart : { requestId :
diff -- git a/imagepipeline-base/src/main/java/com/facebook/cache/disk/DefaultDiskStorage.java b/imagepipeline-base/src/main/java/com/facebook/cache/disk/DefaultDiskStorage.java index 1002b7b..b477281 100644 -- - a/imagepipeline-base/src/main/java/com/facebook/cache/disk/DefaultDiskStorage.java +++ b/imagepipeline-base/src/main/java/com/facebook/cache/disk/DefaultDiskStorage.java @ @ -9,6 +9,8 @ @ package com.facebook.cache.disk ; +import android.os.Environment ; + import java.io.File ; import java.io.FileNotFoundException ; import java.io.FileOutputStream ; @ @ -118,6 +120,24 @ @ public class DefaultDiskStorage implements DiskStorage { public boolean isEnabled ( ) { return true ; } + + @ Override + public boolean isExternal ( ) { + boolean state = false ; + String cacheDirPath = null ; + File extStoragePath = Environment.getExternalStorageDirectory ( ) ; + if ( extStoragePath ! = null ) { + cacheDirPath = extStoragePath.toString ( ) ; + try { + String appCacheDirPath = mRootDirectory.getCanonicalPath ( ) ; + if ( appCacheDirPath.contains ( cacheDirPath ) ) state = true ; + } catch ( IOException e ) { + e.printStackTrace ( ) ; + } + } else { + state = false ; } + return state ; + } /** * Checks if we have to recreate rootDirectory . diff -- git a/imagepipeline-base/src/main/java/com/facebook/cache/disk/DiskStorage.java b/imagepipeline-base/src/main/java/com/facebook/cache/disk/DiskStorage.java index 4d62a43..0213a57 100644 -- - a/imagepipeline-base/src/main/java/com/facebook/cache/disk/DiskStorage.java +++ b/imagepipeline-base/src/main/java/com/facebook/cache/disk/DiskStorage.java @ @ -52,6 +52,12 @ @ public interface DiskStorage { * @ return true , if enabled */ boolean CacheStats return - 1 on app update __EoT__ Hello , I do n't know if it 's the same as https : //github.com/facebook/fresco/issues/984 . When app is update ( or suppressed and reinstalled ) : ` mDiskCacheUsedSize = Fresco.getImagePipelineFactory ( ) .getMainDiskStorageCache ( ) .getSize ( ) ; ` return -1 thus all files are in cache . This has been tested using : ` .setBaseDirectoryPath ( getExternalCacheDir ( ) ) ` or ` .setBaseDirectoryPath ( context.getApplicationContext ( ) .getCacheDir ( ) ) ` as diskCacheConfig Thanks , Eric
diff -- git a/stetho/src/main/java/com/facebook/stetho/inspector/network/NetworkEventReporterImpl.java b/stetho/src/main/java/com/facebook/stetho/inspector/network/NetworkEventReporterImpl.java index 5b0a521..80294a2 100644 -- - a/stetho/src/main/java/com/facebook/stetho/inspector/network/NetworkEventReporterImpl.java +++ b/stetho/src/main/java/com/facebook/stetho/inspector/network/NetworkEventReporterImpl.java @ @ -10,22 +10,31 @ @ package com.facebook.stetho.inspector.network ; import android.os.SystemClock ; + import com.facebook.stetho.common.Utf8Charset ; import com.facebook.stetho.inspector.console.CLog ; import com.facebook.stetho.inspector.protocol.module.Console ; import com.facebook.stetho.inspector.protocol.module.Network ; import com.facebook.stetho.inspector.protocol.module.Page ; + import org.json.JSONException ; import org.json.JSONObject ; -import javax.annotation.Nonnull ; -import javax.annotation.Nullable ; import java.io.IOException ; import java.io.InputStream ; import java.io.OutputStream ; +import java.nio.ByteBuffer ; +import java.nio.CharBuffer ; +import java.nio.charset.CharacterCodingException ; +import java.nio.charset.Charset ; +import java.nio.charset.CharsetDecoder ; +import java.nio.charset.CodingErrorAction ; import java.util.ArrayList ; import java.util.concurrent.atomic.AtomicInteger ; +import javax.annotation.Nonnull ; +import javax.annotation.Nullable ; + /** * Implementation of { @ link NetworkEventReporter } which allows callers to inform the Stetho * system of network traffic . Callers can safely eagerly access this class and store a @ @ -39,6 +48,8 @ @ public class NetworkEventReporterImpl implements NetworkEventReporter { private static NetworkEventReporter sInstance ; + private static final CharsetDecoder decoder = Charset.forName ( Utf8Charset.NAME ) .newDecoder ( ) ; + private NetworkEventReporterImpl ( ) { } @ @ -49,6 +60,8 @ @ public class NetworkEventReporterImpl implements NetworkEventReporter { public static synchronized NetworkEventReporter get ( ) { if ( sInstance == null ) { sInstance = new NetworkEventReporterImpl ( ) ; + Developer Tool No response __EoT__ When request have multipart body file , To view request head lead to developer tool no response .
diff -- git a/EventBus/build.gradle b/EventBus/build.gradle index 50637de..6d6bb1c 100644 -- - a/EventBus/build.gradle +++ b/EventBus/build.gradle @ @ -28,6 +28,7 @ @ configurations { } dependencies { + compile project ( ' : EventBusAnnotation ' ) provided 'com.google.android : android:4.1.1.4' provided 'com.google.android : android-test:4.1.1.4' provided 'com.google.android : annotations:4.1.1.4' diff -- git a/EventBus/src/org/greenrobot/eventbus/Subscribe.java b/EventBus/src/org/greenrobot/eventbus/Subscribe.java deleted file mode 100644 index ed0b8c8..0000000 -- - a/EventBus/src/org/greenrobot/eventbus/Subscribe.java +++ /dev/null @ @ -1,44 +0,0 @ @ -/* - * Copyright ( C ) 2012-2016 Markus Junginger , greenrobot ( http : //greenrobot.org ) - * - * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; - * you may not use this file except in compliance with the License . - * You may obtain a copy of the License at - * - * http : //www.apache.org/licenses/LICENSE-2.0 - * - * Unless required by applicable law or agreed to in writing , software - * distributed under the License is distributed on an `` AS IS '' BASIS , - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . - * See the License for the specific language governing permissions and - * limitations under the Configurable annotation ? __EoT__ I 'm trying to decouple my project as much as possible from the Android framework using pure Java modules to keep things clean . But I 'd really love to use EventBus instead of Guava ( or any other pure Java implementation ) under the hood . To do that , I 'd need an abstraction layer around EventBus , using DI to inject the real implementation . But I 'm still stuck because of the ` @ Subscribe ` annotation : [ SubscriberMethodFinder ] ( https : //github.com/greenrobot/EventBus/blob/master/EventBus/src/org/greenrobot/eventbus/SubscriberMethodFinder.java ) is final/private and the annotation processor can not be configured . Would it be a no-go for you , or are you open to a future PR about that ? If so , any ideas or recommandations ?
diff -- git a/src/test/java/org/apache/ibatis/executor/CachingSimpleExecutorTest.java b/src/test/java/org/apache/ibatis/executor/CachingSimpleExecutorTest.java index f32d313..96eeb90 100644 -- - a/src/test/java/org/apache/ibatis/executor/CachingSimpleExecutorTest.java +++ b/src/test/java/org/apache/ibatis/executor/CachingSimpleExecutorTest.java @ @ -15,9 +15,15 @ @ */ package org.apache.ibatis.executor ; +import org.apache.ibatis.mapping.MappedStatement ; +import org.apache.ibatis.session.RowBounds ; import org.apache.ibatis.transaction.Transaction ; +import org.apache.ibatis.transaction.jdbc.JdbcTransaction ; import org.junit.Test ; +import java.util.List ; +import java.util.concurrent.Executors ; + public class CachingSimpleExecutorTest extends BaseExecutorTest { @ Test @ @ -29,4 +35,22 @ @ public class CachingSimpleExecutorTest extends BaseExecutorTest { return new CachingExecutor ( new SimpleExecutor ( config , transaction ) ) ; } + private final java.util.concurrent.Executor threadExecutor = Executors.newFixedThreadPool ( 20 ) ; + + @ Test + public void testMultiThreadQuery ( ) { + final Executor mybatisExecutor = createExecutor ( new JdbcTransaction ( ds , null , false ) ) ; + + for ( int i = 0 ; i < 20 ; i++ ) { + this.threadExecutor.execute ( ( ) - > { + try { + MappedStatement selectStatement = ExecutorTestHelper.prepareSelectOneAuthorMappedStatement ( config ) ; + List < Object > l = mybatisExecutor.query ( selectStatement , 1 , RowBounds.DEFAULT , Executor.NO_RESULT_HANDLER ) ; + System.out.println ( l ) ; + } catch ( Exception e ) { + e.printStackTrace ( ) ; + } + } ) ; + } BaseExecutor may produce ClassCastException in multithread environment __EoT__ # # MyBatis version 3.4.x ( and maybe all versions ) # # Database vendor and version HSQL , which was tested , ( and maybe all vendors ) # # Test case or example project I just add a test case and open a PR # 1275 . # # Steps to reproduce Because this is a multithread problem , in order to make it easier for testing , I have to set a breakpoint and invoke ` Thread.yield ( ) ` to simulate Thread being blocked , here is how to reproduce in IntelliJ : 1 . Create a breakpoint in ` org.apache.ibatis.executor.BaseExecutor # queryFromDatabase ` , and evaluate a expression ` Thread.yield ( ) ` , and also uncheck `` suspend '' checkbox : ! [ image ] ( https : //user-images.githubusercontent.com/15965696/39660637-160c9f42-5076-11e8-847e-9a9bae5d72dc.png ) 2 . Run the unit test ` org.apache.ibatis.executor.CachingSimpleExecutorTest # testMultiThreadQuery ` ; # # Expected result Test passed . # # Actual result ` ClassCastException ` is thrown . I think it is because we put a ` EXECUTION_PLACEHOLDER ` into the ` localCache ` in class ` BaseExecutor ` : ! [ image ] (
diff -- git a/src/main/java/org/apache/ibatis/builder/xml/mybatis-3-config.dtd b/src/main/java/org/apache/ibatis/builder/xml/mybatis-3-config.dtd index 368965a..def06f1 100644 -- - a/src/main/java/org/apache/ibatis/builder/xml/mybatis-3-config.dtd +++ b/src/main/java/org/apache/ibatis/builder/xml/mybatis-3-config.dtd @ @ -39,10 +39,32 @ @ value CDATA # REQUIRED < ! ELEMENT settings ( setting+ ) > < ! ELEMENT setting EMPTY > - < ! ATTLIST setting -name CDATA # REQUIRED -value CDATA # REQUIRED - > + < ! ATTLIST setting name ( + aggressiveLazyLoading + | autoMappingBehavior + | cacheEnabled + | callSettersOnNulls + | configurationFactory + | defaultExecutorType + | defaultFetchSize + | defaultScriptingLanguage + | defaultStatementTimeout + | jdbcTypeForNull + | localCacheScope + | lazyLoadingEnabled + | lazyLoadTriggerMethods + | logPrefix + | logImpl + | multipleResultSetsEnabled + | mapUnderscoreToCamelCase + | proxyFactory + | safeRowBoundsEnabled + | safeResultHandlerEnabled + | useColumnLabel + | useGeneratedKeys + | vfsImpl + ) # REQUIRED > + < ! ATTLIST setting value CDATA # REQUIRED > < ! ELEMENT typeAliases ( typeAlias* , package* ) > Change to select valid setting name in mybatis-config.xml __EoT__ I want to change to select valid setting name ( e.g . ` aggressiveLazyLoading ` , ` autoMappingBehavior ` , etc.. ) in ` mybatis-config.xml ` . I think it is frendly for MyBatis users . I will change the ` mybatis-3-config.dtd ` as below : `` ` dtd < ! ELEMENT setting EMPTY > < ! ATTLIST setting name ( aggressiveLazyLoading | autoMappingBehavior | cacheEnabled | callSettersOnNulls | configurationFactory | defaultExecutorType | defaultFetchSize | defaultScriptingLanguage | defaultStatementTimeout | jdbcTypeForNull | localCacheScope | lazyLoadingEnabled | lazyLoadTriggerMethods | logPrefix | logImpl | multipleResultSetsEnabled | mapUnderscoreToCamelCase | proxyFactory | safeRowBoundsEnabled | safeResultHandlerEnabled | useColumnLabel | useGeneratedKeys | vfsImpl ) # REQUIRED > < ! ATTLIST setting value CDATA # REQUIRED > `` ` How do think ? I will submit a PR at later . Thanks .
diff -- git a/retrofit/src/main/java/retrofit/converter/SAXConverter.java b/retrofit/src/main/java/retrofit/converter/SAXConverter.java new file mode 100644 index 0000000..0a794e5 -- - /dev/null +++ b/retrofit/src/main/java/retrofit/converter/SAXConverter.java @ @ -0,0 +1,84 @ @ +/* + * Copyright ( C ) 2012 Square , Inc. + * + * Licensed under the Apache License , Version 2.0 ( the `` License '' ) ; + * you may not use this file except in compliance with the License . + * You may obtain a copy of the License at + * + * http : //www.apache.org/licenses/LICENSE-2.0 + * + * Unless required by applicable law or agreed to in writing , software + * distributed under the License is distributed on an `` AS IS '' BASIS , + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . + * See the License for the specific language governing permissions and + * limitations under the License . + */ +package retrofit.converter ; + +import org.xml.sax.ContentHandler ; +import org.xml.sax.InputSource ; +import org.xml.sax.SAXException ; +import org.xml.sax.XMLReader ; +import retrofit.mime.MimeUtil ; +import retrofit.mime.TypedInput ; + +import javax.xml.parsers.ParserConfigurationException ; +import javax.xml.parsers.SAXParserFactory ; +import java.io.IOException ; +import java.io.InputStreamReader ; +import java.lang.reflect.Type ; + +/** + * A { @ link retrofit.converter.Converter XML api sample __EoT__ Would be nice to be able to easily use retrofit for XML apis like AWS . I 'll volunteer to make a sample , if you do n't mind giving me pointers as to what might be needed in abstract .
diff -- git a/retrofit/src/main/java/retrofit/RequestBuilder.java b/retrofit/src/main/java/retrofit/RequestBuilder.java index d04bb19..c45ff07 100644 -- - a/retrofit/src/main/java/retrofit/RequestBuilder.java +++ b/retrofit/src/main/java/retrofit/RequestBuilder.java @ @ -21,6 +21,8 @ @ import java.io.UnsupportedEncodingException ; import java.lang.reflect.Array ; import java.net.URLEncoder ; import java.util.ArrayList ; + +import java.util.HashMap ; import java.util.Arrays ; import java.util.List ; import java.util.Map ; @ @ -31,18 +33,23 @ @ import retrofit.mime.FormUrlEncodedTypedOutput ; import retrofit.mime.MultipartTypedOutput ; import retrofit.mime.TypedOutput ; import retrofit.mime.TypedString ; +import retrofit.rpc.RpcRequest ; import static retrofit.RestMethodInfo.ParamUsage.QUERY ; import static retrofit.RestMethodInfo.ParamUsage.QUERY_MAP ; +import static retrofit.RestMethodInfo.ParamUsage.RPC_PARAM ; final class RequestBuilder implements RequestInterceptor.RequestFacade { private final Converter converter ; private final String [ ] paramNames ; private final RestMethodInfo.ParamUsage [ ] paramUsages ; private final String requestMethod ; + private final String methodName ; + private final RestMethodInfo.RequestType requestType ; private final boolean isSynchronous ; private final boolean isObservable ; private final String apiUrl ; + private final String rpcRequestMethod ; private final FormUrlEncodedTypedOutput formBody ; private final MultipartTypedOutput multipartBody ; @ @ -62,6 +69,7 @ @ final class RequestBuilder implements RequestInterceptor.RequestFacade { requestMethod = methodInfo.requestMethod ; isSynchronous = methodInfo.isSynchronous ; isObservable = methodInfo.isObservable ; + rpcRequestMethod = methodInfo.rpcRequestMethod ; if ( methodInfo.headers ! = null ) { headers = new ArrayList < Header > ( methodInfo.headers ) ; @ @ Evaluate the ability to support JSON-RPC __EoT__ See # 582 for original request . We should figure out how to support this with some combination of converters , interceptors , and plugin support of v2 .
diff -- git a/retrofit/src/main/java/retrofit/RestAdapter.java b/retrofit/src/main/java/retrofit/RestAdapter.java index 3a01247..2c198c8 100644 -- - a/retrofit/src/main/java/retrofit/RestAdapter.java +++ b/retrofit/src/main/java/retrofit/RestAdapter.java @ @ -282,6 +282,9 @ @ public class RestAdapter { Type type = methodDetails.responseObjectType ; if ( statusCode > = 200 & & statusCode < 300 ) { // 2XX == successful request + if ( type.equals ( Void.class ) ) { + return null ; + } // Caller requested the raw Response object directly . if ( type.equals ( Response.class ) ) { // Read the entire stream and replace with one backed by a byte [ ] diff -- git a/retrofit/src/test/java/retrofit/RestAdapterTest.java b/retrofit/src/test/java/retrofit/RestAdapterTest.java index 65e16ff..f8db151 100644 -- - a/retrofit/src/test/java/retrofit/RestAdapterTest.java +++ b/retrofit/src/test/java/retrofit/RestAdapterTest.java @ @ -34,6 +34,7 @ @ import static org.mockito.Matchers.same ; import static org.mockito.Mockito.mock ; import static org.mockito.Mockito.spy ; import static org.mockito.Mockito.verify ; +import static org.mockito.Mockito.never ; import static org.mockito.Mockito.verifyZeroInteractions ; import static org.mockito.Mockito.when ; import static retrofit.Profiler.RequestInformation ; @ @ -71,6 +72,7 @ @ public class RestAdapterTest { @ GET ( `` / '' ) void something ( Callback < Object > callback ) ; @ GET ( `` / '' ) Response direct ( ) ; @ GET ( `` / '' ) void direct ( Callback < Response > callback ) ; Retrofit 2.0 API Spec ( Working Draft ) __EoT__ This is a living spec for what will be v2 of Retrofit . # # Goals - Broaden the scope of how you can process successful responses and handle the results of various exceptions throughout the stack . Currently there 's a mix of exceptions , wrapped types , and callbacks depending on the usage of synchronous or asynchronous API declarations . - Unify API declaration so that both synchronous and asynchronous consumption of a resource does not change its declaration . - Introduce better request and response interceptors which allow for both tweaks to existing requests or full on replacement ( e.g. , for signing purposes ) . - Allow simple request retry and cancel support without the need to talk to the ` RestAdapter ` or generated interface instance . - Completely decouple interface declaration parsing from request invocation and processing and expose the shim layer between the two as a extension-based system for customization . This will be used to ( hopefully ) facilitate RxJava integration as an extensions rather than being baked into the core of the library itself # # Changes # # # Annotation Processors
diff -- git a/retrofit-converters/jackson/src/main/java/retrofit2/converter/jackson/JacksonConverterFactory.java b/retrofit-converters/jackson/src/main/java/retrofit2/converter/jackson/JacksonConverterFactory.java index f6db311..1820c6c 100644 -- - a/retrofit-converters/jackson/src/main/java/retrofit2/converter/jackson/JacksonConverterFactory.java +++ b/retrofit-converters/jackson/src/main/java/retrofit2/converter/jackson/JacksonConverterFactory.java @ @ -18,7 +18,6 @ @ package retrofit2.converter.jackson ; import com.fasterxml.jackson.databind.JavaType ; import com.fasterxml.jackson.databind.ObjectMapper ; import com.fasterxml.jackson.databind.ObjectReader ; -import com.fasterxml.jackson.databind.ObjectWriter ; import java.lang.annotation.Annotation ; import java.lang.reflect.Type ; import okhttp3.RequestBody ; @ @ -56,15 +55,13 @ @ public final class JacksonConverterFactory extends Converter.Factory { public Converter < ResponseBody , ? > responseBodyConverter ( Type type , Annotation [ ] annotations , Retrofit retrofit ) { JavaType javaType = mapper.getTypeFactory ( ) .constructType ( type ) ; - ObjectReader reader = mapper.reader ( javaType ) ; + ObjectReader reader = mapper.readerFor ( javaType ) ; return new JacksonResponseBodyConverter < > ( reader ) ; } @ Override public Converter < ? , RequestBody > requestBodyConverter ( Type type , Annotation [ ] parameterAnnotations , Annotation [ ] methodAnnotations , Retrofit retrofit ) { - JavaType javaType = mapper.getTypeFactory ( ) .constructType ( type ) ; - ObjectWriter writer = mapper.writerWithType ( javaType ) ; - return new JacksonRequestBodyConverter < > ( writer ) ; + return new JacksonRequestBodyConverter < > ( mapper ) ; } } diff -- git a/retrofit-converters/jackson/src/main/java/retrofit2/converter/jackson/JacksonRequestBodyConverter.java b/retrofit-converters/jackson/src/main/java/retrofit2/converter/jackson/JacksonRequestBodyConverter.java index bd20a0a..ffe030e 100644 -- - a/retrofit-converters/jackson/src/main/java/retrofit2/converter/jackson/JacksonRequestBodyConverter.java +++ b/retrofit-converters/jackson/src/main/java/retrofit2/converter/jackson/JacksonRequestBodyConverter.java GsonConverterFactory GsonRequestBodyConverter not handling Polymorphism __EoT__ [ http : //stackoverflow.com/questions/5800433/polymorphism-with-gson ] ( url ) This was working fine in Retrofit 1.9 . Is there any way to avoid use of registerTypeAdapter ?
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 01be9cf..4d80a36 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,5 +1,9 @ @ # Change Log + # # Version 1.3.1-SNAPSHOT + +* https : //github.com/square/leakcanary/pull/24 + # # Version 1.3 * ( 2015-05-08 ) * Initial release . \ No newline at end of file diff -- git a/README.md b/README.md index 6584c58..1bc8255 100644 -- - a/README.md +++ b/README.md @ @ -83,7 +83,7 @ @ public abstract class BaseFragment extends Fragment { 1 . ` RefWatcher.watch ( ) ` creates a [ KeyedWeakReference ] ( https : //github.com/square/leakcanary/blob/master/library/leakcanary-watcher/src/main/java/com/squareup/leakcanary/KeyedWeakReference.java ) to the watched object . 2 . Later , in a background thread , it checks if the reference has been cleared and if not it triggers a GC . -3 . If the reference is still not cleared , it them dumps the heap into a ` .hprof ` file stored on the app file system . +3 . If the reference is still not cleared , it then dumps the heap into a ` .hprof ` file stored on the app file system . 4 . ` HeapAnalyzerService ` is started in a separate process and ` HeapAnalyzer ` parses the heap dump EditText Blink causes memory leak in AlertDialog and DialogFragment __EoT__ See AOSP issue 188551 : https : //code.google.com/p/android/issues/detail ? id=188551 Can be avoided by calling setCursorVisible ( false ) in the dismiss ( ) method of the Dialog .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 01be9cf..4d80a36 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,5 +1,9 @ @ # Change Log + # # Version 1.3.1-SNAPSHOT + +* https : //github.com/square/leakcanary/pull/24 + # # Version 1.3 * ( 2015-05-08 ) * Initial release . \ No newline at end of file diff -- git a/README.md b/README.md index 6584c58..a516918 100644 -- - a/README.md +++ b/README.md @ @ -83,7 +83,7 @ @ public abstract class BaseFragment extends Fragment { 1 . ` RefWatcher.watch ( ) ` creates a [ KeyedWeakReference ] ( https : //github.com/square/leakcanary/blob/master/library/leakcanary-watcher/src/main/java/com/squareup/leakcanary/KeyedWeakReference.java ) to the watched object . 2 . Later , in a background thread , it checks if the reference has been cleared and if not it triggers a GC . -3 . If the reference is still not cleared , it them dumps the heap into a ` .hprof ` file stored on the app file system . +3 . If the reference is still not cleared , it then dumps the heap into a ` .hprof ` file stored on the app file system . 4 . ` HeapAnalyzerService ` is started in a separate process and ` HeapAnalyzer ` parses the heap dump EditText Blink causes memory leak in AlertDialog and DialogFragment __EoT__ See AOSP issue 188551 : https : //code.google.com/p/android/issues/detail ? id=188551 Can be avoided by calling setCursorVisible ( false ) in the dismiss ( ) method of the Dialog .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 01be9cf..28303d6 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,5 +1,61 @ @ # Change Log + + + # # Version 1.3.1-SNAPSHOT + +* Heap dumps and analysis results are now saved on the sd card : [ # 21 ] ( https : //github.com/square/leakcanary/issues/21 ) . +* ` ExcludedRef ` and ` AndroidExcludedRefs ` are customizable : [ # 12 ] ( https : //github.com/square/leakcanary/issues/12 ) [ # 73 ] ( https : //github.com/square/leakcanary/issues/73 ) . +* 6 new ignored Android SDK leaks : [ # 1 ] ( https : //github.com/square/leakcanary/issues/1 ) [ # 4 ] ( https : //github.com/square/leakcanary/issues/4 ) [ # 32 ] ( https : //github.com/square/leakcanary/issues/32 ) [ # 89 ] ( https : //github.com/square/leakcanary/pull/89 ) [ 82 ] ( https : //github.com/square/leakcanary/pull/82 ) . +* Fixed 3 crashes in LeakCanary : [ # 37 ] ( https : //github.com/square/leakcanary/issues/37 ) [ # 46 ] ( https : //github.com/square/leakcanary/issues/46 ) [ # 66 ] ( https : //github.com/square/leakcanary/issues/66 ) . +* Fixed StrictMode thread policy violations : [ # 15 ] ( https : //github.com/square/leakcanary/issues/15 ) . +* Updated ` minSdkVersion ` from ` 9 ` to ` EditText Blink causes memory leak in AlertDialog and DialogFragment __EoT__ See AOSP issue 188551 : https : //code.google.com/p/android/issues/detail ? id=188551 Can be avoided by calling setCursorVisible ( false ) in the dismiss ( ) method of the Dialog .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 01be9cf..dbcaae4 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,5 +1,61 @ @ # Change Log + + + # # Version 1.3.1-SNAPSHOT + +* Heap dumps and analysis results are now saved on the sd card : [ # 21 ] ( https : //github.com/square/leakcanary/issues/21 ) . +* ` ExcludedRef ` and ` AndroidExcludedRefs ` are customizable : [ # 12 ] ( https : //github.com/square/leakcanary/issues/12 ) [ # 73 ] ( https : //github.com/square/leakcanary/issues/73 ) . +* 6 new ignored Android SDK leaks : [ # 1 ] ( https : //github.com/square/leakcanary/issues/1 ) [ # 4 ] ( https : //github.com/square/leakcanary/issues/4 ) [ # 32 ] ( https : //github.com/square/leakcanary/issues/32 ) [ # 89 ] ( https : //github.com/square/leakcanary/pull/89 ) [ 82 ] ( https : //github.com/square/leakcanary/pull/82 ) . +* Fixed 3 crashes in LeakCanary : [ # 37 ] ( https : //github.com/square/leakcanary/issues/37 ) [ # 46 ] ( https : //github.com/square/leakcanary/issues/46 ) [ # 66 ] ( https : //github.com/square/leakcanary/issues/66 ) . +* Fixed StrictMode thread policy violations : [ # 15 ] ( https : //github.com/square/leakcanary/issues/15 ) . +* Updated ` minSdkVersion ` from ` 9 ` to ` EditText Blink causes memory leak in AlertDialog and DialogFragment __EoT__ See AOSP issue 188551 : https : //code.google.com/p/android/issues/detail ? id=188551 Can be avoided by calling setCursorVisible ( false ) in the dismiss ( ) method of the Dialog .
diff -- git a/CHANGELOG.md b/CHANGELOG.md index 01be9cf..156ff1b 100644 -- - a/CHANGELOG.md +++ b/CHANGELOG.md @ @ -1,5 +1,73 @ @ # Change Log + # # Version 1.3.2-SNAPSHOT + +No change yet . + + # # # Dependencies + + `` ` gradle + dependencies { + debugCompile 'com.squareup.leakcanary : leakcanary-android:1.3.2-SNAPSHOT' + releaseCompile 'com.squareup.leakcanary : leakcanary-android-no-op:1.3.2-SNAPSHOT' + } + `` ` + +Snapshots are available in Sonatype 's ` snapshots ` repository : + + `` ` + repositories { + mavenCentral ( ) + maven { + url 'https : //oss.sonatype.org/content/repositories/snapshots/' + } + } + `` ` + + # # Version 1.3.1 * ( 2015-05-16 ) * + +* Heap dumps and analysis results are now saved on the sd card : [ # 21 ] ( https : //github.com/square/leakcanary/issues/21 ) . +* ` ExcludedRef ` and ` AndroidExcludedRefs ` are customizable : [ # 12 ] ( https : //github.com/square/leakcanary/issues/12 ) [ # 73 ] ( https : //github.com/square/leakcanary/issues/73 ) . +* 7 new ignored Android SDK leaks : [ # 1 ] ( https : //github.com/square/leakcanary/issues/1 ) [ # 4 ] ( https : //github.com/square/leakcanary/issues/4 ) [ # 32 ] ( https : //github.com/square/leakcanary/issues/32 ) EditText Blink causes memory leak in AlertDialog and DialogFragment __EoT__ See AOSP issue 188551 : https : //code.google.com/p/android/issues/detail ? id=188551 Can be avoided by calling setCursorVisible ( false ) in the dismiss ( ) method of the Dialog .
diff -- git a/dependencies.gradle b/dependencies.gradle index ac1d5b0..aca464a 100644 -- - a/dependencies.gradle +++ b/dependencies.gradle @ @ -1,11 +1,12 @ @ ext { - compileSdkVersion = 23 - buildToolsVersion = '23.0.3' + compileSdkVersion = 24 + buildToolsVersion = '24.0.0' minSdkVersion = 14 - targetSdkVersion = 23 + targetSdkVersion = 24 sourceCompatibilityVersion = JavaVersion.VERSION_1_7 targetCompatibilityVersion = JavaVersion.VERSION_1_7 okhttp3Version = '3.0.1' + supportLibrariesVersion = '24.0.0' dep = [ androidPlugin : 'com.android.tools.build : gradle:2.1.2 ' , @ @ -13,8 +14,8 @ @ ext { okhttp3 : `` com.squareup.okhttp3 : okhttp : $ okhttp3Version '' , mockWebServer : `` com.squareup.okhttp3 : mockwebserver : $ okhttp3Version '' , pollexor : 'com.squareup : pollexor:2.0.0 ' , - supportV4 : 'com.android.support : support-v4:23.4.0 ' , - supportAnnotations : 'com.android.support : support-annotations:23.4.0 ' , + supportV4 : `` com.android.support : support-v4 : $ supportLibrariesVersion '' , + supportAnnotations : `` com.android.support : support-annotations : $ supportLibrariesVersion '' , junit : 'junit : junit:4.10 ' , fest : 'org.easytesting : fest-assert-core:2.0M10 ' , festAndroid : 'com.squareup : fest-android:1.0.6 ' , Annotate resize ( int , int ) with @ Px __EoT__ I 'm aware this is more of a useful feature rather than bug . There is resizeDimen ( int , int ) but when I made a mistake and called resize ( R.dimen , R.dimen ) Picasso fails to load image . Is there an option to supply @ DimenRes to arguments or any other way of checking in Runtime that input is too big and then throwing IllegalArgumentException ?
diff -- git a/picasso-sample/src/main/java/com/example/picasso/SampleGridViewActivity.java b/picasso-sample/src/main/java/com/example/picasso/SampleGridViewActivity.java index 9097974..ab8efdb 100644 -- - a/picasso-sample/src/main/java/com/example/picasso/SampleGridViewActivity.java +++ b/picasso-sample/src/main/java/com/example/picasso/SampleGridViewActivity.java @ @ -3,6 +3,8 @ @ package com.example.picasso ; import android.os.Bundle ; import android.widget.GridView ; +import com.squareup.picasso.scrolling.PicassoScrollListener ; + public class SampleGridViewActivity extends PicassoSampleActivity { @ Override protected void onCreate ( Bundle savedInstanceState ) { super.onCreate ( savedInstanceState ) ; @ @ -10,5 +12,6 @ @ public class SampleGridViewActivity extends PicassoSampleActivity { GridView gv = ( GridView ) findViewById ( R.id.grid_view ) ; gv.setAdapter ( new SampleGridViewAdapter ( this ) ) ; + gv.setOnScrollListener ( new PicassoScrollListener ( this ) ) ; } } diff -- git a/picasso-sample/src/main/java/com/example/picasso/SampleListDetailActivity.java b/picasso-sample/src/main/java/com/example/picasso/SampleListDetailActivity.java index 890ec88..bb64e97 100644 -- - a/picasso-sample/src/main/java/com/example/picasso/SampleListDetailActivity.java +++ b/picasso-sample/src/main/java/com/example/picasso/SampleListDetailActivity.java @ @ -11,6 +11,7 @ @ import android.widget.ImageView ; import android.widget.ListView ; import android.widget.TextView ; import com.squareup.picasso.Picasso ; +import com.squareup.picasso.scrolling.PicassoScrollListener ; public class SampleListDetailActivity extends PicassoSampleActivity { @ Override protected void onCreate ( Bundle savedInstanceState ) { @ @ -50,6 +51,9 @ @ public class SampleListDetailActivity extends PicassoSampleActivity { activity.showDetails ( url ) ; } } ) ; + + listView.setOnScrollListener ( new PicassoScrollListener ( activity ) ) ; + return listView ; } } diff -- git a/picasso/src/main/java/com/squareup/picasso/Dispatcher.java b/picasso/src/main/java/com/squareup/picasso/Dispatcher.java index 5ba6cfb..d40fd7c 100644 -- - a/picasso/src/main/java/com/squareup/picasso/Dispatcher.java +++ b/picasso/src/main/java/com/squareup/picasso/Dispatcher.java @ @ Provide ScrollListener support __EoT__ It should be easy to use Picasso and attach a ScrollListener to provide smooth scrolling while the user fiings the list .
diff -- git a/picasso-sample/AndroidManifest.xml b/picasso-sample/AndroidManifest.xml index 502d747..54321bf 100644 -- - a/picasso-sample/AndroidManifest.xml +++ b/picasso-sample/AndroidManifest.xml @ @ -34,9 +34,12 @ @ < /intent-filter > < /activity > + + < activity android : name= '' .SampleGridViewScrollingActivity '' android : label= '' @ string/view_pager_activity '' / > < activity android : name= '' .SampleContactsActivity '' / > < activity android : name= '' .SampleGalleryActivity '' / > < activity android : name= '' .SampleListDetailActivity '' / > + < activity android : name= '' .SampleListDetailScrollingActivity '' / > < receiver android : name= '' SampleWidgetProvider '' > < intent-filter > diff -- git a/picasso-sample/res/layout/sample_gridview_activity_scrolling.xml b/picasso-sample/res/layout/sample_gridview_activity_scrolling.xml new file mode 100644 index 0000000..174977c -- - /dev/null +++ b/picasso-sample/res/layout/sample_gridview_activity_scrolling.xml @ @ -0,0 +1,6 @ @ + < ? xml version= '' 1.0 '' encoding= '' utf-8 '' ? > + < android.support.v4.view.ViewPager xmlns : android= '' http : //schemas.android.com/apk/res/android '' + android : id= '' @ +id/viewPager '' + android : layout_width= '' match_parent '' + android : layout_height= '' match_parent '' / > + diff -- git a/picasso-sample/res/layout/sample_gridview_fragment_scrolling.xml b/picasso-sample/res/layout/sample_gridview_fragment_scrolling.xml new file mode 100644 index 0000000..3c14f7f -- - /dev/null +++ b/picasso-sample/res/layout/sample_gridview_fragment_scrolling.xml @ @ -0,0 +1,27 @ @ + < ? xml version= '' 1.0 '' encoding= Provide ScrollListener support __EoT__ It should be easy to use Picasso and attach a ScrollListener to provide smooth scrolling while the user fiings the list .
diff -- git a/picasso/pom.xml b/picasso/pom.xml index df7395d..0b1b4bc 100644 -- - a/picasso/pom.xml +++ b/picasso/pom.xml @ @ -24,7 +24,11 @ @ < artifactId > okhttp-urlconnection < /artifactId > < optional > true < /optional > < /dependency > - + < dependency > + < groupId > org.apache.commons < /groupId > + < artifactId > commons-imaging < /artifactId > + < optional > true < /optional > + < /dependency > < dependency > < groupId > junit < /groupId > < artifactId > junit < /artifactId > diff -- git a/picasso/src/main/java/com/squareup/picasso/NetworkRequestHandler.java b/picasso/src/main/java/com/squareup/picasso/NetworkRequestHandler.java index 484a17f..9302be0 100644 -- - a/picasso/src/main/java/com/squareup/picasso/NetworkRequestHandler.java +++ b/picasso/src/main/java/com/squareup/picasso/NetworkRequestHandler.java @ @ -18,6 +18,14 @ @ package com.squareup.picasso ; import android.graphics.Bitmap ; import android.graphics.BitmapFactory ; import android.net.NetworkInfo ; +import org.apache.commons.imaging.ImageReadException ; +import org.apache.commons.imaging.Imaging ; +import org.apache.commons.imaging.common.IImageMetadata ; +import org.apache.commons.imaging.formats.jpeg.JpegImageMetadata ; +import org.apache.commons.imaging.formats.tiff.TiffField ; +import org.apache.commons.imaging.formats.tiff.TiffImageMetadata ; +import org.apache.commons.imaging.formats.tiff.constants.TiffTagConstants ; + import java.io.IOException ; import java.io.InputStream ; @ @ -34,10 +42,12 @ @ class NetworkRequestHandler extends RequestHandler { private final Downloader downloader ; private final Stats stats ; + private final boolean hasImaging ; public NetworkRequestHandler ( Downloader downloader , Stats stats ) { this.downloader = downloader ; this.stats = stats ; + this.hasImaging = isImagingOnClasspath ( ) ; } @ Override Sometimes picasso 2.3.3 resize inaccuracy . __EoT__ ! [ aef43932-08a3-11e4-9f9a-ea94cbe6d758 ] ( https : //cloud.githubusercontent.com/assets/6055764/3653422/a5896e6e-1152-11e4-9cb6-09c61c4fff57.jpg ) Picasso.with ( this ) .load ( new File ( path ) ) .resize ( 1440 , 1920 ) .centerInside ( ) .into ( mTarget ) ; When I use picasso 2.3.3 load this image , I put some different width and height , sometimes it resize inaccuracy . I debug some information to you . It look like width and height reversal . ! [ 1 ] ( https : //cloud.githubusercontent.com/assets/6055764/3653448/4d37020c-1153-11e4-84be-5d7995809ba0.png ) ! [ 4 ] ( https : //cloud.githubusercontent.com/assets/6055764/3653450/54c8ca28-1153-11e4-8d32-9edd20023efd.png ) ! [ 2 ] ( https : //cloud.githubusercontent.com/assets/6055764/3653453/5c052868-1153-11e4-8072-f1002df4d07a.png ) ! [ 3 ] ( https : //cloud.githubusercontent.com/assets/6055764/3653456/67acaae2-1153-11e4-9019-53239576d262.png ) I hope you can resolve this problem , thanks !
diff -- git a/picasso/src/main/java/com/squareup/picasso/NetworkBitmapHunter.java b/picasso/src/main/java/com/squareup/picasso/NetworkBitmapHunter.java index 6fa0c81..bb2c3b7 100644 -- - a/picasso/src/main/java/com/squareup/picasso/NetworkBitmapHunter.java +++ b/picasso/src/main/java/com/squareup/picasso/NetworkBitmapHunter.java @ @ -104,10 +104,7 @ @ class NetworkBitmapHunter extends BitmapHunter { return BitmapFactory.decodeByteArray ( bytes , 0 , bytes.length , options ) ; } else { if ( calculateSize ) { - BitmapFactory.decodeStream ( stream , null , options ) ; calculateInSampleSize ( data.targetWidth , data.targetHeight , options ) ; - - markStream.reset ( mark ) ; } return BitmapFactory.decodeStream ( stream , null , options ) ; } Exception : java.io.IOException : Can not reset __EoT__ Hi Square team ! We are having an issue in an app , when in a listview , images on some rows load but some of them are blank . I tried to trace it and collect as much information as I can . # # # # Exception `` ` java Picasso : Error : ImageLoadFailed : Uri http : //store.indemand.com/shared/ovs/prodimages/movies/t/troublewiththecurve_ID0360906/troublewiththecurveBM_ID0360906.jpg Picasso : Error : ImageLoadFailed : Exception java.io.IOException : Can not reset Picasso : Error : ImageLoadFailed : StackTrace [ com.squareup.picasso.MarkableInputStream.reset ( MarkableInputStream.java:94 ) , com.squareup.picasso.NetworkBitmapHunter.decodeStream ( NetworkBitmapHunter.java:91 ) , com.squareup.picasso.NetworkBitmapHunter.decode ( NetworkBitmapHunter.java:60 ) , com.squareup.picasso.BitmapHunter.hunt ( BitmapHunter.java:111 ) , com.squareup.picasso.BitmapHunter.run ( BitmapHunter.java:82 ) , java.util.concurrent.Executors $ RunnableAdapter.call ( Executors.java:390 ) , java.util.concurrent.FutureTask.run ( FutureTask.java:234 ) , java.util.concurrent.ThreadPoolExecutor.runWorker ( ThreadPoolExecutor.java:1080 ) , java.util.concurrent.ThreadPoolExecutor $ Worker.run ( ThreadPoolExecutor.java:573 ) , java.lang.Thread.run ( Thread.java:856 ) , com.squareup.picasso.Utils $ PicassoThread.run ( Utils.java:218 ) ] `` ` # # # # Responsible code ( under getView ( ) ) `` ` java pBuilder.build ( ) .load ( URL ) .fit ( ) .into ( ImageView ) ; `` ` By the way , I do n't know if it matters but airplane mode is
diff -- git a/picasso-sample/src/main/java/com/example/picasso/SampleListDetailActivity.java b/picasso-sample/src/main/java/com/example/picasso/SampleListDetailActivity.java index 890ec88..bb64e97 100644 -- - a/picasso-sample/src/main/java/com/example/picasso/SampleListDetailActivity.java +++ b/picasso-sample/src/main/java/com/example/picasso/SampleListDetailActivity.java @ @ -11,6 +11,7 @ @ import android.widget.ImageView ; import android.widget.ListView ; import android.widget.TextView ; import com.squareup.picasso.Picasso ; +import com.squareup.picasso.scrolling.PicassoScrollListener ; public class SampleListDetailActivity extends PicassoSampleActivity { @ Override protected void onCreate ( Bundle savedInstanceState ) { @ @ -50,6 +51,9 @ @ public class SampleListDetailActivity extends PicassoSampleActivity { activity.showDetails ( url ) ; } } ) ; + + listView.setOnScrollListener ( new PicassoScrollListener ( activity ) ) ; + return listView ; } } diff -- git a/picasso/src/main/java/com/squareup/picasso/Dispatcher.java b/picasso/src/main/java/com/squareup/picasso/Dispatcher.java index 5ba6cfb..93f82a5 100644 -- - a/picasso/src/main/java/com/squareup/picasso/Dispatcher.java +++ b/picasso/src/main/java/com/squareup/picasso/Dispatcher.java @ @ -26,6 +26,7 @ @ import android.os.Handler ; import android.os.HandlerThread ; import android.os.Looper ; import android.os.Message ; + import java.util.ArrayList ; import java.util.Iterator ; import java.util.LinkedHashMap ; @ @ -84,6 +85,7 @ @ class Dispatcher { final List < BitmapHunter > batch ; final NetworkBroadcastReceiver receiver ; final boolean scansNetworkChanges ; + final DispatchingQueue dispatchingQueue ; boolean airplaneMode ; @ @ -96,6 +98,7 @ @ class Dispatcher { this.hunterMap = new LinkedHashMap < String , BitmapHunter > ( ) ; this.failedActions = new WeakHashMap < Object , Action > ( ) ; this.handler = new DispatcherHandler ( dispatcherThread.getLooper Throwing OutOfMemoryError `` Could not allocate JNI Env '' __EoT__ `` ` compile 'com.github.captain-miao : recyclerviewutils:1.2.1-SNAPSHOT' @ BindingAdapter ( { `` compressImageUrl '' } ) public static void loadImageCompress ( ImageView imageView , String url ) { //recycle bitmap Drawable drawable = imageView.getDrawable ( ) ; if ( drawable instanceof BitmapDrawable ) { imageView.setImageDrawable ( null ) ; Bitmap bitmap = ( ( BitmapDrawable ) drawable ) .getBitmap ( ) ; Log.d ( TAG , `` recycle bitmap , w : '' + bitmap.getWidth ( ) + `` , h : '' + bitmap.getHeight ( ) ) ; bitmap.recycle ( ) ; } Picasso.with ( imageView.getContext ( ) .getApplicationContext ( ) ) .load ( url ) .memoryPolicy ( MemoryPolicy.NO_CACHE , MemoryPolicy.NO_STORE ) .placeholder ( R.drawable.ic_image_load_place_holder ) .config ( Bitmap.Config.RGB_565 ) .tag ( PicassoOnScrollListener.TAG ) .into ( imageView ) ; } `` ` **fast scroll RecycleView , load image more and more and more ... ** `` ` ** MEMINFO in pid 4695 [ com.github.captain_miao.agera.tutorial ] ** Pss Private Private Swapped Heap Heap Heap Total Dirty Clean Dirty Size Alloc Free -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
